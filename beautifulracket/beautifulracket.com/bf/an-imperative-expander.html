<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/bf/an-imperative-expander.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:16 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Follow the grammar: bf</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;follow-the-grammar-bf&quot;)"></div><h1 anchor="follow-the-grammar-bf" id="follow-the-grammar-bf" hyphens="none">Follow the grammar: <span class="my-code" decode="exclude">bf</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="grammars-and-parsers.html">2&emsp;gram­mars and parsers</a></li><li><a href="grammar-notation.html">3&emsp;gram­mar nota­tion</a></li><li><a href="the-parser.html">4&emsp;the parser</a></li><li><a href="the-tokenizer-and-reader.html">5&emsp;the tok­enizer and reader</a></li><li><a class="here" href="an-imperative-expander.html">6&emsp;an imper­a­tive expander</a></li><li><a href="a-functional-expander.html">7&emsp;a func­tional expander</a></li><li><a href="packaging-our-language.html">8&emsp;pack­ag­ing our lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HjRfg&quot;)"></div><p id="a_HjRfg">In <a href="../stacker/index.html"><span class="my-code" decode="exclude">stacker</span></a> we wrote our expander using <a class="glossary" href="../appendix/glossary.html#imperative-programming"><span class="glossary-link-text">imper­a­tive pro­gram­ming</span></a>. In <a href="../funstacker/index.html"><span class="my-code" decode="exclude">funstacker</span></a> we upgraded the expander with <a class="glossary" href="../appendix/glossary.html#functional-programming"><span class="glossary-link-text">func­tional pro­gram­ming</span></a>. To nail down this con­trast, we’ll do the same with <span class="my-code" decode="exclude">bf</span>: we’ll first write the expander in an imper­a­tive style, and then upgrade it to a func­tional style. (Those who already feel com­fort­able with func­tional pro­gram­ming can move ahead to the next sec­tion.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;starting-the-expander&quot;)"></div><h3 anchor="starting-the-expander" class="subhead" id="starting-the-expander"><a href="#starting-the-expander">Start­ing the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_n0Y42&quot;)"></div><p id="a_n0Y42">Here’s where we left our expander at the end of the last sec­tion:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y8nhE&quot;)"></div><div class="highlight-container" id="a_Y8nhE"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_fcKmh"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yxMia&quot;)"></div><p id="a_yxMia">We don’t need to change any­thing in our manda­tory <span class="my-code" decode="exclude">#%module-begin</span> macro. So we’ll move on to the other <a class="glossary" href="../appendix/glossary.html#macro"><span class="glossary-link-text">macros</span></a> and func­tions we need to han­dle the con­tents of <span class="my-code" decode="exclude">PARSE-TREE</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;following-the-grammar-into-the-expander&quot;)"></div><h3 anchor="following-the-grammar-into-the-expander" class="subhead" id="following-the-grammar-into-the-expander"><a href="#following-the-grammar-into-the-expander">Fol­low­ing the gram­mar into the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VgvQ6&quot;)"></div><p id="a_VgvQ6">We saw how the reader <a href="the-tokenizer-and-reader.html#testing-the-reader">fol­lows the gram­mar</a> while pars­ing the source code, pro­duc­ing a parse tree whose nodes cor­re­spond to the names and pat­terns of the <a class="glossary" href="../appendix/glossary.html#production-rule"><span class="glossary-link-text">pro­duc­tion rules</span></a> of the gram­mar.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_V7Kg9&quot;)"></div><p id="a_V7Kg9">In turn, we can fol­low the gram­mar fur­ther, and use these pro­duc­tion rules to design our expander. Once again, here’s our <span class="my-code" decode="exclude">bf</span> gram­mar:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">parser.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mqxaR&quot;)"></div><div class="highlight-container" id="a_mqxaR"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>bf-program : (bf-op | bf-loop)*<br/>bf-op      : "&gt;" | "&lt;" | "+" | "-" | "." | ","<br/>bf-loop    : "[" (bf-op | bf-loop)* "]"</div><div class="highlight" form="false" id="a_LGaA2"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">brag</span>
<span class="n">bf-program</span> <span class="n">:</span> <span class="p">(</span><span class="n">bf-op</span> <span class="n">| bf-loop)*</span>
<span class="n">bf-op      : "&gt;" |</span> <span class="s2">"&lt;"</span> <span class="n">| "+" |</span> <span class="s2">"-"</span> <span class="n">| "." |</span> <span class="s2">","</span>
<span class="n">bf-loop</span>    <span class="n">:</span> <span class="s2">"["</span> <span class="p">(</span><span class="n">bf-op</span> <span class="err">|</span> <span class="n">bf-loop</span><span class="p">)</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="s2">"]"</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0tTib&quot;)"></div><p id="a_0tTib">What this gram­mar tells us is that we need to han­dle three types of parse-tree nodes—<span class="my-code" decode="exclude">bf-program</span>, <span class="my-code" decode="exclude">bf-op</span>, and <span class="my-code" decode="exclude">bf-loop</span>. In the expander, these will become the names of macros or func­tions that will imple­ment each type of node as stan­dard Racket code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZQqxr&quot;)"></div><p id="a_ZQqxr">Fur­ther­more, the pat­tern on the right side of the each rule tells us what kind of input the cor­re­spond­ing macro or func­tion has to be able to accept. So we don’t have to bum­ble around in the dark—the gram­mar gives us spe­cific march­ing orders.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_E7RI9&quot;)"></div><p id="a_E7RI9">Let’s say it one more time, because it’s such a tremen­dous short­cut:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KstxL&quot;)"></div><p id="a_KstxL">Each pro­duc­tion rule in the gram­mar will have a cor­re­spond­ing macro or func­tion in the expander.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nz3lB&quot;)"></div><p id="a_nz3lB">The name (on the left side) of each pro­duc­tion rule is the name of the cor­re­spond­ing macro or func­tion.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_b19AO&quot;)"></div><p id="a_b19AO">The pat­tern (on the right side) of each pro­duc­tion rule describes the pos­si­ble input to its cor­re­spond­ing macro or func­tion.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QbNsR&quot;)"></div><p id="a_QbNsR">Given a cer­tain pro­duc­tion rule, how do we know if we should imple­ment it with a macro or a func­tion? The rule of thumb is to use a func­tion where we can, and a macro where we must.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iliK2&quot;)"></div><p id="a_iliK2">Often, a pro­duc­tion rule does some­thing sim­ple, like return its argu­ments in a list or print them. In those cases, the rule can be imple­mented with a func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tem9V&quot;)"></div><p id="a_tem9V">But other times, the pro­duc­tion rule needs us to rearrange the code in ways that an ordi­nary func­tion won’t sup­port. In those cases, we can esca­late to a macro.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SA2xJ&quot;)"></div><p id="a_SA2xJ">But for <span class="my-code" decode="exclude">bf</span>, we’ll only use macros, so we can get a lit­tle more prac­tice with how they work.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VWd6p&quot;)"></div><p id="a_VWd6p">To see how this works, let’s pen­cil out a tiny exam­ple. This minia­ture <span class="my-code" decode="exclude">bf</span> pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qKGoN&quot;)"></div><div class="highlight-container" id="a_qKGoN"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">+[&gt;]</div><div class="highlight" form="false" id="a_XaB2L"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" class="docs" hyphens="none">&gt;</a></span><span class="p">]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zruRp&quot;)"></div><p id="a_zruRp">Will be parsed into a tree that looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qbZxp&quot;)"></div><div class="highlight-container" id="a_qbZxp"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">(bf-program (bf-op "+") (bf-loop "[" (bf-op "&gt;") "]"))</div><div class="highlight" form="false" id="a_n9Vks"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">bf-program</span> <span class="p">(</span><span class="n">bf-op</span> <span class="s2">"+"</span><span class="p">)</span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="p">(</span><span class="n">bf-op</span> <span class="s2">"&gt;"</span><span class="p">)</span> <span class="s2">"]"</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vDrAJ&quot;)"></div><p id="a_vDrAJ">Once we’ve writ­ten the cor­re­spond­ing macros, our expander will pro­ceed as fol­lows:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qeYRz&quot;)"></div><p id="a_qeYRz">Call the <span class="my-code" decode="exclude">bf-program</span> macro with two input argu­ments:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_q2FMH&quot;)"></div><p id="a_q2FMH"><span class="my-code" decode="exclude">(bf-op "+")</span></p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KQE5P&quot;)"></div><p id="a_KQE5P"><span class="my-code" decode="exclude">(bf-loop "[" (bf-op "&gt;") "]")</span></p></div></li></ol></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_k823A&quot;)"></div><p id="a_k823A">Call the <span class="my-code" decode="exclude">bf-op</span> macro with one input argu­ment:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Hmdfh&quot;)"></div><p id="a_Hmdfh"><span class="my-code" decode="exclude">"+"</span></p></div></li></ol></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5JpWw&quot;)"></div><p id="a_5JpWw">Call the <span class="my-code" decode="exclude">bf-loop</span> macro with three input argu­ments:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_I3Jhm&quot;)"></div><p id="a_I3Jhm"><span class="my-code" decode="exclude">"["</span></p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vCaKw&quot;)"></div><p id="a_vCaKw"><span class="my-code" decode="exclude">(bf-op "&gt;")</span></p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qgsk9&quot;)"></div><p id="a_qgsk9"><span class="my-code" decode="exclude">"]"</span></p></div></li></ol></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_k823A4&quot;)"></div><p id="a_k823A4">Call the <span class="my-code" decode="exclude">bf-op</span> macro with one input argu­ment:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xO6QB&quot;)"></div><p id="a_xO6QB"><span class="my-code" decode="exclude">"&gt;"</span></p></div></li></ol></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_78ZQR&quot;)"></div><p id="a_78ZQR">The result of this expan­sion needs to be a stan­dard Racket pro­gram that can be eval­u­ated to pro­duce a result.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;from-grammar-to-syntax-pattern&quot;)"></div><h3 anchor="from-grammar-to-syntax-pattern" class="subhead" id="from-grammar-to-syntax-pattern"><a href="#from-grammar-to-syntax-pattern">From gram­mar to syn­tax pat­tern</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5ywOx&quot;)"></div><p id="a_5ywOx">When <a href="../stacker/the-expander.html#expander-output">we first used</a> <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a>, we learned that the first line of the def­i­n­i­tion relies on a <em><a class="glossary" href="../appendix/glossary.html#syntax-pattern"><span class="glossary-link-text">syn­tax pat­tern</span></a></em>. A syn­tax pat­tern does for syn­tax objects what a reg­u­lar expres­sion does for strings: it breaks down the input into pieces so they can be manip­u­lated &amp; rearranged.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TVs87&quot;)"></div><p id="a_TVs87">Let’s start with our <span class="my-code" decode="exclude">bf-program</span> macro. It’s easy—it doesn’t do any­thing. It’s just the top-level wrap­per for the other <span class="my-code" decode="exclude">bf</span> com­mands that do the real work. Accord­ing to the gram­mar, this macro has to be able to han­dle any num­ber of <span class="my-code" decode="exclude">bf-op</span> or <span class="my-code" decode="exclude">bf-loop</span> argu­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Js4uj&quot;)"></div><div class="highlight-container" id="a_Js4uj"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">bf-program : (bf-op | bf-loop)*</div><div class="highlight" form="false" id="a_0JLcl"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>bf-program : (bf-op | bf-loop)*
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IEVLv&quot;)"></div><p id="a_IEVLv">So we’ll define our macro using this syn­tax pat­tern:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cK7v5&quot;)"></div><div class="highlight-container" id="a_cK7v5"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(bf-program OP-OR-LOOP-ARG ...)</div><div class="highlight" form="false" id="a_7Vmuk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_v7caH&quot;)"></div><p id="a_v7caH">The pat­tern has three parts.</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pqCf7&quot;)"></div><p id="a_pqCf7"><span class="my-code" decode="exclude">bf-program</span> denotes a lit­eral iden­ti­fier in the code, and becomes the name of the macro. Every ele­ment of a <span class="my-code" decode="exclude">define-macro</span> syn­tax pat­tern matches lit­er­ally …</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6DCdl&quot;)"></div><p id="a_6DCdl">… unless it’s in <span class="my-code" decode="exclude">ALL-CAPS</span>, which denotes a <em><a class="glossary" href="../appendix/glossary.html#pattern-variable"><span class="glossary-link-text">pat­tern vari­able</span></a></em> that can match any­thing. The name of a pat­tern vari­able can be what­ever we like. In this case, we use <span class="my-code" decode="exclude">OP-OR-LOOP-ARG</span>, to remind us that our matched item is either a <span class="my-code" decode="exclude">bf-op</span> or <span class="my-code" decode="exclude">bf-loop</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VcWHa&quot;)"></div><p id="a_VcWHa">Finally, the ellip­sis, which is sim­i­lar to a <span class="my-code" decode="exclude">*</span> quan­ti­fier in reg­u­lar expres­sions. When used after a pat­tern vari­able, the ellip­sis gath­ers all the argu­ments that fol­low. Like a <span class="my-code" decode="exclude">*</span> quan­ti­fier, the <span class="my-code" decode="exclude">OP-OR-LOOP-ARG ...</span> com­bi­na­tion can also match zero argu­ments.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UNYtj&quot;)"></div><p id="a_UNYtj">Taken together, our syn­tax pat­tern above will define a macro called <span class="my-code" decode="exclude">bf-program</span> that can take any num­ber of argu­ments, which are matched to <span class="my-code" decode="exclude">OP-OR-LOOP-ARG ...</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Gze7D&quot;)"></div><p id="a_Gze7D">This syn­tax pat­tern will han­dle every pos­si­ble pat­tern of argu­ments described by the <span class="my-code" decode="exclude">bf-program</span> pro­duc­tion rule in the gram­mar. In gen­eral, as we con­vert the gram­mar into macros, we’ll essen­tially be trans­lat­ing each pro­duc­tion rule into a syn­tax pat­tern.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_C4A2d&quot;)"></div><p id="a_C4A2d">Here’s the rest of the <span class="my-code" decode="exclude">bf-program</span> macro:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fy7ue&quot;)"></div><div class="highlight-container" id="a_fy7ue"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(void OP-OR-LOOP-ARG ...))<br/>(provide bf-program)</div><div class="highlight" form="false" id="a_I6QT9"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kZLOu&quot;)"></div><p id="a_kZLOu">We recall that the return value of a macro is a <a class="glossary" href="../appendix/glossary.html#syntax-template"><span class="glossary-link-text">syn­tax tem­plate</span></a> for the rewrit­ten code. In this case, because <span class="my-code" decode="exclude">bf</span> pro­grams have their own print­ing com­mands, we’ll just pass our input argu­ments to the func­tion <a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a>, which dis­cards them. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Sim­i­lar to pip­ing out­put to <span class="my-code" decode="exclude">/dev/null</span> in Unixy oper­at­ing sys­tems, for those who have done that.</span></span> When we write our syn­tax tem­plate, we use the pat­tern vari­ables and ellipses from the syn­tax pat­tern. When the macro is invoked, they’ll be replaced with the actual input.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kLPxa&quot;)"></div><p id="a_kLPxa">Next, our <span class="my-code" decode="exclude">bf-loop</span> macro. Let’s review the pro­duc­tion rule for <span class="my-code" decode="exclude">bf-loop</span>, so it can guide our syn­tax pat­tern for the macro def­i­n­i­tion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_y2rjI&quot;)"></div><div class="highlight-container" id="a_y2rjI"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">bf-loop : "[" (bf-op | bf-loop)* "]"</div><div class="highlight" form="false" id="a_upX7J"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>bf-loop : "[" (bf-op | bf-loop)* "]"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1rpy8&quot;)"></div><p id="a_1rpy8">This is the same as the <span class="my-code" decode="exclude">bf-program</span> rule, but with <span class="my-code" decode="exclude">"["</span> and <span class="my-code" decode="exclude">"]"</span> sur­round­ing the <span class="my-code" decode="exclude">bf-op</span> or <span class="my-code" decode="exclude">bf-loop</span> argu­ments in the mid­dle. So our syn­tax pat­tern for this macro will look sim­i­lar to the <span class="my-code" decode="exclude">bf-program</span> macro, but with brack­ets added:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4IesD&quot;)"></div><div class="highlight-container" id="a_4IesD"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(bf-loop "[" OP-OR-LOOP-ARG ... "]")</div><div class="highlight" form="false" id="a_JgrKx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bdF2f&quot;)"></div><p id="a_bdF2f">Now we can put in the macro:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8Sjal&quot;)"></div><div class="highlight-container" id="a_8Sjal"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(void OP-OR-LOOP-ARG ...))<br/>(provide bf-program)<br/><br/>(define-macro (bf-loop "[" OP-OR-LOOP-ARG ... "]")<br/>  #'(until (zero? (current-byte)) ; function coming soon<br/>      OP-OR-LOOP-ARG ...))<br/>(provide bf-loop)</div><div class="highlight" form="false" id="a_oblJ3"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/cond..rkt)._until))" class="docs" hyphens="none">until</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" class="docs" hyphens="none">zero?</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))</span> <span class="c1">; function coming soon</span>
</span><span class="hll">      <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-loop</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WYhYa&quot;)"></div><p id="a_WYhYa">We remem­ber from <a href="intro.html#how-bf-works">how <span class="my-code" decode="exclude">bf</span> works</a> that the argu­ments inside a loop are eval­u­ated repeat­edly until the cur­rent byte is zero. We can imple­ment this behav­ior with an <doc>until</doc> con­di­tional, which keeps eval­u­at­ing its body expres­sions until the cur­rent byte is <span class="my-code" decode="exclude">zero?</span>. To get that value, we’ll call a <span class="my-code" decode="exclude">current-byte</span> func­tion that doesn’t exist yet (but we’ll add it in a minute).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;from-one-syntax-pattern-to-more&quot;)"></div><h3 anchor="from-one-syntax-pattern-to-more" class="subhead" id="from-one-syntax-pattern-to-more"><a href="#from-one-syntax-pattern-to-more">From one syn­tax pat­tern to more</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PrryF&quot;)"></div><p id="a_PrryF">Now to han­dle <span class="my-code" decode="exclude">bf-op</span>. As we saw in the gram­mar and sam­ple parse trees, a <span class="my-code" decode="exclude">bf-op</span> node holds a char­ac­ter from the source code that tells us how <span class="my-code" decode="exclude">bf-op</span> should behave:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zUXKK&quot;)"></div><div class="highlight-container" id="a_zUXKK"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">bf-op : "&gt;" | "&lt;" | "+" | "-" | "." | ","</div><div class="highlight" form="false" id="a_atZSP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>bf-op : "&gt;" | "&lt;" | "+" | "-" | "." | ","
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_g0EDg&quot;)"></div><p id="a_g0EDg">As we did with <span class="my-code" decode="exclude">bf-program</span> and <span class="my-code" decode="exclude">bf-loop</span>, we’ll trans­late this pro­duc­tion rule into a syn­tax pat­tern for the <span class="my-code" decode="exclude">bf-op</span> macro.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1BRt7&quot;)"></div><p id="a_1BRt7">The wrin­kle this time is that <span class="my-code" decode="exclude">bf-op</span> has six pos­si­ble pat­terns. To han­dle this, we’ll use a vari­ant of <span class="my-code" decode="exclude">define-macro</span> called <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a> that will let us set up our macro with six cases, one for each char­ac­ter we might get from <span class="my-code" decode="exclude">bf-op</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KpjpR&quot;)"></div><p id="a_KpjpR">Sim­i­lar to <a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a>, <span class="my-code" decode="exclude">define-macro-cases</span> can have any num­ber of branches. Each branch has a syn­tax pat­tern on the left, and a syn­tax tem­plate on the right. When the macro is invoked, each pat­tern on the left is tested in order. When a pat­tern matches, the syn­tax tem­plate on the right is returned. So if we just fill in the syn­tax pat­terns, we get this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_C1KWA&quot;)"></div><div class="highlight-container" id="a_C1KWA"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases bf-op<br/>  [(bf-op "&gt;") ···]<br/>  [(bf-op "&lt;") ···]<br/>  [(bf-op "+") ···]<br/>  [(bf-op "-") ···]<br/>  [(bf-op ".") ···]<br/>  [(bf-op ",") ···])<br/>(provide bf-op)</div><div class="highlight" form="false" id="a_vjTYK"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">bf-op</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&gt;"</span><span class="p">)</span> <span class="n">···</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&lt;"</span><span class="p">)</span> <span class="n">···</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"+"</span><span class="p">)</span> <span class="n">···</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"-"</span><span class="p">)</span> <span class="n">···</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"."</span><span class="p">)</span> <span class="n">···</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">","</span><span class="p">)</span> <span class="n">···</span><span class="p">])</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-op</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_a5jVA&quot;)"></div><p id="a_a5jVA">Our <span class="my-code" decode="exclude">bf-op</span> macro needs to con­vert these six pat­terns into func­tions that imple­ment the <span class="my-code" decode="exclude">bf</span> lan­guage. For now, let’s put in the names of those func­tions—we’ll fill in their def­i­n­i­tions in a moment. The fin­ished <span class="my-code" decode="exclude">bf-op</span> macro looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uEXCL&quot;)"></div><div class="highlight-container" id="a_uEXCL"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(void OP-OR-LOOP-ARG ...))<br/>(provide bf-program)<br/><br/>(define-macro (bf-loop "[" OP-OR-LOOP-ARG ... "]")<br/>  #'(until (zero? (current-byte)) ; function coming soon<br/>           OP-OR-LOOP-ARG ...))<br/>(provide bf-loop)<br/><br/>(define-macro-cases bf-op<br/>  [(bf-op "&gt;") #'(gt)]        ; We have<br/>  [(bf-op "&lt;") #'(lt)]        ; not made<br/>  [(bf-op "+") #'(plus)]      ; these functions<br/>  [(bf-op "-") #'(minus)]     ; yet, but<br/>  [(bf-op ".") #'(period)]    ; we will<br/>  [(bf-op ",") #'(comma)])    ; shortly.<br/>(provide bf-op)</div><div class="highlight" form="false" id="a_CZceW"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/cond..rkt)._until))" class="docs" hyphens="none">until</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" class="docs" hyphens="none">zero?</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))</span> <span class="c1">; function coming soon</span>
           <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-loop</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">bf-op</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&gt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">gt</span><span class="p">)]</span>        <span class="c1">; We have</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&lt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">lt</span><span class="p">)]</span>        <span class="c1">; not made</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"+"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">plus</span><span class="p">)]</span>      <span class="c1">; these functions</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"-"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">minus</span><span class="p">)]</span>     <span class="c1">; yet, but</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"."</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">period</span><span class="p">)]</span>    <span class="c1">; we will</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">","</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">comma</span><span class="p">)])</span>    <span class="c1">; shortly.</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-op</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9FBT2&quot;)"></div><p id="a_9FBT2">Now we need to add the miss­ing func­tions that imple­ment the rest of the <span class="my-code" decode="exclude">bf</span> lan­guage.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;implementing-the-bf-byte-array&quot;)"></div><h3 anchor="implementing-the-bf-byte-array" class="subhead" id="implementing-the-bf-byte-array"><a href="#implementing-the-bf-byte-array">Imple­ment­ing the BF byte array</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ih8UQ&quot;)"></div><p id="a_Ih8UQ">Recall from <a href="intro.html#how-bf-works">how <span class="my-code" decode="exclude">bf</span> works</a> that when a <span class="my-code" decode="exclude">bf</span> pro­gram starts, it cre­ates an <em>array</em> of 30,000 bytes (ini­tial­ized to 0) and a <em>pointer</em> into that array (ini­tial­ized to the 0 posi­tion). The array and the pointer are <a class="glossary" href="../appendix/glossary.html#state"><span class="glossary-link-text">state</span></a> val­ues: they keep a record of what’s hap­pened in the pro­gram so far.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pZNCy&quot;)"></div><p id="a_pZNCy">We’ll fol­low this descrip­tion by imple­ment­ing the byte array as a Racket <em><a class="glossary" href="../appendix/glossary.html#vector"><span class="glossary-link-text">vec­tor</span></a></em>. Unlike a Racket <a class="explainer" href="../explainer/lists.html">list</a>, a vec­tor is not a series of linked pairs. It’s just a block of mem­ory, so it’s typ­i­cally bet­ter in sit­u­a­tions that require ran­dom, non­se­quen­tial access to data ele­ments. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">See <a class="explainer" href="../explainer/data-structures.html">data struc­tures</a> for more about which Racket data struc­tures are suit­able for which needs.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WeV9Z&quot;)"></div><p id="a_WeV9Z">The <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a> func­tion takes two argu­ments: a size for the vec­tor, and a default value for its cells. Our pointer can just be the num­ber <span class="my-code" decode="exclude">0</span>. Let’s add them to <span class="my-code" decode="exclude">"expander.rkt"</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wHoTd&quot;)"></div><div class="highlight-container" id="a_wHoTd"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define arr (make-vector 30000 0))<br/>(define ptr 0)</div><div class="highlight" form="false" id="a_GjLs0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a></span> <span class="mi">30000</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ptr</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y23Xq&quot;)"></div><p id="a_Y23Xq">Unlike our macros, we don’t have to <span class="my-code" decode="exclude">provide</span> our array vari­ables because they don’t need to be vis­i­ble out­side the expander. They’re just for inter­nal use.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_klapx&quot;)"></div><p id="a_klapx">The <em>cur­rent byte</em> is the byte in the array at the loca­tion indi­cated by the pointer. So our <span class="my-code" decode="exclude">current-byte</span> func­tion just gets the value from <span class="my-code" decode="exclude">arr</span> at the posi­tion <span class="my-code" decode="exclude">ptr</span> using <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_R4XEx&quot;)"></div><div class="highlight-container" id="a_R4XEx"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (current-byte) (vector-ref arr ptr))</div><div class="highlight" form="false" id="a_9caK6"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PpE2a&quot;)"></div><p id="a_PpE2a">Other func­tions also need to set the cur­rent byte. For that, we use <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FK1GN&quot;)"></div><div class="highlight-container" id="a_FK1GN"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (set-current-byte! val) (vector-set! arr ptr val))</div><div class="highlight" form="false" id="a_CRMEW"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="n">val</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a></span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_i17cj&quot;)"></div><p id="a_i17cj">Then we need to make the func­tions used in our <span class="my-code" decode="exclude">bf-op</span> macro. The <span class="my-code" decode="exclude">gt</span> and <span class="my-code" decode="exclude">lt</span> func­tions—cor­re­spond­ing to the <span class="my-code" decode="exclude">bf</span> oper­a­tions <span class="my-code" decode="exclude">&gt;</span> and <span class="my-code" decode="exclude">&lt;</span>—increase or decrease the pointer by one. As we did in <a href="../stacker/index.html"><span class="my-code" decode="exclude">stacker</span></a>, we mutate our state vari­able <span class="my-code" decode="exclude">ptr</span>, using <span class="my-code" decode="exclude">set!</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EBFjk&quot;)"></div><div class="highlight-container" id="a_EBFjk"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (gt) (set! ptr (add1 ptr)))<br/>(define (lt) (set! ptr (sub1 ptr)))</div><div class="highlight" form="false" id="a_q2M5q"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">gt</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="n">ptr</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">lt</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="n">ptr</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Gaozr&quot;)"></div><p id="a_Gaozr">The <span class="my-code" decode="exclude">plus</span> and <span class="my-code" decode="exclude">minus</span> func­tions—cor­re­spond­ing to the <span class="my-code" decode="exclude">bf</span> oper­a­tions <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">-</span>—increase or decrease the value of the cur­rent byte. We can express these oper­a­tions in terms of <span class="my-code" decode="exclude">current-byte</span> and <span class="my-code" decode="exclude">set-current-byte!</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_X3dNs&quot;)"></div><div class="highlight-container" id="a_X3dNs"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (plus) (set-current-byte! (add1 (current-byte))))<br/>(define (minus) (set-current-byte! (sub1 (current-byte))))</div><div class="highlight" form="false" id="a_YRqIc"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">plus</span><span class="p">)</span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">minus</span><span class="p">)</span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sjyne&quot;)"></div><p id="a_sjyne">The <span class="my-code" decode="exclude">period</span> func­tion, cor­re­spond­ing to a <span class="my-code" decode="exclude">.</span> in <span class="my-code" decode="exclude">bf</span> code, writes the cur­rent byte to stan­dard out­put. We use the Racket library func­tion <span class="my-code" decode="exclude">write-byte</span> to help out:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GjPCj&quot;)"></div><div class="highlight-container" id="a_GjPCj"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (period) (write-byte (current-byte)))</div><div class="highlight" form="false" id="a_rejPE"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Output.html#(def._((quote._~23~25kernel)._write-byte))" class="docs" hyphens="none">write-byte</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mjhq2&quot;)"></div><p id="a_mjhq2">Finally, the <span class="my-code" decode="exclude">comma</span> func­tion, cor­re­spond­ing to a <span class="my-code" decode="exclude">,</span> in <span class="my-code" decode="exclude">bf</span> code, sets the cur­rent byte to one read from stan­dard input. We can do this with the Racket func­tion <span class="my-code" decode="exclude">read-byte</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mHgKx&quot;)"></div><div class="highlight-container" id="a_mHgKx"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (comma) (set-current-byte! (read-byte)))</div><div class="highlight" form="false" id="a_JbEnj"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">comma</span><span class="p">)</span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-byte))" class="docs" hyphens="none">read-byte</a></span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OFmLf&quot;)"></div><p id="a_OFmLf">Taken together, our expander should now look like this, with the new array imple­men­ta­tion high­lighted:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YdODt&quot;)"></div><div class="highlight-container" id="a_YdODt"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/> <br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(void OP-OR-LOOP-ARG ...))<br/>(provide bf-program)<br/><br/>(define-macro (bf-loop "[" OP-OR-LOOP-ARG ... "]")<br/>  #'(until (zero? (current-byte))<br/>      OP-OR-LOOP-ARG ...))<br/>(provide bf-loop)<br/><br/>(define-macro-cases bf-op<br/>  [(bf-op "&gt;") #'(gt)]<br/>  [(bf-op "&lt;") #'(lt)]<br/>  [(bf-op "+") #'(plus)]<br/>  [(bf-op "-") #'(minus)]<br/>  [(bf-op ".") #'(period)]<br/>  [(bf-op ",") #'(comma)])<br/>(provide bf-op)<br/><br/>(define arr (make-vector 30000 0))<br/>(define ptr 0)<br/><br/>(define (current-byte) (vector-ref arr ptr))<br/>(define (set-current-byte! val) (vector-set! arr ptr val))<br/><br/>(define (gt) (set! ptr (add1 ptr)))<br/>(define (lt) (set! ptr (sub1 ptr)))<br/>(define (plus) (set-current-byte! (add1 (current-byte))))<br/>(define (minus) (set-current-byte! (sub1 (current-byte))))<br/>(define (period) (write-byte (current-byte)))<br/>(define (comma) (set-current-byte! (read-byte)))<br/>
</div><div class="highlight" form="false" id="a_Fggt7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/cond..rkt)._until))" class="docs" hyphens="none">until</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" class="docs" hyphens="none">zero?</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))</span>
      <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-loop</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">bf-op</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&gt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">gt</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&lt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">lt</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"+"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">plus</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"-"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">minus</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"."</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">period</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">","</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">comma</span><span class="p">)])</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-op</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a></span> <span class="mi">30000</span> <span class="mi">0</span><span class="p">))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ptr</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="n">val</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a></span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">gt</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="n">ptr</span><span class="p">)))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">lt</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="n">ptr</span><span class="p">)))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">plus</span><span class="p">)</span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">minus</span><span class="p">)</span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">))))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Output.html#(def._((quote._~23~25kernel)._write-byte))" class="docs" hyphens="none">write-byte</a></span> <span class="p">(</span><span class="n">current-byte</span><span class="p">)))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">comma</span><span class="p">)</span> <span class="p">(</span><span class="n">set-current-byte!</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-byte))" class="docs" hyphens="none">read-byte</a></span><span class="p">)))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-bf-expander&quot;)"></div><h3 anchor="testing-our-bf-expander" class="subhead" id="testing-our-bf-expander"><a href="#testing-our-bf-expander">Test­ing our BF expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Rhf0Z&quot;)"></div><p id="a_Rhf0Z">Let’s con­firm that our test file <span class="my-code" decode="exclude">"atsign.rkt"</span> is ready to go:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">atsign.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qs9uS&quot;)"></div><div class="highlight-container" id="a_qs9uS"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "reader.rkt"<br/>Greatest language ever!<br/>++++-+++-++-++[&gt;++++-+++-++-++&lt;-]&gt;.</div><div class="highlight" form="false" id="a_ihAov"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>#lang reader "reader.rkt"
<span class="c">Greatest language ever!</span>
<span class="nb">++++-+++-++-++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++++-+++-++-++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bTQdL&quot;)"></div><p id="a_bTQdL">When we run this, we’ll see the result:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vXFJF&quot;)"></div><div class="highlight-container" id="a_vXFJF"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">@</div><div class="highlight" form="false" id="a_HzK2V"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>@
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkn" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_T8Wr4&quot;)"></div><p id="a_T8Wr4">Great—this shows that the macros in our expander are suc­cess­fully con­vert­ing a <span class="my-code" decode="exclude">bf</span> parse tree into func­tions that cor­rectly imple­ment the <span class="my-code" decode="exclude">bf</span> lan­guage rules.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EdtH6&quot;)"></div><p id="a_EdtH6">What if we try to run our “Hello World” <span class="my-code" decode="exclude">bf</span> pro­gram with our new imple­men­ta­tion?</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">hello.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Tpz7A&quot;)"></div><div class="highlight-container" id="a_Tpz7A"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "reader.rkt"<br/>++++++[&gt;++++++++++++&lt;-]&gt;.<br/>&gt;++++++++++[&gt;++++++++++&lt;-]&gt;+.<br/>+++++++..+++.&gt;++++[&gt;+++++++++++&lt;-]&gt;.<br/>&lt;+++[&gt;----&lt;-]&gt;.&lt;&lt;&lt;&lt;&lt;+++[&gt;+++++&lt;-]&gt;.<br/>&gt;&gt;.+++.------.--------.&gt;&gt;+.</div><div class="highlight" form="false" id="a_JRAjt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>#lang reader "reader.rkt"
<span class="nb">++++++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++++++++++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
<span class="nv">&gt;</span><span class="nb">++++++++++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++++++++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nt">.</span><span class="c"></span>
<span class="nb">+++++++</span><span class="nt">..</span><span class="nb">+++</span><span class="nt">.</span><span class="nv">&gt;</span><span class="nb">++++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+++++++++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
<span class="nv">&lt;</span><span class="nb">+++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">----</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="nb">+++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
<span class="nv">&gt;&gt;</span><span class="nt">.</span><span class="nb">+++</span><span class="nt">.</span><span class="nb">------</span><span class="nt">.</span><span class="nb">--------</span><span class="nt">.</span><span class="nv">&gt;&gt;</span><span class="nb">+</span><span class="nt">.</span><span class="c"></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GvQMh&quot;)"></div><div class="highlight-container" id="a_GvQMh"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">Hello, World!</div><div class="highlight" form="false" id="a_9xUJa"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>Hello, World!
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkp" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_utCMl&quot;)"></div><p id="a_utCMl">How about that fac­to­r­ial gen­er­a­tor? (Warn­ing: this pro­gram will emit fac­to­ri­als until you stop it. To inter­rupt a run­ning pro­gram in DrRacket, use the menu options <em>Racket → Ask the Pro­gram to Quit</em> or <em>Racket → Force the Pro­gram to Quit</em>):</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">factorial.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_W1WwU&quot;)"></div><div class="highlight-container" id="a_W1WwU"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "reader.rkt"<br/>&gt;++++++++++&gt;&gt;&gt;+&gt;+[&gt;&gt;&gt;+[-[&lt;&lt;&lt;&lt;&lt;[+&lt;&lt;&lt;&lt;&lt;]&gt;&gt;[[-]&gt;[&lt;&lt;+&gt;+&gt;-]<br/>&lt;[&gt;+&lt;-]&lt;[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-<br/>[&gt;[-]&gt;&gt;&gt;&gt;+&gt;+&lt;&lt;&lt;&lt;&lt;&lt;-[&gt;+&lt;-]]]]]]]]]]]&gt;[&lt;+&gt;-]+&gt;&gt;&gt;&gt;&gt;]&lt;&lt;&lt;&lt;&lt;<br/>[&lt;&lt;&lt;&lt;&lt;]&gt;&gt;&gt;&gt;&gt;&gt;&gt;[&gt;&gt;&gt;&gt;&gt;]++[-&lt;&lt;&lt;&lt;&lt;]&gt;&gt;&gt;&gt;&gt;&gt;-]+&gt;&gt;&gt;&gt;&gt;]&lt;[&gt;++&lt;-]<br/>&lt;&lt;&lt;&lt;[&lt;[&gt;+&lt;-]&lt;&lt;&lt;&lt;]&gt;&gt;[-&gt;[-]++++++[&lt;++++++++&gt;-]&gt;&gt;&gt;&gt;]&lt;&lt;&lt;&lt;&lt;<br/>[&lt;[&gt;+&gt;+&lt;&lt;-]&gt;.&lt;&lt;&lt;&lt;&lt;]&gt;.&gt;&gt;&gt;&gt;]</div><div class="highlight" form="false" id="a_mK2Ne"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre>#lang reader "reader.rkt"
<span class="nv">&gt;</span><span class="nb">++++++++++</span><span class="nv">&gt;&gt;&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="k">[</span><span class="nv">&gt;&gt;&gt;</span><span class="nb">+</span><span class="k">[</span><span class="nb">-</span><span class="k">[</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">[</span><span class="nb">+</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;</span><span class="k">[[</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="k">[</span><span class="nv">&lt;&lt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">-</span><span class="k">]</span><span class="c"></span>
<span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"></span>
<span class="k">[</span><span class="nv">&gt;</span><span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;&lt;&lt;&lt;&lt;&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]]]]]]]]]]]</span><span class="nv">&gt;</span><span class="k">[</span><span class="nv">&lt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">-</span><span class="k">]</span><span class="nb">+</span><span class="nv">&gt;&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="c"></span>
<span class="k">[</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="k">[</span><span class="nv">&gt;&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nb">++</span><span class="k">[</span><span class="nb">-</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="nb">-</span><span class="k">]</span><span class="nb">+</span><span class="nv">&gt;&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="c"></span>
<span class="nv">&lt;&lt;&lt;&lt;</span><span class="k">[</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;</span><span class="k">[</span><span class="nb">-</span><span class="nv">&gt;</span><span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="nb">++++++</span><span class="k">[</span><span class="nv">&lt;</span><span class="nb">++++++++</span><span class="nv">&gt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="c"></span>
<span class="k">[</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="nv">&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="c"></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NIosL&quot;)"></div><div class="highlight-container" id="a_NIosL"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">1<br/>1<br/>2<br/>6<br/>24<br/>120<br/>720<br/>5040<br/>40320<br/>362880<br/>3628800<br/>39916800<br/>479001600<br/>6227020800<br/>87178291200<br/>1307674368000<br/>···</div><div class="highlight" form="false" id="a_DoTPF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre>1
1
2
6
24
120
720
5040
40320
362880
3628800
39916800
479001600
6227020800
87178291200
1307674368000
···
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3fph4&quot;)"></div><p id="a_3fph4">That’s it—we’ve suc­cess­fully imple­mented the <span class="my-code" decode="exclude">bf</span> lan­guage. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">… minus some fid­dly <a class=" ext" href="https://en.wikipedia.org/wiki/Brainfuck#Portability_issues">porta­bil­ity details</a>, which are too dull to pur­sue here.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Cee59&quot;)"></div><p id="a_Cee59">In real life, we’d want to run a larger set of sam­ple pro­grams before draw­ing opti­mistic con­clu­sions. But we’ll defer that kind of stress test­ing for a <a href="../jsonic-2/unit-tests.html">later tuto­r­ial</a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;the-big-but&quot;)"></div><h3 anchor="the-big-but" class="subhead" id="the-big-but"><a href="#the-big-but">The big but</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aF8Yg&quot;)"></div><p id="a_aF8Yg">In this ver­sion of the expander, we imple­mented <span class="my-code" decode="exclude">bf</span> in an imper­a­tive-pro­gram­ming style. We set up two state val­ues (<span class="my-code" decode="exclude">arr</span> and <span class="my-code" decode="exclude">ptr</span>) and called func­tions (<span class="my-code" decode="exclude">gt</span>, <span class="my-code" decode="exclude">lt</span>, <span class="my-code" decode="exclude">plus</span>, and <span class="my-code" decode="exclude">minus</span>) that mutated them. This wasn’t wrong—our test pro­grams worked. And it had a cer­tain logic, as <span class="my-code" decode="exclude">bf</span> itself is an imper­a­tive lan­guage. Who knows—on a cer­tain set of test pro­grams, this may even turn out to be the fastest approach.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pRMTO&quot;)"></div><p id="a_pRMTO">But it’s not idiomatic in Racket, where func­tional pro­gram­ming is the favored style. So we’d be short­chang­ing our­selves if we stopped here. Now that we have a men­tal model for how <span class="my-code" decode="exclude">bf</span> works as a Racket lan­guage, let’s con­vert our expander to a func­tional-pro­gram­ming style.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="grammars-and-parsers.html">2&emsp;gram­mars and parsers</a></li><li><a href="grammar-notation.html">3&emsp;gram­mar nota­tion</a></li><li><a href="the-parser.html">4&emsp;the parser</a></li><li><a href="the-tokenizer-and-reader.html">5&emsp;the tok­enizer and reader</a></li><li><a class="here" href="an-imperative-expander.html">6&emsp;an imper­a­tive expander</a></li><li><a href="a-functional-expander.html">7&emsp;a func­tional expander</a></li><li><a href="packaging-our-language.html">8&emsp;pack­ag­ing our lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="the-tokenizer-and-reader.html">← prev</a>
    <a class="nav-right" href="a-functional-expander.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>