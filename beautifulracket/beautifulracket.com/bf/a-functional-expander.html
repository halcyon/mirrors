<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/bf/a-functional-expander.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:16 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Follow the grammar: bf</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;follow-the-grammar-bf&quot;)"></div><h1 anchor="follow-the-grammar-bf" id="follow-the-grammar-bf" hyphens="none">Follow the grammar: <span class="my-code" decode="exclude">bf</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="grammars-and-parsers.html">2&emsp;gram­mars and parsers</a></li><li><a href="grammar-notation.html">3&emsp;gram­mar nota­tion</a></li><li><a href="the-parser.html">4&emsp;the parser</a></li><li><a href="the-tokenizer-and-reader.html">5&emsp;the tok­enizer and reader</a></li><li><a href="an-imperative-expander.html">6&emsp;an imper­a­tive expander</a></li><li><a class="here" href="a-functional-expander.html">7&emsp;a func­tional expander</a></li><li><a href="packaging-our-language.html">8&emsp;pack­ag­ing our lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;functional-thinking&quot;)"></div><h3 anchor="functional-thinking" class="subhead" id="functional-thinking"><a href="#functional-thinking">Func­tional think­ing</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_v1oa7&quot;)"></div><p id="a_v1oa7">In the func­tional ver­sion of the <span class="my-code" decode="exclude">bf</span> expander, we have two goals:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TdrVg&quot;)"></div><p id="a_TdrVg">Avoid keep­ing <em><a class="glossary" href="../appendix/glossary.html#state"><span class="glossary-link-text">state</span></a></em>—that is, vari­ables that main­tain a record of what’s hap­pened in the pro­gram.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tWhhE&quot;)"></div><p id="a_tWhhE">Avoid <em><a class="glossary" href="../appendix/glossary.html#mutation"><span class="glossary-link-text">muta­tion</span></a></em>—that is, using func­tions to change the value of state vari­ables from afar.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Q4L1s&quot;)"></div><p id="a_Q4L1s">What makes this tricky is that <span class="my-code" decode="exclude">bf</span> is, by its nature, an imper­a­tive lan­guage. Recall from <a href="intro.html#how-bf-works">how <span class="my-code" decode="exclude">bf</span> works</a> that the lan­guage relies on two state val­ues: a mem­ory array of 30,000 bytes, and a pointer into that array.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zDZXf&quot;)"></div><p id="a_zDZXf">In <a href="../funstacker/index.html"><span class="my-code" decode="exclude">funstacker</span></a>, we learned that we could <a href="../funstacker/the-rewrite.html#rewriting-our-expander">approx­i­mate the behav­ior</a> of state vari­ables by turn­ing them into <a class="glossary" href="../appendix/glossary.html#accumulator"><span class="glossary-link-text">accu­mu­la­tors</span></a> within a <a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a> loop. That’s a good start. But unlike <span class="my-code" decode="exclude">funstacker</span>, it won’t be enough. We need to step back and adjust our con­cep­tual model of our <span class="my-code" decode="exclude">bf</span> imple­men­ta­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_asyqB&quot;)"></div><p id="a_asyqB">Before, we mod­eled our <span class="my-code" decode="exclude">bf</span> oper­a­tions as trig­ger­ing func­tions that mutated exist­ing state vari­ables. But these func­tions took no argu­ments, and returned no val­ues.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZTmOi&quot;)"></div><p id="a_ZTmOi">This time, con­sis­tent with the func­tional-pro­gram­ming idiom, we’ll model our <span class="my-code" decode="exclude">bf</span> oper­a­tions as func­tions that take the cur­rent array &amp; pointer val­ues as input, oper­ate on them, and then return new array &amp; pointer val­ues as out­put. This out­put, in turn, becomes the input to the next func­tion in line. In other words, rather than stor­ing state val­ues <em>out­side</em> our func­tions, we’ll let the val­ues travel <em>through</em> the func­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OGX3d&quot;)"></div><p id="a_OGX3d">By the way, is this approach guar­an­teed to give us a <span class="my-code" decode="exclude">bf</span> expander that’s shorter than the <a href="an-imperative-expander.html">imper­a­tive expander</a>? No. Faster? No. Morally supe­rior? No. But the func­tional approach is more idiomatic to Racket. It will become a more vital skill as we advance through the tuto­ri­als, even if it’s not a huge ben­e­fit for <span class="my-code" decode="exclude">bf</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;restarting-the-expander&quot;)"></div><h3 anchor="restarting-the-expander" class="subhead" id="restarting-the-expander"><a href="#restarting-the-expander">(Re)start­ing the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IrIFG&quot;)"></div><p id="a_IrIFG">First, let’s strip our <span class="my-code" decode="exclude">"expander.rkt"</span> mod­ule back to the <span class="my-code" decode="exclude">bf-module-begin</span> macro, which will be the same:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y8nhE&quot;)"></div><div class="highlight-container" id="a_Y8nhE"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_fcKmh"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vRp94&quot;)"></div><p id="a_vRp94">As before, we’ll need to write macros to han­dle <span class="my-code" decode="exclude">bf-program</span>, <span class="my-code" decode="exclude">bf-op</span>, and <span class="my-code" decode="exclude">bf-loop</span> nodes in our parse tree. But before we get to those, we’ll make a helper func­tion that will be the engine of our inter­preter.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;applying-pressure&quot;)"></div><h3 anchor="applying-pressure" class="subhead" id="applying-pressure"><a href="#applying-pressure">Apply­ing pres­sure</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1Cmne&quot;)"></div><p id="a_1Cmne">Our goal is to allow our two <span class="my-code" decode="exclude">bf</span> state val­ues—a mem­ory array of 30,000 bytes, and a pointer into that array—to be passed from one <span class="my-code" decode="exclude">bf</span> oper­a­tion to the next.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aikJA&quot;)"></div><p id="a_aikJA">To do that, these new <span class="my-code" decode="exclude">bf</span> oper­a­tions will mod­eled as func­tions that take two input argu­ments—an array and a pointer—and return a new array and a new pointer. It’s pos­si­ble for Racket func­tions to return mul­ti­ple val­ues (see <a class="explainer" href="../explainer/functions.html">func­tions</a>). But we’ll keep things sim­ple and pack­age the new array and pointer inside a <a class="explainer" href="../explainer/lists.html">list</a>, which will behave as a sin­gle return value. So the new func­tions imple­ment­ing our <span class="my-code" decode="exclude">bf</span> oper­a­tions will fol­low this pat­tern:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OqUlq&quot;)"></div><div class="highlight-container" id="a_OqUlq"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (bf-func arr ptr)<br/>  ;; manipulate the array and pointer ...<br/>  (list new-arr new-ptr))</div><div class="highlight" form="false" id="a_plurP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">bf-func</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
  <span class="c1">;; manipulate the array and pointer ...</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">new-arr</span> <span class="n">new-ptr</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HBrPX&quot;)"></div><p id="a_HBrPX">Next ques­tion: we want the return value of an <span class="my-code" decode="exclude">bf-func</span> to become the input argu­ments of the <span class="my-code" decode="exclude">next-bf-func</span>. But we seem to have an imped­ance mis­match: an <span class="my-code" decode="exclude">bf-func</span> only returns one argu­ment, but <span class="my-code" decode="exclude">next-bf-func</span> needs two argu­ments as input.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NYeQc&quot;)"></div><div class="highlight-container" id="a_NYeQc"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define bf-func-result-list (bf-func arr ptr))<br/>(next-bf-func bf-func-result-list) ; this won't work</div><div class="highlight" form="false" id="a_DJhiN"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">bf-func-result-list</span> <span class="p">(</span><span class="n">bf-func</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
<span class="p">(</span><span class="n">next-bf-func</span> <span class="n">bf-func-result-list</span><span class="p">)</span> <span class="c1">; this won&#39;t work</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bS3Iu&quot;)"></div><p id="a_bS3Iu">We can cure this mis­match with <a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a>. The idea behind <span class="my-code" decode="exclude">apply</span> is sim­ple: it takes a func­tion and a list of val­ues as input, and calls the func­tion while using those val­ues as input argu­ments. So these two expres­sions are always equiv­a­lent:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OA1aM&quot;)"></div><div class="highlight-container" id="a_OA1aM"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply func (list arg1 arg2 arg3 arg4))<br/>(func arg1 arg2 arg3 arg4)</div><div class="highlight" form="false" id="a_KV7QQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arg1</span> <span class="n">arg2</span> <span class="n">arg3</span> <span class="n">arg4</span><span class="p">))</span>
<span class="p">(</span><span class="n">func</span> <span class="n">arg1</span> <span class="n">arg2</span> <span class="n">arg3</span> <span class="n">arg4</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tTshP&quot;)"></div><p id="a_tTshP">To go back to our pseudocode exam­ple, since <span class="my-code" decode="exclude">bf-func-result-list</span> is a list of argu­ments, we can use <span class="my-code" decode="exclude">apply</span> to pass them to the <span class="my-code" decode="exclude">next-bf-func</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1jRrq&quot;)"></div><div class="highlight-container" id="a_1jRrq"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define bf-func-result-list (bf-func arr ptr))<br/>(apply next-bf-func bf-func-result-list) ; this will work</div><div class="highlight" form="false" id="a_eYha9"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">bf-func-result-list</span> <span class="p">(</span><span class="n">bf-func</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">next-bf-func</span> <span class="n">bf-func-result-list</span><span class="p">)</span> <span class="c1">; this will work</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HLy4Z&quot;)"></div><p id="a_HLy4Z">Now that we have <span class="my-code" decode="exclude">apply</span>, we can add a key helper func­tion to our expander, called <span class="my-code" decode="exclude">fold-funcs</span>, that will be the engine of our <span class="my-code" decode="exclude">bf</span> inter­preter:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Lu9xX&quot;)"></div><div class="highlight-container" id="a_Lu9xX"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define (fold-funcs apl bf-funcs)<br/>  (for/fold ([current-apl apl])<br/>            ([bf-func (in-list bf-funcs)])<br/>    (apply bf-func current-apl)))</div><div class="highlight" form="false" id="a_wdkRV"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">apl</span> <span class="n">bf-funcs</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="n">apl</span><span class="p">])</span>
</span><span class="hll">            <span class="p">([</span><span class="n">bf-func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="n">bf-funcs</span><span class="p">)])</span>
</span><span class="hll">    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">bf-func</span> <span class="n">current-apl</span><span class="p">)))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_exyIn&quot;)"></div><p id="a_exyIn">Our func­tion relies on <a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a>, which we <a href="../funstacker/the-rewrite.html#rewriting-our-expander">learned about</a> in <a href="../funstacker/index.html"><span class="my-code" decode="exclude">funstacker</span></a> as a way of approx­i­mat­ing state val­ues with <a class="glossary" href="../appendix/glossary.html#accumulator"><span class="glossary-link-text">accu­mu­la­tors</span></a>. Our <span class="my-code" decode="exclude">fold-funcs</span> func­tion takes two input argu­ments: <span class="my-code" decode="exclude">apl</span>, which is a list of a <span class="my-code" decode="exclude">bf</span> array and pointer—in other words, the return value of a <span class="my-code" decode="exclude">bf-func</span>—and a list of <span class="my-code" decode="exclude">bf-funcs</span>. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner"><span class="my-code" decode="exclude">apl</span> = abbre­vi­a­tion for “array–pointer list”. Unre­lat­edly, there’s a fan­tas­tic pro­gram­ming lan­guage from 1964 called <a class=" ext" href="https://scottlocklin.wordpress.com/2013/07/28/ruins-of-forgotten-empires-apl-languages/">APL</a> that required its own spe­cial font. Decades of ASCII dol­drums would fol­low. But Racket sup­ports Uni­code through­out, so it’s once again pos­si­ble to use funny sym­bols in a pro­gram­ming lan­guage.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ulfx2&quot;)"></div><p id="a_Ulfx2">When the <span class="my-code" decode="exclude">for/fold</span> loop starts, it cre­ates an accu­mu­la­tor called <span class="my-code" decode="exclude">current-apl</span> to hold the cur­rent state of the <span class="my-code" decode="exclude">bf</span> pro­gram, and ini­tial­izes it to the <span class="my-code" decode="exclude">apl</span> argu­ment passed as input. Then it iter­ates over the list of <span class="my-code" decode="exclude">bf-funcs</span>. On each pass through the loop, it uses <span class="my-code" decode="exclude">apply</span> to pass <span class="my-code" decode="exclude">current-apl</span> as argu­ments to the next <span class="my-code" decode="exclude">bf-func</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0dM61&quot;)"></div><p id="a_0dM61">As we remem­ber from our pre­vi­ous use of <span class="my-code" decode="exclude">for/fold</span>, the return value of <span class="my-code" decode="exclude">bf-func</span> becomes the new <span class="my-code" decode="exclude">current-apl</span> value for the next pass. Once we run out of <span class="my-code" decode="exclude">bf-funcs</span>, the last value of <span class="my-code" decode="exclude">current-apl</span> becomes the return value of the <span class="my-code" decode="exclude">for/fold</span> loop, and there­fore the whole <span class="my-code" decode="exclude">fold-funcs</span> func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;back-to-macros&quot;)"></div><h3 anchor="back-to-macros" class="subhead" id="back-to-macros"><a href="#back-to-macros">Back to macros</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vw26l&quot;)"></div><p id="a_vw26l">With <span class="my-code" decode="exclude">fold-funcs</span> in hand, we can now rewrite the macros from our imper­a­tive expander in a func­tional style. Noth­ing has changed in our parse tree. So our macros will be defined using the same <a class="glossary" href="../appendix/glossary.html#syntax-pattern"><span class="glossary-link-text">syn­tax pat­terns</span></a> we fig­ured out before.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oTACm&quot;)"></div><p id="a_oTACm">First we have <span class="my-code" decode="exclude">bf-program</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qmT7H&quot;)"></div><div class="highlight-container" id="a_qmT7H"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define (fold-funcs apl bf-funcs)<br/>  (for/fold ([current-apl apl])<br/>            ([bf-func (in-list bf-funcs)])<br/>    (apply bf-func current-apl)))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(begin<br/>      (define first-apl (list (make-vector 30000 0) 0))<br/>      (void (fold-funcs first-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-program)</div><div class="highlight" form="false" id="a_VkSMy"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">apl</span> <span class="n">bf-funcs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="n">apl</span><span class="p">])</span>
            <span class="p">([</span><span class="n">bf-func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="n">bf-funcs</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">bf-func</span> <span class="n">current-apl</span><span class="p">)))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
</span><span class="hll">      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a></span> <span class="mi">30000</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">0</span><span class="p">))</span>
</span><span class="hll">      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_b9XwY&quot;)"></div><p id="a_b9XwY">We’ll set up our ini­tial pro­gram state in <span class="my-code" decode="exclude">first-apl</span>. As before, our <span class="my-code" decode="exclude">bf</span> array is a Racket vec­tor, and the pointer is an inte­ger, and we’ll com­bine them in a <span class="my-code" decode="exclude">list</span>. We’ll pass this <span class="my-code" decode="exclude">first-apl</span> to <span class="my-code" decode="exclude">fold-funcs</span> along with our list of <span class="my-code" decode="exclude">OP-OR-LOOP-ARG ...</span> as the list of <span class="my-code" decode="exclude">bf-funcs</span>. As before, this macro should not return a value, so we’ll pass the result of <span class="my-code" decode="exclude">fold-funcs</span> to <span class="my-code" decode="exclude">void</span>.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qySjI&quot;)"></div><p id="a_qySjI">Next we have <span class="my-code" decode="exclude">bf-loop</span>, which was sim­ple in our imper­a­tive expander, but needs a lit­tle more finesse here. We observe two things:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Nooyv&quot;)"></div><p id="a_Nooyv">When a <span class="my-code" decode="exclude">bf-loop</span> arrives at <span class="my-code" decode="exclude">fold-funcs</span>, it will be expected to behave as a <span class="my-code" decode="exclude">bf-func</span>. So the return value of our <span class="my-code" decode="exclude">bf-loop</span> macro has to be a func­tion that fol­lows the pat­tern we estab­lished for every <span class="my-code" decode="exclude">bf-func</span>—two input argu­ments (an array and a pointer) and one return value (a list of a new array and pointer).</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_h5eaE&quot;)"></div><p id="a_h5eaE">A <span class="my-code" decode="exclude">bf-loop</span> is basi­cally a minia­ture <span class="my-code" decode="exclude">bf</span> pro­gram that runs repeat­edly until a cer­tain con­di­tion is met. So we can del­e­gate the heavy lift­ing to <span class="my-code" decode="exclude">fold-funcs</span>.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_K3sRv&quot;)"></div><p id="a_K3sRv">The macro looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qHfFB&quot;)"></div><div class="highlight-container" id="a_qHfFB"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define (fold-funcs apl bf-funcs)<br/>  (for/fold ([current-apl apl])<br/>            ([bf-func (in-list bf-funcs)])<br/>    (apply bf-func current-apl)))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(begin<br/>      (define first-apl (list (make-vector 30000 0) 0))<br/>      (void (fold-funcs first-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-program)<br/><br/>(define-macro (bf-loop "[" OP-OR-LOOP-ARG ... "]")<br/>  #'(lambda (arr ptr)<br/>      (for/fold ([current-apl (list arr ptr)])<br/>                ([i (in-naturals)]<br/>                 #:break (zero? (apply current-byte<br/>                                       current-apl)))<br/>        (fold-funcs current-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-loop)</div><div class="highlight" form="false" id="a_ll2Gl"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">apl</span> <span class="n">bf-funcs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="n">apl</span><span class="p">])</span>
            <span class="p">([</span><span class="n">bf-func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="n">bf-funcs</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">bf-func</span> <span class="n">current-apl</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a></span> <span class="mi">30000</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a></span> <span class="p">(</span><span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class="hll">      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)])</span>
</span><span class="hll">                <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-naturals))" class="docs" hyphens="none">in-naturals</a></span><span class="p">)]</span>
</span><span class="hll">                 <span class="kd">#:break</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" class="docs" hyphens="none">zero?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">current-byte</span>
</span><span class="hll">                                       <span class="n">current-apl</span><span class="p">)))</span>
</span><span class="hll">        <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">current-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-loop</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yUT8e&quot;)"></div><p id="a_yUT8e">We can make an anony­mous func­tion with <a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a>, which works like <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a>, except we omit the func­tion name. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">For more about <span class="my-code" decode="exclude">lambda</span>, see <a class="explainer" href="../explainer/functions.html">func­tions</a>.</span></span> A <span class="my-code" decode="exclude">lambda</span> expres­sion can be assigned to a vari­able, or used any­where that Racket expects a func­tion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6nvPK&quot;)"></div><div class="highlight-container" id="a_6nvPK"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define adder (lambda (x y) (+ x y)))<br/>(adder 20 22) ; 42<br/>((lambda (x y) (* x y)) 20 22) ; same as (* 20 22) = 440</div><div class="highlight" form="false" id="a_myAec"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">adder</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a></span> <span class="p">(</span><span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">x</span> <span class="n">y</span><span class="p">)))</span>
<span class="p">(</span><span class="n">adder</span> <span class="mi">20</span> <span class="mi">22</span><span class="p">)</span> <span class="c1">; 42</span>
<span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a></span> <span class="p">(</span><span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">x</span> <span class="n">y</span><span class="p">))</span> <span class="mi">20</span> <span class="mi">22</span><span class="p">)</span> <span class="c1">; same as (* 20 22) = 440</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pgjpm&quot;)"></div><p id="a_pgjpm">In this case, our macro will return a <span class="my-code" decode="exclude">lambda</span> that runs another <span class="my-code" decode="exclude">for/fold</span> loop. As with <span class="my-code" decode="exclude">fold-funcs</span>, the loop will use an accu­mu­la­tor called <span class="my-code" decode="exclude">current-apl</span> that takes its ini­tial state from the input argu­ments (com­bin­ing <span class="my-code" decode="exclude">arr</span> and <span class="my-code" decode="exclude">ptr</span>).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GDyNS&quot;)"></div><p id="a_GDyNS">We remem­ber from <a href="intro.html#how-bf-works">how <span class="my-code" decode="exclude">bf</span> works</a> that a <span class="my-code" decode="exclude">bf-loop</span> needs to con­tinue indef­i­nitely until the cur­rent byte is zero. So our <span class="my-code" decode="exclude">for/fold</span> loop will iter­ate using <a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-naturals))" class="docs" hyphens="none">in-naturals</a>, which pro­duces an unend­ing sequence of inte­gers. Then we add a <span class="my-code" decode="exclude">#:break</span> con­di­tion, which ends the loop when the con­di­tion becomes true, to test whether the cur­rent byte is zero. (We haven’t made the <span class="my-code" decode="exclude">current-byte</span> func­tion yet, but we will shortly.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vzKh9&quot;)"></div><p id="a_vzKh9">Finally, our new call to <span class="my-code" decode="exclude">fold-funcs</span>, which feeds in our <span class="my-code" decode="exclude">current-apl</span> and list of argu­ments. <span class="my-code" decode="exclude">fold-funcs</span> will return a list with a mod­i­fied array and pointer, which becomes the value of <span class="my-code" decode="exclude">current-apl</span> for the next pass of our loop.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BAojm&quot;)"></div><p id="a_BAojm">When the cur­rent byte becomes zero, this <span class="my-code" decode="exclude">for/fold</span> loop will end, and its return value will be the last value of <span class="my-code" decode="exclude">current-apl</span>. This, in turn, becomes the return value of the <span class="my-code" decode="exclude">lambda</span> func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LDv4F&quot;)"></div><p id="a_LDv4F">Duu­u­ude. That was the most super-duper-Rack­ety macro we’ve writ­ten yet. Don’t panic if it takes another read for every­thing to sink in. The big point is that we’re see­ing how we can pass an array / pointer list not just “hor­i­zon­tally” from func­tion to func­tion (= what we did within <span class="my-code" decode="exclude">fold-funcs</span>) but also “ver­ti­cally” by call­ing <span class="my-code" decode="exclude">fold-funcs</span> again within a loop. This tech­nique is called <em><a class="explainer" href="../explainer/recursion.html">recur­sion</a></em>. It’s a clas­sic design pat­tern of func­tional pro­gram­ming, and ubiq­ui­tous in Racket.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xfVKK&quot;)"></div><p id="a_xfVKK">In this case, the ben­e­fit of recur­sion is that we can totally avoid rely­ing on exter­nal state vari­ables and muta­tion. The other ben­e­fit is that we can now relax—it’s all down­hill from here.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CVs06&quot;)"></div><p id="a_CVs06">Our third macro is <span class="my-code" decode="exclude">bf-op</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UAcUU&quot;)"></div><div class="highlight-container" id="a_UAcUU"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define (fold-funcs apl bf-funcs)<br/>  (for/fold ([current-apl apl])<br/>            ([bf-func (in-list bf-funcs)])<br/>    (apply bf-func current-apl)))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(begin<br/>      (define first-apl (list (make-vector 30000 0) 0))<br/>      (void (fold-funcs first-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-program)<br/><br/>(define-macro (bf-loop "[" OP-OR-LOOP-ARG ... "]")<br/>  #'(lambda (arr ptr)<br/>      (for/fold ([current-apl (list arr ptr)])<br/>                ([i (in-naturals)]<br/>                 #:break (zero? (apply current-byte<br/>                                       current-apl)))<br/>        (fold-funcs current-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-loop)<br/><br/>(define-macro-cases bf-op<br/>  [(bf-op "&gt;") #'gt]<br/>  [(bf-op "&lt;") #'lt]<br/>  [(bf-op "+") #'plus]<br/>  [(bf-op "-") #'minus]<br/>  [(bf-op ".") #'period]<br/>  [(bf-op ",") #'comma])<br/>(provide bf-op)</div><div class="highlight" form="false" id="a_yhzUB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">apl</span> <span class="n">bf-funcs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="n">apl</span><span class="p">])</span>
            <span class="p">([</span><span class="n">bf-func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="n">bf-funcs</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">bf-func</span> <span class="n">current-apl</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a></span> <span class="mi">30000</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a></span> <span class="p">(</span><span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)])</span>
                <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-naturals))" class="docs" hyphens="none">in-naturals</a></span><span class="p">)]</span>
                 <span class="kd">#:break</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" class="docs" hyphens="none">zero?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">current-byte</span>
                                       <span class="n">current-apl</span><span class="p">)))</span>
        <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">current-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-loop</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">bf-op</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&gt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">gt</span><span class="p">]</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&lt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">lt</span><span class="p">]</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"+"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">plus</span><span class="p">]</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"-"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">minus</span><span class="p">]</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"."</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">period</span><span class="p">]</span>
</span><span class="hll">  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">","</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">comma</span><span class="p">])</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-op</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_McL3a&quot;)"></div><p id="a_McL3a">It looks sim­i­lar to our pre­vi­ous <span class="my-code" decode="exclude">bf-op</span> macro, but rather than return­ing a self-con­tained func­tion appli­ca­tion like <span class="my-code" decode="exclude">#'(gt)</span>, this ver­sion will return only the name of the cor­re­spond­ing func­tion (so that <span class="my-code" decode="exclude">fold-funcs</span> can <span class="my-code" decode="exclude">apply</span> a list of argu­ments to it).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Av5Y6&quot;)"></div><p id="a_Av5Y6">Now we’re ready to add the func­tions that imple­ment the core <span class="my-code" decode="exclude">bf</span> array oper­a­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;reimplementing-the-bf-array&quot;)"></div><h3 anchor="reimplementing-the-bf-array" class="subhead" id="reimplementing-the-bf-array"><a href="#reimplementing-the-bf-array">(Re)imple­ment­ing the BF array</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3v9av&quot;)"></div><p id="a_3v9av">Our array-imple­men­ta­tion func­tions will cover the same ground as before.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_klapx&quot;)"></div><p id="a_klapx">The <em>cur­rent byte</em> is the byte in the array at the loca­tion indi­cated by the pointer. So our <span class="my-code" decode="exclude">current-byte</span> func­tion just gets the value from <span class="my-code" decode="exclude">arr</span> at the posi­tion <span class="my-code" decode="exclude">ptr</span> using <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_I9XK0&quot;)"></div><div class="highlight-container" id="a_I9XK0"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (current-byte arr ptr) (vector-ref arr ptr))</div><div class="highlight" form="false" id="a_eSORc"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4N0ll&quot;)"></div><p id="a_4N0ll">Keep­ing with the func­tional idiom, our new <span class="my-code" decode="exclude">set-current-byte</span> will dupli­cate the input array with <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((lib._racket/vector..rkt)._vector-copy))" class="docs" hyphens="none">vector-copy</a>, update the byte of inter­est with <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a>, and then return this new array. In this case, <span class="my-code" decode="exclude">vector-set!</span> doesn’t count as muta­tion, because it’s just for inter­nal house­keep­ing. What’s impor­tant is that we’re not using it to affect data out­side the func­tion. (Con­sis­tent with <a href="../explainer/functions.html#naming-conventions">Racket con­ven­tion</a>, we remove the <span class="my-code" decode="exclude">!</span> from the end of our func­tion name, to sig­nal that it returns a value rather than rely­ing on muta­tion):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NDsiZ&quot;)"></div><div class="highlight-container" id="a_NDsiZ"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (set-current-byte arr ptr val)<br/>  (define new-arr (vector-copy arr))<br/>  (vector-set! new-arr ptr val)<br/>  new-arr)</div><div class="highlight" form="false" id="a_NrwIi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">new-arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((lib._racket/vector..rkt)._vector-copy))" class="docs" hyphens="none">vector-copy</a></span> <span class="n">arr</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a></span> <span class="n">new-arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
  <span class="n">new-arr</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6Uasn&quot;)"></div><p id="a_6Uasn">Then we have the func­tions that imple­ment spe­cific <span class="my-code" decode="exclude">bf</span> oper­a­tions. This time, rather than tak­ing no argu­ments and return­ing no val­ues, each func­tion will take two argu­ments—an array and a pointer—and return a list with a pos­si­bly mod­i­fied array and pointer. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Require­ments for input and out­put val­ues can be enforced less casu­ally with <a class="explainer" href="../explainer/contracts.html">con­tracts</a>, a topic we’ll cover later.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_RO67b&quot;)"></div><p id="a_RO67b">The <span class="my-code" decode="exclude">gt</span> and <span class="my-code" decode="exclude">lt</span> func­tions—cor­re­spond­ing to the <span class="my-code" decode="exclude">bf</span> oper­a­tions <span class="my-code" decode="exclude">&gt;</span> and <span class="my-code" decode="exclude">&lt;</span>—increase or decrease the pointer by one.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yuUza&quot;)"></div><div class="highlight-container" id="a_yuUza"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (gt arr ptr) (list arr (add1 ptr)))<br/>(define (lt arr ptr) (list arr (sub1 ptr)))</div><div class="highlight" form="false" id="a_bA3H1"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">gt</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="n">ptr</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">lt</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="n">ptr</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NtHSc&quot;)"></div><p id="a_NtHSc">The <span class="my-code" decode="exclude">plus</span> and <span class="my-code" decode="exclude">minus</span> func­tions—cor­re­spond­ing to the <span class="my-code" decode="exclude">bf</span> oper­a­tions <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">-</span>—increase or decrease the value of the cur­rent byte. We can express these oper­a­tions in terms of <span class="my-code" decode="exclude">current-byte</span> and <span class="my-code" decode="exclude">set-current-byte</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_njVVH&quot;)"></div><div class="highlight-container" id="a_njVVH"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (plus arr ptr)<br/>  (list<br/>   (set-current-byte arr ptr (add1 (current-byte arr ptr)))<br/>   ptr))<br/><br/>(define (minus arr ptr)<br/>  (list<br/>   (set-current-byte arr ptr (sub1 (current-byte arr ptr)))<br/>   ptr))</div><div class="highlight" form="false" id="a_XnvtR"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">plus</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span>
   <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)))</span>
   <span class="n">ptr</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">minus</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span>
   <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)))</span>
   <span class="n">ptr</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_f0jgV&quot;)"></div><p id="a_f0jgV">The <span class="my-code" decode="exclude">period</span> func­tion, cor­re­spond­ing to a <span class="my-code" decode="exclude">.</span> in <span class="my-code" decode="exclude">bf</span> code, writes the cur­rent byte to stan­dard out­put. As before, we use the Racket library func­tion <span class="my-code" decode="exclude">write-byte</span> to help out. Then we just return the unmod­i­fied input val­ues:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_q1QoC&quot;)"></div><div class="highlight-container" id="a_q1QoC"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (period arr ptr)<br/>  (write-byte (current-byte arr ptr))<br/>  (list arr ptr))</div><div class="highlight" form="false" id="a_bXEZW"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">period</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Output.html#(def._((quote._~23~25kernel)._write-byte))" class="docs" hyphens="none">write-byte</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_C2uD6&quot;)"></div><p id="a_C2uD6">Finally, the <span class="my-code" decode="exclude">comma</span> func­tion, cor­re­spond­ing to a <span class="my-code" decode="exclude">,</span> in <span class="my-code" decode="exclude">bf</span> code, sets the cur­rent byte to one read from stan­dard input. As before, we can do this with the Racket func­tion <span class="my-code" decode="exclude">read-byte</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_v40Ou&quot;)"></div><div class="highlight-container" id="a_v40Ou"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (comma arr ptr)<br/>  (list (set-current-byte arr ptr (read-byte)) ptr))</div><div class="highlight" form="false" id="a_rDjin"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">comma</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-byte))" class="docs" hyphens="none">read-byte</a></span><span class="p">))</span> <span class="n">ptr</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NIA9c&quot;)"></div><p id="a_NIA9c">Our fin­ished expander should look like this, with the new array imple­men­ta­tion high­lighted:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qDSjS&quot;)"></div><div class="highlight-container" id="a_qDSjS"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/> <br/>(define-macro (bf-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     PARSE-TREE))<br/>(provide (rename-out [bf-module-begin #%module-begin]))<br/><br/>(define (fold-funcs apl bf-funcs)<br/>  (for/fold ([current-apl apl])<br/>            ([bf-func (in-list bf-funcs)])<br/>    (apply bf-func current-apl)))<br/><br/>(define-macro (bf-program OP-OR-LOOP-ARG ...)<br/>  #'(begin<br/>      (define first-apl (list (make-vector 30000 0) 0))<br/>      (void (fold-funcs first-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-program)<br/><br/>(define-macro (bf-loop "[" OP-OR-LOOP-ARG ... "]")<br/>  #'(lambda (arr ptr)<br/>      (for/fold ([current-apl (list arr ptr)])<br/>                ([i (in-naturals)]<br/>                 #:break (zero? (apply current-byte<br/>                                       current-apl)))<br/>        (fold-funcs current-apl (list OP-OR-LOOP-ARG ...)))))<br/>(provide bf-loop)<br/><br/>(define-macro-cases bf-op<br/>  [(bf-op "&gt;") #'gt]<br/>  [(bf-op "&lt;") #'lt]<br/>  [(bf-op "+") #'plus]<br/>  [(bf-op "-") #'minus]<br/>  [(bf-op ".") #'period]<br/>  [(bf-op ",") #'comma])<br/>(provide bf-op)<br/><br/>(define (current-byte arr ptr) (vector-ref arr ptr))<br/><br/>(define (set-current-byte arr ptr val)<br/>  (define new-arr (vector-copy arr))<br/>  (vector-set! new-arr ptr val)<br/>  new-arr)<br/><br/>(define (gt arr ptr) (list arr (add1 ptr)))<br/>(define (lt arr ptr) (list arr (sub1 ptr)))<br/><br/>(define (plus arr ptr)<br/>  (list<br/>   (set-current-byte arr ptr (add1 (current-byte arr ptr)))<br/>   ptr))<br/><br/>(define (minus arr ptr)<br/>  (list<br/>   (set-current-byte arr ptr (sub1 (current-byte arr ptr)))<br/>   ptr))<br/><br/>(define (period arr ptr)<br/>  (write-byte (current-byte arr ptr))<br/>  (list arr ptr))<br/><br/>(define (comma arr ptr)<br/>  (list (set-current-byte arr ptr (read-byte)) ptr))<br/>
</div><div class="highlight" form="false" id="a_ux8m8"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">PARSE-TREE</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">bf-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">apl</span> <span class="n">bf-funcs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="n">apl</span><span class="p">])</span>
            <span class="p">([</span><span class="n">bf-func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="n">bf-funcs</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">bf-func</span> <span class="n">current-apl</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-program</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._make-vector))" class="docs" hyphens="none">make-vector</a></span> <span class="mi">30000</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">first-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-program</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">bf-loop</span> <span class="s2">"["</span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="s2">"]"</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a></span> <span class="p">(</span><span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">current-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)])</span>
                <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-naturals))" class="docs" hyphens="none">in-naturals</a></span><span class="p">)]</span>
                 <span class="kd">#:break</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" class="docs" hyphens="none">zero?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="n">current-byte</span>
                                       <span class="n">current-apl</span><span class="p">)))</span>
        <span class="p">(</span><span class="n">fold-funcs</span> <span class="n">current-apl</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">OP-OR-LOOP-ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-loop</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">bf-op</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&gt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">gt</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"&lt;"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">lt</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"+"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">plus</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"-"</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">minus</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">"."</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">period</span><span class="p">]</span>
  <span class="p">[(</span><span class="n">bf-op</span> <span class="s2">","</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">comma</span><span class="p">])</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">bf-op</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">new-arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((lib._racket/vector..rkt)._vector-copy))" class="docs" hyphens="none">vector-copy</a></span> <span class="n">arr</span><span class="p">))</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a></span> <span class="n">new-arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
</span><span class="hll">  <span class="n">new-arr</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">gt</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="n">ptr</span><span class="p">)))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">lt</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="n">ptr</span><span class="p">)))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">plus</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span>
</span><span class="hll">   <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" class="docs" hyphens="none">add1</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)))</span>
</span><span class="hll">   <span class="n">ptr</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">minus</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span>
</span><span class="hll">   <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)))</span>
</span><span class="hll">   <span class="n">ptr</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">period</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Output.html#(def._((quote._~23~25kernel)._write-byte))" class="docs" hyphens="none">write-byte</a></span> <span class="p">(</span><span class="n">current-byte</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">comma</span> <span class="n">arr</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-byte))" class="docs" hyphens="none">read-byte</a></span><span class="p">))</span> <span class="n">ptr</span><span class="p">))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-bf-expander&quot;)"></div><h3 anchor="testing-our-bf-expander" class="subhead" id="testing-our-bf-expander"><a href="#testing-our-bf-expander">Test­ing our BF expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HetFF&quot;)"></div><p id="a_HetFF">Let’s con­firm that our test file <span class="my-code" decode="exclude">"atsign.rkt"</span> still works:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">atsign.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qs9uS&quot;)"></div><div class="highlight-container" id="a_qs9uS"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "reader.rkt"<br/>Greatest language ever!<br/>++++-+++-++-++[&gt;++++-+++-++-++&lt;-]&gt;.</div><div class="highlight" form="false" id="a_ihAov"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>#lang reader "reader.rkt"
<span class="c">Greatest language ever!</span>
<span class="nb">++++-+++-++-++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++++-+++-++-++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vXFJF&quot;)"></div><div class="highlight-container" id="a_vXFJF"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">@</div><div class="highlight" form="false" id="a_HzK2V"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>@
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VkHj2&quot;)"></div><p id="a_VkHj2">Very good. How about our “Hello World” <span class="my-code" decode="exclude">bf</span> pro­gram?</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">hello.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Tpz7A&quot;)"></div><div class="highlight-container" id="a_Tpz7A"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "reader.rkt"<br/>++++++[&gt;++++++++++++&lt;-]&gt;.<br/>&gt;++++++++++[&gt;++++++++++&lt;-]&gt;+.<br/>+++++++..+++.&gt;++++[&gt;+++++++++++&lt;-]&gt;.<br/>&lt;+++[&gt;----&lt;-]&gt;.&lt;&lt;&lt;&lt;&lt;+++[&gt;+++++&lt;-]&gt;.<br/>&gt;&gt;.+++.------.--------.&gt;&gt;+.</div><div class="highlight" form="false" id="a_JRAjt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>#lang reader "reader.rkt"
<span class="nb">++++++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++++++++++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
<span class="nv">&gt;</span><span class="nb">++++++++++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++++++++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nt">.</span><span class="c"></span>
<span class="nb">+++++++</span><span class="nt">..</span><span class="nb">+++</span><span class="nt">.</span><span class="nv">&gt;</span><span class="nb">++++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+++++++++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
<span class="nv">&lt;</span><span class="nb">+++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">----</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="nb">+++</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+++++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="c"></span>
<span class="nv">&gt;&gt;</span><span class="nt">.</span><span class="nb">+++</span><span class="nt">.</span><span class="nb">------</span><span class="nt">.</span><span class="nb">--------</span><span class="nt">.</span><span class="nv">&gt;&gt;</span><span class="nb">+</span><span class="nt">.</span><span class="c"></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GvQMh&quot;)"></div><div class="highlight-container" id="a_GvQMh"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">Hello, World!</div><div class="highlight" form="false" id="a_9xUJa"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>Hello, World!
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aZlT1&quot;)"></div><p id="a_aZlT1">Excel­lent. And the fac­to­r­ial gen­er­a­tor—</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">factorial.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_W1WwU&quot;)"></div><div class="highlight-container" id="a_W1WwU"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "reader.rkt"<br/>&gt;++++++++++&gt;&gt;&gt;+&gt;+[&gt;&gt;&gt;+[-[&lt;&lt;&lt;&lt;&lt;[+&lt;&lt;&lt;&lt;&lt;]&gt;&gt;[[-]&gt;[&lt;&lt;+&gt;+&gt;-]<br/>&lt;[&gt;+&lt;-]&lt;[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-[&gt;+&lt;-<br/>[&gt;[-]&gt;&gt;&gt;&gt;+&gt;+&lt;&lt;&lt;&lt;&lt;&lt;-[&gt;+&lt;-]]]]]]]]]]]&gt;[&lt;+&gt;-]+&gt;&gt;&gt;&gt;&gt;]&lt;&lt;&lt;&lt;&lt;<br/>[&lt;&lt;&lt;&lt;&lt;]&gt;&gt;&gt;&gt;&gt;&gt;&gt;[&gt;&gt;&gt;&gt;&gt;]++[-&lt;&lt;&lt;&lt;&lt;]&gt;&gt;&gt;&gt;&gt;&gt;-]+&gt;&gt;&gt;&gt;&gt;]&lt;[&gt;++&lt;-]<br/>&lt;&lt;&lt;&lt;[&lt;[&gt;+&lt;-]&lt;&lt;&lt;&lt;]&gt;&gt;[-&gt;[-]++++++[&lt;++++++++&gt;-]&gt;&gt;&gt;&gt;]&lt;&lt;&lt;&lt;&lt;<br/>[&lt;[&gt;+&gt;+&lt;&lt;-]&gt;.&lt;&lt;&lt;&lt;&lt;]&gt;.&gt;&gt;&gt;&gt;]</div><div class="highlight" form="false" id="a_mK2Ne"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre>#lang reader "reader.rkt"
<span class="nv">&gt;</span><span class="nb">++++++++++</span><span class="nv">&gt;&gt;&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="k">[</span><span class="nv">&gt;&gt;&gt;</span><span class="nb">+</span><span class="k">[</span><span class="nb">-</span><span class="k">[</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">[</span><span class="nb">+</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;</span><span class="k">[[</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="k">[</span><span class="nv">&lt;&lt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">-</span><span class="k">]</span><span class="c"></span>
<span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="c"></span>
<span class="k">[</span><span class="nv">&gt;</span><span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;&lt;&lt;&lt;&lt;&lt;</span><span class="nb">-</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]]]]]]]]]]]</span><span class="nv">&gt;</span><span class="k">[</span><span class="nv">&lt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">-</span><span class="k">]</span><span class="nb">+</span><span class="nv">&gt;&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="c"></span>
<span class="k">[</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="k">[</span><span class="nv">&gt;&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nb">++</span><span class="k">[</span><span class="nb">-</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="nb">-</span><span class="k">]</span><span class="nb">+</span><span class="nv">&gt;&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">++</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="c"></span>
<span class="nv">&lt;&lt;&lt;&lt;</span><span class="k">[</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;&gt;</span><span class="k">[</span><span class="nb">-</span><span class="nv">&gt;</span><span class="k">[</span><span class="nb">-</span><span class="k">]</span><span class="nb">++++++</span><span class="k">[</span><span class="nv">&lt;</span><span class="nb">++++++++</span><span class="nv">&gt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="c"></span>
<span class="k">[</span><span class="nv">&lt;</span><span class="k">[</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&gt;</span><span class="nb">+</span><span class="nv">&lt;&lt;</span><span class="nb">-</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="nv">&lt;&lt;&lt;&lt;&lt;</span><span class="k">]</span><span class="nv">&gt;</span><span class="nt">.</span><span class="nv">&gt;&gt;&gt;&gt;</span><span class="k">]</span><span class="c"></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NIosL&quot;)"></div><div class="highlight-container" id="a_NIosL"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">1<br/>1<br/>2<br/>6<br/>24<br/>120<br/>720<br/>5040<br/>40320<br/>362880<br/>3628800<br/>39916800<br/>479001600<br/>6227020800<br/>87178291200<br/>1307674368000<br/>···</div><div class="highlight" form="false" id="a_DoTPF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre>1
1
2
6
24
120
720
5040
40320
362880
3628800
39916800
479001600
6227020800
87178291200
1307674368000
···
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_COXgF&quot;)"></div><p id="a_COXgF">Every­thing checks out. We’ve suc­cess­fully con­verted our imper­a­tive-style expander into a func­tional-style expander. Again, in the case of <span class="my-code" decode="exclude">bf</span> it’s not nec­es­sar­ily the fastest approach. In fact, we prob­a­bly noticed that <span class="my-code" decode="exclude">"factorial.rkt"</span> now runs much slower.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rVkR8&quot;)"></div><p id="a_rVkR8">The main point was to show that even a lan­guage like <span class="my-code" decode="exclude">bf</span> that relies on state and mtu­a­tion can be imple­mented with­out them, by rely­ing on func­tional-pro­gram­ming tech­niques. As we move toward lan­guages with more com­plex inter­ac­tions, the clean­li­ness of the func­tional approach will pay div­i­dends.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FdtK7&quot;)"></div><p id="a_FdtK7">This will also be the last time we do an imper­a­tive-to-func­tional con­ver­sion. After this, we’ll just do every­thing in a func­tional style at the out­set, avoid­ing state and muta­tion as much as pos­si­ble (though keep­ing with our non-dog­matic pol­icy, we won’t avoid it if it becomes nec­es­sary).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;can-we-make-it-faster&quot;)"></div><h3 anchor="can-we-make-it-faster" class="subhead" id="can-we-make-it-faster"><a href="#can-we-make-it-faster">Can we make it faster?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_n34qU&quot;)"></div><p id="a_n34qU">Alan Perlis once quipped that “A Lisp pro­gram­mer knows the value of every­thing, but the cost of noth­ing.” Mean­ing, the pur­suit of func­tional purity can neg­a­tively affect real-world per­for­mance. In this case, we elim­i­nated state and muta­tion from our <span class="my-code" decode="exclude">bf</span> expander. But it got much slower.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZG2jX&quot;)"></div><p id="a_ZG2jX">Why? We could point out some small inef­fi­cien­cies, but the major buga­boo is our imple­men­ta­tion of <span class="my-code" decode="exclude">set-current-byte</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NDsiZp&quot;)"></div><div class="highlight-container" id="a_NDsiZp"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (set-current-byte arr ptr val)<br/>  (define new-arr (vector-copy arr))<br/>  (vector-set! new-arr ptr val)<br/>  new-arr)</div><div class="highlight" form="false" id="a_NrwIin"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">new-arr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((lib._racket/vector..rkt)._vector-copy))" class="docs" hyphens="none">vector-copy</a></span> <span class="n">arr</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a></span> <span class="n">new-arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
  <span class="n">new-arr</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dIpjF&quot;)"></div><p id="a_dIpjF">The prob­lem here is that mem­ory allo­ca­tion isn’t free. Our input array <span class="my-code" decode="exclude">arr</span> is a large data struc­ture—30,000 bytes—so <a href="http://docs.racket-lang.org/reference/vectors.html#(def._((lib._racket/vector..rkt)._vector-copy))" class="docs" hyphens="none">vector-copy</a> has to allo­cate nearly 30K every time it’s called. That takes time. Also, because the old <span class="my-code" decode="exclude">arr</span> is never used again, it gets marked for dele­tion by Racket’s <em><a class="glossary" href="../appendix/glossary.html#garbage-collector"><span class="glossary-link-text">garbage col­lec­tor</span></a></em>. Garbage col­lec­tion hap­pens auto­mat­i­cally as the pro­gram runs. As dis­carded mem­ory piles up, the garbage col­lec­tor has to run more often. That takes time too.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Un0FV&quot;)"></div><p id="a_Un0FV">What to do? The sim­plest fix would be to avoid unnec­es­sary mem­ory allo­ca­tion. We can do that by adjust­ing <span class="my-code" decode="exclude">set-current-byte</span> to reuse our input data struc­ture <span class="my-code" decode="exclude">arr</span> for the out­put:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_P0y6L&quot;)"></div><div class="highlight-container" id="a_P0y6L"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (set-current-byte arr ptr val)<br/>  (vector-set! arr ptr val)<br/>  arr)</div><div class="highlight" form="false" id="a_yhNc7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">set-current-byte</span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-set!))" class="docs" hyphens="none">vector-set!</a></span> <span class="n">arr</span> <span class="n">ptr</span> <span class="n">val</span><span class="p">)</span>
  <span class="n">arr</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yidSH&quot;)"></div><p id="a_yidSH">If we make this update and try <span class="my-code" decode="exclude">"factorial.rkt"</span> again, it runs much faster.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zdNvS&quot;)"></div><p id="a_zdNvS">Can we live with this change? Sure. We’re not here to be rigid about func­tional pro­gram­ming. The fact that <span class="my-code" decode="exclude">bf</span> relies on a 30,000-byte array is unusual. And throw­ing out 29,999 bytes every time we change one is, in prac­ti­cal terms, waste­ful and slow.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GWayA&quot;)"></div><p id="a_GWayA">More­over, because each <span class="my-code" decode="exclude">arr</span> passed to <span class="my-code" decode="exclude">set-current-byte</span> is never reused, this change has no effect on the rest of the pro­gram. In all, it’s a tiny com­pro­mise with a clear ben­e­fit. Ship it.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="grammars-and-parsers.html">2&emsp;gram­mars and parsers</a></li><li><a href="grammar-notation.html">3&emsp;gram­mar nota­tion</a></li><li><a href="the-parser.html">4&emsp;the parser</a></li><li><a href="the-tokenizer-and-reader.html">5&emsp;the tok­enizer and reader</a></li><li><a href="an-imperative-expander.html">6&emsp;an imper­a­tive expander</a></li><li><a class="here" href="a-functional-expander.html">7&emsp;a func­tional expander</a></li><li><a href="packaging-our-language.html">8&emsp;pack­ag­ing our lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="an-imperative-expander.html">← prev</a>
    <a class="nav-right" href="packaging-our-language.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>