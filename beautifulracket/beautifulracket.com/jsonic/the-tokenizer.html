<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/jsonic/the-tokenizer.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:17 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Extend a data format: jsonic</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;extend-a-data-format-jsonic&quot;)"></div><h1 anchor="extend-a-data-format-jsonic" id="extend-a-data-format-jsonic" hyphens="none">Extend a data format: <span class="my-code" decode="exclude">jsonic</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification.html">2&emsp;spec­i­fi­ca­tion</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a href="the-reader.html">4&emsp;the reader</a></li><li><a class="here" href="the-tokenizer.html">5&emsp;the tok­enizer</a></li><li><a href="the-parser.html">6&emsp;the parser</a></li><li><a href="the-expander.html">7&emsp;the expander</a></li><li><a href="testing-the-language.html">8&emsp;test­ing the lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;the-tokenizer&quot;)"></div><h3 anchor="the-tokenizer" class="subhead" id="the-tokenizer"><a href="#the-tokenizer">The tok­enizer</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y0COR&quot;)"></div><p id="a_Y0COR"><a href="../bf/the-tokenizer-and-reader.html#introducing-the-tokenizer
">Recall that</a> a <a class="glossary" href="../appendix/glossary.html#token"><span class="glossary-link-text">token</span></a> is the small­est mean­ing­ful chunk of a string of source code. Within the reader, a source string is con­verted to tokens with a helper func­tion called a <a class="glossary" href="../appendix/glossary.html#tokenizer"><span class="glossary-link-text">tok­enizer</span></a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_S60l2&quot;)"></div><p id="a_S60l2">We won’t be able to totally reuse the <a href="../bf/source-listing.html">the <span class="my-code" decode="exclude">bf</span> tok­enizer</a>. But the <span class="my-code" decode="exclude">jsonic</span> tok­enizer will fol­low a sim­i­lar pat­tern. Let’s cre­ate a new <span class="my-code" decode="exclude">"tokenizer.rkt"</span> mod­ule with a shell for the <span class="my-code" decode="exclude">tokenize</span> func­tion, and we’ll step through the indi­vid­ual tok­eniz­ing rules:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jLGpo&quot;)"></div><div class="highlight-container" id="a_jLGpo"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require brag/support)<br/><br/>(define (make-tokenizer port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       ···))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide make-tokenizer)</div><div class="highlight" form="false" id="a_pUNyF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="n">···</span><span class="p">))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">make-tokenizer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DhDoS&quot;)"></div><p id="a_DhDoS">As before, <span class="my-code" decode="exclude">make-tokenizer</span> takes a <span class="my-code" decode="exclude">port</span> as input and returns a func­tion, <span class="my-code" decode="exclude">next-token</span>, that the parser will call to retrieve tokens.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ONVcF&quot;)"></div><p id="a_ONVcF">Within <span class="my-code" decode="exclude">next-token</span>, we use a helper func­tion called a <a class="glossary" href="../appendix/glossary.html#lexer"><span class="glossary-link-text">lexer</span></a> to break down the source code into tokens. We first used a lexer in <a href="../bf/index.html"><span class="my-code" decode="exclude">bf</span></a>. But let’s review how it works:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YWo5V&quot;)"></div><p id="a_YWo5V">The lexer must be able to process every token that might appear in the source, includ­ing <a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a> (which sig­nals the end).</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2Sqke&quot;)"></div><p id="a_2Sqke">The lexer con­sists of a series of branches, each rep­re­sent­ing a lex­ing rule. On the left side of the branch is a pat­tern that works like a reg­u­lar expres­sion. On the right is a token-cre­at­ing expres­sion.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZdtZE&quot;)"></div><p id="a_ZdtZE">Each time <span class="my-code" decode="exclude">next-token</span> is called, <span class="my-code" decode="exclude">jsonic-lexer</span> will read as many char­ac­ters from the input <span class="my-code" decode="exclude">port</span> as it can while still match­ing a rule pat­tern.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YTB8V&quot;)"></div><p id="a_YTB8V">The lexer rule will con­vert the matched char­ac­ters (known as the <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a>) into a token using the expres­sion on the right.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_k0qeg&quot;)"></div><p id="a_k0qeg">This token will be returned as the result. The process repeats until the lexer gets the <span class="my-code" decode="exclude">eof</span> sig­nal.</p></div></li></ul><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_65g39&quot;)"></div><p id="a_65g39">We import <span class="my-code" decode="exclude">brag/support</span>, which pro­vides tools we need for the lexer: the basic <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a> func­tion; <a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a>, which is a match­ing helper; <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a>, another helper func­tion to process match results; and <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a>, a data struc­ture that will coop­er­ate with the parser we’ll make later, using <span class="my-code" decode="exclude">#lang brag</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1s8CB&quot;)"></div><p id="a_1s8CB">We’ll need four rules in <span class="my-code" decode="exclude">jsonic-lexer</span>. Tak­ing each in turn:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TC5XW&quot;)"></div><div class="highlight-container" id="a_TC5XW"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require brag/support)<br/><br/>(define (make-tokenizer port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       ···))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide make-tokenizer)</div><div class="highlight" form="false" id="a_Ag02T"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
<span class="hll">       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
</span>       <span class="n">···</span><span class="p">))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">make-tokenizer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_S5SzB&quot;)"></div><p id="a_S5SzB">When <span class="my-code" decode="exclude">port</span> reaches the end of the file, it emits the spe­cial <a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a> sig­nal. Thus, we always need a rule that han­dles <span class="my-code" decode="exclude">eof</span>. We put that in the first rule, return­ing an <span class="my-code" decode="exclude">eof</span> token, which stops the parser.</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MQhYp&quot;)"></div><div class="highlight-container" id="a_MQhYp"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require brag/support)<br/><br/>(define (make-tokenizer port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       ···))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide make-tokenizer)</div><div class="highlight" form="false" id="a_cUrqc"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
<span class="hll">       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
</span>       <span class="n">···</span><span class="p">))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">make-tokenizer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hwlOq&quot;)"></div><p id="a_hwlOq">This next rule han­dles our line com­ments. Recall that any time we find the <span class="my-code" decode="exclude">//</span> char­ac­ter com­bi­na­tion in the source, we want to ignore the rest of the line. So this rule matches every­thing from <span class="my-code" decode="exclude">//</span> to the next new­line. We use the lexer rule <a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a> to make this pat­tern. Once we’ve got­ten our match, we ignore it by call­ing <span class="my-code" decode="exclude">(next-token)</span> again, which has the effect of skip­ping to the next avail­able token.</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4YYNv&quot;)"></div><div class="highlight-container" id="a_4YYNv"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require brag/support)<br/><br/>(define (make-tokenizer port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       [(from/to "@$" "$@")<br/>        (token 'SEXP-TOK (trim-ends "@$" lexeme "$@"))]<br/>       ···))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide make-tokenizer)</div><div class="highlight" form="false" id="a_fYHBi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
<span class="hll">       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"@$"</span> <span class="s2">"$@"</span><span class="p">)</span>
</span><span class="hll">        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a></span> <span class="s2">"@$"</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="s2">"$@"</span><span class="p">))]</span>
</span>       <span class="n">···</span><span class="p">))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">make-tokenizer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mxARK&quot;)"></div><p id="a_mxARK">Next, we match the embed­ded Racket expres­sions that will appear between the <span class="my-code" decode="exclude">@$</span> and <span class="my-code" decode="exclude">$@</span> delim­iters. This is an instance where it’s help­ful to make a “big” token—ulti­mately, these Racket expres­sions will just pass through to the expander intact, so we don’t need to tok­enize any of them into smaller pieces.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_J5L3N&quot;)"></div><p id="a_J5L3N">Again, we use a <span class="my-code" decode="exclude">from/to</span> rule to match every­thing between the <span class="my-code" decode="exclude">@$</span> and <span class="my-code" decode="exclude">$@</span> delim­iters (includ­ing the delim­iters them­selves). Once we’ve matched the embed­ded expres­sion—a value that will be held in the spe­cial lexer vari­able <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a>—we use <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a> to remove the delim­iters.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yRGyQ&quot;)"></div><p id="a_yRGyQ">Finally, we pack­age this trimmed lex­eme into a token struc­ture with the name <span class="my-code" decode="exclude">SEXP-TOK</span>. Named tokens can make a gram­mar sim­pler, because we can then refer to tokens within the gram­mar by name rather than by spe­cific val­ues. By con­ven­tion, named tokens use <span class="my-code" decode="exclude">CAPS</span> names to dis­tin­guish them from names of pro­duc­tion rules in the gram­mar. One nota­tional wrin­kle: though we write <span class="my-code" decode="exclude">'SEXP-TOK</span> here (the <span class="my-code" decode="exclude">'</span> pre­fix makes it a sym­bol rather than a vari­able), in the gram­mar we’ll write this token’s name sim­ply as <span class="my-code" decode="exclude">SEXP-TOK</span>.</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xzTPX&quot;)"></div><div class="highlight-container" id="a_xzTPX"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require brag/support)<br/><br/>(define (make-tokenizer port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       [(from/to "@$" "$@")<br/>        (token 'SEXP-TOK (trim-ends "@$" lexeme "$@"))]<br/>       [any-char (token 'CHAR-TOK lexeme)]))<br/>    (jsonic-lexer port))  <br/>  next-token)<br/>(provide make-tokenizer)</div><div class="highlight" form="false" id="a_cFjly"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"@$"</span> <span class="s2">"$@"</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a></span> <span class="s2">"@$"</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="s2">"$@"</span><span class="p">))]</span>
<span class="hll">       <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._any-char))" class="docs" hyphens="none">any-char</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]))</span>
</span>    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>  
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">make-tokenizer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dF8j5&quot;)"></div><p id="a_dF8j5">Finally, we use an <span class="my-code" decode="exclude">any-char</span> rule to match every­thing else. In a lexer, this works like an <span class="my-code" decode="exclude">else</span> branch, han­dling all char­ac­ters not processed by ear­lier rules. We cre­ate another named token, this time called <span class="my-code" decode="exclude">CHAR-TOK</span>, and include <span class="my-code" decode="exclude">lexeme</span> as the token value.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-the-tokenizer&quot;)"></div><h3 anchor="testing-the-tokenizer" class="subhead" id="testing-the-tokenizer"><a href="#testing-the-tokenizer">Test­ing the tok­enizer</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JcpRX&quot;)"></div><p id="a_JcpRX">It’s not a sub­sti­tute for rig­or­ous <a class="glossary" href="../appendix/glossary.html#unit-test"><span class="glossary-link-text">unit tests</span></a>—we’ll get to those later—but let’s quickly check that our tok­enizer gives us the results we expect.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_d5Iko&quot;)"></div><p id="a_d5Iko">In the REPL for <span class="my-code" decode="exclude">"tokenizer.rkt"</span>, we can use <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a> to test a tok­enizer on strings. A com­ment should result in no tokens:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HtQ84&quot;)"></div><div class="highlight-container" id="a_HtQ84"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply-tokenizer-maker make-tokenizer "// comment\n")</div><div class="highlight" form="false" id="a_0QL7r"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"// comment</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wWkPW&quot;)"></div><div class="highlight-container" id="a_wWkPW"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">'()</div><div class="highlight" form="false" id="a_k9XzU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3qzS7&quot;)"></div><p id="a_3qzS7">A Racket expres­sion between delim­iters should result in a cor­re­spond­ing <span class="my-code" decode="exclude">SEXP-TOK</span> token:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Fhc1A&quot;)"></div><div class="highlight-container" id="a_Fhc1A"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply-tokenizer-maker make-tokenizer "@$ (+ 6 7) $@")</div><div class="highlight" form="false" id="a_Q5SoS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"@$ (+ 6 7) $@"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_isfxq&quot;)"></div><div class="highlight-container" id="a_isfxq"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(list (token-struct 'SEXP-TOK " (+ 6 7) " #f #f #f #f #f))</div><div class="highlight" form="false" id="a_cdrm6"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct))" class="docs" hyphens="none">token-struct</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="s2">" (+ 6 7) "</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Fx9Cr&quot;)"></div><p id="a_Fx9Cr">And any other string should become list of named <span class="my-code" decode="exclude">CHAR-TOK</span> tokens:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GHAu5&quot;)"></div><div class="highlight-container" id="a_GHAu5"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply-tokenizer-maker make-tokenizer "hi")</div><div class="highlight" form="false" id="a_FHacT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"hi"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_21r53&quot;)"></div><div class="highlight-container" id="a_21r53"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(list<br/> (token-struct 'CHAR-TOK "h" #f #f #f #f #f)<br/> (token-struct 'CHAR-TOK "i" #f #f #f #f #f))</div><div class="highlight" form="false" id="a_hKwXq"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span>
 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct))" class="docs" hyphens="none">token-struct</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"h"</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">)</span>
 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct))" class="docs" hyphens="none">token-struct</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"i"</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PvaGV&quot;)"></div><p id="a_PvaGV">The trail­ing <span class="my-code" decode="exclude">#f</span> val­ues are place­hold­ers in the <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a> data struc­ture for <a class="glossary" href="../appendix/glossary.html#source-location"><span class="glossary-link-text">source loca­tion</span></a> fields that we’re not col­lect­ing now. But we’ll start using those fields in the next tuto­r­ial.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zFn4f&quot;)"></div><p id="a_zFn4f">Now that we have our <span class="my-code" decode="exclude">make-tokenizer</span> func­tion, we can make our parser. As we’ll find, the parser will be very sim­ple thanks to the extra work we did here.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oADPV&quot;)"></div><p id="a_oADPV">More broadly, when imple­ment­ing a lan­guage, we’ll often have a choice about where to han­dle cer­tain  tasks: in the tok­enizer, or in the parser, or in the expander. It’s more art than sci­ence. Though work­ing with tok­enizer rules is some­times a chore, they can sub­stan­tially sim­plify the rest of imple­men­ta­tion.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification.html">2&emsp;spec­i­fi­ca­tion</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a href="the-reader.html">4&emsp;the reader</a></li><li><a class="here" href="the-tokenizer.html">5&emsp;the tok­enizer</a></li><li><a href="the-parser.html">6&emsp;the parser</a></li><li><a href="the-expander.html">7&emsp;the expander</a></li><li><a href="testing-the-language.html">8&emsp;test­ing the lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="the-reader.html">← prev</a>
    <a class="nav-right" href="the-parser.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>