<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/jsonic/the-expander.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:17 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Extend a data format: jsonic</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;extend-a-data-format-jsonic&quot;)"></div><h1 anchor="extend-a-data-format-jsonic" id="extend-a-data-format-jsonic" hyphens="none">Extend a data format: <span class="my-code" decode="exclude">jsonic</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification.html">2&emsp;spec­i­fi­ca­tion</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a href="the-reader.html">4&emsp;the reader</a></li><li><a href="the-tokenizer.html">5&emsp;the tok­enizer</a></li><li><a href="the-parser.html">6&emsp;the parser</a></li><li><a class="here" href="the-expander.html">7&emsp;the expander</a></li><li><a href="testing-the-language.html">8&emsp;test­ing the lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;recap-of-the-expanders-role&quot;)"></div><h3 anchor="recap-of-the-expanders-role" class="subhead" id="recap-of-the-expanders-role"><a href="#recap-of-the-expanders-role">Recap of the expander’s role</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LIete&quot;)"></div><p id="a_LIete">Along with <a href="the-reader.html">the reader</a>, the expander is the other essen­tial com­po­nent of every Racket-imple­mented lan­guage:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5sgWu&quot;)"></div><p id="a_5sgWu">The <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a> deter­mines how the code pro­duced by the reader cor­re­sponds to real Racket expres­sions, which are then eval­u­ated to pro­duce a result. The expander works by adding <em><a class="glossary" href="../appendix/glossary.html#binding"><span class="glossary-link-text">bind­ings</span></a></em> to iden­ti­fiers in the code.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_E1zAM&quot;)"></div><p id="a_E1zAM">For an iden­ti­fier to have a mean­ing, it needs a bind­ing. Con­versely, an iden­ti­fier with­out a bind­ing has no mean­ing.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kvJFt&quot;)"></div><p id="a_kvJFt">For instance, if we try to run this pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HxFZM&quot;)"></div><div class="highlight-container" id="a_HxFZM"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">x</div><div class="highlight" form="false" id="a_p8Qhe"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="n">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_T9e70&quot;)"></div><p id="a_T9e70">We get this error:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_V1l9s&quot;)"></div><div class="highlight-container err" id="a_V1l9s"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">x: unbound identifier in module in: x</div><div class="highlight" form="false" id="a_VUxT3"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>x: unbound identifier in module in: x
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MVrln&quot;)"></div><p id="a_MVrln">Why? When we run the pro­gram, Racket tries to eval­u­ate the iden­ti­fier <span class="my-code" decode="exclude">x</span>. But it can’t, because <span class="my-code" decode="exclude">x</span> doesn’t yet have a bind­ing. Hence the “unbound iden­ti­fier” error.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tuQVQ&quot;)"></div><p id="a_tuQVQ">We can bind <span class="my-code" decode="exclude">x</span> by assign­ing it a value with <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZAd6G&quot;)"></div><div class="highlight-container" id="a_ZAd6G"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define x "x is bound to this string")<br/>x</div><div class="highlight" form="false" id="a_n0Jnu"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="s2">"x is bound to this string"</span><span class="p">)</span>
<span class="n">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ybFan&quot;)"></div><div class="highlight-container" id="a_ybFan"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">"x is bound to this string"</div><div class="highlight" form="false" id="a_l9tF2"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="s2">"x is bound to this string"</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Yd6AP&quot;)"></div><p id="a_Yd6AP">More broadly, every iden­ti­fier in a Racket pro­gram needs a bind­ing before the pro­gram can run. <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a> is just one way bind­ing an iden­ti­fier. We can also export a bind­ing from one place with <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a>, and then import that bind­ing with <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cemuI&quot;)"></div><div class="highlight-container" id="a_cemuI"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module my-submod br<br/>  (define x "my-submod binding")<br/>  (provide x))<br/>(require (submod "." my-submod))<br/>x</div><div class="highlight" form="false" id="a_XqxlP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">my-submod</span> <span class="n">br</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="s2">"my-submod binding"</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._submod))" class="docs" hyphens="none">submod</a></span> <span class="s2">"."</span> <span class="n">my-submod</span><span class="p">))</span>
<span class="n">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Dbegc&quot;)"></div><div class="highlight-container" id="a_Dbegc"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">"my-submod binding"</div><div class="highlight" form="false" id="a_cCfXQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="s2">"my-submod binding"</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2eibd&quot;)"></div><p id="a_2eibd">This is also why Rack­e­teers tend to speak gen­er­ally of “bind­ing iden­ti­fiers” rather than “assign­ing val­ues”, a phrase that nar­rowly sug­gests the use of <span class="my-code" decode="exclude">define</span>. There are many ways to bind an iden­ti­fier. The whole idea of an expander is that it binds the iden­ti­fiers in a parse tree, even though no <span class="my-code" decode="exclude">define</span> expres­sions appear in the parse tree itself.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vUzV5&quot;)"></div><p id="a_vUzV5">This is why the reader deliv­ers code <a href="the-reader.html#the-reader">with­out bind­ings</a>. It needs to cre­ate a blank slate for the expander to do its work.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Xi8Tt&quot;)"></div><p id="a_Xi8Tt">The expander works by export­ing (with <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a>) all the nec­es­sary bind­ings. When the reader returns its mod­ule expres­sion, it embeds a ref­er­ence to the expander. For instance, in the <span class="my-code" decode="exclude">read-syntax</span> func­tion for <span class="my-code" decode="exclude">jsonic</span>, inside <span class="my-code" decode="exclude">module-datum</span>, we see the ref­er­ence to <span class="my-code" decode="exclude">jsonic/expander</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/reader.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GXlrY&quot;)"></div><div class="highlight-container" id="a_GXlrY"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require "tokenizer.rkt" "parser.rkt")<br/><br/>(define (read-syntax path port)<br/>  (define parse-tree (parse path (make-tokenizer port)))<br/>  (define module-datum `(module jsonic-module jsonic/expander<br/>                          ,parse-tree))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_FmXoN"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"tokenizer.rkt"</span> <span class="s2">"parser.rkt"</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">parse-tree</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/examples/nested-word-list..rkt)._parse))" class="docs" hyphens="none">parse</a></span> <span class="n">path</span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">jsonic-module</span> <span class="ss">jsonic/expander</span>
                          <span class="o">,</span><span class="n">parse-tree</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rA1uk&quot;)"></div><p id="a_rA1uk">When the code rep­re­sented by <span class="my-code" decode="exclude">module-datum</span> is eval­u­ated, <span class="my-code" decode="exclude">jsonic/expander</span> is imported and pro­vides the ini­tial bind­ings. In other words, <a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a> behaves as if there were an implicit <span class="my-code" decode="exclude">(require jsonic/expander)</span> on the inside. So we don’t need an explicit <span class="my-code" decode="exclude">require</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_V8dMt&quot;)"></div><p id="a_V8dMt">Again, this is mostly a recap. If the details are hazy, <a href="../stacker/the-reader.html#programming-our-reader-output">here’s a review</a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;designing-the-expander&quot;)"></div><h3 anchor="designing-the-expander" class="subhead" id="designing-the-expander"><a href="#designing-the-expander">Design­ing the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wySfT&quot;)"></div><p id="a_wySfT">Racket starts the expander for a lan­guage by invok­ing a macro called <span class="my-code" decode="exclude">#%module-begin</span>. There­fore, as in pre­vi­ous tuto­ri­als, our <span class="my-code" decode="exclude">jsonic</span> expander will <span class="my-code" decode="exclude">provide</span> a <span class="my-code" decode="exclude">#%module-begin</span> macro.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GycGv&quot;)"></div><p id="a_GycGv">Beyond that, <a href="the-parser.html#testing-the-parser">we just saw</a> how the <a class="glossary" href="../appendix/glossary.html#parse-tree"><span class="glossary-link-text">parse tree</span></a> pro­duced by the <span class="my-code" decode="exclude">jsonic</span> parser fol­lows the <a class="glossary" href="../appendix/glossary.html#production-rule"><span class="glossary-link-text">pro­duc­tion rules</span></a> of the <a class="glossary" href="../appendix/glossary.html#grammar"><span class="glossary-link-text">gram­mar</span></a>. In turn, we can use these pro­duc­tion rules to orga­nize the rest of our expander. Let’s review the <a href="../bf/an-imperative-expander.html#following-the-grammar-into-the-expander">tech­nique we first learned</a> in <a href="../bf/index.html"><span class="my-code" decode="exclude">bf</span></a>:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KstxL&quot;)"></div><p id="a_KstxL">Each pro­duc­tion rule in the gram­mar will have a cor­re­spond­ing <a class="glossary" href="../appendix/glossary.html#macro"><span class="glossary-link-text">macro</span></a> or <a class="glossary" href="../appendix/glossary.html#function"><span class="glossary-link-text">func­tion</span></a> in the expander.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fylFy&quot;)"></div><p id="a_fylFy">The name (on the left side) of each rule is the name of the cor­re­spond­ing macro or func­tion.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oMleA&quot;)"></div><p id="a_oMleA">The pat­tern (on the right side) of each rule describes the pos­si­ble input to that cor­re­spond­ing macro or func­tion.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2kruE&quot;)"></div><p id="a_2kruE">The phrase “macro or func­tion” doesn’t imply that we’ll always have a choice. Cer­tain trans­for­ma­tions will require macros. Oth­er­wise, we should pre­fer func­tions. But here in the <span class="my-code" decode="exclude">jsonic</span> expander, we’ll opt for macros only, just to get some more expe­ri­ence writ­ing them.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0saQM&quot;)"></div><p id="a_0saQM">With that in mind, let’s take another look at the gram­mar for <span class="my-code" decode="exclude">jsonic</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/parser.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GE34m&quot;)"></div><div class="highlight-container" id="a_GE34m"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>jsonic-program : (jsonic-char | jsonic-sexp)*<br/>jsonic-char    : CHAR-TOK<br/>jsonic-sexp    : SEXP-TOK
</div><div class="highlight" form="false" id="a_5vnS4"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang brag
jsonic-program : (jsonic-char | jsonic-sexp)*
jsonic-char    : CHAR-TOK
jsonic-sexp    : SEXP-TOK
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2F0An&quot;)"></div><p id="a_2F0An">This gram­mar implies that our expander should have three more macros (in addi­tion to <span class="my-code" decode="exclude">#%module-begin</span>:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7tO91&quot;)"></div><p id="a_7tO91">A <span class="my-code" decode="exclude">jsonic-program</span> macro that accepts any num­ber of argu­ments, each of which is either an <span class="my-code" decode="exclude">jsonic-sexp</span> or <span class="my-code" decode="exclude">json-char</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dLF1W&quot;)"></div><p id="a_dLF1W">A <span class="my-code" decode="exclude">json-char</span> macro that accepts one argu­ment, which is the string value from a <span class="my-code" decode="exclude">CHAR-TOK</span> token.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9U72K&quot;)"></div><p id="a_9U72K">An <span class="my-code" decode="exclude">jsonic-sexp</span> macro that accepts one argu­ment, which is the string value from a <span class="my-code" decode="exclude">SEXP-TOK</span> token.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sFKCM&quot;)"></div><p id="a_sFKCM">We also know from our <a href="language-specification.html#design">lan­guage spec­i­fi­ca­tion</a> that we need to do some house­keep­ing in terms of con­vert­ing results to strings, and mak­ing sure we’re gen­er­at­ing valid JSON. We’ll deal with those tasks as they arise.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MYkng&quot;)"></div><p id="a_MYkng">That gives us enough of a roadmap to get going.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;starting-the-expander&quot;)"></div><h3 anchor="starting-the-expander" class="subhead" id="starting-the-expander"><a href="#starting-the-expander">Start­ing the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y4MdD&quot;)"></div><p id="a_Y4MdD">Let’s cre­ate a new expander mod­ule called <span class="my-code" decode="exclude">"expander.rkt"</span>. Our expander must have a <span class="my-code" decode="exclude">#%module-begin</span> macro, so we’ll start there. The shell of the macro looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7OyWS&quot;)"></div><div class="highlight-container" id="a_7OyWS"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define-macro (jsonic-mb PARSE-TREE)<br/>  #'(#%module-begin<br/>    ···))<br/>(provide (rename-out [jsonic-mb #%module-begin]))</div><div class="highlight" form="false" id="a_0ncyZ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-mb</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
    <span class="n">···</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">jsonic-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mp38P&quot;)"></div><p id="a_mp38P">Fol­low­ing our <a href="../stacker/the-expander.html#programming-our-expander-output">exist­ing habit</a>, we <span class="my-code" decode="exclude">define</span> the macro as <span class="my-code" decode="exclude">jsonic-mb</span> and then use <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a> in the <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a> expres­sion, so that it doesn’t con­flict with the other <span class="my-code" decode="exclude">#%module-begin</span> imported from <span class="my-code" decode="exclude">br/quicklang</span>. The input to this macro is our <span class="my-code" decode="exclude">PARSE-TREE</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hJJl4&quot;)"></div><p id="a_hJJl4">Now let’s fill in the blanks. A <a href="specification.html#design">major require­ment</a> of our lan­guage is that every <span class="my-code" decode="exclude">jsonic</span> pro­gram results in valid JSON. This implies two things: that the result of the pro­gram has to be a string, and that the string has to be val­i­dated against the JSON stan­dard.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jXjIa&quot;)"></div><p id="a_jXjIa">Let’s assume for a moment that we can con­vert our parse tree into a string (and we will, with our next set of macros). Since <span class="my-code" decode="exclude">jsonic-mb</span> is the top-level macro in our pro­gram, we can use it to val­i­date our new string as valid JSON, and return the result:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Z8Gwh&quot;)"></div><div class="highlight-container" id="a_Z8Gwh"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require json)<br/><br/>(define-macro (jsonic-mb PARSE-TREE)<br/>  #'(#%module-begin<br/>     (define result-string PARSE-TREE)<br/>     (define validated-jsexpr (string-&gt;jsexpr result-string))<br/>     (display result-string)))<br/>(provide (rename-out [jsonic-mb #%module-begin]))</div><div class="highlight" form="false" id="a_mAapm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">json</span><span class="p">)</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-mb</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
<span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">result-string</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
</span><span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">validated-jsexpr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a></span> <span class="n">result-string</span><span class="p">))</span>
</span><span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="n">result-string</span><span class="p">)))</span>
</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">jsonic-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IWiG6&quot;)"></div><p id="a_IWiG6">We’ll assume for now that the expan­sion of <span class="my-code" decode="exclude">PARSE-TREE</span> results in a string, which we assign to <span class="my-code" decode="exclude">result-string</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_z88zk&quot;)"></div><p id="a_z88zk">To help us out, we import Racket’s <a href="http://docs.racket-lang.org/json/index.html"><span class="my-code" decode="exclude">json</span></a> library. A major ben­e­fit of mak­ing lan­guages in Racket is that all its libraries are avail­able for every DSL, so we can be opti­mally lazy.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_om0Tw&quot;)"></div><p id="a_om0Tw">In this case, <span class="my-code" decode="exclude">json</span> exports a func­tion called <a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a>. This func­tion con­verts a string to a spe­cial kind of S-expres­sion called a <a href="http://docs.racket-lang.org/json/index.html#%28part._.J.S-.Expressions%29"><em>JS-expres­sion</em></a>. A JS-expres­sion holds a rep­re­sen­ta­tion of JSON data. If <span class="my-code" decode="exclude">string-&gt;jsexpr</span> suc­ceeds, it returns a JS-expres­sion; oth­er­wise it raises an error.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZHLMT&quot;)"></div><p id="a_ZHLMT">Thus, we can con­firm that the <span class="my-code" decode="exclude">result-string</span> of our pro­gram is valid JSON by call­ing <span class="my-code" decode="exclude">string-&gt;jsexpr</span>. For clar­ity, we assign its return value to <span class="my-code" decode="exclude">validated-jsexpr</span>. This is optional, since we ignore this result—we only care about the val­i­da­tion side effect. Then we just <a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a> our <span class="my-code" decode="exclude">result-string</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;expanding-the-parse-tree&quot;)"></div><h3 anchor="expanding-the-parse-tree" class="subhead" id="expanding-the-parse-tree"><a href="#expanding-the-parse-tree">Expand­ing the parse tree</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5QpaY&quot;)"></div><p id="a_5QpaY">Now we’ll add the macros that cor­re­spond to the pro­duc­tion rules in our <span class="my-code" decode="exclude">jsonic</span> gram­mar.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pnnx4&quot;)"></div><p id="a_pnnx4">We’ll start with <span class="my-code" decode="exclude">json-char</span>, because it’s easy:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DK39o&quot;)"></div><div class="highlight-container" id="a_DK39o"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require json)<br/><br/>(define-macro (jsonic-mb PARSE-TREE)<br/>  #'(#%module-begin<br/>     (define result-string PARSE-TREE)<br/>     (define validated-jsexpr (string-&gt;jsexpr result-string))<br/>     (display result-string)))<br/>(provide (rename-out [jsonic-mb #%module-begin]))<br/><br/>(define-macro (json-char CHAR-TOK-VALUE)<br/>  #'CHAR-TOK-VALUE)<br/>(provide json-char)</div><div class="highlight" form="false" id="a_a8AXO"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">json</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-mb</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">result-string</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">validated-jsexpr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a></span> <span class="n">result-string</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="n">result-string</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">jsonic-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">json-char</span> <span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">json-char</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_i3qR5&quot;)"></div><p id="a_i3qR5">This macro accepts one argu­ment, which is the value from a <span class="my-code" decode="exclude">CHAR-TOK</span> token, rep­re­sent­ing a char­ac­ter in a JSON string. All we need to do in this case is pass through this string, which means con­vert­ing it into a syn­tax object. </p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AUdwO&quot;)"></div><p id="a_AUdwO">By the way, there’s noth­ing spe­cial about the name of the <a class="glossary" href="../appendix/glossary.html#pattern-variable"><span class="glossary-link-text">pat­tern vari­able</span></a>, in this case <span class="my-code" decode="exclude">CHAR-TOK-VALUE</span>. It has noth­ing to do with the token name used in the gram­mar. And the macro would work the same way with any pat­tern-vari­able name.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oDoxu&quot;)"></div><p id="a_oDoxu">Then we’ll move to <span class="my-code" decode="exclude">jsonic-program</span>. It’s almost as easy:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GaQ19&quot;)"></div><div class="highlight-container" id="a_GaQ19"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require json)<br/><br/>(define-macro (jsonic-mb PARSE-TREE)<br/>  #'(#%module-begin<br/>     (define result-string PARSE-TREE)<br/>     (define validated-jsexpr (string-&gt;jsexpr result-string))<br/>     (display result-string)))<br/>(provide (rename-out [jsonic-mb #%module-begin]))<br/><br/>(define-macro (json-char CHAR-TOK-VALUE)<br/>  #'CHAR-TOK-VALUE)<br/>(provide json-char)<br/><br/>(define-macro (jsonic-program SEXP-OR-JSON-STR ...)<br/>  #'(string-trim (string-append SEXP-OR-JSON-STR ...)))<br/>(provide jsonic-program)</div><div class="highlight" form="false" id="a_MYfYb"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">json</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-mb</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">result-string</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">validated-jsexpr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a></span> <span class="n">result-string</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="n">result-string</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">jsonic-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">json-char</span> <span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">json-char</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-program</span> <span class="n">SEXP-OR-JSON-STR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="n">SEXP-OR-JSON-STR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">jsonic-program</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KZb5g&quot;)"></div><p id="a_KZb5g">This macro accepts any num­ber of argu­ments, each of which is either an <span class="my-code" decode="exclude">jsonic-sexp</span> or <span class="my-code" decode="exclude">json-char</span>. Each of these is going to be a lit­tle macro of its own, result­ing in a string. As the top-level macro in the parse tree, <span class="my-code" decode="exclude">jsonic-program</span> needs to com­bine these lit­tle strings into one big string (which will become the input to <span class="my-code" decode="exclude">string-&gt;jsexpr</span> in <span class="my-code" decode="exclude">jsonic-mb</span>).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5P14n&quot;)"></div><p id="a_5P14n">We can do this with <a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a> and, for tidi­ness, <a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a> (which will lop off any lead­ing or trail­ing white­space). (As above, there’s noth­ing spe­cial about the <a class="glossary" href="../appendix/glossary.html#pattern-variable"><span class="glossary-link-text">pat­tern-vari­able</span></a> name <span class="my-code" decode="exclude">SEXP-OR-JSON-STR</span>. It’s just meant to be descrip­tive.)</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GTpXK&quot;)"></div><p id="a_GTpXK">That leaves the <span class="my-code" decode="exclude">jsonic-sexp</span> macro, which is only slightly less easy:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iqqZG&quot;)"></div><div class="highlight-container" id="a_iqqZG"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require json)<br/><br/>(define-macro (jsonic-mb PARSE-TREE)<br/>  #'(#%module-begin<br/>     (define result-string PARSE-TREE)<br/>     (define validated-jsexpr (string-&gt;jsexpr result-string))<br/>     (display result-string)))<br/>(provide (rename-out [jsonic-mb #%module-begin]))<br/><br/>(define-macro (json-char CHAR-TOK-VALUE)<br/>  #'CHAR-TOK-VALUE)<br/>(provide json-char)<br/><br/>(define-macro (jsonic-program SEXP-OR-JSON-STR ...)<br/>  #'(string-trim (string-append SEXP-OR-JSON-STR ...)))<br/>(provide jsonic-program)<br/><br/>(define-macro (jsonic-sexp SEXP-STR)<br/>  (with-pattern ([SEXP-DATUM (format-datum '~a #'SEXP-STR)])<br/>    #'(jsexpr-&gt;string SEXP-DATUM)))<br/>(provide jsonic-sexp)</div><div class="highlight" form="false" id="a_Qae4l"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">json</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-mb</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">result-string</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">validated-jsexpr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a></span> <span class="n">result-string</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="n">result-string</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">jsonic-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">json-char</span> <span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">json-char</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-program</span> <span class="n">SEXP-OR-JSON-STR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="n">SEXP-OR-JSON-STR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">jsonic-program</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-sexp</span> <span class="n">SEXP-STR</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span> <span class="p">([</span><span class="n">SEXP-DATUM</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datum))" class="docs" hyphens="none">format-datum</a></span> <span class="o">&#39;</span><span class="ss">~a</span> <span class="o">#&#39;</span><span class="n">SEXP-STR</span><span class="p">)])</span>
</span><span class="hll">    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._jsexpr-~3estring))" class="docs" hyphens="none">jsexpr-&gt;string</a></span> <span class="n">SEXP-DATUM</span><span class="p">)))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">jsonic-sexp</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yEuiM&quot;)"></div><p id="a_yEuiM">The input is the string value from a <span class="my-code" decode="exclude">SEXP-TOK</span> token, rep­re­sent­ing a Racket expres­sion. In our macro syn­tax pat­tern, we call this <span class="my-code" decode="exclude">SEXP-STR</span>. We need to man­u­ally con­vert this string into a new <a class="glossary" href="../appendix/glossary.html#datum"><span class="glossary-link-text">datum</span></a> that we can insert back into the pro­gram, as if it had been there all along.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uWJhb&quot;)"></div><p id="a_uWJhb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a> lets us intro­duce new pat­tern vari­ables that we can then use inside syn­tax tem­plates. In this case, we want to cre­ate a new <span class="my-code" decode="exclude">SEXP-DATUM</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_INaHs&quot;)"></div><p id="a_INaHs">To make this datum, we pass our <span class="my-code" decode="exclude">SEXP-STR</span> input argu­ment to <a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datum))" class="docs" hyphens="none">format-datum</a>. We used this func­tion before, in the <a href="../stacker/the-reader.html#programming-our-reader-input"><span class="my-code" decode="exclude">stacker</span> reader</a>, to con­vert a source string into an S-expres­sion. We’re using it for the same pur­pose here.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3Khei&quot;)"></div><p id="a_3Khei">A point about nota­tion. In the syn­tax pat­tern defin­ing the macro, we call the pat­tern vari­able <span class="my-code" decode="exclude">SEXP-STR</span>, but within <span class="my-code" decode="exclude">format-datum</span>, we write <span class="my-code" decode="exclude">#'SEXP-STR</span>. In both cases, the name of the pat­tern vari­able is <span class="my-code" decode="exclude">SEXP-STR</span>. But within the macro, we can’t use a naked pat­tern vari­able—we have to put it inside a <a class="glossary" href="../appendix/glossary.html#syntax-template"><span class="glossary-link-text">syn­tax tem­plate</span></a>. So when we say <span class="my-code" decode="exclude">#'SEXP-STR</span>, we’re cre­at­ing the world’s small­est syn­tax tem­plate that con­tains only the pat­tern vari­able <span class="my-code" decode="exclude">SEXP-STR</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vt2Sh&quot;)"></div><p id="a_vt2Sh">Finally, we need to return the result of our Racket expres­sion as a JSON string. In <span class="my-code" decode="exclude">jsonic-mb</span>, we used <a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a> from the <span class="my-code" decode="exclude">json</span> library. This library also pro­vides the inverse func­tion, <a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._jsexpr-~3estring))" class="docs" hyphens="none">jsexpr-&gt;string</a>, to con­vert a Racket JS-expres­sion to a JSON string. So in our syn­tax tem­plate, we just pass our <span class="my-code" decode="exclude">SEXP-DATUM</span> to this func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6tVuI&quot;)"></div><p id="a_6tVuI">As we saw before, one ben­e­fit of rely­ing on Racket’s <span class="my-code" decode="exclude">json</span> library is that we don’t have to work as hard. But even bet­ter, we add a layer of error check­ing to our DSL for free. When <span class="my-code" decode="exclude">jsexpr-&gt;string</span> runs, it will con­firm that our Racket expres­sion rep­re­sents a valid JS-expres­sion, and raise an error if it doesn’t.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_z0Gsx&quot;)"></div><p id="a_z0Gsx">Of course, the cost of rely­ing on the <span class="my-code" decode="exclude">json</span> library is that we have to abide by its rules. For instance, for a <a class="glossary" href="../appendix/glossary.html#hash-table"><span class="glossary-link-text">hash table</span></a> to count as a valid <a href="http://docs.racket-lang.org/json/index.html#%28part._.J.S-.Expressions%29">JS-expres­sion</a>, it has to use only <a class="glossary" href="../appendix/glossary.html#symbol"><span class="glossary-link-text">sym­bols</span></a> for keys. Also, the JSON value <span class="my-code" decode="exclude">null</span> has to be rep­re­sented as the Racket sym­bol <span class="my-code" decode="exclude">'null</span>. If we wanted <span class="my-code" decode="exclude">jsonic</span> to be more lenient with input, we could insert a helper func­tion that would con­vert a wider range of Racket val­ues to the nar­rower set accepted as JS-expres­sions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;checking-the-expander&quot;)"></div><h3 anchor="checking-the-expander" class="subhead" id="checking-the-expander"><a href="#checking-the-expander">Check­ing the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_26UMC&quot;)"></div><p id="a_26UMC">Before we test our expander, let’s check that every­thing is in the right place:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HfwGf&quot;)"></div><div class="highlight-container" id="a_HfwGf"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require json)<br/><br/>(define-macro (js-module-begin PARSE-TREE)<br/>  #'(#%module-begin<br/>     (define result-string PARSE-TREE)<br/>     (define validated-jsexpr (string-&gt;jsexpr result-string))<br/>     (display result-string)))<br/>(provide (rename-out [js-module-begin #%module-begin]))<br/><br/>(define-macro (jsonic-char CHAR-TOK-VALUE)<br/>  #'CHAR-TOK-VALUE)<br/>(provide jsonic-char)<br/><br/>(define-macro (jsonic-program SEXP-OR-JSON-STR ...)<br/>  #'(string-trim (string-append SEXP-OR-JSON-STR ...)))<br/>(provide jsonic-program)<br/><br/>(define-macro (jsonic-sexp SEXP-STR)<br/>  (with-pattern ([SEXP-DATUM (format-datum '~a #'SEXP-STR)])<br/>    #'(jsexpr-&gt;string SEXP-DATUM)))<br/>(provide jsonic-sexp)</div><div class="highlight" form="false" id="a_IvYw3"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">json</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">js-module-begin</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">result-string</span> <span class="n">PARSE-TREE</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">validated-jsexpr</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._string-~3ejsexpr))" class="docs" hyphens="none">string-&gt;jsexpr</a></span> <span class="n">result-string</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="n">result-string</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">js-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-char</span> <span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="n">CHAR-TOK-VALUE</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">jsonic-char</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-program</span> <span class="n">SEXP-OR-JSON-STR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="n">SEXP-OR-JSON-STR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">jsonic-program</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">jsonic-sexp</span> <span class="n">SEXP-STR</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span> <span class="p">([</span><span class="n">SEXP-DATUM</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datum))" class="docs" hyphens="none">format-datum</a></span> <span class="o">&#39;</span><span class="ss">~a</span> <span class="o">#&#39;</span><span class="n">SEXP-STR</span><span class="p">)])</span>
    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/json/index.html#(def._((lib._json/main..rkt)._jsexpr-~3estring))" class="docs" hyphens="none">jsexpr-&gt;string</a></span> <span class="n">SEXP-DATUM</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">jsonic-sexp</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_J1MDA&quot;)"></div><p id="a_J1MDA">Now that we have a reader and expander for <span class="my-code" decode="exclude">jsonic</span>, let’s try using the lan­guage.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification.html">2&emsp;spec­i­fi­ca­tion</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a href="the-reader.html">4&emsp;the reader</a></li><li><a href="the-tokenizer.html">5&emsp;the tok­enizer</a></li><li><a href="the-parser.html">6&emsp;the parser</a></li><li><a class="here" href="the-expander.html">7&emsp;the expander</a></li><li><a href="testing-the-language.html">8&emsp;test­ing the lan­guage</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="the-parser.html">← prev</a>
    <a class="nav-right" href="testing-the-language.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>