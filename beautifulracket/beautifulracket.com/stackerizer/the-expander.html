<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/stackerizer/the-expander.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:16 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Dive deeper into macros: stackerizer</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;dive-deeper-into-macros-stackerizer&quot;)"></div><h1 anchor="dive-deeper-into-macros-stackerizer" id="dive-deeper-into-macros-stackerizer" hyphens="none">Dive deeper into macros: <span class="my-code" decode="exclude">stackerizer</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a class="here" href="the-expander.html">3&emsp;the expander</a></li><li><a href="recap.html">4&emsp;recap</a></li><li><a href="source-listing.html">5&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;simplifying-a-variadic-function&quot;)"></div><h3 anchor="simplifying-a-variadic-function" class="subhead" id="simplifying-a-variadic-function"><a href="#simplifying-a-variadic-function">Sim­pli­fy­ing a vari­adic func­tion</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UfASN&quot;)"></div><p id="a_UfASN">In <span class="my-code" decode="exclude">stackerizer</span>, our <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">*</span> oper­a­tions will take any num­ber of argu­ments. To use the mathy word, they are <em><a class="glossary" href="../appendix/glossary.html#variadic"><span class="glossary-link-text">vari­adic</span></a></em>. But in our <span class="my-code" decode="exclude">stacker</span> tar­get lan­guage, those <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">*</span> oper­a­tions take only two argu­ments (mathy word = <em><a class="glossary" href="../appendix/glossary.html#dyadic"><span class="glossary-link-text">dyadic</span></a></em>). So our first chal­lenge is to fig­ure out how to decom­pose a call to a vari­adic func­tion into some com­bi­na­tion of calls to a dyadic func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_D2P9j&quot;)"></div><p id="a_D2P9j">Let’s set up a sim­ple test case:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xK1vD&quot;)"></div><div class="highlight-container" id="a_xK1vD"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1 2 3 4)</div><div class="highlight" form="false" id="a_MT292"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5PLgF&quot;)"></div><p id="a_5PLgF">Of course, when we run this, we’ll get an error:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fVjXr&quot;)"></div><div class="highlight-container err" id="a_fVjXr"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">module: no #%module-begin binding in the module's language</div><div class="highlight" form="false" id="a_N2Bjr"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>module: no #%module-begin binding in the module&#39;s language
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DtPU1&quot;)"></div><p id="a_DtPU1">That should be totally unsur­pris­ing. Our <span class="my-code" decode="exclude">"stackerizer.rkt"</span> is almost blank. Let’s update it like so:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hKxsL&quot;)"></div><div class="highlight-container" id="a_hKxsL"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(provide + *)<br/><br/>(define-macro (stackerizer-mb EXPR)<br/>  #'(#%module-begin<br/>     EXPR))<br/>(provide (rename-out [stackerizer-mb #%module-begin]))</div><div class="highlight" form="false" id="a_4nkyf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stackerizer-mb</span> <span class="n">EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">EXPR</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stackerizer-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_umT4Q&quot;)"></div><p id="a_umT4Q">First, we’ll <span class="my-code" decode="exclude">provide</span> our <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">*</span> func­tions, just as we did in <span class="my-code" decode="exclude">stacker</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hkhPr&quot;)"></div><p id="a_hkhPr">We stip­u­lated in <a href="specification-and-setup.html">spec­i­fi­ca­tion and setup</a> that <span class="my-code" decode="exclude">stackerizer</span> would ony take one S-expres­sion as input. There­fore, we’ll make a <span class="my-code" decode="exclude">stackerizer-mb</span> that accepts one S-expres­sion, denoted by <span class="my-code" decode="exclude">EXPR</span>, and passes it through. As we did in <span class="my-code" decode="exclude">stacker</span>, we use <span class="my-code" decode="exclude">rename-out</span> to export this macro with the cor­rect <span class="my-code" decode="exclude">#%module-begin</span> name.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zEiAp&quot;)"></div><p id="a_zEiAp">When we run <span class="my-code" decode="exclude">"stackerizer-test.rkt"</span>, we’ll get a new result:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EXzA1&quot;)"></div><div class="highlight-container" id="a_EXzA1"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">10</div><div class="highlight" form="false" id="a_OQ3tn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>10
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JCe5g&quot;)"></div><p id="a_JCe5g">Very good. But our <span class="my-code" decode="exclude">+</span> expres­sion has four argu­ments. We need to put that oper­a­tion in terms of dyadic oper­a­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dX07U&quot;)"></div><p id="a_dX07U">Hope­fully we remem­ber from sixth-grade math that addi­tion is asso­cia­tive and com­mu­ta­tive. That means we can group the argu­ments as we wish, and per­form the addi­tions in any order. For instance, this S-expres­sion will eval­u­ate to same result as the last one:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nluAr&quot;)"></div><div class="highlight-container" id="a_nluAr"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1 (+ 2 (+ 3 4))) ; 10</div><div class="highlight" form="false" id="a_omhwD"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">2</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span> <span class="c1">; 10</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_k8QN9&quot;)"></div><p id="a_k8QN9">This new expres­sion uses only dyadic oper­a­tions. The first addi­tion com­bines <span class="my-code" decode="exclude">(+ 3 4)</span>, the next addi­tion com­bines <span class="my-code" decode="exclude">(+ 2 <em>first-result</em>)</span>, and so on. Fur­ther­more, this pat­tern of nested addi­tions could be extended to any num­ber of argu­ments. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Being able to iden­tify pat­terns in code is an essen­tial skill for writ­ing good macros, since a macro works by match­ing a pat­tern in the code and sys­tem­at­i­cally rear­rang­ing its ele­ments.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VrjqZ&quot;)"></div><p id="a_VrjqZ">For instance, this decom­po­si­tion into dyadic oper­a­tions is also math­e­mat­i­cally sound:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CXeCk&quot;)"></div><div class="highlight-container" id="a_CXeCk"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ (+ 1 2) (+ 3 4)) ; 10</div><div class="highlight" form="false" id="a_emlMl"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span> <span class="c1">; 10</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8A27p&quot;)"></div><p id="a_8A27p">But as a pat­tern, it’s a dead end. When <span class="my-code" decode="exclude">5</span> shows up, where will it go? Whereas with our first pat­tern, it’s easy:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GWPud&quot;)"></div><div class="highlight-container" id="a_GWPud"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1 (+ 2 (+ 3 (+ 4 5)))) ; 15</div><div class="highlight" form="false" id="a_3zPqx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">2</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">3</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))))</span> <span class="c1">; 15</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_muf6z&quot;)"></div><p id="a_muf6z">In effect, we can think of this as the spec­i­fi­ca­tion for our vari­adic-to-dyadic macro: the macro needs to rewrite an expres­sion like <span class="my-code" decode="exclude">(+ 1 2 3 4 5)</span> to look like <span class="my-code" decode="exclude">(+ 1 (+ 2 (+ 3 (+ 4 5))))</span>, for any num­ber of argu­ments.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;from-pattern-to-macro&quot;)"></div><h3 anchor="from-pattern-to-macro" class="subhead" id="from-pattern-to-macro"><a href="#from-pattern-to-macro">From pat­tern to macro</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7VLjD&quot;)"></div><p id="a_7VLjD">Now we can write the macro that will con­vert the vari­adic <span class="my-code" decode="exclude">+</span> into a dyadic ver­sion using this pat­tern. Let’s add this code to <span class="my-code" decode="exclude">"stackerizer.rkt"</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6S5en&quot;)"></div><div class="highlight-container" id="a_6S5en"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(provide + *)<br/><br/>(define-macro (stackerizer-mb EXPR)<br/>  #'(#%module-begin<br/>     EXPR))<br/>(provide (rename-out [stackerizer-mb #%module-begin]))<br/><br/>(define-macro-cases +<br/>  [(+ FIRST) #'FIRST]<br/>  [(+ FIRST NEXT ...) #'(list 'dyadd FIRST (+ NEXT ...))])</div><div class="highlight" form="false" id="a_Pafhu"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stackerizer-mb</span> <span class="n">EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">EXPR</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stackerizer-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
</span><span class="hll">  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
</span><span class="hll">  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">dyadd</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oX8Eh&quot;)"></div><p id="a_oX8Eh">This is the first time we’ve seen <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a>. It works like <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a>. But instead of match­ing a sin­gle <a class="glossary" href="../appendix/glossary.html#syntax-pattern"><span class="glossary-link-text">syn­tax pat­tern</span></a>, it lets us spec­ify a series of pat­terns to match. It works like a <span class="my-code" decode="exclude">cond</span> expres­sion: when a left-hand syn­tax pat­tern matches, the code on the right side of the branch—also known as a <em><a class="glossary" href="../appendix/glossary.html#syntax-template"><span class="glossary-link-text">syn­tax tem­plate</span></a></em>, for self-evi­dent rea­sons—is returned. Oth­er­wise, the next pat­tern is tested.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kipiX&quot;)"></div><p id="a_kipiX">We’re also doing some­thing sneaky: we’re nam­ing our macro <span class="my-code" decode="exclude">+</span>. This means that we’ll over­ride the usual def­i­n­i­tion of <span class="my-code" decode="exclude">+</span> (= a func­tion that adds) and turn it into a macro that does some­thing else.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qx6fv&quot;)"></div><p id="a_qx6fv">What does it do, exactly? Let’s start with the first branch:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_U15AB&quot;)"></div><div class="highlight-container" id="a_U15AB"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">[(+ FIRST) #'FIRST]</div><div class="highlight" form="false" id="a_ULnRy"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HRHbe&quot;)"></div><p id="a_HRHbe">The pat­tern on the left will match a sin­gle-argu­ment addi­tion like <span class="my-code" decode="exclude">(+ 42)</span>. The <span class="my-code" decode="exclude">+</span> in the pat­tern matches lit­er­ally. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">An iden­ti­fier in a syn­tax pat­tern matches an iden­ti­fier in the input “lit­er­ally” when both their datums <strong>and</strong> their bind­ings match (also known as match­ing in the sense of <a href="http://docs.racket-lang.org/reference/stxcmp.html#(def._((quote._~23~25kernel)._free-identifier~3d~3f))" class="docs" hyphens="none">free-identifier=?</a>)</span></span> We’ll match the argu­ment within the pat­tern to the <a class="glossary" href="../appendix/glossary.html#pattern-variable"><span class="glossary-link-text">pat­tern vari­able</span></a> <span class="my-code" decode="exclude">FIRST</span>. Within a syn­tax pat­tern, an all-caps iden­ti­fier like <span class="my-code" decode="exclude">FIRST</span> will match any­thing and assign it that name.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YcLLF&quot;)"></div><p id="a_YcLLF">As for the addi­tion oper­a­tion itself, <span class="my-code" decode="exclude">(+ FIRST)</span> is equiv­a­lent to adding noth­ing. So we’ll just return a <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a> con­tain­ing only our <span class="my-code" decode="exclude">FIRST</span> pat­tern vari­able. As usual, to make a syn­tax object within the cur­rent lex­i­cal con­text, we use the <span class="my-code" decode="exclude">#'</span> pre­fix, so the result is <span class="my-code" decode="exclude">#'FIRST</span>. Easy.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_migGt&quot;)"></div><p id="a_migGt">Now the less easy sec­ond branch:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Jr7dI&quot;)"></div><div class="highlight-container" id="a_Jr7dI"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">[(+ FIRST NEXT ...) #'(list 'dyadd FIRST (+ NEXT ...))]</div><div class="highlight" form="false" id="a_xvHc5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">dyadd</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8fz6C&quot;)"></div><p id="a_8fz6C">The syn­tax pat­tern in this branch will match a vari­adic addi­tion like <span class="my-code" decode="exclude">(+ 1 2 3 4 5)</span>. The first argu­ment is matched to <span class="my-code" decode="exclude">FIRST</span>, and the remain­ing argu­ments are matched to <span class="my-code" decode="exclude">NEXT ...</span>, where the ellip­sis gath­ers every­thing that fol­lows. Note that a pat­tern vari­able with an ellip­sis is allowed to match zero argu­ments. That means this pat­tern could also match some­thing like <span class="my-code" decode="exclude">(+ 42)</span>. But in this macro, our first branch will match that case, so <span class="my-code" decode="exclude">(+ 42)</span> would never reach this branch. That also means that the pat­tern in this branch is guar­an­teed to match two or more argu­ments.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1p3vA&quot;)"></div><p id="a_1p3vA">On the right side, we decom­pose our vari­adic addi­tion into a dyadic addi­tion. For pro­to­typ­ing pur­poses, we’ll sim­u­late the con­ver­sion by using the place­holder <span class="my-code" decode="exclude">'dyadd</span> sym­bol to rep­re­sent a dyadic addi­tion. We see it has two argu­ments, as it must. The first argu­ment will be <span class="my-code" decode="exclude">FIRST</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0SxfJ&quot;)"></div><p id="a_0SxfJ">The sec­ond argu­ment, how­ever, is where the magic hap­pens. We take the rest of our argu­ments, which are stored in <span class="my-code" decode="exclude">NEXT ...</span>, and pass them as input to our <span class="my-code" decode="exclude">+</span> macro. This idea of a func­tion or macro call­ing itself is known as <em><a class="glossary" href="../appendix/glossary.html#recursion"><span class="glossary-link-text">recur­sion</span></a></em>. We’ll be see­ing a lot more of it. The core idea of recur­sion is break­ing down a task into smaller ver­sions of the same task. Here, every time the macro reaches this branch, it peels off the first argu­ment, and recur­sively calls itself using the other argu­ments. Even­tu­ally, there will only be one argu­ment left, which will be han­dled by the first branch.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_eniaU&quot;)"></div><p id="a_eniaU">Let’s see how this works. Save <span class="my-code" decode="exclude">"stackerizer.rkt"</span> and try run­ning these test files. This time, every <span class="my-code" decode="exclude">+</span> in the test pro­gram will be inter­preted as a call to our new <span class="my-code" decode="exclude">+</span> macro. When called with one argu­ment, the macro just returns that argu­ment:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YQ2Z7&quot;)"></div><div class="highlight-container" id="a_YQ2Z7"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1)</div><div class="highlight" form="false" id="a_Q8ZIF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5Sz05&quot;)"></div><div class="highlight-container" id="a_5Sz05"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">1</div><div class="highlight" form="false" id="a_qNC3e"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="mi">1</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GB9l1&quot;)"></div><p id="a_GB9l1">When called with more argu­ments, the macro calls itself recur­sively, thereby return­ing recur­sively nested lists with <span class="my-code" decode="exclude">'dyadd</span>.</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hafgY&quot;)"></div><div class="highlight-container" id="a_hafgY"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1 2)</div><div class="highlight" form="false" id="a_Qq9XT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KRcwa&quot;)"></div><div class="highlight-container" id="a_KRcwa"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(dyadd 1 2)</div><div class="highlight" form="false" id="a_cm7Mb"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">(</span><span class="ss">dyadd</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sQ9Ji&quot;)"></div><div class="highlight-container" id="a_sQ9Ji"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1 2 3 4 5)</div><div class="highlight" form="false" id="a_KVtqT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3lqcC&quot;)"></div><div class="highlight-container" id="a_3lqcC"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(dyadd 1 (dyadd 2 (dyadd 3 (dyadd 4 5))))</div><div class="highlight" form="false" id="a_9Ozgw"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">(</span><span class="ss">dyadd</span> <span class="mi">1</span> <span class="p">(</span><span class="ss">dyadd</span> <span class="mi">2</span> <span class="p">(</span><span class="ss">dyadd</span> <span class="mi">3</span> <span class="p">(</span><span class="ss">dyadd</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CvZ6a&quot;)"></div><p id="a_CvZ6a">Notice how this last result fol­lows the <span class="my-code" decode="exclude">(+ 1 (+ 2 (+ 3 (+ 4 5))))</span> pat­tern we designed ear­lier. We’re on the right track. In fact, to get things a lit­tle closer to the goal, let’s go into our <span class="my-code" decode="exclude">+</span> macro and swap out <span class="my-code" decode="exclude">'dyadd</span> with <span class="my-code" decode="exclude">'+</span> like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UzVzy&quot;)"></div><div class="highlight-container" id="a_UzVzy"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases +<br/>  [(+ FIRST) #'FIRST]<br/>  [(+ FIRST NEXT ...) #'(list '+ FIRST (+ NEXT ...))])</div><div class="highlight" form="false" id="a_6QMQZ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">+</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mBrdB&quot;)"></div><p id="a_mBrdB">Let’s be clear: that <span class="my-code" decode="exclude">'+</span> is a <em><a class="glossary" href="../appendix/glossary.html#symbol"><span class="glossary-link-text">sym­bol</span></a></em> con­sist­ing of one lit­eral plus sign. It is <strong>not</strong> the same as the vari­able <span class="my-code" decode="exclude">+</span> that rep­re­sents our macro (just like the string <span class="my-code" decode="exclude">"+"</span> also is not the same as <span class="my-code" decode="exclude">+</span>). Let’s save <span class="my-code" decode="exclude">"stackerizer.rkt"</span> and try run­ning <span class="my-code" decode="exclude">"stackerizer-test.rkt"</span> again:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cIDIK&quot;)"></div><div class="highlight-container" id="a_cIDIK"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(+ 1 (+ 2 (+ 3 (+ 4 5))))</div><div class="highlight" form="false" id="a_dqG9v"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">(</span><span class="ss">+</span> <span class="mi">1</span> <span class="p">(</span><span class="ss">+</span> <span class="mi">2</span> <span class="p">(</span><span class="ss">+</span> <span class="mi">3</span> <span class="p">(</span><span class="ss">+</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yND8v&quot;)"></div><p id="a_yND8v">That takes us even closer to the goal. We’ll also need to deal with <span class="my-code" decode="exclude">*</span>, of course, but that will fol­low the same pat­tern. Let’s return to that after we’ve tack­led the other lin­ger­ing prob­lem we left for our­selves.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;from-nested-to-flat&quot;)"></div><h3 anchor="from-nested-to-flat" class="subhead" id="from-nested-to-flat"><a href="#from-nested-to-flat">From nested to flat</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_seQ7W&quot;)"></div><p id="a_seQ7W"><span class="my-code" decode="exclude">stacker</span> only han­dles a flat list of argu­ments, but <span class="my-code" decode="exclude">stackerizer</span> allows nested expres­sions. So we have to flat­ten the nest­ed struc­ture into an equiv­a­lent list.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ar8sQ&quot;)"></div><p id="a_ar8sQ">As before, we’ll start by work­ing through a sim­ple exam­ple. In the last sec­tion, we fig­ured out how to con­vert a <span class="my-code" decode="exclude">stackerizer</span> expres­sion like <span class="my-code" decode="exclude">(+ 1 2 3 4)</span> into one that looks like <span class="my-code" decode="exclude">(+ 1 (+ 2 (+ 3 4)))</span>. This time, sup­pose we start with that:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zozCy&quot;)"></div><div class="highlight-container" id="a_zozCy"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">(+ 1 (+ 2 (+ 3 4)))</div><div class="highlight" form="false" id="a_H4F8u"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">2</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ki08T&quot;)"></div><p id="a_Ki08T">How would we write that nested expres­sion in <span class="my-code" decode="exclude">stacker</span>? The expres­sion would be eval­u­ated from inner­most to out­er­most, so the ini­tial <span class="my-code" decode="exclude">(+ 3 4)</span> expres­sion would start our <span class="my-code" decode="exclude">stacker</span> pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zzSwk&quot;)"></div><div class="highlight-container" id="a_zzSwk"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>3<br/>+</div><div class="highlight" form="false" id="a_EzcSU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="mi">4</span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cdWIZ&quot;)"></div><p id="a_cdWIZ">This would leave <span class="my-code" decode="exclude">7</span> on the stack. So if we wanted to then add <span class="my-code" decode="exclude">2</span>, we would write:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GEoT6&quot;)"></div><div class="highlight-container" id="a_GEoT6"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>3<br/>+<br/>2<br/>+</div><div class="highlight" form="false" id="a_6WxMs"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="mi">4</span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">2</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fxNPx&quot;)"></div><p id="a_fxNPx">And then <span class="my-code" decode="exclude">1</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MQD3h&quot;)"></div><div class="highlight-container" id="a_MQD3h"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>3<br/>+<br/>2<br/>+<br/>1<br/>+</div><div class="highlight" form="false" id="a_Lnyuk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="mi">4</span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">2</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">1</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OfzRD&quot;)"></div><p id="a_OfzRD">From this, the pat­tern emerges: we just remove the paren­the­ses, keep­ing the argu­ments in order, and then “rotate” the pro­gram 90 degrees coun­ter­clock­wise. We do that by print­ing them in reverse order, one per line.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_f2Uhj&quot;)"></div><p id="a_f2Uhj">This kind of trans­for­ma­tion is best accom­plished in our <span class="my-code" decode="exclude">stackerizer-mb</span>. Let’s update it as fol­lows:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UUv3G&quot;)"></div><div class="highlight-container" id="a_UUv3G"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(provide + *)<br/><br/>(define-macro (stackerizer-mb EXPR)<br/>  #'(#%module-begin<br/>     (for-each displayln<br/>               (reverse (flatten EXPR)))))<br/>(provide (rename-out [stackerizer-mb #%module-begin]))<br/><br/>(define-macro-cases +<br/>  [(+ FIRST) #'FIRST]<br/>  [(+ FIRST NEXT ...) #'(list '+ FIRST (+ NEXT ...))])</div><div class="highlight" form="false" id="a_4GvYq"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stackerizer-mb</span> <span class="n">EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
<span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" class="docs" hyphens="none">for-each</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span>
</span><span class="hll">               <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" class="docs" hyphens="none">reverse</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._flatten))" class="docs" hyphens="none">flatten</a></span> <span class="n">EXPR</span><span class="p">)))))</span>
</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stackerizer-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">+</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oxD12&quot;)"></div><p id="a_oxD12">Recall that in the first ver­sion, we just passed through the <span class="my-code" decode="exclude">EXPR</span> argu­ment untouched. This time, we’ll <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._flatten))" class="docs" hyphens="none">flatten</a> it (which is equiv­a­lent to remov­ing the inner paren­the­ses) and <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" class="docs" hyphens="none">reverse</a> the order. After that, we use <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" class="docs" hyphens="none">for-each</a> with <a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a> to print each item in this list on a sep­a­rate line. When we run our test pro­gram again:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sQ9Jip&quot;)"></div><div class="highlight-container" id="a_sQ9Jip"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(+ 1 2 3 4 5)</div><div class="highlight" form="false" id="a_KVtqTn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_L17Pd&quot;)"></div><p id="a_L17Pd">We’ll now get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LILNV&quot;)"></div><div class="highlight-container" id="a_LILNV"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">5<br/>4<br/>+<br/>3<br/>+<br/>2<br/>+<br/>1<br/>+</div><div class="highlight" form="false" id="a_NTOtC"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="mi">5</span>
<span class="mi">4</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">2</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">1</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rrhp1&quot;)"></div><p id="a_rrhp1">At this point, it might be clearer why we used the <span class="my-code" decode="exclude">'+</span> sym­bol in our macro: when printed with <span class="my-code" decode="exclude">displayln</span>, it looks just like an ordi­nary <span class="my-code" decode="exclude">+</span> oper­a­tor in a <span class="my-code" decode="exclude">stacker</span> pro­gram.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0Ip9l&quot;)"></div><p id="a_0Ip9l">We’re one giant step closer to the goal. We just need to go back and put in our <span class="my-code" decode="exclude">*</span> oper­a­tor.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;macros-making-macros&quot;)"></div><h3 anchor="macros-making-macros" class="subhead" id="macros-making-macros"><a href="#macros-making-macros">Macros mak­ing macros</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_H7cMi&quot;)"></div><p id="a_H7cMi">The easy way to sup­port our <span class="my-code" decode="exclude">*</span> oper­a­tion would be to copy the macro we made for <span class="my-code" decode="exclude">+</span> and change it to use <span class="my-code" decode="exclude">*</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bJdg5&quot;)"></div><div class="highlight-container" id="a_bJdg5"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases +<br/>  [(+ FIRST) #'FIRST]<br/>  [(+ FIRST NEXT ...) #'(list '+ FIRST (+ NEXT ...))])<br/><br/>(define-macro-cases *<br/>  [(* FIRST) #'FIRST]<br/>  [(* FIRST NEXT ...) #'(list '* FIRST (* NEXT ...))])</div><div class="highlight" form="false" id="a_YaNL6"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">+</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">*</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_RvhnC&quot;)"></div><p id="a_RvhnC">But this would break the heart of any expe­ri­enced Rack­e­teer. Since we’re mak­ing a macro any­how, we might as well make one that can gen­er­ate code for both these vari­ants.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qtn3f&quot;)"></div><p id="a_qtn3f">Macros are per­fectly happy to make other macros. We just have to ask. In <span class="my-code" decode="exclude">"stackerizer.rkt"</span>, let’s delete our <span class="my-code" decode="exclude">+</span> macro and replace it with this new <span class="my-code" decode="exclude">define-op</span> macro:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pbQvI&quot;)"></div><div class="highlight-container" id="a_pbQvI"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(provide + *)<br/><br/>(define-macro (stackerizer-mb EXPR)<br/>  #'(#%module-begin<br/>     (for-each displayln<br/>               (reverse (flatten EXPR)))))<br/>(provide (rename-out [stackerizer-mb #%module-begin]))<br/><br/>(define-macro (define-op OP)<br/>  #'(define-macro-cases OP<br/>      [(OP FIRST) #'FIRST]<br/>      [(OP FIRST NEXT (... ...))<br/>       #'(list 'OP FIRST (OP NEXT (... ...)))]))<br/><br/>(define-op +)<br/>(define-op *)</div><div class="highlight" form="false" id="a_hqNuC"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stackerizer-mb</span> <span class="n">EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" class="docs" hyphens="none">for-each</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span>
               <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" class="docs" hyphens="none">reverse</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._flatten))" class="docs" hyphens="none">flatten</a></span> <span class="n">EXPR</span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stackerizer-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-op</span> <span class="n">OP</span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">OP</span>
</span><span class="hll">      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
</span><span class="hll">      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
</span><span class="hll">       <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">OP</span> <span class="n">FIRST</span> <span class="p">(</span><span class="n">OP</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))]))</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="n">define-op</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
</span><span class="hll"><span class="p">(</span><span class="n">define-op</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpks" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ipRtd&quot;)"></div><p id="a_ipRtd">How did we come up with this? Let’s con­vince our­selves that there’s noth­ing  mys­te­ri­ous hap­pen­ing here. We just need to fol­low the macro recipe we’ve used before. We start with the <span class="my-code" decode="exclude">+</span> macro we already made:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UzVzyv&quot;)"></div><div class="highlight-container" id="a_UzVzyv"><div id="code_70" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases +<br/>  [(+ FIRST) #'FIRST]<br/>  [(+ FIRST NEXT ...) #'(list '+ FIRST (+ NEXT ...))])</div><div class="highlight" form="false" id="a_6QMQZt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">+</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpku" data-clipboard-target="#code_70" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hgMp3&quot;)"></div><p id="a_hgMp3">We wrap it inside a new <span class="my-code" decode="exclude">define-macro</span> form with the name <span class="my-code" decode="exclude">define-op</span>, tak­ing a sin­gle argu­ment named <span class="my-code" decode="exclude">OP</span>, and apply the <span class="my-code" decode="exclude">#'</span> pre­fix to turn our exist­ing code into a syn­tax object:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oE8xr&quot;)"></div><div class="highlight-container" id="a_oE8xr"><div id="code_71" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-op OP)<br/>  #'(define-macro-cases +<br/>      [(+ FIRST) #'FIRST]<br/>      [(+ FIRST NEXT ...) #'(list '+ FIRST (+ NEXT ...))]))</div><div class="highlight" form="false" id="a_glody"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-op</span> <span class="n">OP</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
      <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
      <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">+</span> <span class="n">FIRST</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkw" data-clipboard-target="#code_71" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QHfr3&quot;)"></div><p id="a_QHfr3">We replace the occur­rences of our spe­cific <span class="my-code" decode="exclude">+</span> oper­a­tion with the new pat­tern vari­able <span class="my-code" decode="exclude">OP</span> (when we say <span class="my-code" decode="exclude">'OP</span>, the <span class="my-code" decode="exclude">OP</span> is replaced with its actual value before the <span class="my-code" decode="exclude">'</span> is applied):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Lz2aw&quot;)"></div><div class="highlight-container" id="a_Lz2aw"><div id="code_72" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-op OP)<br/>  #'(define-macro-cases OP<br/>      [(OP FIRST) #'FIRST]<br/>      [(OP FIRST NEXT ...) #'(list 'OP FIRST (OP NEXT ...))]))</div><div class="highlight" form="false" id="a_07aHf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-op</span> <span class="n">OP</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">OP</span>
      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">OP</span> <span class="n">FIRST</span> <span class="p">(</span><span class="n">OP</span> <span class="n">NEXT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkx" data-clipboard-target="#code_72" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_b5Hs5&quot;)"></div><p id="a_b5Hs5">And finally, some fid­dly but nec­es­sary house­keep­ing. We want our ellip­sis oper­a­tors to be used in the pat­terns of the result macros, not the <span class="my-code" decode="exclude">define-op</span> macro itself. So we “escape” them with the spe­cial <span class="my-code" decode="exclude">(... ...)</span> form:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OfxpI&quot;)"></div><div class="highlight-container" id="a_OfxpI"><div id="code_73" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-op OP)<br/>  #'(define-macro-cases OP<br/>      [(OP FIRST) #'FIRST]<br/>      [(OP FIRST NEXT (... ...))<br/>        #'(list 'OP FIRST (OP NEXT (... ...)))]))</div><div class="highlight" form="false" id="a_v1Hzs"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-op</span> <span class="n">OP</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">OP</span>
      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
        <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">OP</span> <span class="n">FIRST</span> <span class="p">(</span><span class="n">OP</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_73" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5FS0o&quot;)"></div><p id="a_5FS0o">All that’s left to do is invoke our new macro with the desired names:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zaxVU&quot;)"></div><div class="highlight-container" id="a_zaxVU"><div id="code_74" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-op OP)<br/>  #'(define-macro-cases OP<br/>      [(OP FIRST) #'FIRST]<br/>      [(OP FIRST NEXT (... ...))<br/>        #'(list 'OP FIRST (OP NEXT (... ...)))]))<br/><br/>(define-op +)<br/>(define-op *)</div><div class="highlight" form="false" id="a_EbwXi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-op</span> <span class="n">OP</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">OP</span>
      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
      <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
        <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">OP</span> <span class="n">FIRST</span> <span class="p">(</span><span class="n">OP</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))]))</span>

<span class="p">(</span><span class="n">define-op</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
<span class="p">(</span><span class="n">define-op</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkz" data-clipboard-target="#code_74" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HJMwE&quot;)"></div><p id="a_HJMwE">That’s it. Each call to <span class="my-code" decode="exclude">define-op</span> cre­ates a new macro using the same tem­plate. Then, both <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">*</span> will be set up cor­rectly.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;ellipsis-power&quot;)"></div><h3 anchor="ellipsis-power" class="subhead" id="ellipsis-power"><a href="#ellipsis-power">Ellip­sis power</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NRNuV&quot;)"></div><p id="a_NRNuV">Our <span class="my-code" decode="exclude">define-op</span> macro will work fine as is. But let’s learn one more thing about the ellip­sis oper­a­tor, which turns out to be a seri­ous macro power tool.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GCsxL&quot;)"></div><p id="a_GCsxL">We saw that in a syn­tax pat­tern, an iden­ti­fier fol­lowed by an ellip­sis like <span class="my-code" decode="exclude">FOO ...</span> will match a list of ele­ments (includ­ing pos­si­bly zero ele­ments). Then, when used in a syn­tax tem­plate, <span class="my-code" decode="exclude">FOO</span> rep­re­sents the first ele­ment of that list, and <span class="my-code" decode="exclude">...</span> rep­re­sents the rest.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kPFpC&quot;)"></div><p id="a_kPFpC">But when we use an ellip­sis in a syn­tax tem­plate, it’s work­ing harder than we might sup­pose. The ellip­sis doesn’t just mean “put the other ele­ments here.” It means “han­dle the other ele­ments the same way we han­dled <span class="my-code" decode="exclude">FOO</span>.” So in a syn­tax tem­plate, we’re allowed to sep­a­rate <span class="my-code" decode="exclude">FOO</span> and its ellip­sis. What­ever we do to <span class="my-code" decode="exclude">FOO</span> ends up as a pro­to­type for the rest of the list, rep­re­sented by <span class="my-code" decode="exclude">...</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_taIN0&quot;)"></div><p id="a_taIN0">Let’s try a sim­ple exam­ple to see how this works. This <span class="my-code" decode="exclude">lister</span> macro will match its input argu­ments to the <span class="my-code" decode="exclude">ARG ...</span> pat­tern vari­able. Then we use <span class="my-code" decode="exclude">ARG ...</span> to insert them into the tem­plate in the same order:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Swu1i&quot;)"></div><div class="highlight-container" id="a_Swu1i"><div id="code_75" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (lister ARG ...)<br/>  #'(list ARG ...))<br/><br/>(lister "foo" "bar" "baz") ; '("foo" "bar" "baz")</div><div class="highlight" form="false" id="a_4zqss"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">lister</span> <span class="n">ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>

<span class="p">(</span><span class="n">lister</span> <span class="s2">"foo"</span> <span class="s2">"bar"</span> <span class="s2">"baz"</span><span class="p">)</span> <span class="c1">; &#39;("foo" "bar" "baz")</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkA" data-clipboard-target="#code_75" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DY1fb&quot;)"></div><p id="a_DY1fb">Now con­sider the <span class="my-code" decode="exclude">wrap</span> macro below. It’s like <span class="my-code" decode="exclude">lister</span>. But in the syn­tax tem­plate, <span class="my-code" decode="exclude">ARG</span> is used sep­a­rately from the ellip­sis. We put <span class="my-code" decode="exclude">ARG</span> in a sub­list with <span class="my-code" decode="exclude">42</span>, and then the ellip­sis takes care of doing the same thing to the rest of the matched argu­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_D41ct&quot;)"></div><div class="highlight-container" id="a_D41ct"><div id="code_76" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (wrap ARG ...)<br/>  #'(list '(ARG 42) ...))<br/><br/>(wrap "foo" "bar" "baz")<br/>; '(("foo" 42) ("bar" 42) ("baz" 42))</div><div class="highlight" form="false" id="a_byWen"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">wrap</span> <span class="n">ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">ARG</span> <span class="mi">42</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>

<span class="p">(</span><span class="n">wrap</span> <span class="s2">"foo"</span> <span class="s2">"bar"</span> <span class="s2">"baz"</span><span class="p">)</span>
<span class="c1">; &#39;(("foo" 42) ("bar" 42) ("baz" 42))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkB" data-clipboard-target="#code_76" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YqIYA&quot;)"></div><p id="a_YqIYA">We can even use <span class="my-code" decode="exclude">ARG</span> mul­ti­ple times in the tem­plate, and the ellip­sis will still do the right thing:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_W2rUs&quot;)"></div><div class="highlight-container" id="a_W2rUs"><div id="code_77" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (wrap2 ARG ...)<br/>  #'(list '(ARG 42 ARG) ...))<br/><br/>(wrap2 "foo" "bar" "baz")<br/>; '(("foo" 42 "foo") ("bar" 42 "bar") ("baz" 42 "baz"))</div><div class="highlight" form="false" id="a_XnKKV"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">wrap2</span> <span class="n">ARG</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">ARG</span> <span class="mi">42</span> <span class="ss">ARG</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>

<span class="p">(</span><span class="n">wrap2</span> <span class="s2">"foo"</span> <span class="s2">"bar"</span> <span class="s2">"baz"</span><span class="p">)</span>
<span class="c1">; &#39;(("foo" 42 "foo") ("bar" 42 "bar") ("baz" 42 "baz"))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkC" data-clipboard-target="#code_77" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OFtU1&quot;)"></div><p id="a_OFtU1">Now we can recon­sider our <span class="my-code" decode="exclude">define-op</span> macro. Let’s replace it with a <span class="my-code" decode="exclude">define-ops</span> macro that will let us gen­er­ate both our <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">*</span> oper­a­tions with one macro call. In the real world, this would be a point­less opti­miza­tion. But we’re just look­ing for a pre­text to use another ellip­sis. Here’s the new code:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2bX69&quot;)"></div><div class="highlight-container" id="a_2bX69"><div id="code_78" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-ops OP ...) ; args stored in `OP ...`<br/>  #'(begin<br/>      (define-macro-cases OP ; `OP` from `OP ...`<br/>        [(OP FIRST) #'FIRST]<br/>        [(OP FIRST NEXT (... ...))<br/>         #'(list 'OP FIRST (OP NEXT (... ...)))])<br/>      ...)) ; `...` from `OP ...`<br/><br/>(define-ops + *)</div><div class="highlight" form="false" id="a_oeQTt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-ops</span> <span class="n">OP</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="c1">; args stored in `OP ...`</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">OP</span> <span class="c1">; `OP` from `OP ...`</span>
        <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
        <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
         <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">OP</span> <span class="n">FIRST</span> <span class="p">(</span><span class="n">OP</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))])</span>
      <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span> <span class="c1">; `...` from `OP ...`</span>

<span class="p">(</span><span class="n">define-ops</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkD" data-clipboard-target="#code_78" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YWuRP&quot;)"></div><p id="a_YWuRP">What’s changed here?</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_g7tgG&quot;)"></div><p id="a_g7tgG">First, we add an ellip­sis to the ini­tial syn­tax pat­tern for the macro, so instead of <span class="my-code" decode="exclude">(define-op OP)</span>, we have <span class="my-code" decode="exclude">(define-ops OP ...)</span>. This makes our macro vari­adic.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ha3Ek&quot;)"></div><p id="a_ha3Ek">Then, within the syn­tax tem­plate, we sur­round every­thing with a new <span class="my-code" decode="exclude">(begin ···)</span> form. A syn­tax tem­plate can only con­tain one top-level expres­sion, so <a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a> is just a way of group­ing mul­ti­ple expres­sions into one.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4a4SZ&quot;)"></div><p id="a_4a4SZ">The code in the mid­dle for the <span class="my-code" decode="exclude">OP</span> macro is the same as before. But after the end of this macro code, we add the ellip­sis that cor­re­sponds to the <span class="my-code" decode="exclude">OP</span> pat­tern vari­able. This ellip­sis applies this macro-code tem­plate to the other matched argu­ments, just as it was applied to <span class="my-code" decode="exclude">OP</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DI89T&quot;)"></div><p id="a_DI89T">Finally, we invoke our new macro with <span class="my-code" decode="exclude">(define-ops + *)</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OdX0e&quot;)"></div><p id="a_OdX0e">Again, in the real world, we wouldn’t bother upgrad­ing <span class="my-code" decode="exclude">define-op</span> to <span class="my-code" decode="exclude">define-ops</span>. But now we’ve seen how the ellip­sis lets us repeat part of a syn­tax tem­plate for each mem­ber of a list of matched argu­ments.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zoLQ2&quot;)"></div><p id="a_zoLQ2">Our fin­ished expander should look like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Byi1C&quot;)"></div><div class="highlight-container" id="a_Byi1C"><div id="code_79" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(provide + *)<br/><br/>(define-macro (stackerizer-mb EXPR)<br/>  #'(#%module-begin<br/>     (for-each displayln (reverse (flatten EXPR)))))<br/>(provide (rename-out [stackerizer-mb #%module-begin]))<br/><br/>(define-macro (define-ops OP ...)<br/>  #'(begin<br/>      (define-macro-cases OP<br/>        [(OP FIRST) #'FIRST]<br/>        [(OP FIRST NEXT (... ...))<br/>         #'(list 'OP FIRST (OP NEXT (... ...)))]) <br/>      ...))<br/><br/>(define-ops + *)</div><div class="highlight" form="false" id="a_Wniln"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stackerizer-mb</span> <span class="n">EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" class="docs" hyphens="none">for-each</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" class="docs" hyphens="none">reverse</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._flatten))" class="docs" hyphens="none">flatten</a></span> <span class="n">EXPR</span><span class="p">)))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stackerizer-mb</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-ops</span> <span class="n">OP</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">OP</span>
        <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">FIRST</span><span class="p">]</span>
        <span class="p">[(</span><span class="n">OP</span> <span class="n">FIRST</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
         <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">&#39;</span><span class="ss">OP</span> <span class="n">FIRST</span> <span class="p">(</span><span class="n">OP</span> <span class="n">NEXT</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))])</span> 
      <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>

<span class="p">(</span><span class="n">define-ops</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkE" data-clipboard-target="#code_79" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-language&quot;)"></div><h3 anchor="testing-our-language" class="subhead" id="testing-our-language"><a href="#testing-our-language">Test­ing our lan­guage</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_77ak9&quot;)"></div><p id="a_77ak9">Now let’s run our orig­i­nal test pro­grams. First, the old favorite:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_q0fpx&quot;)"></div><div class="highlight-container" id="a_q0fpx"><div id="code_80" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(* 3 (+ 8 4))</div><div class="highlight" form="false" id="a_hnuzS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">3</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">8</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkF" data-clipboard-target="#code_80" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6DaQm&quot;)"></div><p id="a_6DaQm">When we run this mod­ule, we get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rBJI2&quot;)"></div><div class="highlight-container" id="a_rBJI2"><div id="code_81" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_iZYPf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkG" data-clipboard-target="#code_81" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_A3sVx&quot;)"></div><p id="a_A3sVx">Then we try:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stackerizer-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GA5FQ&quot;)"></div><div class="highlight-container" id="a_GA5FQ"><div id="code_82" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang s-exp "stackerizer.rkt"<br/>(* 1 2 (+ 3 4 (* 5 6 (+ 7 8 (* 9 10)))))</div><div class="highlight" form="false" id="a_aWbSh"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">s-exp</span> <span class="s2">"stackerizer.rkt"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">3</span> <span class="mi">4</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">5</span> <span class="mi">6</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">7</span> <span class="mi">8</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">9</span> <span class="mi">10</span><span class="p">)))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkH" data-clipboard-target="#code_82" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1yWvD&quot;)"></div><p id="a_1yWvD">This time, we get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_arhxW&quot;)"></div><div class="highlight-container" id="a_arhxW"><div id="code_83" form="false" decode="exclude" style="font-size:0;width:0;height:0">10<br/>9<br/>*<br/>8<br/>+<br/>7<br/>+<br/>6<br/>*<br/>5<br/>*<br/>4<br/>+<br/>3<br/>+<br/>2<br/>*<br/>1<br/>*</div><div class="highlight" form="false" id="a_conif"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="source"><pre><span class="mi">10</span>
<span class="mi">9</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">7</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">6</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
<span class="mi">5</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
<span class="mi">4</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">2</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
<span class="mi">1</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkI" data-clipboard-target="#code_83" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mIL8S&quot;)"></div><p id="a_mIL8S">Exactly right.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a class="here" href="the-expander.html">3&emsp;the expander</a></li><li><a href="recap.html">4&emsp;recap</a></li><li><a href="source-listing.html">5&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="specification-and-setup.html">← prev</a>
    <a class="nav-right" href="recap.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>