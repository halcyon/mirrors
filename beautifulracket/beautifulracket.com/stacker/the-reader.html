<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/stacker/the-reader.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:14 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Make a language in one hour: stacker</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;make-a-language-in-one-hour-stacker&quot;)"></div><h1 anchor="make-a-language-in-one-hour-stacker" id="make-a-language-in-one-hour-stacker" hyphens="none">Make a language in one hour: <span class="my-code" decode="exclude">stacker</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="why-make-languages.html">2&emsp;why make lan­guages</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a class="here" href="the-reader.html">4&emsp;the reader</a></li><li><a href="the-expander.html">5&emsp;the expander</a></li><li><a href="recap.html">6&emsp;recap</a></li><li><a href="source-listing.html">7&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;designing-our-reader&quot;)"></div><h3 anchor="designing-our-reader" class="subhead" id="designing-our-reader"><a href="#designing-our-reader">Design­ing our reader</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7uyg0&quot;)"></div><p id="a_7uyg0">Recall the pur­pose of the reader:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wO33W&quot;)"></div><p id="a_wO33W">The <a class="glossary" href="../appendix/glossary.html#reader"><span class="glossary-link-text">reader</span></a> con­verts the source code of our lan­guage from a string of char­ac­ters into Racket-style paren­the­sized forms, also known as <a class="glossary" href="../appendix/glossary.html#s-expression"><span class="glossary-link-text">S-expres­sions</span></a>.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9Q0dW&quot;)"></div><p id="a_9Q0dW">Let’s visu­al­ize what our reader needs to accom­plish. With­out its <span class="my-code" decode="exclude">#lang</span> line, our <span class="my-code" decode="exclude">stacker</span> test pro­gram looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rBJI2&quot;)"></div><div class="highlight-container" id="a_rBJI2"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_iZYPf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Xf75J&quot;)"></div><p id="a_Xf75J">Clearly, these are not paren­the­sized forms. How can we get there? We can see that <span class="my-code" decode="exclude">stacker</span> has one instruc­tion per line. So the sim­plest idea—never a bad place to start—would be for our reader to wrap paren­the­ses around each line:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AKTV4&quot;)"></div><div class="highlight-container" id="a_AKTV4"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">(4)<br/>(8)<br/>(+)<br/>(3)<br/>(*)</div><div class="highlight" form="false" id="a_z7Ya1"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vQFza&quot;)"></div><p id="a_vQFza">The good news—these now look more like the paren­the­sized forms we need. The bad news—they’re not use­ful. Recall that a paren­the­sized form in Racket is <a href="project-setup.html#racket-basics">treated as a func­tion call</a>. But num­bers aren’t func­tions. So expres­sions like <span class="my-code" decode="exclude">(4)</span> and <span class="my-code" decode="exclude">(8)</span> will pro­duce errors.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9oo8s&quot;)"></div><p id="a_9oo8s">Let’s try it in DrRacket. Open a new win­dow with the default <span class="my-code" decode="exclude">#lang br</span> lan­guage at the top and try eval­u­at­ing <span class="my-code" decode="exclude">(4)</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CTlLi&quot;)"></div><div class="highlight-container" id="a_CTlLi"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(4)</div><div class="highlight" form="false" id="a_vNwwy"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_75e8N&quot;)"></div><p id="a_75e8N">We’ll get an error telling us that <span class="my-code" decode="exclude">4</span> is not a “<a class="glossary" href="../appendix/glossary.html#procedure"><span class="glossary-link-text">pro­ce­dure</span></a>”—another word for a func­tion—“that can be applied to argu­ments”:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2euJs&quot;)"></div><div class="highlight-container err" id="a_2euJs"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">application: not a procedure;<br/> expected a procedure that can be applied to arguments<br/>  given: 4<br/>  arguments...: [none]</div><div class="highlight" form="false" id="a_oSLDg"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>application: not a procedure;
 expected a procedure that can be applied to arguments
  given: 4
  arguments...: [none]
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MX2kt&quot;)"></div><p id="a_MX2kt">Our other two paren­the­sized forms—<span class="my-code" decode="exclude">(+)</span> and <span class="my-code" decode="exclude">(*)</span>—are valid func­tion calls. Again, we can ver­ify this by eval­u­at­ing them in DrRacket:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_d7O8F&quot;)"></div><div class="highlight-container" id="a_d7O8F"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">(+) ; 0<br/>(*) ; 1</div><div class="highlight" form="false" id="a_Da3oi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span> <span class="c1">; 0</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span> <span class="c1">; 1</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wFV1x&quot;)"></div><p id="a_wFV1x">But as it stands, they’re being eval­u­ated with­out any input argu­ments. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Math fans can fig­ure out why it makes sense that <span class="my-code" decode="exclude">(+)</span> eval­u­ates to <span class="my-code" decode="exclude">0</span> and <span class="my-code" decode="exclude">(*)</span> to <span class="my-code" decode="exclude">1</span>.</span></span> That’s wrong. They’re sup­posed to take their input from the top of the stack.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ea0eB&quot;)"></div><p id="a_Ea0eB">Our first idea—wrap­ping our argu­ments with paren­the­ses—won’t work. We need to han­dle the inter­ac­tion of our stack and the argu­ments in the pro­gram more care­fully.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LhxW1&quot;)"></div><p id="a_LhxW1">Instead, sup­pose we have an inter­me­di­ary func­tion—call it <span class="my-code" decode="exclude">handle</span>—that inspects each instruc­tion and decides what to do. Fur­ther sup­pose that we wrap each pro­gram argu­ment like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MVLt3&quot;)"></div><div class="highlight-container" id="a_MVLt3"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(handle 4)<br/>(handle 8)<br/>(handle +)<br/>(handle 3)<br/>(handle *)</div><div class="highlight" form="false" id="a_YvvlF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">handle</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_glDP1&quot;)"></div><p id="a_glDP1">What have we accom­plished? Our <span class="my-code" decode="exclude">stacker</span> argu­ments will no longer be treated as func­tion calls. Rather, they’re now input to another func­tion:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8mXDp&quot;)"></div><p id="a_8mXDp"><span class="my-code" decode="exclude">(handle 4)</span> means “call <span class="my-code" decode="exclude">handle</span> with <span class="my-code" decode="exclude">4</span> as the argu­ment.” In that case, <span class="my-code" decode="exclude">handle</span> can push the num­ber onto the stack.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_40SDP&quot;)"></div><p id="a_40SDP"><span class="my-code" decode="exclude">(handle +)</span> means that <span class="my-code" decode="exclude">handle</span> should get the top two argu­ments from the stack and apply the oper­a­tion.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cLyzr&quot;)"></div><p id="a_cLyzr">Now that we know what our reader needs to do, we can pro­gram it.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a-peek-into-the-future&quot;)"></div><h3 anchor="a-peek-into-the-future" class="subhead" id="a-peek-into-the-future"><a href="#a-peek-into-the-future">A peek into the future</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VmpTT&quot;)"></div><p id="a_VmpTT">“Wait—where does this mag­i­cal <span class="my-code" decode="exclude">handle</span> func­tion come from?” Remem­ber the other indis­pens­able part of our lan­guage:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1WvG1&quot;)"></div><p id="a_1WvG1">The <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a>, which deter­mines how these paren­the­sized forms cor­re­spond to real Racket expres­sions (and which are then eval­u­ated to pro­duce a result).</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_clmLr&quot;)"></div><p id="a_clmLr">With the reader, we’re putting our pro­gram into the proper form. With the expander, we’ll give mean­ing to these forms. So our <span class="my-code" decode="exclude">handle</span> func­tion will even­tu­ally be avail­able through our expander.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_o49HF&quot;)"></div><p id="a_o49HF">If it seems sneaky to make plans around a nonex­is­tent func­tion, don’t panic. The reader and expander always exist as a coop­er­at­ing pair. But they have dis­tinct roles. So we want to put things in the right place. The <span class="my-code" decode="exclude">handle</span> func­tion itself belongs in the expander, not the reader.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1RAIp&quot;)"></div><p id="a_1RAIp">Hav­ing glimpsed the future, we return to the code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;programming-our-reader-output&quot;)"></div><h3 anchor="programming-our-reader-output" class="subhead" id="programming-our-reader-output"><a href="#programming-our-reader-output">Pro­gram­ming our reader: out­put</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_m5iUj&quot;)"></div><p id="a_m5iUj">Racket expects the reader to export a func­tion named <span class="my-code" decode="exclude">read-syntax</span>. As the first step in run­ning a source file with a <span class="my-code" decode="exclude">#lang</span> line, Racket passes the source code to the reader for the lan­guage. It does this by call­ing <span class="my-code" decode="exclude">read-syntax</span> with two argu­ments: the <em><a class="glossary" href="../appendix/glossary.html#path"><span class="glossary-link-text">path</span></a></em> to the source file, and a <em><a class="glossary" href="../appendix/glossary.html#port"><span class="glossary-link-text">port</span></a></em> for read­ing data from the file. We’ll come back to these.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SceWI&quot;)"></div><p id="a_SceWI">For now, let’s con­sider the out­put. Every <span class="my-code" decode="exclude">read-syntax</span> has one job: to return code describ­ing a <em><a class="glossary" href="../appendix/glossary.html#module"><span class="glossary-link-text">mod­ule</span></a></em>, pack­aged as a <em><a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a></em>. Racket will replace the source code with this mod­ule code. This mod­ule, in turn, will invoke the expander for our lan­guage, trig­ger­ing the full expan­sion and eval­u­a­tion of the source code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_H1c2G&quot;)"></div><p id="a_H1c2G">Let’s step through these new con­cepts by work­ing through a sam­ple <span class="my-code" decode="exclude">read-syntax</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_g7Sg5&quot;)"></div><div class="highlight-container" id="a_g7Sg5"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (datum-&gt;syntax #f '(module lucy br<br/>                       42)))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_RlSYU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">module</span> <span class="ss">lucy</span> <span class="ss">br</span>
                       <span class="mi">42</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y2p4F&quot;)"></div><p id="a_Y2p4F">To cre­ate a func­tion, we use <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_k3L8l&quot;)"></div><div class="highlight-container" id="a_k3L8l"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (read-syntax path port) ···</div><div class="highlight" form="false" id="a_azNaF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span> <span class="n">···</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oSfJj&quot;)"></div><p id="a_oSfJj">This line sets up a func­tion called <span class="my-code" decode="exclude">read-syntax</span> that accepts two argu­ments. These are <em><a class="glossary" href="../appendix/glossary.html#positional-argument"><span class="glossary-link-text">posi­tional argu­ments</span></a></em>, so we can name them what­ever we like. We’ll be bor­ing and call them <span class="my-code" decode="exclude">path</span> and <span class="my-code" decode="exclude">port</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BO8ph&quot;)"></div><p id="a_BO8ph">We also need to export <span class="my-code" decode="exclude">read-syntax</span> so it’s avail­able out­side this file. In Racket, all def­i­n­i­tions are pri­vate by default. To make a def­i­n­i­tion pub­lic, we use <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UGls5&quot;)"></div><div class="highlight-container" id="a_UGls5"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(provide read-syntax)</div><div class="highlight" form="false" id="a_FJy1u"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZHu1m&quot;)"></div><p id="a_ZHu1m">The body of <span class="my-code" decode="exclude">read-syntax</span> per­forms two tasks.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cN3Kx&quot;)"></div><p id="a_cN3Kx">First, it reads the source code from <span class="my-code" decode="exclude">port</span>. A <em><a class="glossary" href="../appendix/glossary.html#port"><span class="glossary-link-text">port</span></a></em> is a generic inter­face for input (or out­put) that can be read (or writ­ten) incre­men­tally—that is, piece by piece. For instance, if we stop read­ing an input port, the port remem­bers where we stopped. The next time we read from the port, we can resume from the same place. Input ports are use­ful when we’re wary of the size of the file on the other side. It might be too humon­gous to fit into mem­ory.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vSXNk&quot;)"></div><p id="a_vSXNk">In <span class="my-code" decode="exclude">stacker</span>, that won’t be a prob­lem. So let’s just read every­thing from our port at once:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xXOIe&quot;)"></div><div class="highlight-container" id="a_xXOIe"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define src-lines (port-&gt;lines port))</div><div class="highlight" form="false" id="a_HQqgH"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1T69D&quot;)"></div><p id="a_1T69D">We con­vert the con­tents of <span class="my-code" decode="exclude">port</span> to a list of strings by pass­ing it to <a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a>. We store the result in <span class="my-code" decode="exclude">src-lines</span>. (In this toy exam­ple, we won’t actu­ally use <span class="my-code" decode="exclude">src-lines</span>, but we will later on, in the fin­ished ver­sion of this func­tion.)</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Lq84h&quot;)"></div><p id="a_Lq84h">The sec­ond task of <span class="my-code" decode="exclude">read-syntax</span> is to return code describ­ing a mod­ule. In Racket, a <em><a class="glossary" href="../appendix/glossary.html#module"><span class="glossary-link-text">mod­ule</span></a></em> is the basic orga­ni­za­tional unit for pro­gram code. Like every­thing else in Racket, a mod­ule is an expres­sion. The code for a mod­ule expres­sion fol­lows this pat­tern:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Aqpt6&quot;)"></div><div class="highlight-container" id="a_Aqpt6"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module module-name which-expander<br/>   expressions<br/>   to-expand<br/>   and-evaluate ···)</div><div class="highlight" form="false" id="a_RQYv0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">module-name</span> <span class="n">which-expander</span>
   <span class="n">expressions</span>
   <span class="n">to-expand</span>
   <span class="n">and-evaluate</span> <span class="n">···</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xA5p1&quot;)"></div><p id="a_xA5p1">So our sam­ple mod­ule code:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qqkbc&quot;)"></div><div class="highlight-container" id="a_qqkbc"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module lucy br<br/>  42)</div><div class="highlight" form="false" id="a_zuhmz"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">lucy</span> <span class="n">br</span>
  <span class="mi">42</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uGzJ3&quot;)"></div><p id="a_uGzJ3">Means “a mod­ule named <span class="my-code" decode="exclude">lucy</span>, using the expander from the <span class="my-code" decode="exclude">br</span> lan­guage, that eval­u­ates the expres­sion <span class="my-code" decode="exclude">42</span>.”</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UyUln&quot;)"></div><p id="a_UyUln">The mod­ule name is arbi­trary. It doesn’t affect how the mod­ule works.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_msQ5l&quot;)"></div><p id="a_msQ5l">The expander, how­ever, is highly con­se­quen­tial. It deter­mines how the expres­sions inside the mod­ule are inter­preted. Here, we can use the <span class="my-code" decode="exclude">br</span> short­hand because that lan­guage is already installed. But we can also use an explicit path string to des­ig­nate a source file with an expander, for instance:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3jkMa&quot;)"></div><div class="highlight-container" id="a_3jkMa"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module lucy "path/to/expander.rkt"<br/>  42)</div><div class="highlight" form="false" id="a_MCkwi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">lucy</span> <span class="s2">"path/to/expander.rkt"</span>
  <span class="mi">42</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2zlSM&quot;)"></div><p id="a_2zlSM">We still need to con­vert our mod­ule code into a <em><a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a></em>, which is a way of treat­ing code as data. We can use a syn­tax object to store a chunk of source code so it can be eval­u­ated later. Here’s how we do that:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AbQcN&quot;)"></div><p id="a_AbQcN">First, we turn the expres­sion into a <em><a class="glossary" href="../appendix/glossary.html#datum"><span class="glossary-link-text">datum</span></a></em>, which is the raw rep­re­sen­ta­tion of the code as it appears in the source. A datum is not unlike stash­ing code inside a string, but one step evolved, because it pre­serves the list struc­ture of the expres­sion. (Strings, by con­trast, are inher­ently flat.) To make a datum, we use <span class="my-code" decode="exclude">quote</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6sYTT&quot;)"></div><div class="highlight-container" id="a_6sYTT"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">(quote (module lucy br<br/>         42))</div><div class="highlight" form="false" id="a_A5doy"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/quote.html#(form._((quote._~23~25kernel)._quote))" class="docs" hyphens="none">quote</a></span> <span class="p">(</span><span class="ss">module</span> <span class="ss">lucy</span> <span class="ss">br</span>
         <span class="mi">42</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nIGvd&quot;)"></div><p id="a_nIGvd">But in Racket, datums are so com­mon that there’s a short­hand nota­tion for <span class="my-code" decode="exclude">quote</span>—we just add a <span class="my-code" decode="exclude">'</span> pre­fix to the expres­sion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rztLn&quot;)"></div><div class="highlight-container" id="a_rztLn"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(module lucy br<br/>  42)</div><div class="highlight" form="false" id="a_zuhmze"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">(</span><span class="ss">module</span> <span class="ss">lucy</span> <span class="ss">br</span>
  <span class="mi">42</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SMiBo&quot;)"></div><p id="a_SMiBo">With the <span class="my-code" decode="exclude">'</span> pre­fix, this is no longer code for a mod­ule, but rather a list expres­sion with three sym­bols and a num­ber, as we can ver­ify on the <a class="explainer" href="../explainer/repl.html">REPL</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ct63n&quot;)"></div><div class="highlight-container" id="a_Ct63n"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define datum '(module lucy br<br/>                 42))<br/>(list? datum) ; #t<br/>(length datum) ; 4</div><div class="highlight" form="false" id="a_EUpf0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">datum</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">module</span> <span class="ss">lucy</span> <span class="ss">br</span>
                 <span class="mi">42</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list~3f))" class="docs" hyphens="none">list?</a></span> <span class="n">datum</span><span class="p">)</span> <span class="c1">; #t</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" class="docs" hyphens="none">length</a></span> <span class="n">datum</span><span class="p">)</span> <span class="c1">; 4</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DLtFv&quot;)"></div><p id="a_DLtFv">Then we turn our datum into a syn­tax object. Under the hood, a syn­tax object is just a datum with some extra infor­ma­tion attached, includ­ing its con­text within a pro­gram. We can upgrade a datum to a syn­tax object using <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a>. The first argu­ment of <span class="my-code" decode="exclude">datum-&gt;syntax</span> is the pro­gram con­text we want to asso­ciate with the code. We don’t need to do that yet, so we pass <span class="my-code" decode="exclude">#f</span> for the con­text. The sec­ond argu­ment is our datum:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7YLIb&quot;)"></div><div class="highlight-container" id="a_7YLIb"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">(datum-&gt;syntax #f '(module lucy br<br/>                     42))</div><div class="highlight" form="false" id="a_t6hVf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">module</span> <span class="ss">lucy</span> <span class="ss">br</span>
                     <span class="mi">42</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DkQb0&quot;)"></div><p id="a_DkQb0">Finally, we need to return this syn­tax object as the result of the func­tion. Racket has no explicit <span class="my-code" decode="exclude">return</span> state­ment. The return value of a func­tion is just the last expres­sion that appears in its body. So as long as our syn­tax object is the last expres­sion in the body of <span class="my-code" decode="exclude">read-syntax</span>, we’re good.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tm2Hm&quot;)"></div><p id="a_tm2Hm">Now we under­stand every­thing that’s hap­pen­ing in <span class="my-code" decode="exclude">"stacker.rkt"</span>. We’ve defined a <span class="my-code" decode="exclude">read-syntax</span> func­tion that, when invoked, will return a syn­tax object describ­ing a mod­ule, which can be eval­u­ated later.</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_g7Sg5k&quot;)"></div><div class="highlight-container" id="a_g7Sg5k"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (datum-&gt;syntax #f '(module lucy br<br/>                       42)))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_RlSYUi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">module</span> <span class="ss">lucy</span> <span class="ss">br</span>
                       <span class="mi">42</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;trying-our-sample-reader&quot;)"></div><h3 anchor="trying-our-sample-reader" class="subhead" id="trying-our-sample-reader"><a href="#trying-our-sample-reader">Try­ing our sam­ple reader</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_a4jbx&quot;)"></div><p id="a_a4jbx">“Eval­u­ated later—like when?” When we invoke the <span class="my-code" decode="exclude">stacker</span> lan­guage. Let’s see how this works. We return to <span class="my-code" decode="exclude">"stacker-test.rkt"</span>. Thist time, let’s insert some dummy argu­ments:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5af0u&quot;)"></div><div class="highlight-container" id="a_5af0u"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>foo<br/>bar<br/>zam</div><div class="highlight" form="false" id="a_kA9Cr"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="n">foo</span>
<span class="n">bar</span>
<span class="n">zam</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OlFY2&quot;)"></div><p id="a_OlFY2">When we first tried to run the <span class="my-code" decode="exclude">"stacker.rkt"</span> lan­guage, we got an error, because we hadn’t yet made a reader.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kwWZZ&quot;)"></div><p id="a_kwWZZ">Now we have. So let’s run it again. This time, we’ll get a dif­fer­ent result:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JWZzB&quot;)"></div><div class="highlight-container" id="a_JWZzB"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">42</div><div class="highlight" form="false" id="a_bclDp"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>42
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JnNrz&quot;)"></div><p id="a_JnNrz">What’s hap­pen­ing this time? The <span class="my-code" decode="exclude">#lang reader</span> line is respon­si­ble for invok­ing the reader for <span class="my-code" decode="exclude">stacker</span>. To do this, Racket calls our <span class="my-code" decode="exclude">read-syntax</span> func­tion. Our func­tion returns a syn­tax object that describes a mod­ule.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_huv6F&quot;)"></div><p id="a_huv6F">Here’s what hap­pens next: the source code in <span class="my-code" decode="exclude">"stacker-test.rkt"</span> is <strong>entirely replaced</strong> with the syn­tax object returned by <span class="my-code" decode="exclude">read-syntax</span>. So under the hood, this file:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5af0up&quot;)"></div><div class="highlight-container" id="a_5af0up"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>foo<br/>bar<br/>zam</div><div class="highlight" form="false" id="a_kA9Crn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="n">foo</span>
<span class="n">bar</span>
<span class="n">zam</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2kdQh&quot;)"></div><p id="a_2kdQh">Becomes this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt (after read-syntax)</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qqkbcs&quot;)"></div><div class="highlight-container" id="a_qqkbcs"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module lucy br<br/>  42)</div><div class="highlight" form="false" id="a_zuhmzq"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">lucy</span> <span class="n">br</span>
  <span class="mi">42</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_gbuvd&quot;)"></div><p id="a_gbuvd">Once our syn­tax object gets moved into its new loca­tion as real code, it looks just like our mod­ule-expres­sion datum, except that it’s no longer quoted. This makes sense—when we made the mod­ule datum, we wanted to treat the code as data, so we pre­fixed it with <span class="my-code" decode="exclude">'</span>. Now we want to reverse the alchemy, and treat the data as code. So it gets unquoted. After that, the mod­ule expres­sion is eval­u­ated, pro­duc­ing <span class="my-code" decode="exclude">42</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZLw2S&quot;)"></div><p id="a_ZLw2S">Let’s per­suade our­selves that noth­ing spooky has hap­pened. Our <span class="my-code" decode="exclude">read-syntax</span> is respon­si­ble for read­ing the lines of our source file (for now, ignor­ing them) and return­ing a syn­tax object. The new magic we’re wit­ness­ing is that after Racket has passed the source code to <span class="my-code" decode="exclude">read-syntax</span> as an input port, it replaces that source code with the result from <span class="my-code" decode="exclude">read-syntax</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SgTI3&quot;)"></div><p id="a_SgTI3">Let’s ensure that we’re unim­pressed by this magic. We can accom­plish the same trans­for­ma­tion by hand. We replace the source code in <span class="my-code" decode="exclude">"stacker-test.rkt"</span> with our mod­ule code (this time with­out the <span class="my-code" decode="exclude">'</span> pre­fix, because we want the code to be eval­u­ated), and run it:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qqkbcv&quot;)"></div><div class="highlight-container" id="a_qqkbcv"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module lucy br<br/>  42)</div><div class="highlight" form="false" id="a_zuhmzt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">lucy</span> <span class="n">br</span>
  <span class="mi">42</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpku" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IJLd2&quot;)"></div><p id="a_IJLd2">Once again we get <span class="my-code" decode="exclude">42</span>. In gen­eral, every source file that begins with a <span class="my-code" decode="exclude">#lang</span> line gets con­verted to a mod­ule by the lan­guage reader. This is why source files in Racket are also known as mod­ules. (For more, see <a href="../explainer/lang-line.html">the <span class="my-code" decode="exclude">#lang</span> line</a>.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_flcUT&quot;)"></div><p id="a_flcUT">This proved that we can make a round trip from a source file to the <span class="my-code" decode="exclude">stacker</span> reader and back. The major prob­lem with our reader is that it’s not doing any­thing with the <span class="my-code" decode="exclude">src-lines</span> we read from the source file. So let’s fix that.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;programming-our-reader-input&quot;)"></div><h3 anchor="programming-our-reader-input" class="subhead" id="programming-our-reader-input"><a href="#programming-our-reader-input">Pro­gram­ming our reader: input</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cznl9&quot;)"></div><p id="a_cznl9">Right now, we’re ignor­ing the lines of our input source file. So we’ll upgrade our reader to com­plete two new tasks:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JkXHE&quot;)"></div><p id="a_JkXHE">Wrap each line in a <span class="my-code" decode="exclude">(handle ···)</span> form.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DuGGj&quot;)"></div><p id="a_DuGGj">Insert these new forms into the mod­ule we’re return­ing as a syn­tax object.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NrNr0&quot;)"></div><p id="a_NrNr0">To do this, let’s swap out the <span class="my-code" decode="exclude">read-syntax</span> in <span class="my-code" decode="exclude">"stacker.rkt"</span> for a new ver­sion:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EYEmO&quot;)"></div><div class="highlight-container" id="a_EYEmO"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod br<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_EC3zq"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="ss">br</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkw" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FzXwx&quot;)"></div><p id="a_FzXwx">As we’ll see in the next sec­tion, this code will raise an error when we try to use it as a lan­guage. But let’s step through each line to see what it does, and then we’ll be able to under­stand the error.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xXOIez&quot;)"></div><div class="highlight-container" id="a_xXOIez"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define src-lines (port-&gt;lines port))</div><div class="highlight" form="false" id="a_HQqgHx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_slNdZ&quot;)"></div><p id="a_slNdZ">As we did before, we use <a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a> to retrieve the lines from our input <span class="my-code" decode="exclude">port</span>—each rep­re­sent­ing an argu­ment in a <span class="my-code" decode="exclude">stacker</span> pro­gram—as a list of strings. We store this list in <span class="my-code" decode="exclude">src-lines</span>. (In this project, we don’t need <span class="my-code" decode="exclude">path</span>, so we’ll ignore it.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NwXAm&quot;)"></div><div class="highlight-container" id="a_NwXAm"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define src-datums (format-datums '(handle ~a) src-lines))</div><div class="highlight" form="false" id="a_8zxN6"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkA" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_w3y2D&quot;)"></div><p id="a_w3y2D">Next, we con­vert these strings into datums. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Yes, the plural of <em>datum</em> ought to be <em>data</em>. But this poetic license will help us avoid con­fu­sion with the tra­di­tional generic mean­ing of “data”.</span></span> <span class="my-code" decode="exclude">format-datums</span> takes a list of strings and con­verts each of them using a <em><a class="glossary" href="../appendix/glossary.html#format-string"><span class="glossary-link-text">for­mat string</span></a></em>. The <span class="my-code" decode="exclude">~a</span> marks the place where the argu­ment string will be sub­sti­tuted. So the string <span class="my-code" decode="exclude">"4"</span> from the source file will become the datum <span class="my-code" decode="exclude">'(handle 4)</span>, and <span class="my-code" decode="exclude">"+"</span> will become <span class="my-code" decode="exclude">'(handle +)</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DwdsH&quot;)"></div><div class="highlight-container" id="a_DwdsH"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define module-datum `(module stacker-mod br<br/>                        ,@src-datums))</div><div class="highlight" form="false" id="a_rb5Rx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="ss">br</span>
                        <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkB" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VdF7A&quot;)"></div><p id="a_VdF7A">Then we make our mod­ule datum. Here we intro­duce a new bit of nota­tion: the back­tick <span class="my-code" decode="exclude">`</span> is called <em><a class="glossary" href="../appendix/glossary.html#quasiquote"><span class="glossary-link-text">qua­si­quote</span></a></em>. As the name implies, it  works mostly the same way as the usual quote pre­fix <span class="my-code" decode="exclude">'</span>. The “quasi” part is that we can insert vari­ables into the list. To insert a sin­gle value, we use the <a href="http://docs.racket-lang.org/reference/quasiquote.html#(form._((quote._~23~25kernel)._unquote))" class="docs" hyphens="none">unquote</a> oper­a­tor, which is a comma <span class="my-code" decode="exclude">,</span> fol­lowed by the vari­able:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_l2VHg&quot;)"></div><div class="highlight-container" id="a_l2VHg"><div id="code_70" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define x 42)<br/>`(41 ,x 43) ; '(41 42 43)</div><div class="highlight" form="false" id="a_0XaD6"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="mi">42</span><span class="p">)</span>
<span class="o">`</span><span class="p">(</span><span class="mi">41</span> <span class="o">,</span><span class="n">x</span> <span class="mi">43</span><span class="p">)</span> <span class="c1">; &#39;(41 42 43)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkC" data-clipboard-target="#code_70" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PKJbY&quot;)"></div><p id="a_PKJbY">To insert a list of mul­ti­ple val­ues, we use the <a href="http://docs.racket-lang.org/reference/quasiquote.html#(form._((quote._~23~25kernel)._unquote-splicing))" class="docs" hyphens="none">unquote-splicing</a> oper­a­tor, which is a comma and at sign <span class="my-code" decode="exclude">,@</span> fol­lowed by the vari­able. The unquote-splic­ing oper­a­tor merges our sub­list with the sur­round­ing list:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ABJ79&quot;)"></div><div class="highlight-container" id="a_ABJ79"><div id="code_71" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define xs (list 42 43 44))<br/>`(41 ,@xs 45) ; '(41 42 43 44 45)</div><div class="highlight" form="false" id="a_33IjX"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">xs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="mi">42</span> <span class="mi">43</span> <span class="mi">44</span><span class="p">))</span>
<span class="o">`</span><span class="p">(</span><span class="mi">41</span> <span class="o">,@</span><span class="n">xs</span> <span class="mi">45</span><span class="p">)</span> <span class="c1">; &#39;(41 42 43 44 45)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkD" data-clipboard-target="#code_71" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OYhHH&quot;)"></div><p id="a_OYhHH">Notice that if we use the unquote oper­a­tor with a sub­list, the sub­list will remain nested:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3q21c&quot;)"></div><div class="highlight-container" id="a_3q21c"><div id="code_72" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define xs (list 42 43 44))<br/>`(41 ,xs 45) ; '(41 (42 43 44) 45)</div><div class="highlight" form="false" id="a_OqOQB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">xs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="mi">42</span> <span class="mi">43</span> <span class="mi">44</span><span class="p">))</span>
<span class="o">`</span><span class="p">(</span><span class="mi">41</span> <span class="o">,</span><span class="n">xs</span> <span class="mi">45</span><span class="p">)</span> <span class="c1">; &#39;(41 (42 43 44) 45)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkE" data-clipboard-target="#code_72" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OrDIm&quot;)"></div><p id="a_OrDIm">Now we can under­stand what’s hap­pen­ing in our mod­ule datum:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DwdsHH&quot;)"></div><div class="highlight-container" id="a_DwdsHH"><div id="code_73" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define module-datum `(module stacker-mod br<br/>                        ,@src-datums))</div><div class="highlight" form="false" id="a_rb5RxF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="ss">br</span>
                        <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkG" data-clipboard-target="#code_73" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_X6AYy&quot;)"></div><p id="a_X6AYy">This datum describes a mod­ule called <span class="my-code" decode="exclude">stacker-mod</span> (another arbi­trary name). Because we haven’t writ­ten our <span class="my-code" decode="exclude">stacker</span> expander yet, we’ll tem­porar­ily use the <span class="my-code" decode="exclude">br</span> expander (mean­ing, this mod­ule will be inter­preted as source writ­ten in the <span class="my-code" decode="exclude">br</span> lan­guage).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aoQA3&quot;)"></div><p id="a_aoQA3">We qua­si­quote our mod­ule datum using <span class="my-code" decode="exclude">`</span> so we can use <span class="my-code" decode="exclude">,@</span> inside to splice our <span class="my-code" decode="exclude">src-datums</span> into the body of the mod­ule. So if our <span class="my-code" decode="exclude">src-datums</span> were a list of three datums like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6UpzV&quot;)"></div><div class="highlight-container" id="a_6UpzV"><div id="code_74" form="false" decode="exclude" style="font-size:0;width:0;height:0">'((handle 42) (handle +) (handle 25))</div><div class="highlight" form="false" id="a_I0WJB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">((</span><span class="ss">handle</span> <span class="mi">42</span><span class="p">)</span> <span class="p">(</span><span class="ss">handle</span> <span class="ss">+</span><span class="p">)</span> <span class="p">(</span><span class="ss">handle</span> <span class="mi">25</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkI" data-clipboard-target="#code_74" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Lpn58&quot;)"></div><p id="a_Lpn58">After splic­ing, our mod­ule datum will look like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4YSWA&quot;)"></div><div class="highlight-container" id="a_4YSWA"><div id="code_75" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(module stacker-mod br<br/>  (handle 42)<br/>  (handle +)<br/>  (handle 25))</div><div class="highlight" form="false" id="a_DHX7s"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="ss">br</span>
  <span class="p">(</span><span class="ss">handle</span> <span class="mi">42</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">handle</span> <span class="ss">+</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">handle</span> <span class="mi">25</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkJ" data-clipboard-target="#code_75" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YYk7m&quot;)"></div><p id="a_YYk7m">We move on to the last line of our func­tion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_twRsC&quot;)"></div><div class="highlight-container" id="a_twRsC"><div id="code_76" form="false" decode="exclude" style="font-size:0;width:0;height:0">(datum-&gt;syntax #f module-datum)</div><div class="highlight" form="false" id="a_qN0TV"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkK" data-clipboard-target="#code_76" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dIfKA&quot;)"></div><p id="a_dIfKA">As before, we fin­ish by con­vert­ing our datum to a syn­tax object using <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a>, pass­ing <span class="my-code" decode="exclude">#f</span> as the con­text argu­ment.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aSnrR&quot;)"></div><p id="a_aSnrR">Finally, we <span class="my-code" decode="exclude">(provide read-syntax)</span> so the func­tion is avail­able out­side this source file.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-reader&quot;)"></div><h3 anchor="testing-our-reader" class="subhead" id="testing-our-reader"><a href="#testing-our-reader">Test­ing our reader</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2fkBO&quot;)"></div><p id="a_2fkBO">Let’s make sure our updated reader works the way we hope, by test­ing it with some dummy val­ues. Save <span class="my-code" decode="exclude">"stacker.rkt"</span>. Update <span class="my-code" decode="exclude">"stacker-test.rkt"</span> as fol­lows:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jqyvt&quot;)"></div><div class="highlight-container" id="a_jqyvt"><div id="code_77" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>42<br/>"Hello world"<br/>#t</div><div class="highlight" form="false" id="a_7KLSb"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="mi">42</span>
<span class="s2">"Hello world"</span>
<span class="no">#t</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkL" data-clipboard-target="#code_77" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oCfQa&quot;)"></div><p id="a_oCfQa">Don’t worry that this code isn’t a valid <span class="my-code" decode="exclude">stacker</span> pro­gram. Our reader doesn’t know any­thing about the mean­ing of <span class="my-code" decode="exclude">stacker</span> code, so it should work with any argu­ments. We might as well try it with a num­ber, a string, and a boolean.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Z3LVg&quot;)"></div><p id="a_Z3LVg">Run this file in DrRacket. What hap­pens? You should get an error that looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8XrS7&quot;)"></div><div class="highlight-container err" id="a_8XrS7"><div id="code_78" form="false" decode="exclude" style="font-size:0;width:0;height:0">handle: unbound identifier in module in: handle</div><div class="highlight" form="false" id="a_X3dui"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>handle: unbound identifier in module in: handle
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkM" data-clipboard-target="#code_78" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Zkcgd&quot;)"></div><p id="a_Zkcgd">This looks like bad news. But it tells us some­thing use­ful. Our code is try­ing to call the <span class="my-code" decode="exclude">handle</span> func­tion (which is what we wanted). But it’s not suc­ceed­ing, because <span class="my-code" decode="exclude">handle</span> doesn’t exist yet. We’ll fix that shortly.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0jZUO&quot;)"></div><p id="a_0jZUO">In the mean­time, how can we check the out­put of <span class="my-code" decode="exclude">read-syntax</span>? For debug­ging pur­poses, we can put in a tem­po­rary shim. We add a sec­ond <span class="my-code" decode="exclude">'</span> pre­fix to our for­mat string in <span class="my-code" decode="exclude">format-datums</span>, like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JP5dA&quot;)"></div><div class="highlight-container" id="a_JP5dA"><div id="code_79" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums ''(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod br<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_EC3zqN"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
<span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
</span>  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="ss">br</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkO" data-clipboard-target="#code_79" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jO6GZ&quot;)"></div><p id="a_jO6GZ">What will hap­pen now? Before we run <span class="my-code" decode="exclude">"stacker-test.rkt"</span> again, let’s think through this change. Recall that when our syn­tax object from <span class="my-code" decode="exclude">read-syntax</span> is moved into place, Racket unquotes it so that it can be eval­u­ated as code. By adding a sec­ond level of quot­ing, how­ever, we’re pro­tect­ing our <span class="my-code" decode="exclude">src-datums</span> from turn­ing into code. Once they’re unquoted, they’ll still have a layer of quot­ing. They’ll still behave as data, and they’ll be printed out as usual.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lLIwe&quot;)"></div><p id="a_lLIwe">Let’s run <span class="my-code" decode="exclude">"stacker-test.rkt"</span> and see if this idea works:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sgJ2Q&quot;)"></div><div class="highlight-container" id="a_sgJ2Q"><div id="code_80" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(handle)<br/>'(handle 42)<br/>'(handle "Hello world")<br/>'(handle #t)</div><div class="highlight" form="false" id="a_WIgnl"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>&#39;(handle)
&#39;(handle 42)
&#39;(handle "Hello world")
&#39;(handle #t)
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkP" data-clipboard-target="#code_80" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hu9UV&quot;)"></div><p id="a_hu9UV">This looks mostly right: each argu­ment in <span class="my-code" decode="exclude">"stacker-test.rkt"</span>—<span class="my-code" decode="exclude">42</span>, <span class="my-code" decode="exclude">"Hello world"</span>, and <span class="my-code" decode="exclude">#t</span>—has been wrapped as a paren­the­sized <span class="my-code" decode="exclude">handle</span> form. Because of the extra level of quot­ing, each of these forms is printed as a datum.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Nk3pO&quot;)"></div><p id="a_Nk3pO">But that <span class="my-code" decode="exclude">'(handle)</span> at the top—where did that come from? Remem­ber that <em>every­thing</em> in the source file gets passed to <span class="my-code" decode="exclude">read-syntax</span>. That includes the new­line between the end of the <span class="my-code" decode="exclude">#lang</span> line and the first line with <span class="my-code" decode="exclude">42</span>. For instance, update <span class="my-code" decode="exclude">"stacker-test.rkt"</span> like this and run it again:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AuP6M&quot;)"></div><div class="highlight-container" id="a_AuP6M"><div id="code_81" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>42<br/><br/>"Hello world"<br/><br/>#t</div><div class="highlight" form="false" id="a_YPj2D"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="mi">42</span>

<span class="s2">"Hello world"</span>

<span class="no">#t</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkQ" data-clipboard-target="#code_81" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PLc4v&quot;)"></div><p id="a_PLc4v">Every line, includ­ing the blank lines, will be con­verted to <span class="my-code" decode="exclude">handle</span> form:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FmAeW&quot;)"></div><div class="highlight-container" id="a_FmAeW"><div id="code_82" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(handle)<br/>'(handle 42)<br/>'(handle)<br/>'(handle "Hello world")<br/>'(handle)<br/>'(handle #t)</div><div class="highlight" form="false" id="a_6cBtC"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>&#39;(handle)
&#39;(handle 42)
&#39;(handle)
&#39;(handle "Hello world")
&#39;(handle)
&#39;(handle #t)
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkR" data-clipboard-target="#code_82" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7gkgG&quot;)"></div><p id="a_7gkgG">It’s pos­si­ble to fil­ter out mean­ing­less source code before we make the mod­ule expres­sion—but we’ll save that tech­nique <a href="../bf/index.html">for later</a>. Here in <span class="my-code" decode="exclude">stacker</span>, we’ll just notice that blank lines will still gen­er­ate calls to <span class="my-code" decode="exclude">handle</span>. So when we write <span class="my-code" decode="exclude">handle</span>, we should deal with them prop­erly.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4649a&quot;)"></div><p id="a_4649a">To fin­ish our test, let’s change <span class="my-code" decode="exclude">"stacker-test.rkt"</span> to use the input from our orig­i­nal sam­ple pro­gram:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2QKGB&quot;)"></div><div class="highlight-container" id="a_2QKGB"><div id="code_83" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_bROJh"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkS" data-clipboard-target="#code_83" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YOovP&quot;)"></div><p id="a_YOovP">When we run this, we get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0QtAl&quot;)"></div><div class="highlight-container" id="a_0QtAl"><div id="code_84" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(handle)<br/>'(handle 4)<br/>'(handle 8)<br/>'(handle +)<br/>'(handle 3)<br/>'(handle *)</div><div class="highlight" form="false" id="a_sHZIk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span><span class="p">)</span>
<span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="mi">4</span><span class="p">)</span>
<span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="mi">8</span><span class="p">)</span>
<span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">+</span><span class="p">)</span>
<span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="mi">3</span><span class="p">)</span>
<span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">*</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkT" data-clipboard-target="#code_84" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Iq1Kc&quot;)"></div><p id="a_Iq1Kc">Except for the quotes—which are there tem­porar­ily for debug­ging, and won’t exist on the real code—that’s exactly right.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xflKG&quot;)"></div><p id="a_xflKG">We’re almost ready to move on. Let’s fin­ish our reader by mak­ing two changes to <span class="my-code" decode="exclude">read-syntax</span>. First, since we’re done debug­ging, let’s remove the extra <span class="my-code" decode="exclude">'</span> pre­fix from the for­mat string in <span class="my-code" decode="exclude">format-datums</span>. Sec­ond, let’s change our mod­ule datum so that instead of invok­ing <span class="my-code" decode="exclude">br</span> as the expander, it will use <span class="my-code" decode="exclude">"stacker.rkt"</span>. So the fin­ished func­tion looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kPFWR&quot;)"></div><div class="highlight-container" id="a_kPFWR"><div id="code_85" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_Q5CBU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
<span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
</span>                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkU" data-clipboard-target="#code_85" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_of684&quot;)"></div><p id="a_of684">Of course, <span class="my-code" decode="exclude">"stacker.rkt"</span> doesn’t have an expander yet. We’ll add that next.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="why-make-languages.html">2&emsp;why make lan­guages</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a class="here" href="the-reader.html">4&emsp;the reader</a></li><li><a href="the-expander.html">5&emsp;the expander</a></li><li><a href="recap.html">6&emsp;recap</a></li><li><a href="source-listing.html">7&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="setup.html">← prev</a>
    <a class="nav-right" href="the-expander.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>