<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/stacker/the-expander.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:14 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Make a language in one hour: stacker</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;make-a-language-in-one-hour-stacker&quot;)"></div><h1 anchor="make-a-language-in-one-hour-stacker" id="make-a-language-in-one-hour-stacker" hyphens="none">Make a language in one hour: <span class="my-code" decode="exclude">stacker</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="why-make-languages.html">2&emsp;why make lan­guages</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a href="the-reader.html">4&emsp;the reader</a></li><li><a class="here" href="the-expander.html">5&emsp;the expander</a></li><li><a href="recap.html">6&emsp;recap</a></li><li><a href="source-listing.html">7&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;the-expander&quot;)"></div><h3 anchor="the-expander" class="subhead" id="the-expander"><a href="#the-expander">The expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yJOZx&quot;)"></div><p id="a_yJOZx">To recap—every lan­guage in Racket has two essen­tial com­po­nents:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XCNa0&quot;)"></div><p id="a_XCNa0">A <em><a class="glossary" href="../appendix/glossary.html#reader"><span class="glossary-link-text">reader</span></a></em>, which con­verts source code from a string of char­ac­ters into paren­the­sized S-expres­sions.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ajqOv&quot;)"></div><p id="a_ajqOv">An <em><a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a></em>, which deter­mines how these S-expres­sions cor­re­spond to real Racket expres­sions, which are then eval­u­ated to pro­duce a result.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7DJCh&quot;)"></div><p id="a_7DJCh">We’re done with our reader. Now we’ll make our expander.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vC74y&quot;)"></div><p id="a_vC74y">First, why is it called an <em>expander</em>? Recall that our reader con­sisted of a <span class="my-code" decode="exclude">read-syntax</span> func­tion that sur­rounded each line of the source file with <span class="my-code" decode="exclude">(handle ...)</span>, in essence “expand­ing” it. The expander will per­form a sim­i­lar process on the rest of the code, with the help of <em><a class="glossary" href="../appendix/glossary.html#macro"><span class="glossary-link-text">macros</span></a></em>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;introducing-macros&quot;)"></div><h3 anchor="introducing-macros" class="subhead" id="introducing-macros"><a href="#introducing-macros">Intro­duc­ing macros</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8JsqJ&quot;)"></div><p id="a_8JsqJ">It turns out that a lot of things in Racket that look like nor­mal func­tions are actu­ally copy­ing &amp; rewrit­ing code when the pro­gram is com­piled (an event we’ll call <em><a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a></em>) rather than being invoked when the pro­gram is eval­u­ated (an event we’ll call <em><a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a></em>). Sup­pose we use <span class="my-code" decode="exclude">and</span> within a pro­gram like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_s6Kw8&quot;)"></div><div class="highlight-container" id="a_s6Kw8"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">(and cond-a cond-b cond-c)</div><div class="highlight" form="false" id="a_ATzRT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="n">cond-a</span> <span class="n">cond-b</span> <span class="n">cond-c</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VVEUl&quot;)"></div><p id="a_VVEUl">From afar, <span class="my-code" decode="exclude">and</span> looks like a func­tion. But it’s not. Rather, at com­pile time, this use of <span class="my-code" decode="exclude">and</span> gets expanded—that is, rewrit­ten—so it looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_101iL&quot;)"></div><div class="highlight-container" id="a_101iL"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">(if cond-a<br/>    (if cond-b<br/>        cond-c<br/>        #f)<br/>    #f)</div><div class="highlight" form="false" id="a_219w7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="n">cond-a</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="n">cond-b</span>
        <span class="n">cond-c</span>
        <span class="no">#f</span><span class="p">)</span>
    <span class="no">#f</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iVoRa&quot;)"></div><p id="a_iVoRa">This is the code that actu­ally gets eval­u­ated at run time. Let’s not be alarmed. These nested <a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a> con­di­tion­als mean the same thing as our orig­i­nal <span class="my-code" decode="exclude">and</span>. The expander has sim­ply rewrit­ten the <span class="my-code" decode="exclude">and</span> expres­sion as the equiv­a­lent nested <span class="my-code" decode="exclude">if</span> expres­sions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_51aJ2&quot;)"></div><p id="a_51aJ2">Within Racket, <span class="my-code" decode="exclude">and</span> belongs to a spe­cial and impor­tant class of func­tions called <em><a class="glossary" href="../appendix/glossary.html#macro"><span class="glossary-link-text">macros</span></a></em>. Macros have a restricted inter­face: they take cer­tain code as input (pack­aged as a <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a>), and return other code as out­put (also as a syn­tax object). Thus, macros are some­times known more pre­cisely as <em><a class="glossary" href="../appendix/glossary.html#syntax-transformer"><span class="glossary-link-text">syn­tax trans­form­ers</span></a></em>. We can think of them as a sophis­ti­cated form of search-and-replace—they’re like reg­u­lar expres­sions designed to work on code frag­ments, rather than strings.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_u97sj&quot;)"></div><p id="a_u97sj">Strictly speak­ing, macros are func­tions, but it’s con­ven­tional in Racket to call them <em>macros</em>, and reserve the term <em>func­tion</em> for a pro­ce­dure that’s eval­u­ated at run time. So if we talk about “con­vert­ing a func­tion into a macro,” that’s the intended con­trast.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vFIrr&quot;)"></div><p id="a_vFIrr">Macros are also known, espe­cially within the <a href="http://docs.racket-lang.org/reference/syntax.html">Racket doc­u­men­ta­tion</a>, as <em><a class="glossary" href="../appendix/glossary.html#syntactic-form"><span class="glossary-link-text">syn­tac­tic forms</span></a></em> or just <em><a class="glossary" href="../appendix/glossary.html#form"><span class="glossary-link-text">forms</span></a></em>—a nice term, because it empha­sizes that a macro doesn’t eval­u­ate the code it gets as input. Rather, it imple­ments a tem­plate for putting items into cer­tain posi­tions, like fill­ing in the blanks of a form. We could, for instance, use the <span class="my-code" decode="exclude">and</span> form like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qXowa&quot;)"></div><div class="highlight-container" id="a_qXowa"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">(and (error 'boom) (error 'bam) (error 'pow))</div><div class="highlight" form="false" id="a_1Va48"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">boom</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">bam</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">pow</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kvii4&quot;)"></div><p id="a_kvii4">If <span class="my-code" decode="exclude">and</span> were a func­tion, these argu­ments would be eval­u­ated first, and the pro­gram would end with <span class="my-code wrappable" decode="exclude">error: boom</span> before the argu­ments were ever passed to <span class="my-code" decode="exclude">and</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4FP7N&quot;)"></div><p id="a_4FP7N">But because <span class="my-code" decode="exclude">and</span> is a macro, it hap­pily rewrites our code as usual:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fMyVD&quot;)"></div><div class="highlight-container" id="a_fMyVD"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">(if (error 'boom)<br/>    (if (error 'bam)<br/>        (error 'pow)<br/>        #f)<br/>    #f)</div><div class="highlight" form="false" id="a_3o2Ap"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">boom</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">bam</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">pow</span><span class="p">)</span>
        <span class="no">#f</span><span class="p">)</span>
    <span class="no">#f</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uOOcr&quot;)"></div><p id="a_uOOcr">When this new code runs, we still get an error, of course. But the <span class="my-code" decode="exclude">and</span> macro was able to com­plete its work any­how. This brings us to the three golden rules of macros:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_He8be&quot;)"></div><p id="a_He8be">At com­pile time, a macro takes one code frag­ment as input, and con­verts it to a new code frag­ment. The input &amp; out­put code frag­ments are each pack­aged inside a syn­tax object.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qGI41&quot;)"></div><p id="a_qGI41">Because com­pile time hap­pens before run time, all macros oper­ate before any run-time func­tions.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fPjz3&quot;)"></div><p id="a_fPjz3">A macro can only treat its input code as a lit­eral syn­tac­tic entity. It can’t eval­u­ate argu­ments or expres­sions within that code, because those val­ues are only avail­able at run time (which hap­pens after com­pile time).</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DVvKM&quot;)"></div><p id="a_DVvKM">Under this def­i­n­i­tion, our <span class="my-code" decode="exclude">read-syntax</span> func­tion doesn’t qual­ify as a macro. It didn’t take a syn­tax object as input—rather, it took two input argu­ments (a path and an input port) and made a syn­tax object from that.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dvKeZ&quot;)"></div><p id="a_dvKeZ">Because macros run at com­pile time and have a restricted inter­face, they’re not as ver­sa­tile as ordi­nary func­tions. For this rea­son, a macro is not the tool of first resort. Still, macros are use­ful &amp; impor­tant because they can do things that ordi­nary func­tions can­not.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_F85uN&quot;)"></div><p id="a_F85uN">As we’ll see, the linch­pin of our expander will be a macro.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;before-we-enter-the-hall-of-the-macro-king&quot;)"></div><h3 anchor="before-we-enter-the-hall-of-the-macro-king" class="subhead" id="before-we-enter-the-hall-of-the-macro-king"><a href="#before-we-enter-the-hall-of-the-macro-king">Before we enter the hall of the macro king</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yhrC2&quot;)"></div><p id="a_yhrC2">Racket’s macro sys­tem is its crown jewel. Refined for nearly 20 years, it’s a work of great sci­ence and beauty. It’s also fun­da­men­tal to how Racket mod­els the imple­men­ta­tion of lan­guages. There­fore, any­one who wants to make lan­guages with Racket has to be will­ing to learn a few things about macros.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PLDAt&quot;)"></div><p id="a_PLDAt">That said, though the macro sys­tem is always reward­ing, it’s not always easy. For most pro­gram­mers, these are new &amp; unfa­mil­iar con­cepts. Don’t panic. These ideas aren’t eso­teric or com­pli­cated. They just intro­duce a new way of think­ing about pro­gram code. Most of us haven’t thought about code this way because we haven’t worked with lan­guages with an ele­gant macro sys­tem like Racket’s.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;what-does-the-expander-do&quot;)"></div><h3 anchor="what-does-the-expander-do" class="subhead" id="what-does-the-expander-do"><a href="#what-does-the-expander-do">What does the expander do?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0v2Gp&quot;)"></div><p id="a_0v2Gp">If the reader was respon­si­ble for the <em>form</em> of the code, we could say the expander is respon­si­ble for its <em>mean­ing</em>. The expander’s job is to pre­pare the code so Racket can eval­u­ate it.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mxPsK&quot;)"></div><p id="a_mxPsK">Pre­pare it how? The code can be <a href="../explainer/evaluation.html">eval­u­ated</a> only if every name used in the code has a con­nec­tion to an actual value or func­tion. In Racket, a “name used in the code” is called an <em><a class="glossary" href="../appendix/glossary.html#identifier"><span class="glossary-link-text">iden­ti­fier</span></a></em>. “A con­nec­tion to an actual value or func­tion” is called a <em><a class="glossary" href="../appendix/glossary.html#binding"><span class="glossary-link-text">bind­ing</span></a></em>. So we’d say that the expander pre­pares the code for eval­u­a­tion by ensur­ing that <strong>every iden­ti­fier has a bind­ing</strong>. Once an iden­ti­fier has a bind­ing, it becomes a <em><a class="glossary" href="../appendix/glossary.html#variable"><span class="glossary-link-text">vari­able</span></a></em>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_X6SGq&quot;)"></div><p id="a_X6SGq">We already came across the ideas of iden­ti­fiers and bind­ings when we tested our <span class="my-code" decode="exclude">stacker</span> reader <a href="the-reader.html#testing-our-reader">with­out an expander</a>. Recall that we got this error:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jQehB&quot;)"></div><div class="highlight-container err" id="a_jQehB"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">handle: unbound identifier in module</div><div class="highlight" form="false" id="a_JYHBQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>handle: unbound identifier in module
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UCwnL&quot;)"></div><p id="a_UCwnL">Now we know what it means. The code from the reader referred to a <span class="my-code" decode="exclude">handle</span> iden­ti­fier, e.g.:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WGsRz&quot;)"></div><div class="highlight-container" id="a_WGsRz"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(handle 4)</div><div class="highlight" form="false" id="a_PcPKQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">handle</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pv9rP&quot;)"></div><p id="a_pv9rP">This expres­sion means “call <span class="my-code" decode="exclude">handle</span> with the argu­ment <span class="my-code" decode="exclude">4</span>.” But the expander hadn’t given <span class="my-code" decode="exclude">handle</span> a bind­ing. Thus we got the “unbound iden­ti­fier” error.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5UJOD&quot;)"></div><p id="a_5UJOD">Within the expander, we have three basic tech­niques for adding bind­ings to code:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NQEcZ&quot;)"></div><p id="a_NQEcZ">We can <em>define macros</em> that rewrite cer­tain code as other code at com­pile time (for instance, <span class="my-code" decode="exclude">and</span>).</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TNXxS&quot;)"></div><p id="a_TNXxS">We can <em>define func­tions</em> that are invoked at run time.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_noPX9&quot;)"></div><p id="a_noPX9">We can <em>import bind­ings</em> from exist­ing Racket mod­ules, which can include both macros and func­tions.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bDlM9&quot;)"></div><p id="a_bDlM9">We’ll use all three tech­niques in our <span class="my-code" decode="exclude">stacker</span> expander.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;designing-our-expander&quot;)"></div><h3 anchor="designing-our-expander" class="subhead" id="designing-our-expander"><a href="#designing-our-expander">Design­ing our expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1J5dq&quot;)"></div><p id="a_1J5dq">As we did <a href="the-reader.html#designing-our-reader">with our reader</a>, let’s pen­cil out what our expander needs to do.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_S8Pak&quot;)"></div><p id="a_S8Pak">In our case, the code we’re get­ting from the reader will look like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_luBfB&quot;)"></div><div class="highlight-container" id="a_luBfB"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">(handle)<br/>(handle 4)<br/>(handle 8)<br/>(handle +)<br/>(handle 3)<br/>(handle *)</div><div class="highlight" form="false" id="a_sHZIk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ChB4x&quot;)"></div><p id="a_ChB4x">From this sam­ple, we can set out the tasks for our expander:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pJcLn&quot;)"></div><p id="a_pJcLn">From the pro­to­type code above, we see we need to pro­vide bind­ings for three iden­ti­fiers: <span class="my-code" decode="exclude">handle</span>, which deter­mines what to do with each argu­ment; <span class="my-code" decode="exclude">+</span>, a stack oper­a­tor; and <span class="my-code" decode="exclude">*</span>, another stack oper­a­tor.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kpoXM&quot;)"></div><p id="a_kpoXM">We also need num­bers. But we get those for free—in Racket, num­bers can’t be iden­ti­fiers. They auto­mat­i­cally eval­u­ate to their numeric value. Sim­i­larly, paren­the­ses are always treated as delim­iters, and Racket already knows what to do with them.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_J8wpX&quot;)"></div><p id="a_J8wpX">Con­sis­tent with <a href="intro.html">the design of <span class="my-code" decode="exclude">stacker</span></a>, we also have to imple­ment a stack. The stack needs an inter­face for stor­ing, read­ing, and doing oper­a­tions on argu­ments. This inter­face will be used by <span class="my-code" decode="exclude">handle</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5gRvR&quot;)"></div><p id="a_5gRvR">Finally, our expander needs to pro­vide a spe­cial macro called <span class="my-code" decode="exclude">#%module-begin</span> to get every­thing started. We’ll dis­cuss that in the next sec­tion.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vFhbX&quot;)"></div><p id="a_vFhbX">Once we have these ele­ments in place, the <span class="my-code" decode="exclude">stacker</span> lan­guage will work.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;programming-our-expander-output&quot;)"></div><h3 anchor="programming-our-expander-output" class="subhead" id="programming-our-expander-output"><a href="#programming-our-expander-output">Pro­gram­ming our expander: out­put</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Z6gqY&quot;)"></div><p id="a_Z6gqY">Let’s think about the state of our code when the expander starts. The reader has just fin­ished its work—mean­ing <span class="my-code" decode="exclude">read-syntax</span> has returned code describ­ing a mod­ule expres­sion, pack­aged inside a syn­tax object. For exam­ple, if the <span class="my-code" decode="exclude">stacker</span> reader started with source code like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rBJI2&quot;)"></div><div class="highlight-container" id="a_rBJI2"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_iZYPf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>4
8
+
3
*
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hhnBw&quot;)"></div><p id="a_hhnBw">It would return the fol­low­ing mod­ule as a syn­tax object:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sYQ45&quot;)"></div><div class="highlight-container" id="a_sYQ45"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module stacker-mod "stacker.rkt"<br/>  (handle)<br/>  (handle 4)<br/>  (handle 8)<br/>  (handle +)<br/>  (handle 3)<br/>  (handle *))</div><div class="highlight" form="false" id="a_mdapk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
  <span class="p">(</span><span class="n">handle</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="mi">4</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="mi">8</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MVfLD&quot;)"></div><p id="a_MVfLD">This becomes the start­ing input for the expander.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hv3I2&quot;)"></div><p id="a_hv3I2">We saw that Racket starts the reader for a lan­guage by invok­ing a func­tion called, by con­ven­tion, <span class="my-code" decode="exclude">read-syntax</span>. Sim­i­larly, Racket starts the expander for a lan­guage by invok­ing a  macro called, by con­ven­tion, <a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a>. There­fore, every expander needs to export a <span class="my-code" decode="exclude">#%module-begin</span> macro.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KNpdz&quot;)"></div><p id="a_KNpdz">Racket con­verts the mod­ule expres­sion above into an invo­ca­tion of the <span class="my-code" decode="exclude">#%module-begin</span> macro by pass­ing it the code inside the mod­ule:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Bxvhw&quot;)"></div><div class="highlight-container" id="a_Bxvhw"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(#%module-begin<br/>  (handle)<br/>  (handle 4)<br/>  (handle 8)<br/>  (handle +)<br/>  (handle 3)<br/>  (handle *))</div><div class="highlight" form="false" id="a_XKDro"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
  <span class="p">(</span><span class="n">handle</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="mi">4</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="mi">8</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="mi">3</span><span class="p">)</span>
  <span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nRPis&quot;)"></div><p id="a_nRPis">Like any macro, <span class="my-code" decode="exclude">#%module-begin</span> will take this code as its input. And like any macro, <span class="my-code" decode="exclude">#%module-begin</span> will rewrite it as nec­es­sary and return the new code pack­aged as a syn­tax object. This new code will replace the whole <span class="my-code" decode="exclude">#%module-begin</span> expres­sion above, and expan­sion &amp; eval­u­a­tion will con­tinue from there.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZdfuN&quot;)"></div><p id="a_ZdfuN">Because every Racket lan­guage exports a <span class="my-code" decode="exclude">#%module-begin</span>, the most com­mon way to imple­ment the <span class="my-code" decode="exclude">#%module-begin</span> in a new lan­guage is as fol­lows:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IQxX7&quot;)"></div><p id="a_IQxX7">Han­dle any lan­guage-spe­cific pro­cess­ing of the code.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OpYOR&quot;)"></div><p id="a_OpYOR">Pass the result to an exist­ing <span class="my-code" decode="exclude">#%module-begin</span> for the rest of the heavy lift­ing. (Cau­tion: all the <span class="my-code" decode="exclude">#%module-begin</span> macros have the same name. There­fore, some care is needed to keep them straight.)</p></div></li></ol><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0rouq&quot;)"></div><p id="a_0rouq">Let’s <span class="my-code" decode="exclude">"stacker.rkt"</span> and update it like so:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lQu0V&quot;)"></div><div class="highlight-container" id="a_lQu0V"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_vG9aR"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
</span><span class="hll">     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lT1vi&quot;)"></div><p id="a_lT1vi">At the top, we see good old <span class="my-code" decode="exclude">read-syntax</span>, just as we left it.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5T6Rg&quot;)"></div><p id="a_5T6Rg">Below that, our def­i­n­i­tion of <span class="my-code" decode="exclude">#%module-begin</span>. Let’s step through each part.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_c7a5T&quot;)"></div><div class="highlight-container" id="a_c7a5T"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (stacker-module-begin HANDLE-EXPR ...)</div><div class="highlight" form="false" id="a_wFcwB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_v7tBV&quot;)"></div><p id="a_v7tBV">When we made our reader, we saw that an ordi­nary func­tion is defined with a list of input argu­ments. But because a macro gets a chunk of code, we typ­i­cally define a macro with a <em><a class="glossary" href="../appendix/glossary.html#syntax-pattern"><span class="glossary-link-text">syn­tax pat­tern</span></a></em> instead. A syn­tax pat­tern is like a reg­u­lar expres­sion: it breaks down the input into pieces so they can be manip­u­lated &amp; rearranged.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y9ECq&quot;)"></div><p id="a_Y9ECq">Our ordi­nary <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a> doesn’t sup­port syn­tax pat­terns in the first line. Instead, we use <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a>, which does. This first line says we’re defin­ing a macro called <span class="my-code" decode="exclude">stacker-module-begin</span>. <span class="my-code" decode="exclude">HANDLE-EXPR</span> is a <em><a class="glossary" href="../appendix/glossary.html#pattern-variable"><span class="glossary-link-text">pat­tern vari­able</span></a></em>—mean­ing, a named match within the syn­tax pat­tern. When used with an ellip­sis <span class="my-code" decode="exclude">...</span>, this pat­tern vari­able will match each line of the code passed to the macro. (We’ll defer the details till later, though the curi­ous can detour through <a class="explainer" href="../explainer/syntax-patterns.html">syn­tax pat­terns</a>.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JVDfF&quot;)"></div><p id="a_JVDfF">Then we have the return value of our macro:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iTtj3&quot;)"></div><div class="highlight-container" id="a_iTtj3"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">#'(#%module-begin<br/>   HANDLE-EXPR ...)</div><div class="highlight" form="false" id="a_bboja"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
   <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mxVpU&quot;)"></div><p id="a_mxVpU">Syn­tax objects in Racket are so com­mon that we have a few ways to make them. In our <span class="my-code" decode="exclude">read-syntax</span> we’re using  <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a> to make a syn­tax object from <span class="my-code" decode="exclude">module-datum</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KUY5T&quot;)"></div><p id="a_KUY5T">This time, we’re using some new nota­tion—the pre­fix <span class="my-code" decode="exclude">#'</span>—to make code into a syn­tax object. It’s sim­i­lar to the <span class="my-code" decode="exclude">'</span> pre­fix we’ve already used that makes code into a datum. But the <span class="my-code" decode="exclude">#'</span> pre­fix not only cre­ates the datum, but also cap­tures the cur­rent <em><a class="glossary" href="../appendix/glossary.html#lexical-context"><span class="glossary-link-text">lex­i­cal con­text</span></a></em>, and attaches that to the new syn­tax object. Lex­i­cal con­text is the fancy phrase for “a list of avail­able vari­ables”. In prac­tice, what it means is that a syn­tax object made with <span class="my-code" decode="exclude">#'</span> will be able to access all the vari­ables defined at that point in the code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4wJTN&quot;)"></div><p id="a_4wJTN">One of these is the <span class="my-code" decode="exclude">HANDLE-EXPR ...</span> pat­tern vari­able. Those lines of code will just be merged into the new syn­tax object.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PvDzd&quot;)"></div><p id="a_PvDzd">Another vari­able is <span class="my-code" decode="exclude">#%module-begin</span>. Recall that our plan is to take our input code and pass it to the next <span class="my-code" decode="exclude">#%module-begin</span> in the chain. When we go into DrRacket and put the cur­sor over the <span class="my-code" decode="exclude">#%module-begin</span>, we see a pur­ple arrow and a popup mes­sage that says <span class="my-code" decode="exclude">imported from "br/quicklang"</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpkd&quot;)"></div><div id="a_Vldpkd" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="binding.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_gzEZF&quot;)"></div><p id="a_gzEZF">We don’t need to explic­itly import this <span class="my-code" decode="exclude">#%module-begin</span>. It’s already avail­able because we’re using <span class="my-code" decode="exclude">br/quicklang</span>, so we impliedly have access to all its bind­ings, and it, like every lan­guage, pro­vides its own <span class="my-code" decode="exclude">#%module-begin</span>. (For that mat­ter, we could import one from a dif­fer­ent lan­guage, but for <span class="my-code" decode="exclude">stacker</span>, there’s no need.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BqYsG&quot;)"></div><p id="a_BqYsG">Finally we have to make <span class="my-code" decode="exclude">stacker-module-begin</span> avail­able out­side <span class="my-code" decode="exclude">stacker.rkt</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QUGqM&quot;)"></div><div class="highlight-container" id="a_QUGqM"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">(provide (rename-out [stacker-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_ZG0wL"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7m8kG&quot;)"></div><p id="a_7m8kG">As before, we use <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a>. But this time, we use the <span class="my-code" decode="exclude">rename-out</span> qual­i­fier so that <span class="my-code" decode="exclude">stacker-module-begin</span> is avail­able out­side this source file with the cor­rect <span class="my-code" decode="exclude">#%module-begin</span> name.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dkzrm&quot;)"></div><p id="a_dkzrm">Why didn’t we just name our macro <span class="my-code" decode="exclude">#%module-begin</span> at the start? Sup­pose we had writ­ten our macro like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0NBcx&quot;)"></div><div class="highlight-container" id="a_0NBcx"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (#%module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...))<br/>(provide #%module-begin)</div><div class="highlight" form="false" id="a_vNZnt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_d99Yh&quot;)"></div><p id="a_d99Yh">The prob­lem here is that we’d be cre­at­ing a nam­ing con­flict between two <span class="my-code" decode="exclude">#%module-begin</span> macros: the new one we’re defin­ing, and the one from <span class="my-code" decode="exclude">br/quicklang</span> that we’re hop­ing to rely on. This <span class="my-code" decode="exclude">#%module-begin</span> will just call itself, cre­at­ing an infi­nite loop. Thus, we give our new <span class="my-code" decode="exclude">#%module-begin</span> macro a tem­po­rary, non-con­flict­ing name, and change it as part of the <span class="my-code" decode="exclude">provide</span> expres­sion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-expander&quot;)"></div><h3 anchor="testing-our-expander" class="subhead" id="testing-our-expander"><a href="#testing-our-expander">Test­ing our expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7cD6L&quot;)"></div><p id="a_7cD6L">Let’s see if our sim­ple <span class="my-code" decode="exclude">#%module-begin</span> works. Here’s what <span class="my-code" decode="exclude">"stacker.rkt"</span> should look like:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lQu0Vi&quot;)"></div><div class="highlight-container" id="a_lQu0Vi"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_vG9aRg"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uuMWU&quot;)"></div><p id="a_uuMWU">Now run <span class="my-code" decode="exclude">"stacker-test.rkt"</span> (which is the same as ever):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2QKGB&quot;)"></div><div class="highlight-container" id="a_2QKGB"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_bROJh"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oskef&quot;)"></div><p id="a_oskef">We get an error:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jQehBm&quot;)"></div><div class="highlight-container err" id="a_jQehBm"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">handle: unbound identifier in module</div><div class="highlight" form="false" id="a_JYHBQk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>handle: unbound identifier in module
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fNmgu&quot;)"></div><p id="a_fNmgu">That’s the same error we got when we tried to run our pro­gram <a href="the-reader.html#testing-our-reader">with­out an expander</a>. But we haven’t got­ten around to defin­ing <span class="my-code" decode="exclude">handle</span> yet, so we shouldn’t be sur­prised that the error per­sists.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mssvE&quot;)"></div><p id="a_mssvE">Can we at least check that our macro is work­ing? Sure. Let’s reuse the short­cut we used to test the reader the first time: adding a <span class="my-code" decode="exclude">'</span> pre­fix to the out­put so it gets con­verted back into lit­eral code. This time, we add the <span class="my-code" decode="exclude">'</span> pre­fix to the <span class="my-code" decode="exclude">HANDLE-EXPR</span> inside our macro def­i­n­i­tion like so:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ejyld&quot;)"></div><div class="highlight-container" id="a_Ejyld"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     'HANDLE-EXPR ...))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_vG9aRn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
<span class="hll">     <span class="o">&#39;</span><span class="ss">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_T2KBZ&quot;)"></div><p id="a_T2KBZ">Now when we run <span class="my-code" decode="exclude">"stacker-test.rkt"</span>, we get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0QtAl&quot;)"></div><div class="highlight-container" id="a_0QtAl"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(handle)<br/>'(handle 4)<br/>'(handle 8)<br/>'(handle +)<br/>'(handle 3)<br/>'(handle *)</div><div class="highlight" form="false" id="a_sHZIkp"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>&#39;(handle)
&#39;(handle 4)
&#39;(handle 8)
&#39;(handle +)
&#39;(handle 3)
&#39;(handle *)
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5PQdZ&quot;)"></div><p id="a_5PQdZ">What we’re see­ing is our source code, con­verted into <span class="my-code" decode="exclude">(handle ···)</span> expres­sions by the <span class="my-code" decode="exclude">read-syntax</span> func­tion in our reader, then con­verted into datums by the <span class="my-code" decode="exclude">#%module-begin</span> macro in our expander, and then printed in the out­put win­dow of DrRacket.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_m0cp0&quot;)"></div><p id="a_m0cp0">That’s good news—we’ve ver­i­fied that we can make a round-trip from our source file, through our reader, through our expander, and back. We’re another step closer to hav­ing a work­ing lan­guage.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8JWZx&quot;)"></div><p id="a_8JWZx">Let’s remove the <span class="my-code" decode="exclude">'</span> pre­fix we just added to the front of <span class="my-code" decode="exclude">HANDLE-EXPR</span>, and move on.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;programming-our-expander-bindings&quot;)"></div><h3 anchor="programming-our-expander-bindings" class="subhead" id="programming-our-expander-bindings"><a href="#programming-our-expander-bindings">Pro­gram­ming our expander: bind­ings</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Iv8QY&quot;)"></div><p id="a_Iv8QY">When we <a href="#designing-our-expander">designed our expander</a>, we set out three tasks:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JotFQ&quot;)"></div><p id="a_JotFQ">Pro­vide the spe­cial <span class="my-code" decode="exclude">#%module-begin</span> macro.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_slGgW&quot;)"></div><p id="a_slGgW">Imple­ment a stack, with an inter­face for stor­ing, read­ing, and doing oper­a­tions on argu­ments, that can be used by <span class="my-code" decode="exclude">handle</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_M7xa5&quot;)"></div><p id="a_M7xa5">Pro­vide bind­ings for three iden­ti­fiers: <span class="my-code" decode="exclude">handle</span>, which deter­mines what to do with each argu­ment; <span class="my-code" decode="exclude">+</span>, a stack oper­a­tor; and <span class="my-code" decode="exclude">*</span>, another stack oper­a­tor.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ut4t9&quot;)"></div><p id="a_Ut4t9">We com­pleted the first task—we made <span class="my-code" decode="exclude">#%module-begin</span>. So now we need to work on the other two—imple­ment­ing a stack and cre­at­ing bind­ings for our iden­ti­fiers.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_llyjj&quot;)"></div><p id="a_llyjj">First the stack, which we imple­ment using Racket <a class="explainer" href="../explainer/lists.html">list</a> oper­a­tions:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_f4P05&quot;)"></div><div class="highlight-container" id="a_f4P05"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))<br/><br/>(define stack empty)<br/><br/>(define (pop-stack!)<br/>  (define arg (first stack))<br/>  (set! stack (rest stack))<br/>  arg)<br/><br/>(define (push-stack! arg)<br/>  (set! stack (cons arg stack)))</div><div class="highlight" form="false" id="a_nTQal"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stack</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack</span><span class="p">))</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" class="docs" hyphens="none">rest</a></span> <span class="n">stack</span><span class="p">))</span>
</span><span class="hll">  <span class="n">arg</span><span class="p">)</span>
</span><span class="hll">
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack</span><span class="p">)))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Wzv1f&quot;)"></div><p id="a_Wzv1f">Our <span class="my-code" decode="exclude">stack</span> starts out as the <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a> list.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_eYJju&quot;)"></div><p id="a_eYJju"><span class="my-code" decode="exclude">pop-stack!</span> removes the top argu­ment from the stack and returns it. We do this in three steps. We get the <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a> argu­ment from the stack and assign it to a tem­po­rary <span class="my-code" decode="exclude">arg</span> vari­able. Then we <span class="my-code" decode="exclude">set!</span> our <span class="my-code" decode="exclude">stack</span> equal to the <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" class="docs" hyphens="none">rest</a> of the argu­ments after the first. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">By con­ven­tion, Racket func­tions that update the value of a vari­able are named with a <span class="my-code" decode="exclude">!</span> at the end. For other nam­ing con­ven­tions, see <a class="explainer" href="../explainer/functions.html">func­tions</a>.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5JaGq&quot;)"></div><p id="a_5JaGq"><span class="my-code" decode="exclude">push-stack!</span> puts a new argu­ment on the stack. We do this with <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a>. <span class="my-code" decode="exclude">cons</span> is one of the old­est Lisp func­tions, get­ting its name from its role <em>con­struct­ing</em> a new item in mem­ory. (For more about <span class="my-code" decode="exclude">cons</span>, see <a class="explainer" href="../explainer/pairs.html">pairs</a>.) Every time we <span class="my-code" decode="exclude">cons</span> an item onto the list, we cre­ate a new list that’s one big­ger. After we push the argu­ment, we <span class="my-code" decode="exclude">set!</span> our <span class="my-code" decode="exclude">stack</span> equal to this new, larger stack.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HNhPL&quot;)"></div><p id="a_HNhPL">Now let’s add our long-awaited <span class="my-code" decode="exclude">handle</span> func­tion. Let’s remem­ber how <span class="my-code" decode="exclude">handle</span> is invoked in a <span class="my-code" decode="exclude">stacker</span> pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_luBfBu&quot;)"></div><div class="highlight-container" id="a_luBfBu"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">(handle)<br/>(handle 4)<br/>(handle 8)<br/>(handle +)<br/>(handle 3)<br/>(handle *)</div><div class="highlight" form="false" id="a_sHZIks"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">4</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="n">handle</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkt" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SUNWH&quot;)"></div><p id="a_SUNWH">We observe that it can have zero or one argu­ment. If it has an argu­ment, it’s either a num­ber or a stack oper­a­tor (either <span class="my-code" decode="exclude">+</span> or <span class="my-code" decode="exclude">*</span>). So let’s add the fol­low­ing <span class="my-code" decode="exclude">handle</span> func­tion:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_myuvL&quot;)"></div><div class="highlight-container" id="a_myuvL"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '(handle ~a) src-lines))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@src-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))<br/><br/>(define stack empty)<br/><br/>(define (pop-stack!)<br/>  (define arg (first stack))<br/>  (set! stack (rest stack))<br/>  arg)<br/><br/>(define (push-stack! arg)<br/>  (set! stack (cons arg stack)))<br/><br/>(define (handle [arg #f])<br/>  (cond<br/>    [(number? arg) (push-stack! arg)]<br/>    [(or (equal? + arg) (equal? * arg))<br/>     (define op-result (arg (pop-stack!) (pop-stack!)))<br/>     (push-stack! op-result)]))<br/>(provide handle)</div><div class="highlight" form="false" id="a_KcNhg"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">src-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stack</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" class="docs" hyphens="none">rest</a></span> <span class="n">stack</span><span class="p">))</span>
  <span class="n">arg</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack</span><span class="p">)))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle</span> <span class="p">[</span><span class="n">arg</span> <span class="no">#f</span><span class="p">])</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
</span><span class="hll">    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)]</span>
</span><span class="hll">    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">))</span>
</span><span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)))</span>
</span><span class="hll">     <span class="p">(</span><span class="n">push-stack!</span> <span class="n">op-result</span><span class="p">)]))</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">handle</span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkv" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SAUBT&quot;)"></div><p id="a_SAUBT">Then we step through each line:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ETeaP&quot;)"></div><div class="highlight-container" id="a_ETeaP"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (handle [arg #f])</div><div class="highlight" form="false" id="a_bIQfM"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle</span> <span class="p">[</span><span class="n">arg</span> <span class="no">#f</span><span class="p">])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkw" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CK9Um&quot;)"></div><p id="a_CK9Um">We <span class="my-code" decode="exclude">define</span> our <span class="my-code" decode="exclude">handle</span> func­tion to take one argu­ment, called <span class="my-code" decode="exclude">arg</span>. By declar­ing <span class="my-code" decode="exclude">arg</span> in brack­ets with a default value of <span class="my-code" decode="exclude">#f</span>, we make it an <em><a class="glossary" href="../appendix/glossary.html#optional-argument"><span class="glossary-link-text">optional argu­ment</span></a></em>. So if <span class="my-code" decode="exclude">handle</span> is called with an argu­ment, <span class="my-code" decode="exclude">arg</span> takes that value; if not, <span class="my-code" decode="exclude">arg</span> is set to <span class="my-code" decode="exclude">#f</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_I4HnM&quot;)"></div><div class="highlight-container" id="a_I4HnM"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">(cond<br/>    [(number? arg) (push-stack! arg)]</div><div class="highlight" form="false" id="a_eQpfH"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkx" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9Kzdu&quot;)"></div><p id="a_9Kzdu">This <a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a> intro­duces a con­di­tional expres­sion with two branches. The con­di­tion on the left side of a branch is tested. If the con­di­tion is true, the expres­sions on the right side of the branch are eval­u­ated. If the con­di­tion fails, we move to the next branch. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Fur­ther details in <a class="explainer" href="../explainer/booleans-and-conditionals.html">Booleans and con­di­tion­als</a>.</span></span> The first branch tests if <span class="my-code" decode="exclude">arg</span> is a <span class="my-code" decode="exclude">number?</span>. If so, we put it onto the stack with <span class="my-code" decode="exclude">push-stack!</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DNGX9&quot;)"></div><div class="highlight-container" id="a_DNGX9"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">[(or (equal? + arg) (equal? * arg))<br/>     (define op-result (arg (pop-stack!) (pop-stack!)))<br/>     (push-stack! op-result)]</div><div class="highlight" form="false" id="a_uHw4t"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)))</span>
     <span class="p">(</span><span class="n">push-stack!</span> <span class="n">op-result</span><span class="p">)]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_87haC&quot;)"></div><p id="a_87haC">In the sec­ond branch, we test if <span class="my-code" decode="exclude">arg</span> is <span class="my-code" decode="exclude">equal?</span> to one of our stack oper­a­tors. If so, we retrieve the first two ele­ments from the stack with two calls to <span class="my-code" decode="exclude">pop-stack!</span>. We apply <span class="my-code" decode="exclude">arg</span> to these val­ues by putting it in the func­tion posi­tion of a new expres­sion with the stack val­ues as argu­ments. We store the result in <span class="my-code" decode="exclude">op-result</span>. We then push <span class="my-code" decode="exclude">op-result</span> onto the stack.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BoCXm&quot;)"></div><p id="a_BoCXm">What if <span class="my-code" decode="exclude">handle</span> is called with no argu­ments, and <span class="my-code" decode="exclude">arg</span> is <span class="my-code" decode="exclude">#f</span>? We were always plan­ning to ignore that case. So we don’t need to add a branch to our <span class="my-code" decode="exclude">cond</span> expres­sion to deal with it. We just let it fall through. Like­wise, any other input that doesn’t meet one of our con­di­tions will be ignored.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wsCSO&quot;)"></div><div class="highlight-container" id="a_wsCSO"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">(provide handle)</div><div class="highlight" form="false" id="a_5rk4z"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">handle</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkz" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0jpEu&quot;)"></div><p id="a_0jpEu">Finally, we make <span class="my-code" decode="exclude">handle</span> avail­able out­side our source file with the usual <span class="my-code" decode="exclude">provide</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Cl7AJ&quot;)"></div><p id="a_Cl7AJ">We also need to pro­vide bind­ings for <span class="my-code" decode="exclude">+</span> and <span class="my-code" decode="exclude">*</span>. This is easy, because our <span class="my-code" decode="exclude">br/quicklang</span> lan­guage already defines these func­tions. We just need to bor­row these bind­ings for <span class="my-code" decode="exclude">stacker</span>. We can do that by adding one more <span class="my-code" decode="exclude">provide</span> to our source file:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NMxvX&quot;)"></div><div class="highlight-container" id="a_NMxvX"><div id="code_70" form="false" decode="exclude" style="font-size:0;width:0;height:0">(provide + *)</div><div class="highlight" form="false" id="a_6HZm9"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkA" data-clipboard-target="#code_70" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JNwqT&quot;)"></div><p id="a_JNwqT">Our <span class="my-code" decode="exclude">"stacker.rkt"</span> should now look like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oj8zD&quot;)"></div><div class="highlight-container" id="a_oj8zD"><div id="code_71" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define args (port-&gt;lines port))<br/>  (define handle-datums (format-datums '(handle ~a) args))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@handle-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))<br/><br/>(define stack empty)<br/><br/>(define (pop-stack!)<br/>  (define arg (first stack))<br/>  (set! stack (rest stack))<br/>  arg)<br/><br/>(define (push-stack! arg)<br/>  (set! stack (cons arg stack)))<br/><br/>(define (handle [arg #f])<br/>  (cond<br/>    [(number? arg) (push-stack! arg)]<br/>    [(or (equal? * arg) (equal? + arg))<br/>     (define op-result (arg (pop-stack!) (pop-stack!)))<br/>     (push-stack! op-result)]))<br/>(provide handle)<br/><br/>(provide + *)</div><div class="highlight" form="false" id="a_k5qcm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">args</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">handle-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">args</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">handle-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stack</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" class="docs" hyphens="none">rest</a></span> <span class="n">stack</span><span class="p">))</span>
  <span class="n">arg</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle</span> <span class="p">[</span><span class="n">arg</span> <span class="no">#f</span><span class="p">])</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)]</span>
    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)))</span>
     <span class="p">(</span><span class="n">push-stack!</span> <span class="n">op-result</span><span class="p">)]))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">handle</span><span class="p">)</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkB" data-clipboard-target="#code_71" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-expander-with-bindings&quot;)"></div><h3 anchor="testing-our-expander-with-bindings" class="subhead" id="testing-our-expander-with-bindings"><a href="#testing-our-expander-with-bindings">Test­ing our expander with bind­ings</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MyHmz&quot;)"></div><p id="a_MyHmz">We’re get­ting close. Let’s run our <span class="my-code" decode="exclude">"stacker-test.rkt"</span> file, which still looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2QKGBE&quot;)"></div><div class="highlight-container" id="a_2QKGBE"><div id="code_72" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "stacker.rkt"<br/>4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_bROJhC"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"stacker.rkt"</span>
<span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkD" data-clipboard-target="#code_72" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8dCH1&quot;)"></div><p id="a_8dCH1">The good news—no errors.<br/>The bad news—no pro­gram result, either.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CZdbD&quot;)"></div><p id="a_CZdbD">This is a sim­ple fix. The result of our pro­gram is what­ever value is sit­ting on top of the stack at the end. So we add one line to our <span class="my-code" decode="exclude">stacker-module-begin</span>, to <a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a> the <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a> ele­ment of our <span class="my-code" decode="exclude">stack</span> after all the <span class="my-code" decode="exclude">HANDLE-EXPR</span> lines have been eval­u­ated:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">stacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_34fK5&quot;)"></div><div class="highlight-container" id="a_34fK5"><div id="code_73" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define args (port-&gt;lines port))<br/>  (define handle-datums (format-datums '(handle ~a) args))<br/>  (define module-datum `(module stacker-mod "stacker.rkt"<br/>                          ,@handle-datums))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (stacker-module-begin HANDLE-EXPR ...)<br/>  #'(#%module-begin<br/>     HANDLE-EXPR ...<br/>     (display (first stack))))<br/>(provide (rename-out [stacker-module-begin #%module-begin]))<br/><br/>(define stack empty)<br/><br/>(define (pop-stack!)<br/>  (define arg (first stack))<br/>  (set! stack (rest stack))<br/>  arg)<br/><br/>(define (push-stack! arg)<br/>  (set! stack (cons arg stack)))<br/><br/>(define (handle [arg #f])<br/>  (cond<br/>    [(number? arg) (push-stack! arg)]<br/>    [(or (equal? * arg) (equal? + arg))<br/>     (define op-result (arg (pop-stack!) (pop-stack!))) <br/>     (push-stack! op-result)]))<br/>(provide handle)<br/><br/>(provide + *)
</div><div class="highlight" form="false" id="a_vDdDP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">args</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">handle-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">handle</span> <span class="ss">~a</span><span class="p">)</span> <span class="n">args</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">stacker-mod</span> <span class="s2">"stacker.rkt"</span>
                          <span class="o">,@</span><span class="n">handle-datums</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">stacker-module-begin</span> <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="n">HANDLE-EXPR</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
<span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack</span><span class="p">))))</span>
</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">stacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stack</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._rest))" class="docs" hyphens="none">rest</a></span> <span class="n">stack</span><span class="p">))</span>
  <span class="n">arg</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">stack</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle</span> <span class="p">[</span><span class="n">arg</span> <span class="no">#f</span><span class="p">])</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="n">push-stack!</span> <span class="n">arg</span><span class="p">)]</span>
    <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">))</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)</span> <span class="p">(</span><span class="n">pop-stack!</span><span class="p">)))</span> 
     <span class="p">(</span><span class="n">push-stack!</span> <span class="n">op-result</span><span class="p">)]))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">handle</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkF" data-clipboard-target="#code_73" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AhgmL&quot;)"></div><p id="a_AhgmL">If we run <span class="my-code" decode="exclude">"stacker-test.rkt"</span> one more time, we get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mw772&quot;)"></div><div class="highlight-container" id="a_mw772"><div id="code_74" form="false" decode="exclude" style="font-size:0;width:0;height:0">36</div><div class="highlight" form="false" id="a_2jsOx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="mi">36</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkG" data-clipboard-target="#code_74" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_W6CKw&quot;)"></div><p id="a_W6CKw">That’s it—we’ve made our first pro­gram­ming lan­guage.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="why-make-languages.html">2&emsp;why make lan­guages</a></li><li><a href="setup.html">3&emsp;setup</a></li><li><a href="the-reader.html">4&emsp;the reader</a></li><li><a class="here" href="the-expander.html">5&emsp;the expander</a></li><li><a href="recap.html">6&emsp;recap</a></li><li><a href="source-listing.html">7&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="the-reader.html">← prev</a>
    <a class="nav-right" href="recap.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>