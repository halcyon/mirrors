<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/basic-3/command-line-arguments.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:48:14 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Closing the loop: basic</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;closing-the-loop-basic&quot;)"></div><h1 anchor="closing-the-loop-basic" id="closing-the-loop-basic" hyphens="none">Closing the loop: <span class="my-code" decode="exclude">basic</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="functions.html">3&emsp;func­tions</a></li><li><a href="imports.html">4&emsp;imports</a></li><li><a href="exports.html">5&emsp;exports</a></li><li><a href="the-repl.html">6&emsp;the repl</a></li><li><a class="here" href="command-line-arguments.html">7&emsp;com­mand-line argu­ments</a></li><li><a href="recap.html">8&emsp;recap</a></li><li><a href="source-listing.html">9&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wtJlD&quot;)"></div><p id="a_wtJlD">We’ll end this tuto­r­ial by adding sup­port for com­mand-line argu­ments. Let’s be clear: no one will ever write a shell script in BASIC. But it’ll give us a look at how Racket han­dles com­mand-line argu­ments. We’ll also learn a few things about macro <a class="explainer" href="../explainer/hygiene.html">hygiene</a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9A8qw&quot;)"></div><p id="a_9A8qw">Best of all, we only have to update one mod­ule. Really.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;command-line-arguments&quot;)"></div><h3 anchor="command-line-arguments" class="subhead" id="command-line-arguments"><a href="#command-line-arguments">Com­mand-line argu­ments</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0zVQC&quot;)"></div><p id="a_0zVQC">In <a href="exports.html">exports</a>, we learned about the <a class="glossary" href="../appendix/glossary.html#parameter"><span class="glossary-link-text">para­me­ter</span></a> called <a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._current-output-port))" class="docs" hyphens="none">current-output-port</a>, which con­trols where printed out­put goes; in <a href="the-repl.html">the REPL</a>, we learned about the <a href="http://docs.racket-lang.org/reference/eval.html#(def._((quote._~23~25kernel)._current-read-interaction))" class="docs" hyphens="none">current-read-interaction</a> para­me­ter that con­trols how the REPL parses its input.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oJu3F&quot;)"></div><p id="a_oJu3F">Sim­i­larly, Racket makes its com­mand-line argu­ments avail­able through a para­me­ter called <a href="http://docs.racket-lang.org/reference/runtime.html#(def._((quote._~23~25kernel)._current-command-line-arguments))" class="docs" hyphens="none">current-command-line-arguments</a>, which holds a <a class="glossary" href="../appendix/glossary.html#vector"><span class="glossary-link-text">vec­tor</span></a> con­tain­ing the com­mand line argu­ments that were passed dur­ing the cur­rent ses­sion. For instance, let’s make a new <span class="my-code" decode="exclude">"args.rkt"</span> mod­ule:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/args.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_woFYB&quot;)"></div><div class="highlight-container" id="a_woFYB"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(current-command-line-arguments)</div><div class="highlight" form="false" id="a_zoH62"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/runtime.html#(def._((quote._~23~25kernel)._current-command-line-arguments))" class="docs" hyphens="none">current-command-line-arguments</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nKE6A&quot;)"></div><p id="a_nKE6A">If we run this file in DrRacket, the vec­tor of com­mand-line argu­ments is empty—as we’d expect, since we’re not run­ning it from the com­mand line:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y4hlx&quot;)"></div><div class="highlight-container" id="a_Y4hlx"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">'#()</div><div class="highlight" form="false" id="a_bXMWJ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&#39;#()
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_84SW9&quot;)"></div><p id="a_84SW9">But if we go to the com­mand line, we can ask <span class="my-code" decode="exclude">racket</span> to start with a cer­tain mod­ule by using the <span class="my-code" decode="exclude">-l</span> flag and the mod­ule name. Sub­se­quent argu­ments are treated as com­mand-line argu­ments for that mod­ule:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bqi0a&quot;)"></div><div class="highlight-container" id="a_bqi0a"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; racket -l basic/args "foo" 42 --bar "zam"</div><div class="highlight" form="false" id="a_3j9Rl"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; racket -l basic/args "foo" 42 --bar "zam"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2RtnH&quot;)"></div><p id="a_2RtnH">This time, <span class="my-code" decode="exclude">"args.rkt"</span> prints the com­mand-line argu­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_g49dr&quot;)"></div><div class="highlight-container" id="a_g49dr"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">'#("foo" "42" "--bar" "zam")</div><div class="highlight" form="false" id="a_psChd"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&#39;#("foo" "42" "--bar" "zam")
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rqkEN&quot;)"></div><p id="a_rqkEN">Beyond that, what we do with these argu­ments is up to us. Racket’s <a href="http://docs.racket-lang.org/reference/Command-Line_Parsing.html?q=command-line#%28form._%28%28lib._racket%2Fcmdline..rkt%29._command-line%29%29"><span class="my-code" decode="exclude">command-line</span></a> func­tion, for instance, pro­vides a high-level inter­face for pars­ing com­mand-line argu­ments, includ­ing flags.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;cracking-the-shell&quot;)"></div><h3 anchor="cracking-the-shell" class="subhead" id="cracking-the-shell"><a href="#cracking-the-shell">Crack­ing the shell</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SDubd&quot;)"></div><p id="a_SDubd">For BASIC, we won’t get that fancy. Instead, we’ll just make the first 10 com­mand-line argu­ments avail­able within our BASIC pro­gram under the spe­cial names <span class="my-code" decode="exclude">arg0</span>, <span class="my-code" decode="exclude">arg1</span>, ... <span class="my-code" decode="exclude">arg9</span>. That means we have two tasks:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SsAzW&quot;)"></div><p id="a_SsAzW">Cre­ate the <span class="my-code" decode="exclude">arg0</span>, <span class="my-code" decode="exclude">arg1</span>, ... <span class="my-code" decode="exclude">arg9</span> vari­ables.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CGsiN&quot;)"></div><p id="a_CGsiN">Set the value of each of these vari­ables to the cor­re­spond­ing value read from the com­mand line. (If there are fewer than 10 com­mand-line argu­ments, we’ll set the remain­ing vari­ables to <span class="my-code" decode="exclude">0</span>.) </p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bTJ13&quot;)"></div><p id="a_bTJ13">One small lim­i­ta­tion is that we can’t match the num­ber of <span class="my-code" decode="exclude">arg*</span> vari­ables to the num­ber of com­mand-line argu­ments. We’ll be rely­ing on syn­tax trans­for­ma­tion to cre­ate the vari­ables at <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a>. But the actual com­mand-line argu­ments won’t be avail­able until <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a>. So the num­ber of vari­ables has to be fixed in advance. That said, 10 is arbi­trary—we could make 25 or 100. The code would work the same way.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Cs2fX&quot;)"></div><p id="a_Cs2fX">Once we do this, we should be able to use these vari­ables like any other. If we make a sam­ple <span class="my-code" decode="exclude">"report-args.rkt"</span> mod­ule (using <span class="my-code" decode="exclude">basic-demo-3</span> just for illus­tra­tion):</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/report-args.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CElNt&quot;)"></div><div class="highlight-container" id="a_CElNt"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-3<br/>10 print "arg0 is " ; arg0<br/>20 print "arg1 + arg1 is " ; arg1 + arg1<br/>40 print "arg3 is " ; arg3<br/>50 print "arg4 is " ; arg4</div><div class="highlight" form="false" id="a_z8xhI"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-3
<span class="nl">10</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg0 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg0</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg1 + arg1 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">arg1</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg3 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg3</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg4 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg4</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qlnAH&quot;)"></div><p id="a_qlnAH">And invoke it from the com­mand line like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4vanH&quot;)"></div><div class="highlight-container" id="a_4vanH"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; racket -l basic/report-args "foo" 42 --bar "zam"</div><div class="highlight" form="false" id="a_vdn9o"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; racket -l basic/report-args "foo" 42 --bar "zam"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pSayy&quot;)"></div><p id="a_pSayy">We get this report of the com­mand-line argu­ments. We omit <span class="my-code" decode="exclude">arg2</span> just to show that we don’t have to use them all. Since there is no <span class="my-code" decode="exclude">arg4</span> passed to the pro­gram, it behaves like an ordi­nary BASIC vari­able ini­tial­ized to <span class="my-code" decode="exclude">0</span>):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AehAk&quot;)"></div><div class="highlight-container" id="a_AehAk"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">arg0 is foo<br/>arg1 + arg1 is 84<br/>arg3 is zam<br/>arg4 is 0</div><div class="highlight" form="false" id="a_jpH83"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>arg0 is foo
arg1 + arg1 is 84
arg3 is zam
arg4 is 0
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_itcZ0&quot;)"></div><p id="a_itcZ0">Seems straight­for­ward. But it puts us on a col­li­sion course with an issue that con­founds every writer of Racket macros at least once—how to cir­cum­vent macro <a class="glossary" href="../appendix/glossary.html#hygiene"><span class="glossary-link-text">hygiene</span></a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_d8mBu&quot;)"></div><p id="a_d8mBu">So before we get to the code, a small detour.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;introducing-hygiene&quot;)"></div><h3 anchor="introducing-hygiene" class="subhead" id="introducing-hygiene"><a href="#introducing-hygiene">Intro­duc­ing hygiene</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7WHui&quot;)"></div><p id="a_7WHui"><em><a class="glossary" href="../appendix/glossary.html#hygiene"><span class="glossary-link-text">Hygiene</span></a></em> is the orga­niz­ing pol­icy of Racket’s <a class="glossary" href="../appendix/glossary.html#macro"><span class="glossary-link-text">macro</span></a> sys­tem. It holds that <a class="glossary" href="../appendix/glossary.html#identifier"><span class="glossary-link-text">iden­ti­fiers</span></a> intro­duced by a macro should get their <a class="glossary" href="../appendix/glossary.html#binding"><span class="glossary-link-text">bind­ings</span></a> from the place where the macro was defined, <strong>not</strong> the place where the macro is used. The effect is to keep macro-cre­ated iden­ti­fiers in a name­space sep­a­rate from that of oth­ers. In Racket, these name­spaces are called <a class="glossary" href="../appendix/glossary.html#lexical-context"><span class="glossary-link-text">lex­i­cal con­texts</span></a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HM9Ql&quot;)"></div><p id="a_HM9Ql">“If hygiene is so impor­tant, then why haven’t we been hear­ing more about it?” There’s been no need. The nice thing about hygiene is that it usu­ally con­forms to our intu­itions about how macro-cre­ated code should work, and cuts down on house­keep­ing. (Hygiene is so named because of the “clean­li­ness” it enforces between lex­i­cal con­texts.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_paWMI&quot;)"></div><p id="a_paWMI">For instance, in our macro adven­tures so far, we haven’t had to worry about macro-intro­duced iden­ti­fiers con­flict­ing with oth­ers. For this, we can thank hygiene. In this exam­ple, we have a <span class="my-code" decode="exclude">begin</span> block that defines a vari­able <span class="my-code" decode="exclude">x</span>, and then a  <span class="my-code" decode="exclude">make-x</span> macro that pro­duces the same <span class="my-code" decode="exclude">begin</span> block with a dif­fer­ent value for <span class="my-code" decode="exclude">x</span>. When we run both of these blocks in the same mod­ule, do the two <span class="my-code" decode="exclude">x</span> def­i­n­i­tions con­flict?</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BXrYG&quot;)"></div><div class="highlight-container" id="a_BXrYG"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">(begin (define x 42) x)<br/><br/>(define-macro (make-x)<br/>  #'(begin (define x 'macro-id) x))<br/><br/>(make-x)</div><div class="highlight" form="false" id="a_MuD4t"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="mi">42</span><span class="p">)</span> <span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">make-x</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="o">&#39;</span><span class="ss">macro-id</span><span class="p">)</span> <span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="n">make-x</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jtwhX&quot;)"></div><p id="a_jtwhX">No, they do not:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KMion&quot;)"></div><div class="highlight-container" id="a_KMion"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">42<br/>'macro-id</div><div class="highlight" form="false" id="a_e4aU9"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>42
&#39;macro-id
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xShZB&quot;)"></div><p id="a_xShZB">What’s hap­pen­ing here? When Racket cre­ates an iden­ti­fier dur­ing <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a>, it asso­ciates it with a par­tic­u­lar lex­i­cal con­text. Later, when Racket needs to resolve the bind­ing of that iden­ti­fier, it relies on its lex­i­cal con­text. To Racket, the two <span class="my-code" decode="exclude">x</span> vari­ables in the above exam­ple are com­pletely dif­fer­ent.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pVWp2&quot;)"></div><p id="a_pVWp2">Under the hood, Racket attaches the lex­i­cal con­text to the <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a> that con­tains the iden­ti­fier. Just like the other meta­data attached to the syn­tax object—e.g., <a class="glossary" href="../appendix/glossary.html#source-location"><span class="glossary-link-text">source loca­tion</span></a> or <a class="glossary" href="../appendix/glossary.html#syntax-property"><span class="glossary-link-text">syn­tax prop­er­ties</span></a>—lex­i­cal con­text is pre­served as the iden­ti­fer trav­els through the var­i­ous macro trans­for­ma­tions that hap­pen dur­ing com­pile time.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_of8Pi&quot;)"></div><p id="a_of8Pi">Hav­ing mul­ti­ple vari­ables with the same name shouldn’t be alarm­ing. Con­sider an anal­o­gous exam­ple: with <a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a>, we’re accus­tomed to intro­duc­ing <em>local bind­ings</em> that are only valid within the body of the expres­sion, that may <a class="glossary" href="../appendix/glossary.html#shadow"><span class="glossary-link-text">shadow</span></a> exist­ing bind­ings. In this exam­ple, we have two def­i­n­i­tions of a vari­able called <span class="my-code" decode="exclude">z</span>, but we know the local bind­ing of <span class="my-code" decode="exclude">z</span> won’t “escape” its sur­round­ing <span class="my-code" decode="exclude">let</span> and col­lide with the bind­ing on the out­side:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_G6Dev&quot;)"></div><div class="highlight-container" id="a_G6Dev"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define z 42)<br/>z ; 42<br/>(let ()<br/>  (define z 'let-id)<br/>  z) ; 'let-id</div><div class="highlight" form="false" id="a_pgDQC"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">z</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">z</span> <span class="c1">; 42</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a></span> <span class="p">()</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">z</span> <span class="o">&#39;</span><span class="ss">let-id</span><span class="p">)</span>
  <span class="n">z</span><span class="p">)</span> <span class="c1">; &#39;let-id</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0L86A&quot;)"></div><p id="a_0L86A">Hygiene is a dif­fer­ent mech­a­nism, but has a sim­i­lar effect—cre­at­ing lex­i­cal sep­a­ra­tion between vari­ables.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_h8AcF&quot;)"></div><p id="a_h8AcF">So what hap­pens if we remove hygiene? We can find out by chang­ing our <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a> to <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-unhygienic-macro))" class="docs" hyphens="none">define-unhygienic-macro</a>, which will make our macro write its code into the exist­ing lex­i­cal con­text, rather than keep­ing its code sep­a­rate: <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">“You’re doing it wrong” is the low­est form of pro­gram­ming advice. But please don’t use <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-unhygienic-macro))" class="docs" hyphens="none">define-unhygienic-macro</a> in your own code. It exists only for demon­stra­tion pur­poses. Oth­er­wise, it is a bringer of dark­ness and despair.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PdJS9&quot;)"></div><div class="highlight-container" id="a_PdJS9"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(begin (define x 42) x)<br/><br/>(define-unhygienic-macro (make-x)<br/>  #'(begin (define x 'macro-id) x))<br/><br/>(make-x)</div><div class="highlight" form="false" id="a_GxWPd"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="mi">42</span><span class="p">)</span> <span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-unhygienic-macro))" class="docs" hyphens="none">define-unhygienic-macro</a></span> <span class="p">(</span><span class="n">make-x</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="o">&#39;</span><span class="ss">macro-id</span><span class="p">)</span> <span class="n">x</span><span class="p">))</span>

<span class="p">(</span><span class="n">make-x</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_raBxE&quot;)"></div><p id="a_raBxE">This time, our two <span class="my-code" decode="exclude">x</span> vari­ables will occupy the same lex­i­cal con­text, so the result is dif­fer­ent:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zNIL7&quot;)"></div><div class="highlight-container err" id="a_zNIL7"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">module: duplicate definition for identifier in: x</div><div class="highlight" form="false" id="a_ylI7j"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>module: duplicate definition for identifier in: x
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DynwU&quot;)"></div><p id="a_DynwU">This illus­trates why hygiene is an essen­tial ingre­di­ent in a <a class="glossary" href="../appendix/glossary.html#composable"><span class="glossary-link-text">com­pos­able</span></a>—mean­ing, “plays nicely with oth­ers”—macro sys­tem. Once we make a macro, we want to be able to call it from any code, and have it behave the same way (and not break things). With­out hygiene, we’d always have the risk that an iden­ti­fier in the macro could col­lide with one already defined at the call­ing site. Hygiene guar­an­tees this will never hap­pen.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;the-limits-of-hygiene&quot;)"></div><h3 anchor="the-limits-of-hygiene" class="subhead" id="the-limits-of-hygiene"><a href="#the-limits-of-hygiene">The lim­its of hygiene</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jWxky&quot;)"></div><p id="a_jWxky">In most cases, hygiene makes writ­ing macros eas­ier. But occa­sion­ally it con­flicts with legit­i­mate goals, like using a macro as a sub­sti­tute for <span class="my-code" decode="exclude">define</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Cir0O&quot;)"></div><p id="a_Cir0O">Here’s an exam­ple that trips up every Rack­e­teer at least once (and usu­ally more). Sup­pose a pro­gram repeat­edly defines three vari­ables:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_la7Ra&quot;)"></div><div class="highlight-container" id="a_la7Ra"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define a 1)<br/>(define b 2)<br/>(define c 3)<br/>(+ a b c) ; 6</div><div class="highlight" form="false" id="a_CCdEn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">a</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">b</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">c</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span> <span class="c1">; 6</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GKqYa&quot;)"></div><p id="a_GKqYa">Before long, a bright idea arises. “I know—I’ll make a macro!”</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_be0uq&quot;)"></div><div class="highlight-container" id="a_be0uq"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-three-vars)<br/>  #'(begin<br/>      (define a 1)<br/>      (define b 2)<br/>      (define c 3)))<br/>(define-three-vars)<br/>(+ a b c)</div><div class="highlight" form="false" id="a_4kmTx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-three-vars</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">a</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">b</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">c</span> <span class="mi">3</span><span class="p">)))</span>
<span class="p">(</span><span class="n">define-three-vars</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fVYRE&quot;)"></div><p id="a_fVYRE">But then dis­ap­point­ment ensues:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yp548&quot;)"></div><div class="highlight-container err" id="a_yp548"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">a: unbound identifier in module in: a</div><div class="highlight" form="false" id="a_otzuN"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>a: unbound identifier in module in: a
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PiEwe&quot;)"></div><p id="a_PiEwe">What’s the prob­lem here? Same as the prob­lem with <span class="my-code" decode="exclude">make-x</span>—hygiene guar­an­tees that the iden­ti­fiers intro­duced by the macro remain in a sep­a­rate lex­i­cal con­text. So <span class="my-code" decode="exclude">a</span> <span class="my-code" decode="exclude">b</span> and <span class="my-code" decode="exclude">c</span> are not acces­si­ble at the call­ing site after the macro is invoked.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rG7J5&quot;)"></div><p id="a_rG7J5">In a sit­u­a­tion like this, we have two choices:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nrKzA&quot;)"></div><p id="a_nrKzA">We can rewrite the macro hygien­i­cally by pass­ing the iden­ti­fiers as argu­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_akLRI&quot;)"></div><div class="highlight-container" id="a_akLRI"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-three-vars ID1 ID2 ID3)<br/>  #'(begin<br/>      (define ID1 1)<br/>      (define ID2 2)<br/>      (define ID3 3)))<br/>(define-three-vars a b c)<br/>(+ a b c) ; 6</div><div class="highlight" form="false" id="a_X3Igi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-three-vars</span> <span class="n">ID1</span> <span class="n">ID2</span> <span class="n">ID3</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID1</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID2</span> <span class="mi">2</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID3</span> <span class="mi">3</span><span class="p">)))</span>
<span class="p">(</span><span class="n">define-three-vars</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span> <span class="c1">; 6</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vL7ka&quot;)"></div><p id="a_vL7ka">When we rewrite the macro this way, the iden­ti­fiers <span class="my-code" decode="exclude">a</span> <span class="my-code" decode="exclude">b</span> and <span class="my-code" decode="exclude">c</span> are no longer being intro­duced by the macro. Rather, they’re being intro­duced on the out­side, and passed to the macro as argu­ments. There­fore, rather than being siloed in the lex­i­cal con­text of the macro, they retain their lex­i­cal con­text from the call­ing site.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uuXCz&quot;)"></div><p id="a_uuXCz">This is why we didn’t encounter any hygiene-related dif­fi­cul­ties when <a href="../basic-2/variables-and-input.html">we added vari­ables</a> to BASIC. All the iden­ti­fiers for our vari­ables came from the orig­i­nal source code. Even though our expander picked them up and moved them around, they retained their orig­i­nal lex­i­cal con­text.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AY1Ep&quot;)"></div><p id="a_AY1Ep">Or, if we don’t want to pass the iden­ti­fiers as argu­ments, we can man­u­ally cre­ate iden­ti­fiers con­nected to the lex­i­cal con­text of the call­ing site. Because they cir­cum­vent hygiene, these are known as <em>unhy­gienic</em> iden­ti­fiers:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_calaK&quot;)"></div><div class="highlight-container" id="a_calaK"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define-three-vars)<br/>  (with-pattern ([ID1 (datum-&gt;syntax caller-stx 'a)]<br/>                 [ID2 (datum-&gt;syntax caller-stx 'b)]<br/>                 [ID3 (datum-&gt;syntax caller-stx 'c)])<br/>    #'(begin<br/>        (define ID1 1)<br/>        (define ID2 2)<br/>        (define ID3 3))))<br/>(define-three-vars)<br/>(+ a b c) ; 6</div><div class="highlight" form="false" id="a_3XrPN"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">define-three-vars</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span> <span class="p">([</span><span class="n">ID1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/define..rkt)._caller-stx))" class="docs" hyphens="none">caller-stx</a></span> <span class="o">&#39;</span><span class="ss">a</span><span class="p">)]</span>
                 <span class="p">[</span><span class="n">ID2</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/define..rkt)._caller-stx))" class="docs" hyphens="none">caller-stx</a></span> <span class="o">&#39;</span><span class="ss">b</span><span class="p">)]</span>
                 <span class="p">[</span><span class="n">ID3</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/define..rkt)._caller-stx))" class="docs" hyphens="none">caller-stx</a></span> <span class="o">&#39;</span><span class="ss">c</span><span class="p">)])</span>
    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID1</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID2</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID3</span> <span class="mi">3</span><span class="p">))))</span>
<span class="p">(</span><span class="n">define-three-vars</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span> <span class="c1">; 6</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zSHAM&quot;)"></div><p id="a_zSHAM">Here, we use <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a> to make each iden­ti­fier, which takes a lex­i­cal con­text as its first argu­ment, and a <a class="glossary" href="../appendix/glossary.html#datum"><span class="glossary-link-text">datum</span></a> as the sec­ond. The result is a new syn­tax object asso­ci­ated with the given lex­i­cal con­text. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">We first used <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a> when we made <a href="../stacker/the-reader.html">the reader for <span class="my-code" decode="exclude">stacker</span></a>. Back then, we used <span class="my-code" decode="exclude">#f</span> as the lex­i­cal con­text, because we delib­er­ately wanted the result­ing syn­tax object to have no bind­ings.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_83pim&quot;)"></div><p id="a_83pim">For the lex­i­cal-con­text argu­ment, we pass a syn­tax object with the lex­i­cal con­text we want to “bor­row”. In this case, it’s the macro vari­able <a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/define..rkt)._caller-stx))" class="docs" hyphens="none">caller-stx</a>, which is the syn­tax object rep­re­sent­ing the orig­i­nal call to the macro, and thus car­ries the lex­i­cal con­text of the call­ing site.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7GMIR&quot;)"></div><p id="a_7GMIR">In terms of Racket idiom, unhy­gienic iden­ti­fiers occupy the same space as <a class="glossary" href="../appendix/glossary.html#mutation"><span class="glossary-link-text">muta­tion</span></a> or <a class="glossary" href="../appendix/glossary.html#parameter"><span class="glossary-link-text">para­me­ters</span></a>: we avoid them when we can, because they go against the nat­ural grain of the lan­guage. But when they’re the right tool for the job, we’re not finicky about using them.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0PtMr&quot;)"></div><p id="a_0PtMr">For instance, whe we want to cre­ate a new struc­ture type, we use <a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" class="docs" hyphens="none">struct</a>, which works in part by intro­duc­ing unhy­gienic iden­ti­fiers at the call­ing site (con­struc­tor, pred­i­cate, get­ters, set­ters):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9gVJz&quot;)"></div><div class="highlight-container" id="a_9gVJz"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">(struct thing (left right) #:mutable)<br/>(define t (thing 'foo 'bar))<br/>(thing? t) ; #t<br/>(thing-left t) ; 'foo<br/>(thing-right t) ; 'bar<br/>(set-thing-left! t 'zam)<br/>(thing-left t) ; 'zam</div><div class="highlight" form="false" id="a_dgv7L"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" class="docs" hyphens="none">struct</a></span> <span class="n">thing</span> <span class="p">(</span><span class="n">left</span> <span class="n">right</span><span class="p">)</span> <span class="kd">#:mutable</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._t))" class="docs" hyphens="none">t</a></span> <span class="p">(</span><span class="n">thing</span> <span class="o">&#39;</span><span class="ss">foo</span> <span class="o">&#39;</span><span class="ss">bar</span><span class="p">))</span>
<span class="p">(</span><span class="n">thing?</span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._t))" class="docs" hyphens="none">t</a></span><span class="p">)</span> <span class="c1">; #t</span>
<span class="p">(</span><span class="n">thing-left</span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._t))" class="docs" hyphens="none">t</a></span><span class="p">)</span> <span class="c1">; &#39;foo</span>
<span class="p">(</span><span class="n">thing-right</span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._t))" class="docs" hyphens="none">t</a></span><span class="p">)</span> <span class="c1">; &#39;bar</span>
<span class="p">(</span><span class="n">set-thing-left!</span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._t))" class="docs" hyphens="none">t</a></span> <span class="o">&#39;</span><span class="ss">zam</span><span class="p">)</span>
<span class="p">(</span><span class="n">thing-left</span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._t))" class="docs" hyphens="none">t</a></span><span class="p">)</span> <span class="c1">; &#39;zam</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kHqTP&quot;)"></div><p id="a_kHqTP">For this rea­son, <span class="my-code" decode="exclude">struct</span> will fail if any of these unhy­gienic names con­flict with exist­ing iden­ti­fiers at the call­ing site:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Qtxn8&quot;)"></div><div class="highlight-container" id="a_Qtxn8"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (thing? x) #t)<br/>(struct thing (left right) #:mutable)</div><div class="highlight" form="false" id="a_lJY4w"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">thing?</span> <span class="n">x</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" class="docs" hyphens="none">struct</a></span> <span class="n">thing</span> <span class="p">(</span><span class="n">left</span> <span class="n">right</span><span class="p">)</span> <span class="kd">#:mutable</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hZeg3&quot;)"></div><div class="highlight-container err" id="a_hZeg3"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">module: duplicate definition for identifier in: thing?</div><div class="highlight" form="false" id="a_egm4f"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>module: duplicate definition for identifier in: thing?
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aJGpG&quot;)"></div><p id="a_aJGpG">By the way, <span class="my-code" decode="exclude">datum-&gt;syntax</span> is just one option for cre­at­ing unhy­gienic iden­ti­fiers. Helper func­tions like <a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._prefix-id))" class="docs" hyphens="none">prefix-id</a>, <a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._suffix-id))" class="docs" hyphens="none">suffix-id</a>, and <a href="http://docs.racket-lang.org/reference/syntax-util.html#(def._((lib._racket/syntax..rkt)._format-id))" class="docs" hyphens="none">format-id</a> can also cre­ate iden­ti­fiers in a dif­fer­ent lex­i­cal con­text. Fur­ther­more, though it’s most com­mon for unhy­gienic iden­ti­fiers to be inserted in the lex­i­cal con­text of the macro call­ing site, we can put them—or any other syn­tax items—inside any lex­i­cal con­text.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MEeJ5&quot;)"></div><p id="a_MEeJ5">Hav­ing com­pleted our detour about hygiene, we’re ready to imple­ment com­mand-line argu­ments in BASIC.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;expander-updates&quot;)"></div><h3 anchor="expander-updates" class="subhead" id="expander-updates"><a href="#expander-updates">Expander updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5BXei&quot;)"></div><p id="a_5BXei">Our task is to get the argu­ments out of <a href="http://docs.racket-lang.org/reference/runtime.html#(def._((quote._~23~25kernel)._current-command-line-arguments))" class="docs" hyphens="none">current-command-line-arguments</a> and assign them to the indexed vari­ables <span class="my-code" decode="exclude">arg0</span> through <span class="my-code" decode="exclude">arg9</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rg5xd&quot;)"></div><p id="a_rg5xd">We only need to update <span class="my-code" decode="exclude">"expander.rkt"</span>, but in a few places.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KvqLS&quot;)"></div><p id="a_KvqLS">In our <span class="my-code" decode="exclude">begin-for-syntax</span> block, we add <span class="my-code" decode="exclude">make-shell-ids-and-idxs</span>, a helper func­tion for mak­ing our indexed iden­ti­fiers:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Wqcsa&quot;)"></div><div class="highlight-container" id="a_Wqcsa"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (make-shell-ids-and-idxs ctxt)<br/>    (define arg-count 10)<br/>    (for/list ([idx (in-range arg-count)])<br/>      (list (suffix-id #'arg idx #:context ctxt) idx)))</div><div class="highlight" form="false" id="a_mwwGw"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-shell-ids-and-idxs</span> <span class="n">ctxt</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg-count</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="docs" hyphens="none">for/list</a></span> <span class="p">([</span><span class="n">idx</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" class="docs" hyphens="none">in-range</a></span> <span class="n">arg-count</span><span class="p">)])</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._suffix-id))" class="docs" hyphens="none">suffix-id</a></span> <span class="o">#&#39;</span><span class="n">arg</span> <span class="n">idx</span> <span class="kd">#:context</span> <span class="n">ctxt</span><span class="p">)</span> <span class="n">idx</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mPxx2&quot;)"></div><p id="a_mPxx2">This func­tion takes one argu­ment, <span class="my-code" decode="exclude">ctxt</span>, which is the lex­i­cal con­text where we want to place the iden­ti­fiers. It will return a list of syn­tax objects, each of which con­tains an iden­ti­fier and the index of the com­mand-line argu­ment it cor­re­sponds to. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">We could change the <span class="my-code" decode="exclude">arg-count</span> value here to gen­er­ate more than 10 <span class="my-code" decode="exclude">arg*</span> iden­ti­fiers.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fV5Vn&quot;)"></div><p id="a_fV5Vn">For later use, we refac­tor our <span class="my-code" decode="exclude">find-property</span> func­tion to extract a helper func­tion called <span class="my-code" decode="exclude">unique-ids</span>, which removes dupli­cate iden­ti­fiers from a list:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XSnOt&quot;)"></div><div class="highlight-container" id="a_XSnOt"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (unique-ids stxs)<br/>  (remove-duplicates stxs #:key syntax-&gt;datum))<br/><br/>(define (find-property which line-stxs)<br/>  (unique-ids<br/>   (for/list ([stx (in-list (stx-flatten line-stxs))]<br/>              #:when (syntax-property stx which))<br/>     stx)))</div><div class="highlight" form="false" id="a_3o3Gk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">unique-ids</span> <span class="n">stxs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._remove-duplicates))" class="docs" hyphens="none">remove-duplicates</a></span> <span class="n">stxs</span> <span class="kd">#:key</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3edatum))" class="docs" hyphens="none">syntax-&gt;datum</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">find-property</span> <span class="n">which</span> <span class="n">line-stxs</span><span class="p">)</span>
  <span class="p">(</span><span class="n">unique-ids</span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="docs" hyphens="none">for/list</a></span> <span class="p">([</span><span class="n">stx</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._stx-flatten))" class="docs" hyphens="none">stx-flatten</a></span> <span class="n">line-stxs</span><span class="p">))]</span>
              <span class="kd">#:when</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx</span> <span class="n">which</span><span class="p">))</span>
     <span class="n">stx</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BMcKs&quot;)"></div><p id="a_BMcKs">In our <span class="my-code" decode="exclude">b-module-begin</span> macro, we make a list of <span class="my-code" decode="exclude">SHELL-ID</span> and <span class="my-code" decode="exclude">SHELL-IDX</span> val­ues by call­ing <span class="my-code" decode="exclude">make-shell-ids-and-idxs</span>. We pass <span class="my-code" decode="exclude">caller-stx</span> as the lex­i­cal-con­text argu­ment, since we want these new iden­ti­fiers to behave as if they came from the call­ing site.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Jj73S&quot;)"></div><div class="highlight-container" id="a_Jj73S"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">[((SHELL-ID SHELL-IDX) ...)<br/> (make-shell-ids-and-idxs caller-stx)]</div><div class="highlight" form="false" id="a_l18nh"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">[((</span><span class="n">SHELL-ID</span> <span class="n">SHELL-IDX</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
 <span class="p">(</span><span class="n">make-shell-ids-and-idxs</span> <span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/define..rkt)._caller-stx))" class="docs" hyphens="none">caller-stx</a></span><span class="p">)]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_b2Zf8&quot;)"></div><p id="a_b2Zf8">If any of our indexed iden­ti­fiers <span class="my-code" decode="exclude">arg0</span> through <span class="my-code" decode="exclude">arg9</span> already appear in the code, they’ll already be part of the <span class="my-code" decode="exclude">VAR-ID ...</span> list. We can’t <span class="my-code" decode="exclude">define</span> any vari­able twice. So we need to gen­er­ate a list of unique iden­ti­fiers. We do this by con­cate­nat­ing <span class="my-code" decode="exclude">VAR-ID ...</span> and <span class="my-code" decode="exclude">SHELL-ID ...</span> into one list and run­ning this list through <span class="my-code" decode="exclude">unique-ids</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YA9uA&quot;)"></div><div class="highlight-container" id="a_YA9uA"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">[(UNIQUE-ID ...)<br/> (unique-ids<br/>  (syntax-&gt;list #'(VAR-ID ... SHELL-ID ...)))]</div><div class="highlight" form="false" id="a_TNDM0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">[(</span><span class="n">UNIQUE-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
 <span class="p">(</span><span class="n">unique-ids</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3elist))" class="docs" hyphens="none">syntax-&gt;list</a></span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="n">SHELL-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))]</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkn" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XiWb9&quot;)"></div><p id="a_XiWb9">After that, we just need to <span class="my-code" decode="exclude">define</span> each <span class="my-code" decode="exclude">UNIQUE-ID</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5Tzxs&quot;)"></div><div class="highlight-container" id="a_5Tzxs"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define UNIQUE-ID 0) ...</div><div class="highlight" form="false" id="a_25oqt"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">UNIQUE-ID</span> <span class="mi">0</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ut0HJ&quot;)"></div><p id="a_Ut0HJ">We also <span class="my-code" decode="exclude">set!</span> every <span class="my-code" decode="exclude">SHELL-ID</span> to its cor­re­spond­ing com­mand-line argu­ment, using <span class="my-code" decode="exclude">SHELL-IDX</span> as the index into the vec­tor:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Mmbvz&quot;)"></div><div class="highlight-container" id="a_Mmbvz"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">(let ([clargs (current-command-line-arguments)])<br/>  (set! SHELL-ID (get-clarg clargs SHELL-IDX)) ...)</div><div class="highlight" form="false" id="a_lBYDn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a></span> <span class="p">([</span><span class="n">clargs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/runtime.html#(def._((quote._~23~25kernel)._current-command-line-arguments))" class="docs" hyphens="none">current-command-line-arguments</a></span><span class="p">)])</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">SHELL-ID</span> <span class="p">(</span><span class="n">get-clarg</span> <span class="n">clargs</span> <span class="n">SHELL-IDX</span><span class="p">))</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkp" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tJIXI&quot;)"></div><p id="a_tJIXI">Because we pre­fer to min­i­mize the amount of code inside the body of our macro, we move the <span class="my-code" decode="exclude">get-clarg</span> helper func­tion to the out­side:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QQkFJ&quot;)"></div><div class="highlight-container" id="a_QQkFJ"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (get-clarg clargs idx)<br/>  (if (&lt;= (vector-length clargs) idx)<br/>      0<br/>      (let ([val (vector-ref clargs idx)])<br/>        (or (string-&gt;number val) val))))</div><div class="highlight" form="false" id="a_pihpJ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">get-clarg</span> <span class="n">clargs</span> <span class="n">idx</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c~3d))" class="docs" hyphens="none">&lt;=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-length))" class="docs" hyphens="none">vector-length</a></span> <span class="n">clargs</span><span class="p">)</span> <span class="n">idx</span><span class="p">)</span>
      <span class="mi">0</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a></span> <span class="p">([</span><span class="n">val</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a></span> <span class="n">clargs</span> <span class="n">idx</span><span class="p">)])</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="n">val</span><span class="p">)</span> <span class="n">val</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mnMwy&quot;)"></div><p id="a_mnMwy">The helper func­tion takes two argu­ments: the vec­tor of com­mand-line argu­ments, and a vec­tor index. If the <span class="my-code" decode="exclude">idx</span> exceeds the num­ber of val­ues avail­able in <span class="my-code" decode="exclude">clargs</span>, we return <span class="my-code" decode="exclude">0</span>. Oth­er­wise, the com­mand-line argu­ment will be a string, or a string that rep­re­sents a num­ber. We try con­vert­ing it with <a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a>, but if it returns <span class="my-code" decode="exclude">#f</span>, we return the argu­ment itself.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_y7dYt&quot;)"></div><p id="a_y7dYt">When we put all the pieces together, our <span class="my-code" decode="exclude">"expander.rkt"</span> looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Rr3Ie&quot;)"></div><div class="highlight-container" id="a_Rr3Ie"><div id="code_70" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require "struct.rkt" "run.rkt" "elements.rkt" "setup.rkt")<br/>(provide (rename-out [b-module-begin #%module-begin])<br/>         (all-from-out "elements.rkt"))<br/><br/>(define-macro (b-module-begin (b-program LINE ...))<br/>  (with-pattern<br/>      ([((b-line NUM STMT ...) ...) #'(LINE ...)]<br/>       [(LINE-FUNC ...) (prefix-id "line-" #'(NUM ...))]<br/>       [(VAR-ID ...) (find-property 'b-id #'(LINE ...))]<br/>       [(IMPORT-NAME ...)<br/>        (find-property 'b-import-name #'(LINE ...))]<br/>       [(EXPORT-NAME ...)<br/>        (find-property 'b-export-name #'(LINE ...))]<br/>       [((SHELL-ID SHELL-IDX) ...)<br/>        (make-shell-ids-and-idxs caller-stx)] <br/>       [(UNIQUE-ID ...)<br/>        (unique-ids<br/>         (syntax-&gt;list #'(VAR-ID ... SHELL-ID ...)))])<br/>    #'(#%module-begin<br/>       (module configure-runtime br<br/>         (require basic/setup)<br/>         (do-setup!))<br/>       (require IMPORT-NAME) ...<br/>       (provide EXPORT-NAME ...)<br/>       (define UNIQUE-ID 0) ...<br/>       (let ([clargs (current-command-line-arguments)])<br/>         (set! SHELL-ID (get-clarg clargs SHELL-IDX)) ...)<br/>       LINE ...<br/>       (define line-table<br/>         (apply hasheqv (append (list NUM LINE-FUNC) ...)))<br/>       (parameterize<br/>           ([current-output-port (basic-output-port)])<br/>         (void (run line-table))))))<br/><br/>(define (get-clarg clargs idx)<br/>  (if (&lt;= (vector-length clargs) idx)<br/>      0<br/>      (let ([val (vector-ref clargs idx)])<br/>        (or (string-&gt;number val) val))))<br/><br/>(begin-for-syntax<br/>  (require racket/list)<br/>  <br/>  (define (unique-ids stxs)<br/>    (remove-duplicates stxs #:key syntax-&gt;datum))<br/><br/>  (define (find-property which line-stxs)<br/>    (unique-ids<br/>     (for/list ([stx (in-list (stx-flatten line-stxs))]<br/>                #:when (syntax-property stx which))<br/>       stx)))<br/><br/>  (define (make-shell-ids-and-idxs ctxt)<br/>    (define arg-count 10)<br/>    (for/list ([idx (in-range arg-count)])<br/>      (list (suffix-id #'arg idx #:context ctxt) idx))))<br/>
</div><div class="highlight" form="false" id="a_eLDep"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"run.rkt"</span> <span class="s2">"elements.rkt"</span> <span class="s2">"setup.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">b-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">])</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._all-from-out))" class="docs" hyphens="none">all-from-out</a></span> <span class="s2">"elements.rkt"</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-module-begin</span> <span class="p">(</span><span class="n">b-program</span> <span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span>
      <span class="p">([((</span><span class="n">b-line</span> <span class="n">NUM</span> <span class="n">STMT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)]</span>
       <span class="p">[(</span><span class="n">LINE-FUNC</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._prefix-id))" class="docs" hyphens="none">prefix-id</a></span> <span class="s2">"line-"</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">NUM</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]</span>
       <span class="p">[(</span><span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="p">(</span><span class="n">find-property</span> <span class="o">&#39;</span><span class="ss">b-id</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]</span>
       <span class="p">[(</span><span class="n">IMPORT-NAME</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
        <span class="p">(</span><span class="n">find-property</span> <span class="o">&#39;</span><span class="ss">b-import-name</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]</span>
       <span class="p">[(</span><span class="n">EXPORT-NAME</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
        <span class="p">(</span><span class="n">find-property</span> <span class="o">&#39;</span><span class="ss">b-export-name</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]</span>
<span class="hll">       <span class="p">[((</span><span class="n">SHELL-ID</span> <span class="n">SHELL-IDX</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span><span class="hll">        <span class="p">(</span><span class="n">make-shell-ids-and-idxs</span> <span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/define..rkt)._caller-stx))" class="docs" hyphens="none">caller-stx</a></span><span class="p">)]</span> 
</span><span class="hll">       <span class="p">[(</span><span class="n">UNIQUE-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span><span class="hll">        <span class="p">(</span><span class="n">unique-ids</span>
</span><span class="hll">         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3elist))" class="docs" hyphens="none">syntax-&gt;list</a></span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="n">SHELL-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))])</span>
</span>    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">configure-runtime</span> <span class="n">br</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">basic/setup</span><span class="p">)</span>
         <span class="p">(</span><span class="n">do-setup!</span><span class="p">))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">IMPORT-NAME</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">EXPORT-NAME</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
<span class="hll">       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">UNIQUE-ID</span> <span class="mi">0</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
</span><span class="hll">       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a></span> <span class="p">([</span><span class="n">clargs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/runtime.html#(def._((quote._~23~25kernel)._current-command-line-arguments))" class="docs" hyphens="none">current-command-line-arguments</a></span><span class="p">)])</span>
</span><span class="hll">         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">SHELL-ID</span> <span class="p">(</span><span class="n">get-clarg</span> <span class="n">clargs</span> <span class="n">SHELL-IDX</span><span class="p">))</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
</span>       <span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">line-table</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hasheqv))" class="docs" hyphens="none">hasheqv</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._append))" class="docs" hyphens="none">append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">NUM</span> <span class="n">LINE-FUNC</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/parameters.html#(form._((lib._racket/private/more-scheme..rkt)._parameterize))" class="docs" hyphens="none">parameterize</a></span>
           <span class="p">([</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._current-output-port))" class="docs" hyphens="none">current-output-port</a></span> <span class="p">(</span><span class="n">basic-output-port</span><span class="p">)])</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">run</span> <span class="n">line-table</span><span class="p">))))))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">get-clarg</span> <span class="n">clargs</span> <span class="n">idx</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c~3d))" class="docs" hyphens="none">&lt;=</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-length))" class="docs" hyphens="none">vector-length</a></span> <span class="n">clargs</span><span class="p">)</span> <span class="n">idx</span><span class="p">)</span>
</span><span class="hll">      <span class="mi">0</span>
</span><span class="hll">      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a></span> <span class="p">([</span><span class="n">val</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/vectors.html#(def._((quote._~23~25kernel)._vector-ref))" class="docs" hyphens="none">vector-ref</a></span> <span class="n">clargs</span> <span class="n">idx</span><span class="p">)])</span>
</span><span class="hll">        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="n">val</span><span class="p">)</span> <span class="n">val</span><span class="p">))))</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin-for-syntax))" class="docs" hyphens="none">begin-for-syntax</a></span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">racket/list</span><span class="p">)</span>

<span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">unique-ids</span> <span class="n">stxs</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._remove-duplicates))" class="docs" hyphens="none">remove-duplicates</a></span> <span class="n">stxs</span> <span class="kd">#:key</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3edatum))" class="docs" hyphens="none">syntax-&gt;datum</a></span><span class="p">))</span>
</span><span class="hll">
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">find-property</span> <span class="n">which</span> <span class="n">line-stxs</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="n">unique-ids</span>
</span><span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="docs" hyphens="none">for/list</a></span> <span class="p">([</span><span class="n">stx</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._stx-flatten))" class="docs" hyphens="none">stx-flatten</a></span> <span class="n">line-stxs</span><span class="p">))]</span>
</span><span class="hll">                <span class="kd">#:when</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx</span> <span class="n">which</span><span class="p">))</span>
</span><span class="hll">       <span class="n">stx</span><span class="p">)))</span>
</span><span class="hll">
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-shell-ids-and-idxs</span> <span class="n">ctxt</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg-count</span> <span class="mi">10</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="docs" hyphens="none">for/list</a></span> <span class="p">([</span><span class="n">idx</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" class="docs" hyphens="none">in-range</a></span> <span class="n">arg-count</span><span class="p">)])</span>
</span><span class="hll">      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._suffix-id))" class="docs" hyphens="none">suffix-id</a></span> <span class="o">#&#39;</span><span class="n">arg</span> <span class="n">idx</span> <span class="kd">#:context</span> <span class="n">ctxt</span><span class="p">)</span> <span class="n">idx</span><span class="p">))))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_70" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-command-line-arguments&quot;)"></div><h3 anchor="testing-our-command-line-arguments" class="subhead" id="testing-our-command-line-arguments"><a href="#testing-our-command-line-arguments">Test­ing our com­mand-line argu­ments</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6fXB0&quot;)"></div><p id="a_6fXB0">We should now be able to run our <span class="my-code" decode="exclude">"report-args.rkt"</span> mod­ule under <span class="my-code" decode="exclude">#lang basic</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/report-args.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8Ajce&quot;)"></div><div class="highlight-container" id="a_8Ajce"><div id="code_71" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 print "arg0 is " ; arg0<br/>20 print "arg1 + arg1 is " ; arg1 + arg1<br/>40 print "arg3 is " ; arg3<br/>50 print "arg4 is " ; arg4</div><div class="highlight" form="false" id="a_5ksC4"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg0 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg0</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg1 + arg1 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">arg1</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg3 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg3</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"arg4 is "</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">arg4</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpks" data-clipboard-target="#code_71" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qlnAHt&quot;)"></div><p id="a_qlnAHt">And invoke it from the com­mand line like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4vanHw&quot;)"></div><div class="highlight-container" id="a_4vanHw"><div id="code_72" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; racket -l basic/report-args "foo" 42 --bar "zam"</div><div class="highlight" form="false" id="a_vdn9ou"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; racket -l basic/report-args "foo" 42 --bar "zam"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkv" data-clipboard-target="#code_72" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_apcYw&quot;)"></div><p id="a_apcYw">We should see this report of the com­mand-line argu­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AehAkz&quot;)"></div><div class="highlight-container" id="a_AehAkz"><div id="code_73" form="false" decode="exclude" style="font-size:0;width:0;height:0">arg0 is foo<br/>arg1 + arg1 is 84<br/>arg3 is zam<br/>arg4 is 0</div><div class="highlight" form="false" id="a_jpH83x"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>arg0 is foo
arg1 + arg1 is 84
arg3 is zam
arg4 is 0
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_73" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TKTbq&quot;)"></div><p id="a_TKTbq">This shows that all the pieces are work­ing. In par­tic­u­lar, it shows that we’ve suc­cess­fully cre­ated unhy­gienic iden­ti­fiers that behave as if they were defined at the call­ing site (that is, in the BASIC source).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_waZh5&quot;)"></div><p id="a_waZh5">To appre­ci­ate the impor­tance of break­ing hygiene, we can try remov­ing the <span class="my-code" decode="exclude">#:context ctxt</span> argu­ment from the call to <span class="my-code" decode="exclude">suffix-id</span>. If we try invok­ing the same shell com­mand:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4vanHC&quot;)"></div><div class="highlight-container" id="a_4vanHC"><div id="code_74" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; racket -l basic/report-args "foo" 42 --bar "zam"</div><div class="highlight" form="false" id="a_vdn9oA"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; racket -l basic/report-args "foo" 42 --bar "zam"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkB" data-clipboard-target="#code_74" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_q7MiG&quot;)"></div><p id="a_q7MiG">This time, we get an error:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sRgXj&quot;)"></div><div class="highlight-container err" id="a_sRgXj"><div id="code_75" form="false" decode="exclude" style="font-size:0;width:0;height:0">set!: unbound identifier in module<br/>  in: arg0<br/>  context...:<br/>   standard-module-name-resolver</div><div class="highlight" form="false" id="a_SN5DY"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>set!: unbound identifier in module
  in: arg0
  context...:
   standard-module-name-resolver
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkD" data-clipboard-target="#code_75" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6shW2&quot;)"></div><p id="a_6shW2">This error arises because there are two mis­matched <span class="my-code" decode="exclude">arg0</span> iden­ti­fiers in the code. One is attached to the lex­i­cal con­text of the BASIC source, and appears in the <span class="my-code" decode="exclude">VAR-ID ...</span> list. This one is used for the <span class="my-code" decode="exclude">define</span>. The other is attached to the lex­i­cal con­text of <span class="my-code" decode="exclude">make-shell-ids-and-values</span>, and appears in the <span class="my-code" decode="exclude">SHELL-ID</span> ... list. This one is used for the <span class="my-code" decode="exclude">set!</span>. Hence the error: the macro-intro­duced <span class="my-code" decode="exclude">arg0</span> used with <span class="my-code" decode="exclude">set!</span> has not been defined yet.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rTWKa&quot;)"></div><p id="a_rTWKa">One gotcha about work­ing with unhy­gienic iden­ti­fiers is that error mes­sages can be ambigu­ous. For instance, the error above says that <span class="my-code" decode="exclude">arg0</span> is unbound. But it doesn’t tell us <em>which</em> <span class="my-code" decode="exclude">arg0</span> is the prob­lem. In this case, we’re using <span class="my-code" decode="exclude">set!</span> only with <span class="my-code" decode="exclude">SHELL-ID</span>, so we can deduce the cul­prit. But in gen­eral, it’s another rea­son to use unhy­gieinic iden­ti­fiers spar­ingly.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="functions.html">3&emsp;func­tions</a></li><li><a href="imports.html">4&emsp;imports</a></li><li><a href="exports.html">5&emsp;exports</a></li><li><a href="the-repl.html">6&emsp;the repl</a></li><li><a class="here" href="command-line-arguments.html">7&emsp;com­mand-line argu­ments</a></li><li><a href="recap.html">8&emsp;recap</a></li><li><a href="source-listing.html">9&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="the-repl.html">← prev</a>
    <a class="nav-right" href="recap.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>