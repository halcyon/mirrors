<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/basic-3/the-repl.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:48:14 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Closing the loop: basic</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;closing-the-loop-basic&quot;)"></div><h1 anchor="closing-the-loop-basic" id="closing-the-loop-basic" hyphens="none">Closing the loop: <span class="my-code" decode="exclude">basic</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="functions.html">3&emsp;func­tions</a></li><li><a href="imports.html">4&emsp;imports</a></li><li><a href="exports.html">5&emsp;exports</a></li><li><a class="here" href="the-repl.html">6&emsp;the repl</a></li><li><a href="command-line-arguments.html">7&emsp;com­mand-line argu­ments</a></li><li><a href="recap.html">8&emsp;recap</a></li><li><a href="source-listing.html">9&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_56EQ6&quot;)"></div><p id="a_56EQ6">Our project in this sec­tion will be to improve the REPL to be able to under­stand &amp; eval­u­ate expres­sions writ­ten in BASIC.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;repl-recap&quot;)"></div><h3 anchor="repl-recap" class="subhead" id="repl-recap"><a href="#repl-recap">REPL recap</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zEUA2&quot;)"></div><p id="a_zEUA2">We haven’t said much about the <a class="explainer" href="../explainer/repl.html">REPL</a>, though we’ve been using it through­out this book. The REPL—an acronym for <em>read–eval­u­ate–print loop</em>, pro­nounced <em>rep­ple</em>—is where Racket prints the results of pro­grams:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5N7wp&quot;)"></div><div class="highlight-container" id="a_5N7wp"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (f x) (+ x x))<br/>(define x 21)<br/>(f x)</div><div class="highlight" form="false" id="a_NZ9j0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">x</span> <span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="mi">21</span><span class="p">)</span>
<span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JWZzB&quot;)"></div><div class="highlight-container" id="a_JWZzB"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">42</div><div class="highlight" form="false" id="a_bclDp"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>42
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_O5rGG&quot;)"></div><p id="a_O5rGG">On the com­mand line, the REPL starts auto­mat­i­cally when we run <span class="my-code" decode="exclude">racket</span>. In DrRacket, the lower panel of each win­dow con­tains the REPL. The DrRacket REPL is more capa­ble than the com­mand-line ver­sion, how­ever. For a sur­prise, try this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_w05Id&quot;)"></div><div class="highlight-container" id="a_w05Id"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">(require plot math)<br/>(plot3d (surface3d (λ (x y) (* (cos x) (sin y)))<br/>                   (- pi) pi (- pi) pi))</div><div class="highlight" form="false" id="a_LhFJG"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="nb"><a href="http://docs.racket-lang.org/plot/plotting.html#(def._((lib._plot/main..rkt)._plot))" class="docs" hyphens="none">plot</a></span> <span class="nb"><a href="http://docs.racket-lang.org/scribble/Miscellaneous.html#(def._((lib._scribble/manual..rkt)._math))" class="docs" hyphens="none">math</a></span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/plot/plotting.html#(def._((lib._plot/main..rkt)._plot3d))" class="docs" hyphens="none">plot3d</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/plot/renderer3d.html#(def._((lib._plot/main..rkt)._surface3d))" class="docs" hyphens="none">surface3d</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" class="docs" hyphens="none">λ</a></span> <span class="p">(</span><span class="n">x</span> <span class="n">y</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._cos))" class="docs" hyphens="none">cos</a></span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sin))" class="docs" hyphens="none">sin</a></span> <span class="n">y</span><span class="p">)))</span>
                   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" class="docs" hyphens="none">pi</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" class="docs" hyphens="none">pi</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" class="docs" hyphens="none">pi</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" class="docs" hyphens="none">pi</a></span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AvQdB&quot;)"></div><p id="a_AvQdB">The REPL is used for input as well as out­put. Expres­sions can be entered directly on the REPL, and eval­u­ated imme­di­ately:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1HWbX&quot;)"></div><div class="highlight-container" id="a_1HWbX"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; (define (g x) (* x x))<br/>&gt; g<br/>#&lt;procedure:g&gt;<br/>&gt; (g 9)<br/>81</div><div class="highlight" form="false" id="a_AfXKM"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>&gt; (define (g x) (* x x))
&gt; g
#&lt;procedure:g&gt;
&gt; (g 9)
81
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6DwDT&quot;)"></div><p id="a_6DwDT">The REPL is not an inde­pen­dent eval­u­a­tion envi­ron­ment. Rather, expres­sions entered on the REPL are treated as if they lived in the top level of the cur­rently run­ning pro­gram. There­fore, REPL expres­sions can access all the <a class="glossary" href="../appendix/glossary.html#binding"><span class="glossary-link-text">bind­ings</span></a> avail­able in the pro­gram, even if they’re not exported with <span class="my-code" decode="exclude">provide</span>. For instance, this pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5N7wp6&quot;)"></div><div class="highlight-container" id="a_5N7wp6"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (f x) (+ x x))<br/>(define x 21)<br/>(f x)</div><div class="highlight" form="false" id="a_NZ9j04"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>(define (f x) (+ x x))
(define x 21)
(f x)
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_veQ49&quot;)"></div><p id="a_veQ49">Prints an ini­tial result:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JWZzB9&quot;)"></div><div class="highlight-container" id="a_JWZzB9"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">42</div><div class="highlight" form="false" id="a_bclDp7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>42
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_a3636&quot;)"></div><p id="a_a3636">But we can move to the REPL and eval­u­ate new expres­sions using <span class="my-code" decode="exclude">f</span> and <span class="my-code" decode="exclude">x</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rCUDa&quot;)"></div><div class="highlight-container" id="a_rCUDa"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; f<br/>#&lt;procedure:f&gt;<br/>&gt; x<br/>21<br/>&gt; (f (+ x x))<br/>84</div><div class="highlight" form="false" id="a_41gVx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>&gt; f
#&lt;procedure:f&gt;
&gt; x
21
&gt; (f (+ x x))
84
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XOuWN&quot;)"></div><p id="a_XOuWN">In a way, we can think of the REPL as per­form­ing a smaller-scale ver­sion of the pro­cess­ing steps that hap­pen in a full Racket-imple­mented lan­guage. When we make a lan­guage, the source code is sent to our <a class="glossary" href="../appendix/glossary.html#reader"><span class="glossary-link-text">reader</span></a>, which turns it into a <a class="glossary" href="../appendix/glossary.html#module"><span class="glossary-link-text">mod­ule</span></a> expres­sion, which is passed to our <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a> to be expanded and eval­u­ated, and the results are printed. Like­wise, as its name implies, the REPL reads an expres­sion, then expands, eval­u­ates, and prints it. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">In Racket, per­haps “REEPL” would be the more accu­rate acronym, but REPL is the tra­di­tional name among Lisps.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AgiXH&quot;)"></div><p id="a_AgiXH">The key dif­fer­ence between a lan­guage and the REPL is the behav­ior dur­ing the reader phase. In a lan­guage, the input (= the lines of source code) is read as a mod­ule, which then behaves as a self-con­tained pro­gram. Whereas on the REPL, the input (= a sin­gle line) is read as a sin­gle expres­sion, which then behaves as a frag­ment of a larger pro­gram.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;limits-of-the-repl&quot;)"></div><h3 anchor="limits-of-the-repl" class="subhead" id="limits-of-the-repl"><a href="#limits-of-the-repl">Lim­its of the REPL</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4GLry&quot;)"></div><p id="a_4GLry">Those who have been fid­dling with the REPL dur­ing our tuto­ri­als may have noticed some­thing strange: no mat­ter what our source lan­guage looks like, the REPL only accepts Racket-style S-expres­sions as input.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hiE1j&quot;)"></div><p id="a_hiE1j">For instance, here’s a BASIC pro­gram sim­i­lar to our ear­lier exam­ple that exports <span class="my-code" decode="exclude">f</span> and <span class="my-code" decode="exclude">x</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PGQbn&quot;)"></div><div class="highlight-container" id="a_PGQbn"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 def f(x) = x + x<br/>20 x = 21<br/>30 export f : export x</div><div class="highlight" form="false" id="a_KBae0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">def</span><span class="w"> </span><span class="vg">f</span><span class="p">(</span><span class="vg">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">21</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">export</span><span class="w"> </span><span class="vg">f</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">export</span><span class="w"> </span><span class="vg">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_seghf&quot;)"></div><p id="a_seghf">When we try to enter a BASIC-style expres­sion on the REPL, we get an error: <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">The REPL reads <span class="my-code" decode="exclude">f(x)</span> as two expres­sions: <span class="my-code" decode="exclude">f</span> fol­lowed by <span class="my-code" decode="exclude">(x)</span>, which becomes <span class="my-code" decode="exclude">(21)</span> and trig­gers an error, becase <span class="my-code" decode="exclude">21</span> is “not a pro­ce­dure”.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qvpwW&quot;)"></div><div class="highlight-container" id="a_qvpwW"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; f(x)<br/>#&lt;procedure:f&gt;<br/>application: not a procedure;<br/> expected a procedure that can be applied to arguments<br/>  given: 21<br/>  arguments...: [none]</div><div class="highlight" form="false" id="a_0KPci"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>&gt; f(x)
#&lt;procedure:f&gt;
application: not a procedure;
 expected a procedure that can be applied to arguments
  given: 21
  arguments...: [none]
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2fUXX&quot;)"></div><p id="a_2fUXX">But if we use Racket-style syn­tax, it works:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FvQRx&quot;)"></div><div class="highlight-container" id="a_FvQRx"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; (f x)<br/>42</div><div class="highlight" form="false" id="a_nZrw7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>&gt; (f x)
42
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_otrZH&quot;)"></div><p id="a_otrZH">“But we wrote a top-notch BASIC reader. Why doesn’t the REPL use that auto­mat­i­cally?” Because it won’t work. As we learned above, a lan­guage reader pro­duces a mod­ule that rep­re­sents a self-con­tained pro­gram. Whereas a REPL reader needs to pro­duce a sin­gle expres­sion. There­fore, by default, the REPL doesn’t rely on the reader of the cur­rent lan­guage. Instead, it relies on the usual S-expres­sion reader.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_gI2mT&quot;)"></div><p id="a_gI2mT">This isn’t com­pletely use­less. It just means that if we want to use the REPL, we need to man­u­ally con­vert BASIC expres­sions to what they’d look like in the parse tree pro­duced by the main lan­guage reader.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KtthI&quot;)"></div><p id="a_KtthI">We just saw one exam­ple: we passed <span class="my-code" decode="exclude">x</span> as an argu­ment to the <span class="my-code" decode="exclude">f</span> func­tion on the REPL by using the S-expres­sion func­tion nota­tion <span class="my-code" decode="exclude">(f x)</span> rather than the BASIC func­tion nota­tion <span class="my-code" decode="exclude">f(x)</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cUIM4&quot;)"></div><p id="a_cUIM4">Here’s another exam­ple. Even though we can’t eval­u­ate <span class="my-code" decode="exclude">x + x * x</span> directly:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_G83fo&quot;)"></div><div class="highlight-container" id="a_G83fo"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; x + x * x<br/>21<br/>+: undefined;<br/> cannot reference an identifier before its definition</div><div class="highlight" form="false" id="a_feRVk"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>&gt; x + x * x
21
+: undefined;
 cannot reference an identifier before its definition
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DT6Me&quot;)"></div><p id="a_DT6Me">We can eval­u­ate the parse-tree ver­sion of this expres­sion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QwHrs&quot;)"></div><div class="highlight-container" id="a_QwHrs"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; (b-sum x "+" (b-product x "*" x))<br/>882</div><div class="highlight" form="false" id="a_2iinO"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>&gt; (b-sum x "+" (b-product x "*" x))
882
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zVBhK&quot;)"></div><p id="a_zVBhK">Not com­pletely use­less. But still a chore and a bore. It would def­i­nitely be nicer to be able to enter BASIC expres­sions on the REPL with the usual BASIC nota­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;improving-the-repl&quot;)"></div><h3 anchor="improving-the-repl" class="subhead" id="improving-the-repl"><a href="#improving-the-repl">Improv­ing the REPL</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yh4v7&quot;)"></div><p id="a_yh4v7">The good news is that we can con­fig­ure the REPL to work with BASIC expres­sions. To do this, we have two tasks:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7ZFwk&quot;)"></div><p id="a_7ZFwk">We need to make a new “expres­sion reader” for the REPL that can read sin­gle BASIC expres­sions.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DXDSl&quot;)"></div><p id="a_DXDSl">When a BASIC mod­ule runs, we need to con­fig­ure the REPL to use this new expres­sion reader.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CA5YR&quot;)"></div><p id="a_CA5YR">The sec­ond part is easy. Our BASIC-aware REPL will only be invoked when a BASIC mod­ule is run directly (vs. being imported into another mod­ule). There­fore, as we learned in <a href="exports.html">exports</a>, this is a job that can be han­dled by the <span class="my-code" decode="exclude">configure-runtime</span> sub­mod­ule. We’ll update our <span class="my-code" decode="exclude">do-setup!</span> func­tion to set the REPL to use the new expres­sion reader.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_gB166&quot;)"></div><p id="a_gB166">So how about the first part—where do we get this expres­sion reader? Clearly, we’d pre­fer to avoid start­ing from scratch. Ide­ally, we’d like to derive our expres­sion reader from our cur­rent lexer &amp; parser. In par­tic­u­lar, we’ve already writ­ten a bunch of parser rules for han­dling BASIC expres­sions—it would be nice to be able to just reach in and reuse them.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AhIMO&quot;)"></div><p id="a_AhIMO">As it turns out, we can. So far, we’ve used <span class="my-code" decode="exclude">#lang brag</span> to gen­er­ate a <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/examples/nested-word-list..rkt)._parse))" class="docs" hyphens="none">parse</a> func­tion that starts from the first rule in the gram­mar. The start­ing rule ends up serv­ing as the root node of the result­ing parse tree. Since we use <span class="my-code" decode="exclude">parse</span> to han­dle whole pro­grams, we’ve usu­ally named this first rule <span class="my-code" decode="exclude">langname-program</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uBJPS&quot;)"></div><p id="a_uBJPS">But any mod­ule writ­ten in <span class="my-code" decode="exclude">brag</span> also pro­vides a func­tion called <a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/examples/nested-word-list..rkt)._make-rule-parser))" class="docs" hyphens="none">make-rule-parser</a> that lets us gen­er­ate a parser for any rule within the gram­mar. So rather than start­ing with the first rule, we can start any­where.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SE1hb&quot;)"></div><p id="a_SE1hb">Let’s see how this works. Sup­pose we want to parse the string we used above—<span class="my-code" decode="exclude">x + x * x</span>—as a BASIC expres­sion. We con­vert the string into a port with <span class="my-code" decode="exclude">open-input-string</span>. Then, as we do in our reader, we pass the port to our tok­enizer, and then a parser. But this time, rather than using <span class="my-code" decode="exclude">parse</span>, we gen­er­ate a parser from the <span class="my-code" decode="exclude">b-sum</span> rule in our gram­mar:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ElSzM&quot;)"></div><div class="highlight-container" id="a_ElSzM"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(require brag/support basic/parser basic/tokenizer)<br/>(define source (open-input-string "x + x * x"))<br/>(define sum-parser (make-rule-parser b-sum))<br/>(define sum-parse-tree (sum-parser (make-tokenizer source)))<br/>(syntax-&gt;datum sum-parse-tree)</div><div class="highlight" form="false" id="a_5sT01"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span> <span class="n">basic/parser</span> <span class="n">basic/tokenizer</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">source</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a></span> <span class="s2">"x + x * x"</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">sum-parser</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/examples/nested-word-list..rkt)._make-rule-parser))" class="docs" hyphens="none">make-rule-parser</a></span> <span class="n">b-sum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">sum-parse-tree</span> <span class="p">(</span><span class="n">sum-parser</span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">source</span><span class="p">)))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3edatum))" class="docs" hyphens="none">syntax-&gt;datum</a></span> <span class="n">sum-parse-tree</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mlfzy&quot;)"></div><p id="a_mlfzy">The result, instead of a whole BASIC pro­gram, is a parse tree that starts at a <span class="my-code" decode="exclude">b-sum</span> node:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Z1BnM&quot;)"></div><div class="highlight-container" id="a_Z1BnM"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(b-sum<br/>  (b-sum (b-product (b-neg (b-expt x))))<br/>  "+"<br/>  (b-product (b-product (b-neg (b-expt x)))<br/>             "*"<br/>             (b-neg (b-expt x))))</div><div class="highlight" form="false" id="a_Osj31"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>&#39;(b-sum
  (b-sum (b-product (b-neg (b-expt x))))
  "+"
  (b-product (b-product (b-neg (b-expt x)))
             "*"
             (b-neg (b-expt x))))
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FOH4d&quot;)"></div><p id="a_FOH4d">If we remove the triv­ial one-argu­ment expres­sions, we’re left with this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wLzFH&quot;)"></div><div class="highlight-container" id="a_wLzFH"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(b-sum x "+" (b-product x "*" x))</div><div class="highlight" form="false" id="a_LjzVJ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&#39;(b-sum x "+" (b-product x "*" x))
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KfYAj&quot;)"></div><p id="a_KfYAj">This is the same as the parse-tree ver­sion of this expres­sion we cal­cu­lated by hand ear­lier. Best of all, we didn’t have to write any­thing new—we just reused our exist­ing tok­enizer and <span class="my-code" decode="exclude">brag</span> mod­ules.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PcAIr&quot;)"></div><p id="a_PcAIr">As a lan­guage reader, this parser wouldn’t be much use, because it can’t parse a whole pro­gram—just a sum expers­sion. But as a REPL reader, it’s get­ting closer what we need.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;parser-updates&quot;)"></div><h3 anchor="parser-updates" class="subhead" id="parser-updates"><a href="#parser-updates">Parser updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sRSWH&quot;)"></div><p id="a_sRSWH">Now that we know how to gen­er­ate a parser for any rule, we have a choice:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3q9yr&quot;)"></div><p id="a_3q9yr">We can base our REPL reader on an exist­ing rule—<span class="my-code" decode="exclude">b-expr</span> or <span class="my-code" decode="exclude">b-statement</span> would be good options.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BpLK5&quot;)"></div><p id="a_BpLK5">Or, if we want to be more gen­er­ous about what kind of expres­sions our new REPL will han­dle, we can add a spe­cial REPL rule to our parser gram­mar.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7Y5si&quot;)"></div><p id="a_7Y5si">That’s the more flex­i­ble approach, so we’ll do it that way. At the bot­tom of <span class="my-code" decode="exclude">"parse.rkt"</span>, let’s add a new rule called <span class="my-code" decode="exclude">b-repl</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/parser.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_G1iaE&quot;)"></div><div class="highlight-container" id="a_G1iaE"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>b-program : [b-line] (/NEWLINE [b-line])*<br/>b-line : b-line-num [b-statement] (/":" [b-statement])* [b-rem]<br/>@b-line-num : INTEGER<br/>b-rem : REM<br/>@b-statement : b-end | b-print | b-goto<br/>             | b-let | b-input | b-if<br/>             | b-gosub | b-return | b-for | b-next<br/>             | b-def | b-import | b-export<br/>b-end : /"end"<br/>b-print : /"print" [b-printable] (/";" [b-printable])*<br/>@b-printable : STRING | b-expr<br/>b-goto : /"goto" b-expr<br/>b-let : [/"let"] b-id /"=" (STRING | b-expr)<br/>b-if : /"if" b-expr /"then" (b-statement | b-expr)<br/>                   [/"else" (b-statement | b-expr)]<br/>b-input : /"input" b-id<br/>@b-id : ID<br/>b-gosub : /"gosub" b-expr<br/>b-return : /"return"<br/>b-for : /"for" b-id /"=" b-expr /"to" b-expr [/"step" b-expr]<br/>b-next : /"next" b-id<br/>b-def : /"def" b-id /"(" b-id [/"," b-id]* /")" /"=" b-expr<br/>b-import : /"import" b-import-name<br/>@b-import-name : RACKET-ID | STRING<br/>b-export : /"export" b-export-name<br/>@b-export-name : ID<br/>b-expr : b-or-expr<br/>b-or-expr : [b-or-expr "or"] b-and-expr<br/>b-and-expr : [b-and-expr "and"] b-not-expr<br/>b-not-expr : ["not"] b-comp-expr<br/>b-comp-expr : [b-comp-expr ("="|"&lt;"|"&gt;"|"&lt;&gt;")] b-sum<br/>b-sum : [b-sum ("+"|"-")] b-product<br/>b-product : [b-product ("*"|"/"|"mod")] b-neg<br/>b-neg : ["-"] b-expt<br/>b-expt : [b-expt ("^")] b-value<br/>@b-value : b-number | b-id | /"(" b-expr /")" | b-func<br/>b-func : ID /"(" b-expr [/"," b-expr]* /")"<br/>@b-number : INTEGER | DECIMAL<br/>b-repl : (b-statement | b-expr) (/":" [@b-repl])*</div><div class="highlight" form="false" id="a_bhNdE"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="source"><pre>#lang brag
b-program : [b-line] (/NEWLINE [b-line])*
b-line : b-line-num [b-statement] (/":" [b-statement])* [b-rem]
@b-line-num : INTEGER
b-rem : REM
@b-statement : b-end | b-print | b-goto
             | b-let | b-input | b-if
             | b-gosub | b-return | b-for | b-next
             | b-def | b-import | b-export
b-end : /"end"
b-print : /"print" [b-printable] (/";" [b-printable])*
@b-printable : STRING | b-expr
b-goto : /"goto" b-expr
b-let : [/"let"] b-id /"=" (STRING | b-expr)
b-if : /"if" b-expr /"then" (b-statement | b-expr)
                   [/"else" (b-statement | b-expr)]
b-input : /"input" b-id
@b-id : ID
b-gosub : /"gosub" b-expr
b-return : /"return"
b-for : /"for" b-id /"=" b-expr /"to" b-expr [/"step" b-expr]
b-next : /"next" b-id
b-def : /"def" b-id /"(" b-id [/"," b-id]* /")" /"=" b-expr
b-import : /"import" b-import-name
@b-import-name : RACKET-ID | STRING
b-export : /"export" b-export-name
@b-export-name : ID
b-expr : b-or-expr
b-or-expr : [b-or-expr "or"] b-and-expr
b-and-expr : [b-and-expr "and"] b-not-expr
b-not-expr : ["not"] b-comp-expr
b-comp-expr : [b-comp-expr ("="|"&lt;"|"&gt;"|"&lt;&gt;")] b-sum
b-sum : [b-sum ("+"|"-")] b-product
b-product : [b-product ("*"|"/"|"mod")] b-neg
b-neg : ["-"] b-expt
b-expt : [b-expt ("^")] b-value
@b-value : b-number | b-id | /"(" b-expr /")" | b-func
b-func : ID /"(" b-expr [/"," b-expr]* /")"
@b-number : INTEGER | DECIMAL
<span class="hll">b-repl : (b-statement | b-expr) (/":" [@b-repl])*
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pNjGx&quot;)"></div><p id="a_pNjGx">This new REPL rule will accept BASIC state­ments (like <span class="my-code" decode="exclude">print 24 * x</span>) or raw BASIC expres­sions (like <span class="my-code" decode="exclude">24 * x</span>). Fol­low­ing the con­ven­tion in BASIC lines, we allow mul­ti­ple inputs on the REPL to be chained together with <span class="my-code" decode="exclude">:</span> (which we express with a spliced, recur­sive ref­er­ence to the <span class="my-code" decode="exclude">b-repl</span> rule).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fCDsE&quot;)"></div><p id="a_fCDsE">Would it make sense to carve out cer­tain state­ments from our REPL pat­tern? Our REPL expres­sions will be eval­u­ated as if they were in the top level of our lan­guage mod­ule. They will not, how­ever, be eval­u­ated as if they were hap­pen­ing dur­ing the <span class="my-code" decode="exclude">run</span> loop. That means that cer­tain state­ments on the REPL—like <span class="my-code" decode="exclude">goto</span> and <span class="my-code" decode="exclude">gosub</span>—will be invalid, because they don’t mean any­thing out­side of the con­text of the <span class="my-code" decode="exclude">run</span> loop.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2xGIZ&quot;)"></div><p id="a_2xGIZ">But if we carve them out here, then they’ll trig­ger a pars­ing error. That might be con­fus­ing to a user. Instead, we let them all through now, and han­dle the invalid ones in the expander, where we can raise a more infor­ma­tive error.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;setup-module-updates&quot;)"></div><h3 anchor="setup-module-updates" class="subhead" id="setup-module-updates"><a href="#setup-module-updates">Setup mod­ule updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iZnKf&quot;)"></div><p id="a_iZnKf">In <span class="my-code" decode="exclude">"setup.rkt"</span>, we attach our new parser to the REPL. Just as we do in our main reader mod­ule, we start by import­ing <span class="my-code" decode="exclude">"parser.rkt"</span> and <span class="my-code" decode="exclude">"tokenizer.rkt"</span>. We also define a <span class="my-code" decode="exclude">repl-parse</span> func­tion based on our new <span class="my-code" decode="exclude">b-repl</span> parser rule:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/setup.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Hy8jn&quot;)"></div><div class="highlight-container" id="a_Hy8jn"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "parser.rkt" "tokenizer.rkt")<br/>(provide basic-output-port do-setup!)<br/><br/>(define basic-output-port<br/>  (make-parameter (open-output-nowhere)))<br/><br/>(define repl-parse (make-rule-parser b-repl))<br/><br/>(define (do-setup! [where #f])<br/>  (basic-output-port (current-output-port)))</div><div class="highlight" form="false" id="a_OoSom"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"parser.rkt"</span> <span class="s2">"tokenizer.rkt"</span><span class="p">)</span>
</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">basic-output-port</span> <span class="n">do-setup!</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">basic-output-port</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/parameters.html#(def._((quote._~23~25kernel)._make-parameter))" class="docs" hyphens="none">make-parameter</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._open-output-nowhere))" class="docs" hyphens="none">open-output-nowhere</a></span><span class="p">)))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">repl-parse</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/examples/nested-word-list..rkt)._make-rule-parser))" class="docs" hyphens="none">make-rule-parser</a></span> <span class="n">b-repl</span><span class="p">))</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">do-setup!</span> <span class="p">[</span><span class="n">where</span> <span class="no">#f</span><span class="p">])</span>
  <span class="p">(</span><span class="n">basic-output-port</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._current-output-port))" class="docs" hyphens="none">current-output-port</a></span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lTRFZ&quot;)"></div><p id="a_lTRFZ">To do its job, the REPL relies on a spe­cial <a class="glossary" href="../appendix/glossary.html#parameter"><span class="glossary-link-text">para­me­ter</span></a> called <a href="http://docs.racket-lang.org/reference/eval.html#(def._((quote._~23~25kernel)._current-read-interaction))" class="docs" hyphens="none">current-read-interaction</a>. This para­me­ter holds a read-inter­ac­tion func­tion that’s respon­si­ble for tak­ing the input from the REPL and chunk­ing it into syn­tax objects to eval­u­ate. The REPL calls this read-inter­ac­tion func­tion repeat­edly to get new syn­tax objects. When the read-inter­ac­tion func­tion returns <span class="my-code" decode="exclude">eof</span>, the REPL stops (mean­ing, con­trol returns to the user at the REPL prompt).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7Eawt&quot;)"></div><p id="a_7Eawt">The read-inter­ac­tion func­tion takes two argu­ments: a <span class="my-code" decode="exclude">port</span>, which holds the text input from the REPL, and an <span class="my-code" decode="exclude">origin</span> value (that osten­si­bly describes where the <span class="my-code" decode="exclude">port</span> came from, but we shouldn’t rely on it to con­tain use­ful infor­ma­tion). Because each user com­mand on the REPL ends with a new­line, the con­tents of the port will be a new­line-ter­mi­nated string. So if the user enters this at the REPL prompt:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KiqKO&quot;)"></div><div class="highlight-container" id="a_KiqKO"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; print 42 : x + x * x : 25</div><div class="highlight" form="false" id="a_Rfg2a"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; print 42 : x + x * x : 25
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IYPEt&quot;)"></div><p id="a_IYPEt">The port passed to the read-inter­ac­tion func­tion will con­tain this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MFUEb&quot;)"></div><div class="highlight-container" id="a_MFUEb"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">"print 42 : x + x * x : 25\n"</div><div class="highlight" form="false" id="a_Rkeai"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>"print 42 : x + x * x : 25\n"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_A999C&quot;)"></div><p id="a_A999C">When­ever we want our REPL to behave dif­fer­ently, we need to set the <span class="my-code" decode="exclude">current-read-interaction</span> para­me­ter to use a new read-inter­ac­tion func­tion. In this case, we call our new func­tion <span class="my-code" decode="exclude">read-one-line</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0WM65&quot;)"></div><div class="highlight-container" id="a_0WM65"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (read-one-line origin port)<br/>  (define one-line (read-line port))<br/>  (if (eof-object? one-line)<br/>      eof<br/>      (repl-parse<br/>       (make-tokenizer (open-input-string one-line)))))</div><div class="highlight" form="false" id="a_vckdC"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">read-one-line</span> <span class="n">origin</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">one-line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof-object~3f))" class="docs" hyphens="none">eof-object?</a></span> <span class="n">one-line</span><span class="p">)</span>
      <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span>
      <span class="p">(</span><span class="n">repl-parse</span>
       <span class="p">(</span><span class="n">make-tokenizer</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a></span> <span class="n">one-line</span><span class="p">)))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkn" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rCqGm&quot;)"></div><p id="a_rCqGm">When the REPL calls <span class="my-code" decode="exclude">read-one-line</span> the first time, it will read the first (and only) new­line-ter­mi­nated string in the <span class="my-code" decode="exclude">port</span> using <a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a>. We con­vert this string into a new port with <a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a>, pass this port to <span class="my-code" decode="exclude">make-tokenizer</span>, and  this tok­enizer to <span class="my-code" decode="exclude">repl-parse</span>, which will turn it into a parsed syn­tax object.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_q2DRq&quot;)"></div><p id="a_q2DRq">When the REPL calls <span class="my-code" decode="exclude">read-one-line</span> a sec­ond time, we get an <a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof-object~3f))" class="docs" hyphens="none">eof-object?</a> from <span class="my-code" decode="exclude">read-line</span>—because there’s only going to be one new­line-ter­mi­nated string in <span class="my-code" decode="exclude">port</span>—and we return <span class="my-code" decode="exclude">eof</span>, which will stop the REPL.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CBF0l&quot;)"></div><p id="a_CBF0l">This lit­tle <span class="my-code" decode="exclude">eof</span> fan­dango may seem silly. But the REPL doesn’t make any assump­tions about how input cor­re­sponds to syn­tax objects. That’s why we have to do this by hand. It’s sim­i­lar to how we always include an <span class="my-code" decode="exclude">eof</span> rule in a <a class="glossary" href="../appendix/glossary.html#lexer"><span class="glossary-link-text">lexer</span></a>. Actu­ally, if we wanted, we could imple­ment <span class="my-code" decode="exclude">read-one-line</span> using <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_K9dyR&quot;)"></div><div class="highlight-container" id="a_K9dyR"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (read-one-line origin port)<br/>  (define repl-lexer<br/>    (lexer<br/>     [(eof) eof]<br/>     [(from/to any-char "\n")<br/>      (repl-parse<br/>       (make-tokenizer<br/>        (open-input-string (string-trim lexeme))))]))<br/>  (repl-lexer port))</div><div class="highlight" form="false" id="a_pQL3j"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">read-one-line</span> <span class="n">origin</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">repl-lexer</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
     <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
     <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._any-char))" class="docs" hyphens="none">any-char</a></span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
      <span class="p">(</span><span class="n">repl-parse</span>
       <span class="p">(</span><span class="n">make-tokenizer</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))))]))</span>
  <span class="p">(</span><span class="n">repl-lexer</span> <span class="n">port</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ykv8R&quot;)"></div><p id="a_Ykv8R">Both ver­sions will do the same thing. But we’ll stick with the first one—in this case, <span class="my-code" decode="exclude">read-line</span> takes care of the house­keep­ing more neatly than <span class="my-code" decode="exclude">lexer</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MKIU2&quot;)"></div><p id="a_MKIU2">By the way, unlike our main <span class="my-code" decode="exclude">read-syntax</span> func­tion, we don’t need to pass around an extra path argu­ment to the tok­enizer and parser. We only needed that when we wanted to gen­er­ate source loca­tions. In the REPL, we can ignore them.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NbuHL&quot;)"></div><p id="a_NbuHL">To com­plete the REPL setup, we go inside <span class="my-code" decode="exclude">do-setup!</span> and reset the <span class="my-code" decode="exclude">current-read-interaction</span> to use our new <span class="my-code" decode="exclude">read-one-line</span> func­tion. We remem­ber that <span class="my-code" decode="exclude">do-setup!</span> is called by our <span class="my-code" decode="exclude">configure-runtime</span> sub­mod­ule. So when we run a BASIC pro­gram directly, the <span class="my-code" decode="exclude">configure-runtime</span> sub­mod­ule will be trig­gered, and our REPL will be repro­grammed to use our <span class="my-code" decode="exclude">read-one-line</span> func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_F5Mpo&quot;)"></div><p id="a_F5Mpo">The fin­ished <span class="my-code" decode="exclude">"setup.rkt"</span> mod­ule looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/setup.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vm2I5&quot;)"></div><div class="highlight-container" id="a_Vm2I5"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "parser.rkt" "tokenizer.rkt")<br/>(provide basic-output-port do-setup!)<br/><br/>(define basic-output-port<br/>  (make-parameter (open-output-nowhere)))<br/><br/>(define repl-parse (make-rule-parser b-repl))<br/><br/>(define (read-one-line origin port)<br/>  (define one-line (read-line port))<br/>  (if (eof-object? one-line)<br/>      eof<br/>      (repl-parse<br/>       (make-tokenizer (open-input-string one-line)))))<br/><br/>(define (do-setup! [where #f])<br/>  (basic-output-port (current-output-port))<br/>  (current-read-interaction read-one-line))</div><div class="highlight" form="false" id="a_LLD4R"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"parser.rkt"</span> <span class="s2">"tokenizer.rkt"</span><span class="p">)</span>
</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">basic-output-port</span> <span class="n">do-setup!</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">basic-output-port</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/parameters.html#(def._((quote._~23~25kernel)._make-parameter))" class="docs" hyphens="none">make-parameter</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._open-output-nowhere))" class="docs" hyphens="none">open-output-nowhere</a></span><span class="p">)))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">repl-parse</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/examples/nested-word-list..rkt)._make-rule-parser))" class="docs" hyphens="none">make-rule-parser</a></span> <span class="n">b-repl</span><span class="p">))</span>
</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">read-one-line</span> <span class="n">origin</span> <span class="n">port</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">one-line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a></span> <span class="n">port</span><span class="p">))</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof-object~3f))" class="docs" hyphens="none">eof-object?</a></span> <span class="n">one-line</span><span class="p">)</span>
</span><span class="hll">      <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span>
</span><span class="hll">      <span class="p">(</span><span class="n">repl-parse</span>
</span><span class="hll">       <span class="p">(</span><span class="n">make-tokenizer</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a></span> <span class="n">one-line</span><span class="p">)))))</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">do-setup!</span> <span class="p">[</span><span class="n">where</span> <span class="no">#f</span><span class="p">])</span>
  <span class="p">(</span><span class="n">basic-output-port</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._current-output-port))" class="docs" hyphens="none">current-output-port</a></span><span class="p">))</span>
<span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/eval.html#(def._((quote._~23~25kernel)._current-read-interaction))" class="docs" hyphens="none">current-read-interaction</a></span> <span class="n">read-one-line</span><span class="p">))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkp" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;expander-updates&quot;)"></div><h3 anchor="expander-updates" class="subhead" id="expander-updates"><a href="#expander-updates">Expander updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Diob3&quot;)"></div><p id="a_Diob3">Because we chose to cre­ate a new <span class="my-code" decode="exclude">b-repl</span> rule in the parser, we also have to imple­ment it in the expander. We add a <span class="my-code" decode="exclude">b-repl</span> macro to <span class="my-code" decode="exclude">"misc.rkt"</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/misc.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JhZ8w&quot;)"></div><div class="highlight-container" id="a_JhZ8w"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "struct.rkt")<br/>(provide b-rem b-print b-let b-input b-import b-export b-repl)<br/><br/>(define (b-rem val) (void))<br/><br/>(define (b-print . vals)<br/>  (displayln (string-append* (map ~a vals))))<br/><br/>(define-macro (b-let ID VAL) #'(set! ID VAL))<br/><br/>(define-macro (b-input ID)<br/>  #'(b-let ID (let* ([str (read-line)]<br/>                     [num (string-&gt;number (string-trim str))])<br/>                (or num str))))<br/><br/>(define-macro (b-import NAME) #'(void))<br/><br/>(define-macro (b-export NAME) #'(void))<br/><br/>(define-macro (b-repl . ALL-INPUTS)<br/>  (with-pattern ([INPUTS ···])<br/>    #'(begin . INPUTS)))</div><div class="highlight" form="false" id="a_Qc2bZ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span><span class="p">)</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">b-rem</span> <span class="n">b-print</span> <span class="n">b-let</span> <span class="n">b-input</span> <span class="n">b-import</span> <span class="n">b-export</span> <span class="n">b-repl</span><span class="p">)</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-rem</span> <span class="n">val</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">vals</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-append*))" class="docs" hyphens="none">string-append*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" class="docs" hyphens="none">map</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/format..rkt)._~7ea))" class="docs" hyphens="none">~a</a></span> <span class="n">vals</span><span class="p">))))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-input</span> <span class="n">ID</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" class="docs" hyphens="none">let*</a></span> <span class="p">([</span><span class="n">str</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a></span><span class="p">)]</span>
                     <span class="p">[</span><span class="n">num</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="n">str</span><span class="p">))])</span>
                <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="n">num</span> <span class="n">str</span><span class="p">))))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-import</span> <span class="n">NAME</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-export</span> <span class="n">NAME</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-repl</span> <span class="o">.</span> <span class="n">ALL-INPUTS</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span> <span class="p">([</span><span class="n">INPUTS</span> <span class="n">···</span><span class="p">])</span>
</span><span class="hll">    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span> <span class="o">.</span> <span class="n">INPUTS</span><span class="p">)))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4V9PJ&quot;)"></div><p id="a_4V9PJ">In the <span class="my-code" decode="exclude">b-repl</span> macro, we’re intro­duc­ing some syn­tax-pat­tern nota­tion we haven’t used before. The dot <span class="my-code" decode="exclude">.</span> is like a <a class="glossary" href="../appendix/glossary.html#rest-argument"><span class="glossary-link-text">rest argu­ment</span></a> for syn­tax pat­terns. It means “col­lect the rest of the syn­tax ele­ments in this pat­tern vari­able”. It’s an alter­na­tive to an ellip­sis <span class="my-code" decode="exclude">...</span> for match­ing mul­ti­ple items. So these two pat­terns are the same:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ekqli&quot;)"></div><div class="highlight-container" id="a_ekqli"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">(b-repl EACH-INPUT ...)<br/>(b-repl . ALL-INPUTS)</div><div class="highlight" form="false" id="a_gpDza"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">b-repl</span> <span class="n">EACH-INPUT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
<span class="p">(</span><span class="n">b-repl</span> <span class="o">.</span> <span class="n">ALL-INPUTS</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2E2zI&quot;)"></div><p id="a_2E2zI">One dif­fer­ence is that like a rest argu­ment, the dot can only be used at the tail of a pat­tern. An ellip­sis can be used any­where.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5NnsW&quot;)"></div><p id="a_5NnsW">Another dif­fer­ence comes when we use the result­ing pat­tern vari­able in a syn­tax tem­plate. A pat­tern vari­able cre­ated with a dot, like <span class="my-code" decode="exclude">ALL-INPUTS</span>, rep­re­sents a self-con­tained list of syn­tax objects. If we want to com­bine it with another ele­ment, it has to appear at the end of a paren­the­sized expres­sion in the syn­tax tem­plate, and we use another dot <span class="my-code" decode="exclude">.</span> as a con­nec­tor.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_55nYq&quot;)"></div><p id="a_55nYq"><span class="my-code" decode="exclude">EACH-INPUT</span>, by con­trast, rep­re­sents the first ele­ment of a list of syn­tax objects, and the accom­pa­ny­ing <span class="my-code" decode="exclude">...</span> rep­re­sents the rest. So these syn­tax tem­plates are equiv­a­lent:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kIqXD&quot;)"></div><div class="highlight-container" id="a_kIqXD"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">#'(apply + (list EACH-INPUT ...))<br/>#'(apply + (list . ALL-INPUTS))</div><div class="highlight" form="false" id="a_qtxZq"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">EACH-INPUT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
<span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">.</span> <span class="n">ALL-INPUTS</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpks" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vMmC0&quot;)"></div><p id="a_vMmC0">A lim­i­ta­tion of the dot is that it doesn’t offer the step-and-repeat behav­ior that the ellip­sis does. For instance, this expres­sion will mul­ti­ply <span class="my-code" decode="exclude">EACH-INPUT</span> by <span class="my-code" decode="exclude">42</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_urkLl&quot;)"></div><div class="highlight-container" id="a_urkLl"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">#'(list (* 42 EACH-INPUT) ...))</div><div class="highlight" form="false" id="a_jeyN5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">42</span> <span class="n">EACH-INPUT</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span><span class="err">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkt" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GjTUi&quot;)"></div><p id="a_GjTUi">But in macros where we’re not using this behav­ior, the dot can make our tem­plates and pat­terns tidier. It’s an option, not a require­ment. For fur­ther details, see <a class="explainer" href="../explainer/syntax-patterns.html">syn­tax pat­terns</a>.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fXOJL&quot;)"></div><p id="a_fXOJL">We still need to fill in the inte­rior of the <span class="my-code" decode="exclude">b-repl</span> macro. When we made the <span class="my-code" decode="exclude">b-repl</span> parser rule, we decided to per­mit every kind of state­ment and expres­sion as input, even the ones that didn’t make sense in a REPL con­text, and sort through them later.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qDFor&quot;)"></div><p id="a_qDFor">That time has come. The main work of the <span class="my-code" decode="exclude">b-repl</span> macro will be to take a list of <span class="my-code" decode="exclude">ALL-INPUTS</span> and win­now it to a list of valid <span class="my-code" decode="exclude">INPUTS</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GTqcR&quot;)"></div><p id="a_GTqcR">So which inputs make sense on the REPL? Prob­a­bly just these:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0Pxoi&quot;)"></div><p id="a_0Pxoi"><span class="my-code" decode="exclude">print</span> state­ments should do their usual thing.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uDOBg&quot;)"></div><p id="a_uDOBg">BASIC expres­sions should be printed.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DpzNI&quot;)"></div><p id="a_DpzNI"><span class="my-code" decode="exclude">let</span> state­ments should intro­duce new vari­ables.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sOLWF&quot;)"></div><p id="a_sOLWF"><span class="my-code" decode="exclude">def</span> state­ments should intro­duce new func­tions.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Wpris&quot;)"></div><p id="a_Wpris">All the other state­ments—includ­ing <span class="my-code" decode="exclude">goto</span>, <span class="my-code" decode="exclude">gosub</span>, and <span class="my-code" decode="exclude">for</span> / <span class="my-code" decode="exclude">next</span>—only make sense in the con­text of a run­ning pro­gram. So we just raise an error if we see any of these.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Brcxp&quot;)"></div><p id="a_Brcxp">To process our list of <span class="my-code" decode="exclude">ALL-INPUTS</span>, we use a syn­tax helper func­tion called <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a>. This is a like a hybrid of <a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a> and <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._filter))" class="docs" hyphens="none">filter</a>. It tries to match each ele­ment in a list of syn­tax objects to one or more pat­tern clauses. If a pat­tern matches, the syn­tax tem­plate on the right side is returned. If no pat­tern matches, or the right-side result is <span class="my-code" decode="exclude">#f</span>, the ele­ment is omit­ted. The result of <span class="my-code" decode="exclude">pattern-case-filter</span> is a new (and pos­si­bly shorter) list of syn­tax objects.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WLgjP&quot;)"></div><p id="a_WLgjP">Let’s start our <span class="my-code" decode="exclude">pattern-case-filter</span> with a rule to match <span class="my-code" decode="exclude">print</span> state­ments. We want to just pass these through. So our syn­tax pat­tern will match input items that begin with <span class="my-code" decode="exclude">b-print</span>, and just emit a result that’s the same as the input:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EUni4&quot;)"></div><div class="highlight-container" id="a_EUni4"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">(pattern-case-filter #'ALL-INPUTS<br/>  [(b-print . PRINT-ARGS)<br/>   #'(b-print . PRINT-ARGS)]<br/>   ···)</div><div class="highlight" form="false" id="a_hP6py"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a></span> <span class="o">#&#39;</span><span class="n">ALL-INPUTS</span>
  <span class="p">[(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)]</span>
   <span class="n">···</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpku" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WjlcM&quot;)"></div><p id="a_WjlcM">Next are BASIC expres­sions. These will come through as <span class="my-code" decode="exclude">b-expr</span> items. We want to print these, so we wrap them in a <span class="my-code" decode="exclude">b-print</span> expres­sion. In other words, every raw BASIC expres­sion <span class="my-code" decode="exclude">ex</span> will behave as if we typed <span class="my-code" decode="exclude">print ex</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_begQG&quot;)"></div><div class="highlight-container" id="a_begQG"><div id="code_70" form="false" decode="exclude" style="font-size:0;width:0;height:0">(pattern-case-filter #'ALL-INPUTS<br/>  [(b-print . PRINT-ARGS)<br/>   #'(b-print . PRINT-ARGS)]<br/>  [(b-expr . EXPR-ARGS)<br/>   #'(b-print (b-expr . EXPR-ARGS))]<br/>   ···)</div><div class="highlight" form="false" id="a_hvSDn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a></span> <span class="o">#&#39;</span><span class="n">ALL-INPUTS</span>
  <span class="p">[(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">b-expr</span> <span class="o">.</span> <span class="n">EXPR-ARGS</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="p">(</span><span class="n">b-expr</span> <span class="o">.</span> <span class="n">EXPR-ARGS</span><span class="p">))]</span>
   <span class="n">···</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkv" data-clipboard-target="#code_70" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tQhs6&quot;)"></div><p id="a_tQhs6">But wait—there’s a trap for the unwary here. We know that an <span class="my-code" decode="exclude">UPPERCASE</span> pat­tern vari­able is a wild­card that matches any value; any­thing else in the syn­tax pat­tern is matched lit­er­ally. When a pat­tern con­tains an iden­ti­fier like <span class="my-code" decode="exclude">b-expr</span>, the notion of “lit­er­ally” means not just the iden­ti­fier’s name but also its <a class="glossary" href="../appendix/glossary.html#binding"><span class="glossary-link-text">bind­ing</span></a>. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Racket jocks might know this as equal­ity in the sense of <a href="http://docs.racket-lang.org/reference/stxcmp.html#(def._((quote._~23~25kernel)._free-identifier~3d~3f))" class="docs" hyphens="none">free-identifier=?</a>.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iEiOF&quot;)"></div><p id="a_iEiOF">Let’s see an exam­ple. Here, <span class="my-code" decode="exclude">prime-stx</span> is a syn­tax object that refers to <span class="my-code" decode="exclude">prime?</span>, a bind­ing from the <span class="my-code" decode="exclude">math/number-theory</span> library. But when we try to match <span class="my-code" decode="exclude">prime-stx</span> to the pat­tern <span class="my-code" decode="exclude">prime?</span>, we get an empty list:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_m4xxr&quot;)"></div><div class="highlight-container" id="a_m4xxr"><div id="code_71" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module mod br<br/>  (require math/number-theory)<br/>  (define prime-stx #'prime?)<br/>  (provide prime-stx))<br/>(require (submod "." mod))<br/><br/>(pattern-case-filter (list prime-stx)<br/>  [prime? 'yay]) ; '()?!</div><div class="highlight" form="false" id="a_Ty3rm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">mod</span> <span class="n">br</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">math/number-theory</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">prime-stx</span> <span class="o">#&#39;</span><span class="n">prime?</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">prime-stx</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._submod))" class="docs" hyphens="none">submod</a></span> <span class="s2">"."</span> <span class="n">mod</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">prime-stx</span><span class="p">)</span>
  <span class="p">[</span><span class="n">prime?</span> <span class="o">&#39;</span><span class="ss">yay</span><span class="p">])</span> <span class="c1">; &#39;()?!</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkw" data-clipboard-target="#code_71" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tgT1Q&quot;)"></div><p id="a_tgT1Q">The prob­lem here is that the lit­eral iden­ti­fier <span class="my-code" decode="exclude">prime?</span> in the syn­tax pat­tern has no bind­ing. So even though the iden­ti­fier names are the same, their bind­ings are not. There­fore, the pat­tern doesn’t match, and the result is the empty list.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_gHsC7&quot;)"></div><p id="a_gHsC7">If we want this pat­tern to work, we have to import <span class="my-code" decode="exclude">math/number-theory</span> so that the syn­tax pat­tern in <span class="my-code" decode="exclude">pattern-case-filter</span> will refer to the same <span class="my-code" decode="exclude">prime?</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_K6xxC&quot;)"></div><div class="highlight-container" id="a_K6xxC"><div id="code_72" form="false" decode="exclude" style="font-size:0;width:0;height:0">(module mod br<br/>  (require math/number-theory)<br/>  (define prime-stx #'prime?)<br/>  (provide prime-stx))<br/>(require (submod "." mod))<br/><br/>(require math/number-theory)<br/>(pattern-case-filter (list prime-stx)<br/>  [prime? 'yay]) ; '(yay)</div><div class="highlight" form="false" id="a_h3EgG"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((quote._~23~25kernel)._module))" class="docs" hyphens="none">module</a></span> <span class="n">mod</span> <span class="n">br</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">math/number-theory</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">prime-stx</span> <span class="o">#&#39;</span><span class="n">prime?</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">prime-stx</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._submod))" class="docs" hyphens="none">submod</a></span> <span class="s2">"."</span> <span class="n">mod</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">math/number-theory</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">prime-stx</span><span class="p">)</span>
  <span class="p">[</span><span class="n">prime?</span> <span class="o">&#39;</span><span class="ss">yay</span><span class="p">])</span> <span class="c1">; &#39;(yay)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkx" data-clipboard-target="#code_72" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GlySO&quot;)"></div><p id="a_GlySO">Com­ing back to <span class="my-code" decode="exclude">b-expr</span>—when we see an parsed ele­ment start­ing with <span class="my-code" decode="exclude">b-expr</span>, it’s not just any <span class="my-code" decode="exclude">b-expr</span>, but the <span class="my-code" decode="exclude">b-expr</span> intro­duced from our <span class="my-code" decode="exclude">"expr.rkt"</span> mod­ule. So if we want to match this par­tic­u­lar <span class="my-code" decode="exclude">b-expr</span>, we need to import <span class="my-code" decode="exclude">"expr.rkt"</span> into this mod­ule: <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">We didn’t have the same pos­si­ble prob­lem with <span class="my-code" decode="exclude">b-print</span> because it’s defined in this mod­ule.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9ypms&quot;)"></div><div class="highlight-container" id="a_9ypms"><div id="code_73" form="false" decode="exclude" style="font-size:0;width:0;height:0">(require "struct.rkt" "expr.rkt")</div><div class="highlight" form="false" id="a_4iPWf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"expr.rkt"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_73" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sOZtB&quot;)"></div><p id="a_sOZtB">Mov­ing on to <span class="my-code" decode="exclude">let</span> and <span class="my-code" decode="exclude">def</span> state­ments. We want to sup­port these because it’s use­ful to be able to cre­ate vari­ables and func­tions on the REPL. But we recall that in our lan­guage imple­men­ta­tion, our vari­ables and func­tions are hoisted to the top of the mod­ule and ini­tial­ized to <span class="my-code" decode="exclude">0</span>. Then the cor­re­spond­ing <span class="my-code" decode="exclude">b-let</span> and <span class="my-code" decode="exclude">b-def</span> macros use <span class="my-code" decode="exclude">set!</span> to change their val­ues. This won’t work on the REPL—we can’t <span class="my-code" decode="exclude">set!</span> a vari­able that hasn’t been cre­ated.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AmuQ5&quot;)"></div><p id="a_AmuQ5">So on the REPL, when we come across a <span class="my-code" decode="exclude">b-let</span> or <span class="my-code" decode="exclude">b-def</span> expres­sion, we rewrite them as ordi­nary <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a> expres­sions:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_T8oQT&quot;)"></div><div class="highlight-container" id="a_T8oQT"><div id="code_74" form="false" decode="exclude" style="font-size:0;width:0;height:0">(pattern-case-filter #'ALL-INPUTS<br/>  [(b-print . PRINT-ARGS)<br/>   #'(b-print . PRINT-ARGS)]<br/>  [(b-expr . EXPR-ARGS)<br/>   #'(b-print (b-expr . EXPR-ARGS))]<br/>  [(b-let ID VAL)<br/>   #'(define ID VAL)]<br/>  [(b-def FUNC-ID VAR-ID ... EXPR)<br/>   #'(define (FUNC-ID VAR-ID ...) EXPR)]<br/>   ···)</div><div class="highlight" form="false" id="a_mzh9t"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a></span> <span class="o">#&#39;</span><span class="n">ALL-INPUTS</span>
  <span class="p">[(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">b-expr</span> <span class="o">.</span> <span class="n">EXPR-ARGS</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="p">(</span><span class="n">b-expr</span> <span class="o">.</span> <span class="n">EXPR-ARGS</span><span class="p">))]</span>
  <span class="p">[(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)]</span>
  <span class="p">[(</span><span class="n">b-def</span> <span class="n">FUNC-ID</span> <span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="n">EXPR</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">FUNC-ID</span> <span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="n">EXPR</span><span class="p">)]</span>
   <span class="n">···</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkz" data-clipboard-target="#code_74" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iVGVT&quot;)"></div><p id="a_iVGVT">Any­thing else should be an error. So we add one more case to our <span class="my-code" decode="exclude">pattern-case-filter</span>, pop it in the <span class="my-code" decode="exclude">b-repl</span> macro, and the fin­ished <span class="my-code" decode="exclude">"misc.rkt"</span> looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/misc.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_c1G1y&quot;)"></div><div class="highlight-container" id="a_c1G1y"><div id="code_75" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "struct.rkt" "expr.rkt")<br/>(provide b-rem b-print b-let b-input b-import b-export b-repl)<br/><br/>(define (b-rem val) (void))<br/><br/>(define (b-print . vals)<br/>  (displayln (string-append* (map ~a vals))))<br/><br/>(define-macro (b-let ID VAL) #'(set! ID VAL))<br/><br/>(define-macro (b-input ID)<br/>  #'(b-let ID (let* ([str (read-line)]<br/>                     [num (string-&gt;number (string-trim str))])<br/>                (or num str))))<br/><br/>(define-macro (b-import NAME) #'(void))<br/><br/>(define-macro (b-export NAME) #'(void))<br/><br/>(define-macro (b-repl . ALL-INPUTS)<br/>  (with-pattern<br/>      ([INPUTS (pattern-case-filter #'ALL-INPUTS<br/>                 [(b-print . PRINT-ARGS)<br/>                  #'(b-print . PRINT-ARGS)]<br/>                 [(b-expr . EXPR-ARGS)<br/>                  #'(b-print (b-expr . EXPR-ARGS))]<br/>                 [(b-let ID VAL)<br/>                  #'(define ID VAL)]<br/>                 [(b-def FUNC-ID VAR-ID ... EXPR)<br/>                  #'(define (FUNC-ID VAR-ID ...) EXPR)]<br/>                 [ANYTHING-ELSE<br/>                  #'(error 'invalid-repl-input)])])<br/>    #'(begin . INPUTS)))</div><div class="highlight" form="false" id="a_ifJ9B"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"expr.rkt"</span><span class="p">)</span>
</span><span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">b-rem</span> <span class="n">b-print</span> <span class="n">b-let</span> <span class="n">b-input</span> <span class="n">b-import</span> <span class="n">b-export</span> <span class="n">b-repl</span><span class="p">)</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-rem</span> <span class="n">val</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">vals</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-append*))" class="docs" hyphens="none">string-append*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" class="docs" hyphens="none">map</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/format..rkt)._~7ea))" class="docs" hyphens="none">~a</a></span> <span class="n">vals</span><span class="p">))))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-input</span> <span class="n">ID</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" class="docs" hyphens="none">let*</a></span> <span class="p">([</span><span class="n">str</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a></span><span class="p">)]</span>
                     <span class="p">[</span><span class="n">num</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="n">str</span><span class="p">))])</span>
                <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="n">num</span> <span class="n">str</span><span class="p">))))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-import</span> <span class="n">NAME</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-export</span> <span class="n">NAME</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-repl</span> <span class="o">.</span> <span class="n">ALL-INPUTS</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span>
</span><span class="hll">      <span class="p">([</span><span class="n">INPUTS</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._pattern-case-filter))" class="docs" hyphens="none">pattern-case-filter</a></span> <span class="o">#&#39;</span><span class="n">ALL-INPUTS</span>
</span><span class="hll">                 <span class="p">[(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)</span>
</span><span class="hll">                  <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">PRINT-ARGS</span><span class="p">)]</span>
</span><span class="hll">                 <span class="p">[(</span><span class="n">b-expr</span> <span class="o">.</span> <span class="n">EXPR-ARGS</span><span class="p">)</span>
</span><span class="hll">                  <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-print</span> <span class="p">(</span><span class="n">b-expr</span> <span class="o">.</span> <span class="n">EXPR-ARGS</span><span class="p">))]</span>
</span><span class="hll">                 <span class="p">[(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)</span>
</span><span class="hll">                  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)]</span>
</span><span class="hll">                 <span class="p">[(</span><span class="n">b-def</span> <span class="n">FUNC-ID</span> <span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span> <span class="n">EXPR</span><span class="p">)</span>
</span><span class="hll">                  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">FUNC-ID</span> <span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="n">EXPR</span><span class="p">)]</span>
</span><span class="hll">                 <span class="p">[</span><span class="n">ANYTHING-ELSE</span>
</span><span class="hll">                  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._error))" class="docs" hyphens="none">error</a></span> <span class="o">&#39;</span><span class="ss">invalid-repl-input</span><span class="p">)])])</span>
</span><span class="hll">    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span> <span class="o">.</span> <span class="n">INPUTS</span><span class="p">)))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkA" data-clipboard-target="#code_75" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-the-repl&quot;)"></div><h3 anchor="testing-the-repl" class="subhead" id="testing-the-repl"><a href="#testing-the-repl">Test­ing the REPL</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EBns5&quot;)"></div><p id="a_EBns5">Now we’re ready to try out our new REPL. Let’s make a lit­tle pro­gram that defines a func­tion and a vari­able:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">repl-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_aEkiA&quot;)"></div><div class="highlight-container" id="a_aEkiA"><div id="code_76" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 def f(x) = x * x<br/>20 y = 10</div><div class="highlight" form="false" id="a_QfuL3"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">def</span><span class="w"> </span><span class="vg">f</span><span class="p">(</span><span class="vg">x</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">10</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkB" data-clipboard-target="#code_76" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Kfv1D&quot;)"></div><p id="a_Kfv1D">We should be able to eval­u­ate these directly on the REPL:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NRReU&quot;)"></div><div class="highlight-container" id="a_NRReU"><div id="code_77" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; f<br/>#&lt;procedure:f&gt;<br/>&gt; y<br/>10</div><div class="highlight" form="false" id="a_RCraa"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>&gt; f
#&lt;procedure:f&gt;
&gt; y
10
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkC" data-clipboard-target="#code_77" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_eBua3&quot;)"></div><p id="a_eBua3">How about some BASIC-style expres­sions:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hyEjP&quot;)"></div><div class="highlight-container" id="a_hyEjP"><div id="code_78" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; y + y * y<br/>110<br/>&gt; f(y)<br/>100<br/>&gt; f(y) * y<br/>1000<br/>&gt; f(f(y))<br/>10000</div><div class="highlight" form="false" id="a_qfTkB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre>&gt; y + y * y
110
&gt; f(y)
100
&gt; f(y) * y
1000
&gt; f(f(y))
10000
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkD" data-clipboard-target="#code_78" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uFs80&quot;)"></div><p id="a_uFs80">Let’s also try using explicit <span class="my-code" decode="exclude">print</span> state­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rxCPh&quot;)"></div><div class="highlight-container" id="a_rxCPh"><div id="code_79" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; print y + y * y<br/>110<br/>&gt; print f(y)<br/>100<br/>&gt; print f(y) * y<br/>1000<br/>&gt; print f(f(y))<br/>10000<br/>&gt; print y + y * y ; f(y) ; f(y) * y ; f(f(y))<br/>110100100010000</div><div class="highlight" form="false" id="a_Pmn1n"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre>&gt; print y + y * y
110
&gt; print f(y)
100
&gt; print f(y) * y
1000
&gt; print f(f(y))
10000
&gt; print y + y * y ; f(y) ; f(y) * y ; f(f(y))
110100100010000
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkE" data-clipboard-target="#code_79" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZwYGa&quot;)"></div><p id="a_ZwYGa">And colon-sep­a­rated chains of state­ments and expres­sions:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SdaY6&quot;)"></div><div class="highlight-container" id="a_SdaY6"><div id="code_80" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; print y + y * y : f(y) : print f(y) * y : f(f(y))<br/>110<br/>100<br/>1000<br/>10000</div><div class="highlight" form="false" id="a_AtPu7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>&gt; print y + y * y : f(y) : print f(y) * y : f(f(y))
110
100
1000
10000
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkF" data-clipboard-target="#code_80" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5LikR&quot;)"></div><p id="a_5LikR">Now a <span class="my-code" decode="exclude">def</span> and <span class="my-code" decode="exclude">let</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EstVM&quot;)"></div><div class="highlight-container" id="a_EstVM"><div id="code_81" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; def g(i) = 2 * i<br/>&gt; g<br/>#&lt;procedure:g&gt;<br/>&gt; let z = 20<br/>&gt; z<br/>20<br/>&gt; z + y<br/>30<br/>&gt; g(f(z))<br/>800</div><div class="highlight" form="false" id="a_kZOrQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre>&gt; def g(i) = 2 * i
&gt; g
#&lt;procedure:g&gt;
&gt; let z = 20
&gt; z
20
&gt; z + y
30
&gt; g(f(z))
800
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkG" data-clipboard-target="#code_81" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iaH6O&quot;)"></div><p id="a_iaH6O">And finally some bad input:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HFKSt&quot;)"></div><div class="highlight-container" id="a_HFKSt"><div id="code_82" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; goto 10<br/>error: invalid-repl-input</div><div class="highlight" form="false" id="a_ShDKF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>&gt; goto 10
error: invalid-repl-input
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkH" data-clipboard-target="#code_82" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4NTRz&quot;)"></div><p id="a_4NTRz">That took a while, but only because we have such high stan­dards. As with syn­tax col­or­ing and indent­ing, our lan­guage will work fine even if we never improve the REPL. But the REPL is an intrin­sic part of Racket. A small amount of extra effort—adapt­ing the tok­enizer and parser we’ve already made—pays off in a bet­ter lan­guage inter­face.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="functions.html">3&emsp;func­tions</a></li><li><a href="imports.html">4&emsp;imports</a></li><li><a href="exports.html">5&emsp;exports</a></li><li><a class="here" href="the-repl.html">6&emsp;the repl</a></li><li><a href="command-line-arguments.html">7&emsp;com­mand-line argu­ments</a></li><li><a href="recap.html">8&emsp;recap</a></li><li><a href="source-listing.html">9&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="exports.html">← prev</a>
    <a class="nav-right" href="command-line-arguments.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>