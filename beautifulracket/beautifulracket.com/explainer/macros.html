<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/explainer/macros.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:46:55 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Macros</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#explainers">explain­ers</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;macros&quot;)"></div><h1 anchor="macros" id="macros" hyphens="none">Macros</h1></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tjREq&quot;)"></div><p id="a_tjREq">A <em>macro</em> is a spe­cial kind of func­tion that runs at <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a>, con­sum­ing cer­tain code as input and rewrit­ing it as new code. Macros are also known as <em>syn­tax trans­for­m­ers</em>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VwOIc&quot;)"></div><p id="a_VwOIc">For instance, <a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a> is a macro:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oF7ft&quot;)"></div><div class="highlight-container" id="a_oF7ft"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">(and (expr a) (expr b) (expr c))</div><div class="highlight" form="false" id="a_XLJtG"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="p">(</span><span class="n">expr</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">expr</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">expr</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qqlAw&quot;)"></div><p id="a_qqlAw">That rewrites its input like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TW8kq&quot;)"></div><div class="highlight-container" id="a_TW8kq"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">(if (expr a)<br/>    (if (expr b)<br/>        (expr c)<br/>        #f)<br/>    #f)</div><div class="highlight" form="false" id="a_fQFu5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="n">expr</span> <span class="n">a</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="n">expr</span> <span class="n">b</span><span class="p">)</span>
        <span class="p">(</span><span class="n">expr</span> <span class="n">c</span><span class="p">)</span>
        <span class="no">#f</span><span class="p">)</span>
    <span class="no">#f</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TvI7p&quot;)"></div><p id="a_TvI7p">The code result­ing from a macro is called the <em>expan­sion</em> of the macro, because it’s often longer than the input code (though it can be any length).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JsekD&quot;)"></div><p id="a_JsekD">Even though macros are func­tions, it’s con­ven­tional to refer to them strictly as <em>macros</em>, and reserve the term <em>func­tion</em> for the tra­di­tional kind of func­tion that’s eval­u­ated at <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a>. Macros are also called <em>forms</em> (espe­cially in the Racket doc­u­men­ta­tion).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;why-macros&quot;)"></div><h3 anchor="why-macros" class="subhead" id="why-macros"><a href="#why-macros">Why macros?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7OeeB&quot;)"></div><p id="a_7OeeB">Macros are valu­able for two rea­sons:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LBhbo&quot;)"></div><p id="a_LBhbo">At the pro­gram level, macros allow us to imple­ment ideas in code that can’t be achieved with ordi­nary func­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WWX5B&quot;)"></div><p id="a_WWX5B">For instance, let’s fig­ure out how to make <span class="my-code" decode="exclude">report</span>, which prints an expres­sion, and then returns the result of the expres­sion nor­mally.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Aup4n&quot;)"></div><div class="highlight-container" id="a_Aup4n"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">(report (* 1 2 3 4))</div><div class="highlight" form="false" id="a_Acm50"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/debug..rkt)._report))" class="docs" hyphens="none">report</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kaWbI&quot;)"></div><p id="a_kaWbI">Sup­pose <span class="my-code" decode="exclude">report</span> were an ordi­nary func­tion. The expres­sion <span class="my-code" decode="exclude">(* 1 2 3 4)</span> would be eval­u­ated as <span class="my-code" decode="exclude">24</span>, which would become the input to <span class="my-code" decode="exclude">report</span>. But then the orig­i­nal expres­sion couldn’t be printed, because <span class="my-code" decode="exclude">report</span> would never see it. So <span class="my-code" decode="exclude">report</span> can’t be a func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GOjU2&quot;)"></div><p id="a_GOjU2">Whereas if <span class="my-code" decode="exclude">report</span> is a macro, its input includes the lit­eral code <span class="my-code" decode="exclude">(* 1 2 3 4)</span>, which can be manip­u­lated as code:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LOpwO&quot;)"></div><div class="highlight-container" id="a_LOpwO"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (report EXPR)<br/>  #'(begin<br/>      ; EXPR used as literal data<br/>      (displayln (format "input was ~a" 'EXPR))<br/>      EXPR)) ; EXPR used for its result<br/>(report (* 1 2 3 4))</div><div class="highlight" form="false" id="a_SSROv"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/debug..rkt)._report))" class="docs" hyphens="none">report</a></span> <span class="n">EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="c1">; EXPR used as literal data</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._format))" class="docs" hyphens="none">format</a></span> <span class="s2">"input was ~a"</span> <span class="o">&#39;</span><span class="ss">EXPR</span><span class="p">))</span>
      <span class="n">EXPR</span><span class="p">))</span> <span class="c1">; EXPR used for its result</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/debug..rkt)._report))" class="docs" hyphens="none">report</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GXpRa&quot;)"></div><p id="a_GXpRa">Now if we run <span class="my-code" decode="exclude">report</span>, we get the right result:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Aup4n6&quot;)"></div><div class="highlight-container" id="a_Aup4n6"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">(report (* 1 2 3 4))</div><div class="highlight" form="false" id="a_Acm504"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/debug..rkt)._report))" class="docs" hyphens="none">report</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oS6PO&quot;)"></div><div class="highlight-container" id="a_oS6PO"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">input was (* 1 2 3 4)<br/>24</div><div class="highlight" form="false" id="a_8zlUc"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>input was (* 1 2 3 4)
24
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wjZnk&quot;)"></div><p id="a_wjZnk">In this way, macros resem­ble tools like the <a class=" ext" href="http://tigcc.ticalc.org/doc/cpp.html">C pre­pro­ces­sor</a>. But unlike a pre­pro­ces­sor, which usu­ally involves a lim­ited vocab­u­lary of oper­a­tions, a macro can use every­thing in the Racket lan­guage.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6Kxz0&quot;)"></div><p id="a_6Kxz0">Fur­ther­more, macros enforce <a class="explainer" href="hygiene.html">hygiene</a>, which is a set of guar­an­tees about how macro-gen­er­ated code will inter­act with other code. Under­stand­ing hygiene is essen­tial to under­stand­ing macros. See <a class="explainer" href="hygiene.html">hygiene</a>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_o9ECK&quot;)"></div><p id="a_o9ECK">At the com­piler level, macros allow forms to be expressed in terms of pro­gres­sively more prim­i­tive forms, all the way down to a set of <a class="glossary" href="../appendix/glossary.html#core-syntactic-form"><span class="glossary-link-text">core syn­tac­tic forms</span></a>. By only han­dling a <a href="http://docs.racket-lang.org/reference/syntax-model.html#%28part._fully-expanded%29">small set</a> of core syn­tac­tic forms, Racket can com­pile, opti­mize, and eval­u­ate pro­grams more effi­ciently. For instance, we saw that <span class="my-code" decode="exclude">and</span> is expressed in terms of <span class="my-code" decode="exclude">if</span>. In turn, <span class="my-code" decode="exclude">if</span> is a core syn­tac­tic form.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9HnbH&quot;)"></div><p id="a_9HnbH">Within a Racket-imple­mented pro­gram­ming lan­guage, we often use macros within our <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a> to con­vert the forms of our lan­guage into stan­dard Racket forms. But really, we’re just stack­ing more macros atop an exist­ing tower of macros, all of which lead back to the core syn­tac­tic forms.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;interface-and-operation&quot;)"></div><h3 anchor="interface-and-operation" class="subhead" id="interface-and-operation"><a href="#interface-and-operation">Inter­face &amp; oper­a­tion</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_keyFF&quot;)"></div><p id="a_keyFF">Macros are func­tions that take one <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a> as input and return another syn­tax object. These syn­tax objects con­tain lit­eral code, pack­aged with meta­data like lex­i­cal con­text and source loca­tion. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">To get around the lim­ited inter­face, macros can read and write arbi­trary <em>syn­tax prop­er­ties</em> to pass extra meta­data or argu­ments to other macros. See <a class="explainer" href="syntax-objects.html">syn­tax objects</a> for the whole story.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Opq8j&quot;)"></div><p id="a_Opq8j">The syn­tax object passed to a macro con­tains the whole call­ing expres­sion that invoked the macro. So if we invoke <span class="my-code" decode="exclude">and</span> like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oF7fta&quot;)"></div><div class="highlight-container" id="a_oF7fta"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">(and (expr a) (expr b) (expr c))</div><div class="highlight" form="false" id="a_XLJtG8"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="p">(</span><span class="n">expr</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">expr</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">expr</span> <span class="n">c</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0WF3v&quot;)"></div><p id="a_0WF3v"><span class="my-code" decode="exclude">and</span> does not get three argu­ments as input, the way an ordi­nary func­tion would. Rather, it gets a syn­tax object like this, that retains a ref­er­ence to the lex­i­cal con­text of the call­ing site:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_neaFM&quot;)"></div><div class="highlight-container" id="a_neaFM"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">(and #'(and (expr a) (expr b) (expr c)))</div><div class="highlight" form="false" id="a_2nXUe"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>(and #&#39;(and (expr a) (expr b) (expr c)))
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_szHr5&quot;)"></div><p id="a_szHr5">A macro extracts the pieces of the input syn­tax object and rearranges them into new code. Usu­ally this is done with the help of <a class="glossary" href="../appendix/glossary.html#syntax-pattern"><span class="glossary-link-text">syn­tax pat­terns</span></a>, which match these pieces to <a class="glossary" href="../appendix/glossary.html#pattern-variable"><span class="glossary-link-text">pat­tern vari­ables</span></a>. For exam­ple, we could imple­ment <span class="my-code" decode="exclude">and</span> as shown below, using three syn­tax pat­terns to han­dle input cases of zero argu­ments, one argu­ment, and two or more argu­ments. The pat­tern vari­ables are cap­i­tal­ized:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_S37Eb&quot;)"></div><div class="highlight-container" id="a_S37Eb"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases and<br/>  [(and) #'#t]<br/>  [(and COND) #'COND]<br/>  [(and COND OTHER-CONDS ...) #'(if COND<br/>                                    (and OTHER-CONDS ...)<br/>                                    #f)])<br/>(and) ; #t<br/>(and 42) ; 42<br/>(and 42 #f) ; #f<br/>(and 42 #f #t) ; #f</div><div class="highlight" form="false" id="a_aINUi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="no">#t</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="n">COND</span><span class="p">)</span> <span class="o">#&#39;</span><span class="n">COND</span><span class="p">]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="n">COND</span> <span class="n">OTHER-CONDS</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="n">COND</span>
                                    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="n">OTHER-CONDS</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span>
                                    <span class="no">#f</span><span class="p">)])</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span><span class="p">)</span> <span class="c1">; #t</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="mi">42</span><span class="p">)</span> <span class="c1">; 42</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="mi">42</span> <span class="no">#f</span><span class="p">)</span> <span class="c1">; #f</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" class="docs" hyphens="none">and</a></span> <span class="mi">42</span> <span class="no">#f</span> <span class="no">#t</span><span class="p">)</span> <span class="c1">; #f</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2TEV6&quot;)"></div><p id="a_2TEV6">The expres­sion on the right side of each branch is the out­put code for that branch, using <span class="my-code" decode="exclude">#'</span> to pack­age it as a syn­tax object. Ref­er­ences to pat­tern vari­ables are auto­mat­i­cally replaced with the matched item.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZgXuO&quot;)"></div><p id="a_ZgXuO">Unlike nested expres­sions, which are eval­u­ated from the inside out, nested macros are eval­u­ated from the out­side in. This makes it pos­si­ble for macros to gen­er­ate ref­er­ences to other macros, which in turn are expanded. For instance, the third branch of <span class="my-code" decode="exclude">and</span> includes a recur­sive ref­er­ence. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">As with nor­mal func­tions, it’s pos­si­ble to acci­den­tally cre­ate macros with infi­nite recur­sion.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_X6xKk&quot;)"></div><p id="a_X6xKk">Because macros are expanded at com­pile time, they can’t access the run-time mean­ings of the input code (because while the macro is run­ning, those mean­ings have yet to be estab­lished). There­fore, a macro has to han­dle its input argu­ments strictly as syn­tac­tic items.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;why-not-macros&quot;)"></div><h3 anchor="why-not-macros" class="subhead" id="why-not-macros"><a href="#why-not-macros">Why not macros?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2gulT&quot;)"></div><p id="a_2gulT">Macros aren’t a sub­sti­tute for ordi­nary func­tions. Macros are inher­ently more lim­ited:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ATLfM&quot;)"></div><p id="a_ATLfM">They per­form one ser­vice: rewrit­ing code.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Q39z9&quot;)"></div><p id="a_Q39z9">They can only con­sume and return syn­tax objects.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_anlDM&quot;)"></div><p id="a_anlDM">They run at com­pile time, so they can’t know any­thing about the run-time mean­ing of their input.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_A9WfW&quot;)"></div><p id="a_A9WfW">More­over, because macros can rewrite code in arbi­trary ways, they can make code less read­able and pre­dictable. It’s tempt­ing, for instance, to infer that this line of code cre­ates a vari­able named <span class="my-code" decode="exclude">fruit</span> with the value <span class="my-code" decode="exclude">"banana"</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6svU6&quot;)"></div><div class="highlight-container" id="a_6svU6"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define fruit "banana")</div><div class="highlight" form="false" id="a_bhEhf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">fruit</span> <span class="s2">"banana"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vC6nB&quot;)"></div><p id="a_vC6nB">But we’d be assum­ing that in this lan­guage, <span class="my-code" decode="exclude">define</span> has its usual mean­ing. It might not. What if our lan­guage rede­fines <span class="my-code" decode="exclude">define</span> with a macro?</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BqxJm&quot;)"></div><div class="highlight-container" id="a_BqxJm"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (define NAME VALUE)<br/>  #'"orange you glad I didn't say banana?")<br/>(define fruit "banana")</div><div class="highlight" form="false" id="a_PJ0ld"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">NAME</span> <span class="n">VALUE</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="s2">"orange you glad I didn&#39;t say banana?"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">fruit</span> <span class="s2">"banana"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DHjLg&quot;)"></div><p id="a_DHjLg">Early-stage Rack­e­teers are some­times tempted to use macros to avoid learn­ing the idioms of the core Racket library. Why? Because writ­ing macros is fun; learn­ing the library, less fun. But in the long term, it’s a false econ­omy. You’ll want to under­stand Racket idioms because you’ll even­tu­ally need to read other Racket code (and oth­ers will need to read yours).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;mixing-macros-and-functions&quot;)"></div><h3 anchor="mixing-macros-and-functions" class="subhead" id="mixing-macros-and-functions"><a href="#mixing-macros-and-functions">Mix­ing macros &amp; func­tions</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GqOP7&quot;)"></div><p id="a_GqOP7">Macros are pow­er­ful, but they’re not free. Expand­ing a macro is addi­tional work that has to be done at <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a>. A macro cre­ates new code, which then has to be com­piled and inter­preted at <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TC6km&quot;)"></div><p id="a_TC6km">In gen­eral, ordi­nary func­tions have bet­ter per­for­mance char­ac­ter­is­tics. There­fore, some tips for com­bin­ing them effi­ciently:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fQA3O&quot;)"></div><p id="a_fQA3O">Don’t use a macro where a func­tion will work equally well. Save macros for the sit­u­a­tions where a func­tion won’t work.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jE6oF&quot;)"></div><div class="highlight-container" id="a_jE6oF"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (add . XS) #'(apply + (list . XS))) ; no<br/>(define (add . xs) (apply + xs)) ; yes</div><div class="highlight" form="false" id="a_MTi0B"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">add</span> <span class="o">.</span> <span class="n">XS</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="o">.</span> <span class="n">XS</span><span class="p">)))</span> <span class="c1">; no</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">add</span> <span class="o">.</span> <span class="n">xs</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">xs</span><span class="p">))</span> <span class="c1">; yes</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_S32Nv&quot;)"></div><p id="a_S32Nv">Design the macro to emit as lit­tle code as pos­si­ble. Where pos­si­ble, refac­tor code into an exter­nal helper func­tion. (Because of <a class="explainer" href="hygiene.html">hygiene</a>, this is easy to do.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Bua8Q&quot;)"></div><div class="highlight-container" id="a_Bua8Q"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (mac NUM)<br/>  #'(begin<br/>      (displayln 'NUM)<br/>      (if (even? NUM)<br/>          (do-thing NUM)<br/>          (do-other-thing NUM)))) ; no<br/><br/>(define-macro (mac2 NUM)<br/>  #'(begin<br/>      (displayln 'NUM)<br/>      (test-and-do-something NUM))) ; yes<br/><br/>(define (test-and-do-something x)<br/>  (if (even? x)<br/>      (do-thing x)<br/>      (do-other-thing x)))</div><div class="highlight" form="false" id="a_D1BRj"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">mac</span> <span class="n">NUM</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="o">&#39;</span><span class="ss">NUM</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._even~3f))" class="docs" hyphens="none">even?</a></span> <span class="n">NUM</span><span class="p">)</span>
          <span class="p">(</span><span class="n">do-thing</span> <span class="n">NUM</span><span class="p">)</span>
          <span class="p">(</span><span class="n">do-other-thing</span> <span class="n">NUM</span><span class="p">))))</span> <span class="c1">; no</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">mac2</span> <span class="n">NUM</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="o">&#39;</span><span class="ss">NUM</span><span class="p">)</span>
      <span class="p">(</span><span class="n">test-and-do-something</span> <span class="n">NUM</span><span class="p">)))</span> <span class="c1">; yes</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">test-and-do-something</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._even~3f))" class="docs" hyphens="none">even?</a></span> <span class="n">x</span><span class="p">)</span>
      <span class="p">(</span><span class="n">do-thing</span> <span class="n">x</span><span class="p">)</span>
      <span class="p">(</span><span class="n">do-other-thing</span> <span class="n">x</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;further&quot;)"></div><h3 anchor="further" class="subhead" id="further"><a href="#further">Fur­ther</a></h3></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NiLBd&quot;)"></div><p id="a_NiLBd"><span><a href="http://docs.racket-lang.org/guide/macros.html">Macros</a> in the Racket Guide</span></p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kLpuA&quot;)"></div><p id="a_kLpuA"><a class="explainer" href="hygiene.html">Hygiene</a>, a key con­cept for under­stand­ing macros</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3v8cs&quot;)"></div><p id="a_3v8cs"><span><a href="http://docs.racket-lang.org/reference/syntax-model.html">Syn­tax model</a> in the Racket Ref­er­ence</span></p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_z7BXH&quot;)"></div><p id="a_z7BXH"><span><a href="http://docs.racket-lang.org/reference/syntax-model.html#%28part._fully-expanded%29">Fully expanded pro­grams</a> in the Racket Ref­er­ence</span></p></div></li></ul></div>
    <a class="nav-left" href="loops.html">← prev</a>
    <a class="nav-right" href="modules.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>