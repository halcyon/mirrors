<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/jsonic-2/source-locations.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:19 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Level up: jsonic revisited</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;level-up-jsonic-revisited&quot;)"></div><h1 anchor="level-up-jsonic-revisited" id="level-up-jsonic-revisited" hyphens="none">Level up: <span class="my-code" decode="exclude">jsonic</span> revisited</h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="setup.html">2&emsp;setup</a></li><li><a href="contracts.html">3&emsp;con­tracts</a></li><li><a href="unit-tests.html">4&emsp;unit tests</a></li><li><a class="here" href="source-locations.html">5&emsp;source loca­tions</a></li><li><a href="drracket-integration.html">6&emsp;drracket inte­gra­tion</a></li><li><a href="syntax-coloring.html">7&emsp;syn­tax col­or­ing</a></li><li><a href="indenting.html">8&emsp;indent­ing</a></li><li><a href="toolbar-buttons.html">9&emsp;tool­bar but­tons</a></li><li><a href="recap.html">10&emsp;recap</a></li><li><a href="source-listing.html">11&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GX1Hp&quot;)"></div><p id="a_GX1Hp">Before we move into <a href="drracket-integration.html">DrRacket inte­gra­tion</a>, we need to take a short detour to pre­pare our lan­guage.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;introducing-source-locations&quot;)"></div><h3 anchor="introducing-source-locations" class="subhead" id="introducing-source-locations"><a href="#introducing-source-locations">Intro­duc­ing source loca­tions</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hmpVL&quot;)"></div><p id="a_hmpVL">A <em><a class="glossary" href="../appendix/glossary.html#source-location"><span class="glossary-link-text">source loca­tion</span></a></em> is a set of fields that pin­point where an S-expres­sion (or other code) came from within a <a class="glossary" href="../appendix/glossary.html#source-file"><span class="glossary-link-text">source file</span></a>. Source loca­tions are used through­out Racket (as they are in other lan­guages) for var­i­ous tasks. For instance, error reports usu­ally have a source loca­tion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hrBcq&quot;)"></div><div class="highlight-container" id="a_hrBcq"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require rackunit)<br/>(check-true #f)</div><div class="highlight" form="false" id="a_bVcaP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">rackunit</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-true))" class="docs" hyphens="none">check-true</a></span> <span class="no">#f</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Yww7Z&quot;)"></div><div class="highlight-container err" id="a_Yww7Z"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">--------------------<br/>FAILURE<br/>name:       check-true<br/>location:   unsaved-editor:3:0<br/>params:     (#f)<br/>expression: (check-true #f)<br/>--------------------</div><div class="highlight" form="false" id="a_SEGBx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre>--------------------
FAILURE
name:       check-true
location:   unsaved-editor:3:0
params:     (#f)
expression: (check-true #f)
--------------------
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2pKAJ&quot;)"></div><p id="a_2pKAJ">The mes­sage <span class="my-code" decode="exclude">unsaved-editor:3:0</span> tells us that the error occurred in line <span class="my-code" decode="exclude">3</span>, col­umn <span class="my-code" decode="exclude">0</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nZ58o&quot;)"></div><p id="a_nZ58o">Source loca­tions are typ­i­cally tracked as a set of five fields, which can each be <span class="my-code" decode="exclude">#f</span> if the value is unknown, or a num­ber:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xMTlj&quot;)"></div><p id="a_xMTlj">The <em>source ori­gin</em>, which is usu­ally a <a class="glossary" href="../appendix/glossary.html#path"><span class="glossary-link-text">path</span></a> in the filesys­tem.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BIolV&quot;)"></div><p id="a_BIolV">A <em>posi­tion</em> (count­ing from 1). Posi­tion rep­re­sents the num­ber of char­cac­ters away from the start of the file.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wEiGs&quot;)"></div><p id="a_wEiGs">A <em>line num­ber</em> (count­ing from 1), which is the ver­ti­cal line num­ber from the top.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_n0HGr&quot;)"></div><p id="a_n0HGr">A <em>col­umn num­ber</em> (count­ing from 0), which is the hor­i­zon­tal off­set within the cur­rent line.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xTxNL&quot;)"></div><p id="a_xTxNL">A <em>span</em> (count­ing from 0), which is the num­ber of char­ac­ters that the code occu­pies rel­a­tive to its posi­tion mea­sure­ment.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mMURy&quot;)"></div><p id="a_mMURy">One small gotcha: not every Racket func­tion that uses source loca­tions prints all the source-loca­tion fields, or prints them in the same order. As we saw above, <span class="my-code" decode="exclude">rackunit</span> only prints the line and col­umn from the source loca­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_miw41&quot;)"></div><p id="a_miw41">Racket has a stan­dard <a class="glossary" href="../appendix/glossary.html#structure-type"><span class="glossary-link-text">struc­ture type</span></a> called a <a href="http://docs.racket-lang.org/reference/exns.html#(def._((lib._racket/private/base..rkt)._srcloc))" class="docs" hyphens="none">srcloc</a> that holds all five of these val­ues. Func­tions that han­dle source loca­tions often use <span class="my-code" decode="exclude">srcloc</span> struc­tures for input or out­put.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;why-are-source-locations-important&quot;)"></div><h3 anchor="why-are-source-locations-important" class="subhead" id="why-are-source-locations-important"><a href="#why-are-source-locations-important">Why are source loca­tions impor­tant?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HTHfY&quot;)"></div><p id="a_HTHfY"><a href="../stacker/why-make-languages.html#how-are-languages-implemented
">As we learned</a> in <a href="../stacker/index.html"><span class="my-code" decode="exclude">stacker</span></a>, one of the big ben­e­fits of imple­ment­ing a lan­guage in Racket is that it can use all of Racket’s exist­ing libraries and tools. This works because every Racket-imple­mented lan­guage is really a <a class="glossary" href="../appendix/glossary.html#source-to-source-compiler"><span class="glossary-link-text">source-to-source com­piler</span></a> that trans­lates the new lan­guage into a Racket pro­gram.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_04wy7&quot;)"></div><p id="a_04wy7">This means that even a graph­i­cal tool like DrRacket can han­dle lan­guages that don’t look any­thing like Racket. For instance, source loca­tions are used by DrRacket to han­dle error-high­light­ing effects and other GUI con­ve­niences. All we have to do is attach the orig­i­nal source loca­tions to the new Racket code. Sup­pose our new lan­guage lets us define a vari­able like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_55ZLR&quot;)"></div><div class="highlight-container" id="a_55ZLR"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">let x be 42 / 0</div><div class="highlight" form="false" id="a_0B92U"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>let x be 42 / 0
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0QgFN&quot;)"></div><p id="a_0QgFN">And it’s trans­lated into Racket code that looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Jof4P&quot;)"></div><div class="highlight-container" id="a_Jof4P"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define x (/ 42 0))</div><div class="highlight" form="false" id="a_oECiV"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" class="docs" hyphens="none">/</a></span> <span class="mi">42</span> <span class="mi">0</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wsI7P&quot;)"></div><p id="a_wsI7P">When the divide-by-zero error occurs, DrRacket will be able to use the orig­i­nal source loca­tion to high­light the error in the orig­i­nal code. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">We will learn how to actu­ally do this in the <a href="../basic/index.html"><span class="my-code" decode="exclude">basic</span></a> tuto­r­ial.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TSWMN&quot;)"></div><p id="a_TSWMN">But the cost of this coop­er­a­tion is a lit­tle extra house­keep­ing so our lan­guage pro­vides the infor­ma­tion needed to sup­port other Racket tools. Includ­ing source loca­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_weCFo&quot;)"></div><p id="a_weCFo">As with <a href="contracts.html">con­tracts</a> and <a href="unit-tests.html">unit tests</a>, using source loca­tions is optional. In ear­lier tuto­ri­als, we didn’t worry about source loca­tions because we wanted to keep the focus on learn­ing the core mechan­ics of mak­ing a lan­guage. Noth­ing bad hap­pened.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_79oHV&quot;)"></div><p id="a_79oHV">But since we now want to <a href="drracket-integration.html">inte­grate our lan­guage</a> with DrRacket, we need to take this detour.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;where-are-source-locations-stored&quot;)"></div><h3 anchor="where-are-source-locations-stored" class="subhead" id="where-are-source-locations-stored"><a href="#where-are-source-locations-stored">Where are source loca­tions stored?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_s5a4l&quot;)"></div><p id="a_s5a4l">We’ve already worked with <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax objects</span></a> as a way of pack­ag­ing a ref­er­ence to lit­eral Racket code with cer­tain meta­data fields. One <a href="../stacker/the-expander.html#lexical-context-introduced">field we’ve men­tioned</a> is <a class="glossary" href="../appendix/glossary.html#lexical-context"><span class="glossary-link-text">lex­i­cal con­text</span></a>, which is a list of vari­ables vis­i­ble to the code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NUmqI&quot;)"></div><p id="a_NUmqI">Source loca­tion is another field that’s stored in a syn­tax object. For instance, when we use the <span class="my-code" decode="exclude">#'</span> pre­fix to make a syn­tax object from a datum, its source loca­tion will auto­mat­i­cally be stored in the result­ing syn­tax object. In turn, these source-loca­tion fields can be read with <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-line))" class="docs" hyphens="none">syntax-line</a>, <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-column))" class="docs" hyphens="none">syntax-column</a>, etc.:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6m2Mn&quot;)"></div><div class="highlight-container" id="a_6m2Mn"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define stx #'foobar)<br/>(syntax-position stx) ; 24<br/>(syntax-line stx) ; 2<br/>(syntax-column stx); 14<br/>(syntax-span stx) ; 6</div><div class="highlight" form="false" id="a_JH6Yx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stx</span> <span class="o">#&#39;</span><span class="n">foobar</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-position))" class="docs" hyphens="none">syntax-position</a></span> <span class="n">stx</span><span class="p">)</span> <span class="c1">; 24</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-line))" class="docs" hyphens="none">syntax-line</a></span> <span class="n">stx</span><span class="p">)</span> <span class="c1">; 2</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-column))" class="docs" hyphens="none">syntax-column</a></span> <span class="n">stx</span><span class="p">)</span><span class="c1">; 14</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-span))" class="docs" hyphens="none">syntax-span</a></span> <span class="n">stx</span><span class="p">)</span> <span class="c1">; 6</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kU4h1&quot;)"></div><p id="a_kU4h1">As with lex­i­cal con­text, a syn­tax object retains a ref­er­ence to its orig­i­nal source loca­tion unless these fields are explic­itly changed.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;how-are-source-locations-tracked&quot;)"></div><h3 anchor="how-are-source-locations-tracked" class="subhead" id="how-are-source-locations-tracked"><a href="#how-are-source-locations-tracked">How are source loca­tions tracked?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2iJoc&quot;)"></div><p id="a_2iJoc">As we might guess, source loca­tions are derived from the orig­i­nal source file that holds the code. There­fore, what­ever func­tion reads the source code is respon­si­ble for col­lect­ing source loca­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hEUhs&quot;)"></div><p id="a_hEUhs">After that, func­tions that han­dle the code need to pre­serve the source loca­tions. If we don’t manip­u­late the syn­tax objects much, this is easy. But more com­plex manip­u­la­tions can incur a lit­tle extra effort to make sure source loca­tions stay where they should.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Gut6e&quot;)"></div><p id="a_Gut6e">In <span class="my-code" decode="exclude">jsonic</span>, the func­tion that first reads in the source code is <span class="my-code" decode="exclude">make-tokenizer</span>. Right now, <span class="my-code" decode="exclude">make-tokenizer</span> doesn’t col­lect source loca­tions. We can see this if we feed <span class="my-code" decode="exclude">make-tokenizer</span> a char­ac­ter:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IMYr2&quot;)"></div><div class="highlight-container" id="a_IMYr2"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(require brag/support jsonic/tokenizer)<br/>(apply-tokenizer-maker make-tokenizer "x")</div><div class="highlight" form="false" id="a_1tALV"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span> <span class="n">jsonic/tokenizer</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"x"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_P3WtS&quot;)"></div><div class="highlight-container" id="a_P3WtS"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">(list (token-struct 'CHAR-TOK "x" #f #f #f #f #f))</div><div class="highlight" form="false" id="a_a5908"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct))" class="docs" hyphens="none">token-struct</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"x"</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_urmSp&quot;)"></div><p id="a_urmSp">Our lexer is using the helper func­tion <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a> to cre­ate an instance of <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct))" class="docs" hyphens="none">token-struct</a> named <span class="my-code" decode="exclude">CHAR-TOK</span> with a value of <span class="my-code" decode="exclude">"x"</span>. But the next four fields are the source-loca­tion fields. They’re set to <span class="my-code" decode="exclude">#f</span> because no source-loca­tion infror­ma­tion has been col­lected.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;gathering-the-source-location-data&quot;)"></div><h3 anchor="gathering-the-source-location-data" class="subhead" id="gathering-the-source-location-data"><a href="#gathering-the-source-location-data">Gath­er­ing the source-loca­tion data</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oLzsz&quot;)"></div><p id="a_oLzsz">For com­plete source loca­tions, we need four pieces of data: posi­tion, line, col­umn, and span. We’ll col­lect this data, then embed it within the <span class="my-code" decode="exclude">token</span> struc­tures emit­ted by <span class="my-code" decode="exclude">make-tokenizer</span>. After that, as long as our <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/examples/nested-word-list..rkt)._parse))" class="docs" hyphens="none">parse</a> and <span class="my-code" decode="exclude">read-syntax</span> func­tions pre­serve the source loca­tions, the source loca­tions will be avail­able to other tools, like DrRacket.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oARSp&quot;)"></div><p id="a_oARSp">Let’s open <span class="my-code" decode="exclude">"tokenizer.rkt"</span> so we can add the nec­es­sary code to <span class="my-code" decode="exclude">make-tokenizer</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fnN9U&quot;)"></div><p id="a_fnN9U">Line count and col­umn count are avail­able from the input port. But by default, an input port doesn’t track this infor­ma­tion. So first, we acti­vate line and col­umn count­ing for our <span class="my-code" decode="exclude">port</span> by adding a call to <a href="http://docs.racket-lang.org/reference/linecol.html#(def._((quote._~23~25kernel)._port-count-lines!))" class="docs" hyphens="none">port-count-lines!</a>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Hj4cc&quot;)"></div><div class="highlight-container" id="a_Hj4cc"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">···<br/>(define (make-tokenizer port)<br/>  (port-count-lines! port) ; &lt;- turn on line &amp; column counting<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       [(from/to "@$" "$@")<br/>        (token 'SEXP-TOK (trim-ends "@$" lexeme "$@"))]<br/>       [any-char (token 'CHAR-TOK lexeme)]))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide<br/> (contract-out<br/>   [make-tokenizer (input-port? . -&gt; . (-&gt; jsonic-token?))]))<br/>···</div><div class="highlight" form="false" id="a_KJ3IU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="source"><pre><span class="n">···</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
<span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/linecol.html#(def._((quote._~23~25kernel)._port-count-lines!))" class="docs" hyphens="none">port-count-lines!</a></span> <span class="n">port</span><span class="p">)</span> <span class="c1">; &lt;- turn on line &amp; column counting</span>
</span>  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"@$"</span> <span class="s2">"$@"</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a></span> <span class="s2">"@$"</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="s2">"$@"</span><span class="p">))]</span>
       <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._any-char))" class="docs" hyphens="none">any-char</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span>
 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/base..rkt)._contract-out))" class="docs" hyphens="none">contract-out</a></span>
   <span class="p">[</span><span class="n">make-tokenizer</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._input-port~3f))" class="docs" hyphens="none">input-port?</a></span> <span class="o">.</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="o">.</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="n">jsonic-token?</span><span class="p">))]))</span>
<span class="n">···</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vwDan&quot;)"></div><p id="a_vwDan">We won’t attach source-loca­tion data to our <span class="my-code" decode="exclude">eof</span> rule (because it’s always last) nor our line-com­ment rule (because it doesn’t pro­duce a token). But we will add it to our <span class="my-code" decode="exclude">SEXP-TOK</span> and <span class="my-code" decode="exclude">CHAR-TOK</span> rules.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YMpZh&quot;)"></div><p id="a_YMpZh">Let’s start with <span class="my-code" decode="exclude">CHAR-TOK</span> because it’s a lit­tle eas­ier:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kFHgY&quot;)"></div><div class="highlight-container" id="a_kFHgY"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">···<br/>(define (make-tokenizer port)<br/>  (port-count-lines! port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       [(from/to "@$" "$@")<br/>        (token 'SEXP-TOK (trim-ends "@$" lexeme "$@"))]<br/>       [any-char (token 'CHAR-TOK lexeme<br/>                        #:position (pos lexeme-start)<br/>                        #:line (line lexeme-start)<br/>                        #:column (col lexeme-start)<br/>                        #:span (- (pos lexeme-end)<br/>                                  (pos lexeme-start)))]))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide<br/> (contract-out<br/>   [make-tokenizer (input-port? . -&gt; . (-&gt; jsonic-token?))]))<br/>···</div><div class="highlight" form="false" id="a_JZ3WS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="source"><pre><span class="n">···</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/linecol.html#(def._((quote._~23~25kernel)._port-count-lines!))" class="docs" hyphens="none">port-count-lines!</a></span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"@$"</span> <span class="s2">"$@"</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a></span> <span class="s2">"@$"</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="s2">"$@"</span><span class="p">))]</span>
<span class="hll">       <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._any-char))" class="docs" hyphens="none">any-char</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span>
</span><span class="hll">                        <span class="kd">#:position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
</span><span class="hll">                        <span class="kd">#:line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/indent..rkt)._line))" class="docs" hyphens="none">line</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
</span><span class="hll">                        <span class="kd">#:column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-col))" class="docs" hyphens="none">col</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
</span><span class="hll">                        <span class="kd">#:span</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._end-pos))" class="docs" hyphens="none">lexeme-end</a></span><span class="p">)</span>
</span><span class="hll">                                  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)))]))</span>
</span>    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span>
 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/base..rkt)._contract-out))" class="docs" hyphens="none">contract-out</a></span>
   <span class="p">[</span><span class="n">make-tokenizer</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._input-port~3f))" class="docs" hyphens="none">input-port?</a></span> <span class="o">.</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="o">.</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="n">jsonic-token?</span><span class="p">))]))</span>
<span class="n">···</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kR6wk&quot;)"></div><p id="a_kR6wk">Just as <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a> cre­ates a spe­cial vari­able called <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a> that holds the matched char­ac­ters, it also cre­ates <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a> and <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._end-pos))" class="docs" hyphens="none">lexeme-end</a>, spe­cial vari­ables that hold the posi­tion, line, and col­umn for the start and end of the <span class="my-code" decode="exclude">lexeme</span>. We retrieve these val­ues from <span class="my-code" decode="exclude">lexeme-start</span> or <span class="my-code" decode="exclude">lexeme-end</span> with the helper func­tions <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a>, <a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/indent..rkt)._line))" class="docs" hyphens="none">line</a>, and <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-col))" class="docs" hyphens="none">col</a>. Because the span is a rel­a­tive mea­sure­ment, we cal­cu­late it by sub­tract­ing the end posi­tion from the start posi­tion. We then pass these val­ues to <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a> using its cor­re­spond­ing <a class="glossary" href="../appendix/glossary.html#keyword-argument"><span class="glossary-link-text">key­word argu­ments</span></a>—<span class="my-code" decode="exclude">#:position</span>, <span class="my-code" decode="exclude">#:line</span>, <span class="my-code" decode="exclude">#:column</span>, and <span class="my-code" decode="exclude">#:span</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_no73I&quot;)"></div><p id="a_no73I">Let’s use the REPL to see how this changes the result from <span class="my-code" decode="exclude">make-tokenizer</span>. If we run <span class="my-code" decode="exclude">"tokenizer.rkt"</span> now, we’ll get errors because our unit tests will fail. Don’t panic—we’ll fix those in a minute. Let’s jump down to the REPL and enter the sam­ple expres­sion <a href="#how-are-source-locations-tracked">we tried ear­lier</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fcjUw&quot;)"></div><div class="highlight-container" id="a_fcjUw"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply-tokenizer-maker make-tokenizer "x")</div><div class="highlight" form="false" id="a_Z2W7j"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"x"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Seotq&quot;)"></div><div class="highlight-container" id="a_Seotq"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(list (token-struct 'CHAR-TOK "x" 1 1 0 1 #f))</div><div class="highlight" form="false" id="a_4dFnp"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct))" class="docs" hyphens="none">token-struct</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"x"</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="no">#f</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_58Ug5&quot;)"></div><p id="a_58Ug5">Last time, our source-loca­tion fields were all <span class="my-code" decode="exclude">#f</span>, because we hadn’t filled  them in. This time, they show the source loca­tion we embed­ded for <span class="my-code" decode="exclude">"x"</span>: it’s in posi­tion <span class="my-code" decode="exclude">1</span> of the input, line <span class="my-code" decode="exclude">1</span>, col­umn-off­set <span class="my-code" decode="exclude">0</span>, and has a span of <span class="my-code" decode="exclude">1</span>.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_B5IPa&quot;)"></div><p id="a_B5IPa">Now we’ll han­dle the <span class="my-code" decode="exclude">SEXP-TOK</span> rule:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dlqYa&quot;)"></div><div class="highlight-container" id="a_dlqYa"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">···<br/>(define (make-tokenizer port)<br/>  (port-count-lines! port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       [(from/to "@$" "$@")<br/>        (token 'SEXP-TOK (trim-ends "@$" lexeme "$@")<br/>               #:position (+ (pos lexeme-start) 2)<br/>               #:line (line lexeme-start)<br/>               #:column (+ (col lexeme-start) 2)<br/>               #:span (- (pos lexeme-end)<br/>                         (pos lexeme-start) 4))]<br/>       [any-char (token 'CHAR-TOK lexeme<br/>                        #:position (pos lexeme-start)<br/>                        #:line (line lexeme-start)<br/>                        #:column (col lexeme-start)<br/>                        #:span (- (pos lexeme-end)<br/>                                  (pos lexeme-start)))]))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide<br/> (contract-out<br/>   [make-tokenizer (input-port? . -&gt; . (-&gt; jsonic-token?))]))<br/>···</div><div class="highlight" form="false" id="a_5SiXm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="source"><pre><span class="n">···</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/linecol.html#(def._((quote._~23~25kernel)._port-count-lines!))" class="docs" hyphens="none">port-count-lines!</a></span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"@$"</span> <span class="s2">"$@"</span><span class="p">)</span>
<span class="hll">        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a></span> <span class="s2">"@$"</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="s2">"$@"</span><span class="p">)</span>
</span><span class="hll">               <span class="kd">#:position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="hll">               <span class="kd">#:line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/indent..rkt)._line))" class="docs" hyphens="none">line</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
</span><span class="hll">               <span class="kd">#:column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-col))" class="docs" hyphens="none">col</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
</span><span class="hll">               <span class="kd">#:span</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._end-pos))" class="docs" hyphens="none">lexeme-end</a></span><span class="p">)</span>
</span><span class="hll">                         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span> <span class="mi">4</span><span class="p">))]</span>
</span>       <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._any-char))" class="docs" hyphens="none">any-char</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span>
                        <span class="kd">#:position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
                        <span class="kd">#:line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/indent..rkt)._line))" class="docs" hyphens="none">line</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
                        <span class="kd">#:column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-col))" class="docs" hyphens="none">col</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
                        <span class="kd">#:span</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._end-pos))" class="docs" hyphens="none">lexeme-end</a></span><span class="p">)</span>
                                  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)))]))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span>
 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/base..rkt)._contract-out))" class="docs" hyphens="none">contract-out</a></span>
   <span class="p">[</span><span class="n">make-tokenizer</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._input-port~3f))" class="docs" hyphens="none">input-port?</a></span> <span class="o">.</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="o">.</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="n">jsonic-token?</span><span class="p">))]))</span>
<span class="n">···</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HjbvE&quot;)"></div><p id="a_HjbvE">The basic idea is the same. But we need to adjust our source-loca­tion fields because we’re trim­ming two char­ac­ters from each end of the lex­eme, but the source-loca­tion data comes from the untrimmed lex­eme. Because each delim­iter is two char­ac­ters, we add <span class="my-code" decode="exclude">2</span> to both the posi­tion and col­umn, and sub­tract <span class="my-code" decode="exclude">4</span> from the over­all span.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_r2ejD&quot;)"></div><p id="a_r2ejD">That’s every­thing we need to change within <span class="my-code" decode="exclude">make-tokenizer</span>. We can see, per­haps, why not every project needs to track source loca­tions—it requires some extra house­keep­ing to keep the source-loca­tion data in sync, espe­cially if we’re per­form­ing other pro­cess­ing on our lex­emes. On the other hand, we only have to do it once, and then we can enjoy the ben­e­fits of source loca­tions through­out our lan­guage, includ­ing DrRacket.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;updating-our-unit-tests&quot;)"></div><h3 anchor="updating-our-unit-tests" class="subhead" id="updating-our-unit-tests"><a href="#updating-our-unit-tests">Updat­ing our unit tests</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ti51w&quot;)"></div><p id="a_Ti51w">Now that we’ve improved <span class="my-code" decode="exclude">make-tokenizer</span>, we have to update its unit tests to reflect the new behav­ior. (We didn’t change any­thing about <span class="my-code" decode="exclude">jsonic-token?</span>, so its tests will remain the same.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2MdW4&quot;)"></div><p id="a_2MdW4">We’ll rewrite our tests to use <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a> and its key­word argu­ments to gen­er­ate test tokens with the right source-loca­tion data. We can do this by just count­ing char­ac­ters. This was our first test case that got bro­ken:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Fhc1A&quot;)"></div><div class="highlight-container" id="a_Fhc1A"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply-tokenizer-maker make-tokenizer "@$ (+ 6 7) $@")</div><div class="highlight" form="false" id="a_Q5SoS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"@$ (+ 6 7) $@"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BM7AX&quot;)"></div><p id="a_BM7AX">Accord­ing to our lexer rules, this will become an <span class="my-code" decode="exclude">SEXP-TOK</span> token. Its lex­eme will have two char­ac­ters trimmed from the begin­ning and end. For the trimmed lex­eme, the posi­tion is two more than the orig­i­nal <span class="my-code" decode="exclude">1</span> = <span class="my-code" decode="exclude">3</span>. The line num­ber will remain <span class="my-code" decode="exclude">1</span>. The col­umn off­set is two more than the orig­i­nal <span class="my-code" decode="exclude">0</span> = <span class="my-code" decode="exclude">2</span>. And the span is four less than the orig­i­nal <span class="my-code" decode="exclude">13</span> = <span class="my-code" decode="exclude">9</span>. So we’ll expect a list with one token that looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_saVrp&quot;)"></div><div class="highlight-container" id="a_saVrp"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">(list (token 'SEXP-TOK " (+ 6 7) "<br/>             #:position 3<br/>             #:line 1<br/>             #:column 2<br/>             #:span 9))</div><div class="highlight" form="false" id="a_gq9Z0"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="s2">" (+ 6 7) "</span>
             <span class="kd">#:position</span> <span class="mi">3</span>
             <span class="kd">#:line</span> <span class="mi">1</span>
             <span class="kd">#:column</span> <span class="mi">2</span>
             <span class="kd">#:span</span> <span class="mi">9</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WDovj&quot;)"></div><p id="a_WDovj">We do the same for our other test case:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GHAu5&quot;)"></div><div class="highlight-container" id="a_GHAu5"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">(apply-tokenizer-maker make-tokenizer "hi")</div><div class="highlight" form="false" id="a_FHacT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"hi"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bajFa&quot;)"></div><p id="a_bajFa">Accord­ing to our lexer rules, this will become two <span class="my-code" decode="exclude">CHAR-TOK</span> tokens. They will both be on line <span class="my-code" decode="exclude">1</span> and both have a span of <span class="my-code" decode="exclude">1</span>. The first will be in posi­tion <span class="my-code" decode="exclude">1</span> and col­umn <span class="my-code" decode="exclude">0</span>. The sec­ond will be in posi­tion <span class="my-code" decode="exclude">2</span> and col­umn <span class="my-code" decode="exclude">1</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XnPKr&quot;)"></div><div class="highlight-container" id="a_XnPKr"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">(list (token 'CHAR-TOK "h"<br/>             #:position 1<br/>             #:line 1<br/>             #:column 0<br/>             #:span 1)<br/>      (token 'CHAR-TOK "i"<br/>             #:position 2<br/>             #:line 1<br/>             #:column 1<br/>             #:span 1))</div><div class="highlight" form="false" id="a_KRMZR"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"h"</span>
             <span class="kd">#:position</span> <span class="mi">1</span>
             <span class="kd">#:line</span> <span class="mi">1</span>
             <span class="kd">#:column</span> <span class="mi">0</span>
             <span class="kd">#:span</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"i"</span>
             <span class="kd">#:position</span> <span class="mi">2</span>
             <span class="kd">#:line</span> <span class="mi">1</span>
             <span class="kd">#:column</span> <span class="mi">1</span>
             <span class="kd">#:span</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_IJjNK&quot;)"></div><p id="a_IJjNK">Sub­sti­tut­ing these new test results, the com­pleted mod­ule will look like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">jsonic/tokenizer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BIQXE&quot;)"></div><div class="highlight-container" id="a_BIQXE"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require brag/support racket/contract)<br/><br/>(module+ test<br/>  (require rackunit))<br/><br/>(define (jsonic-token? x)<br/>  (or (eof-object? x) (string? x) (token-struct? x)))<br/><br/>(module+ test<br/>  (check-true (jsonic-token? eof))<br/>  (check-true (jsonic-token? "a string"))<br/>  (check-true (jsonic-token? (token 'A-TOKEN-STRUCT "hi")))<br/>  (check-false (jsonic-token? 42)))<br/><br/>(define (make-tokenizer port)<br/>  (port-count-lines! port)<br/>  (define (next-token)<br/>    (define jsonic-lexer<br/>      (lexer<br/>       [(eof) eof]<br/>       [(from/to "//" "\n") (next-token)]<br/>       [(from/to "@$" "$@")<br/>        (token 'SEXP-TOK (trim-ends "@$" lexeme "$@")<br/>               #:position (+ (pos lexeme-start) 2)<br/>               #:line (line lexeme-start)<br/>               #:column (+ (col lexeme-start) 2)<br/>               #:span (- (pos lexeme-end)<br/>                         (pos lexeme-start) 4))]<br/>       [any-char (token 'CHAR-TOK lexeme<br/>                        #:position (pos lexeme-start)<br/>                        #:line (line lexeme-start)<br/>                        #:column (col lexeme-start)<br/>                        #:span (- (pos lexeme-end)<br/>                                  (pos lexeme-start)))]))<br/>    (jsonic-lexer port))<br/>  next-token)<br/>(provide<br/> (contract-out<br/>  [make-tokenizer (input-port? . -&gt; . (-&gt; jsonic-token?))]))<br/><br/>(module+ test<br/>  (check-equal?<br/>   (apply-tokenizer-maker make-tokenizer "// comment\n")<br/>   empty)<br/>  (check-equal?<br/>   (apply-tokenizer-maker make-tokenizer "@$ (+ 6 7) $@")<br/>   (list (token 'SEXP-TOK " (+ 6 7) "<br/>                #:position 3<br/>                #:line 1<br/>                #:column 2<br/>                #:span 9)))<br/>  (check-equal?<br/>   (apply-tokenizer-maker make-tokenizer "hi")<br/>   (list (token 'CHAR-TOK "h"<br/>                #:position 1<br/>                #:line 1<br/>                #:column 0<br/>                #:span 1)<br/>         (token 'CHAR-TOK "i"<br/>                #:position 2<br/>                #:line 1<br/>                #:column 1<br/>                #:span 1))))</div><div class="highlight" form="false" id="a_mEJD7"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span> <span class="n">racket/contract</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" class="docs" hyphens="none">module+</a></span> <span class="n">test</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">rackunit</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">jsonic-token?</span> <span class="n">x</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof-object~3f))" class="docs" hyphens="none">eof-object?</a></span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string~3f))" class="docs" hyphens="none">string?</a></span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token-struct~3f))" class="docs" hyphens="none">token-struct?</a></span> <span class="n">x</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" class="docs" hyphens="none">module+</a></span> <span class="n">test</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-true))" class="docs" hyphens="none">check-true</a></span> <span class="p">(</span><span class="n">jsonic-token?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-true))" class="docs" hyphens="none">check-true</a></span> <span class="p">(</span><span class="n">jsonic-token?</span> <span class="s2">"a string"</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-true))" class="docs" hyphens="none">check-true</a></span> <span class="p">(</span><span class="n">jsonic-token?</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">A-TOKEN-STRUCT</span> <span class="s2">"hi"</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-false))" class="docs" hyphens="none">check-false</a></span> <span class="p">(</span><span class="n">jsonic-token?</span> <span class="mi">42</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">make-tokenizer</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/linecol.html#(def._((quote._~23~25kernel)._port-count-lines!))" class="docs" hyphens="none">port-count-lines!</a></span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">next-token</span><span class="p">)</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">jsonic-lexer</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a></span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"//"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">next-token</span><span class="p">)]</span>
       <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"@$"</span> <span class="s2">"$@"</span><span class="p">)</span>
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._trim-ends))" class="docs" hyphens="none">trim-ends</a></span> <span class="s2">"@$"</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="s2">"$@"</span><span class="p">)</span>
               <span class="kd">#:position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
               <span class="kd">#:line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/indent..rkt)._line))" class="docs" hyphens="none">line</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
               <span class="kd">#:column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-col))" class="docs" hyphens="none">col</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
               <span class="kd">#:span</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._end-pos))" class="docs" hyphens="none">lexeme-end</a></span><span class="p">)</span>
                         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span> <span class="mi">4</span><span class="p">))]</span>
       <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._any-char))" class="docs" hyphens="none">any-char</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span>
                        <span class="kd">#:position</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
                        <span class="kd">#:line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/indent..rkt)._line))" class="docs" hyphens="none">line</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
                        <span class="kd">#:column</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-col))" class="docs" hyphens="none">col</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)</span>
                        <span class="kd">#:span</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" class="docs" hyphens="none">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._end-pos))" class="docs" hyphens="none">lexeme-end</a></span><span class="p">)</span>
                                  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(def._((lib._br-parser-tools/lex..rkt)._position-offset))" class="docs" hyphens="none">pos</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._start-pos))" class="docs" hyphens="none">lexeme-start</a></span><span class="p">)))]))</span>
    <span class="p">(</span><span class="n">jsonic-lexer</span> <span class="n">port</span><span class="p">))</span>
  <span class="n">next-token</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span>
 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/base..rkt)._contract-out))" class="docs" hyphens="none">contract-out</a></span>
  <span class="p">[</span><span class="n">make-tokenizer</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._input-port~3f))" class="docs" hyphens="none">input-port?</a></span> <span class="o">.</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="o">.</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" class="docs" hyphens="none">-&gt;</a></span> <span class="n">jsonic-token?</span><span class="p">))]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._module+))" class="docs" hyphens="none">module+</a></span> <span class="n">test</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-equal~3f))" class="docs" hyphens="none">check-equal?</a></span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"// comment</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
   <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-equal~3f))" class="docs" hyphens="none">check-equal?</a></span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"@$ (+ 6 7) $@"</span><span class="p">)</span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">SEXP-TOK</span> <span class="s2">" (+ 6 7) "</span>
                <span class="kd">#:position</span> <span class="mi">3</span>
                <span class="kd">#:line</span> <span class="mi">1</span>
                <span class="kd">#:column</span> <span class="mi">2</span>
                <span class="kd">#:span</span> <span class="mi">9</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/rackunit/api.html#(def._((lib._rackunit/main..rkt)._check-equal~3f))" class="docs" hyphens="none">check-equal?</a></span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._apply-tokenizer-maker))" class="docs" hyphens="none">apply-tokenizer-maker</a></span> <span class="n">make-tokenizer</span> <span class="s2">"hi"</span><span class="p">)</span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"h"</span>
                <span class="kd">#:position</span> <span class="mi">1</span>
                <span class="kd">#:line</span> <span class="mi">1</span>
                <span class="kd">#:column</span> <span class="mi">0</span>
                <span class="kd">#:span</span> <span class="mi">1</span><span class="p">)</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">CHAR-TOK</span> <span class="s2">"i"</span>
                <span class="kd">#:position</span> <span class="mi">2</span>
                <span class="kd">#:line</span> <span class="mi">1</span>
                <span class="kd">#:column</span> <span class="mi">1</span>
                <span class="kd">#:span</span> <span class="mi">1</span><span class="p">))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PzegN&quot;)"></div><p id="a_PzegN">When we run <span class="my-code" decode="exclude">"tokenizer.rkt"</span> again, the unit-test­ing errors will be gone.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;checking-source-locations-in-our-reader&quot;)"></div><h3 anchor="checking-source-locations-in-our-reader" class="subhead" id="checking-source-locations-in-our-reader"><a href="#checking-source-locations-in-our-reader">Check­ing source loca­tions in our reader</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_B9XSi&quot;)"></div><p id="a_B9XSi">Ear­lier, <a href="#gathering-the-source-location-data">we noted that</a> once we’ve cap­tured the source loca­tions, our <span class="my-code" decode="exclude">parse</span> and <span class="my-code" decode="exclude">read-syntax</span> func­tions need to leave them intact so they’ll be avail­able to tools like DrRacket. Now that we’ve updated <span class="my-code" decode="exclude">make-tokenizer</span> to col­lect the source loca­tions, we should ver­ify that they’re mak­ing it all the way through.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sVPlq&quot;)"></div><p id="a_sVPlq">Let’s open <span class="my-code" decode="exclude">"reader.rkt"</span>. Our <span class="my-code" decode="exclude">read-syntax</span> func­tion relies on <span class="my-code" decode="exclude">parse</span>. So it should suf­fice to pass some source code to <span class="my-code" decode="exclude">read-syntax</span> and see if the source loca­tions come through cor­rectly (because that will also imply they’re being han­dled cor­rectly by <span class="my-code" decode="exclude">parse</span>).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bll4c&quot;)"></div><p id="a_bll4c">Let’s try a sim­ple test case on the REPL:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qjuZm&quot;)"></div><div class="highlight-container" id="a_qjuZm"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">(read-syntax #f (open-input-string "//x\ny\nz"))</div><div class="highlight" form="false" id="a_j4YWP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="no">#f</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a></span> <span class="s2">"//x</span><span class="se">\n</span><span class="s2">y</span><span class="se">\n</span><span class="s2">z"</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VZMqw&quot;)"></div><p id="a_VZMqw"><span class="my-code" decode="exclude">read-syntax</span> takes a argu­ment with path info and an input port. We don’t have a path so we’ll just use <span class="my-code" decode="exclude">#f</span> for the first argu­ment. We can con­vert a string into an input port with <a href="http://docs.racket-lang.org/reference/stringport.html#(def._((quote._~23~25kernel)._open-input-string))" class="docs" hyphens="none">open-input-string</a>. The string we’re using, <span class="my-code" decode="exclude">"//x\ny\nz"</span>, is equiv­a­lent to this source:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YryJ8&quot;)"></div><div class="highlight-container" id="a_YryJ8"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">//x<br/>y<br/>z</div><div class="highlight" form="false" id="a_6a5ye"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="n">//x</span>
<span class="n">y</span>
<span class="n">z</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Et0fM&quot;)"></div><p id="a_Et0fM">The <span class="my-code" decode="exclude">x</span> is inside a line com­ment, so it should dis­ap­pear. The <span class="my-code" decode="exclude">y</span> and <span class="my-code" decode="exclude">z</span> (and inter­ven­ing new­line) should appear in the parse tree, with source loca­tions on line <span class="my-code" decode="exclude">2</span> and <span class="my-code" decode="exclude">3</span>, respec­tively.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pV9iK&quot;)"></div><p id="a_pV9iK">When we run this expres­sion on the REPL, the result will look like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fZUBa&quot;)"></div><div class="highlight-container" id="a_fZUBa"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; #&lt;syntax (module jsonic-module jsonic/...&gt;</div><div class="highlight" form="false" id="a_pWTjm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; #&lt;syntax (module jsonic-module jsonic/...&gt;
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_igOcs&quot;)"></div><p id="a_igOcs">But in DrRacket, the lit­tle arrow on the left end of the line will be click­able. Click on it, and DrRacket will reveal a panel that we can use to explore the syn­tax object returned by <span class="my-code" decode="exclude">read-syntax</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpkk&quot;)"></div><div id="a_Vldpkk" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="drracket-syntax.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_L040W&quot;)"></div><p id="a_L040W">The left side of the panel shows the lit­eral code inside the syn­tax object. We can see that it’s what we expected—the first line <span class="my-code" decode="exclude">//x</span> dis­ap­pears, and the other char­ac­ters go into the parse tree.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_M48jc&quot;)"></div><p id="a_M48jc">DrRacket also lets us click on items of inter­est within the syn­tax object. The prop­er­ties of each item will be shown in the right-hand panel labeled <em>Gen­eral Info</em>. If we click the <span class="my-code" decode="exclude">"y"</span> in the parse tree (as shown below) its source loca­tion will be revealed: posi­tion <span class="my-code" decode="exclude">5</span>, line <span class="my-code" decode="exclude">2</span>, col­umn <span class="my-code" decode="exclude">0</span>, and span <span class="my-code" decode="exclude">1</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpkl&quot;)"></div><div id="a_Vldpkl" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="drracket-syntax-y.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8xDbT&quot;)"></div><p id="a_8xDbT">This is exactly right. Like­wise, if we click <span class="my-code" decode="exclude">"z"</span>, we’ll see posi­tion <span class="my-code" decode="exclude">7</span>, line <span class="my-code" decode="exclude">3</span>, col­umn <span class="my-code" decode="exclude">0</span>, and span <span class="my-code" decode="exclude">1</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hXo52&quot;)"></div><p id="a_hXo52">Thus, we’ve ver­i­fied that <span class="my-code" decode="exclude">parse</span> and <span class="my-code" decode="exclude">read-syntax</span> are pre­serv­ing source loca­tions cor­rectly. It would also be pos­si­ble to write some unit tests that auto­mat­i­cally ver­ify this. But that would be a detour from the cur­rent detour. Let’s press onward.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;recap&quot;)"></div><h3 anchor="recap" class="subhead" id="recap"><a href="#recap">Recap</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_I5SEW&quot;)"></div><p id="a_I5SEW">What’s neat about source loca­tions in Racket is that they’re a prop­erty of the orig­i­nal source code that’s car­ried along with the code wher­ever it goes. So even if our lan­guage imple­men­ta­tion arranges the source code into a parse tree, then slices &amp; dices it with any num­ber of <a class="glossary" href="../appendix/glossary.html#macro"><span class="glossary-link-text">macros</span></a>—the source loca­tions remain attached. (Or if we need to replace the code entirely, we can take its source loca­tion and attach it to the new item.) This, in turn, is pos­si­ble because Racket han­dles code as recur­sively anno­tated <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax objects</span></a> rather than plain strings.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oKkL7&quot;)"></div><p id="a_oKkL7">Just as there’s more than one way to read a source file—we’ve been using a com­bi­na­tion of a tok­enizer and parser, but that’s just one pos­si­bil­ity—there’s more than one way to col­lect source-loca­tion data. For instance, we’ll learn a sleeker way of col­lect­ing source loca­tions in the <a href="../basic/index.html"><span class="my-code" decode="exclude">basic</span></a> tuto­r­ial.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SIuOA&quot;)"></div><p id="a_SIuOA">The essen­tial idea always remains the same. As we read the source file, we also cap­ture the source-loca­tion fields. We then anno­tate the parsed expres­sions with this infor­ma­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qg1tn&quot;)"></div><p id="a_qg1tn">Our process here was sim­ple because <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer))" class="docs" hyphens="none">lexer</a> auto­mat­i­cally gath­ers source-loca­tion data—we just needed to start using it—and the <a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/examples/nested-word-list..rkt)._parse))" class="docs" hyphens="none">parse</a> func­tion cre­ated by <span class="my-code" decode="exclude">#lang brag</span> already knows how to pre­serve it.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="setup.html">2&emsp;setup</a></li><li><a href="contracts.html">3&emsp;con­tracts</a></li><li><a href="unit-tests.html">4&emsp;unit tests</a></li><li><a class="here" href="source-locations.html">5&emsp;source loca­tions</a></li><li><a href="drracket-integration.html">6&emsp;drracket inte­gra­tion</a></li><li><a href="syntax-coloring.html">7&emsp;syn­tax col­or­ing</a></li><li><a href="indenting.html">8&emsp;indent­ing</a></li><li><a href="toolbar-buttons.html">9&emsp;tool­bar but­tons</a></li><li><a href="recap.html">10&emsp;recap</a></li><li><a href="source-listing.html">11&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="unit-tests.html">← prev</a>
    <a class="nav-right" href="drracket-integration.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>