<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/funstacker/the-rewrite.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:15 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Learn some functional programming: funstacker</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;learn-some-functional-programming-funstacker&quot;)"></div><h1 anchor="learn-some-functional-programming-funstacker" id="learn-some-functional-programming-funstacker" hyphens="none">Learn some functional programming: <span class="my-code" decode="exclude">funstacker</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="project-setup.html">2&emsp;project setup</a></li><li><a class="here" href="the-rewrite.html">3&emsp;the rewrite</a></li><li><a href="recap.html">4&emsp;recap</a></li><li><a href="source-listing.html">5&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;reshaping-our-language&quot;)"></div><h3 anchor="reshaping-our-language" class="subhead" id="reshaping-our-language"><a href="#reshaping-our-language">Reshap­ing our lan­guage</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UNBtX&quot;)"></div><p id="a_UNBtX">Con­sis­tent with the prin­ci­ples of func­tional pro­gram­ming, our goal is to remove the <a class="glossary" href="../appendix/glossary.html#state"><span class="glossary-link-text">state</span></a> and <a class="glossary" href="../appendix/glossary.html#mutation"><span class="glossary-link-text">muta­tion</span></a> from our pro­gram. But first, we need recon­sider more than just the imple­men­ta­tion of our stack.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_kZG22&quot;)"></div><p id="a_kZG22">Recall that <span class="my-code" decode="exclude">stacker</span> was designed around the idea of wrap­ping each argu­ment in the source code within its own <span class="my-code" decode="exclude">(handle ···)</span> datum. So source code that looked like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rBJI2&quot;)"></div><div class="highlight-container" id="a_rBJI2"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_iZYPf"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FaLAw&quot;)"></div><p id="a_FaLAw">Would end up as a series of <a class="glossary" href="../appendix/glossary.html#s-expression"><span class="glossary-link-text">S-expres­sions</span></a> that looked like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MVLt3&quot;)"></div><div class="highlight-container" id="a_MVLt3"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">(handle 4)<br/>(handle 8)<br/>(handle +)<br/>(handle 3)<br/>(handle *)</div><div class="highlight" form="false" id="a_YvvlF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>(handle 4)
(handle 8)
(handle +)
(handle 3)
(handle *)
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_K0izU&quot;)"></div><p id="a_K0izU">Sure, this was obvi­ous &amp; con­ve­nient. But it also resulted in a lan­guage imple­men­ta­tion where each call to <span class="my-code" decode="exclude">handle</span> only knew about the cur­rent argu­ment. More­over, each call to <span class="my-code" decode="exclude">handle</span> was inde­pen­dent of the ones that come before and after. So we had no choice but to main­tain the pro­gram state using an exter­nal <span class="my-code" decode="exclude">stack</span> vari­able, and mutate it as the pro­gram pro­gressed. This style of pro­gram­ming—where func­tion calls use muta­tion to change the pro­gram state—is known as <em><a class="glossary" href="../appendix/glossary.html#imperative-programming"><span class="glossary-link-text">imper­a­tive pro­gram­ming</span></a></em>. It has its place. But it’s not what we’re going for.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_33pb8&quot;)"></div><p id="a_33pb8">If we want to get rid of state &amp; muta­tion, we need to find a dif­fer­ent way to main­tain the stack as we han­dle each argu­ment. And this starts at the top, with the way the expres­sions in our pro­gram are nested—what in Racket is called the <em><a class="glossary" href="../appendix/glossary.html#shape"><span class="glossary-link-text">shape</span></a></em> of the code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_r3g0f&quot;)"></div><p id="a_r3g0f">One option would be to nest the calls to <span class="my-code" decode="exclude">handle</span> (but let’s call this the­o­ret­i­cal func­tion <span class="my-code" decode="exclude">h2</span>, since it won’t work the same way as <span class="my-code" decode="exclude">handle</span>):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_33pOz&quot;)"></div><div class="highlight-container" id="a_33pOz"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">(h2 (h2 (h2 (h2 (h2 4) 8) +) 3) *)</div><div class="highlight" form="false" id="a_RE4dW"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">h2</span> <span class="p">(</span><span class="n">h2</span> <span class="p">(</span><span class="n">h2</span> <span class="p">(</span><span class="n">h2</span> <span class="p">(</span><span class="n">h2</span> <span class="mi">4</span><span class="p">)</span> <span class="mi">8</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span><span class="p">)</span> <span class="mi">3</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FZ2j8&quot;)"></div><p id="a_FZ2j8">What will hap­pen here? S-expres­sions are eval­u­ated from the inside out. So <span class="my-code" decode="exclude">(h2 4)</span> will be eva­l­uted first, and then its result used as the first argu­ment in <span class="my-code" decode="exclude">(h2 <em>result</em> 8)</span>, and so on. So we’d be pro­cess­ing our argu­ments in the cor­rect order, and we could pass the interim stack from one expres­sion to the next. At the end, we’d have the fin­ished stack.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PXBS0&quot;)"></div><p id="a_PXBS0">Another option would be to pass all the argu­ments to a sin­gle func­tion (let’s call this one <span class="my-code" decode="exclude">handle-args</span>):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4Si1c&quot;)"></div><div class="highlight-container" id="a_4Si1c"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">(handle-args 4 8 + 3 *)</div><div class="highlight" form="false" id="a_68FYO"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="n">handle-args</span> <span class="mi">4</span> <span class="mi">8</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="mi">3</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mQu3g&quot;)"></div><p id="a_mQu3g">In this case, <span class="my-code" decode="exclude">handle-args</span> could access all the argu­ments. There’d be no need to mutate a vari­able out­side the bound­aries of the func­tion. All the house­keep­ing could hap­pen inside, and then the func­tion would deliver the fin­ished stack as its return value.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tVT51&quot;)"></div><p id="a_tVT51">Though the nest­ing pat­terns are dif­fer­ent, it turns out that both approaches end up work­ing mostly the same way. But the <span class="my-code" decode="exclude">h2</span> approach requires a lit­tle more knowl­edge about macros than we cur­rently have. So we’ll go with the <span class="my-code" decode="exclude">handle-args</span> approach—pass all the argu­ments to a sin­gle func­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;rewriting-our-reader&quot;)"></div><h3 anchor="rewriting-our-reader" class="subhead" id="rewriting-our-reader"><a href="#rewriting-our-reader">Rewrit­ing our reader</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PtuLs&quot;)"></div><p id="a_PtuLs">Our reader still con­sists of a sin­gle <span class="my-code" decode="exclude">read-syntax</span> func­tion. Let’s replace the exist­ing <span class="my-code" decode="exclude">read-syntax</span> in <span class="my-code" decode="exclude">funstacker.rkt</span> with this code:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_e0ZhJ&quot;)"></div><div class="highlight-container" id="a_e0ZhJ"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define src-lines (port-&gt;lines port))<br/>  (define src-datums (format-datums '~a src-lines))<br/>  (define module-datum `(module funstacker-mod "funstacker.rkt"<br/>                          (handle-args ,@src-datums)))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)</div><div class="highlight" form="false" id="a_G5OmU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">src-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="ss">~a</span> <span class="n">src-lines</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">funstacker-mod</span> <span class="s2">"funstacker.rkt"</span>
                          <span class="p">(</span><span class="ss">handle-args</span> <span class="o">,@</span><span class="n">src-datums</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5Wb7P&quot;)"></div><p id="a_5Wb7P">This ver­sion works basi­cally the same way as before. But this time, rather than wrap each argu­ment in its own <span class="my-code" decode="exclude">(handle ···)</span> datum, we’ll con­vert the argu­ments into datums with­out wrap­ping them at all, stor­ing them in a list called <span class="my-code" decode="exclude">src-datums</span>. Then, inside our <span class="my-code" decode="exclude">module-datum</span>, we’ll splice the <span class="my-code" decode="exclude">src-datums</span> into a sin­gle <span class="my-code" decode="exclude">(handle-args ···)</span> expres­sion. <span class="my-code" decode="exclude">handle-args</span> will be the name of the new func­tion that will process our argu­ments.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;rewriting-our-expander&quot;)"></div><h3 anchor="rewriting-our-expander" class="subhead" id="rewriting-our-expander"><a href="#rewriting-our-expander">Rewrit­ing our expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cQIQF&quot;)"></div><p id="a_cQIQF">As before, we need to <span class="my-code" decode="exclude">provide</span> a <span class="my-code" decode="exclude">#%module-begin</span> macro that acts as the start­ing point for the expander. Let’s replace the exist­ing <span class="my-code" decode="exclude">#%module-begin</span> in <span class="my-code" decode="exclude">funstacker.rkt</span> with this code:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_eQRea&quot;)"></div><div class="highlight-container" id="a_eQRea"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro (funstacker-module-begin HANDLE-ARGS-EXPR)<br/>  #'(#%module-begin<br/>     (display (first HANDLE-ARGS-EXPR))))<br/>(provide (rename-out [funstacker-module-begin #%module-begin]))</div><div class="highlight" form="false" id="a_7Wjkr"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">funstacker-module-begin</span> <span class="n">HANDLE-ARGS-EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">HANDLE-ARGS-EXPR</span><span class="p">))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">funstacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_T0ggz&quot;)"></div><p id="a_T0ggz">In our new <span class="my-code" decode="exclude">read-syntax</span>, we saw that our <span class="my-code" decode="exclude">module-datum</span> will con­tain exactly one expres­sion, namely a call to <span class="my-code" decode="exclude">(handle-args ···)</span>. So the <span class="my-code" decode="exclude">funstacker-module-begin</span> macro only has to be able to han­dle this one argu­ment as input, which we name <span class="my-code" decode="exclude">HANDLE-ARGS-EXPR</span>. Then, because <span class="my-code" decode="exclude">HANDLE-ARGS-EXPR</span> will return a fin­ished stack, we use it as the input argu­ment in <span class="my-code" decode="exclude">(display (first HANDLE-ARGS-EXPR))</span>. Notice that it replaces <span class="my-code" decode="exclude">stack</span>, the state vari­able that we’re elim­i­nat­ing.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8pUwN&quot;)"></div><p id="a_8pUwN">Then we need to imple­ment our stack. In  <span class="my-code" decode="exclude">funstacker.rkt</span>, we replace <span class="my-code" decode="exclude">stack</span>, <span class="my-code" decode="exclude">pop-stack!</span>, <span class="my-code" decode="exclude">push-stack!</span> and <span class="my-code" decode="exclude">handle</span> with our new <span class="my-code" decode="exclude">handle-args</span> func­tion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Mt53z&quot;)"></div><div class="highlight-container" id="a_Mt53z"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (handle-args . args)<br/>  (for/fold ([stack-acc empty])<br/>            ([arg (filter-not void? args)])<br/>    (cond<br/>      [(number? arg) (cons arg stack-acc)]<br/>      [(or (equal? * arg) (equal? + arg))<br/>       (define op-result<br/>         (arg (first stack-acc) (second stack-acc)))<br/>       (cons op-result (drop stack-acc 2))])))<br/>(provide handle-args)</div><div class="highlight" form="false" id="a_GUuch"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle-args</span> <span class="o">.</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">stack-acc</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">])</span>
            <span class="p">([</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._filter-not))" class="docs" hyphens="none">filter-not</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void~3f))" class="docs" hyphens="none">void?</a></span> <span class="n">args</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
      <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack-acc</span><span class="p">)]</span>
      <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span>
         <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack-acc</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" class="docs" hyphens="none">second</a></span> <span class="n">stack-acc</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._drop))" class="docs" hyphens="none">drop</a></span> <span class="n">stack-acc</span> <span class="mi">2</span><span class="p">))])))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">handle-args</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7yo7L&quot;)"></div><p id="a_7yo7L">Some of this looks sim­i­lar to our old <span class="my-code" decode="exclude">handle</span> func­tion. But we’re mov­ing from an imper­a­tive style to a func­tional style, and intro­duc­ing some new nota­tion. Let’s go through this func­tion line by line.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Dz1o5&quot;)"></div><div class="highlight-container" id="a_Dz1o5"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define (handle-args . args)</div><div class="highlight" form="false" id="a_1tE6C"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle-args</span> <span class="o">.</span> <span class="n">args</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y8FbO&quot;)"></div><p id="a_Y8FbO">The dot in front of <span class="my-code" decode="exclude">args</span> des­ig­nates it as a <em><a class="glossary" href="../appendix/glossary.html#rest-argument"><span class="glossary-link-text">rest argu­ment</span></a></em>. A rest argu­ment is optional in any func­tion def­i­n­i­tion. It can only appear as the last argu­ment. Any num­ber of <a class="glossary" href="../appendix/glossary.html#positional-argument"><span class="glossary-link-text">posi­tional argu­ments</span></a> can appear before it. The rest argu­ment means “gather the remain­ing argu­ments in a list and assign it to this vari­able.” A rest argu­ment makes it pos­si­ble for a func­tion to accept any num­ber of argu­ments. That’s what we need here, since we don’t know in advance how many argu­ments will be in the source code.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1Sn13&quot;)"></div><div class="highlight-container" id="a_1Sn13"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">(for/fold ([stack-acc empty])<br/>          ([arg (filter-not void? args)])</div><div class="highlight" form="false" id="a_4m10o"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">stack-acc</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">])</span>
          <span class="p">([</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._filter-not))" class="docs" hyphens="none">filter-not</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void~3f))" class="docs" hyphens="none">void?</a></span> <span class="n">args</span><span class="p">)])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JXkyS&quot;)"></div><p id="a_JXkyS">Next we have <a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a>, which deserves a place in every­one’s list of favorite Racket tools. <span class="my-code" decode="exclude">for/fold</span> iter­ates over a list of val­ues (like the <span class="my-code" decode="exclude">for</span> loops we’ve seen in other lan­guages). But each pass of the loop also returns a spe­cial value called an <em><a class="glossary" href="../appendix/glossary.html#accumulator"><span class="glossary-link-text">accu­mu­la­tor</span></a></em>. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">The accu­mu­la­tor is the des­ti­na­tion of the “fold­ing”, and is also used in the related func­tions <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._foldl))" class="docs" hyphens="none">foldl</a> and <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._foldr))" class="docs" hyphens="none">foldr</a>.</span></span> An accu­mu­la­tor is sim­i­lar to a state vari­able, with two dif­fer­ences. First, the accu­mu­la­tor lives inside our loop, rather than out­side. Sec­ond, on each pass of <span class="my-code" decode="exclude">for/fold</span>, rather than change the value of the accu­mu­la­tor with <a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a>, we replace it with a whole new value. The loop ends when the iter­a­tor runs out of val­ues. The return value of the whole <span class="my-code" decode="exclude">for/fold</span> loop is the final value of its accu­mu­la­tor.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iZsIh&quot;)"></div><p id="a_iZsIh">Let’s con­sider a sim­ple <span class="my-code" decode="exclude">for/fold</span> loop just so we under­stand the mechan­ics:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VxeOO&quot;)"></div><div class="highlight-container" id="a_VxeOO"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(for/fold ([sum 0])<br/>          ([int (list 1 2 3 4 5 6 7 8 9 10)])<br/>  (+ sum int)) ; 55</div><div class="highlight" form="false" id="a_xjsge"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">sum</span> <span class="mi">0</span><span class="p">])</span>
          <span class="p">([</span><span class="n">int</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">10</span><span class="p">)])</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">sum</span> <span class="n">int</span><span class="p">))</span> <span class="c1">; 55</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_95t7V&quot;)"></div><p id="a_95t7V">Here, our accu­mu­la­tor is <span class="my-code" decode="exclude">sum</span> and starts with the value <span class="my-code" decode="exclude">0</span>. Our iter­a­tor is <span class="my-code" decode="exclude">int</span>, which will take on each val­ues in <span class="my-code" decode="exclude">(list 1 2 3 4 5 6 7 8 9 10)</span>. On each pass of the loop, <span class="my-code" decode="exclude">(+ sum int)</span> means that we add the cur­rent value of <span class="my-code" decode="exclude">sum</span> to the cur­rent value of <span class="my-code" decode="exclude">int</span>. This acts as the “return value” of the loop, and becomes the new accu­mu­la­tor value for the next iter­a­tion. So we end up adding the inte­gers together, and the return value of the whole loop is <span class="my-code" decode="exclude">55</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Zu4cC&quot;)"></div><p id="a_Zu4cC">Going back to our loop:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1Sn13c&quot;)"></div><div class="highlight-container" id="a_1Sn13c"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(for/fold ([stack-acc empty])<br/>          ([arg (filter-not void? args)])</div><div class="highlight" form="false" id="a_4m10oa"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">stack-acc</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">])</span>
          <span class="p">([</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._filter-not))" class="docs" hyphens="none">filter-not</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void~3f))" class="docs" hyphens="none">void?</a></span> <span class="n">args</span><span class="p">)])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_71Fzc&quot;)"></div><p id="a_71Fzc">A <span class="my-code" decode="exclude">for/fold</span> loop has two manda­tory parts.</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xc3gF&quot;)"></div><p id="a_xc3gF">We have to define at least one accu­mu­la­tor and assign it an ini­tial value. We’ll call our accu­mu­la­tor <span class="my-code" decode="exclude">stack-acc</span>, and make it <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a> to start.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Z7utZ&quot;)"></div><p id="a_Z7utZ">We have to define at least one iter­a­tor. We’ll call this <span class="my-code" decode="exclude">arg</span> and iter­ate over our list of <span class="my-code" decode="exclude">args</span>.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0Ovpm&quot;)"></div><p id="a_0Ovpm">Let’s not for­get that some of the lines in our source pro­gram might be blank. Since they serve no pur­pose, we’d like to get rid of them before we run our loop. When these blank lines are con­verted to datums, they’ll end up as the spe­cial Racket value <span class="my-code" decode="exclude">&lt;#void&gt;</span>, which can be tested with <a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void~3f))" class="docs" hyphens="none">void?</a>. So we use <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._filter-not))" class="docs" hyphens="none">filter-not</a> to extract a list of the non-<span class="my-code" decode="exclude">void?</span> ele­ments in <span class="my-code" decode="exclude">args</span> before we iter­ate.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qn0rt&quot;)"></div><div class="highlight-container" id="a_qn0rt"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">(cond<br/>  [(number? arg) (cons arg stack-acc)]<br/>  [(or (equal? * arg) (equal? + arg))<br/>   (define op-result<br/>     (arg (first stack-acc) (second stack-acc)))<br/>   (cons op-result (drop stack-acc 2))])</div><div class="highlight" form="false" id="a_tgdyc"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack-acc</span><span class="p">)]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">))</span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span>
     <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack-acc</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" class="docs" hyphens="none">second</a></span> <span class="n">stack-acc</span><span class="p">)))</span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._drop))" class="docs" hyphens="none">drop</a></span> <span class="n">stack-acc</span> <span class="mi">2</span><span class="p">))])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lTjMO&quot;)"></div><p id="a_lTjMO">This <a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a> expres­sion looks sim­i­lar to the one we had in our orig­i­nal <span class="my-code" decode="exclude">handle</span> func­tion. But this time, instead of mutat­ing an exter­nal <span class="my-code" decode="exclude">stack</span> vari­able, each branch will cre­ate an updated copy of our <span class="my-code" decode="exclude">stack-acc</span> accu­mu­la­tor. In essence, instead of rely­ing on exter­nal <span class="my-code" decode="exclude">push-stack!</span> and <span class="my-code" decode="exclude">pop-stack!</span> func­tions, we’ll do all the stack pro­cess­ing inside our <span class="my-code" decode="exclude">cond</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MaihB&quot;)"></div><p id="a_MaihB">If <span class="my-code" decode="exclude">arg</span> is a num­ber, we push it onto the stack with <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a>. If <span class="my-code" decode="exclude">arg</span> is a stack oper­a­tor, we cal­cu­late <span class="my-code" decode="exclude">op-result</span> using the <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a> and <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" class="docs" hyphens="none">second</a> ele­ments of <span class="my-code" decode="exclude">stack-acc</span>. Unlike <span class="my-code" decode="exclude">pop-stack!</span>, these oper­a­tions don’t remove argu­ments from the stack, so we have to explic­itly <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._drop))" class="docs" hyphens="none">drop</a> two items from <span class="my-code" decode="exclude">stack-acc</span>. Then we put <span class="my-code" decode="exclude">op-result</span> onto the stack (again with <span class="my-code" decode="exclude">cons</span>). The new stack that’s cre­ated at the end of each branch will be returned as the value of the whole <span class="my-code" decode="exclude">cond</span> expres­sion, and thereby become the new value of <span class="my-code" decode="exclude">stack-acc</span> used in the next iter­a­tion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3AHHc&quot;)"></div><p id="a_3AHHc">Finally, as we did in <span class="my-code" decode="exclude">stacker</span>, we need to <span class="my-code" decode="exclude">provide</span> our stack oper­a­tors:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_NMxvX&quot;)"></div><div class="highlight-container" id="a_NMxvX"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">(provide + *)</div><div class="highlight" form="false" id="a_6HZm9"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-funstacker&quot;)"></div><h3 anchor="testing-funstacker" class="subhead" id="testing-funstacker"><a href="#testing-funstacker">Test­ing Fun­stacker</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sCjjI&quot;)"></div><p id="a_sCjjI">Our whole <span class="my-code" decode="exclude">"funstacker.rkt"</span> should now look like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">funstacker.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_X44Us&quot;)"></div><div class="highlight-container" id="a_X44Us"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/><br/>(define (read-syntax path port)<br/>  (define args (port-&gt;lines port))<br/>  (define arg-datums (format-datums '~a args))<br/>  (define module-datum `(module funstacker-mod "funstacker.rkt"<br/>                          (handle-args ,@arg-datums)))<br/>  (datum-&gt;syntax #f module-datum))<br/>(provide read-syntax)<br/><br/>(define-macro (funstacker-module-begin HANDLE-ARGS-EXPR)<br/>  #'(#%module-begin<br/>     (display (first HANDLE-ARGS-EXPR))))<br/>(provide (rename-out [funstacker-module-begin #%module-begin]))<br/><br/>(define (handle-args . args)<br/>  (for/fold ([stack-acc empty])<br/>            ([arg (filter-not void? args)])<br/>    (cond<br/>      [(number? arg) (cons arg stack-acc)]<br/>      [(or (equal? * arg) (equal? + arg))<br/>       (define op-result<br/>         (arg (first stack-acc) (second stack-acc)))<br/>       (cons op-result (drop stack-acc 2))])))<br/>(provide handle-args)<br/><br/>(provide + *)
</div><div class="highlight" form="false" id="a_dNL27"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span> <span class="n">path</span> <span class="n">port</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">args</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-lib.html#(def._((lib._racket/port..rkt)._port-~3elines))" class="docs" hyphens="none">port-&gt;lines</a></span> <span class="n">port</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">arg-datums</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/datum..rkt)._format-datums))" class="docs" hyphens="none">format-datums</a></span> <span class="o">&#39;</span><span class="ss">~a</span> <span class="n">args</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">module-datum</span> <span class="o">`</span><span class="p">(</span><span class="ss">module</span> <span class="ss">funstacker-mod</span> <span class="s2">"funstacker.rkt"</span>
                          <span class="p">(</span><span class="ss">handle-args</span> <span class="o">,@</span><span class="n">arg-datums</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" class="docs" hyphens="none">datum-&gt;syntax</a></span> <span class="no">#f</span> <span class="n">module-datum</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/Reading.html#(def._((quote._~23~25kernel)._read-syntax))" class="docs" hyphens="none">read-syntax</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">funstacker-module-begin</span> <span class="n">HANDLE-ARGS-EXPR</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._display))" class="docs" hyphens="none">display</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">HANDLE-ARGS-EXPR</span><span class="p">))))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">funstacker-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">handle-args</span> <span class="o">.</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/fold))" class="docs" hyphens="none">for/fold</a></span> <span class="p">([</span><span class="n">stack-acc</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">])</span>
            <span class="p">([</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._filter-not))" class="docs" hyphens="none">filter-not</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void~3f))" class="docs" hyphens="none">void?</a></span> <span class="n">args</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._cond))" class="docs" hyphens="none">cond</a></span>
      <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" class="docs" hyphens="none">number?</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">arg</span> <span class="n">stack-acc</span><span class="p">)]</span>
      <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span> <span class="n">arg</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" class="docs" hyphens="none">equal?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">arg</span><span class="p">))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">op-result</span>
         <span class="p">(</span><span class="n">arg</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._first))" class="docs" hyphens="none">first</a></span> <span class="n">stack-acc</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._second))" class="docs" hyphens="none">second</a></span> <span class="n">stack-acc</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" class="docs" hyphens="none">cons</a></span> <span class="n">op-result</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._drop))" class="docs" hyphens="none">drop</a></span> <span class="n">stack-acc</span> <span class="mi">2</span><span class="p">))])))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">handle-args</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkf" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fgHYI&quot;)"></div><p id="a_fgHYI">If we run our <span class="my-code" decode="exclude">"funstacker-test.rkt"</span> file:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">funstacker-test.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fNPOz&quot;)"></div><div class="highlight-container" id="a_fNPOz"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang reader "funstacker.rkt"<br/>4<br/>8<br/>+<br/>3<br/>*</div><div class="highlight" form="false" id="a_1JB59"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">reader</span> <span class="s2">"funstacker.rkt"</span>
<span class="mi">4</span>
<span class="mi">8</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" class="docs" hyphens="none">*</a></span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pRj6g&quot;)"></div><p id="a_pRj6g">We’ll get:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mw772&quot;)"></div><div class="highlight-container" id="a_mw772"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">36</div><div class="highlight" form="false" id="a_2jsOx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="mi">36</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MpXn7&quot;)"></div><p id="a_MpXn7">Our con­ver­sion to func­tional pro­gram­ming is com­plete. Bet­ter still, <span class="my-code" decode="exclude">funstacker</span> is even shorter than <span class="my-code" decode="exclude">stacker</span>.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="project-setup.html">2&emsp;project setup</a></li><li><a class="here" href="the-rewrite.html">3&emsp;the rewrite</a></li><li><a href="recap.html">4&emsp;recap</a></li><li><a href="source-listing.html">5&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="project-setup.html">← prev</a>
    <a class="nav-right" href="recap.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>