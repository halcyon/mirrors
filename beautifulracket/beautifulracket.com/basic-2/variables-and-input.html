<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/basic-2/variables-and-input.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:47:57 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Into the rapids: more basic</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;into-the-rapids-more-basic&quot;)"></div><h1 anchor="into-the-rapids-more-basic" id="into-the-rapids-more-basic" hyphens="none">Into the rapids: more <span class="my-code" decode="exclude">basic</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="the-syntax-colorer.html">3&emsp;the syn­tax col­orer</a></li><li><a href="better-line-errors.html">4&emsp;bet­ter line errors</a></li><li><a class="here" href="variables-and-input.html">5&emsp;vari­ables and input</a></li><li><a href="expressions.html">6&emsp;expres­sions</a></li><li><a href="conditionals.html">7&emsp;con­di­tion­als</a></li><li><a href="subroutines-and-loops.html">8&emsp;sub­rou­tines and loops</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_erIML&quot;)"></div><p id="a_erIML">It’ll be dif­fi­cult to make any decent BASIC games with­out vari­ables and user input. Input is easy once we have vari­ables. Vari­ables are a lit­tle harder. But we’ll use the prin­ci­ple that’s served us well so far: study the behav­ior of BASIC vari­ables, and then fig­ure out the most nat­ural way to model this behav­ior in Racket.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;variables-in-basic&quot;)"></div><h3 anchor="variables-in-basic" class="subhead" id="variables-in-basic"><a href="#variables-in-basic">Vari­ables in BASIC</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oN9bB&quot;)"></div><p id="a_oN9bB">Vari­ables work a lit­tle dif­fer­ently in BASIC than in Racket:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7baMH&quot;)"></div><p id="a_7baMH">All vari­ables are global. There’s no way to cre­ate a “locally scoped” vari­able (e.g., one that is only valid inside a cer­tain line or loop). So when any line in the pro­gram refers to vari­able <span class="my-code" decode="exclude">x</span>, it always has to be the same <span class="my-code" decode="exclude">x</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2liRD&quot;)"></div><p id="a_2liRD">A vari­able can be declared explic­itly with <span class="my-code" decode="exclude">let</span>, or by sim­ply assign­ing it a value with <span class="my-code" decode="exclude">=</span>. This pro­gram (using <span class="my-code" decode="exclude">basic-demo-2</span> for a moment, because our own imple­men­ta­tion isn’t work­ing yet) prints <span class="my-code" decode="exclude">66</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0Ofev&quot;)"></div><div class="highlight-container" id="a_0Ofev"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 let x = 42<br/>20 y = 24<br/>30 print x + y</div><div class="highlight" form="false" id="a_qudJy"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">let</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">42</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">24</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">y</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_D6IX1&quot;)"></div><p id="a_D6IX1">Vari­ables don’t have to be declared in advance. If a vari­able is used before its value has been set, it defaults to a value of <span class="my-code" decode="exclude">0</span>. So this pro­gram is valid, and prints <span class="my-code" decode="exclude">000</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_OSaZ5&quot;)"></div><div class="highlight-container" id="a_OSaZ5"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 print x ; y ; z</div><div class="highlight" form="false" id="a_79Rmi"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">z</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3g2o7&quot;)"></div><p id="a_3g2o7">Because BASIC pro­grams rely almost entirely on global vari­ables and <a class="glossary" href="../appendix/glossary.html#mutation"><span class="glossary-link-text">muta­tion</span></a>, they are in some sense the antithe­sis of the func­tional pro­gram­ming tech­niques that are idiomatic in Racket. Still, we will not be deterred.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BbCML&quot;)"></div><p id="a_BbCML">Tra­di­tion­ally, BASIC vari­ables were lim­ited to one let­ter, and vari­ables that held strings were one let­ter fol­lowed by <span class="my-code" decode="exclude">$</span>. We won’t pre­serve this tra­di­tion, because it’s point­less and awful. Instead we’ll allow our BASIC vari­ables to be any sequence of alpha­betic or numeric char­ac­ters (or <span class="my-code" decode="exclude">$</span>) that starts with a let­ter. (Those who insist on one-let­ter names can still have them.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;modeling-basic-variables&quot;)"></div><h3 anchor="modeling-basic-variables" class="subhead" id="modeling-basic-variables"><a href="#modeling-basic-variables">Mod­el­ing BASIC vari­ables</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_N40sB&quot;)"></div><p id="a_N40sB">We can fore­see two pos­si­ble approaches:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JxZr2&quot;)"></div><p id="a_JxZr2">We could think of BASIC vari­ables as a <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run-time</span></a> con­cept. Mean­ing, we could start with an empty data struc­ture—say, a  <a class="glossary" href="../appendix/glossary.html#hash-table"><span class="glossary-link-text">hash table</span></a>—and treat vari­able ref­er­ences as keys into the hash table, read­ing or writ­ing as appro­pri­ate.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qL1lT&quot;)"></div><p id="a_qL1lT">The good news is that this approach would be eas­ier to imple­ment, and would do most of what we need.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nC4ln&quot;)"></div><p id="a_nC4ln">The bad news is that this approach is an evo­lu­tion­ary dead end. Once we make vari­ables into hash keys, how will we use them on the <a class="explainer" href="../explainer/repl.html">REPL</a>? (Insert annoy­ing house­keep­ing here.) What if we want to <a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a> these val­ues out­side the file? (Insert more house­keep­ing.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_vcjkB&quot;)"></div><p id="a_vcjkB">Our short­cut starts to look like a false econ­omy. Mod­el­ing our BASIC vari­ables as hash keys might save us some setup effort. But before long, it’ll cost us.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Q38mq&quot;)"></div><p id="a_Q38mq">Alter­na­tively, we could think of our BASIC vari­ables as a <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile-time</span></a> con­cept. Mean­ing, we could model them as actual Racket vari­ables.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4i9lo&quot;)"></div><p id="a_4i9lo">The good news is that this approach would make a lot of other things in our imple­men­ta­tion eas­ier. For instance, when we write macros, we could use BASIC vari­ables in the same loca­tions as reg­u­lar Racket vari­ables.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mKU1Z&quot;)"></div><p id="a_mKU1Z">Well, almost. The first time we use a Racket vari­able, we intro­duce it into our pro­gram with <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a>. In BASIC, because the pro­gram lines can be exe­cuted in any order, we wouldn’t be able to say at com­pile time which ref­er­ence to a cer­tain vari­able came “first”. No prob­lem—we could just imple­ment every assign­ment to a BASIC vari­able as a muta­tion (using <a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a>).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ljkdq&quot;)"></div><p id="a_Ljkdq">Which brings us to the bad news: to make this work, we’d need to some­how <span class="my-code" decode="exclude">define</span> all the vari­ables the pro­gram uses in advance. How?</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qXJ0k&quot;)"></div><p id="a_qXJ0k">Before we answer that ques­tion, let’s agree that the hash-table idea is a loser. In gen­eral, BASIC vari­ables have a lot in com­mon with Racket vari­ables. We’ll get more ben­e­fit from keep­ing those con­cepts tied together, rather than choos­ing some­thing with a less nat­ural fit (= a hash table).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SIuki&quot;)"></div><p id="a_SIuki">As always, we’ll have to update our <a class="glossary" href="../appendix/glossary.html#lexer"><span class="glossary-link-text">lexer</span></a> and our <a class="glossary" href="../appendix/glossary.html#parser"><span class="glossary-link-text">parser</span></a> to han­dle vari­ables and vari­able-assign­ment state­ments. We’ll also have to update the <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a> to imple­ment the muta­tion under­ly­ing these state­ments. But for us, that part will be easy—we’ve done it before.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;search-and-destroy&quot;)"></div><h3 anchor="search-and-destroy" class="subhead" id="search-and-destroy"><a href="#search-and-destroy">Search and destroy</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3sYGJ&quot;)"></div><p id="a_3sYGJ">Let’s focus on the new prob­lem. If we want to model BASIC vari­ables as Racket vari­ables, we need them all to be defined before we start run­ning the indi­vid­ual lines of a pro­gram. So in a pro­gram like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dZh8U&quot;)"></div><div class="highlight-container" id="a_dZh8U"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 x = 1<br/>20 print x<br/>30 y = x * 2<br/>40 print y<br/>50 z = x + y<br/>60 print z</div><div class="highlight" form="false" id="a_QPtT5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">1</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="il">2</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">y</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">y</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">z</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qRsjz&quot;)"></div><p id="a_qRsjz">We’d need <span class="my-code" decode="exclude">x</span>, <span class="my-code" decode="exclude">y</span>, and <span class="my-code" decode="exclude">z</span> to be defined (and ini­tial­ized to <span class="my-code" decode="exclude">0</span>) before the first line runs.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_RBKpA&quot;)"></div><p id="a_RBKpA">We know that any kind of setup work that needs to hap­pen before the first line can live in the <span class="my-code" decode="exclude">#%module-begin</span> macro in our <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a>. For instance, we cur­rently use this macro to set up a <span class="my-code" decode="exclude">line-table</span> before we call <span class="my-code" decode="exclude">run</span> to start the pro­gram:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tmbgu&quot;)"></div><div class="highlight-container" id="a_tmbgu"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require "struct.rkt" "run.rkt" "elements.rkt")<br/>(provide (rename-out [b-module-begin #%module-begin])<br/>         (all-from-out "elements.rkt"))<br/><br/>(define-macro (b-module-begin (b-program LINE ...))<br/>  (with-pattern<br/>      ([((b-line NUM STMT ...) ...) #'(LINE ...)]<br/>       [(LINE-FUNC ...) (prefix-id "line-" #'(NUM ...))])<br/>    #'(#%module-begin<br/>       LINE ...<br/>       (define line-table<br/>         (apply hasheqv (append (list NUM LINE-FUNC) ...)))<br/>       (void (run line-table)))))<br/><br/>
</div><div class="highlight" form="false" id="a_5BlNp"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"run.rkt"</span> <span class="s2">"elements.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">b-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">])</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._all-from-out))" class="docs" hyphens="none">all-from-out</a></span> <span class="s2">"elements.rkt"</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-module-begin</span> <span class="p">(</span><span class="n">b-program</span> <span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span>
      <span class="p">([((</span><span class="n">b-line</span> <span class="n">NUM</span> <span class="n">STMT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)]</span>
       <span class="p">[(</span><span class="n">LINE-FUNC</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._prefix-id))" class="docs" hyphens="none">prefix-id</a></span> <span class="s2">"line-"</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">NUM</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
       <span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">line-table</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hasheqv))" class="docs" hyphens="none">hasheqv</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._append))" class="docs" hyphens="none">append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">NUM</span> <span class="n">LINE-FUNC</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">run</span> <span class="n">line-table</span><span class="p">)))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9lf1d&quot;)"></div><p id="a_9lf1d">Fol­low­ing that idea, if we had a list of the iden­ti­fiers in the BASIC pro­gram, we could insert a <span class="my-code" decode="exclude">define</span> expres­sion at the top of our <span class="my-code" decode="exclude">#%module-begin</span> for each, turn­ing them into vari­ables.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pAkgr&quot;)"></div><p id="a_pAkgr">So where do we get this list of iden­ti­fiers? In <a href="../basic/the-expander.html#our-module-begin-macro">the last tuto­r­ial</a>, we saw how we could use a <a class="explainer" href="../explainer/syntax-patterns.html">syn­tax pat­tern</a> to match <span class="my-code" decode="exclude">b-line</span> ele­ments from our parse tree and extract a list of line num­bers. That worked nicely because the lines were already acces­si­ble from the <span class="my-code" decode="exclude">LINE ...</span> pat­tern vari­able, and the line num­ber was in the same loca­tion of every line.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VvFuU&quot;)"></div><p id="a_VvFuU">This time, we can’t use that tech­nique. Unlike the line num­bers, our iden­ti­fiers could be any­where in the BASIC pro­gram. Some­how, we need to search the whole parse tree for uses of iden­ti­fiers, and extract them.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LKwEa&quot;)"></div><p id="a_LKwEa">We could do this by shak­ing the parse tree more vig­or­ously—for instance, recur­sively tak­ing it apart with <a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" class="docs" hyphens="none">match</a> and look­ing for iden­ti­fiers. This kind of frontal assault could work. But it also amounts to re-pars­ing the parse tree.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WoDRw&quot;)"></div><p id="a_WoDRw">There­fore it would be nice to some­how con­sol­i­date this work inside our parser. It turns out that we can use <a href="../basic/the-parser.html#cuts-and-splices">cuts and splices</a> in the parser—which we used before to sim­plify the parse tree—to also mark cer­tain ele­ments, like iden­ti­fiers, so they’re easy to find later.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;gone-but-not-forgotten&quot;)"></div><h3 anchor="gone-but-not-forgotten" class="subhead" id="gone-but-not-forgotten"><a href="#gone-but-not-forgotten">Gone but not for­got­ten</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lCqVs&quot;)"></div><p id="a_lCqVs">In <span class="my-code" decode="exclude">#lang brag</span>, when we use a cut on a rule name, or a splice on a pat­tern ele­ment, we end up remov­ing a rule name from a node in the parse tree. Sup­pose our gram­mar looks like this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wT6yW&quot;)"></div><div class="highlight-container" id="a_wT6yW"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>program : list<br/>list : "1" "2" "3"</div><div class="highlight" form="false" id="a_I7BsZ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>#lang brag
program : list
list : "1" "2" "3"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Fgcpe&quot;)"></div><p id="a_Fgcpe">The code <span class="my-code" decode="exclude">123</span> would be parsed like so:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6hPm4&quot;)"></div><div class="highlight-container" id="a_6hPm4"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">(program (list "1" "2" "3"))</div><div class="highlight" form="false" id="a_ozSWA"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>(program (list "1" "2" "3"))
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mkGYE&quot;)"></div><p id="a_mkGYE">If we apply a cut to the <span class="my-code" decode="exclude">list</span> rule:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8NlKn&quot;)"></div><div class="highlight-container" id="a_8NlKn"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>program : list<br/>/list : "1" "2" "3"</div><div class="highlight" form="false" id="a_7whqR"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>#lang brag
program : list
/list : "1" "2" "3"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wWWeD&quot;)"></div><p id="a_wWWeD">The <span class="my-code" decode="exclude">list</span> name dis­ap­pears from the parse tree, but the ele­ments remain:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_K3VJo&quot;)"></div><div class="highlight-container" id="a_K3VJo"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">(program ("1" "2" "3"))</div><div class="highlight" form="false" id="a_oakYr"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>(program ("1" "2" "3"))
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lqAWL&quot;)"></div><p id="a_lqAWL">Or, if we apply a splice to either appear­ance of <span class="my-code" decode="exclude">list</span> in the gram­mar:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QPdh8&quot;)"></div><div class="highlight-container" id="a_QPdh8"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>program : @list<br/>list : "1" "2" "3"</div><div class="highlight" form="false" id="a_fjaYU"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>#lang brag
program : @list
list : "1" "2" "3"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7du8n&quot;)"></div><p id="a_7du8n">Once again, the <span class="my-code" decode="exclude">list</span> name dis­ap­pears from the parse tree, and the ele­ments remain (though this time, those ele­ments are spliced into the sur­round­ing node):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3Spd0&quot;)"></div><div class="highlight-container" id="a_3Spd0"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">(program "1" "2" "3")</div><div class="highlight" form="false" id="a_XX7L3"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>(program "1" "2" "3")
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk9" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_blEHj&quot;)"></div><p id="a_blEHj">As a con­ve­nience in these cases, <span class="my-code" decode="exclude">#lang brag</span> pre­serves the rule name by adding it as a <em><a class="glossary" href="../appendix/glossary.html#syntax-property"><span class="glossary-link-text">syn­tax prop­erty</span></a></em> to the resid­ual ele­ments.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;introducing-syntax-properties&quot;)"></div><h3 anchor="introducing-syntax-properties" class="subhead" id="introducing-syntax-properties"><a href="#introducing-syntax-properties">Intro­duc­ing syn­tax prop­er­ties</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6Xp2m&quot;)"></div><p id="a_6Xp2m">A syn­tax prop­erty is a key–value field attached to a <a class="glossary" href="../appendix/glossary.html#syntax-object"><span class="glossary-link-text">syn­tax object</span></a>. The key has to be a sym­bol; the value can be any­thing. Syn­tax prop­er­ties are read and writ­ten using <a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a>. When writ­ing a prop­erty, <span class="my-code" decode="exclude">syntax-property</span> takes three argu­ments—syn­tax object, key, and value—and returns a syn­tax object with the updated field. When read­ing, it takes a syn­tax object and key and returns the match­ing value. If the syn­tax object doesn’t have a syn­tax prop­erty with that key, the result is <span class="my-code" decode="exclude">#f</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_voLTa&quot;)"></div><div class="highlight-container" id="a_voLTa"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define stx #'foobar)<br/>(define stx-with-prop (syntax-property stx 'my-key "my value"))<br/>(syntax-property stx 'my-key) ; #f<br/>(syntax-property stx-with-prop 'my-key) ; "my-value"<br/>(syntax-property stx-with-prop 'missing-key) ; #f</div><div class="highlight" form="false" id="a_3P4UX"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stx</span> <span class="o">#&#39;</span><span class="n">foobar</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">stx-with-prop</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx</span> <span class="o">&#39;</span><span class="ss">my-key</span> <span class="s2">"my value"</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx</span> <span class="o">&#39;</span><span class="ss">my-key</span><span class="p">)</span> <span class="c1">; #f</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx-with-prop</span> <span class="o">&#39;</span><span class="ss">my-key</span><span class="p">)</span> <span class="c1">; "my-value"</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx-with-prop</span> <span class="o">&#39;</span><span class="ss">missing-key</span><span class="p">)</span> <span class="c1">; #f</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YQe9v&quot;)"></div><p id="a_YQe9v">Syn­tax prop­er­ties offer us a way of anno­tat­ing a syn­tax object with arbi­trary meta­data that would oth­er­wise have to travel sep­a­rately. They’re always optional. But what’s nice about syn­tax prop­er­ties is that they behave like source loca­tions: once a syn­tax prop­erty is set, it stays attached to a piece of syn­tax through­out its trav­els.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_BQuLf&quot;)"></div><p id="a_BQuLf">A lim­i­ta­tion of syn­tax prop­er­ties, how­ever, is that they’re only avail­able while we’re manip­u­lat­ing our code as a syn­tax object (say, within a <a class="explainer" href="../explainer/macros.html">macro</a> at <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a>). Once the code enters <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a>, the syn­tax prop­er­ties are no longer avail­able. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">If a syn­tax-prop­erty value needs to be avail­able dur­ing run time, we can use a macro to extract it from the syn­tax object and “pro­mote” it to run time by writ­ing the value into new run-time code. See <a href="highlighting-run-time-errors.html">high­light­ing run-time errors</a> for an exam­ple.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_waiTW&quot;)"></div><p id="a_waiTW">For now, let’s see how sim­ple inspec­tion of syn­tax prop­er­ties works. First, we’ll look at the parse tree of a one-line pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_knwYH&quot;)"></div><div class="highlight-container" id="a_knwYH"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo/parse-only<br/>10 print 2 + 2</div><div class="highlight" form="false" id="a_xObF5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo/parse-only
<span class="nl">10</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="il">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">2</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkb" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_W8Ffd&quot;)"></div><div class="highlight-container" id="a_W8Ffd"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">'(b-program (b-line 10 (b-print (b-num-expr (b-sum 2 2)))))</div><div class="highlight" form="false" id="a_XCqJT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&#39;(b-program (b-line 10 (b-print (b-num-expr (b-sum 2 2)))))
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_E7GuC&quot;)"></div><p id="a_E7GuC">No big sur­prises there. But let’s switch to <span class="my-code" decode="exclude">#lang basic-demo/parse-stx</span>, which will reveal the whole syn­tax object that results from the parse process (we didn’t make this dialect in the first tuto­r­ial, but it’s included with the <span class="my-code" decode="exclude">beautiful-racket</span> library):</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TOwPl&quot;)"></div><div class="highlight-container" id="a_TOwPl"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo/parse-stx<br/>10 print 2 + 2</div><div class="highlight" form="false" id="a_aqYDW"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo/parse-stx
<span class="nl">10</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="il">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">2</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkd" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xiiqf&quot;)"></div><p id="a_xiiqf">This time, DrRacket prints a syn­tax object into the REPL:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpke&quot;)"></div><div id="a_Vldpke" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="stx-prop-01.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ns4Ib&quot;)"></div><p id="a_Ns4Ib">We can click on the tri­an­gle at the left of the syn­tax object to see what’s inside:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpkf&quot;)"></div><div id="a_Vldpkf" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="stx-prop-02.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GgA1J&quot;)"></div><p id="a_GgA1J">On the left we see the <a class="glossary" href="../appendix/glossary.html#datum"><span class="glossary-link-text">datum</span></a> inside the syn­tax object, which is the same as the sim­ple parse tree we saw before. On the right we see the extra infor­ma­tion that’s pack­aged into the syn­tax object.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XbtNF&quot;)"></div><p id="a_XbtNF">On the datum side, let’s click on the line num­ber <span class="my-code" decode="exclude">10</span>, which started out inside a <span class="my-code" decode="exclude">b-line-num</span> node:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpkg&quot;)"></div><div id="a_Vldpkg" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="stx-prop-03.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0WXq7&quot;)"></div><p id="a_0WXq7">This updates the right side of the win­dow with infor­ma­tion spe­cific to the nested syn­tax object <span class="my-code" decode="exclude">10</span>. As we can see, under <em>Known prop­er­ties</em>—a list of the syn­tax prop­er­ties attached to the object—is the prop­erty <span class="my-code" decode="exclude">'b-line-num</span>. The value is another syn­tax object, rep­re­sent­ing the orig­i­nal <span class="my-code" decode="exclude">'b-line-num</span> rule name that was omit­ted from the parse tree.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ShgCu&quot;)"></div><p id="a_ShgCu">Next, let’s go back to the datum side and click on the left paren­the­sis next to <span class="my-code" decode="exclude">b-print</span>. This high­lights the whole <span class="my-code" decode="exclude">b-print</span> expres­sion. Recall that this started out wrapped inside a <span class="my-code" decode="exclude">b-statement</span> rule, which got spliced out:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpkh&quot;)"></div><div id="a_Vldpkh" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="stx-prop-04.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0gDM0&quot;)"></div><p id="a_0gDM0">But as with <span class="my-code" decode="exclude">10</span>, we see that a syn­tax prop­erty called <span class="my-code" decode="exclude">'b-statement</span> exists. (We also see two other syn­tax prop­er­ties: <span class="my-code" decode="exclude">'splice-rh-id</span> and <span class="my-code" decode="exclude">'hide-or-splice</span>. These are pri­vate val­ues used by <span class="my-code" decode="exclude">brag</span> for other house­keep­ing.)</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oEK2u&quot;)"></div><p id="a_oEK2u">Finally, let’s click on either <span class="my-code" decode="exclude">2</span> inside <span class="my-code" decode="exclude">b-sum</span>. We see a syn­tax prop­erty for the <span class="my-code" decode="exclude">'b-number</span> node that was spliced out:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Vldpki&quot;)"></div><div id="a_Vldpki" style="text-align:center;padding:0.5rem;padding-bottom:1rem"><img style="width:90%;border:1px solid #ccc" src="stx-prop-05.gif"/></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9gBRy&quot;)"></div><p id="a_9gBRy">With that in mind, we can see the path toward imple­ment­ing BASIC vari­ables.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;what-about-input&quot;)"></div><h3 anchor="what-about-input" class="subhead" id="what-about-input"><a href="#what-about-input">What about input?</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_AzFNa&quot;)"></div><p id="a_AzFNa">Oh, right. The <span class="my-code" decode="exclude">input</span> state­ment is just a <span class="my-code" decode="exclude">let</span> that takes its ini­tial value from user input. When the pro­gram reaches the <span class="my-code" decode="exclude">input</span> state­ment, it will dis­play a prompt and wait for the user to enter a value:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rCWtB&quot;)"></div><div class="highlight-container" id="a_rCWtB"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 let x = 42<br/>20 input y<br/>30 print x ; y</div><div class="highlight" form="false" id="a_UxZFL"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">let</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">42</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">input</span><span class="w"> </span><span class="vg">y</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">y</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WAf4R&quot;)"></div><div class="highlight-container" id="a_WAf4R"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; joyce</div><div class="highlight" form="false" id="a_VqEBc"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>&gt; joyce
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UoX50&quot;)"></div><p id="a_UoX50">And then it fin­ishes:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_17q8W&quot;)"></div><div class="highlight-container" id="a_17q8W"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">42joyce</div><div class="highlight" form="false" id="a_bJhmo"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>42joyce
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5BJCi&quot;)"></div><p id="a_5BJCi">We’ll add sup­port for <span class="my-code" decode="exclude">input</span> as we work on <span class="my-code" decode="exclude">let</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;the-game-plan&quot;)"></div><h3 anchor="the-game-plan" class="subhead" id="the-game-plan"><a href="#the-game-plan">The game plan</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_k7NM0&quot;)"></div><p id="a_k7NM0">Now we’re ready. We have four tasks:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sBpNJ&quot;)"></div><p id="a_sBpNJ">Update our lexer to rec­og­nize iden­ti­fiers, as well as <span class="my-code" decode="exclude">let</span>, <span class="my-code" decode="exclude">=</span>, and <span class="my-code" decode="exclude">input</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lyszo&quot;)"></div><p id="a_lyszo">Update our parser with rules that rec­og­nize <span class="my-code" decode="exclude">let</span> and <span class="my-code" decode="exclude">input</span> state­ments, and our iden­ti­fiers. We’ll use splices to tag our iden­ti­fiers with a spe­cial syn­tax prop­erty so we can find them later.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mDzjH&quot;)"></div><p id="a_mDzjH">Update our <span class="my-code" decode="exclude">#%module-begin</span> macro to retrieve the iden­ti­fiers and <a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a> them before the pro­gram runs.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PjgaG&quot;)"></div><p id="a_PjgaG">Imple­ment the <span class="my-code" decode="exclude">let</span> and <span class="my-code" decode="exclude">input</span> state­ments with macros in the expander.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Hj8QV&quot;)"></div><p id="a_Hj8QV">Our goal will be to run this sam­ple pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tiGUi&quot;)"></div><div class="highlight-container" id="a_tiGUi"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 let x = "foo"<br/>20 y = 42<br/>30 let z = x<br/>40 input i<br/>50 print z ; y + y + 10 ; x ; i</div><div class="highlight" form="false" id="a_O1QkJ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">let</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"foo"</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">42</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">let</span><span class="w"> </span><span class="vg">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">input</span><span class="w"> </span><span class="vg">i</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">z</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">i</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iAlE2&quot;)"></div><p id="a_iAlE2">And get this result:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Tw3zG&quot;)"></div><div class="highlight-container" id="a_Tw3zG"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">foo94foojoyce</div><div class="highlight" form="false" id="a_QuYUu"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="n">foo94foojoyce</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkn" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_xJ8PR&quot;)"></div><p id="a_xJ8PR">Where <span class="my-code" decode="exclude">joyce</span> rep­re­sents what­ever value is entered at the user prompt.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;lexer-updates&quot;)"></div><h3 anchor="lexer-updates" class="subhead" id="lexer-updates"><a href="#lexer-updates">Lexer updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iauN9&quot;)"></div><p id="a_iauN9">In <span class="my-code" decode="exclude">"lexer.rkt"</span>, we make two changes:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/lexer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2CdDg&quot;)"></div><div class="highlight-container" id="a_2CdDg"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require brag/support)<br/><br/>(define-lex-abbrev digits (:+ (char-set "0123456789")))<br/><br/>(define-lex-abbrev reserved-terms (:or "print" "goto" "end" "+"<br/>":" ";" "let" "=" "input"))<br/><br/>(define basic-lexer<br/>  (lexer-srcloc<br/>   [(eof) (return-without-srcloc eof)]<br/>   ["\n" (token 'NEWLINE lexeme)]<br/>   [whitespace (token lexeme #:skip? #t)]<br/>   [(from/stop-before "rem" "\n") (token 'REM lexeme)]<br/>   [reserved-terms (token lexeme lexeme)]<br/>   [(:seq alphabetic (:* (:or alphabetic numeric "$")))<br/>    (token 'ID (string-&gt;symbol lexeme))]<br/>   [digits (token 'INTEGER (string-&gt;number lexeme))]<br/>   [(:or (:seq (:? digits) "." digits)<br/>         (:seq digits "."))<br/>    (token 'DECIMAL (string-&gt;number lexeme))]<br/>   [(:or (from/to "\"" "\"") (from/to "'" "'"))<br/>    (token 'STRING<br/>           (substring lexeme<br/>                      1 (sub1 (string-length lexeme))))]))<br/><br/>(provide basic-lexer)</div><div class="highlight" form="false" id="a_RdilY"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._define-lex-abbrev))" class="docs" hyphens="none">define-lex-abbrev</a></span> <span class="n">digits</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a+))" class="docs" hyphens="none">:+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._char-set))" class="docs" hyphens="none">char-set</a></span> <span class="s2">"0123456789"</span><span class="p">)))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._define-lex-abbrev))" class="docs" hyphens="none">define-lex-abbrev</a></span> <span class="n">reserved-terms</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="s2">"print"</span> <span class="s2">"goto"</span> <span class="s2">"end"</span> <span class="s2">"+"</span>
</span><span class="hll"><span class="s2">":"</span> <span class="s2">";"</span> <span class="s2">"let"</span> <span class="s2">"="</span> <span class="s2">"input"</span><span class="p">))</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">basic-lexer</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer-srcloc))" class="docs" hyphens="none">lexer-srcloc</a></span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._return-without-srcloc))" class="docs" hyphens="none">return-without-srcloc</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">NEWLINE</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._whitespace))" class="docs" hyphens="none">whitespace</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="kd">#:skip?</span> <span class="no">#t</span><span class="p">)]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/stop-before))" class="docs" hyphens="none">from/stop-before</a></span> <span class="s2">"rem"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">REM</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="n">reserved-terms</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a*))" class="docs" hyphens="none">:*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._numeric))" class="docs" hyphens="none">numeric</a></span> <span class="s2">"$"</span><span class="p">)))</span>
<span class="hll">    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">ID</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._string-~3esymbol))" class="docs" hyphens="none">string-&gt;symbol</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))]</span>
</span><span class="hll">   <span class="p">[</span><span class="n">digits</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">INTEGER</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))]</span>
</span>   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a~3f))" class="docs" hyphens="none">:?</a></span> <span class="n">digits</span><span class="p">)</span> <span class="s2">"."</span> <span class="n">digits</span><span class="p">)</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="n">digits</span> <span class="s2">"."</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">DECIMAL</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"&#39;"</span> <span class="s2">"&#39;"</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">STRING</span>
           <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._substring))" class="docs" hyphens="none">substring</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span>
                      <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-length))" class="docs" hyphens="none">string-length</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))))]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">basic-lexer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5uLYG&quot;)"></div><p id="a_5uLYG">We intro­duce a new lexer abbre­vi­a­tion called <span class="my-code" decode="exclude">reserved-terms</span>, because we’re going to be intro­duc­ing a lot more of them. We move our exist­ing terms there, plus <span class="my-code" decode="exclude">let</span> and <span class="my-code" decode="exclude">=</span> and <span class="my-code" decode="exclude">input</span>.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_a49Xx&quot;)"></div><p id="a_a49Xx">We also intro­duce a rule to match iden­ti­fiers, and put them into a token of type <span class="my-code" decode="exclude">'ID</span> as a sym­bol.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GjMNx&quot;)"></div><p id="a_GjMNx">Our rule for iden­ti­fiers fol­lows our <a href="#variables-in-basic">orig­i­nal spec­i­fi­ca­tion</a>: any sequence of <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a> or <a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._numeric))" class="docs" hyphens="none">numeric</a> char­ac­ters, or <span class="my-code" decode="exclude">$</span>, begin­ning with an alpha­betic char­ac­ter, so the full rule is this:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mSOwT&quot;)"></div><div class="highlight-container" id="a_mSOwT"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">(:seq alphabetic (:* (:or alphabetic numeric "$")))</div><div class="highlight" form="false" id="a_3dBbQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a*))" class="docs" hyphens="none">:*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._numeric))" class="docs" hyphens="none">numeric</a></span> <span class="s2">"$"</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkp" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_GS8ig&quot;)"></div><p id="a_GS8ig">We con­vert our iden­ti­fier lex­eme to a sym­bol with <a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._string-~3esymbol))" class="docs" hyphens="none">string-&gt;symbol</a>. Why? Things that exist as sym­bols in the parse tree (for instance, rule names) are treated as iden­ti­fiers by the <a class="glossary" href="../appendix/glossary.html#expander"><span class="glossary-link-text">expander</span></a>, and thus can have <a class="glossary" href="../appendix/glossary.html#binding"><span class="glossary-link-text">bind­ings</span></a> attached to them. Whereas strings that reach the expander always remain strings. Obvi­ously, we want our <span class="my-code" decode="exclude">'ID</span> tokens to be treated as iden­ti­fiers.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;parser-updates&quot;)"></div><h3 anchor="parser-updates" class="subhead" id="parser-updates"><a href="#parser-updates">Parser updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UqBwQ&quot;)"></div><p id="a_UqBwQ">Mov­ing on to <span class="my-code" decode="exclude">"parser.rkt"</span>:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/parser.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tOQlU&quot;)"></div><div class="highlight-container" id="a_tOQlU"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>b-program : [b-line] (/NEWLINE [b-line])*<br/>b-line : b-line-num [b-statement] (/":" [b-statement])* [b-rem]<br/>@b-line-num : INTEGER<br/>@b-statement : b-end | b-print | b-goto | b-let | b-input<br/>b-rem : REM<br/>b-end : /"end"<br/>b-print : /"print" [b-printable] (/";" [b-printable])*<br/>@b-printable : STRING | b-expr<br/>b-goto : /"goto" b-expr<br/>b-let : [/"let"] b-id /"=" (b-expr | STRING)<br/>b-input : /"input" b-id<br/>@b-id : ID<br/>b-expr : b-sum<br/>b-sum : b-number (/"+" b-number)*<br/>@b-number : INTEGER | DECIMAL | b-id</div><div class="highlight" form="false" id="a_AEDKE"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="source"><pre>#lang brag
b-program : [b-line] (/NEWLINE [b-line])*
b-line : b-line-num [b-statement] (/":" [b-statement])* [b-rem]
@b-line-num : INTEGER
<span class="hll">@b-statement : b-end | b-print | b-goto | b-let | b-input
</span>b-rem : REM
b-end : /"end"
b-print : /"print" [b-printable] (/";" [b-printable])*
@b-printable : STRING | b-expr
b-goto : /"goto" b-expr
<span class="hll">b-let : [/"let"] b-id /"=" (b-expr | STRING)
</span><span class="hll">b-input : /"input" b-id
</span><span class="hll">@b-id : ID
</span>b-expr : b-sum
b-sum : b-number (/"+" b-number)*
<span class="hll">@b-number : INTEGER | DECIMAL | b-id
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SrJ5x&quot;)"></div><p id="a_SrJ5x">We add three rules: <span class="my-code" decode="exclude">b-let</span>, <span class="my-code" decode="exclude">b-input</span>, and <span class="my-code" decode="exclude">b-id</span>. We add <span class="my-code" decode="exclude">b-let</span> and <span class="my-code" decode="exclude">b-input</span> as pos­si­ble matches on the right side of <span class="my-code" decode="exclude">b-statement</span>. We also add <span class="my-code" decode="exclude">b-id</span> to the <span class="my-code" decode="exclude">b-number</span> rule, so vari­ables can be used in  expres­sions (that’s a lit­tle casual, but we’ll do bet­ter when we get to <a href="expressions.html">expres­sions</a>). The <span class="my-code" decode="exclude">b-id</span> rule itself matches tokens of type <span class="my-code" decode="exclude">ID</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6sKZg&quot;)"></div><p id="a_6sKZg">As we have before, we use cuts on the right side of the <span class="my-code" decode="exclude">b-let</span> and <span class="my-code" decode="exclude">b-input</span> rules to omit syn­tac­tic ele­ments that we won’t need later.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KbZeV&quot;)"></div><p id="a_KbZeV">We also apply a splice to the <span class="my-code" decode="exclude">b-id</span> rule. This means that every­where <span class="my-code" decode="exclude">b-id</span> appears in the gram­mar, the iden­ti­fier will be spliced into the node. But it also means that these iden­ti­fiers will have their <span class="my-code" decode="exclude">b-id</span> syn­tax prop­erty set. Next, we use this syn­tax prop­erty to locate the iden­ti­fiers in the parse tree.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;updating-the-expander&quot;)"></div><h3 anchor="updating-the-expander" class="subhead" id="updating-the-expander"><a href="#updating-the-expander">Updat­ing the expander</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sbktI&quot;)"></div><p id="a_sbktI">We need to update our <span class="my-code" decode="exclude">#%module-begin</span> macro, and then imple­ment the <span class="my-code" decode="exclude">b-let</span> and <span class="my-code" decode="exclude">b-input</span> state­ments.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7HL6n&quot;)"></div><p id="a_7HL6n">In our <span class="my-code" decode="exclude">"expander.rkt"</span> mod­ule, we make two changes:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/expander.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jKNzf&quot;)"></div><div class="highlight-container" id="a_jKNzf"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br/quicklang<br/>(require "struct.rkt" "run.rkt" "elements.rkt")<br/>(provide (rename-out [b-module-begin #%module-begin])<br/>         (all-from-out "elements.rkt"))<br/><br/>(define-macro (b-module-begin (b-program LINE ...))<br/>  (with-pattern<br/>      ([((b-line NUM STMT ...) ...) #'(LINE ...)]<br/>       [(LINE-FUNC ...) (prefix-id "line-" #'(NUM ...))]<br/>       [(VAR-ID ...) (find-unique-var-ids #'(LINE ...))])<br/>    #'(#%module-begin<br/>       (define VAR-ID 0) ...<br/>       LINE ...<br/>       (define line-table<br/>         (apply hasheqv (append (list NUM LINE-FUNC) ...)))<br/>       (void (run line-table)))))<br/><br/>(begin-for-syntax<br/>  (require racket/list)<br/>  (define (find-unique-var-ids line-stxs)<br/>    (remove-duplicates<br/>     (for/list ([stx (in-list (stx-flatten line-stxs))]<br/>                #:when (syntax-property stx 'b-id))<br/>       stx)<br/>     #:key syntax-&gt;datum)))<br/>
</div><div class="highlight" form="false" id="a_AeAiu"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br/quicklang</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"run.rkt"</span> <span class="s2">"elements.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._rename-out))" class="docs" hyphens="none">rename-out</a></span> <span class="p">[</span><span class="n">b-module-begin</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span><span class="p">])</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._all-from-out))" class="docs" hyphens="none">all-from-out</a></span> <span class="s2">"elements.rkt"</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-module-begin</span> <span class="p">(</span><span class="n">b-program</span> <span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/syntax..rkt)._with-pattern))" class="docs" hyphens="none">with-pattern</a></span>
      <span class="p">([((</span><span class="n">b-line</span> <span class="n">NUM</span> <span class="n">STMT</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)]</span>
       <span class="p">[(</span><span class="n">LINE-FUNC</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._prefix-id))" class="docs" hyphens="none">prefix-id</a></span> <span class="s2">"line-"</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">NUM</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))]</span>
<span class="hll">       <span class="p">[(</span><span class="n">VAR-ID</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)</span> <span class="p">(</span><span class="n">find-unique-var-ids</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">))])</span>
</span>    <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/module.html#(form._((lib._racket/private/base..rkt)._~23~25module-begin))" class="docs" hyphens="none">#%module-begin</a></span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">VAR-ID</span> <span class="mi">0</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
       <span class="n">LINE</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">line-table</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hasheqv))" class="docs" hyphens="none">hasheqv</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._append))" class="docs" hyphens="none">append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="docs" hyphens="none">list</a></span> <span class="n">NUM</span> <span class="n">LINE-FUNC</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="docs" hyphens="none">...</a></span><span class="p">)))</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span> <span class="p">(</span><span class="n">run</span> <span class="n">line-table</span><span class="p">)))))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin-for-syntax))" class="docs" hyphens="none">begin-for-syntax</a></span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">racket/list</span><span class="p">)</span>
</span><span class="hll">  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">find-unique-var-ids</span> <span class="n">line-stxs</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._remove-duplicates))" class="docs" hyphens="none">remove-duplicates</a></span>
</span><span class="hll">     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" class="docs" hyphens="none">for/list</a></span> <span class="p">([</span><span class="n">stx</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-list))" class="docs" hyphens="none">in-list</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._stx-flatten))" class="docs" hyphens="none">stx-flatten</a></span> <span class="n">line-stxs</span><span class="p">))]</span>
</span><span class="hll">                <span class="kd">#:when</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxprops.html#(def._((quote._~23~25kernel)._syntax-property))" class="docs" hyphens="none">syntax-property</a></span> <span class="n">stx</span> <span class="o">&#39;</span><span class="ss">b-id</span><span class="p">))</span>
</span><span class="hll">       <span class="n">stx</span><span class="p">)</span>
</span><span class="hll">     <span class="kd">#:key</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3edatum))" class="docs" hyphens="none">syntax-&gt;datum</a></span><span class="p">)))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_JB5xw&quot;)"></div><p id="a_JB5xw">In <span class="my-code" decode="exclude">b-module-begin</span>, we add a <span class="my-code" decode="exclude">(VAR-ID ...)</span> pat­tern that matches the iden­ti­fiers in our parse tree, which we extract with the helper func­tion <span class="my-code" decode="exclude">find-unique-var-ids</span> (about which, more below). We also add <span class="my-code" decode="exclude">(define VAR-ID 0) ...</span> to the body of the macro, which will cre­ate the vari­ables with their default value of <span class="my-code" decode="exclude">0</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TqMR2&quot;)"></div><p id="a_TqMR2">Then the helper func­tion. Though a macro gen­er­ates code that is eval­u­ated at <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a> (also known as <a class="glossary" href="../appendix/glossary.html#phase-0"><span class="glossary-link-text">phase 0</span></a>), the code that imple­ments the macro itself is eval­u­ated at <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a> (also known as <a class="glossary" href="../appendix/glossary.html#phase-1"><span class="glossary-link-text">phase 1</span></a>). Racket is strict about keep­ing these phases sep­a­rate. So when we want to make a helper func­tion for the macro that we call from <em>out­side</em> the syn­tax tem­plate, we have to intro­duce that func­tion at phase 1.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_InWIn&quot;)"></div><p id="a_InWIn">Within the expander, an easy way to do this is wrap the func­tion in <a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin-for-syntax))" class="docs" hyphens="none">begin-for-syntax</a>, which is like <a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a>, but shifts its con­tents into phase 1.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_dMhmk&quot;)"></div><p id="a_dMhmk">The <span class="my-code" decode="exclude">find-unique-var-ids</span> func­tion itself works as fol­lows. We pass  the argu­ment <span class="my-code" decode="exclude">#'(LINE ...)</span>, which is a syn­tax object con­tain­ing all the <span class="my-code" decode="exclude">b-line</span> nodes from the parse tree. We use <a href="http://docs.racket-lang.org/br/index.html#(def._((lib._br/syntax..rkt)._stx-flatten))" class="docs" hyphens="none">stx-flatten</a> to turn it into a flat list of syn­tax objects. (In so doing, we demol­ish the struc­ture of the parse tree, but that doesn’t affect our search—it just makes the data a lit­tle eas­ier to han­dle.) We then iter­ate over these small syn­tax objects to find the ones with a <span class="my-code" decode="exclude">syntax-property</span> of <span class="my-code" decode="exclude">'b-id</span>. These are the droids we’re look­ing for. We col­lect them into a list.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_70O0i&quot;)"></div><p id="a_70O0i">Because an iden­ti­fier can show up any num­ber of times in a pro­gram, we use <a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._remove-duplicates))" class="docs" hyphens="none">remove-duplicates</a> to win­now our list to dis­tinct iden­ti­fiers. Strictly speak­ing, no syn­tax object con­tain­ing an iden­ti­fier will be a “dupli­cate” of another, because, among other things, they’ll all have unique <a class="glossary" href="../appendix/glossary.html#source-location"><span class="glossary-link-text">source loca­tions</span></a>. So we’d rather dis­re­gard these dif­fer­ences. To do this, we use the <span class="my-code" decode="exclude">#:key</span> argu­ment, which is a func­tion that’s applied to the ele­ments before com­par­ing them. We use <a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3edatum))" class="docs" hyphens="none">syntax-&gt;datum</a> for this argu­ment so we can com­pare our syn­tax objects just on the basis of their under­ly­ing datums.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_npQGa&quot;)"></div><p id="a_npQGa">Again, this is not the only way to find iden­ti­fiers in a parse tree. In this case, because we know we can find the iden­ti­fiers with the <span class="my-code" decode="exclude">'b-id</span> syn­tax prop­erty, we can do a smash-and-grab.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hmo5y&quot;)"></div><p id="a_hmo5y">Last, we add two macros to <span class="my-code" decode="exclude">"misc.rkt"</span> to han­dle our <span class="my-code" decode="exclude">b-let</span> and <span class="my-code" decode="exclude">b-input</span> state­ments:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/misc.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bJnNT&quot;)"></div><div class="highlight-container" id="a_bJnNT"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "struct.rkt")<br/>(provide b-rem b-print b-let b-input)<br/><br/>(define (b-rem val) (void))<br/><br/>(define (b-print . vals)<br/>  (displayln (string-append* (map ~a vals))))<br/><br/>(define-macro (b-let ID VAL) #'(set! ID VAL))<br/><br/>(define-macro (b-input ID)<br/>  #'(b-let ID (let* ([str (read-line)]<br/>                     [num (string-&gt;number (string-trim str))])<br/>                (or num str))))</div><div class="highlight" form="false" id="a_Uy0fK"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">b-rem</span> <span class="n">b-print</span> <span class="n">b-let</span> <span class="n">b-input</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-rem</span> <span class="n">val</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-print</span> <span class="o">.</span> <span class="n">vals</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" class="docs" hyphens="none">displayln</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-append*))" class="docs" hyphens="none">string-append*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" class="docs" hyphens="none">map</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/format..rkt)._~7ea))" class="docs" hyphens="none">~a</a></span> <span class="n">vals</span><span class="p">))))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">ID</span> <span class="n">VAL</span><span class="p">))</span>
</span>
<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-input</span> <span class="n">ID</span><span class="p">)</span>
</span><span class="hll">  <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">ID</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let*))" class="docs" hyphens="none">let*</a></span> <span class="p">([</span><span class="n">str</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a></span><span class="p">)]</span>
</span><span class="hll">                     <span class="p">[</span><span class="n">num</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((lib._racket/string..rkt)._string-trim))" class="docs" hyphens="none">string-trim</a></span> <span class="n">str</span><span class="p">))])</span>
</span><span class="hll">                <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="docs" hyphens="none">or</a></span> <span class="n">num</span> <span class="n">str</span><span class="p">))))</span>
</span></pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpks" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_C5wdu&quot;)"></div><p id="a_C5wdu">As promised, <span class="my-code" decode="exclude">b-let</span> sim­ply uses <a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a> to mutate the value of <span class="my-code" decode="exclude">ID</span>. <span class="my-code" decode="exclude">b-input</span> is phrased in terms of <span class="my-code" decode="exclude">b-let</span>. It uses the Racket library func­tion <a href="http://docs.racket-lang.org/reference/Byte_and_String_Input.html#(def._((quote._~23~25kernel)._read-line))" class="docs" hyphens="none">read-line</a> to get input from a user prompt. By default, the input from <span class="my-code" decode="exclude">read-line</span> is a string. We attempt to con­vert it to a num­ber with <a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a>. But if that returns <span class="my-code" decode="exclude">#f</span>, we return the raw <span class="my-code" decode="exclude">str</span> value.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-our-variables&quot;)"></div><h3 anchor="testing-our-variables" class="subhead" id="testing-our-variables"><a href="#testing-our-variables">Test­ing our vari­ables</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3RLiN&quot;)"></div><p id="a_3RLiN">Let’s try our sam­ple pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hAgBa&quot;)"></div><div class="highlight-container" id="a_hAgBa"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 let x = "foo"<br/>20 y = 42<br/>30 let z = x<br/>40 input i<br/>50 print z ; y + y + 10 ; x ; i</div><div class="highlight" form="false" id="a_DE2cn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">let</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"foo"</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">42</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">let</span><span class="w"> </span><span class="vg">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">input</span><span class="w"> </span><span class="vg">i</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">z</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">i</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkt" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TtKKM&quot;)"></div><p id="a_TtKKM">When we run it, the pro­gram should stop at line <span class="my-code" decode="exclude">40</span> and put up a prompt at the REPL. We put in a value and type <span class="my-code" decode="exclude">enter</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_WAf4Rw&quot;)"></div><div class="highlight-container" id="a_WAf4Rw"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">&gt; joyce</div><div class="highlight" form="false" id="a_VqEBcu"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" class="docs" hyphens="none">&gt;</a></span> <span class="n">joyce</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkv" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_cFMBz&quot;)"></div><p id="a_cFMBz">And then the pro­gram should fin­ish:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Tw3zGz&quot;)"></div><div class="highlight-container" id="a_Tw3zGz"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">foo94foojoyce</div><div class="highlight" form="false" id="a_QuYUux"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="n">foo94foojoyce</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_EjMjv&quot;)"></div><p id="a_EjMjv">Our per­sis­tence has paid off. By choos­ing to model our BASIC vari­ables as Racket vari­ables—rather than a hash table—we took a slightly steeper route. But in so doing, we made things sim­pler for our­selves as we con­tinue to extend the lan­guage.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jUrEA&quot;)"></div><p id="a_jUrEA">We’ve shown we can assign, print, and add vari­ables. But if we want do more elab­o­rate oper­a­tions, we’ll have to upgrade our han­dling of expres­sions and val­ues. That’s next.</p></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="the-syntax-colorer.html">3&emsp;the syn­tax col­orer</a></li><li><a href="better-line-errors.html">4&emsp;bet­ter line errors</a></li><li><a class="here" href="variables-and-input.html">5&emsp;vari­ables and input</a></li><li><a href="expressions.html">6&emsp;expres­sions</a></li><li><a href="conditionals.html">7&emsp;con­di­tion­als</a></li><li><a href="subroutines-and-loops.html">8&emsp;sub­rou­tines and loops</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="better-line-errors.html">← prev</a>
    <a class="nav-right" href="expressions.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>