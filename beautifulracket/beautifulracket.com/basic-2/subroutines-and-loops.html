<!DOCTYPE html>
<html>
  
<!-- Mirrored from beautifulracket.com/basic-2/subroutines-and-loops.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 16 Mar 2017 05:48:11 GMT -->
<head>
    <meta charset="UTF-8">
    <title>Beautiful Racket: Into the rapids: more basic</title>
    <link rel="stylesheet" type="text/css" media="all" href="../styles.css"/>
    <script type="text/javascript" src="../functions.js"></script>
    <script type="text/javascript" src="../clipboard.min.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-74684045-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>
<body>
<div id="alert">Thank you for your comment</div>
    <div id="doc"><h3 class="dept" anchorize="false"><a href="../index.html">Beau­ti­ful Racket</a> / <a href="../index.html#tutorials">tuto­ri­als</a></h3><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;into-the-rapids-more-basic&quot;)"></div><h1 anchor="into-the-rapids-more-basic" id="into-the-rapids-more-basic" hyphens="none">Into the rapids: more <span class="my-code" decode="exclude">basic</span></h1></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="the-syntax-colorer.html">3&emsp;the syn­tax col­orer</a></li><li><a href="better-line-errors.html">4&emsp;bet­ter line errors</a></li><li><a href="variables-and-input.html">5&emsp;vari­ables and input</a></li><li><a href="expressions.html">6&emsp;expres­sions</a></li><li><a href="conditionals.html">7&emsp;con­di­tion­als</a></li><li><a class="here" href="subroutines-and-loops.html">8&emsp;sub­rou­tines and loops</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_m3elb&quot;)"></div><p id="a_m3elb">No self-respect­ing BASIC tuto­r­ial would be com­plete with­out two indis­pens­able con­trol-flow tools—sub­rou­tines made with <span class="my-code" decode="exclude">gosub</span> and <span class="my-code" decode="exclude">return</span>, and loops made with <span class="my-code" decode="exclude">for</span> and <span class="my-code" decode="exclude">next</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_3OXGH&quot;)"></div><p id="a_3OXGH">To make these, we’re going to use a new tool: <a class="glossary" href="../appendix/glossary.html#continuation"><span class="glossary-link-text">con­tin­u­a­tions</span></a>. Con­tin­u­a­tions have a rep­u­ta­tion for being weird and com­pli­cated. They’re not. But it’ll be eas­ier to see why if we first under­stand why our other options won’t work.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;subroutines&quot;)"></div><h3 anchor="subroutines" class="subhead" id="subroutines"><a href="#subroutines">Sub­rou­tines</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Y2JB2&quot;)"></div><p id="a_Y2JB2"><span class="my-code" decode="exclude">gosub</span> is short for “go to sub­rou­tine”. It’s meant to com­pen­sate for the less-than-stel­lar sup­port for named func­tions in BASIC. <span class="my-code" decode="exclude">gosub</span> starts out likle <span class="my-code" decode="exclude">goto</span>, in that it takes a num­ber or numer­i­cal expres­sion as an argu­ment. When the pro­gram arrives at a <span class="my-code" decode="exclude">gosub</span>, it jumps to the line indi­cated.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8azp8&quot;)"></div><p id="a_8azp8">The dif­fer­ence is that when the pro­gram encoun­ters a <span class="my-code" decode="exclude">return</span> state­ment, it jumps back to the most recent <span class="my-code" decode="exclude">gosub</span> and con­tin­ues nor­mally. So it’s like a round-trip ver­sion of <span class="my-code" decode="exclude">goto</span>, mak­ing it eas­ier to move through the pro­gram in a non-lin­ear fash­ion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_HRgzm&quot;)"></div><div class="highlight-container" id="a_HRgzm"><div id="code_43" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 gosub 50<br/>20 gosub 70<br/>30 print "third"<br/>40 end<br/>50 print "first"<br/>60 return<br/>70 print "second"<br/>80 return</div><div class="highlight" form="false" id="a_7jN3d"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">50</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">70</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"third"</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"first"</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">return</span>
<span class="nl">70</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"second"</span>
<span class="nl">80</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk" data-clipboard-target="#code_43" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_d15mg&quot;)"></div><div class="highlight-container" id="a_d15mg"><div id="code_44" form="false" decode="exclude" style="font-size:0;width:0;height:0">first<br/>second<br/>third</div><div class="highlight" form="false" id="a_m6l0Q"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>first
second
third
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk1" data-clipboard-target="#code_44" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YG6fN&quot;)"></div><p id="a_YG6fN">By com­bin­ing vari­able assign­ment with <span class="my-code" decode="exclude">gosub</span>, we can approx­i­mate the behav­ior of call­ing a func­tion:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_FHdt7&quot;)"></div><div class="highlight-container" id="a_FHdt7"><div id="code_45" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 x = 11 : gosub 30 : gosub 30 : gosub 30<br/>20 end<br/>30 print x : x = x + 1<br/>40 return</div><div class="highlight" form="false" id="a_NolA1"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">11</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">30</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">30</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">30</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">1</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk2" data-clipboard-target="#code_45" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6URFF&quot;)"></div><div class="highlight-container" id="a_6URFF"><div id="code_46" form="false" decode="exclude" style="font-size:0;width:0;height:0">11<br/>12<br/>13</div><div class="highlight" form="false" id="a_NFGxb"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>11
12
13
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk3" data-clipboard-target="#code_46" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9aNgQ&quot;)"></div><p id="a_9aNgQ">We don’t actu­ally pass argu­ments to a <span class="my-code" decode="exclude">gosub</span>, nor does <span class="my-code" decode="exclude">return</span> pro­vide a value. They’re just con­trol-flow state­ments. The shar­ing of val­ues hap­pens via global BASIC vari­ables.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_8T9Bc&quot;)"></div><p id="a_8T9Bc">Fur­ther­more, <span class="my-code" decode="exclude">gosub</span> can appear among other state­ments in a line (includ­ing other <span class="my-code" decode="exclude">gosub</span> state­ments). That means that <span class="my-code" decode="exclude">return</span> can’t just be short­hand for <span class="my-code" decode="exclude">goto</span>: we might have to <span class="my-code" decode="exclude">return</span> to the mid­dle of a line, which <span class="my-code" decode="exclude">goto</span> can’t han­dle.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uCWeT&quot;)"></div><p id="a_uCWeT">A <span class="my-code" decode="exclude">gosub</span> can also be invoked within a con­di­tional:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_1Mnl8&quot;)"></div><div class="highlight-container" id="a_1Mnl8"><div id="code_47" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 x = 2 : y = 4<br/>20 if x &lt; y then gosub 40<br/>30 end<br/>40 print "less"<br/>50 return</div><div class="highlight" form="false" id="a_TBwjO"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">4</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">if</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="vg">then</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">40</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"less"</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk4" data-clipboard-target="#code_47" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_H1sGT&quot;)"></div><div class="highlight-container" id="a_H1sGT"><div id="code_48" form="false" decode="exclude" style="font-size:0;width:0;height:0">less</div><div class="highlight" form="false" id="a_GvqKv"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre>less
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk5" data-clipboard-target="#code_48" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;loops&quot;)"></div><h3 anchor="loops" class="subhead" id="loops"><a href="#loops">Loops</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_18qur&quot;)"></div><p id="a_18qur">It’s pos­si­ble to make loops with <span class="my-code" decode="exclude">if</span> and <span class="my-code" decode="exclude">goto</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_G8PHN&quot;)"></div><div class="highlight-container" id="a_G8PHN"><div id="code_49" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 if x &lt; 4 then print x else 30<br/>20 x = x + 1 : goto 10<br/>30 end</div><div class="highlight" form="false" id="a_typQx"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">if</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="il">4</span><span class="w"> </span><span class="vg">then</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="vg">else</span><span class="w"> </span><span class="il">30</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="il">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">goto</span><span class="w"> </span><span class="il">10</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">end</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk6" data-clipboard-target="#code_49" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rWl5R&quot;)"></div><div class="highlight-container" id="a_rWl5R"><div id="code_50" form="false" decode="exclude" style="font-size:0;width:0;height:0">0<br/>1<br/>2<br/>3</div><div class="highlight" form="false" id="a_kCuRj"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>0
1
2
3
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk7" data-clipboard-target="#code_50" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_43hS2&quot;)"></div><p id="a_43hS2">But often, writ­ing the loop with <span class="my-code" decode="exclude">for</span> and <span class="my-code" decode="exclude">next</span> is sim­pler:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DkpkR&quot;)"></div><div class="highlight-container" id="a_DkpkR"><div id="code_51" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 for x = 0 to 3<br/>20 print x<br/>30 next x</div><div class="highlight" form="false" id="a_8gQeB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">0</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpk8" data-clipboard-target="#code_51" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rWl5Rb&quot;)"></div><div class="highlight-container" id="a_rWl5Rb"><div id="code_52" form="false" decode="exclude" style="font-size:0;width:0;height:0">0<br/>1<br/>2<br/>3</div><div class="highlight" form="false" id="a_kCuRj9"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>0
1
2
3
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpka" data-clipboard-target="#code_52" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YCeYO&quot;)"></div><p id="a_YCeYO"><span class="my-code" decode="exclude">for</span> defines the start­ing and end­ing val­ues of a loop vari­able. The pro­gram pro­ceeds until it reaches a <span class="my-code" decode="exclude">next</span> ref­er­enc­ing the same loop vari­able. Then it incre­ments the loop vari­able, returns to the top of the loop, and keeps going. When the loop vari­able exceeds the end­ing value, the loop ends and the pro­gram con­tin­ues.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2HBFI&quot;)"></div><p id="a_2HBFI">The state­ments between the <span class="my-code" decode="exclude">for</span> and <span class="my-code" decode="exclude">next</span> have no spe­cial sta­tus (e.g., they’re not rec­og­nized as a “block”). Con­trol can leave the loop and come back:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_oSbUZ&quot;)"></div><div class="highlight-container" id="a_oSbUZ"><div id="code_53" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 for x = 0 to 3<br/>20 gosub 50<br/>30 next x<br/>40 end<br/>50 print x<br/>60 return</div><div class="highlight" form="false" id="a_jvXKS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">0</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">50</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkc" data-clipboard-target="#code_53" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rWl5Rf&quot;)"></div><div class="highlight-container" id="a_rWl5Rf"><div id="code_54" form="false" decode="exclude" style="font-size:0;width:0;height:0">0<br/>1<br/>2<br/>3</div><div class="highlight" form="false" id="a_kCuRjd"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>0
1
2
3
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpke" data-clipboard-target="#code_54" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7HQew&quot;)"></div><p id="a_7HQew">By default, the loop vari­able is incre­mented by <span class="my-code" decode="exclude">1</span> on each pass. This can be adjusted with an optional <span class="my-code" decode="exclude">step</span> value at the top of the loop:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4nA4e&quot;)"></div><div class="highlight-container" id="a_4nA4e"><div id="code_55" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 for x = 0 to 3 step .5<br/>20 print x<br/>30 next x</div><div class="highlight" form="false" id="a_KDP4E"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">0</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span><span class="w"> </span><span class="vg">step</span><span class="w"> </span><span class="mf">.5</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkg" data-clipboard-target="#code_55" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VFyCd&quot;)"></div><div class="highlight-container" id="a_VFyCd"><div id="code_56" form="false" decode="exclude" style="font-size:0;width:0;height:0">0<br/>0.5<br/>1<br/>1.5<br/>2<br/>2.5<br/>3</div><div class="highlight" form="false" id="a_pdInJ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="source"><pre>0
0.5
1
1.5
2
2.5
3
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkh" data-clipboard-target="#code_56" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;designing-subroutines-and-loops&quot;)"></div><h3 anchor="designing-subroutines-and-loops" class="subhead" id="designing-subroutines-and-loops"><a href="#designing-subroutines-and-loops">Design­ing sub­rou­tines and loops</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_M37XQ&quot;)"></div><p id="a_M37XQ">The key fea­ture shared by sub­rou­tines and loops is that they both jump back to an ear­lier point in the pro­gram. <span class="my-code" decode="exclude">return</span> jumps back to a cor­re­spond­ing <span class="my-code" decode="exclude">gosub</span>; <span class="my-code" decode="exclude">next</span> to a cor­re­spond­ing <span class="my-code" decode="exclude">for</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LUrn2&quot;)"></div><p id="a_LUrn2">“OK, then we can model them as vari­ants of <span class="my-code" decode="exclude">goto</span>.” Good idea, but there’s more to the story. <span class="my-code" decode="exclude">goto</span> gets its des­ti­na­tion from an explicit value passed as an argu­ment. <span class="my-code" decode="exclude">return</span> and <span class="my-code" decode="exclude">next</span>, by con­trast, have to infer their des­ti­na­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ocu4S&quot;)"></div><p id="a_ocu4S">For instance, in this pro­gram, <span class="my-code" decode="exclude">gosub</span> is called twice, so the <span class="my-code" decode="exclude">return</span> first sends us back to line <span class="my-code" decode="exclude">10</span>, and then to line <span class="my-code" decode="exclude">20</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XWi2U&quot;)"></div><div class="highlight-container" id="a_XWi2U"><div id="code_57" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 x = 10 : gosub 40<br/>20 x = 20 : gosub 40<br/>30 end<br/>40 print x<br/>50 return</div><div class="highlight" form="false" id="a_oZuf5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">10</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">40</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">20</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">40</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpki" data-clipboard-target="#code_57" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_D9T2S&quot;)"></div><div class="highlight-container" id="a_D9T2S"><div id="code_58" form="false" decode="exclude" style="font-size:0;width:0;height:0">10<br/>20</div><div class="highlight" form="false" id="a_VNZzj"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>10
20
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkj" data-clipboard-target="#code_58" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_h63XP&quot;)"></div><p id="a_h63XP">In this case, the same <span class="my-code" decode="exclude">return</span> state­ment sends us to two dif­fer­ent des­ti­na­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9ctux&quot;)"></div><p id="a_9ctux">With <span class="my-code" decode="exclude">next</span>, the pres­ence of the loop vari­able as an argu­ment pro­vides a clue where to go. <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">In real BASIC, the loop vari­able can be omit­ted from <span class="my-code" decode="exclude">next</span>. We’re not going to imple­ment that ver­sion, though the dif­fer­ence is just a lit­tle extra house­keep­ing.</span></span> In prin­ci­ple, at <a class="glossary" href="../appendix/glossary.html#compile-time"><span class="glossary-link-text">com­pile time</span></a>, we could sift through the lines of the pro­gram to find the cor­re­spond­ing <span class="my-code" decode="exclude">for</span> state­ment, and stash it inside the <span class="my-code" decode="exclude">next</span>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zUYyc&quot;)"></div><div class="highlight-container" id="a_zUYyc"><div id="code_59" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 for x = 0 to 3<br/>20 print x<br/>30 next x rem we could make this mean `goto 10`</div><div class="highlight" form="false" id="a_zZOxr"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">0</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="vg">rem</span><span class="w"> </span><span class="vg">we</span><span class="w"> </span><span class="vg">could</span><span class="w"> </span><span class="vg">make</span><span class="w"> </span><span class="vg">this</span><span class="w"> </span><span class="vg">mean</span><span class="w"> </span><span class="err">`</span><span class="vg">goto</span><span class="w"> </span><span class="il">10</span><span class="err">`</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkk" data-clipboard-target="#code_59" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SRGys&quot;)"></div><p id="a_SRGys">The prob­lem is that a loop vari­able can be used any num­ber of times, so match­ing <span class="my-code" decode="exclude">next</span> state­ments to <span class="my-code" decode="exclude">for</span> state­ments might get com­pli­cated:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SfoOU&quot;)"></div><div class="highlight-container" id="a_SfoOU"><div id="code_60" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 for x = 0 to 3 : print x : next x<br/>20 for x = 4 to 6<br/>30 print x<br/>40 next x<br/>50 for x = 7 to 9<br/>60 print x<br/>40 next x</div><div class="highlight" form="false" id="a_1rglm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">0</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">4</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">6</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">7</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">9</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkl" data-clipboard-target="#code_60" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_D5jH5&quot;)"></div><p id="a_D5jH5">But wait—there’s more. A <span class="my-code" decode="exclude">next</span> state­ment doesn’t just jump back to the <span class="my-code" decode="exclude">for</span>. It acts as a con­di­tional: it incre­ments the loop vari­able, checks whether it exceeds the max­i­mum allowed value, and if so, allows the loop to exit.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_qmDPf&quot;)"></div><p id="a_qmDPf">So <span class="my-code" decode="exclude">next</span> needs to know not only the line num­ber of the cor­re­spond­ing <span class="my-code" decode="exclude">for</span>, but also the end value of its loop. We won’t nec­es­sar­ily be able to deter­mine this end value until the pro­gram is run­ning:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_2TA6X&quot;)"></div><div class="highlight-container" id="a_2TA6X"><div id="code_61" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 for x = 1 to 3<br/>20 for y = 1 to x<br/>30 print x ; y<br/>40 next y : next x</div><div class="highlight" form="false" id="a_uhixs"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">1</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">1</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">y</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">y</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkm" data-clipboard-target="#code_61" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QWgza&quot;)"></div><div class="highlight-container" id="a_QWgza"><div id="code_62" form="false" decode="exclude" style="font-size:0;width:0;height:0">11<br/>21<br/>22<br/>31<br/>32<br/>33</div><div class="highlight" form="false" id="a_Ucpkm"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre>11
21
22
31
32
33
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkn" data-clipboard-target="#code_62" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ACmWZ&quot;)"></div><p id="a_ACmWZ">Here, the <span class="my-code" decode="exclude">y</span> loop runs three times, and <span class="my-code" decode="exclude">next y</span> tests for a dif­fer­ent max­i­mum value each time.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_x4Vo6&quot;)"></div><p id="a_x4Vo6">We’re back in the same sit­u­a­tion that we were with <span class="my-code" decode="exclude">return</span>, where the behav­ior of the <span class="my-code" decode="exclude">next</span> state­ment nec­es­sar­ily depends on con­text only avail­able at <a class="glossary" href="../appendix/glossary.html#run-time"><span class="glossary-link-text">run time</span></a>. So we can’t rely on fig­ur­ing out every­thing at com­pile time. Instead, we’d like to cap­ture cer­tain run-time con­text when we reach a <span class="my-code" decode="exclude">gosub</span> or <span class="my-code" decode="exclude">for</span>, and save it so that it’s avail­able when we encounter the cor­re­spond­ing <span class="my-code" decode="exclude">return</span> or <span class="my-code" decode="exclude">next</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0JPor&quot;)"></div><p id="a_0JPor">That’s exactly what con­tin­u­a­tions are for.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;introducing-continuations&quot;)"></div><h3 anchor="introducing-continuations" class="subhead" id="introducing-continuations"><a href="#introducing-continuations">Intro­duc­ing con­tin­u­a­tions</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jrEbD&quot;)"></div><p id="a_jrEbD">A con­tin­u­a­tion in a Racket pro­gram is a spe­cial kind of func­tion that serves a sim­i­lar pur­pose as a line num­ber in BASIC: it marks a ref­er­ence point within the pro­gram that we can return to later. Of course, a Racket pro­gram is struc­tured around expres­sions, not lines. So a con­tin­u­a­tion can be cap­tured at the posi­tion of any expres­sion.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ey0eI&quot;)"></div><p id="a_Ey0eI">For exam­ple, if we have a pro­gram with four expres­sion posi­tions: <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">Namely: a func­tion, two strings, and the result of apply­ing the func­tion to the strings.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_4UJv3&quot;)"></div><div class="highlight-container" id="a_4UJv3"><div id="code_63" form="false" decode="exclude" style="font-size:0;width:0;height:0">(string-append "foo" "bar")</div><div class="highlight" form="false" id="a_pkxol"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="s2">"foo"</span> <span class="s2">"bar"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpko" data-clipboard-target="#code_63" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ZUGvH&quot;)"></div><p id="a_ZUGvH">We can cap­ture the con­tin­u­a­tion at the <span class="my-code" decode="exclude">"foo"</span> posi­tion  by wrap­ping it in <a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a>:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_26QFX&quot;)"></div><div class="highlight-container" id="a_26QFX"><div id="code_64" form="false" decode="exclude" style="font-size:0;width:0;height:0">(string-append (let/cc this-cc<br/>                 "foo") "bar")</div><div class="highlight" form="false" id="a_JYndu"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">this-cc</span>
                 <span class="s2">"foo"</span><span class="p">)</span> <span class="s2">"bar"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkp" data-clipboard-target="#code_64" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_ecpIv&quot;)"></div><p id="a_ecpIv">Here, <span class="my-code" decode="exclude">let/cc</span> cap­tures the cur­rent con­tin­u­a­tion (hence <span class="my-code" decode="exclude">cc</span>) and assigns it to <span class="my-code" decode="exclude">this-cc</span> (or what­ever name we choose). <span class="tooltip" onclick="this.classList.toggle('tooltip_visible')"> + <span class="tooltip-inner">There are other func­tions that also cap­ture con­tin­u­a­tions, but <span class="my-code" decode="exclude">let/cc</span> will suf­fice for every­thing we need to do.</span></span></p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_VXH8a&quot;)"></div><p id="a_VXH8a"><span class="my-code" decode="exclude">let/cc</span> oth­er­wise works like ordi­nary <a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" class="docs" hyphens="none">let</a>: after cap­tur­ing the con­tin­u­a­tion, it eval­u­ates the expres­sions within and returns the last as its result. So both these pro­grams eval­u­ate to <span class="my-code" decode="exclude">"foobar"</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hwqu3&quot;)"></div><p id="a_hwqu3">If we want to save the con­tin­u­a­tion for later use, we can stash it inside another vari­able:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_y5osv&quot;)"></div><div class="highlight-container" id="a_y5osv"><div id="code_65" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define my-cc #f)<br/>(string-append (let/cc this-cc<br/>                 (set! my-cc this-cc)<br/>                 "foo") "bar")<br/>(procedure? my-cc) ; #t<br/>(continuation? my-cc) ; #t</div><div class="highlight" form="false" id="a_SxrsZ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">my-cc</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">this-cc</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">my-cc</span> <span class="n">this-cc</span><span class="p">)</span>
                 <span class="s2">"foo"</span><span class="p">)</span> <span class="s2">"bar"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((quote._~23~25kernel)._procedure~3f))" class="docs" hyphens="none">procedure?</a></span> <span class="n">my-cc</span><span class="p">)</span> <span class="c1">; #t</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(def._((quote._~23~25kernel)._continuation~3f))" class="docs" hyphens="none">continuation?</a></span> <span class="n">my-cc</span><span class="p">)</span> <span class="c1">; #t</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkq" data-clipboard-target="#code_65" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ylh9U&quot;)"></div><p id="a_Ylh9U">OK, we’ve cap­tured a con­tin­u­a­tion. What can we do with it? The con­tin­u­a­tion is a func­tion that takes one argu­ment. When we call the con­tin­u­a­tion, it returns us to the posi­tion in the pro­gram where the con­tin­u­a­tion was cap­tured (that is, the posi­tion of the <span class="my-code" decode="exclude">let/cc</span>). The argu­ment to the con­tin­u­a­tion is used as the new value at that posi­tion (that is, it “replaces” the <span class="my-code" decode="exclude">let/cc</span>). If the con­tin­u­a­tion leaves us in the mid­dle of a larger expres­sion, the sur­round­ing expres­sion is re-eval­u­ated. So if we call <span class="my-code" decode="exclude">my-cc</span> with <span class="my-code" decode="exclude">"zam"</span> as the argu­ment:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Oy3yj&quot;)"></div><div class="highlight-container" id="a_Oy3yj"><div id="code_66" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define my-cc #f)<br/>(string-append (let/cc this-cc<br/>                 (set! my-cc this-cc)<br/>                 "foo") "bar")<br/>(my-cc "zam")</div><div class="highlight" form="false" id="a_azfuI"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">my-cc</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">this-cc</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">my-cc</span> <span class="n">this-cc</span><span class="p">)</span>
                 <span class="s2">"foo"</span><span class="p">)</span> <span class="s2">"bar"</span><span class="p">)</span>
<span class="p">(</span><span class="n">my-cc</span> <span class="s2">"zam"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkr" data-clipboard-target="#code_66" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_LQyDa&quot;)"></div><p id="a_LQyDa">We cause <a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a> to be eval­u­ated a sec­ond time with <span class="my-code" decode="exclude">"zam"</span> instead of <span class="my-code" decode="exclude">"foo"</span> as the first argu­ment:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PYmUI&quot;)"></div><div class="highlight-container" id="a_PYmUI"><div id="code_67" form="false" decode="exclude" style="font-size:0;width:0;height:0">"foobar"<br/>"zambar"</div><div class="highlight" form="false" id="a_FfGIR"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>"foobar"
"zambar"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpks" data-clipboard-target="#code_67" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_H9uT5&quot;)"></div><p id="a_H9uT5">If we cap­ture a con­tin­u­a­tion at the <span class="my-code" decode="exclude">string-append</span> instead, every­thing works the same way, but now we can use the con­tin­u­a­tion to change the func­tion applied to the argu­ments, rather than one of the argu­ments:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_5zNP5&quot;)"></div><div class="highlight-container" id="a_5zNP5"><div id="code_68" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define my-cc #f)<br/>((let/cc this-cc<br/>   (set! my-cc this-cc)<br/>   string-append) "foo" "bar")<br/>(my-cc (λ strs (apply string-append<br/>                      (reverse (map string-upcase strs)))))</div><div class="highlight" form="false" id="a_5Imwa"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">my-cc</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">this-cc</span>
   <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">my-cc</span> <span class="n">this-cc</span><span class="p">)</span>
   <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span><span class="p">)</span> <span class="s2">"foo"</span> <span class="s2">"bar"</span><span class="p">)</span>
<span class="p">(</span><span class="n">my-cc</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" class="docs" hyphens="none">λ</a></span> <span class="n">strs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/procedures.html#(def._((lib._racket/private/base..rkt)._apply))" class="docs" hyphens="none">apply</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span>
                      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" class="docs" hyphens="none">reverse</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._map))" class="docs" hyphens="none">map</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-upcase))" class="docs" hyphens="none">string-upcase</a></span> <span class="n">strs</span><span class="p">)))))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkt" data-clipboard-target="#code_68" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jaT55&quot;)"></div><div class="highlight-container" id="a_jaT55"><div id="code_69" form="false" decode="exclude" style="font-size:0;width:0;height:0">"foobar"<br/>"BARFOO"</div><div class="highlight" form="false" id="a_zb8BP"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>"foobar"
"BARFOO"
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpku" data-clipboard-target="#code_69" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_SJmhQ&quot;)"></div><p id="a_SJmhQ">If this still seems weird, we can think of the con­tin­u­a­tion as a way of con­vert­ing an ordi­nary expres­sion into a func­tion of an argu­ment <span class="my-code" decode="exclude">x</span>, where <span class="my-code" decode="exclude">x</span> goes in the posi­tion marked by <span class="my-code" decode="exclude">let/cc</span>. Below, the func­tion <span class="my-code" decode="exclude">cc-ish</span> roughly approx­i­mates how <span class="my-code" decode="exclude">let/cc</span> works:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_sSaKK&quot;)"></div><div class="highlight-container" id="a_sSaKK"><div id="code_70" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define my-cc #f)<br/>(string-append (let/cc this-cc<br/>                 (set! my-cc this-cc)<br/>                 "foo") "bar") ; "foobar"<br/>(my-cc "zam") ; "zambar"<br/><br/>(define (cc-ish [x "foo"]) (string-append x "bar"))<br/>(cc-ish) ; "foobar"<br/>(cc-ish "zam") ; "zambar"</div><div class="highlight" form="false" id="a_sAWHT"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">my-cc</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">this-cc</span>
                 <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" class="docs" hyphens="none">set!</a></span> <span class="n">my-cc</span> <span class="n">this-cc</span><span class="p">)</span>
                 <span class="s2">"foo"</span><span class="p">)</span> <span class="s2">"bar"</span><span class="p">)</span> <span class="c1">; "foobar"</span>
<span class="p">(</span><span class="n">my-cc</span> <span class="s2">"zam"</span><span class="p">)</span> <span class="c1">; "zambar"</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">cc-ish</span> <span class="p">[</span><span class="n">x</span> <span class="s2">"foo"</span><span class="p">])</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-append))" class="docs" hyphens="none">string-append</a></span> <span class="n">x</span> <span class="s2">"bar"</span><span class="p">))</span>
<span class="p">(</span><span class="n">cc-ish</span><span class="p">)</span> <span class="c1">; "foobar"</span>
<span class="p">(</span><span class="n">cc-ish</span> <span class="s2">"zam"</span><span class="p">)</span> <span class="c1">; "zambar"</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkv" data-clipboard-target="#code_70" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;continuation-caveats&quot;)"></div><h3 anchor="continuation-caveats" class="subhead" id="continuation-caveats"><a href="#continuation-caveats">Con­tin­u­a­tion caveats</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_zZY2j&quot;)"></div><p id="a_zZY2j">Hav­ing drawn a par­al­lel between con­tin­u­a­tions and BASIC line num­bers, we should be care­ful not to press the anal­ogy too far. Con­tin­u­a­tions have a cou­ple impor­tant dif­fer­ences from line num­bers:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_PFS6q&quot;)"></div><p id="a_PFS6q">Line num­bers are hard-coded into a BASIC pro­gram, so it’s a ref­er­ence sys­tem that exists at com­pile time. By con­trast, con­tin­u­a­tions can only be cap­tured at run time. In prac­tice, this means that we can’t use a con­tin­u­a­tion until we’ve actu­ally eval­u­ated the cor­re­spond­ing <span class="my-code" decode="exclude">let/cc</span> dur­ing the pro­gram run.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ssyzv&quot;)"></div><p id="a_Ssyzv">In turn, this implies that we can only use con­tin­u­a­tions to jump back­ward to points in the pro­gram already vis­ited. Whereas in BASIC, we can use line num­bers to jump to pre­vi­ously vis­ited lines, or lines not yet vis­ited. So con­tin­u­a­tions are inher­ently more lim­ited than <span class="my-code" decode="exclude">goto</span> with line num­bers.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_iRxVq&quot;)"></div><p id="a_iRxVq">Still, though they’re not a tool of first resort, con­tin­u­a­tions are use­ful in sit­u­a­tions that require unusual kinds of con­trol flow. For exam­ple, we used <a class="glossary" href="../appendix/glossary.html#exception"><span class="glossary-link-text">excep­tions</span></a> to imple­ment our pro­gram-end sig­nal for the <span class="my-code" decode="exclude">end</span> state­ment, and the change-line sig­nal for <span class="my-code" decode="exclude">goto</span>. Under the hood, excep­tions are imple­mented with con­tin­u­a­tions. This works because an excep­tion is a way of jump­ing back (or maybe “upward”) through the call­ing chain.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_DioRw&quot;)"></div><p id="a_DioRw">Like­wise, our <span class="my-code" decode="exclude">return</span> and <span class="my-code" decode="exclude">next</span> state­ments need to jump back to a pre­vi­ously vis­ited point in a BASIC pro­gram. This time, we can’t use excep­tions. Unlike <span class="my-code" decode="exclude">end</span> and <span class="my-code" decode="exclude">goto</span>, the places we want to revisit are not in the call­ing chain. But we can imple­ment these state­ments directly with con­tin­u­a­tions.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;lexer-updates&quot;)"></div><h3 anchor="lexer-updates" class="subhead" id="lexer-updates"><a href="#lexer-updates">Lexer updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uwMIo&quot;)"></div><p id="a_uwMIo">To our list of <span class="my-code" decode="exclude">reserved-terms</span>, we add six new ones: <span class="my-code" decode="exclude">gosub</span>, <span class="my-code" decode="exclude">return</span>, <span class="my-code" decode="exclude">for</span>, <span class="my-code" decode="exclude">next</span>, <span class="my-code" decode="exclude">to</span>, <span class="my-code" decode="exclude">step</span>, and <span class="my-code" decode="exclude">next</span>. These rules fol­low the state­ment syn­tax described above:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/lexer.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_y8T7N&quot;)"></div><div class="highlight-container" id="a_y8T7N"><div id="code_71" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require brag/support)<br/><br/>(define-lex-abbrev digits (:+ (char-set "0123456789")))<br/><br/>(define-lex-abbrev reserved-terms (:or "print" "goto" "end" "+" ":" ";" "let" "=" "input" "-" "*" "/" "^" "mod" "(" ")" "def" "if" "then" "else" "&lt;" "&gt;" "&lt;&gt;" "and" "or" "not" "gosub" "return" "for" "to" "step" "next"))<br/><br/>(define basic-lexer<br/>  (lexer-srcloc<br/>   [(eof) (return-without-srcloc eof)]<br/>   ["\n" (token 'NEWLINE lexeme)]<br/>   [whitespace (token lexeme #:skip? #t)]<br/>   [(from/stop-before "rem" "\n") (token 'REM lexeme)]<br/>   [reserved-terms (token lexeme lexeme)]<br/>   [(:seq alphabetic (:* (:or alphabetic numeric "$")))<br/>    (token 'ID (string-&gt;symbol lexeme))]<br/>   [digits (token 'INTEGER (string-&gt;number lexeme))]<br/>   [(:or (:seq (:? digits) "." digits)<br/>         (:seq digits "."))<br/>    (token 'DECIMAL (string-&gt;number lexeme))]<br/>   [(:or (from/to "\"" "\"") (from/to "'" "'"))<br/>    (token 'STRING<br/>           (substring lexeme<br/>                      1 (sub1 (string-length lexeme))))]))<br/><br/>(provide basic-lexer)</div><div class="highlight" form="false" id="a_gxjQe"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="n">brag/support</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._define-lex-abbrev))" class="docs" hyphens="none">define-lex-abbrev</a></span> <span class="n">digits</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a+))" class="docs" hyphens="none">:+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._char-set))" class="docs" hyphens="none">char-set</a></span> <span class="s2">"0123456789"</span><span class="p">)))</span>

<span class="hll"><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._define-lex-abbrev))" class="docs" hyphens="none">define-lex-abbrev</a></span> <span class="n">reserved-terms</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="s2">"print"</span> <span class="s2">"goto"</span> <span class="s2">"end"</span> <span class="s2">"+"</span> <span class="s2">":"</span> <span class="s2">";"</span> <span class="s2">"let"</span> <span class="s2">"="</span> <span class="s2">"input"</span> <span class="s2">"-"</span> <span class="s2">"*"</span> <span class="s2">"/"</span> <span class="s2">"^"</span> <span class="s2">"mod"</span> <span class="s2">"("</span> <span class="s2">")"</span> <span class="s2">"def"</span> <span class="s2">"if"</span> <span class="s2">"then"</span> <span class="s2">"else"</span> <span class="s2">"&lt;"</span> <span class="s2">"&gt;"</span> <span class="s2">"&lt;&gt;"</span> <span class="s2">"and"</span> <span class="s2">"or"</span> <span class="s2">"not"</span> <span class="s2">"gosub"</span> <span class="s2">"return"</span> <span class="s2">"for"</span> <span class="s2">"to"</span> <span class="s2">"step"</span> <span class="s2">"next"</span><span class="p">))</span>
</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">basic-lexer</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexer-srcloc))" class="docs" hyphens="none">lexer-srcloc</a></span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._return-without-srcloc))" class="docs" hyphens="none">return-without-srcloc</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/port-ops.html#(def._((quote._~23~25kernel)._eof))" class="docs" hyphens="none">eof</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">NEWLINE</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._whitespace))" class="docs" hyphens="none">whitespace</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="kd">#:skip?</span> <span class="no">#t</span><span class="p">)]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/stop-before))" class="docs" hyphens="none">from/stop-before</a></span> <span class="s2">"rem"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">REM</span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="n">reserved-terms</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">)]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a*))" class="docs" hyphens="none">:*</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._alphabetic))" class="docs" hyphens="none">alphabetic</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._numeric))" class="docs" hyphens="none">numeric</a></span> <span class="s2">"$"</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">ID</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._string-~3esymbol))" class="docs" hyphens="none">string-&gt;symbol</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))]</span>
   <span class="p">[</span><span class="n">digits</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">INTEGER</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3a~3f))" class="docs" hyphens="none">:?</a></span> <span class="n">digits</span><span class="p">)</span> <span class="s2">"."</span> <span class="n">digits</span><span class="p">)</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aseq))" class="docs" hyphens="none">:seq</a></span> <span class="n">digits</span> <span class="s2">"."</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">DECIMAL</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._string-~3enumber))" class="docs" hyphens="none">string-&gt;number</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))]</span>
   <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._~3aor))" class="docs" hyphens="none">:or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(form._((lib._brag/support..rkt)._from/to))" class="docs" hyphens="none">from/to</a></span> <span class="s2">"&#39;"</span> <span class="s2">"&#39;"</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/brag/index.html#(def._((lib._brag/support..rkt)._token))" class="docs" hyphens="none">token</a></span> <span class="o">&#39;</span><span class="ss">STRING</span>
           <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._substring))" class="docs" hyphens="none">substring</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span>
                      <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" class="docs" hyphens="none">sub1</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/strings.html#(def._((quote._~23~25kernel)._string-length))" class="docs" hyphens="none">string-length</a></span> <span class="nb"><a href="http://docs.racket-lang.org/br-parser-tools/Lexers.html#(form._((lib._br-parser-tools/lex..rkt)._lexeme))" class="docs" hyphens="none">lexeme</a></span><span class="p">))))]))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">basic-lexer</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkw" data-clipboard-target="#code_71" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9EYhN&quot;)"></div><p id="a_9EYhN">Oth­er­wise, our lexer remains the same.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;parser-updates&quot;)"></div><h3 anchor="parser-updates" class="subhead" id="parser-updates"><a href="#parser-updates">Parser updates</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fHyCq&quot;)"></div><p id="a_fHyCq">We add four new rules to cover our new state­ments: <span class="my-code" decode="exclude">b-gosub</span>, <span class="my-code" decode="exclude">b-return</span>, <span class="my-code" decode="exclude">b-for</span>, and <span class="my-code" decode="exclude">b-next</span>. We also add them to the right side of the <span class="my-code" decode="exclude">b-statement</span> rule:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/parser.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_YDdWQ&quot;)"></div><div class="highlight-container" id="a_YDdWQ"><div id="code_72" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang brag<br/>b-program : [b-line] (/NEWLINE [b-line])*<br/>b-line : b-line-num [b-statement] (/":" [b-statement])* [b-rem]<br/>@b-line-num : INTEGER<br/>b-rem : REM<br/>@b-statement : b-end | b-print | b-goto<br/>             | b-let | b-input | b-if<br/>             | b-gosub | b-return | b-for | b-next<br/>b-end : /"end"<br/>b-print : /"print" [b-printable] (/";" [b-printable])*<br/>@b-printable : STRING | b-expr<br/>b-goto : /"goto" b-expr<br/>b-let : [/"let"] b-id /"=" (STRING | b-expr)<br/>b-if : /"if" b-expr /"then" (b-statement | b-expr)<br/>                   [/"else" (b-statement | b-expr)]<br/>b-input : /"input" b-id<br/>@b-id : ID<br/>b-gosub : /"gosub" b-expr<br/>b-return : /"return"<br/>b-for : /"for" b-id /"=" b-expr /"to" b-expr [/"step" b-expr]<br/>b-next : /"next" b-id<br/>b-expr : b-or-expr<br/>b-or-expr : [b-or-expr "or"] b-and-expr<br/>b-and-expr : [b-and-expr "and"] b-not-expr<br/>b-not-expr : ["not"] b-comp-expr<br/>b-comp-expr : [b-comp-expr ("="|"&lt;"|"&gt;"|"&lt;&gt;")] b-sum<br/>b-sum : [b-sum ("+"|"-")] b-product<br/>b-product : [b-product ("*"|"/"|"mod")] b-neg<br/>b-neg : ["-"] b-expt<br/>b-expt : [b-expt ("^")] b-value<br/>@b-value : b-number | b-id | /"(" b-expr /")"<br/>@b-number : INTEGER | DECIMAL</div><div class="highlight" form="false" id="a_aISXS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="source"><pre>#lang brag
b-program : [b-line] (/NEWLINE [b-line])*
b-line : b-line-num [b-statement] (/":" [b-statement])* [b-rem]
@b-line-num : INTEGER
b-rem : REM
@b-statement : b-end | b-print | b-goto
             | b-let | b-input | b-if
<span class="hll">             | b-gosub | b-return | b-for | b-next
</span>b-end : /"end"
b-print : /"print" [b-printable] (/";" [b-printable])*
@b-printable : STRING | b-expr
b-goto : /"goto" b-expr
b-let : [/"let"] b-id /"=" (STRING | b-expr)
b-if : /"if" b-expr /"then" (b-statement | b-expr)
                   [/"else" (b-statement | b-expr)]
b-input : /"input" b-id
@b-id : ID
<span class="hll">b-gosub : /"gosub" b-expr
</span><span class="hll">b-return : /"return"
</span><span class="hll">b-for : /"for" b-id /"=" b-expr /"to" b-expr [/"step" b-expr]
</span><span class="hll">b-next : /"next" b-id
</span>b-expr : b-or-expr
b-or-expr : [b-or-expr "or"] b-and-expr
b-and-expr : [b-and-expr "and"] b-not-expr
b-not-expr : ["not"] b-comp-expr
b-comp-expr : [b-comp-expr ("="|"&lt;"|"&gt;"|"&lt;&gt;")] b-sum
b-sum : [b-sum ("+"|"-")] b-product
b-product : [b-product ("*"|"/"|"mod")] b-neg
b-neg : ["-"] b-expt
b-expt : [b-expt ("^")] b-value
@b-value : b-number | b-id | /"(" b-expr /")"
@b-number : INTEGER | DECIMAL
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkx" data-clipboard-target="#code_72" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;expander-updates-gosub-and-return&quot;)"></div><h3 anchor="expander-updates-gosub-and-return" class="subhead" id="expander-updates-gosub-and-return"><a href="#expander-updates-gosub-and-return">Expander updates: gosub and return</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9fq5g&quot;)"></div><p id="a_9fq5g">We’ll build our expander func­tions for <span class="my-code" decode="exclude">b-gosub</span> and <span class="my-code" decode="exclude">b-return</span> into our exist­ing <span class="my-code" decode="exclude">"go.rkt"</span> mod­ule. Every time we reach a <span class="my-code" decode="exclude">b-gosub</span>, we save a con­tin­u­a­tion onto a stack. When we reach a <span class="my-code" decode="exclude">b-return</span>, we get the most recent con­tin­u­a­tion off the stack and invoke it. So the imple­men­ta­tion looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/go.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_M3VFr&quot;)"></div><div class="highlight-container" id="a_M3VFr"><div id="code_73" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "struct.rkt" "line.rkt")<br/>(provide b-end b-goto b-gosub b-return)<br/><br/>(define (b-end) (raise (end-program-signal)))<br/><br/>(define (b-goto num-expr)<br/>  (raise (change-line-signal num-expr)))<br/><br/>(define return-ccs empty)<br/><br/>(define (b-gosub num-expr)<br/>  (let/cc here-cc<br/>    (push! return-ccs here-cc)<br/>    (b-goto num-expr)))<br/><br/>(define (b-return)<br/>  (unless (not (empty? return-ccs))<br/>    (raise-line-error "return without gosub"))<br/>  (define top-cc (pop! return-ccs))<br/>  (top-cc (void)))</div><div class="highlight" form="false" id="a_o7eD5"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"line.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">b-end</span> <span class="n">b-goto</span> <span class="n">b-gosub</span> <span class="n">b-return</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-end</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._raise))" class="docs" hyphens="none">raise</a></span> <span class="p">(</span><span class="n">end-program-signal</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-goto</span> <span class="n">num-expr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._raise))" class="docs" hyphens="none">raise</a></span> <span class="p">(</span><span class="n">change-line-signal</span> <span class="n">num-expr</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">return-ccs</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-gosub</span> <span class="n">num-expr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">here-cc</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/list..rkt)._push!))" class="docs" hyphens="none">push!</a></span> <span class="n">return-ccs</span> <span class="n">here-cc</span><span class="p">)</span>
    <span class="p">(</span><span class="n">b-goto</span> <span class="n">num-expr</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-return</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" class="docs" hyphens="none">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" class="docs" hyphens="none">not</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty~3f))" class="docs" hyphens="none">empty?</a></span> <span class="n">return-ccs</span><span class="p">))</span>
    <span class="p">(</span><span class="n">raise-line-error</span> <span class="s2">"return without gosub"</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">top-cc</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/list..rkt)._pop!))" class="docs" hyphens="none">pop!</a></span> <span class="n">return-ccs</span><span class="p">))</span>
  <span class="p">(</span><span class="n">top-cc</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpky" data-clipboard-target="#code_73" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_QRBA1&quot;)"></div><p id="a_QRBA1">We make new stack called <span class="my-code" decode="exclude">return-ccs</span>. Within <span class="my-code" decode="exclude">b-gosub</span>, we use <span class="my-code" decode="exclude">let/cc</span> to cap­ture the con­tin­u­a­tion as <span class="my-code" decode="exclude">here-cc</span> and <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/list..rkt)._push!))" class="docs" hyphens="none">push!</a> it onto the stack. We then pass our <span class="my-code" decode="exclude">b-gosub</span> argu­ment to <span class="my-code" decode="exclude">b-goto</span>, which will send us where we need to go.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_uoC4M&quot;)"></div><p id="a_uoC4M">Then, in <span class="my-code" decode="exclude">b-return</span>, we unwind the process. If the <span class="my-code" decode="exclude">return-ccs</span> stack is empty, it means our pro­gram reached a <span class="my-code" decode="exclude">b-return</span> that didn’t have a cor­re­spond­ing <span class="my-code" decode="exclude">b-gosub</span>, so we use <span class="my-code" decode="exclude">raise-line-error</span> (which, pre­sciently, we made in <a href="better-line-errors.html">bet­ter line errors</a>) to sig­nal the prob­lem.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_fqPHE&quot;)"></div><p id="a_fqPHE">Oth­er­wise, we <a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/list..rkt)._pop!))" class="docs" hyphens="none">pop!</a> the top­most con­tin­u­a­tion from the stack, and invoke it with a <span class="my-code" decode="exclude">(void)</span> argu­ment. The effect is to jump back to the <span class="my-code" decode="exclude">b-gosub</span> where the con­tin­u­a­tion was cap­tured, and replace the <span class="my-code" decode="exclude">let/cc</span> expres­sion with <span class="my-code" decode="exclude">(void)</span>. This is equiv­a­lent to a state­ment that does noth­ing. The pro­gram will con­tinue nor­mally from that point.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-subroutines&quot;)"></div><h3 anchor="testing-subroutines" class="subhead" id="testing-subroutines"><a href="#testing-subroutines">Test­ing sub­rou­tines</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_y9XMM&quot;)"></div><p id="a_y9XMM">We can quickly test that our <span class="my-code" decode="exclude">gosub</span> and <span class="my-code" decode="exclude">return</span> are work­ing with our ear­lier test pro­gram:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jJCyJ&quot;)"></div><div class="highlight-container" id="a_jJCyJ"><div id="code_74" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 gosub 50<br/>20 gosub 70<br/>30 print "third"<br/>40 end<br/>50 print "first"<br/>60 return<br/>70 print "second"<br/>80 return</div><div class="highlight" form="false" id="a_UgFCn"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">50</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">70</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"third"</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"first"</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">return</span>
<span class="nl">70</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"second"</span>
<span class="nl">80</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_Vldpkz" data-clipboard-target="#code_74" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_d15mgC&quot;)"></div><div class="highlight-container" id="a_d15mgC"><div id="code_75" form="false" decode="exclude" style="font-size:0;width:0;height:0">first<br/>second<br/>third</div><div class="highlight" form="false" id="a_m6l0QA"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre>first
second
third
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkB" data-clipboard-target="#code_75" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_f6tOv&quot;)"></div><p id="a_f6tOv">We can also check that our <span class="my-code" decode="exclude">return</span> error works cor­rectly:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_C4aaT&quot;)"></div><div class="highlight-container" id="a_C4aaT"><div id="code_76" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic-demo-2<br/>10 gosub 50<br/>20 return<br/>50 print "hello"<br/>60 return</div><div class="highlight" form="false" id="a_mIzLe"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>#lang basic-demo-2
<span class="nl">10</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">50</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">return</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"hello"</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkD" data-clipboard-target="#code_76" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_9Dkv2&quot;)"></div><div class="highlight-container" id="a_9Dkv2"><div id="code_77" form="false" decode="exclude" style="font-size:0;width:0;height:0">hello<br/>error in line 20: return without gosub</div><div class="highlight" form="false" id="a_QLxkD"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="source"><pre>hello
error in line 20: return without gosub
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkE" data-clipboard-target="#code_77" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_jdQ4R&quot;)"></div><p id="a_jdQ4R">When we pick the right tool for the job, the rest is easy.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;expander-updates-for-and-next&quot;)"></div><h3 anchor="expander-updates-for-and-next" class="subhead" id="expander-updates-for-and-next"><a href="#expander-updates-for-and-next">Expander updates: for and next</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_yxTj2&quot;)"></div><p id="a_yxTj2">Ear­lier, we noticed that <span class="my-code" decode="exclude">for</span> and <span class="my-code" decode="exclude">next</span> have to coop­er­ate at a dis­tance:</p></div><ul><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_wSePO&quot;)"></div><p id="a_wSePO"><span class="my-code" decode="exclude">for</span> marks the top of the loop, sets the ini­tial value of the loop vari­able, its max­i­mum value, and option­ally a <span class="my-code" decode="exclude">step</span> value (which defaults to <span class="my-code" decode="exclude">1</span>).</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0OOIR&quot;)"></div><p id="a_0OOIR"><span class="my-code" decode="exclude">next</span> incre­ments the vari­able by the step value and checks if the new value is less than or equal to the max­i­mum value estab­lished by <span class="my-code" decode="exclude">for</span>. If it is, we return to the top of the loop with the new value. Oth­er­wise, the loop ends and the pro­gram con­tin­ues after the <span class="my-code" decode="exclude">next</span>.</p></div></li></ul><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_pEYjj&quot;)"></div><p id="a_pEYjj">Let’s start by fram­ing out an ini­tial ver­sion of the <span class="my-code" decode="exclude">b-for</span> macro. We use two cases. In the first case, if we don’t get a <span class="my-code" decode="exclude">step</span> value, we stick the default value of <span class="my-code" decode="exclude">1</span> on the end and call <span class="my-code" decode="exclude">b-for</span> again:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6hlSj&quot;)"></div><div class="highlight-container" id="a_6hlSj"><div id="code_78" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases b-for<br/>  [(_ LOOP-ID START END) #'(b-for LOOP-ID START END 1)]<br/>  [(_ LOOP-ID START END STEP)  #'(b-let LOOP-ID START)])</div><div class="highlight" form="false" id="a_007iI"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">b-for</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-for</span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="n">STEP</span><span class="p">)</span>  <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">LOOP-ID</span> <span class="n">START</span><span class="p">)])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkF" data-clipboard-target="#code_78" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Ng47U&quot;)"></div><p id="a_Ng47U">That brings every­thing to the sec­ond case. We know at least that we have to assign a start­ing value to the <span class="my-code" decode="exclude">LOOP-ID</span>. So let’s call <span class="my-code" decode="exclude">b-let</span> with <span class="my-code" decode="exclude">LOOP-ID</span> and the <span class="my-code" decode="exclude">START</span> value.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_rKsa1&quot;)"></div><p id="a_rKsa1">Now what? We know from imple­ment­ing <span class="my-code" decode="exclude">gosub</span> and <span class="my-code" decode="exclude">return</span> that we can use a con­tin­u­a­tion to jump back­ward. Unsur­pris­ingly, that’s how we travel from <span class="my-code" decode="exclude">next</span> back to <span class="my-code" decode="exclude">for</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_0d1Dx&quot;)"></div><p id="a_0d1Dx">We also learned that we can use a con­tin­u­a­tion to fill in a new value at the posi­tion where the con­tin­u­a­tion is cap­tured. Among other things, <span class="my-code" decode="exclude">next</span> restarts the loop with a new value assigned to our loop vari­able. So it might not be a bad idea to cap­ture a con­tin­u­a­tion around the assign­ment value:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6vRiR&quot;)"></div><div class="highlight-container" id="a_6vRiR"><div id="code_79" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define-macro-cases b-for<br/>  [(_ LOOP-ID START END) #'(b-for LOOP-ID START END 1)]<br/>  [(_ LOOP-ID START END STEP) #'(b-let LOOP-ID (let/cc loop-cc<br/>                                                 START))])</div><div class="highlight" form="false" id="a_juhkX"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">b-for</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-for</span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="n">STEP</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">LOOP-ID</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">loop-cc</span>
                                                 <span class="n">START</span><span class="p">))])</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkG" data-clipboard-target="#code_79" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_gGZbe&quot;)"></div><p id="a_gGZbe">We’re not sav­ing <span class="my-code" decode="exclude">loop-cc</span> any­where yet. But what’s going to hap­pen if we call <span class="my-code" decode="exclude">(loop-cc 42)</span>? We’d be jump­ing into the mid­dle of a <span class="my-code" decode="exclude">b-let</span> expres­sion with a new value, which will cause the <span class="my-code" decode="exclude">b-let</span> to be eval­u­ated again, thereby assign­ing <span class="my-code" decode="exclude">42</span> to the <span class="my-code" decode="exclude">LOOP-ID</span>. Invok­ing the con­tin­u­a­tion will also move us back to the top of loop. So call­ing <span class="my-code" decode="exclude">loop-cc</span> with a new value is equiv­a­lent to restart­ing the loop with that value.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_e8pjV&quot;)"></div><p id="a_e8pjV">Now that we have a means of trav­el­ing back to the top of the loop with a new value, the path for­ward reveals itself:</p></div><ol><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_bV1dD&quot;)"></div><p id="a_bV1dD">With <span class="my-code" decode="exclude">gosub</span> and <span class="my-code" decode="exclude">return</span>, we kept a stack of con­tin­u­a­tions in the order we found them. This time, we make a <a class="glossary" href="../appendix/glossary.html#hash-table"><span class="glossary-link-text">hash table</span></a> that stores the con­tin­u­a­tion asso­ci­ated with each <span class="my-code" decode="exclude">for</span> loop. We use the <span class="my-code" decode="exclude">LOOP-ID</span> as the key. For the value, we store a <a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._lambda))" class="docs" hyphens="none">lambda</a> func­tion that han­dles the loop house­keep­ing, includ­ing the con­tin­u­a­tion.</p></div></li><li><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_6IBIt&quot;)"></div><p id="a_6IBIt">When we reach a <span class="my-code" decode="exclude">next</span>, we’ll use its argu­ment to get the cor­re­spond­ing func­tion out of the hash table, and run it.</p></div></li></ol><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_MU0bu&quot;)"></div><p id="a_MU0bu">The gim­mick here is that although <span class="my-code" decode="exclude">for</span> and <span class="my-code" decode="exclude">next</span> appear to be coop­er­at­ing, under the hood, <span class="my-code" decode="exclude">b-for</span> will be doing all the heavy lift­ing, by set­ting up a func­tion that can be called by <span class="my-code" decode="exclude">b-next</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_Uj5Gz&quot;)"></div><p id="a_Uj5Gz">Let’s frame out that much:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mCgmX&quot;)"></div><div class="highlight-container" id="a_mCgmX"><div id="code_80" form="false" decode="exclude" style="font-size:0;width:0;height:0">(define next-funcs (make-hasheq))<br/><br/>(define-macro-cases b-for<br/>  [(_ LOOP-ID START END) #'(b-for LOOP-ID START END 1)]<br/>  [(_ LOOP-ID START END STEP)<br/>   #'(b-let LOOP-ID<br/>            (let/cc loop-cc<br/>              (hash-set! next-funcs<br/>                         'LOOP-ID<br/>                         (λ () ···))<br/>              START))])<br/><br/>(define-macro (b-next LOOP-ID)<br/>  #'(begin<br/>      (unless (hash-has-key? next-funcs 'LOOP-ID)<br/>        (raise-line-error<br/>         (format "`next ~a` without for" 'LOOP-ID)))<br/>      (define func (hash-ref next-funcs 'LOOP-ID))<br/>      (func)))</div><div class="highlight" form="false" id="a_ftknZ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="source"><pre><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">next-funcs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._make-hasheq))" class="docs" hyphens="none">make-hasheq</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">b-for</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-for</span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="n">STEP</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">LOOP-ID</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">loop-cc</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="docs" hyphens="none">hash-set!</a></span> <span class="n">next-funcs</span>
                         <span class="o">&#39;</span><span class="ss">LOOP-ID</span>
                         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" class="docs" hyphens="none">λ</a></span> <span class="p">()</span> <span class="n">···</span><span class="p">))</span>
              <span class="n">START</span><span class="p">))])</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-next</span> <span class="n">LOOP-ID</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" class="docs" hyphens="none">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((lib._racket/private/more-scheme..rkt)._hash-has-key~3f))" class="docs" hyphens="none">hash-has-key?</a></span> <span class="n">next-funcs</span> <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">)</span>
        <span class="p">(</span><span class="n">raise-line-error</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._format))" class="docs" hyphens="none">format</a></span> <span class="s2">"`next ~a` without for"</span> <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" class="docs" hyphens="none">hash-ref</a></span> <span class="n">next-funcs</span> <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">))</span>
      <span class="p">(</span><span class="n">func</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkH" data-clipboard-target="#code_80" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_nP8DD&quot;)"></div><p id="a_nP8DD">Our <span class="my-code" decode="exclude">next-funcs</span> hash table needs to be <a class="glossary" href="../appendix/glossary.html#mutable"><span class="glossary-link-text">muta­ble</span></a> but it will use <a class="glossary" href="../appendix/glossary.html#symbol"><span class="glossary-link-text">sym­bols</span></a> as keys, so our fastest option is <a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._make-hasheq))" class="docs" hyphens="none">make-hasheq</a>. Within the <span class="my-code" decode="exclude">let/cc</span>, we use <a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="docs" hyphens="none">hash-set!</a> to store an (as yet empty) lambda with the key <span class="my-code" decode="exclude">'LOOP-ID</span>.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_TJTKq&quot;)"></div><p id="a_TJTKq">On the other side, in <span class="my-code" decode="exclude">b-next</span>, we use <span class="my-code" decode="exclude">raise-line-error</span> to sig­nal an error if our <span class="my-code" decode="exclude">next-funcs</span> hash table has no cor­re­spond­ing key. Oth­er­wise, we fetch the func­tion and exe­cute it.</p></div><div anchorize="false" style="height:1em"></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_KKzRB&quot;)"></div><p id="a_KKzRB">Now we just need to fill in the lambda. The fin­ished <span class="my-code" decode="exclude">"go.rkt"</span> looks like this:</p></div><div class="filebox" anchorize="false"><div class="filename" anchorize="false" decode="exclude">basic/go.rkt</div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_7Jtyh&quot;)"></div><div class="highlight-container" id="a_7Jtyh"><div id="code_81" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang br<br/>(require "struct.rkt" "line.rkt" "misc.rkt")<br/>(provide b-end b-goto b-gosub b-return b-for b-next)<br/><br/>(define (b-end) (raise (end-program-signal)))<br/><br/>(define (b-goto num-expr)<br/>  (raise (change-line-signal num-expr)))<br/><br/>(define return-ccs empty)<br/><br/>(define (b-gosub num-expr)<br/>  (let/cc this-cc<br/>    (push! return-ccs this-cc)<br/>    (b-goto num-expr)))<br/><br/>(define (b-return)<br/>  (unless (not (empty? return-ccs))<br/>    (raise-line-error "return without gosub"))<br/>  (define top-cc (pop! return-ccs))<br/>  (top-cc (void)))<br/><br/>(define next-funcs (make-hasheq))<br/><br/>(define-macro-cases b-for<br/>  [(_ LOOP-ID START END) #'(b-for LOOP-ID START END 1)]<br/>  [(_ LOOP-ID START END STEP)<br/>   #'(b-let LOOP-ID<br/>            (let/cc loop-cc<br/>              (hash-set! next-funcs<br/>                         'LOOP-ID<br/>                         (λ ()<br/>                           (define next-val<br/>                             (+ LOOP-ID STEP))<br/>                           (if (next-val<br/>                                . in-closed-interval? .<br/>                                START END)<br/>                               (loop-cc next-val)<br/>                               (hash-remove! next-funcs<br/>                                             'LOOP-ID))))<br/>              START))])<br/><br/>(define (in-closed-interval? x start end)<br/>  ((if (&lt; start end) &lt;= &gt;=) start x end))<br/><br/>(define-macro (b-next LOOP-ID)<br/>  #'(begin<br/>      (unless (hash-has-key? next-funcs 'LOOP-ID)<br/>        (raise-line-error<br/>         (format "`next ~a` without for" 'LOOP-ID)))<br/>      (define func (hash-ref next-funcs 'LOOP-ID))<br/>      (func)))</div><div class="highlight" form="false" id="a_QES6n"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></div></td><td class="code"><div class="source"><pre><span class="kn">#lang </span><span class="nn">br</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" class="docs" hyphens="none">require</a></span> <span class="s2">"struct.rkt"</span> <span class="s2">"line.rkt"</span> <span class="s2">"misc.rkt"</span><span class="p">)</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" class="docs" hyphens="none">provide</a></span> <span class="n">b-end</span> <span class="n">b-goto</span> <span class="n">b-gosub</span> <span class="n">b-return</span> <span class="n">b-for</span> <span class="n">b-next</span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-end</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._raise))" class="docs" hyphens="none">raise</a></span> <span class="p">(</span><span class="n">end-program-signal</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-goto</span> <span class="n">num-expr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((quote._~23~25kernel)._raise))" class="docs" hyphens="none">raise</a></span> <span class="p">(</span><span class="n">change-line-signal</span> <span class="n">num-expr</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">return-ccs</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty))" class="docs" hyphens="none">empty</a></span><span class="p">)</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-gosub</span> <span class="n">num-expr</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">this-cc</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/list..rkt)._push!))" class="docs" hyphens="none">push!</a></span> <span class="n">return-ccs</span> <span class="n">this-cc</span><span class="p">)</span>
    <span class="p">(</span><span class="n">b-goto</span> <span class="n">num-expr</span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">b-return</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" class="docs" hyphens="none">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" class="docs" hyphens="none">not</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty~3f))" class="docs" hyphens="none">empty?</a></span> <span class="n">return-ccs</span><span class="p">))</span>
    <span class="p">(</span><span class="n">raise-line-error</span> <span class="s2">"return without gosub"</span><span class="p">))</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">top-cc</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/list..rkt)._pop!))" class="docs" hyphens="none">pop!</a></span> <span class="n">return-ccs</span><span class="p">))</span>
  <span class="p">(</span><span class="n">top-cc</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/void.html#(def._((quote._~23~25kernel)._void))" class="docs" hyphens="none">void</a></span><span class="p">)))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">next-funcs</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._make-hasheq))" class="docs" hyphens="none">make-hasheq</a></span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro-cases))" class="docs" hyphens="none">define-macro-cases</a></span> <span class="n">b-for</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span><span class="p">)</span> <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-for</span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="mi">1</span><span class="p">)]</span>
  <span class="p">[(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" class="docs" hyphens="none">_</a></span> <span class="n">LOOP-ID</span> <span class="n">START</span> <span class="n">END</span> <span class="n">STEP</span><span class="p">)</span>
   <span class="o">#&#39;</span><span class="p">(</span><span class="n">b-let</span> <span class="n">LOOP-ID</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/cont.html#(form._((lib._racket/private/more-scheme..rkt)._let/cc))" class="docs" hyphens="none">let/cc</a></span> <span class="n">loop-cc</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-set!))" class="docs" hyphens="none">hash-set!</a></span> <span class="n">next-funcs</span>
                         <span class="o">&#39;</span><span class="ss">LOOP-ID</span>
                         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" class="docs" hyphens="none">λ</a></span> <span class="p">()</span>
                           <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">next-val</span>
                             <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" class="docs" hyphens="none">+</a></span> <span class="n">LOOP-ID</span> <span class="n">STEP</span><span class="p">))</span>
                           <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="n">next-val</span>
                                <span class="o">.</span> <span class="n">in-closed-interval?</span> <span class="o">.</span>
                                <span class="n">START</span> <span class="n">END</span><span class="p">)</span>
                               <span class="p">(</span><span class="n">loop-cc</span> <span class="n">next-val</span><span class="p">)</span>
                               <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-remove!))" class="docs" hyphens="none">hash-remove!</a></span> <span class="n">next-funcs</span>
                                             <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">))))</span>
              <span class="n">START</span><span class="p">))])</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="p">(</span><span class="n">in-closed-interval?</span> <span class="n">x</span> <span class="n">start</span> <span class="n">end</span><span class="p">)</span>
  <span class="p">((</span><span class="nb"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" class="docs" hyphens="none">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" class="docs" hyphens="none">&lt;</a></span> <span class="n">start</span> <span class="n">end</span><span class="p">)</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c~3d))" class="docs" hyphens="none">&lt;=</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e~3d))" class="docs" hyphens="none">&gt;=</a></span><span class="p">)</span> <span class="n">start</span> <span class="n">x</span> <span class="n">end</span><span class="p">))</span>

<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/br/index.html#(form._((lib._br/define..rkt)._define-macro))" class="docs" hyphens="none">define-macro</a></span> <span class="p">(</span><span class="n">b-next</span> <span class="n">LOOP-ID</span><span class="p">)</span>
  <span class="o">#&#39;</span><span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" class="docs" hyphens="none">begin</a></span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" class="docs" hyphens="none">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((lib._racket/private/more-scheme..rkt)._hash-has-key~3f))" class="docs" hyphens="none">hash-has-key?</a></span> <span class="n">next-funcs</span> <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">)</span>
        <span class="p">(</span><span class="n">raise-line-error</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._format))" class="docs" hyphens="none">format</a></span> <span class="s2">"`next ~a` without for"</span> <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" class="docs" hyphens="none">define</a></span> <span class="n">func</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/hashtables.html#(def._((quote._~23~25kernel)._hash-ref))" class="docs" hyphens="none">hash-ref</a></span> <span class="n">next-funcs</span> <span class="o">&#39;</span><span class="ss">LOOP-ID</span><span class="p">))</span>
      <span class="p">(</span><span class="n">func</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkI" data-clipboard-target="#code_81" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lhIAE&quot;)"></div><p id="a_lhIAE">Inside the lambda, we’re imple­ment­ing the steps we already set out. We incre­ment the value of <span class="my-code" decode="exclude">LOOP-ID</span> by the <span class="my-code" decode="exclude">STEP</span> value, store it in <span class="my-code" decode="exclude">next-val</span>, and check if it’s between the <span class="my-code" decode="exclude">START</span> and <span class="my-code" decode="exclude">END</span> val­ues. If so, we con­tinue the loop with <span class="my-code" decode="exclude">next-val</span>—mean­ing, we call our con­tin­u­a­tion <span class="my-code" decode="exclude">loop-cc</span> with <span class="my-code" decode="exclude">next-val</span> as the argu­ment. If not, the loop is done, so we delete its entry from the <span class="my-code" decode="exclude">next-funcs</span> hash table.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_UtDPh&quot;)"></div><p id="a_UtDPh">By the way, <span class="my-code" decode="exclude">in-closed-interval</span> is a helper func­tion that checks whether a value is between two other val­ues. We need to take a lit­tle care because the end value is not nec­es­sar­ily greater than the start value (for instance, when the step value is neg­a­tive).</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;testing-loops&quot;)"></div><h3 anchor="testing-loops" class="subhead" id="testing-loops"><a href="#testing-loops">Test­ing loops</a></h3></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_tDZ6W&quot;)"></div><p id="a_tDZ6W">With those changes, our <span class="my-code" decode="exclude">#lang basic</span> should be able to han­dle loops that go up or down, with or with­out a <span class="my-code" decode="exclude">step</span> value. For good mea­sure, let’s throw in <span class="my-code" decode="exclude">gosub</span> and <span class="my-code" decode="exclude">return</span> too:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_XcJyB&quot;)"></div><div class="highlight-container" id="a_XcJyB"><div id="code_82" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 for h = 1 to 2<br/>20 for t = 2 to 4 step 2<br/>30 for d = 9 to 8 step -1<br/>40 gosub 60<br/>50 next d : next t : next h : print "done" : end<br/>60 print h ; t ; d<br/>70 return</div><div class="highlight" form="false" id="a_dojRB"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">1</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">2</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">2</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">4</span><span class="w"> </span><span class="vg">step</span><span class="w"> </span><span class="il">2</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">9</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">8</span><span class="w"> </span><span class="vg">step</span><span class="w"> </span><span class="il">-1</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">gosub</span><span class="w"> </span><span class="il">60</span>
<span class="nl">50</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">d</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">t</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">h</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="s2">"done"</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="vg">end</span>
<span class="nl">60</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">h</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">t</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="vg">d</span>
<span class="nl">70</span><span class="w"> </span><span class="vg">return</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkJ" data-clipboard-target="#code_82" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_lTFiR&quot;)"></div><div class="highlight-container" id="a_lTFiR"><div id="code_83" form="false" decode="exclude" style="font-size:0;width:0;height:0">129<br/>128<br/>149<br/>148<br/>229<br/>228<br/>249<br/>248<br/>done</div><div class="highlight" form="false" id="a_6eIOQ"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="source"><pre>129
128
149
148
229
228
249
248
done
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkK" data-clipboard-target="#code_83" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_mIL8S&quot;)"></div><p id="a_mIL8S">Exactly right.</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_hBbcD&quot;)"></div><p id="a_hBbcD">Let’s also try a pro­gram with a miss­ing <span class="my-code" decode="exclude">for</span> state­ment:</p></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_CIBkb&quot;)"></div><div class="highlight-container" id="a_CIBkb"><div id="code_84" form="false" decode="exclude" style="font-size:0;width:0;height:0">#lang basic<br/>10 for x = 1 to 3<br/>20 print x<br/>30 next x<br/>40 next x</div><div class="highlight" form="false" id="a_k4AHS"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="source"><pre>#lang basic
<span class="nl">10</span><span class="w"> </span><span class="vg">for</span><span class="w"> </span><span class="vg">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="il">1</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="il">3</span>
<span class="nl">20</span><span class="w"> </span><span class="vg">print</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">30</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
<span class="nl">40</span><span class="w"> </span><span class="vg">next</span><span class="w"> </span><span class="vg">x</span>
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkL" data-clipboard-target="#code_84" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div class="sidebar-container"><div class="sidebar has_form" onclick="toggle_form(&quot;a_a6Fi1&quot;)"></div><div class="highlight-container" id="a_a6Fi1"><div id="code_85" form="false" decode="exclude" style="font-size:0;width:0;height:0">1<br/>2<br/>3<br/>error in line 40: `next x` without for</div><div class="highlight" form="false" id="a_mKaoF"><table class="sourcetable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="source"><pre>1
2
3
error in line 40: `next x` without for
</pre></div>
</td></tr></tbody></table></div><div class="copy-button" form="false" onClick="notify('copied to clipboard', 1000)" id="a_VldpkM" data-clipboard-target="#code_85" data-clipboard-action="copy"><img src="../fonts/feather-v1.1/svg/download.svg" alt="copy to clipboard"/></div></div></div><div anchorize="false" style="height:2em"></div><ul class="siblinks"><li><a href="intro.html">1&emsp;intro</a></li><li><a href="specification-and-setup.html">2&emsp;spec­i­fi­ca­tion and setup</a></li><li><a href="the-syntax-colorer.html">3&emsp;the syn­tax col­orer</a></li><li><a href="better-line-errors.html">4&emsp;bet­ter line errors</a></li><li><a href="variables-and-input.html">5&emsp;vari­ables and input</a></li><li><a href="expressions.html">6&emsp;expres­sions</a></li><li><a href="conditionals.html">7&emsp;con­di­tion­als</a></li><li><a class="here" href="subroutines-and-loops.html">8&emsp;sub­rou­tines and loops</a></li><li><a href="recap.html">9&emsp;recap</a></li><li><a href="source-listing.html">10&emsp;source list­ing</a></li></ul></div>
    <a class="nav-left" href="conditionals.html">← prev</a>
    <a class="nav-right" href="recap.html">next →</a>




</body>

<script type="text/javascript">



function show_all_forms() {
 var elems = document.getElementsByClassName('has_form');
 for (var i = 0 ; i < elems.length ; i++) {
  toggle_form(elems[i].id);
 }
}

// for debugging forms only: uncomment next line
// show_all_forms();

// sets up copy-to-clipboard buttons in code boxes
var clipboard = new Clipboard('.copy-button');
clipboard.on('success', function(e) {console.log(e);});
clipboard.on('error', function(e) {console.log(e);});
</script>