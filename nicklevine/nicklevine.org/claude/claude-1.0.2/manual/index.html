<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<!-- Mirrored from nicklevine.org/claude/claude-1.0.2/manual/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 28 Jul 2017 13:23:32 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.11: http://docutils.sourceforge.net/" />
<title>CLAUDE AND CLAUDE-SETUP</title>
<link rel="stylesheet" href="style/claude.css" type="text/css" />
</head>
<body>
<div class="document" id="claude-and-claude-setup">
<h1 class="title">CLAUDE AND CLAUDE-SETUP</h1>

<!-- -*- mode: rst; eval: (rst2html-after-save-hook) -*- -->
<!-- $Id: //info.ravenbrook.com/user/ndl/lisp/claude/claude-1.0.2/manual/source/index.txt#1 $ -->
<p>This is the documentation for CLAUDE and CLAUDE-SETUP, version 1.0.</p>
<p><strong>CLAUDE</strong> (the <em>Common Lisp Library Audience Expansion Toolkit</em>)
exports libraries written in Common Lisp, so that applications being
developed in other languages can access them. CLAUDE co-operates with
foreign runtimes in the management of CLOS objects, records, arrays
and more primitive types. Lisp macros make the task of exporting a
library simple and elegant; template documentation along with C
headers and sample code files relieve some of the burden of explaining
such exports to the application programmer.</p>
<p><strong>CLAUDE-SETUP</strong> configures CLAUDE for your library.</p>
<div class="contents local topic" id="contents">
<ul class="auto-toc simple">
<li><a class="reference internal" href="#getting-started" id="id75">1&nbsp;&nbsp;&nbsp;Getting Started</a><ul class="auto-toc">
<li><a class="reference internal" href="#rapid-example" id="id76">1.1&nbsp;&nbsp;&nbsp;Rapid Example</a></li>
<li><a class="reference internal" href="#summary" id="id77">1.2&nbsp;&nbsp;&nbsp;Summary</a></li>
<li><a class="reference internal" href="#requirements" id="id78">1.3&nbsp;&nbsp;&nbsp;Requirements</a></li>
<li><a class="reference internal" href="#runtime-libraries" id="id79">1.4&nbsp;&nbsp;&nbsp;Runtime libraries</a></li>
<li><a class="reference internal" href="#setting-up-your-library" id="id80">1.5&nbsp;&nbsp;&nbsp;Setting up your library</a></li>
<li><a class="reference internal" href="#road-test" id="id81">1.6&nbsp;&nbsp;&nbsp;Road test</a></li>
<li><a class="reference internal" href="#build-script" id="id82">1.7&nbsp;&nbsp;&nbsp;Build script</a></li>
<li><a class="reference internal" href="#library-names" id="id83">1.8&nbsp;&nbsp;&nbsp;Library names</a></li>
</ul>
</li>
<li><a class="reference internal" href="#external-interface" id="id84">2&nbsp;&nbsp;&nbsp;External Interface</a><ul class="auto-toc">
<li><a class="reference internal" href="#initialisation-and-termination" id="id85">2.1&nbsp;&nbsp;&nbsp;Initialisation and termination</a></li>
<li><a class="reference internal" href="#calling-claude-functions" id="id86">2.2&nbsp;&nbsp;&nbsp;Calling CLAUDE functions</a></li>
<li><a class="reference internal" href="#data-model" id="id87">2.3&nbsp;&nbsp;&nbsp;Data model</a></li>
<li><a class="reference internal" href="#error-handling" id="id88">2.4&nbsp;&nbsp;&nbsp;Error handling</a></li>
<li><a class="reference internal" href="#dereferencing" id="id89">2.5&nbsp;&nbsp;&nbsp;Dereferencing</a></li>
<li><a class="reference internal" href="#records" id="id90">2.6&nbsp;&nbsp;&nbsp;Records</a></li>
<li><a class="reference internal" href="#arrays" id="id91">2.7&nbsp;&nbsp;&nbsp;Arrays</a></li>
<li><a class="reference internal" href="#handles" id="id92">2.8&nbsp;&nbsp;&nbsp;Handles</a></li>
<li><a class="reference internal" href="#tests" id="id93">2.9&nbsp;&nbsp;&nbsp;Tests</a></li>
<li><a class="reference internal" href="#reference" id="id94">2.10&nbsp;&nbsp;&nbsp;Reference</a></li>
</ul>
</li>
<li><a class="reference internal" href="#internal-interface" id="id95">3&nbsp;&nbsp;&nbsp;Internal Interface</a><ul class="auto-toc">
<li><a class="reference internal" href="#the-claude-package" id="id96">3.1&nbsp;&nbsp;&nbsp;The CLAUDE package</a></li>
<li><a class="reference internal" href="#id53" id="id97">3.2&nbsp;&nbsp;&nbsp;Types</a></li>
<li><a class="reference internal" href="#the-defining-macros" id="id98">3.3&nbsp;&nbsp;&nbsp;The defining macros</a></li>
<li><a class="reference internal" href="#external-functions" id="id99">3.4&nbsp;&nbsp;&nbsp;External functions</a></li>
<li><a class="reference internal" href="#callback-management" id="id100">3.5&nbsp;&nbsp;&nbsp;Callback management</a></li>
<li><a class="reference internal" href="#memory" id="id101">3.6&nbsp;&nbsp;&nbsp;Memory</a></li>
<li><a class="reference internal" href="#debugging-and-error-handling" id="id102">3.7&nbsp;&nbsp;&nbsp;Debugging and error handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting" id="id103">4&nbsp;&nbsp;&nbsp;Troubleshooting</a></li>
</ul>
</div>
<div class="section" id="getting-started">
<h1><a class="toc-backref" href="#id75">1&nbsp;&nbsp;&nbsp;Getting Started</a></h1>
<p>For a general overview of CLAUDE, see the <a class="reference external" href="../../paper.pdf">paper</a> presented at <a class="reference external" href="http://www.european-lisp-symposium.org/">ELS 2014</a>.</p>
<p>For an example of an library developed using CLAUDE, see Ravenbrook's
<a class="reference external" href="http://chart.ravenbrook.com/downloads">Chart Desktop</a>.</p>
<div class="section" id="rapid-example">
<h2><a class="toc-backref" href="#id76">1.1&nbsp;&nbsp;&nbsp;Rapid Example</a></h2>
<p>With very little overhead, the library author can define an <em>external
class</em>:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defclass-external</span> <span class="name variable">frob</span> <span class="punctuation">()</span>
  <span class="punctuation">())</span>
</pre>
<p>and an <em>external function</em> which returns an instance of that class:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">new-frob</span> <span class="literal string symbol">:result-type</span> <span class="name variable">object</span><span class="punctuation">)</span> <span class="punctuation">()</span>
  <span class="punctuation">(</span><span class="name builtin">make-instance</span> <span class="literal string symbol">'frob</span><span class="punctuation">))</span>
</pre>
<p>A Python application programmer can then instantiate the class thus:</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="name">claude</span><span class="operator">.</span><span class="name">Frob</span><span class="punctuation">()</span>
<span class="operator">&lt;</span><span class="name">Claude</span> <span class="name">Frob</span> <span class="name">handle</span><span class="operator">=</span><span class="literal number hex">0x200538b0</span><span class="operator">&gt;</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
</div>
<div class="section" id="summary">
<h2><a class="toc-backref" href="#id77">1.2&nbsp;&nbsp;&nbsp;Summary</a></h2>
<p>These are the steps you'll need to take, to export your lisp library:</p>
<ol class="arabic simple">
<li>Check out the <a class="reference external" href="#requirements">requirements</a> below.</li>
<li>Use <a class="reference internal" href="#claude-setup"><tt class="docutils literal"><span class="pre">CLAUDE-SETUP</span></tt></a> to create and configure a copy of the toolkit.</li>
<li>Merge your source code into this (or, at least, point the system
definition to your code).</li>
<li>Write a <a class="reference external" href="#internal-interface">CLAUDE interface layer</a> to your code.</li>
<li>Run the <a class="reference internal" href="#save-dll-lisp"><tt class="docutils literal"><span class="pre">save-dll.lisp</span></tt></a> script.</li>
<li>Test what you've done so far by expanding the sample Python
interface to work with it.</li>
<li>Now get the C interface working too.</li>
<li>Expand the <a class="reference external" href="../mumble/manual/index.html">template documentation</a>,
to cover your exports as well as CLAUDE's.</li>
</ol>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id78">1.3&nbsp;&nbsp;&nbsp;Requirements</a></h2>
<ul class="simple">
<li>CLAUDE currently only runs on <a class="reference external" href="http://www.lispworks.com/">LispWorks</a>. It's been tested with version 6.1 on
32-bit Windows. CLAUDE could be ported to other operating systems,
and should be portable to a few other lisp implementations
(probably: <a class="reference external" href="http://franz.com/products/allegrocl/">Allegro</a>, <a class="reference external" href="http://abcl.org/">ABCL</a> and <a class="reference external" href="http://ecls.sourceforge.net/">ECL</a>), all
for reasonable effort. Please <a class="reference external" href="mailto:claude&#64;ravenbrook.com">talk to me</a> if you need a port to a different
platform.</li>
<li>Application programmers using your library, and their end users,
will need the <a class="reference external" href="#runtime-libraries">runtime libraries</a> upon which LispWorks depends.</li>
<li>CLAUDE uses the <a class="reference external" href="http://common-lisp.net/project/bordeaux-threads/">Bordeaux Threads</a> and <a class="reference external" href="http://common-lisp.net/project/cffi/">Common
Foreign Function Interface</a>
libraries. It assumes that <a class="reference external" href="http://www.quicklisp.org/">Quicklisp</a>
is present and able to load them.</li>
<li>The examples require <a class="reference external" href="http://www.python.org/download/releases/2.7.6/">Python 2.7</a> and a C compiler
(I've tested against: Visual Studio 2012 C and C++; Cygwin; MinGW).</li>
<li>The template documentation is written as <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a>. I use <a class="reference external" href="http://docutils.sourceforge.net/docs/user/tools.html">rst2html.py</a> to convert
it to HTML, but you might choose another method, or throw the whole
thing out and start again.</li>
</ul>
</div>
<div class="section" id="runtime-libraries">
<h2><a class="toc-backref" href="#id79">1.4&nbsp;&nbsp;&nbsp;Runtime libraries</a></h2>
<p>Your users (application programmers using your CLAUDE-based library)
must be shown the following warning, which is also included in the
template documentation.</p>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you don't intend either to copy / move the DLL after you've
unpacked it, or to redistribute an application you've built using
this library, you can skip this small print.</p>
</div>
<p><span class="small">The library needs access to Microsoft's</span> <span class="smallcite">C Runtime
and Standard C++ Libraries.</span> <span class="small">If it can't find them it simply
won't run. You'll see something like this:</span></p>
<img alt="images/incorrect-config.png" src="images/incorrect-config.png" />
<p><span class="small">These runtime libraries can be either installed to a central
location on your computer or</span> — <span class="small">as in the .ZIP archive</span>
— <span class="small">present in a Microsoft.VC80.CRT\ directory alongside
the library's DLL.</span></p>
<ul>
<li><p class="first"><span class="small">Central location</span></p>
<p><span class="small">If the runtime libraries have already been installed on your
machine (by the installer of some other application, say) then you
can move or copy the library DLL as you wish, and it will continue to
work.</span></p>
</li>
<li><p class="first"><span class="small">Private copy</span></p>
<p><span class="small">Otherwise, if you move or copy the DLL you should keep a
copy of Microsoft.VC80.CRT\ alongside it.</span></p>
</li>
<li><p class="first"><span class="small">Redistribution</span></p>
<p><span class="small">If you redistribute an application based on this library
then you will need to revisit this issue. Advice on</span>
<span class="smallcite">Redistributing Visual C++ libraries</span> <span class="small">will be
found on the MSDN website:</span> <a class="reference external" href="http://msdn.microsoft.com/en-us/library/ms235316(v=vs.80).aspx">here</a>.</p>
</li>
</ul>
</div>
<div class="section" id="setting-up-your-library">
<span id="claude-setup"></span><h2><a class="toc-backref" href="#id80">1.5&nbsp;&nbsp;&nbsp;Setting up your library</a></h2>
<!-- .. CLAUDE-SETUP is available via `Quicklisp <http://www.quicklisp.org/>`_. -->
<p>CLAUDE-SETUP can be downloaded from <a class="reference external" href="../../index.html">http://www.nicklevine.org/claude/</a>.
It contains an unconfigured copy of CLAUDE. Configure CLAUDE for your
library by calling <tt class="docutils literal"><span class="pre">claude-setup:configure</span></tt>, supplying as arguments
the keyword naming your library and a location where it can be
unpacked. For example:</p>
<!-- (ql:quickload :claude-setup) -->
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">asdf:load-system</span> <span class="literal string symbol">:claude-setup</span><span class="punctuation">)</span>
<span class="punctuation">(</span><span class="name variable">claude-setup:configure</span> <span class="literal string symbol">:wombat</span> <span class="literal string">&quot;c:/home/wombat&quot;</span><span class="punctuation">)</span>
</pre>
<p>After running the above form, the <tt class="docutils literal">wombat</tt> directory will contain the
following:</p>
<pre class="literal-block">
c:/home/wombat/
   build/save-dll.lisp       script for saving library as DLL
   wombat.asd              * system definition for wombat
   claude/                   CLAUDE source
   examples/C/             * a brief test case
   include/                * C header file
   library                   text file containing the string &quot;wombat&quot;
   manual/                 * wombat documentation
   Microsoft.VC80.CRT/       runtime libraries used by CLAUDE
   pyWombat/               * example Python interface
   src/                    * system definition for wombat
</pre>
<p>You'll find working with this document, and in particular the Python
example, easiest if you keep all these files together.</p>
<p>The starred items above will need your attention.</p>
</div>
<div class="section" id="road-test">
<h2><a class="toc-backref" href="#id81">1.6&nbsp;&nbsp;&nbsp;Road test</a></h2>
<p>Even before you've done any work to connect your library to CLAUDE you
can test run the vanilla framework, by using the build script
<tt class="docutils literal"><span class="pre">save-dll.lisp</span></tt> to save a DLL and then running some tests through
the Python interface.</p>
<p><strong>CLAUDE is a 32-bit library; you'll need a 32-bit Python installation.</strong></p>
<pre class="code python literal-block">
<span class="name">C</span><span class="punctuation">:</span>\<span class="name">home</span>\<span class="name">wombat</span><span class="operator">&gt;</span> <span class="name">lispworks</span> <span class="operator">-</span><span class="name">init</span> <span class="name">build</span>\<span class="name">save</span><span class="operator">-</span><span class="name">dll</span><span class="operator">.</span><span class="name">lisp</span>
<span class="punctuation">[</span><span class="operator">...</span><span class="punctuation">]</span> <span class="punctuation">;</span> <span class="name">saves</span> <span class="name">wombat</span><span class="operator">.</span><span class="name">dll</span>
<span class="name">C</span><span class="punctuation">:</span>\<span class="name">home</span>\<span class="name">wombat</span><span class="operator">&gt;</span> <span class="name">python</span>
<span class="name">Python</span> <span class="literal number float">2.7</span><span class="operator">.</span><span class="literal number integer">1</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyWombat</span> <span class="keyword namespace">import</span> <span class="name">wombat</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">wombat</span><span class="operator">.</span><span class="name">Wombat</span><span class="punctuation">()</span>
<span class="operator">&lt;</span><span class="name">Wombat</span> <span class="name">Wombat</span> <span class="name">handle</span><span class="operator">=</span><span class="literal number hex">0x200538b0</span><span class="operator">&gt;</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">wombat</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">communications_test</span><span class="punctuation">()</span>
<span class="name builtin pseudo">True</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
<p>See <a class="reference external" href="../mumble/manual/index.html#tests">below</a> for details of further tests in the vanilla interface.</p>
</div>
<div class="section" id="build-script">
<span id="save-dll-lisp"></span><h2><a class="toc-backref" href="#id82">1.7&nbsp;&nbsp;&nbsp;Build script</a></h2>
<p>This <a class="reference external" href="../mumble/build/save-dll.html">script</a> should be loaded into a TTY LispWorks (using the <tt class="docutils literal"><span class="pre">-init</span></tt>
command-line option is recommended) to save your CLAUDE-based library
as a DLL.</p>
<p>Your system should have been defined in the file <a class="reference external" href="../mumble/src/defsys.html">src/defsys.lisp</a>.
If you'd rather use ASDF to manage your code then you'll need an
obvious edit to <tt class="docutils literal">(defun <span class="pre">application-load)</span></tt> in the script to support
this.</p>
<p>Supply <tt class="docutils literal"><span class="pre">-force</span></tt> on the command-line to force recompile the system.</p>
<p>Supply <tt class="docutils literal"><span class="pre">-devel</span></tt> to save a full development image (LispWorks IDE
opens when your library is initialized); otherwise the library will be
<a class="reference external" href="http://www.lispworks.com/documentation/lw61/DV/html/delivery.htm">delivered</a>
(at level 0).</p>
<p>When the full development image restarts, it automatically reloads the
CLAUDE system; if you have not added any <a class="reference internal" href="#defun-external"><tt class="docutils literal"><span class="pre">defun-external</span></tt></a> forms since
you last saved the image then all your edits are now part of the
library.</p>
<p>Example:</p>
<pre class="code common-lisp literal-block">
<span class="name variable">lww-console-611.exe</span> <span class="name variable">-init</span> <span class="name variable">build\save-dll.lisp</span> <span class="name variable">-devel</span>
</pre>
<p>You will need two Quicklisp libraries (Bordeaux Threads, and the
Common Foreign Function Interface) and it's assumed that Quicklisp
knows where to find them.</p>
<div class="section" id="configurations">
<h3>1.7.1&nbsp;&nbsp;&nbsp;Configurations</h3>
<ol class="arabic simple">
<li>If you have a <tt class="docutils literal">.ico</tt> file which you want associated with the
library, uncomment the <tt class="docutils literal"><span class="pre">:icon-file</span></tt> line in the call to
<tt class="docutils literal">deliver</tt>.</li>
<li>In the IDE you might find it handy for listeners to open in some
particular package. See <tt class="docutils literal"><span class="pre">#+try-this</span></tt> towards the end of the
script.</li>
</ol>
</div>
</div>
<div class="section" id="library-names">
<h2><a class="toc-backref" href="#id83">1.8&nbsp;&nbsp;&nbsp;Library names</a></h2>
<p>The rest of this document assumes, for want of anything better, that
your library is called <em>Mumble</em>. The copy of CLAUDE which forms part
of the CLAUDE-SETUP distribution has already been configured under
that name, the upshot being that you can use it along with most of
the examples here and not have to change any names.</p>
<p>The mapping from lisp names to foreign names is given by:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">substitute</span> <span class="literal string char">#\_</span> <span class="literal string char">#\-</span> <span class="punctuation">(</span><span class="name builtin">format</span> <span class="name constant">nil</span> <span class="literal string">&quot;~(~a_~a~)&quot;</span> <span class="name variable global">*claude-library*</span> <span class="name variable">lisp-name</span><span class="punctuation">))</span>
</pre>
</div>
</div>
<div class="section" id="external-interface">
<h1><a class="toc-backref" href="#id84">2&nbsp;&nbsp;&nbsp;External Interface</a></h1>
<p>This section covers everything the application programmer needs to
know about driving CLAUDE. I'll cover starting and stopping the
library, function calls, error handling, the structures CLAUDE uses,
and memory and how to free it.</p>
<p>Your users will have to start by implementing their own infrastructure
layer, as described below. In your role as their software supplier,
you should know how it's done. Also, the <a class="reference external" href="#external-interface">lisp reference</a> assumes
familiarity with this section and its terminology. The <a class="reference external" href="../mumble/examples/C/test.c">C example</a> might help, as should the following
files in the Python interface:</p>
<blockquote>
<dl class="docutils">
<dt><a class="reference external" href="../mumble/pyMumble/invoke.html">invoke.py</a></dt>
<dd>Function call wrappers: extract results, check for errors</dd>
<dt><a class="reference external" href="../mumble/pyMumble/lib.html">lib.py</a></dt>
<dd>Stubs for all calls into the DLL</dd>
<dt><a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a></dt>
<dd>Implementations of the objects that CLAUDE uses</dd>
</dl>
</blockquote>
<p>In the following I'll use extracts from the Python interface to
demonstrate how to drive the library. I'll assume some familiarity
with Python's <a class="reference external" href="http://docs.python.org/2/library/ctypes.html"><tt class="docutils literal">ctypes</tt></a> foreign function library.</p>
<p><strong>The library's calling convention is stdcall.</strong></p>
<div class="section" id="initialisation-and-termination">
<h2><a class="toc-backref" href="#id85">2.1&nbsp;&nbsp;&nbsp;Initialisation and termination</a></h2>
<p>The CLAUDE library initialises itself automatically, the first time
you call any function in its interface. If you find this distasteful,
you can initialise the library explicitly by calling <a class="reference internal" href="#mumble-init"><tt class="docutils literal">mumble_init()</tt></a>.</p>
<p>Somewhat more important is to close the library gracefully when you're
finished it, by calling <a class="reference internal" href="#mumble-close"><tt class="docutils literal">mumble_close()</tt></a>; failure to do may result in
a warning message.</p>
<p>The Python interface arranges for this in <a class="reference external" href="../mumble/pyMumble/connect.html">connect.py</a>, which also sets the global <tt class="docutils literal">dll</tt> to point
to the ctypes shared library object. Every export from the library is
now a member of the <tt class="docutils literal">dll</tt> object (for example, we can invoke the
library function <a class="reference internal" href="#mumble-init"><tt class="docutils literal">mumble_init()</tt></a> by calling <tt class="docutils literal">dll.mumble_init</tt>).</p>
<p><tt class="docutils literal">connect.py</tt>, along with everything else you'll need to go with it,
is imported by <tt class="docutils literal">mumble.py</tt>:</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyMumble</span> <span class="keyword namespace">import</span> <span class="name">mumble</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
</div>
<div class="section" id="calling-claude-functions">
<span id="error-will-be-signalled"></span><span id="error-to-be-signalled"></span><span id="error-is-signalled"></span><span id="signal-an-error"></span><h2><a class="toc-backref" href="#id86">2.2&nbsp;&nbsp;&nbsp;Calling CLAUDE functions</a></h2>
<p>All CLAUDE functions return a result code of type <a class="reference internal" href="#mumble-res-t"><tt class="docutils literal">mumble_res_t</tt></a>.
They indicate <cite>success</cite> by returning <tt class="docutils literal">MUMBLE_RES_OK</tt>, which is
defined to be zero; they <cite>signal errors</cite> by returning
<tt class="docutils literal">MUMBLE_RES_FAIL</tt>, which is non-zero, and retaining a string
describing the error. You can retrieve the most recent error string by
calling <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a>.</p>
<p>In the Python example, the function <tt class="docutils literal">check</tt> in <a class="reference external" href="../mumble/pyMumble/invoke.html">invoke.py</a> examines the return value of a
function call into the library. If this value is not OK (zero) then a
<a class="reference external" href="#error-handling">MumbleError</a> is raised.</p>
<pre class="code python literal-block">
<span class="name">OK</span> <span class="operator">=</span> <span class="literal number integer">0</span>

<span class="keyword">def</span> <span class="name function">check</span><span class="punctuation">(</span><span class="name">func</span><span class="punctuation">,</span> <span class="operator">*</span><span class="name">args</span><span class="punctuation">):</span>
    <span class="literal string doc">&quot;&quot;&quot;
    Apply func to its args, checking the result code.
    &quot;&quot;&quot;</span>
    <span class="name">result</span> <span class="operator">=</span> <span class="name">func</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">args</span><span class="punctuation">)</span>
    <span class="keyword">if</span> <span class="name">result</span> <span class="operator">!=</span> <span class="name">OK</span><span class="punctuation">:</span>
        <span class="keyword">raise</span> <span class="name">MumbleError</span><span class="punctuation">()</span>
</pre>
<p>Library functions which need to return some value in addition to the
result code do so by reference: they take a pointer as their first
argument and write through it.</p>
<p>Still in <a class="reference external" href="../mumble/pyMumble/invoke.html">invoke.py</a>, the function
wrapper <tt class="docutils literal">val</tt> creates just such a pointer. This pointer is prepended
to <tt class="docutils literal">func</tt>'s argument list, the library is invoked, the result code
checked, and the result is extracted. The wrapper <tt class="docutils literal">void</tt> has the
same form but is for calls which don't return a useful result.</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">val</span><span class="punctuation">(</span><span class="name">func</span><span class="punctuation">):</span>
    <span class="literal string doc">&quot;&quot;&quot;
    Return a function which calls func with an additional pointer argument,
    checks the result, and dereferences the pointer.
    &quot;&quot;&quot;</span>
    <span class="keyword">def</span> <span class="name function">invoker</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">args</span><span class="punctuation">):</span>
        <span class="name">pointer</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_void_p</span><span class="punctuation">()</span>
        <span class="name">check</span><span class="punctuation">(</span><span class="name">func</span><span class="punctuation">,</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">byref</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">),</span> <span class="operator">*</span><span class="name">args</span><span class="punctuation">)</span>
        <span class="keyword">return</span> <span class="name">pointer</span><span class="operator">.</span><span class="name">value</span>
    <span class="keyword">return</span> <span class="name">invoker</span>

<span class="keyword">def</span> <span class="name function">void</span><span class="punctuation">(</span><span class="name">func</span><span class="punctuation">):</span>
    <span class="literal string doc">&quot;&quot;&quot;
    Return a function which calls func, checking the result.
    &quot;&quot;&quot;</span>
    <span class="keyword">def</span> <span class="name function">invoker</span><span class="punctuation">(</span><span class="operator">*</span><span class="name">args</span><span class="punctuation">):</span>
        <span class="name">check</span><span class="punctuation">(</span><span class="name">func</span><span class="punctuation">,</span> <span class="operator">*</span><span class="name">args</span><span class="punctuation">)</span>
    <span class="keyword">return</span> <span class="name">invoker</span>
</pre>
</div>
<div class="section" id="data-model">
<h2><a class="toc-backref" href="#id87">2.3&nbsp;&nbsp;&nbsp;Data model</a></h2>
<p>CLAUDE functions take arguments of the following types:</p>
<ul class="simple">
<li><a class="reference internal" href="#integer"><tt class="docutils literal">integer</tt></a> (signed and unsigned);</li>
<li>UTF-8 encoded string;</li>
<li><a class="reference internal" href="#handle"><tt class="docutils literal">handle</tt></a> (denoting an object within the library);</li>
<li><a class="reference internal" href="#record"><tt class="docutils literal">record</tt></a> (sequence of values whose length and constituent types
are determined by the context in which it's being passed);</li>
<li><a class="reference internal" href="#array"><tt class="docutils literal">array</tt></a> (sequence of values whose length is not known in advance);</li>
<li>pointer to any of the above (for <a class="reference external" href="#calling-claude-functions">return values</a>);</li>
<li>pointer to function (passed as an unsigned integer).</li>
</ul>
<p><strong>This version of CLAUDE does not support floats. Please</strong> <a class="reference external" href="mailto:claude&#64;ravenbrook.com">write to
me</a> <strong>if this is a problem.</strong></p>
<p>Handles are only ever generated by the library. When you have no
further use for a handle you should call <a class="reference internal" href="#mumble-remove-objects"><tt class="docutils literal">mumble_remove_objects()</tt></a>.</p>
<p><a class="reference internal" href="#aggregate"><tt class="docutils literal">Aggregate</tt></a> values — strings, records (for example, a pair of
integers representing a co-ordinate pair) and arrays (for example, a
list of co-ordinate pairs) — might be generated by either the
library or your application.</p>
<p>The contents of any aggregate value created by your application,
passed into CLAUDE and retained there — for example, the string to
be used as the title of a display window, or an array of records
describing new objects to be added to the system — are copied by
the library before your call returns. So you may immediately recycle
the memory associated with such values.</p>
<p>Any aggregate value created within the library and passed to your
application as return data will be retained by CLAUDE, until you
declare that you have no further use for it by calling the library
function <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a>. If you free a sequence (i.e. a <a class="reference internal" href="#record"><tt class="docutils literal">record</tt></a>
or <a class="reference internal" href="#array"><tt class="docutils literal">array</tt></a>) which itself contains any aggregate values, then these
values will be freed recursively.</p>
<p>The Python interface has a simple stub for invoking <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a>:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">free</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">):</span>
    <span class="name">invoke</span><span class="operator">.</span><span class="name">void</span><span class="punctuation">(</span><span class="name">dll</span><span class="operator">.</span><span class="name">mumble_free</span><span class="punctuation">)(</span><span class="name">pointer</span><span class="punctuation">)</span>
</pre>
<p><strong>Note that</strong> <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> <strong>does not free</strong> <a class="reference internal" href="#id27"><tt class="docutils literal">handles</tt></a>, or
release them in any sense. Freeing an array of objects releases the
resources associated with the array itself and not those of the
objects. (See instead <a class="reference internal" href="#mumble-remove-objects"><tt class="docutils literal">mumble_remove_objects()</tt></a>.)</p>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">The library is designed to catch and recover from errors but it
cannot be totally resilient to bad data: the only way for it to
interpret an <a class="reference internal" href="#aggregate"><tt class="docutils literal">aggregate</tt></a> value (string, record, array) is to
dereference the corresponding pointer. If the pointer is invalid
this may lead to an unhandled exception which could crash either the
library or your application. If you're working in Python the
following minimal check from <a class="reference external" href="../mumble/pyMumble/invoke.html">invoke.py</a> is suggested.</p>
</div>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">plausible_address</span><span class="punctuation">(</span><span class="name">address</span><span class="punctuation">):</span>
    <span class="literal string doc">&quot;&quot;&quot;
    Return the address, checking that it refers to valid memory.

    This is only the most basic of checks. The address of a compound
    record might pass this test but what it points to might be
    rubbish, and we can't check for that without going into a
    description of record layout.

    The test works by loading one byte from the given address. If
    there's anything wrong with the address, Python will handle the
    error and raise one of its own Exceptions.
    &quot;&quot;&quot;</span>
    <span class="name">ctypes</span><span class="operator">.</span><span class="name">string_at</span><span class="punctuation">(</span><span class="name">address</span><span class="punctuation">,</span> <span class="literal number integer">1</span><span class="punctuation">)</span>
    <span class="keyword">return</span> <span class="name">address</span>
</pre>
</div>
<div class="section" id="error-handling">
<span id="mumbleerror-will-be-raised"></span><span id="mumbleerror-to-be-raised"></span><span id="mumbleerror-is-raised"></span><span id="raise-a-mumbleerror"></span><span id="raise-an-exception"></span><h2><a class="toc-backref" href="#id88">2.4&nbsp;&nbsp;&nbsp;Error handling</a></h2>
<p>Let's see how errors might be handled. The <tt class="docutils literal">MumbleError</tt> exception
defined in <a class="reference external" href="../mumble/pyMumble/invoke.html">invoke.py</a> demonstrates:</p>
<ul class="simple">
<li>checking result codes;</li>
<li>a CLAUDE function returning a value in addition to its result code;</li>
<li>use of  <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> to release the resources associated with a
string which originated inside the library.</li>
</ul>
<p>Raising this exception calls <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a> and reports the
result. As corner cases, the exception checks whether (a) there
actually was any error in the first place, (b) it was possible to
report the error and (c) it was possible to <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> the error
report. In the last case a warning note is tacked onto the head of the
report rather than risking a chain of recursive errors.</p>
<pre class="code python literal-block">
<span class="keyword">class</span> <span class="name class">MumbleError</span><span class="punctuation">(</span><span class="name exception">Exception</span><span class="punctuation">):</span>
    <span class="keyword">def</span> <span class="name function">__init__</span><span class="punctuation">(</span><span class="name builtin pseudo">self</span><span class="punctuation">):</span>
        <span class="name">string</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_char_p</span><span class="punctuation">(</span><span class="name builtin pseudo">None</span><span class="punctuation">)</span>
        <span class="name">error</span> <span class="operator">=</span> <span class="name">dll</span><span class="operator">.</span><span class="name">mumble_last_error</span><span class="punctuation">(</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">byref</span><span class="punctuation">(</span><span class="name">string</span><span class="punctuation">))</span>
        <span class="keyword">if</span> <span class="name">error</span> <span class="operator">!=</span> <span class="name">OK</span><span class="punctuation">:</span>
            <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span> <span class="operator">=</span> <span class="literal string">'Mumble reports an error, '</span> \
                          <span class="operator">+</span> <span class="literal string">'and an error reporting the error.'</span>
        <span class="keyword">else</span><span class="punctuation">:</span>
            <span class="name">value</span> <span class="operator">=</span> <span class="name">string</span><span class="operator">.</span><span class="name">value</span>
            <span class="keyword">if</span> <span class="name">value</span><span class="punctuation">:</span>
                <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span> <span class="operator">=</span> <span class="name">value</span><span class="operator">.</span><span class="name">decode</span><span class="punctuation">(</span><span class="literal string">'utf-8'</span><span class="punctuation">)</span>
                <span class="keyword">if</span> <span class="operator word">not</span> <span class="name">config</span><span class="operator">.</span><span class="name">show_backtrace</span><span class="punctuation">:</span>
                    <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span> <span class="operator">=</span> <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span><span class="operator">.</span><span class="name">splitlines</span><span class="punctuation">()[</span><span class="literal number integer">0</span><span class="punctuation">]</span>
                <span class="keyword">if</span> <span class="name">dll</span><span class="operator">.</span><span class="name">mumble_free</span><span class="punctuation">(</span><span class="name">string</span><span class="punctuation">)</span> <span class="operator">!=</span> <span class="name">OK</span><span class="punctuation">:</span>
                    <span class="comment"># Today isn't turning out very well. (Not that I</span>
                    <span class="comment"># was seriously expecting to end up on this branch.)</span>
                    <span class="name">warning</span> <span class="operator">=</span> <span class="literal string">'*** Warning: Mumble was unable to free '</span> \
                              <span class="operator">+</span> <span class="literal string">'the mumble_last_error string. ***'</span>
                    <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span> <span class="operator">=</span> <span class="name">warning</span> <span class="operator">+</span> <span class="literal string">'</span><span class="literal string escape">\n\n</span><span class="literal string">'</span> <span class="operator">+</span> <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span>
            <span class="keyword">else</span><span class="punctuation">:</span>
                <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span> <span class="operator">=</span> <span class="literal string">'How did this happen? There was no error in Mumble.'</span>

    <span class="keyword">def</span> <span class="name function">__str__</span><span class="punctuation">(</span><span class="name builtin pseudo">self</span><span class="punctuation">):</span>
        <span class="keyword">return</span> <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">string</span>
</pre>
<p>(You'll note that I haven't made use of the bundling functions
<tt class="docutils literal">check</tt>, <tt class="docutils literal">val</tt> or <tt class="docutils literal">void</tt> here. That's because any failure they
encountered would recursively raise another <tt class="docutils literal">MumbleError</tt>, which
could rapidly spiral out of control.)</p>
<p>The string returned from <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a> describes the most
recent error signalled by the library. If this was a <em>pilot error</em>
then you'll get a one line description of the problem. If
alternatively some exceptional condition (say: division by zero) was
caught then a backtrace will be included. This might be longer and
less edifying than you care for; <tt class="docutils literal">MumbleError</tt> uses the configuration
variable <tt class="docutils literal">show_backtrace</tt> from <a class="reference external" href="../mumble/pyMumble/config.html">config.py</a>
to decide whether to show you the backtrace.</p>
<p>If there is no error to report, <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a> returns a null
pointer.</p>
<p>Let's go under the hood. I'll bypasss all the bundling and checking
functions (<tt class="docutils literal">check</tt> etc.) and make a series of low-level calls, at
the Python prompt, directly into the DLL:</p>
<ol class="arabic simple">
<li>provoking a deliberate error (result code is not <tt class="docutils literal">OK</tt>),</li>
<li>calling <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a> to obtain a string describing the
error,</li>
<li><a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a>ing the string, and</li>
<li>polling to see if there's another error string (which there
isn't).</li>
</ol>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">import</span> <span class="name namespace">ctypes</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyMumble.invoke</span> <span class="keyword namespace">import</span> <span class="name">dll</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">dll</span><span class="operator">.</span><span class="name">mumble_free</span><span class="punctuation">(</span><span class="literal number hex">0xdeadbeef</span><span class="punctuation">)</span>
<span class="operator">-</span><span class="literal number integer">1</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">string</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_char_p</span><span class="punctuation">(</span><span class="name builtin pseudo">None</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">dll</span><span class="operator">.</span><span class="name">mumble_last_error</span><span class="punctuation">(</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">byref</span><span class="punctuation">(</span><span class="name">string</span><span class="punctuation">))</span>
<span class="literal number integer">0</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">string</span>
<span class="name">c_char_p</span><span class="punctuation">(</span><span class="literal string">'Pointer to 0xdeadbeef is invalid and cannot be freed.</span><span class="literal string escape">\r\n</span><span class="literal string">'</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">dll</span><span class="operator">.</span><span class="name">mumble_free</span><span class="punctuation">(</span><span class="name">string</span><span class="punctuation">)</span>
<span class="literal number integer">0</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">dll</span><span class="operator">.</span><span class="name">mumble_last_error</span><span class="punctuation">(</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">byref</span><span class="punctuation">(</span><span class="name">string</span><span class="punctuation">))</span>
<span class="literal number integer">0</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">string</span>
<span class="name">c_char_p</span><span class="punctuation">(</span><span class="name builtin pseudo">None</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
<p>The C equivalent to the above might be based on the following
fragments:</p>
<pre class="code cpp literal-block">
<span class="comment preproc">#define ASSERT_OK(form)    \
   {mumble_res_t res = (form); assert(res == MUMBLE_RES_OK);}
#define ASSERT_FAIL(form)  \
   {mumble_res_t res = (form); assert(res == MUMBLE_RES_FAIL);}
</span>
<span class="keyword type">mumble_aggregate_t</span> <span class="name">pointer</span><span class="punctuation">;</span>

<span class="name">pointer</span><span class="punctuation">.</span><span class="name">string</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="keyword type">char</span><span class="operator">*</span><span class="punctuation">)</span><span class="literal number hex">0xdeadbeef</span><span class="punctuation">;</span>
<span class="name">ASSERT_FAIL</span><span class="punctuation">(</span><span class="name">mumble_free</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">));</span>

<span class="name">ASSERT_OK</span><span class="punctuation">(</span><span class="name">mumble_last_error</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">.</span><span class="name">string</span><span class="punctuation">)));</span>
<span class="name">assert</span><span class="punctuation">(</span><span class="name">strcmp</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">.</span><span class="name">string</span><span class="punctuation">,</span>
              <span class="literal string">&quot;Pointer to 0xdeadbeef is invalid and cannot be freed.</span><span class="literal string escape">\r\n</span><span class="literal string">&quot;</span><span class="punctuation">)</span>
       <span class="operator">==</span> <span class="literal number integer">0</span><span class="punctuation">);</span>
<span class="name">ASSERT_OK</span><span class="punctuation">(</span><span class="name">mumble_free</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">));</span>

<span class="name">ASSERT_OK</span><span class="punctuation">(</span><span class="name">mumble_last_error</span><span class="punctuation">(</span><span class="operator">&amp;</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">.</span><span class="name">string</span><span class="punctuation">)));</span>
<span class="name">assert</span><span class="punctuation">(</span><span class="name">pointer</span><span class="punctuation">.</span><span class="name">string</span> <span class="operator">==</span> <span class="literal number integer">0</span><span class="punctuation">);</span>
</pre>
<p>I won't document every possible way to <a class="reference internal" href="#raise-an-exception">raise an exception</a> while
working with this code. Most <tt class="docutils literal">MumbleError</tt>s have fairly obvious
causes. Working with discarded objects is the primary culprit. (The C
<a class="reference internal" href="#functions">functions</a> reference is more thorough about error conditions.)</p>
</div>
<div class="section" id="dereferencing">
<h2><a class="toc-backref" href="#id89">2.5&nbsp;&nbsp;&nbsp;Dereferencing</a></h2>
<p>Working from Python, we'll need to be able to switch between ctypes
instances and their memory addresses. (With the foreign interfaces of
other languages, the corresponding solution might look very
different. In C it'll be trivial.)</p>
<p>The pyMumble function <tt class="docutils literal">dereference_address</tt> in <a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a> takes one argument which it treats as the
memory address of a <tt class="docutils literal">ctypes.c_uint</tt>. It dereferences this address
and returns the integer. Dereferencing <tt class="docutils literal">0</tt> returns <tt class="docutils literal">None</tt>.</p>
<p>The function <tt class="docutils literal">address_of</tt> returns the address of a ctypes instance's
underlying data.</p>
<p>In the following example we create a ctypes <a class="reference external" href="http://docs.python.org/2/library/ctypes.html#arrays"><tt class="docutils literal">array</tt></a> which contains
an integer and the address of a ctypes string. By dereferencing the
address of the array we are able to recover the integer; by
dereferencing the address of the following word in memory we recover
the address of the string.</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyMumble</span> <span class="keyword namespace">import</span> <span class="name">objects</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">s</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_char_p</span><span class="punctuation">(</span><span class="literal string">'hello'</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">pointer</span><span class="punctuation">((</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">c_uint</span> <span class="operator">*</span><span class="literal number integer">2</span><span class="punctuation">)(</span><span class="literal number integer">99</span><span class="punctuation">,</span> <span class="name">objects</span><span class="operator">.</span><span class="name">address_of</span><span class="punctuation">(</span><span class="name">s</span><span class="punctuation">)))</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">address_of</span><span class="punctuation">(</span><span class="name">s</span><span class="punctuation">)</span>
<span class="literal number integer long">39344980L</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">address_of</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">)</span>
<span class="literal number integer long">38708808L</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">dereference_address</span><span class="punctuation">(</span><span class="literal number integer long">38708808L</span><span class="punctuation">)</span>
<span class="literal number integer long">99L</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">dereference_address</span><span class="punctuation">(</span><span class="literal number integer long">38708808L</span> <span class="operator">+</span> <span class="literal number integer">4</span><span class="punctuation">)</span>
<span class="literal number integer long">39344980L</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name builtin">hex</span><span class="punctuation">(</span><span class="name">objects</span><span class="operator">.</span><span class="name">dereference_address</span><span class="punctuation">(</span><span class="name">_</span><span class="punctuation">))</span>
<span class="literal string">'0x6c6c6568L'</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p>Watch out for the Python garbage collector!</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_char_p</span><span class="punctuation">(</span><span class="literal string">'goodbye'</span><span class="punctuation">)</span>
<span class="name">c_char_p</span><span class="punctuation">(</span><span class="literal string">'goodbye'</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">address_of</span><span class="punctuation">(</span><span class="name">_</span><span class="punctuation">)</span>
<span class="literal number integer long">39343764L</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">dereference_address</span><span class="punctuation">(</span><span class="name">_</span><span class="punctuation">)</span>
<span class="literal number integer long">0L</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
<p class="last">In this case we haven't retained a pointer to the ctypes string. Its
data has already been reclaimed and is no longer accessible to us.</p>
</div>
</div>
<div class="section" id="records">
<span id="record"></span><h2><a class="toc-backref" href="#id90">2.6&nbsp;&nbsp;&nbsp;Records</a></h2>
<p>A <a class="reference internal" href="#mumble-record-t">record</a> is a sequence of CLAUDE values in memory.</p>
<p>Both the number of the values which constitute a record, and their
various types, are determined by the context in which that record
is used.</p>
<p>As a very simple example of records in pyMumble, I'll get values
into and out of a record used to hold a co-ordinate pair. In this
case the record consists of two values and both happen to have the
same type: signed <a class="reference internal" href="#integers"><tt class="docutils literal">integers</tt></a>. I'll use the functions <tt class="docutils literal">construct</tt>
and <tt class="docutils literal">deconstruct</tt> which are fully documented in <a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a> and which basically do what I did the long
way round in the <a class="reference internal" href="#dereferencing">dereferencing</a> example above.</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyMumble</span> <span class="keyword namespace">import</span> <span class="name">objects</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">location</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="literal number integer">101</span><span class="punctuation">,</span> <span class="literal number integer">234</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">objects</span><span class="operator">.</span><span class="name">construct</span><span class="punctuation">(</span><span class="name">location</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">x</span>
<span class="operator">&lt;</span><span class="name">pyMumble</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">LP_c_ulong_Array_2</span> <span class="name builtin">object</span> <span class="name">at</span> <span class="literal number hex">0x024EA620</span><span class="operator">&gt;</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">deconstruct</span><span class="punctuation">(</span><span class="name">objects</span><span class="operator">.</span><span class="name">address_of</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">),</span> <span class="literal number integer">2</span><span class="punctuation">)</span>
<span class="punctuation">(</span><span class="literal number integer long">101L</span><span class="punctuation">,</span> <span class="literal number integer long">234L</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
</div>
<div class="section" id="arrays">
<span id="array"></span><h2><a class="toc-backref" href="#id91">2.7&nbsp;&nbsp;&nbsp;Arrays</a></h2>
<p>An <a class="reference internal" href="#mumble-array-t">array</a> is another form of sequence of CLAUDE values in memory .</p>
<p>This time the number of values is not determined by context but must
be passed as part of the array. The types of an array's members are
always the same.</p>
<p>Under the hood, arrays are implemented as <a class="reference internal" href="#records"><tt class="docutils literal">records</tt></a>. The first
member of the record is the array's length; the remaining members
are the array's values.</p>
<p>Two examples, the first in C. The macro <tt class="docutils literal">CHECK</tt> is defined in
<a class="reference external" href="../mumble/include/mumble.h">mumble.h</a>; it verifies that a library
call has returned <tt class="docutils literal">MUMBLE_RES_OK</tt>.</p>
<pre class="code cpp literal-block">
<span class="comment preproc">#define mumble_record_size(n) (offsetof(mumble_record_s, values) \
                              + (n) * sizeof(mumble_value_t))
#define mumble_array_size(n)  (offsetof(mumble_array_s, values)  \
                              + ((n)+1) * sizeof(mumble_value_t))
</span>
<span class="name">callback</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="keyword type">mumble_record_t</span><span class="punctuation">)</span><span class="name">alloca</span><span class="punctuation">(</span><span class="name">mumble_record_size</span><span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">));</span>
<span class="name">callback</span><span class="operator">-&gt;</span><span class="name">values</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">].</span><span class="name">aggregate</span><span class="punctuation">.</span><span class="name">string</span> <span class="operator">=</span> <span class="literal string">&quot;mumble_advise_condition&quot;</span><span class="punctuation">;</span>
<span class="name">callback</span><span class="operator">-&gt;</span><span class="name">values</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">].</span><span class="name">uinteger</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="keyword type">int</span><span class="punctuation">)</span><span class="name">mumble_advise_condition</span><span class="punctuation">;</span>

<span class="name">callbacks</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="keyword type">mumble_array_t</span><span class="punctuation">)</span><span class="name">alloca</span><span class="punctuation">(</span><span class="name">mumble_array_size</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">));</span>
<span class="name">callbacks</span><span class="operator">-&gt;</span><span class="name">length</span> <span class="operator">=</span> <span class="literal number integer">1</span><span class="punctuation">;</span>
<span class="name">callbacks</span><span class="operator">-&gt;</span><span class="name">values</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">].</span><span class="name">aggregate</span><span class="punctuation">.</span><span class="name">record</span> <span class="operator">=</span> <span class="name">callback</span><span class="punctuation">;</span>
<span class="name">ASSERT_OK</span> <span class="punctuation">(</span><span class="name">mumble_set_callbacks</span><span class="punctuation">((</span><span class="keyword type">mumble_handle_t</span><span class="punctuation">)</span><span class="name builtin">NULL</span><span class="punctuation">,</span> <span class="name">callbacks</span><span class="punctuation">));</span>
</pre>
<p>The second example uses pyMumble:</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">import</span> <span class="name namespace">ctypes</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyMumble</span> <span class="keyword namespace">import</span> <span class="name">objects</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">s</span> <span class="operator">=</span> <span class="name builtin">map</span><span class="punctuation">(</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">c_char_p</span><span class="punctuation">,</span> <span class="punctuation">[</span><span class="literal string">'hello'</span><span class="punctuation">,</span> <span class="literal string">'goodbye'</span><span class="punctuation">])</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">x</span> <span class="operator">=</span> <span class="name">objects</span><span class="operator">.</span><span class="name">pack</span><span class="punctuation">(</span><span class="name">s</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">x</span>
<span class="operator">&lt;</span><span class="name">pyMumble</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">LP_c_ulong_Array_3</span> <span class="name builtin">object</span> <span class="name">at</span> <span class="literal number hex">0x022B9620</span><span class="operator">&gt;</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">unwrap</span> <span class="operator">=</span> <span class="keyword">lambda</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">):</span> <span class="punctuation">(</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">cast</span><span class="punctuation">(</span><span class="name">name</span><span class="punctuation">,</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_char_p</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">value</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">unpack</span><span class="punctuation">(</span><span class="name">objects</span><span class="operator">.</span><span class="name">address_of</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">),</span> <span class="name">unwrapfun</span><span class="operator">=</span><span class="name">unwrap</span><span class="punctuation">)</span>
<span class="punctuation">[</span><span class="literal string">'hello'</span><span class="punctuation">,</span> <span class="literal string">'goodbye'</span><span class="punctuation">]</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
<p><tt class="docutils literal">Pack</tt> and <tt class="docutils literal">unpack</tt> are implemented in <a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a>, in terms of <tt class="docutils literal">construct</tt> and
<tt class="docutils literal">deconstruct</tt> above. Note that by default, <tt class="docutils literal">unpack</tt> is designed to
pass its array argument to <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> after the array's members
have been extracted; this allows the CLAUDE DLL to reclaim the memory
pointed to by the array (and by any aggregate values which it
contains). Overriding this behaviour is unlikely to be useful to you
if the array originated inside the library; once you've unpacked an
array there is no further use for it.</p>
</div>
<div class="section" id="handles">
<h2><a class="toc-backref" href="#id92">2.8&nbsp;&nbsp;&nbsp;Handles</a></h2>
<p>In CLAUDE, objects are represented by <a class="reference internal" href="#id27"><tt class="docutils literal">handles</tt></a>. Your library will
provide functions for constructing each of the various types of
object, and each of these functions will return a <tt class="docutils literal">handle</tt>.</p>
<p>In pyMumble we define classes corresponding to each of the CLAUDE object
types — these are all subclasses of <tt class="docutils literal">MumbleObject</tt> which is
defined in <a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a> — and create
instances of these classes to correspond to each new handle:</p>
<pre class="code python literal-block">
<span class="name">_objects</span> <span class="operator">=</span> <span class="punctuation">{</span><span class="literal number integer">0</span><span class="punctuation">:</span><span class="name builtin pseudo">None</span><span class="punctuation">}</span>

<span class="keyword">class</span> <span class="name class">MumbleObject</span><span class="punctuation">(</span><span class="name builtin">object</span><span class="punctuation">):</span>
    <span class="keyword">def</span> <span class="name function">__init__</span><span class="punctuation">(</span><span class="name builtin pseudo">self</span><span class="punctuation">,</span> <span class="name">handle</span><span class="punctuation">):</span>
        <span class="name">_objects</span><span class="punctuation">[</span><span class="name">handle</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name builtin pseudo">self</span>
        <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">handle</span> <span class="operator">=</span> <span class="name">handle</span>

    <span class="keyword">def</span> <span class="name function">box</span><span class="punctuation">(</span><span class="name builtin pseudo">self</span><span class="punctuation">):</span>
        <span class="keyword">return</span> <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">handle</span>

    <span class="keyword">def</span> <span class="name function">_discard</span><span class="punctuation">(</span><span class="name builtin pseudo">self</span><span class="punctuation">):</span>
        <span class="name">handle</span> <span class="operator">=</span> <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">handle</span>
        <span class="keyword">del</span> <span class="name">_objects</span><span class="punctuation">[</span><span class="name">handle</span><span class="punctuation">]</span>
        <span class="name builtin pseudo">self</span><span class="operator">.</span><span class="name">handle</span> <span class="operator">=</span> <span class="name builtin pseudo">None</span>

<span class="keyword">def</span> <span class="name function">unbox</span><span class="punctuation">(</span><span class="name">handle</span><span class="punctuation">):</span>
    <span class="keyword">return</span> <span class="name">_objects</span><span class="punctuation">[</span><span class="name">handle</span><span class="punctuation">]</span>
</pre>
<p>We can now use <a class="reference internal" href="#arrays">arrays</a>, <tt class="docutils literal">box</tt> and <tt class="docutils literal">unbox</tt> to demonstrate the use
of <a class="reference internal" href="#mumble-remove-objects"><tt class="docutils literal">mumble_remove_objects()</tt></a>:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">remove_objects</span><span class="punctuation">(</span><span class="name">objects</span><span class="punctuation">):</span>
    <span class="name">box</span> <span class="operator">=</span> <span class="keyword">lambda</span><span class="punctuation">(</span><span class="name">x</span><span class="punctuation">):</span> <span class="name">x</span><span class="operator">.</span><span class="name">box</span><span class="punctuation">()</span>
    <span class="name">invalids</span> <span class="operator">=</span> <span class="name">unpack</span><span class="punctuation">(</span><span class="name">lib</span><span class="operator">.</span><span class="name">remove_objects</span><span class="punctuation">(</span><span class="name">pack</span><span class="punctuation">(</span><span class="name">objects</span><span class="punctuation">,</span> <span class="name">box</span><span class="punctuation">)),</span> <span class="name">unbox</span><span class="punctuation">)</span>
    <span class="keyword">for</span> <span class="name">invalid</span> <span class="operator word">in</span> <span class="name">invalids</span><span class="punctuation">:</span>
        <span class="name">invalid</span><span class="operator">.</span><span class="name">_discard</span><span class="punctuation">()</span>
</pre>
<p>Note incidentally that:</p>
<ul class="simple">
<li>the array created by <tt class="docutils literal">pack</tt> is reclaimed by the Python garbage
collector; and</li>
<li>the array created by <a class="reference internal" href="#mumble-remove-objects"><tt class="docutils literal">mumble_remove_objects()</tt></a> is explicitly passed
to <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> by <tt class="docutils literal">unpack</tt>.</li>
</ul>
<p>In this example I use <tt class="docutils literal">unbox</tt> as a debugging aid. Suppose I'm faced
with the following error:</p>
<pre class="literal-block">
pyMumble.invoke.MumbleError: Wibble, with #&lt;Mumble MumbleObject
handle=0x20053748&gt;), which is not permitted.
</pre>
<p>Then <tt class="docutils literal">unbox</tt> can identify the object with handle <tt class="docutils literal">0x20053748</tt>:</p>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="name">mumble</span><span class="operator">.</span><span class="name">objects</span><span class="operator">.</span><span class="name">unbox</span><span class="punctuation">(</span><span class="literal number hex">0x20053748</span><span class="punctuation">)</span>
<span class="operator">&lt;</span><span class="name">Mumble</span> <span class="name">MumbleObject</span> <span class="name">handle</span><span class="operator">=</span><span class="literal number hex">0x20053748</span><span class="operator">&gt;</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
</div>
<div class="section" id="tests">
<h2><a class="toc-backref" href="#id93">2.9&nbsp;&nbsp;&nbsp;Tests</a></h2>
<p>Before moving on, you should conduct a test equivalent to the
following. It will ensure that the library is working, that you are
communicating with the library successfully and in particular that you
are <a class="reference internal" href="#arrays">packing</a> and unpacking arrays correctly.</p>
<p>In this test we:</p>
<ol class="arabic simple">
<li>create and record the handles of two unboxed vanilla CLAUDE <a class="reference internal" href="#mumble-new-object">objects</a>;</li>
<li>pass one of them to CLAUDE and observe that <a class="reference internal" href="#mumble-return-object"><tt class="docutils literal">mumble_return_object()</tt></a>
returns precisely the same handle;</li>
<li>pass an array containing the pair to CLAUDE and observe that
<a class="reference internal" href="#mumble-return-array"><tt class="docutils literal">mumble_return_array()</tt></a> returns an equivalent array; and</li>
<li>define an externally callable function which returns its argument,
pass this plus one of the objects to CLAUDE, and allow the library
to apply our function to that object and <a class="reference internal" href="#mumble-invoke-return-object">confirm</a> that the right
value came back to it.</li>
</ol>
<pre class="code python literal-block">
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">import</span> <span class="name namespace">ctypes</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name decorator">&#64;ctypes.WINFUNCTYPE</span><span class="punctuation">(</span><span class="name">ctypes</span><span class="operator">.</span><span class="name">c_uint</span><span class="punctuation">,</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_uint</span><span class="punctuation">)</span>
<span class="operator">...</span> <span class="keyword">def</span> <span class="name function">return_handle</span><span class="punctuation">(</span><span class="name">handle</span><span class="punctuation">):</span>
<span class="operator">...</span>   <span class="keyword">return</span> <span class="name">handle</span>
<span class="operator">...</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="keyword namespace">from</span> <span class="name namespace">pyMumble.invoke</span> <span class="keyword namespace">import</span> <span class="name">dll</span><span class="punctuation">,</span> <span class="name">void</span><span class="punctuation">,</span> <span class="name">val</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">obj_1</span> <span class="operator">=</span> <span class="name">val</span><span class="punctuation">(</span><span class="name">dll</span><span class="operator">.</span><span class="name">mumble_new_object</span><span class="punctuation">)()</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">obj_2</span> <span class="operator">=</span> <span class="name">val</span><span class="punctuation">(</span><span class="name">dll</span><span class="operator">.</span><span class="name">mumble_new_object</span><span class="punctuation">)()</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objs</span> <span class="operator">=</span> <span class="punctuation">[</span><span class="name">obj_1</span><span class="punctuation">,</span> <span class="name">obj_2</span><span class="punctuation">]</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objs</span>
<span class="punctuation">[</span><span class="literal number integer">537280600</span><span class="punctuation">,</span> <span class="literal number integer">537280728</span><span class="punctuation">]</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">val</span><span class="punctuation">(</span><span class="name">dll</span><span class="operator">.</span><span class="name">mumble_return_object</span><span class="punctuation">)(</span><span class="name">obj_1</span><span class="punctuation">)</span>
<span class="literal number integer">537280600</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">objects</span><span class="operator">.</span><span class="name">unpack</span><span class="punctuation">(</span><span class="name">val</span><span class="punctuation">(</span><span class="name">dll</span><span class="operator">.</span><span class="name">mumble_return_array</span><span class="punctuation">)(</span><span class="name">objects</span><span class="operator">.</span><span class="name">pack</span><span class="punctuation">(</span><span class="name">objs</span><span class="punctuation">)))</span>
<span class="punctuation">[</span><span class="literal number integer long">537280600L</span><span class="punctuation">,</span> <span class="literal number integer long">537280728L</span><span class="punctuation">]</span>
<span class="operator">&gt;&gt;&gt;</span> <span class="name">ctypes</span><span class="operator">.</span><span class="name">c_bool</span><span class="punctuation">(</span><span class="name">val</span><span class="punctuation">(</span><span class="name">dll</span><span class="operator">.</span><span class="name">mumble_invoke_return_object</span><span class="punctuation">)(</span><span class="name">return_handle</span><span class="punctuation">,</span> <span class="name">obj_1</span><span class="punctuation">))</span>
<span class="name">c_bool</span><span class="punctuation">(</span><span class="name builtin pseudo">True</span><span class="punctuation">)</span>
<span class="operator">&gt;&gt;&gt;</span>
</pre>
<p>See also <tt class="docutils literal">communications_test</tt> in <a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a>.</p>
</div>
<div class="section" id="reference">
<h2><a class="toc-backref" href="#id94">2.10&nbsp;&nbsp;&nbsp;Reference</a></h2>
<div class="section" id="types">
<h3>2.10.1&nbsp;&nbsp;&nbsp;Types</h3>
<p>The following types are declared in <a class="reference external" href="../mumble/include/mumble.h">mumble.h</a>.</p>
<span class="target" id="aggregate"></span><pre class="code literal-block" id="mumble-aggregate-t">
mumble_aggregate_t
</pre>
<p>An aggregate value is a string, <a class="reference internal" href="#record"><tt class="docutils literal">record</tt></a>, or <a class="reference internal" href="#array"><tt class="docutils literal">array</tt></a>. Note that
these are all pointer types.</p>
<p>The contents of any aggregate value created by your application,
passed into CLAUDE and retained there — for example, the string to
be drawn on some window's titlebar — are copied by CLAUDE before
your call returns. So you may immediately recycle the memory
associated with such values.</p>
<p>The contents of any aggregate value created within CLAUDE and passed to
your application will be retained by CLAUDE until you declare that you
have no further use for them. See the library function <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a>
for this.</p>
<pre class="code cpp literal-block">
<span class="keyword">typedef</span> <span class="keyword">union</span> <span class="keyword type">mumble_aggregate_t</span> <span class="punctuation">{</span>
  <span class="keyword type">char</span> <span class="operator">*</span><span class="name">string</span><span class="punctuation">;</span>               <span class="comment multiline">/* UTF-8 */</span>
  <span class="keyword">struct</span> <span class="name">mumble_record_s</span> <span class="operator">*</span><span class="name">record</span><span class="punctuation">;</span>
  <span class="keyword">struct</span> <span class="name">mumble_array_s</span> <span class="operator">*</span><span class="name">array</span><span class="punctuation">;</span>
<span class="punctuation">}</span> <span class="keyword type">mumble_aggregate_t</span><span class="punctuation">;</span>
</pre>
<pre class="code literal-block" id="mumble-array-t">
mumble_array_t
</pre>
<p>An <em>array</em> is the memory address of a sequence of <a class="reference internal" href="#values"><tt class="docutils literal">values</tt></a> whose
length is not known in advance. The constituent types are all the same
and are determined by context. The first item in any array is always
the number of remaining items. (If you wish to pass three items, then
the array consists of four values, the first of which is the number
3.)</p>
<p>Compare with <a class="reference internal" href="#records"><tt class="docutils literal">records</tt></a>, whose length is known in advance, but
whose constituent types need not be the same.</p>
<pre class="code cpp literal-block">
<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="name">mumble_array_s</span> <span class="operator">*</span><span class="keyword type">mumble_array_t</span><span class="punctuation">;</span>
<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="name">mumble_array_s</span> <span class="punctuation">{</span>
  <span class="keyword type">mumble_ulong_t</span> <span class="name">length</span><span class="punctuation">;</span>
  <span class="keyword type">mumble_value_t</span> <span class="name">values</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">];</span>    <span class="comment multiline">/* all the same members of mumble_value_t */</span>
<span class="punctuation">}</span> <span class="name">mumble_array_s</span><span class="punctuation">;</span>
</pre>
<span class="target" id="handle"></span><span class="target" id="id27"></span><pre class="code literal-block" id="mumble-handle-t">
mumble_handle_t
</pre>
<p>A <em>handle</em> denotes an object within the library. Each such object is
assigned a handle when CLAUDE creates it; and that handle can be used
to unambiguously reference the object.</p>
<pre class="code cpp literal-block">
<span class="keyword">typedef</span> <span class="keyword type">mumble_ulong_t</span> <span class="keyword type">mumble_handle_t</span><span class="punctuation">;</span>
</pre>
<p>Handles can only be generated by the library. When you have no further
use for a handle (i.e. when removing any object from the system) you
should call <a class="reference internal" href="#mumble-remove-objects"><tt class="docutils literal">mumble_remove_objects()</tt></a>.</p>
<span class="target" id="integer"></span><span class="target" id="integers"></span><span class="target" id="mumble-long-t"></span><pre class="code literal-block" id="mumble-ulong-t">
mumble_long_t
mumble_ulong_t
</pre>
<p>All integers are passed as one of these two types.</p>
<pre class="code cpp literal-block">
<span class="comment preproc">#include &lt;stdint.h&gt;
</span>
<span class="keyword">typedef</span> <span class="keyword type">int32_t</span> <span class="keyword type">mumble_long_t</span><span class="punctuation">;</span>
<span class="keyword">typedef</span> <span class="keyword type">uint32_t</span> <span class="keyword type">mumble_ulong_t</span><span class="punctuation">;</span>
</pre>
<pre class="code literal-block" id="mumble-res-t">
mumble_res_t
</pre>
<p>All CLAUDE functions return a value of type <tt class="docutils literal">mumble_res_t</tt>. This is an
alias for <tt class="docutils literal">int32_t</tt>:</p>
<pre class="code cpp literal-block">
<span class="keyword">typedef</span> <span class="keyword type">mumble_long_t</span> <span class="keyword type">mumble_res_t</span><span class="punctuation">;</span>

<span class="keyword">enum</span> <span class="punctuation">{</span>
  <span class="name">MUMBLE_RES_OK</span>   <span class="operator">=</span>  <span class="literal number integer">0</span><span class="punctuation">,</span>        <span class="comment multiline">/* success */</span>
  <span class="name">MUMBLE_RES_FAIL</span> <span class="operator">=</span> <span class="operator">-</span><span class="literal number integer">1</span>         <span class="comment multiline">/* failure */</span>
<span class="punctuation">};</span>
</pre>
<p>If a call into CLAUDE has failed, you should call <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a>
to find out why.</p>
<pre class="code literal-block" id="mumble-record-t">
mumble_record_t
</pre>
<p>A <em>record</em> is the memory address of a sequence of <a class="reference internal" href="#values"><tt class="docutils literal">values</tt></a> whose
length and constituent types (which need not all be the same) are
determined by the context in which it's being passed. For example, a
co-ordinate pair might be passed as a record of two integers.</p>
<p>Compare with <a class="reference internal" href="#arrays"><tt class="docutils literal">arrays</tt></a>, whose length is not known in advance, but whose
constituent types must be the same.</p>
<pre class="code cpp literal-block">
<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="name">mumble_record_s</span> <span class="operator">*</span><span class="keyword type">mumble_record_t</span><span class="punctuation">;</span>
<span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="name">mumble_record_s</span> <span class="punctuation">{</span>
  <span class="keyword type">mumble_value_t</span> <span class="name">values</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">];</span>    <span class="comment multiline">/* maybe different members of mumble_value_t */</span>
<span class="punctuation">}</span> <span class="name">mumble_record_s</span><span class="punctuation">;</span>
</pre>
<span class="target" id="values"></span><pre class="code literal-block" id="mumble-value-t">
mumble_value_t
</pre>
<p><tt class="docutils literal">mumble_value_t</tt> is a union of all other CLAUDE types. The values
passed within <a class="reference internal" href="#arrays"><tt class="docutils literal">arrays</tt></a> and <a class="reference internal" href="#records"><tt class="docutils literal">records</tt></a> are of type
<tt class="docutils literal">mumble_value_t</tt>. All values passed as arguments to library functions
are of type <tt class="docutils literal">mumble_value_t</tt> (or, for functions which return some
value in addition to the result code, <tt class="docutils literal">mumble_value_t*</tt>).</p>
<pre class="code cpp literal-block">
<span class="keyword">typedef</span> <span class="keyword">union</span> <span class="keyword type">mumble_value_t</span> <span class="punctuation">{</span>
  <span class="keyword type">mumble_ulong_t</span> <span class="name">uinteger</span><span class="punctuation">;</span>
  <span class="keyword type">mumble_long_t</span> <span class="name">integer</span><span class="punctuation">;</span>
  <span class="keyword type">mumble_handle_t</span> <span class="name">handle</span><span class="punctuation">;</span>
  <span class="keyword type">mumble_aggregate_t</span> <span class="name">aggregate</span><span class="punctuation">;</span>
<span class="punctuation">}</span> <span class="keyword type">mumble_value_t</span><span class="punctuation">;</span>
</pre>
</div>
<div class="section" id="functions">
<h3>2.10.2&nbsp;&nbsp;&nbsp;Functions</h3>
<p>The following functions are declared in <a class="reference external" href="../mumble/include/mumble.h">mumble.h</a>. For sample calls into the DLL see also
<a class="reference external" href="../mumble/examples/C/mumble.c">mumble.c</a> and <a class="reference external" href="../mumble/examples/C/test.c">test.c</a>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="51%" />
<col width="49%" />
</colgroup>
<tbody valign="top">
<tr><td><dl class="first last docutils">
<dt>Connecting and Disconnecting</dt>
<dd><a class="reference internal" href="#id29"><tt class="docutils literal">mumble_close</tt></a>                     <br />
<a class="reference internal" href="#id32"><tt class="docutils literal">mumble_init</tt></a></dd>
<dt>Error Handling</dt>
<dd><a class="reference internal" href="#id35"><tt class="docutils literal">mumble_last_error</tt></a>                <br />
<a class="reference internal" href="#id41"><tt class="docutils literal">mumble_raise_error</tt></a></dd>
<dt>CLAUDE Objects and Communication Tests</dt>
<dd><a class="reference internal" href="#id33"><tt class="docutils literal">mumble_invoke_return_object</tt></a>      <br />
<a class="reference internal" href="#id38"><tt class="docutils literal">mumble_new_object</tt></a>                <br />
<a class="reference internal" href="#id43"><tt class="docutils literal">mumble_request_error</tt></a>             <br />
<a class="reference internal" href="#id44"><tt class="docutils literal">mumble_return_array</tt></a>              <br />
<a class="reference internal" href="#id46"><tt class="docutils literal">mumble_return_object</tt></a></dd>
</dl>
</td>
<td><dl class="first last docutils">
<dt>Memory</dt>
<dd><a class="reference internal" href="#id31"><tt class="docutils literal">mumble_free</tt></a>                     <br />
<a class="reference internal" href="#id42"><tt class="docutils literal">mumble_remove_objects</tt></a>           <br /></dd>
<dt>Callbacks</dt>
<dd><a class="reference internal" href="#id48"><tt class="docutils literal">mumble_set_callbacks</tt></a></dd>
<dt>From the Command Line</dt>
<dd><a class="reference internal" href="#mumble-version"><tt class="docutils literal">mumble_version</tt></a></dd>
</dl>
</td>
</tr>
</tbody>
</table>
<pre class="code literal-block" id="id29">
<span id="mumble-close"></span>mumble_res_t mumble_close(void)
</pre>
<p>Make the CLAUDE library quit.</p>
<p>If this function is not called before your process exits, the CLAUDE
library might issue a warning message about not being unloaded cleanly
(<tt class="docutils literal">&quot;Idle process was still alive when DLL was <span class="pre">unloaded...&quot;</span></tt>).</p>
<p>See the <tt class="docutils literal">_on_exit()</tt> function in <a class="reference external" href="../mumble/pyMumble/connect.html">connect.py</a> for an example of calling this function
automatically when Python is quit, provided the DLL is initialised at
the time.</p>
<pre class="code literal-block" id="id31">
<span id="mumble-free"></span>mumble_res_t mumble_free(mumble_aggregate_t pointer)
</pre>
<p>Instruct the CLAUDE library to free the memory referenced by pointer.</p>
<p>Pointer may be any <a class="reference internal" href="#aggregate"><tt class="docutils literal">aggregate</tt></a> value which originated in the CLAUDE
library. If it references a sequence (i.e. a <a class="reference internal" href="#record"><tt class="docutils literal">record</tt></a> or
<a class="reference internal" href="#array"><tt class="docutils literal">array</tt></a>), then any aggregate values within that sequence will be
freed recursively.</p>
<p>If pointer isn't a valid reference (for instance, if it's just some
number you made up) then an <a class="reference internal" href="#error-is-signalled">error is signalled</a>.</p>
<pre class="code literal-block" id="id32">
<span id="mumble-init"></span>mumble_res_t mumble_init(void)
</pre>
<p>Initialise the CLAUDE library.</p>
<p>Calling this function is optional, in that calling any function in the
CLAUDE interface will automatically ensure that CLAUDE has been
initialised. If however you prefer to initialise the library
explicitly then you're welcome to do so.</p>
<pre class="code literal-block" id="id33">
<span id="mumble-invoke-return-object"></span>mumble_res_t mumble_invoke_return_object(bool *success,
                                         mumble_handle_t(*)(mumble_handle_t) funct,
                                         mumble_handle_t object)
</pre>
<p>Ask CLAUDE whether applying the function to the handle returns the same
handle.</p>
<p>The only conceivable purpose of this function is to allow you to
conduct <a class="reference external" href="#tests">communication tests</a> with the library while you're porting
to it. It answers the questions: are you passing function pointers
correctly? and are you successfully interpreting handles to
pre-existing objects?</p>
<p>Your function <tt class="docutils literal">funct</tt> should take one argument, a <a class="reference internal" href="#handle"><tt class="docutils literal">handle</tt></a>. It
should interpret this handle as a CLAUDE object, in whatever way is
appropriate to your application; then it should convert that object
back to a handle and return this new handle. If the application's data
model is simply to work with raw handles, then it's fine for this
function to just return its argument; doing that otherwise would be
defeating the purpose of the test.</p>
<p>CLAUDE decodes the handle argument (<tt class="docutils literal">object</tt>) into one of its own
objects. It calls the function with that object's handle. It expects
the result of this function call to be a handle which it can decode
and compare with the original object, returning true if they were the
same.</p>
<pre class="code literal-block" id="last-error">
<span id="id35"></span><span id="mumble-last-error"></span>mumble_res_t mumble_last_error(char **error_string)
</pre>
<p>Return a string describing the last error to occur within the CLAUDE
library.</p>
<p>The string consists of a brief error message possibly followed by a
verbose stack backtrace (note for Python users: with most recent call
<em>first</em>).</p>
<p>If you're getting an error you don't understand, please forward it
without delay to <a class="reference external" href="mailto:claude&#64;ravenbrook.com">claude&#64;ravenbrook.com</a> and we'll help you interpret
it if the problem was at your end, or get a fix to you if the
fault was inside CLAUDE.</p>
<p>If no error has occurred in this session, or at least none since a
previous call to <tt class="docutils literal">mumble_last_error()</tt>, then <tt class="docutils literal">mumble_last_error()</tt>
returns a null pointer.</p>
<p>When you're done with the error string you should <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a>
it.</p>
<p>See the <a class="reference external" href="#error-handling"><tt class="docutils literal">MumbleError</tt></a> Exception class in <a class="reference external" href="../mumble/pyMumble/invoke.html">invoke.py</a> for a cautious example.</p>
<pre class="code literal-block" id="id38">
<span id="mumble-new-object"></span>mumble_res_t mumble_new_object(mumble_handle_t *object)
</pre>
<p>Return the handle for a new, undifferentiated, CLAUDE object.</p>
<p>The only conceivable purpose of such an object is to allow you to
conduct <a class="reference external" href="#tests">communication tests</a> with the library while you're porting
to it. See <a class="reference internal" href="#mumble-return-object"><tt class="docutils literal">mumble_return_object()</tt></a>, <a class="reference internal" href="#mumble-return-array"><tt class="docutils literal">mumble_return_array()</tt></a> and
<a class="reference internal" href="#mumble-invoke-return-object"><tt class="docutils literal">mumble_invoke_return_object()</tt></a> for test functions, and
<tt class="docutils literal">communications_test</tt> in <a class="reference external" href="../mumble/pyMumble/objects.html">objects.py</a> for a
complete example.</p>
<p>Your library will undoubtedly export the means to create more
interesting CLAUDE objects.</p>
<p>When you're done with the object you should <a class="reference internal" href="#mumble-remove-objects"><tt class="docutils literal">mumble_remove_objects()</tt></a>
an array containing its handle.</p>
<pre class="code literal-block" id="raise-error">
<span id="id41"></span><span id="mumble-raise-error"></span>mumble_res_t mumble_raise_error(char *error_string)
</pre>
<p><a class="reference internal" href="#signal-an-error">Signal an error</a> whose report is <tt class="docutils literal">error_string</tt>. The string should
have originated in a <a class="reference internal" href="#mumble-advise-condition"><tt class="docutils literal">mumble_advise_condition</tt></a> callback; it will be
automatically passed to <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> by this call.</p>
<p>See also <a class="reference internal" href="#mumble-request-error"><tt class="docutils literal">mumble_request_error()</tt></a>.</p>
<pre class="code literal-block" id="remove-objects">
<span id="id42"></span><span id="mumble-remove-objects"></span>mumble_res_t mumble_remove_objects(mumble_array_t *result, mumble_array_t array)
</pre>
<p><em>Invalidate</em> objects within CLAUDE and permit memory to be recycled.</p>
<p><tt class="docutils literal">Array</tt> may contain any number of <a class="reference internal" href="#id27"><tt class="docutils literal">handles</tt></a> for CLAUDE objects.
Once a handle has been removed the corresponding CLAUDE object becomes
invalid: you should no longer communicate with CLAUDE about that
object and if you attempt to do so an <a class="reference internal" href="#error-will-be-signalled">error will be signalled</a>.</p>
<p><tt class="docutils literal">mumble_remove_objects()</tt> returns a new <a class="reference internal" href="#array">array</a> itemising all the
handles whose objects have been invalidated. Note that this might not
have the same contents as the array you provided (it's up to the
library to decide whether an object <em>can</em> be invalidated, and if so
whether any other objects must necessarily become invalid too). When
you're done with this second array you should <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> it.</p>
<pre class="code literal-block" id="id43">
<span id="mumble-request-error"></span>mumble_res_t mumble_request_error(mumble_handle_t object, char *error_string)
</pre>
<p>Cause an <a class="reference internal" href="#error-to-be-signalled">error to be signalled</a>. If <tt class="docutils literal">object</tt> is null the error
will come straight back (via <tt class="docutils literal">MUMBLE_RES_FAIL</tt>); if it's a window
handle then the error will occur in that window's thread; if it's any
other object then a new thread will be created and the error will
occur in that thread; in both of these two cases the
<a class="reference internal" href="#mumble-advise-condition"><tt class="docutils literal">mumble_advise_condition</tt></a> callback will be invoked.</p>
<p><tt class="docutils literal"><span class="pre">Error-string</span></tt> is any text of your choosing.</p>
<p>The only conceivable purpose of this function is to allow you to
conduct tests with the library while you're porting to it. It helps
answer the question: are you handling errors correctly?</p>
<pre class="code literal-block" id="id44">
<span id="mumble-return-array"></span>mumble_res_t mumble_return_array(mumble_array_t *result, mumble_array_t array)
</pre>
<p>Return a fresh <a class="reference internal" href="#array"><tt class="docutils literal">array</tt></a>, containing the same <a class="reference internal" href="#id27"><tt class="docutils literal">handles</tt></a> as this one.</p>
<p>The only conceivable purpose of this function is to allow you to
conduct <a class="reference external" href="#tests">communication tests</a> with the library while you're porting
to it. It answers the question: can you pack and unpack arrays
correctly?</p>
<p>The argument should be an array of handles. CLAUDE unpacks the array
to get at the handles, decodes the handles to obtain a sequence of its
own objects, and from this packs a fresh array of those objects'
handles. As with <a class="reference internal" href="#mumble-return-object"><tt class="docutils literal">mumble_return_object()</tt></a>, if <tt class="docutils literal">array</tt> isn't a valid
array or its constituent handles handles, then an <a class="reference internal" href="#error-is-signalled">error is
signalled</a>. However the onus is on the application to check that
interpreting the array as a memory address will not be problematic.</p>
<p>When you're done with the returned array you should <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a>
it.</p>
<pre class="code literal-block" id="id46">
<span id="mumble-return-object"></span>mumble_res_t mumble_return_object(mumble_handle_t *result, mumble_handle_t object)
</pre>
<p>Return the object's <a class="reference internal" href="#handle"><tt class="docutils literal">handle</tt></a>.</p>
<p>The only conceivable purpose of this function is to allow you to
conduct <a class="reference external" href="#tests">communication tests</a> with the library while you're porting
to it. It answers the question: are you recording new handles
correctly?</p>
<p>This function isn't totally trivial: CLAUDE decodes the handle into one
of its own objects and then returns that object's handle. If your
handle isn't a valid handle (for instance, if it's just some number
you made up) then CLAUDE can't process it and an <a class="reference internal" href="#error-is-signalled">error is signalled</a>.</p>
<pre class="code literal-block" id="id48">
<span id="mumble-set-callbacks"></span>mumble_res_t mumble_set_callbacks(mumble_handle_t object, mumble_array_t callbacks)
</pre>
<p>Establish callbacks in this object.</p>
<p>The <tt class="docutils literal">object</tt> argument is either the <a class="reference internal" href="#handle"><tt class="docutils literal">handle</tt></a> of an object or null;
<tt class="docutils literal">callbacks</tt> is an array of two-element records, each containing
the name of one of the <a class="reference external" href="#callbacks">documented callbacks</a> and either a function
pointer to be called when CLAUDE wants to invoke that callback, or a
null pointer to remove that callback.</p>
<p>If <tt class="docutils literal">object</tt> is null then each callback set (or removed) applies to
all objects for which that callback has not been set explicitly.</p>
<p>It is not an error for CLAUDE to attempt to invoke a callback which
isn't currently set: in this case nothing happens. If, for example, if
there were a callback called <tt class="docutils literal">mumble_frobnicated</tt> and you didn't
want that callback to do anything, you might simply choose not to set
that callback. For any callback which returns a value, the library's
documentation should state what happens if the callback isn't set.</p>
<!-- ctype `C callable function pointer` __ http://docs.python.org/2/library/ctypes.html#callback-functions -->
<pre class="code literal-block" id="mumble-version">
void mumble_version(void)
</pre>
<p><tt class="docutils literal">mumble_version</tt> is designed to be invoked only from the command
line via <tt class="docutils literal">rundll32</tt>. <strong>It should not be called from your
application.</strong></p>
<p>The command line syntax is:</p>
<pre class="literal-block">
rundll32 mumble.dll,mumble_version
</pre>
<p>The current version string is printed to stdout. The DLL will then
terminate. <tt class="docutils literal">mumble_version</tt> does not return any values.</p>
<p>For example:</p>
<pre class="literal-block">
C:\home\mumble&gt; rundll32 mumble.dll,mumble_version
Mumble, release 0.1.2
CLAUDE, release 1.0.2
C:\home\mumble&gt;
</pre>
</div>
<div class="section" id="callbacks">
<span id="callback"></span><h3>2.10.3&nbsp;&nbsp;&nbsp;Callbacks</h3>
<p>The following callback is declared in <a class="reference external" href="../mumble/include/mumble.h">mumble.h</a>. For how to set and unset callbacks,
and what happens if an unset callback is invoked, see
<a class="reference internal" href="#mumble-set-callbacks"><tt class="docutils literal">mumble_set_callbacks()</tt></a>.</p>
<pre class="code literal-block" id="mumble-advise-condition">
void mumble_advise_condition(mumble_handle_t object, char *error_string)
</pre>
<p>If an error occurs during a call to one of the <a class="reference external" href="#functions">library functions</a>
then an <a class="reference internal" href="#error-is-signalled">error is signalled</a>.</p>
<p>If an error occurs at some other time then the option of returning the
value <tt class="docutils literal">MUMBLE_RES_FAIL</tt> isn't available — there's no function
call from which to return anything. Instead, this callback is invoked.</p>
<p>If the error occurred in a thread &quot;associated&quot; with one of the
library's objects, then <tt class="docutils literal">object</tt> might be that object's handle
(otherwise <tt class="docutils literal">object</tt> is null).</p>
<p>The <tt class="docutils literal">error_string</tt> is of the same form as the reports returned by
calls to <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a>.</p>
<p>You have two choices when programming your application to receive this
callback.</p>
<ul class="simple">
<li>Deal with the <tt class="docutils literal">error_string</tt> and then <a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> it.</li>
<li>Call <a class="reference internal" href="#mumble-raise-error"><tt class="docutils literal">mumble_raise_error()</tt></a> which will turn the error over to
whatever mechanism you have for dealing with <tt class="docutils literal">MUMBLE_RES_FAIL</tt>.</li>
</ul>
<p>If this callback is not set then asynchronous errors will not be
reported to the application.</p>
</div>
</div>
</div>
<div class="section" id="internal-interface">
<h1><a class="toc-backref" href="#id95">3&nbsp;&nbsp;&nbsp;Internal Interface</a></h1>
<p>The <a class="reference external" href="#external-interface">previous section</a> covered everything that your users as
application programmers need to know about driving CLAUDE. This
section covers the same material from your point of view: that of the
author of a Common Lisp library to be exported via CLAUDE.</p>
<div class="section" id="the-claude-package">
<h2><a class="toc-backref" href="#id96">3.1&nbsp;&nbsp;&nbsp;The CLAUDE package</a></h2>
<p>The lisp symbols documented here are exported from the <tt class="docutils literal">CLAUDE</tt>
package which is defined in <a class="reference external" href="../mumble/claude/src/pkg.html">pkg.lisp</a>. Note that <tt class="docutils literal">CLAUDE</tt> shadows four
symbol names: <tt class="docutils literal">ARRAY</tt>, <tt class="docutils literal"><span class="pre">STANDARD-OBJECT</span></tt>, <tt class="docutils literal"><span class="pre">STRUCTURE-OBJECT</span></tt> and
<tt class="docutils literal">CLOSE</tt>; the first of these is also exported.</p>
<p>Your package definition might look like this:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">defpackage</span> <span class="literal string">&quot;MUMBLE&quot;</span>
  <span class="punctuation">(</span><span class="literal string symbol">:add-use-defaults</span> <span class="name constant">t</span><span class="punctuation">)</span>
  <span class="punctuation">(</span><span class="literal string symbol">:use</span> <span class="literal string">&quot;CLAUDE&quot;</span><span class="punctuation">)</span>
  <span class="punctuation">(</span><span class="literal string symbol">:shadowing-import-from</span> <span class="literal string">&quot;CLAUDE&quot;</span> <span class="literal string">&quot;ARRAY&quot;</span><span class="punctuation">))</span>
</pre>
</div>
<div class="section" id="id53">
<span id="internal-types"></span><h2><a class="toc-backref" href="#id97">3.2&nbsp;&nbsp;&nbsp;Types</a></h2>
<p>The basic types, for values which can be passed as arguments and
return values for <a class="reference external" href="#defun-external">external functions</a> and for <a class="reference external" href="#internal-callbacks">callbacks</a>, are:</p>
<ul class="simple">
<li><a class="reference internal" href="#internal-array"><tt class="docutils literal">array</tt></a></li>
<li><a class="reference internal" href="#int"><tt class="docutils literal">int</tt></a></li>
<li><a class="reference internal" href="#object"><tt class="docutils literal">object</tt></a></li>
<li><a class="reference internal" href="#internal-record"><tt class="docutils literal">record</tt></a></li>
<li><a class="reference internal" href="#uint"><tt class="docutils literal">uint</tt></a></li>
<li><a class="reference internal" href="#ustring"><tt class="docutils literal">ustring</tt></a></li>
</ul>
<p>Additionally any subtype of <a class="reference internal" href="#object"><tt class="docutils literal">object</tt></a>, as defined by
<a class="reference internal" href="#defclass-external"><tt class="docutils literal"><span class="pre">defclass-external</span></tt></a> or <a class="reference internal" href="#defstruct-external"><tt class="docutils literal"><span class="pre">defstruct-external</span></tt></a>, may be used. It is not
compulsory to specify the argument types of an external function —
they default to <tt class="docutils literal">object</tt> — or to be fully specific, but it is
recommended that you do specify as tightly as possible, so that a
runtime check can validate each value as it's <a class="reference external" href="#handles">unboxed</a>. The
result-type of an external function, unless :void, must be specified.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">new-nodes</span> <span class="literal string symbol">:result-type</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">))</span>
    <span class="punctuation">((</span><span class="name variable">graph</span> <span class="name variable">graph</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="name variable">descriptions</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name variable">record</span> <span class="punctuation">(</span><span class="name variable">ustring</span> <span class="name variable">ustring</span><span class="punctuation">)))))</span>
  <span class="operator">...</span><span class="punctuation">)</span>
</pre>
<pre class="code literal-block" id="internal-array">
(array type &amp;key call)
</pre>
<p>Externally, an <a class="reference internal" href="#array">array</a> of values of type <tt class="docutils literal">type</tt>. Internally, a list.
If <tt class="docutils literal">call</tt> is specified, it's a function which will be applied to
each member of an array which is being returned from an <a class="reference external" href="#defun-external">external
function</a> (i.e. being converted from lisp to a foreign type).</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name variable">record</span> <span class="punctuation">(</span><span class="name variable">object</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">)</span> <span class="name variable">ustring</span> <span class="name variable">ustring</span><span class="punctuation">)))</span>
</pre>
<div class="tip">
<p class="first admonition-title">Tip</p>
<p class="last">One particular use of arrays is for reducing the stack switching
overhead of making very many calls into or out of lisp, which can
otherwise become significant. I strongly recommend that wherever
possible the data for such calls should be packed into arrays and
your interface desgined so as to enforce fewer calls across the
language boundary. For example, <a class="reference external" href="http://chart.ravenbrook.com/downloads/">Chart Desktop</a> supports
<tt class="docutils literal">chart_new_nodes()</tt> rather than <tt class="docutils literal">chart_new_ node()</tt>; a simple
experiment indicates that if <tt class="docutils literal">chart_new_node()</tt> were made
available, it would generate 1000 nodes almost an order of
magnitude slower than its array counterpart.</p>
</div>
<pre class="code literal-block" id="int">
int
</pre>
<p>A signed 32-bit integer.</p>
<pre class="code literal-block" id="object">
object
(object &amp;key allow-null)
</pre>
<p>Internally, an <tt class="docutils literal">object</tt> is a value of any type defined by
<a class="reference internal" href="#defclass-external"><tt class="docutils literal"><span class="pre">defclass-external</span></tt></a> or <a class="reference internal" href="#defstruct-external"><tt class="docutils literal"><span class="pre">defstruct-external</span></tt></a>. Externally, it's
represented by a <a class="reference external" href="#handles">handle</a>. If <tt class="docutils literal"><span class="pre">allow-null</span></tt> is set then null values
are permitted too.</p>
<p>Instead of <tt class="docutils literal">object</tt>, any subtype of <tt class="docutils literal">object</tt> may be given.</p>
<pre class="code literal-block" id="internal-record">
(record types &amp;key allow-null)
</pre>
<p>Externally, a <a class="reference internal" href="#record">record</a> of values of types <tt class="docutils literal">types</tt>. Internally, a
list. If <tt class="docutils literal"><span class="pre">allow-null</span></tt> is set then a null value is permitted instead.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">record</span> <span class="punctuation">(</span><span class="name variable">node</span> <span class="punctuation">(</span><span class="name variable">record</span> <span class="punctuation">(</span><span class="name variable">int</span> <span class="name variable">int</span><span class="punctuation">)</span> <span class="literal string symbol">:allow-null</span> <span class="name constant">t</span><span class="punctuation">)))</span>
</pre>
<pre class="code literal-block" id="uint">
uint
</pre>
<p>An unsigned 32-bit integer.</p>
<pre class="code literal-block" id="ustring">
ustring
</pre>
<p>A UTF-8 encoded string.</p>
</div>
<div class="section" id="the-defining-macros">
<h2><a class="toc-backref" href="#id98">3.3&nbsp;&nbsp;&nbsp;The defining macros</a></h2>
<pre class="code literal-block" id="defstruct-external">
<span id="defclass-external"></span>(defclass-external name superclasses slots &amp;rest class-options)
(defstruct-external name-and-options &amp;rest slots)
</pre>
<p>These macros augment <tt class="docutils literal">defclass</tt> and <tt class="docutils literal">defstruct</tt> to define
<em>external</em> standard- and structure-classes. Members of these classes
can be created by the library, passed back and forth between the
library and the application, and deleted at the application's request
by (or as a side-effect of) a call to the external function
<a class="reference internal" href="#remove-objects"><tt class="docutils literal"><span class="pre">remove-objects</span></tt></a>.</p>
<pre class="code literal-block" id="defun-external">
(defun-external name-and-options arguments &amp;body body)
</pre>
<p>This macro defines an <em>external function</em>: one which can be invoked by
the external application. <tt class="docutils literal"><span class="pre">Name-and-options</span></tt> is either the
function's internal name (which will be <a class="reference external" href="#library-names">translated</a>  for external
use in the usual way), or a list matching <tt class="docutils literal">(name &amp;key <span class="pre">(result-type</span>
:void))</tt>. Each argument must be either a list of the form <tt class="docutils literal"><span class="pre">(arg-name</span>
<span class="pre">arg-type)</span></tt>, or a symbol <tt class="docutils literal"><span class="pre">arg-name</span></tt> which will be interpreted as
<tt class="docutils literal"><span class="pre">(arg-name</span> object)</tt>. The types are as described <a class="reference external" href="#internal-types">above</a>.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">new-nodes</span> <span class="literal string symbol">:result-type</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">))</span>
    <span class="punctuation">((</span><span class="name variable">graph</span> <span class="name variable">graph</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="name variable">descriptions</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name variable">record</span> <span class="punctuation">(</span><span class="name variable">ustring</span> <span class="name variable">ustring</span><span class="punctuation">)))))</span>
  <span class="punctuation">(</span><span class="name builtin">loop</span> <span class="name variable">for</span> <span class="punctuation">(</span><span class="name variable">label</span> <span class="name variable">text</span><span class="punctuation">)</span> <span class="name variable">in</span> <span class="name variable">descriptions</span> <span class="name variable">collect</span>
        <span class="punctuation">(</span><span class="name variable">make-node</span> <span class="name variable">graph</span>
                   <span class="literal string symbol">:label</span> <span class="name variable">label</span>
                   <span class="literal string symbol">:text</span> <span class="name variable">text</span><span class="punctuation">)))</span>
</pre>
<p>There is no guarantee that external functions can readily be invoked
from within lisp. For development and testing of any non-trivial
external function, you may find it best to use it as a trampoline:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name variable">complex-spong</span> <span class="punctuation">((</span><span class="name variable">things</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">thing</span><span class="punctuation">)))</span>
  <span class="punctuation">(</span><span class="name builtin">loop</span> <span class="name variable">for</span> <span class="name variable">thing</span> <span class="name variable">in</span> <span class="name variable">things</span> <span class="name builtin">do</span>
        <span class="punctuation">(</span><span class="name variable">one-complex-spong</span> <span class="name variable">thing</span><span class="punctuation">)))</span>

<span class="punctuation">(</span><span class="name builtin">defun</span> <span class="name variable">one-complex-spong</span> <span class="punctuation">(</span><span class="name variable">thing</span><span class="punctuation">)</span>
  <span class="operator">...</span><span class="punctuation">)</span>
</pre>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note that in LispWorks, it is not possible to export external
functions from a DLL without resaving the image, and so the testing
of new <tt class="docutils literal"><span class="pre">defun-external</span></tt> forms will require a restart.</p>
</div>
</div>
<div class="section" id="external-functions">
<h2><a class="toc-backref" href="#id99">3.4&nbsp;&nbsp;&nbsp;External functions</a></h2>
<p>Here are the signatures of CLAUDE's <a class="reference external" href="#defun-external">external</a> functions. (This list
is for information only; the functions' names are not exported from
the <tt class="docutils literal">CLAUDE</tt> package; see the <a class="reference external" href="#functions">external interface</a> for details of
each function.)</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name builtin">close</span> <span class="punctuation">())</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name variable">free</span> <span class="punctuation">((</span><span class="name variable">pointer</span> <span class="literal string symbol">:pointer</span><span class="punctuation">)))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name variable">init</span> <span class="punctuation">())</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">invoke-return-object</span> <span class="literal string symbol">:result-type</span> <span class="literal string symbol">:boolean</span><span class="punctuation">)</span>
    <span class="punctuation">((</span><span class="name variable">return-object</span> <span class="punctuation">(</span><span class="literal string symbol">:pointer</span> <span class="literal string symbol">:function</span><span class="punctuation">))</span> <span class="name variable">object</span><span class="punctuation">))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">last-error</span> <span class="literal string symbol">:result-type</span> <span class="name variable">ustring</span><span class="punctuation">)</span> <span class="punctuation">())</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">new-object</span> <span class="literal string symbol">:result-type</span> <span class="name variable">object</span><span class="punctuation">)</span> <span class="punctuation">())</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name variable">raise-error</span> <span class="punctuation">((</span><span class="name variable">report</span> <span class="punctuation">(</span><span class="name variable">ustring</span> <span class="literal string symbol">:free</span> <span class="name constant">t</span><span class="punctuation">))))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">remove-objects</span> <span class="literal string symbol">:result-type</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span> <span class="literal string symbol">:call</span> <span class="literal string symbol">'discard</span><span class="punctuation">))</span>
    <span class="punctuation">((</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">))))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name variable">request-error</span> <span class="punctuation">((</span><span class="name variable">object</span> <span class="punctuation">(</span><span class="name variable">object</span> <span class="literal string symbol">:allow-null</span> <span class="name constant">t</span><span class="punctuation">))</span>
                               <span class="punctuation">(</span><span class="name variable">error-string</span> <span class="name variable">ustring</span><span class="punctuation">)))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">return-array</span> <span class="literal string symbol">:result-type</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">))</span>
    <span class="punctuation">((</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">))))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">return-object</span> <span class="literal string symbol">:result-type</span> <span class="name variable">object</span><span class="punctuation">)</span> <span class="punctuation">(</span><span class="name variable">object</span><span class="punctuation">))</span>

<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="name variable">set-callbacks</span> <span class="punctuation">((</span><span class="name variable">manager</span> <span class="punctuation">(</span><span class="name variable">manager</span> <span class="literal string symbol">:allow-null</span> <span class="name constant">t</span><span class="punctuation">))</span>
                               <span class="punctuation">(</span><span class="name variable">callbacks</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name variable">record</span> <span class="punctuation">(</span><span class="name variable">ustring</span> <span class="name variable">uint</span><span class="punctuation">))))))</span>
</pre>
</div>
<div class="section" id="callback-management">
<span id="internal-callbacks"></span><h2><a class="toc-backref" href="#id100">3.5&nbsp;&nbsp;&nbsp;Callback management</a></h2>
<p><strong>This version of CLAUDE does not support the passing of arrays and records in callbacks. Please</strong>
<a class="reference external" href="mailto:claude&#64;ravenbrook.com">write to me</a> <strong>if this is a problem.</strong></p>
<pre class="code literal-block" id="invoke-callback">
(invoke-callback pattern (manager manager) callback &amp;rest arguments)
</pre>
<p>Generic function whose primary method invokes a <a class="reference external" href="#mumble-set-callbacks">named callback</a> on
<a class="reference internal" href="#manager"><tt class="docutils literal">manager</tt></a>. The callback is a symbol whose name will be <a class="reference external" href="#library-names">translated</a>
in the usual way. If no callback is defined then the method returns
<tt class="docutils literal">nil</tt>, otherwise it returns <tt class="docutils literal">t</tt> as a first value and the result of
invoking the callback as a second.</p>
<p>The pattern can take various forms. The simplest form is the expected
return type of the callback:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">invoke-callback</span> <span class="literal string symbol">:void</span> <span class="name variable">interface</span> <span class="literal string symbol">'interface-terminated</span> <span class="name variable">interface</span><span class="punctuation">)</span>

<span class="punctuation">(</span><span class="name variable">invoke-callback</span> <span class="literal string symbol">:boolean</span> <span class="name variable">interface</span> <span class="literal string symbol">'interface-terminate-requested</span> <span class="name variable">interface</span><span class="punctuation">)</span>
</pre>
<p>Alternatively <tt class="docutils literal">pattern</tt> can be a list whose first element is this
return type and whose remaining elements are either argument types or
(name type) pairs:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="keyword">let</span> <span class="punctuation">((</span><span class="name builtin">error</span> <span class="punctuation">(</span><span class="name variable">fli:pointer-address</span> <span class="punctuation">(</span><span class="name variable">to-foreign-string</span> <span class="name variable">report</span><span class="punctuation">))))</span>
  <span class="punctuation">(</span><span class="name variable">invoke-callback</span> <span class="operator">'</span><span class="punctuation">(</span><span class="literal string symbol">:void</span> <span class="punctuation">(</span><span class="name variable">interface</span> <span class="punctuation">(</span><span class="name variable">interface</span> <span class="literal string symbol">:allow-null</span> <span class="name constant">t</span><span class="punctuation">))</span> <span class="punctuation">(</span><span class="name variable">address</span> <span class="name variable">uint</span><span class="punctuation">))</span>
                   <span class="name variable">manager</span>
                   <span class="literal string symbol">'advise-condition</span>
                   <span class="punctuation">(</span><span class="name builtin">when</span> <span class="punctuation">(</span><span class="name builtin">and</span> <span class="name variable">interface</span> <span class="punctuation">(</span><span class="name variable">object-wrapper</span> <span class="name variable">interface</span><span class="punctuation">))</span> <span class="name variable">interface</span><span class="punctuation">)</span>
                   <span class="name builtin">error</span><span class="punctuation">)</span>
</pre>
<p>The arguments of the foreign funcallable which <a class="reference internal" href="#invoke-callback"><tt class="docutils literal"><span class="pre">invoke-callback</span></tt></a>
generates, where not specified explicitly, are each named after their
corresponding parameter's type.</p>
<pre class="code literal-block" id="interface">
(defclass-external interface ())
</pre>
<p><a class="reference external" href="#defclass-external">External class</a>. Any external subclass of <tt class="docutils literal">capi:interface</tt> should
also inherit from this class.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defclass-external</span> <span class="name variable">interface</span> <span class="punctuation">(</span><span class="name variable">manager</span> <span class="name variable">capi:interface</span><span class="punctuation">)</span>
  <span class="punctuation">())</span>
</pre>
<pre class="code literal-block" id="manager">
(defclass-external manager ())
</pre>
<p><a class="reference external" href="#defclass-external">External class</a>. Any object on which a callback is defined must be an
instance of a subclass of <tt class="docutils literal">manager</tt>.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">defmethod</span> <span class="name variable">interface-terminate-requested</span> <span class="punctuation">((</span><span class="name variable">interface</span> <span class="name variable">interface</span><span class="punctuation">))</span>
  <span class="punctuation">(</span><span class="name builtin">multiple-value-bind</span> <span class="punctuation">(</span><span class="name variable">callbackp</span> <span class="name variable">proceed</span><span class="punctuation">)</span>
      <span class="punctuation">(</span><span class="name variable">invoke-callback</span> <span class="literal string symbol">:boolean</span> <span class="name variable">interface</span> <span class="literal string symbol">'interface-terminate-requested</span>
                       <span class="name variable">interface</span><span class="punctuation">)</span>
    <span class="punctuation">(</span><span class="name builtin">or</span> <span class="punctuation">(</span><span class="name builtin">not</span> <span class="name variable">callbackp</span><span class="punctuation">)</span>
        <span class="name variable">proceed</span><span class="punctuation">)))</span>
</pre>
<pre class="code literal-block" id="to-foreign-string">
(to-foreign-string string)
</pre>
<p>Function: returns a foreign pointer to <tt class="docutils literal">string</tt> and ensures that
this pointer will remain valid until the application calls
<a class="reference internal" href="#mumble-free"><tt class="docutils literal">mumble_free()</tt></a> on it.</p>
</div>
<div class="section" id="memory">
<h2><a class="toc-backref" href="#id101">3.6&nbsp;&nbsp;&nbsp;Memory</a></h2>
<pre class="code literal-block" id="remove-object">
(remove-object self)
</pre>
<p>Generic function. The <a class="reference external" href="#defun-external">external</a> function <a class="reference internal" href="#remove-objects"><tt class="docutils literal"><span class="pre">remove-objects</span></tt></a> (plural!)
calls <tt class="docutils literal"><span class="pre">remove-object</span></tt> on each object in its list argument. The
applicable method on an object should decide whether to allow that
object to be invalidated, and what other objects must also be
invalidated in consequence; it should perform any side-effects
resulting from this invalidation; and it should return a list (maybe
empty) of all the objects actually to be invalidated.
<a class="reference internal" href="#remove-objects"><tt class="docutils literal"><span class="pre">remove-objects</span></tt></a> will then perform the invalidations and return to
the application the list of all objects invalidated.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">defun-external</span> <span class="punctuation">(</span><span class="name variable">remove-objects</span> <span class="literal string symbol">:result-type</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span> <span class="literal string symbol">:call</span> <span class="literal string symbol">'discard</span><span class="punctuation">))</span>
    <span class="punctuation">((</span><span class="name class">array</span> <span class="punctuation">(</span><span class="name class">array</span> <span class="name variable">object</span><span class="punctuation">)))</span>
  <span class="punctuation">(</span><span class="name builtin">remove-duplicates</span> <span class="punctuation">(</span><span class="name builtin">loop</span> <span class="name variable">for</span> <span class="name variable">object</span> <span class="name variable">in</span> <span class="name class">array</span>
                        <span class="name builtin">append</span> <span class="punctuation">(</span><span class="name variable">remove-object</span> <span class="name variable">object</span><span class="punctuation">))))</span>
</pre>
<p>Two methods on <tt class="docutils literal"><span class="pre">remove-object</span></tt> are provided, essentially equivalent to:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">defmethod</span> <span class="name variable">remove-object</span> <span class="punctuation">((</span><span class="name variable">self</span> <span class="name variable">object</span><span class="punctuation">))</span>
  <span class="punctuation">(</span><span class="name builtin">list</span> <span class="name variable">self</span><span class="punctuation">))</span>
</pre>
<p>Example:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">defmethod</span> <span class="name variable">remove-object</span> <span class="punctuation">((</span><span class="name variable">self</span> <span class="name variable">node</span><span class="punctuation">))</span>
  <span class="punctuation">(</span><span class="name builtin">prog1</span> <span class="punctuation">(</span><span class="name builtin">cons</span> <span class="name variable">self</span>
               <span class="punctuation">(</span><span class="name builtin">loop</span> <span class="name variable">for</span> <span class="name variable">edge</span> <span class="name variable">in</span> <span class="punctuation">(</span><span class="name variable">node-edges</span> <span class="name variable">self</span><span class="punctuation">)</span>
                     <span class="name builtin">append</span> <span class="punctuation">(</span><span class="name variable">remove-object</span> <span class="name variable">edge</span><span class="punctuation">)))</span>
    <span class="punctuation">(</span><span class="name variable">remove-node</span> <span class="name variable">self</span><span class="punctuation">)))</span>
</pre>
</div>
<div class="section" id="debugging-and-error-handling">
<h2><a class="toc-backref" href="#id102">3.7&nbsp;&nbsp;&nbsp;Debugging and error handling</a></h2>
<pre class="code literal-block">
(defparameter *library-version* nil)
</pre>
<p>If set, should be a string which can be used for the first line of the
<a class="reference external" href="#mumble-version">current version string</a>.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">setf</span> <span class="name variable global">*library-version*</span> <span class="literal string">&quot;Mumble, release 0.1.2&quot;</span><span class="punctuation">)</span>
</pre>
<pre class="code literal-block" id="address-string">
(address-string object)
</pre>
<p>Function: returns the immutable address string associated with
<tt class="docutils literal">object</tt>. This address is precisely the number associated with
<tt class="docutils literal">object</tt> when it is <a class="reference external" href="#handles">boxed</a>.</p>
<pre class="code common-lisp literal-block">
<span class="name variable">CL-USER</span> <span class="literal number integer">6</span> <span class="name builtin">&gt;</span> <span class="punctuation">(</span><span class="name variable">defclass-external</span> <span class="name variable">wombat</span> <span class="punctuation">()</span> <span class="punctuation">())</span>
<span class="error">#</span><span class="name variable">&lt;STANDARD-CLASS</span> <span class="name variable">WOMBAT</span> <span class="name variable">200CD00F&gt;</span>

<span class="name variable">CL-USER</span> <span class="literal number integer">7</span> <span class="name builtin">&gt;</span> <span class="punctuation">(</span><span class="name builtin">make-instance</span> <span class="literal string symbol">'wombat</span><span class="punctuation">)</span>
<span class="error">#</span><span class="name variable">&lt;Mumble</span> <span class="name variable">Wombat</span> <span class="name variable">handle=0x20053748&gt;</span>

<span class="name variable">CL-USER</span> <span class="literal number integer">8</span> <span class="name builtin">&gt;</span> <span class="punctuation">(</span><span class="name variable">address-string</span> <span class="name builtin">*</span><span class="punctuation">)</span>
<span class="literal string">&quot;0x20053748&quot;</span>

<span class="name variable">CL-USER</span> <span class="literal number integer">9</span> <span class="name builtin">&gt;</span>
</pre>
<pre class="code literal-block" id="complain">
(complain format-control &amp;rest format-arguments)
</pre>
<p>Function. A call to <tt class="docutils literal">complain</tt> is treated as an error, except that a
backtrace is not passed to the application. Call this function if the
application has made a mistake:</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">unless</span> <span class="punctuation">(</span><span class="name variable">capi-internals:interface-process</span> <span class="name variable">interface</span><span class="punctuation">)</span>
  <span class="punctuation">(</span><span class="name variable">complain</span> <span class="literal string">&quot;~a has been closed.&quot;</span> <span class="name variable">interface</span><span class="punctuation">))</span>
</pre>
<pre class="code literal-block" id="do-abort">
(do-abort key)
</pre>
<p>Function, calls <tt class="docutils literal">(abort)</tt>. The key is purely a debugging aid: you
can trace <tt class="docutils literal"><span class="pre">do-abort</span></tt> to tell where calls to <tt class="docutils literal">abort</tt> came from.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name variable">do-abort</span> <span class="literal string symbol">:handle-condition</span><span class="punctuation">)</span>
</pre>
<pre class="code literal-block" id="handle-stuff">
(handle-stuff &amp;body body)
</pre>
<p>Macro which establishes a CLAUDE-aware handler for <tt class="docutils literal">warning</tt>s and
<tt class="docutils literal"><span class="pre">serious-condition</span></tt>s. The top-level-hook of <a class="reference internal" href="#interface"><tt class="docutils literal">interface</tt></a>s uses
this. You're advised to do the same, in all the threads which your
library creates.</p>
<pre class="code common-lisp literal-block">
<span class="punctuation">(</span><span class="name builtin">defun</span> <span class="name variable">capi-top-level-hook</span> <span class="punctuation">(</span><span class="name variable">continuation</span> <span class="name variable">interface</span><span class="punctuation">)</span>
  <span class="punctuation">(</span><span class="keyword">declare</span> <span class="punctuation">(</span><span class="keyword">ignore</span> <span class="name variable">interface</span><span class="punctuation">))</span>
  <span class="punctuation">(</span><span class="name variable">handle-stuff</span>
    <span class="punctuation">(</span><span class="name builtin">funcall</span> <span class="name variable">continuation</span><span class="punctuation">)))</span>
</pre>
<pre class="code literal-block" id="object-wrapper">
(object-wrapper object)
</pre>
<p>Function, returns <tt class="docutils literal">object</tt>'s wrapper, if currently set. A useful way
to determine whether the object is currently <a class="reference external" href="#handles">boxed</a> (or, alternatively,
whether it's been deleted by <a class="reference internal" href="#remove-objects"><tt class="docutils literal"><span class="pre">remove-objects</span></tt></a>).</p>
<pre class="code literal-block" id="shift-last-error">
(shift-last-error condition)
</pre>
<p>Function, useful in error handlers. Saves a printed report of the
condition and returns the previously saved value; the condition may be
null (meaning: no condition is saved). You can retrieve this value by
calling the <a class="reference external" href="#defun-external">external</a> function <a class="reference internal" href="#last-error"><tt class="docutils literal"><span class="pre">last-error</span></tt></a> (which calls
<tt class="docutils literal"><span class="pre">(shift-last-error</span> nil)</tt>); it is set by the external function
<a class="reference internal" href="#raise-error"><tt class="docutils literal"><span class="pre">raise-error</span></tt></a>.</p>
<pre class="code literal-block" id="with-debug-env">
(with-debug-env (&amp;key warnings) &amp;body body)
</pre>
<p>Macro, binds:</p>
<ul class="simple">
<li><tt class="docutils literal">*package*</tt> to its current value,</li>
<li><tt class="docutils literal"><span class="pre">*debugger-hook*</span></tt> to a handler which calls <a class="reference internal" href="#shift-last-error"><tt class="docutils literal"><span class="pre">shift-last-error</span></tt></a>
followed by <a class="reference internal" href="#do-abort"><tt class="docutils literal"><span class="pre">do-abort</span></tt></a>, and</li>
<li>if <tt class="docutils literal">warnings</tt> is set, <tt class="docutils literal"><span class="pre">*break-on-warnings*</span></tt> to <tt class="docutils literal">t</tt>.</li>
</ul>
</div>
</div>
<div class="section" id="troubleshooting">
<h1><a class="toc-backref" href="#id103">4&nbsp;&nbsp;&nbsp;Troubleshooting</a></h1>
<p>The key message is: if something's not working and you don't
understand why, <a class="reference external" href="mailto:claude&#64;ravenbrook.com">get in touch</a>. We'll
help you interpret the problem, and get a fix to you if the fault was
inside CLAUDE.</p>
<p>Please include the <a class="reference external" href="#mumble-version">version string</a>.</p>
<ul class="simple">
<li>If you were using pyMumble and Python raised an exception, please send
us the backtrace.</li>
<li>If a call into the library returned an error code, please send us
any error string generated by <a class="reference internal" href="#mumble-last-error"><tt class="docutils literal">mumble_last_error()</tt></a>.</li>
<li>Make sure you are handling the <a class="reference internal" href="#mumble-advise-condition"><tt class="docutils literal">mumble_advise_condition</tt></a> callback,
and include any error strings arising from this.</li>
</ul>
<hr class="docutils" />
<div class="figure" id="license">
<img alt="images/lisp.jpg" src="images/lisp.jpg" />
</div>
<p><span class="copyright">CLAUDE: The Common Lisp Library Audience Expansion Toolkit</span> <br />
<span class="copyright">Copyright (c) 2009-2014, Ravenbrook Limited.</span> <br />
<span class="copyright">All rights reserved.</span></p>
<p><span class="copyright">Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:</span></p>
<blockquote>
<p><span class="copyright">Redistributions of source code must retain the above
copyright notice, this list of conditions and the following
disclaimer.</span></p>
<p><span class="copyright">Redistributions in binary form must reproduce the
above copyright notice, this list of conditions and the following
disclaimer in the documentation and/or other materials provided
with the distribution.</span></p>
</blockquote>
<p><span class="copyright">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS
OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.</span></p>
<!-- .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. .. -->
</div>
</div>
<div class="footer">
<hr class="footer" />
Generated on: 2014-05-04 06:54 UTC.

</div>
</body>

<!-- Mirrored from nicklevine.org/claude/claude-1.0.2/manual/ by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 28 Jul 2017 13:23:32 GMT -->
</html>
