<!DOCTYPE html>
<html lang="en-US" class="no-js">

<!-- Mirrored from stuartsierra.com/tag/clojure/page/3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 17:00:23 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Clojure &#8211; Page 3 &#8211; Digital Digressions by Stuart Sierra</title>
<link rel='dns-prefetch' href='http://s0.wp.com/'>
<link rel='dns-prefetch' href='http://secure.gravatar.com/'>
<link rel='dns-prefetch' href='http://fonts.googleapis.com/'>
<link rel='dns-prefetch' href='http://s.w.org/'>
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Feed" href="http://feeds2.feedburner.com/StuartSierra" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Comments Feed" href="../../../comments/feed" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Clojure Tag Feed" href="http://feeds2.feedburner.com/StuartSierra" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/stuartsierra.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='twentysixteen-jetpack-css'  href='../../../wp-content/plugins/jetpack/modules/theme-tools/compat/twentysixteen3a05.css?ver=4.2.2' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-fonts-css'  href='https://fonts.googleapis.com/css?family=Merriweather%3A400%2C700%2C900%2C400italic%2C700italic%2C900italic%7CMontserrat%3A400%2C700%7CInconsolata%3A400&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='../../../wp-content/plugins/jetpack/_inc/genericons/genericons/genericons128b.css?ver=3.1' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-style-css'  href='../../../wp-content/themes/twentysixteen/style167b.css?ver=4.6' type='text/css' media='all' />
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='jetpack_css-css'  href='../../../wp-content/plugins/jetpack/css/jetpack3a05.css?ver=4.2.2' type='text/css' media='all' />
<script type='text/javascript' src='../../../wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../../../wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://stuartsierra.com/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<link rel='https://api.w.org/' href='../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6" />

<link rel='dns-prefetch' href='http://v0.wordpress.com/'>
</head>

<body class="archive paged tag tag-clojure tag-47 paged-3 tag-paged-3 hfeed">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

		<header id="masthead" class="site-header" role="banner">
			<div class="site-header-main">
				<div class="site-branding">
					
											<p class="site-title"><a href="../../../index.html" rel="home">Digital Digressions by Stuart Sierra</a></p>
											<p class="site-description">From programming to everything else</p>
									</div><!-- .site-branding -->

									<button id="menu-toggle" class="menu-toggle">Menu</button>

					<div id="site-header-menu" class="site-header-menu">
													<nav id="site-navigation" class="main-navigation" role="navigation" aria-label="Primary Menu">
								<div class="menu-main-menu-container"><ul id="menu-main-menu" class="primary-menu"><li id="menu-item-635" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../../../about-me.html">About Me</a></li>
<li id="menu-item-633" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../../../writing.html">Writing</a></li>
<li id="menu-item-634" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../../../presentations.html">Presentations</a></li>
<li id="menu-item-636" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../../../software.html">Software</a></li>
<li id="menu-item-637" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../../../contact.html">Contact</a></li>
</ul></div>							</nav><!-- .main-navigation -->
						
											</div><!-- .site-header-menu -->
							</div><!-- .site-header-main -->

											<div class="header-image">
					<a href="../../../index.html" rel="home">
						<img src="../../../wp-content/uploads/2015/12/header.jpg" srcset="https://stuartsierra.com/wp-content/uploads/2015/12/header-300x70.jpg 300w, https://stuartsierra.com/wp-content/uploads/2015/12/header-768x179.jpg 768w, https://stuartsierra.com/wp-content/uploads/2015/12/header-1024x239.jpg 1024w, https://stuartsierra.com/wp-content/uploads/2015/12/header.jpg 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 81vw, (max-width: 1362px) 88vw, 1200px" width="1200" height="280" alt="Digital Digressions by Stuart Sierra">
					</a>
				</div><!-- .header-image -->
					</header><!-- .site-header -->

		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			<header class="page-header">
				<h1 class="page-title">Tag: Clojure</h1>			</header><!-- .page-header -->

			
<article id="post-741" class="post-741 post type-post status-publish format-standard hentry category-programming tag-clojure tag-components tag-lifecycle tag-workflow">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/09/15/lifecycle-composition.html" rel="bookmark">Lifecycle Composition</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>
I&#8217;ve been thinking about how to build up software systems out of<br />
stateful components. In past <a href="http://www.infoq.com/presentations/Clojure-Large-scale-patterns-techniques">presentations</a> and <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">blog posts</a> I&#8217;ve alluded<br />
to a standard interface I use for starting and stopping stateful<br />
components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this] <span class="org-string">"Begins operation of this component."</span>)
  (stop [this] <span class="org-string">"Ceases operation of this component."</span>))
</pre>
</div>
<p>
Most of my Clojure programs follow the same basic structure: Each<br />
subsystem or service is represented by a record which implements this<br />
protocol. At the top, there is a &#8220;system&#8221; record which contains all<br />
the other components.
</p>
<p>
I&#8217;ve gone through several versions of this protocol with the same<br />
function names but slightly different semantics.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Side Effects, Mutable State</h2>
<div class="outline-text-2" id="text-1">
<p>
In the first version, <code>start</code> and <code>stop</code> were side-effecting<br />
procedures which returned a future or promise:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Asynchronous, returns a</span>
<span class="org-string">  promise on which the caller can block to wait until the component is</span>
<span class="org-string">  started."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Asynchronous, returns a</span>
<span class="org-string">  promise on which the caller can block to wait until the component is</span>
<span class="org-string">  stopped."</span>))
</pre>
</div>
<p>
The calling code could dereference the future to block until the<br />
service had successfully started. For example, a database-access<br />
component might look like this:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">Database</span> [uri connection-atom]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (<span class="org-builtin">future</span> (<span class="org-builtin">reset!</span> connection-atom (connect uri))))
  (stop [_]
    (<span class="org-preprocessor">.close</span> @connection-atom)
    (<span class="org-builtin">future</span> (<span class="org-builtin">reset!</span> connection-atom nil))))

(<span class="org-keyword">defn</span> <span class="org-function-name">database</span> [uri]
  (-&gt;<span class="org-preprocessor">Database</span> uri (<span class="org-builtin">atom</span> nil)))
</pre>
</div>
<p>
My idea was that multiple services could be started in parallel if<br />
they didn&#8217;t depend on one another, but in practice I always ended up<br />
blocking on every call to <code>start</code>:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (<span class="org-builtin">future</span>
      @(start database)
      @(start scheduler)
      @(start web)))
  (stop [_]
    (<span class="org-builtin">future</span>
      @(stop web)
      @(stop scheduler)
      @(stop database))))

(<span class="org-keyword">defn</span> <span class="org-function-name">system</span> [database-uri]
  (<span class="org-keyword">let</span> [database (database database-uri)
        scheduler (scheduler)
        web (web-server database)]
    (-&gt;<span class="org-preprocessor">System</span> database scheduler web)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Second Attempt</h2>
<div class="outline-text-2" id="text-2">
<p>
I decided to drop the requirement to return a promise from start/stop,<br />
which meant that those functions became synchronous and had no return<br />
value:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is started."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is stopped."</span>))
</pre>
</div>
<p>
This simplified the code calling start/stop, because I didn&#8217;t have to<br />
worry about dereferencing any futures.
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (start database)
    (start scheduler)
    (start web))
  (stop [_]
    (stop web)
    (stop scheduler)
    (stop database)))
</pre>
</div>
<p>
This also made it very clear that I was using start/stop only for<br />
side-effects, forcing all of my components to contain mutable state.
</p>
<p>
Also, I had to manually place the calls to start/stop in the correct<br />
order, to ensure that components were not started before other<br />
components which depended on them.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Immutable Values</h2>
<div class="outline-text-2" id="text-3">
<p>
I decided to try to make the component objects more like immutable<br />
values by redefining start/stop to return updated versions of the<br />
components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is started. Returns an updated version of this</span>
<span class="org-string">  component."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is stopped. Returns an updated version of this</span>
<span class="org-string">  component."</span>))
</pre>
</div>
<p>
In this version, <code>start</code> and <code>stop</code> feel more like functions. They are<br />
still not <b>pure</b> functions, because they will have to execute<br />
side-effects such as connecting to a database or opening a web server<br />
port, but at least they return something meaningful.
</p>
<p>
This version has the added benefit of removing some mutable state, at<br />
the cost of making the start/stop implementations slightly more<br />
complicated. Now these functions have to return a new instance of the<br />
component record:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">Database</span> [uri connection]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">assoc</span> this <span class="org-constant">:connection</span> (connect uri)))
  (stop [this]
    (<span class="org-preprocessor">.close</span> connection)
    (<span class="org-builtin">assoc</span> this <span class="org-constant">:connection</span> nil)))

(<span class="org-keyword">defn</span> <span class="org-function-name">database</span> [uri]
  (-&gt;<span class="org-preprocessor">Database</span> uri nil))
</pre>
</div>
<p>
One interesting feature of this pattern is that the system record can<br />
<code>reduce</code> over its own keys to start/stop all the components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] start))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Keys are returned in the order they were declared.</span>
            (<span class="org-builtin">keys</span> this)))
  (stop [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] stop))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Reverse the order to stop.</span>
            (<span class="org-builtin">reverse</span> (<span class="org-builtin">keys</span> this)))))
</pre>
</div>
<p>
However, this relies on implementation behavior of Clojure records:<br />
the <code>keys</code> function will return the keys in the order they are<br />
declared in the record. I&#8217;m reluctant to rely on that undocumented<br />
behavior, so instead I&#8217;ll declare the ordering explicitly:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-function-name">component-order</span>
  [<span class="org-constant">:database</span> <span class="org-constant">:scheduler</span> <span class="org-constant">:web</span>])

(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] start))
            this
            component-order))
  (stop [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] stop))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Reverse the order to stop.</span>
            (<span class="org-builtin">reverse</span> component-order))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Dependency Order</h2>
<div class="outline-text-2" id="text-4">
<p>
I still don&#8217;t have good solution to specifying the order in which<br />
components must be started/stopped. I&#8217;ve tried building a graph of<br />
dependencies and computing the correct order. This would be similar to<br />
what <a href="https://github.com/clojure/tools.namespace">tools.namespace</a> does with namespaces. But I haven&#8217;t been able to<br />
come up with a good syntax for representing these relationships that<br />
isn&#8217;t more cumbersome than just declaring them in order.
</p>
<p>
I&#8217;ve also tried using Prismatic&#8217;s <a href="https://github.com/Prismatic/plumbing">Graph</a> library or my own <a href="https://github.com/stuartsierra/flow">Flow</a> library<br />
to define the graph of dependency relationships, but neither of those<br />
libraries can produce a structure that <b>remembers</b> the graph after it<br />
has computed its output, so I have no way to recover the dependency<br />
relationships after constructing the system object.
</p>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Dependency Injection and State</h2>
<div class="outline-text-2" id="text-5">
<p>
This technique is a form of dependency injection through constructors.<br />
The choice of whether to make the individual components mutable,<br />
stateful objects has an impact on how I can use them later on. In the<br />
original version of this pattern using mutable objects, each component<br />
gets stable references to other components it depends on. In the later<br />
version using immutable data structures, each component gets<br />
references to the <b>constructed</b> versions of other components it<br />
depends on, but not the <b>started</b> versions of those components,<br />
i.e. the values returned from <code>start</code>.
</p>
<p>
So far, this has not been a problem in the programs I write. For<br />
example, a Datomic database connection is always recoverable from the<br />
URI, so I don&#8217;t need to store it explicitly. But other components,<br />
particularly components which rely on external state to function<br />
properly, might need to be mutable so that their dependents can still<br />
use them via the references the received in their constructors. I<br />
could still have <code>start</code> and <code>stop</code> return new values, but they would<br />
also have to modify some mutable state (such as a Ref or Atom) along<br />
the way. As always, mutable objects muddy the distinction between<br />
<b>values</b> and <b>identities</b>.
</p>
<p>
I&#8217;ve also experimented with variations of <code>start</code> and <code>stop</code> that<br />
pass in other &#8220;started&#8221; components, but this was cumbersome and hard<br />
to generalize through a single interface.
</p>
<p>
So I don&#8217;t have a perfect system. It works well enough for the<br />
applications I&#8217;ve developed with it so far, and it facilitates my<br />
<a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">REPL-driven development workflow</a>, but I always have to adapt to<br />
circumstance. Eliminating mutable state is generally a good thing,<br />
but it can also be limiting, especially when you have to deal with<br />
<b>external</b> state.
</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/09/15/lifecycle-composition.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-09-15T08:37:28+00:00">September 15, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../components.html" rel="tag">components</a>, <a href="../../lifecycle.html" rel="tag">lifecycle</a>, <a href="../../workflow.html" rel="tag">workflow</a></span><span class="comments-link"><a href="../../../2013/09/15/lifecycle-composition.html#comments">7 Comments<span class="screen-reader-text"> on Lifecycle Composition</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-721" class="post-721 post type-post status-publish format-standard hentry category-programming tag-clojure tag-workflow">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/06/04/my-clojure-workflow-reloaded.html" rel="bookmark">My Clojure Workflow, Reloaded</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>I have a new post up on the Relevance blog: <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">My Clojure Workflow, Reloaded</a>. It&#8217;s a description of how I work with Clojure interactively using the REPL, <a href="https://github.com/clojure/tools.namespace">tools.namespace</a>, and <a href="http://leiningen.org/">Leiningen</a>.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/06/04/my-clojure-workflow-reloaded.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-06-04T08:14:22+00:00">June 4, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../workflow.html" rel="tag">workflow</a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-710" class="post-710 post type-post status-publish format-standard hentry category-programming tag-clojure tag-patterns tag-scope">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/03/29/perils-of-dynamic-scope.html" rel="bookmark">On the Perils of Dynamic Scope</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p><i>Common Lisp the Language</i> (CLtL) devotes an entire chapter to the subject of <a href="http://www.cs.cmu.edu/Groups/AI/html/cltl/clm/node43.html">Scope and Extent</a>. It defines <b>scope</b> as the textual region of a program in which an entity may be used, where &#8220;entity&#8221; could be a symbol, a value, or something more abstract like a variable binding.
</p>
<p>
So scope is about <i>where</i> you can use something. CLtL defines two different kinds of scope:
</p>
<p>
<b>Lexical scope</b> is usually the body of a single expression like <code>let</code> or <code>defun</code>.
</p>
<p>
<b>Indefinite scope</b> is everything else, effectively the global set of symbols that exist in a program.
</p>
<p>
In contrast, <b>extent</b> is about <i>when</i>: it&#8217;s the interval of time during which something may be used. CLtL defines two different kinds of extent:
</p>
<p>
<b>Dynamic extent</b> refers to things that exist for a fixed period of time and are explicitly &#8220;destroyed&#8221; at the end of that period, usually when control returns to the code that created the thing.
</p>
<p>
<b>Indefinite extent</b> is everything else: things that get created, passed around, and eventually garbage-collected.
</p>
<p>
In any language with a garbage collector, most things have indefinite extent. You can create strings, lists, or hash tables and pass them around with impunity. When the garbage collector determines that you are done using something, it reclaims the memory. The process is, in most cases, completely transparent to you.
</p>
<p>
But what about the so-called <b>dynamic scope</b>? The authors of CLtL have this to say:
</p>
<blockquote>
<p>The term &#8220;dynamic scope&#8221; is a misnomer. Nevertheless it is both traditional and useful.
</p>
</blockquote>
<p>
They also define &#8220;dynamic scope&#8221; to be the combination of <i>indefinite scope</i> and <i>dynamic extent</i>. That is, things with dynamic scope are valid in any <i>place</i> in a program, but only for a limited <i>time</i>. In Common Lisp, these are called &#8220;special variables,&#8221; and are created with the macros <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defpar.htm"><code>defparameter</code> and <code>defvar</code></a>.
</p>
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Vars</h2>
<div class="outline-text-2" id="text-1">
<p>
So what does this have to do with Clojure? Clojure has these things called Vars. Every time you write <code>def</code> or <code>defn</code> or one of its variants in Clojure, you&#8217;re creating a Var.
</p>
<p>
Vars have <i>indefinite scope</i>: no matter where you <code>def</code> a Var, it&#8217;s visible everywhere in the program.<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>
</p>
<p>
Vars usually have <i>indefinite extent</i> as well. Usually. This is where things get tricky. Clojure, unlike Common Lisp, was designed for multi-threaded programs.<sup><a class="footref" name="fnr.2" href="#fn.2">2</a></sup> The meaning of <i>extent</i> gets a lot muddier in the face of multiple threads. Each thread has its own timeline, its own view of &#8220;now&#8221; which may or may not conform to any other thread&#8217;s view.
</p>
<p>
In Clojure versions 1.2 and earlier, <b>all</b> Vars had dynamic scope by default, but this meant that there was a performance cost to look up the current dynamic binding of a Var on every function call. Leading up to 1.3, Rich Hickey experimented with allowing Vars to be declared <code>^:static</code>, before settling on static by default with <code>^:dynamic</code> as an option. You can still find <code>^:static</code> declarations littered through the Clojure source code. Maybe someday they&#8217;ll be useful again.
</p>
<p>
The definition of &#8220;dynamic scope&#8221; in Clojure is even fuzzier than it is in Common Lisp. How do we define &#8220;extent&#8221; in the face of multiple threads, each potentially with its own thread-local binding? If a resource can be shared across multiple threads, we have to coordinate the cleanup of that resource. For example, if I open a socket and then hand it off to another piece of code, who is responsible for closing the socket?
</p>
<p>
Resource management is one concurrency bugaboo that Clojure developers have not managed to crack. Various attempts have been made: you can see the artifacts in wiki and mailing list discussions of <a href="http://dev.clojure.org/display/design/Resource+Scopes">Resource Scopes</a>. So far, no solution has been found that doesn&#8217;t just shift the problem somewhere else.
</p>
<p>
It ends up looking a bit like garbage collection: how do I track the path of every resource used by my program and ensure that it gets cleaned up at the appropriate time? But it&#8217;s even harder than that, because resources like file handles and sockets are much scarcer than memory: they need to be reclaimed as soon as possible. In a modern runtime like the JVM, garbage collection is stochastic: there&#8217;s no guarantee that it will happen at any particular time, or even that it will happen at all.
</p>
<p>
To make matters worse, Clojure has laziness to contend with. It&#8217;s entirely possible to obtain a resource, start consuming it via a lazy sequence, and <i>never finish</i> consuming it.
</p>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">The Wrong Solution</h2>
<div class="outline-text-2" id="text-2">
<p>
This brings me to one of my top <a href="http://c2.com/cgi/wiki?AntiPattern">anti-patterns</a> in Clojure: the Dynamically-Scoped Singleton Resource (DSSR).
</p>
<p>
The DSSR is popular in libraries that depend on some external resource such as a socket, file, or database connection. It typically looks like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">ns</span> com.example.library)

(<span class="org-keyword">def</span> <span class="org-constant">^:dynamic</span> <span class="org-function-name">*resource*</span>)

(<span class="org-keyword">defn-</span> <span class="org-function-name">internal-procedure</span> []
  <span class="org-comment-delimiter">;; </span><span class="org-comment">... uses *resource* ...</span>
  )

(<span class="org-keyword">defn</span> <span class="org-function-name">public-api-function</span> [arg]
  <span class="org-comment-delimiter">;; </span><span class="org-comment">... calls internal-procedure ...</span>
  )
</pre>
<p>
That is, there is a single dynamic Var holding the &#8220;resource&#8221; on which the rest of the API operates. The DSSR is often accompanied by a <code>with-*</code> macro:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defmacro</span> <span class="org-function-name">with-resource</span> [src &amp; body]
  `(<span class="org-keyword">binding</span> [*resource* (acquire src)]
     (<span class="org-keyword">try</span> ~@body
       (<span class="org-keyword">finally</span>
         (dispose *resource*)))))
</pre>
<p>
This looks harmless enough. It&#8217;s practically a carbon copy of Clojure&#8217;s <code>with-open</code> macro, and it ensures that the resource will get cleaned up even if <code>body</code> throws an exception.
</p>
<p>
The problem with this pattern, especially in libraries, is the constraints it imposes on any code that wants to use the library. The <code>with-resource</code> macro severely constrains what you can do in the <code>body</code>:
</p>
<p>
<b>You can&#8217;t dispatch to another thread.</b> Say goodbye to Agents, Futures, thread pools, non-blocking I/O, or any other kind of asynchrony. The resource is only valid on the current thread.<sup><a class="footref" name="fnr.3" href="#fn.3">3</a></sup>
</p>
<p>
<b>You can&#8217;t return a lazy sequence</b> backed by the resource because the resource will be destroyed as soon as <code>body</code> returns.
</p>
<p>
<b>You can&#8217;t have more than one resource at a time.</b> Hence the &#8220;singleton&#8221; in the name of this pattern. Using a thread-bound Var throughout the API means that you can never operate on more than one instance of the resource in a single thread. Lots of apps need to work with multiple databases, which really sucks using this kind of library.
</p>
<p>
The last problem with this pattern is a more subtle one: <b>hidden dependencies</b>. The public API functions, which have global scope, depend on the state (thread-local binding) of another Var with global scope. This dependency isn&#8217;t explicitly stated anywhere in the definition of those functions. That might not seem like such a big deal in small examples, and it isn&#8217;t. But as programs (and development teams) grow larger, it&#8217;s one additional piece of implicit knowledge that you have to keep in your head. If there are seventeen layers of function calls between the resource binding and its usage, how certain are you going to be that the resource has the right extent?
</p>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Friends Don&#8217;t Let Friends Use Dynamic Scope</h2>
<div class="outline-text-2" id="text-3">
<p>
The alternative is easy: don&#8217;t do it. Don&#8217;t try to &#8220;solve&#8221; resource management in every library.
</p>
<p>
By all means, provide the functions to acquire and dispose of resources, but then let the application programmer decide what to do with them. Define API functions to take the resource as an argument.
</p>
<p>
Applications can manage their own resources, and only the application programmer knows what the extent of those resources should be. Maybe you can pass it around as a value. Maybe you want to use dynamic binding after all. Maybe you want to stash it in a global state Var.<sup><a class="footref" name="fnr.4" href="#fn.4">4</a></sup> That&#8217;s for you to decide.
</p>
<p>
<a href="http://datomic.com/">Datomic</a> is a good example to follow: it creates connection objects that have a lot of state attached to them &mdash; sockets, queues, and threads. But it says nothing about how you should manage the extent of those connections.<sup><a class="footref" name="fnr.5" href="#fn.5">5</a></sup> Most functions in the <a href="http://docs.datomic.com/clojure/index.html">Datomic API</a> take either a connection or a database (a value obtained from the connection) as an argument.
</p>
</div>
</div>
<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Safe Dynamic Scope</h2>
<div class="outline-text-2" id="text-4">
<p>
So dynamic scope is totally evil, right? Not totally. There are situations where dynamic scope can be helpful without causing the cascade of problems I described above.
</p>
<p>
Remember that dynamic scope in Clojure is really <i>thread-local binding</i>. Therefore, it&#8217;s best suited to operations that are <i>confined to a single thread</i>. There are plenty of examples of this: most popular algorithms are single-threaded, after all. Consider the classic <a href="http://www.cs.engr.uky.edu/~lewis/essays/compilers/rec-des.html">recursive-descent parser</a>: you start with one function call at the top and you&#8217;re not done until that function returns. The entire operation happens on a single thread, in a single call stack. It has <b>dynamic extent</b>.
</p>
<p>
I took advantage of this fact in a <a href="https://github.com/clojure/data.json">Clojure JSON parser</a>. There were a number of control flags that I needed to make available to all the functions. Rather than pass around extra arguments all over the place, I created <a href="https://github.com/clojure/data.json/blob/data.json-0.2.1/src/main/clojure/clojure/data/json.clj#L20-L22">private dynamic Vars</a> to hold them. Those Vars get <a href="https://github.com/clojure/data.json/blob/data.json-0.2.1/src/main/clojure/clojure/data/json.clj#L263-L265">bound in the entry-point</a> to the parser, based on options passed in as arguments to the public API function. The thread-local state never leaks out of the initial function call.
</p>
<p>
As another example, the Clojure compiler, although written in Java, <a href="https://github.com/clojure/clojure/blob/clojure-1.5.1/src/jvm/clojure/lang/Compiler.java#L181-L203">uses dynamic Vars</a> to keep track of internal state.
</p>
<p>
And what about our friend <code>with-open</code>? I said that the example <code>with-resource</code> macro was nearly a copy of it, but only nearly. <code>clojure.core/with-open</code> creates <b>lexical</b> (i.e. local) bindings. It still suffers from some limitations around what you can do in the body, but at least it doesn&#8217;t limit you to one resource at a time.
</p>
<p>
Global state is the zombie in the closet of every Clojure program, about which I&#8217;ll have more to say in future posts. For now, I hope I&#8217;ve convinced you that dynamic scope is easily abused and has a lot of unintended consequences.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> Technically, a Var is visible only <b>after</b> the point at which it was defined. This is significant with regard to the order of definitions, but Vars are still globally visible once they have been defined.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.2" href="#fnr.2">2</a></sup> CLtL has this note embedded in the chapter on scope and extent: &#8220;Behind the assertion that dynamic extents nest properly is the assumption that there is only a single program or process. Common Lisp does not address the problems of multiprogramming (timesharing) or multiprocessing (more than one active processor) within a single Lisp environment.&#8221; Modern Common Lisp implementations have added multi-threading, but it remains absent from the language specification.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.3" href="#fnr.3">3</a></sup> You can use <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/bound-fn">bound-fn</a> to capture the bindings and pass them to another thread, but you still have the problem that the resource may be destroyed before the other thread is finished with it.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.4" href="#fnr.4">4</a></sup> Not recommended, to be discussed in a future post.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.5" href="#fnr.5">5</a></sup> There&#8217;s some caching of connection objects under the hood, but this is not relevant to the consumer.
</p>
</div>
</div>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/03/29/perils-of-dynamic-scope.html" rel="bookmark"><time class="entry-date published" datetime="2013-03-29T08:00:52+00:00">March 29, 2013</time><time class="updated" datetime="2013-03-28T20:10:34+00:00">March 28, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../patterns.html" rel="tag">patterns</a>, <a href="../../scope.html" rel="tag">scope</a></span><span class="comments-link"><a href="../../../2013/03/29/perils-of-dynamic-scope.html#comments">11 Comments<span class="screen-reader-text"> on On the Perils of Dynamic Scope</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-693" class="post-693 post type-post status-publish format-standard hentry category-programming tag-clojure">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/02/04/affordance-concision.html" rel="bookmark">Affordance and Concision</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Quick, Clojure programmers, what does the following expression do?
</p>
<pre class="src src-clojure">(<span class="org-builtin">get</span> x k)
</pre>
<p>
If you answered, <i>It looks up the key <code>k</code> in an associative data structure <code>x</code> and returns its associated value</i>, you&#8217;re right, but only partially.
</p>
<p>
What if <code>x</code> is not an associative data structure? In every released version of Clojure up to and including 1.5.0, <code>get</code> will return <code>nil</code> in that case.
</p>
<p>
Is that a bug or a feature? It can certainly lead to some hard-to-find bugs, such as this one which I&#8217;ve often found in my own code:
</p>
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-function-name">person</span> (<span class="org-builtin">ref</span> {<span class="org-constant">:name</span> <span class="org-string">"Stuart"</span> <span class="org-constant">:job</span> <span class="org-string">"Programmer"</span>}))

(<span class="org-builtin">get</span> person <span class="org-constant">:name</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; nil</span>
</pre>
<p>
Spot the bug? <code>person</code> is not a map but rather a Ref whose state is a map. I should have written <code>(get @person :name)</code>. One character between triumph and defeat! To make matters worse, that <code>nil</code> might not show up until it triggers a NullPointerException several pages of code later.
</p>
<p>
It turns out that several core functions in Clojure behave this way: if called on an object which does not implement the correct interface, they return <code>nil</code> rather than throwing an exception.
</p>
<p>
The <code>contains?</code> function is a more bothersome example. Not only is the name difficult to remember &mdash; it&#8217;s an associative function that checks for keys, not a linear search of values like <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Collection.html#contains(java.lang.Object)">java.util.Collection#contains</a> &mdash; but it also returns <code>nil</code> on functions which do not implement <a href="https://github.com/clojure/clojure/blob/clojure-1.4.0/src/jvm/clojure/lang/Associative.java">clojure.lang.Associative</a>. Or at least it did up through Clojure 1.4.0. I submitted a <a href="https://github.com/clojure/clojure/commit/3acb6ee7ec5c295ae14de861d03a5efd115a5968">patch</a> (<a href="http://dev.clojure.org/jira/browse/CLJ-932">CLJ-932</a>), included in Clojure 1.5.0, which changed <code>contains?</code> to throw an exception instead.<a class="footref" name="fnr.1" href="#fn.1">[1]</a>
</p>
<p>
I submitted a similar patch (<a href="http://dev.clojure.org/jira/browse/CLJ-1107">CLJ-1107</a>) to do the same thing for <code>get</code>, but not in time for consideration in the 1.5.0 release.
</p>
<p>
A few weeks later, I was writing some code that looked like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">my-type</span> [x]
  (<span class="org-keyword">or</span> (<span class="org-builtin">get</span> x <span class="org-constant">:my-namespace/type</span>)
      (<span class="org-builtin">get</span> (<span class="org-builtin">meta</span> x) <span class="org-constant">:my-namespace/type</span>)
      (<span class="org-builtin">get</span> x <span class="org-constant">:type</span>)
      (clojure.core/<span class="org-builtin">type</span> x)))
</pre>
<p>
I wanted a flexible definition of &#8220;type&#8221; which worked on maps or records with different possible keys, falling back on the <code>clojure.core/type</code> function, which looks for a <code>:type</code> key in metadata before falling back to <code>clojure.core/class</code>.
</p>
<p>
Before the patch to <code>get</code> in CLJ-1107, this code works perfectly well. After the patch, it won&#8217;t. I would have to write this instead:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">my-type</span> [x]
  (<span class="org-keyword">or</span> (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:my-namespace/type</span>))
      (<span class="org-builtin">get</span> (<span class="org-builtin">meta</span> x) <span class="org-constant">:my-namespace/type</span>)
      (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:type</span>))
      (clojure.core/<span class="org-builtin">type</span> x)))
</pre>
<p>
But wait! The <code>meta</code> function also returns <code>nil</code> for objects which do not support metadata. Maybe that should be &#8220;fixed&#8221; too. Then I would have to write this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">my-type</span> [x]
  (<span class="org-keyword">or</span> (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:my-namespace/type</span>))
      (<span class="org-keyword">when</span> (<span class="org-builtin">instance?</span> x <span class="org-preprocessor">clojure.lang.IMeta</span>)
        (<span class="org-builtin">get</span> (<span class="org-builtin">meta</span> x) <span class="org-constant">:my-namespace/type</span>))
      (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:type</span>))
      (clojure.core/<span class="org-builtin">type</span> x)))
</pre>
<p>
And so on.
</p>
<p>
Every language decision means trade-offs. Clojure accepts <code>nil</code> as a logical false value in boolean contexts, like Common Lisp (and also many scripting languages). This &#8220;nil punning&#8221; enables a concise style in which <code>nil</code> stands in for an empty collection or missing data.<a class="footref" name="fnr.2" href="#fn.2">[2]</a> For example, Clojure 1.5.0 introduces two new macros <a href="https://github.com/clojure/clojure/blob/clojure-1.5.0-RC4/src/clj/clojure/core.clj#L6785-L6805"><code>some-&gt;</code> and <code>some-&gt;&gt;</code></a>, which keep evaluating expressions until one of them returns <code>nil</code>.
</p>
<p>
Is Clojure&#8217;s <code>get</code> wrong? It depends on what you think <code>get</code> should mean. If you&#8217;re a fan of more strictly-typed functional languages you might think <code>get</code> should be defined to return an instance of the <code>Maybe</code> monad:
</p>
<pre class="example">
;; made-up syntax:
get [Associative⟨K,V⟩, K] → Maybe⟨V⟩
</pre>
<p>
You can implement the <a href="http://onclojure.com/2009/03/05/a-monad-tutorial-for-clojure-programmers-part-1/">Maybe monad in Clojure</a>, but there&#8217;s less motivation to do so without the support of a static type checker. You could also argue that, since Clojure is dynamically-typed, <code>get</code> can have a more general type:
</p>
<pre class="example">
;; made-up syntax:
get [Any, Any] → Any | nil
</pre>
<p>
This latter definition is effectively the type of <code>get</code> in Clojure right now.
</p>
<p>
Which form is better is a matter of taste. What I do know is that the current behavior of <code>get</code> doesn&#8217;t give much <i>affordance</i> to a Clojure programmer, even an experienced one.<a class="footref" name="fnr.3" href="#fn.3">[3]</a>
</p>
<p>
Again, tradeoffs. Clojure&#8217;s definition of <code>get</code> is flexible but can lead to subtle bugs. The stricter version would be safer but less flexible.
</p>
<p>
An even stricter version of <code>get</code> would throw an exception if the key is not present instead of returning <code>nil</code>. Sometimes that&#8217;s what you want. The <a href="https://github.com/Datomic/simulant">Simulant testing framework</a> defines a utility function <a href="https://github.com/Datomic/simulant/blob/4d4580460a6aea917b74a923060c99dae906b3fc/src/simulant/util.clj#L23-L30"><code>getx</code></a> that does just that.
</p>
<p>
Over the past five years, Rich Hickey has gradually led Clojure in the direction of &#8220;fast but correct by default.&#8221; This is particularly evident in the <a href="http://dev.clojure.org/display/doc/Documentation+for+1.3+Numerics">numeric primitives since release 1.3.0</a>, which throw an exception on overflow (correct) but do not automatically promote from fixed- to arbitrary-precision types (slow).
</p>
<p>
I believe the change to <code>get</code> in CLJ-1107 will ultimately be more help than hindrance. But it might also be useful to have a function which retains the &#8220;more dynamic&#8221; behavior. We might call it <code>get'</code> in the manner of the auto-promoting arithmetic functions such as <code>+'</code>. Or perhaps, with some cleverness, we could define a higher order function that transforms <i>any</i> function into a function that returns <code>nil</code> when called on a type it does not support. This would be similar in spirit to <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/fnil"><code>fnil</code></a> but harder to define.<a class="footref" name="fnr.4" href="#fn.4">[4]</a>
</p>
<p><strong>Update #1:</strong> changed <code>(instance? x clojure.lang.Associative)</code> to <code>(associative? x)</code>, suggested by Luke VanderHart.</p>
<p><strong>Update #2:</strong> Some readers have pointed out that I could make <code>my-type</code>  polymorphic, thereby avoiding the conditional checks. But that would be even longer and, in my opinion, more complicated than the conditional version. The <code>get</code> function is already polymorphic, a fact which I exploited in the original definition of <code>my-type</code>. It&#8217;s a contrived example anyway, not a cogent design.</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><a class="footnum" name="fn.1" href="#fnr.1">[1]</a> We can&#8217;t do anything about the name of <code>contains?</code> without breaking a lot more code. This change, at least, is unlikely to break any code that wasn&#8217;t already broken.
</p>
<p class="footnote"><a class="footnum" name="fn.2" href="#fnr.2">[2]</a> There&#8217;s a <a href="http://www.apl.jhu.edu/~hall/lisp/Scheme-Ballad.text">cute poem about nil-punning</a> in Common Lisp versus Scheme or T.
</p>
<p class="footnote"><a class="footnum" name="fn.3" href="#fnr.3">[3]</a> I am slightly abusing the <a href="http://en.wikipedia.org/wiki/Affordance">definition of affordance</a> here, but I think it works to convey what I mean: the implementation of <code>get</code> in the Clojure runtime does not help me to write my code correctly.
</p>
<p class="footnote"><a class="footnum" name="fn.4" href="#fnr.4">[4]</a> I don&#8217;t actually know how to do it without catching <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/IllegalArgumentException.html">IllegalArgumentException</a>, which would be bad for performance and potentially too broad. Left as an exercise for the reader!
</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/02/04/affordance-concision.html" rel="bookmark"><time class="entry-date published" datetime="2013-02-04T08:28:52+00:00">February 4, 2013</time><time class="updated" datetime="2013-02-04T20:45:12+00:00">February 4, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a></span><span class="comments-link"><a href="../../../2013/02/04/affordance-concision.html#comments">3 Comments<span class="screen-reader-text"> on Affordance and Concision</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-667" class="post-667 post type-post status-publish format-standard hentry category-programming tag-clojure">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/01/01/clojure-2012-year-in-review.html" rel="bookmark">Clojure 2012 Year in Review</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>I signed off my <a href="../../../2012/01/03/clojure-2011-year-in-review.html">Clojure 2011 Year in Review</a> with the words <i>You ain&#8217;t seen nothing yet.</i> Coming back for 2012, all I can think of is <i>Wow, what a year!</i> I&#8217;m happy to say that Clojure in 2012 exceeded even my wildest dreams.
</p>
<p>
2012 was the year when Clojure grew up. It lost the squeaky voice of adolescence and gained the confident baritone of a professional language. The industry as a whole took notice, and people started making serious commitments to Clojure in both time and money.
</p>
<p>
There was so much Clojure news in 2012 that I can&#8217;t even begin to cover it all. I&#8217;m sure I&#8217;ve missed scores of important and exciting projects. But here are the ones that came to mind:
</p>
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Growth &amp; Industry Mindshare</h2>
<div class="outline-text-2" id="text-1">
<ul>
<li>
<p>The <a href="https://groups.google.com/forum/#!forum/clojure">Clojure mailing list</a> has over <b>seven thousand</b> members.</p>
</li>
<li>
<p>Chas Emerick&#8217;s <a href="http://cemerick.com/2012/08/06/results-of-the-2012-state-of-clojure-survey/">State of Clojure Survey</a> got twice as many responses as in 2011.</p>
</li>
<li>
<p>Two new mailing lists spun up, <a href="https://groups.google.com/forum/#!aboutgroup/clojure-tools">clojure-tools</a> for &#8220;Clojure toolsmiths&#8221; and <a href="https://groups.google.com/forum/#!forum/clojure-sec">clojure-sec</a> for &#8220;security issues affecting those building applications with Clojure.&#8221;</p>
</li>
<li>
<p>Clojure moved into the &#8220;Adopt&#8221; section of <a href="http://www.thoughtworks.com/articles/technology-radar-october-2012">ThoughtWorks&#8217; Technology Radar</a> in October.</p>
</li>
<li>
<p>Conferences! I hereby dub 2012 the &#8220;year of the Clojure conference.&#8221; The first ever <a href="http://clojurewest.org/news/2012/5/11/clojurewest-video-schedule.html">Clojure/West</a> took place in San Jose in March, and <a href="http://clojure-conj.org/">Clojure/conj</a> returned to Raleigh in November. London got into the Clojure conference action with <a href="http://euroclojure.com/2012/">EuroClojure</a> in May and <a href="http://skillsmatter.com/event/home/clojure-exchange-2012">Clojure eXchange</a> in December.</p>
</li>
<li>
<p>O&#8217;Reilly got into the Clojure book game with two releases: the massive <a href="http://www.clojurebook.com/">Clojure Programming</a> by Chas Emerick, Christophe Grand, and Brian Carper; and the pocket-sized <a href="http://thinkrelevance.com/blog/2012/11/29/clojurescript-up-and-running">ClojureScript: Up and Running</a> by me and Luke VanderHart (see link for a discount code valid until Feb. 1, 2013).
</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">The Language</h2>
<div class="outline-text-2" id="text-2">
<ul>
<li>
<p>Clojure contributors closed 113 <a href="http://dev.clojure.org/jira">JIRA</a> tickets on the core language (not counting duplicates).</p>
</li>
<li>
<p><a href="https://github.com/clojure/clojure/blob/clojure-1.4.0/changes.md">Clojure 1.4</a> introduced <a href="https://github.com/clojure/clojure/blob/clojure-1.4.0/changes.md#21-reader-literals">tagged literals</a>, and the <a href="https://github.com/edn-format/edn">Extensible Data Notation</a> (edn) began an independent existence, including <a href="https://github.com/edn-format/edn/wiki/Implementations">implementations</a> in <a href="https://github.com/relevance/edn-ruby">Ruby</a> and <a href="https://github.com/shaunxcode/jsedn">JavaScript</a>.</p>
</li>
<li>
<p><a href="https://github.com/clojure/clojure/blob/clojure-1.5.0-RC1/changes.md">Clojure 1.5</a> entered &#8220;release candidate&#8221; status, bringing the new <a href="http://clojure.com/blog/2012/05/08/reducers-a-library-and-model-for-collection-processing.html">reducers</a> framework and <a href="https://github.com/clojure/clojure/blob/clojure-1.5.0-RC1/changes.md#24-new-threading-macros">new threading macros</a>.
</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Software &amp; Tools</h2>
<div class="outline-text-2" id="text-3">
<ul>
<li>
<p>The big news, of course, was the release of <a href="http://www.datomic.com/">Datomic</a>, a radical new database from Rich Hickey and Relevance, in March. <a href="http://blog.datomic.com/2012/10/codeq.html">Codeq</a>, a new way to look at source code repositories, followed in October.</p>
</li>
<li>
<p><a href="http://www.lighttable.com/">Light Table</a>, a new IDE oriented towards Clojure, rocketed to over $300,000 in pledges <a href="http://www.kickstarter.com/projects/ibdknox/light-table">on Kickstarter</a> and entered the <a href="http://www.chris-granger.com/2012/05/17/light-table-is-in-yc/">Summer 2012 cohort of YCombinator</a>.</p>
</li>
<li>
<p>Speaking of tooling, what a bounty! <a href="http://leiningen.org/">Leiningen</a> got a major new version, as did <a href="https://github.com/clojure/tools.nrepl">nREPL</a> and <a href="https://github.com/clojure/tools.namespace">tools.namespace</a>. Emacs users finally escaped the Common Lisp <a href="http://common-lisp.net/project/slime/">SLIME</a> with <a href="https://github.com/kingtim/nrepl.el">nrepl.el</a>.</p>
</li>
<li>
<p>Red Hat&#8217;s <a href="http://immutant.org/">Immutant</a> became the first comprehensive application server for Clojure.</p>
</li>
<li>
<p><a href="http://clojure.com/blog/2012/01/11/announcing-clojurescript-one.html">ClojureScript One</a> demonstrated techniques for building applications in ClojureScript.
</p>
</li>
</ul>
</div>
</div>
<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Blogs and &#8216;Casts</h2>
<div class="outline-text-2" id="text-4">
<ul>
<li>
<p><a href="http://planet.clojure.in/">Planet Clojure</a> now aggregates over 400 blogs. </p>
</li>
<li>
<p>I laid out some history and motivation for the Clojure contribution process in  <a href="http://clojure.com/blog/2012/02/17/clojure-governance.html">Clojure/huh? &#8211; Clojure&#8217;s Governance and How It Got That Way</a>.</p>
</li>
<li>
<p>Chas Emerick&#8217;s <a href="http://mostlylazy.com/">Mostly Lazy</a> podcast featured <a href="http://mostlylazy.com/2012/09/21/episode-8-phil-hagelberg-empowering-userspace-in-heroku-leiningen-and-emacs/">Phil Hagelberg</a>, <a href="http://mostlylazy.com/2012/08/30/episode-7-anthony-grimes-tools-and-projects-minimum-viable-snippets/">Anthony Grimes</a>, and <a href="http://mostlylazy.com/2012/08/14/episode-6-chris-houser-clojure-surveys-getting-the-little-things-right-in-languages-yegge-rama-clojurescript-repls/">Chris Houser</a>.</p>
</li>
<li>
<p>Michael Fogus interviewed prominent Clojure community members in his &#8220;take 5&#8221; series: <a href="http://clojure.com/blog/2012/06/15/take5-anthony-grimes.html">Anthony Grimes</a>, <a href="http://clojure.com/blog/2012/06/01/take6-jim-crossley.html">Jim Crossley</a>, <a href="http://clojure.com/blog/2012/05/22/take5-colin-jones.html">Colin Jones</a>, <a href="http://clojure.com/blog/2012/04/19/take5-daniel-spiewak.html">Daniel Spiewak</a>, <a href="http://clojure.com/blog/2012/03/16/take5-baishampayan-ghose.html">Baishampayan Ghose</a>, <a href="http://clojure.com/blog/2012/02/28/take5-kevin-lynagh.html">Kevin Lynagh</a>, <a href="http://clojure.com/blog/2012/02/16/take5-william-byrd.html">William Byrd</a>, <a href="http://clojure.com/blog/2012/01/25/take4-arnoldo-molina.html">Arnoldo Jose Muller-Molina</a>, and <a href="http://clojure.com/blog/2012/01/04/take5-sam-aaron.html">Sam Aaron</a>.</p>
</li>
<li>
<p>Craig Andera launched the <a href="http://thinkrelevance.com/blog/tags/podcast">Relevance podcast</a>, where he interviewed many Clojurists such as <a href="http://thinkrelevance.com/blog/2012/12/12/timothy-baldridge-podcast-episode-022">Timothy Baldridge</a>, <a href="http://thinkrelevance.com/blog/2012/12/05/jason-rudolph-podcast-episode-021">Jason Rudolph</a>, <a href="http://thinkrelevance.com/blog/2012/10/12/rich-hickey-podcast-episode-019">Rich Hickey</a> (<a href="http://thinkrelevance.com/blog/2012/07/31/rich-hickey-podcast-episode-014">twice</a>), <a href="http://thinkrelevance.com/blog/2012/10/10/stuart-sierra-podcast-episode-018">me!</a>, <a href="http://thinkrelevance.com/blog/2012/09/22/clojure-conference-organizers-podcast-episode-015">Clojure conference organizers</a>, <a href="http://thinkrelevance.com/blog/2012/08/07/michael-fogus-podcast-episode-015">Michael Fogus</a> (<a href="http://thinkrelevance.com/blog/2012/03/28/thinkrelevance-the-podcast-episode-008-michael-fogus">twice</a>), <a href="http://thinkrelevance.com/blog/2012/04/26/thinkrelevance-the-podcast-episode-010-stu-halloway">Stuart Halloway</a>, <a href="http://thinkrelevance.com/blog/2012/04/09/thinkrelevance-the-podcast-episode-009-alan-dipert">Alan Dipert</a>, <a href="http://thinkrelevance.com/blog/2012/01/25/thinkrelevance-the-podcast-episode-004-aaron-bedra-s-valedictory">Aaron Bedra</a>, <a href="http://thinkrelevance.com/blog/2012/01/12/podcast-episode-003">Brenton Ashworth</a>, and <a href="http://thinkrelevance.com/blog/2012/01/05/podcast-episode-002">David Liebke</a>.
</p>
</li>
</ul>
<p>
&nbsp;
</p>
<p>
I have no idea what 2013 is going to bring. But if I were to venture a guess, I&#8217;d say it&#8217;s going to be a fantastic time to be working in Clojure.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/01/01/clojure-2012-year-in-review.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-01-01T17:22:55+00:00">January 1, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a></span><span class="comments-link"><a href="../../../2013/01/01/clojure-2012-year-in-review.html#comments">1 Comment<span class="screen-reader-text"> on Clojure 2012 Year in Review</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-659" class="post-659 post type-post status-publish format-standard hentry category-programming tag-clojure">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2012/09/12/when-to-write-a-macro.html" rel="bookmark">When (Not) to Write a Macro</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">The Solution in Search of a Problem</h2>
<div class="outline-text-2" id="text-1">
<p>
A few months ago I wrote an article called <a href="../../../2012/05/16/syntactic-pipelines.html">Syntactic Pipelines</a>, about a style of programming (in Clojure) in which each function takes and returns a map with similar structure:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">subprocess-one</span> [data]
  (<span class="org-builtin">let</span> [{<span class="org-constant">:keys</span> [alpha beta]} data]
    (<span class="org-builtin">-&gt;</span> data
        (<span class="org-variable-name">assoc</span> <span class="org-constant">:epsilon</span> (compute-epsilon alpha))
        (<span class="org-variable-name">update-in</span> [<span class="org-constant">:gamma</span>] merge (compute-gamma beta)))))

<span class="org-comment-delimiter">;; </span><span class="org-comment">...</span>

(<span class="org-keyword">defn</span> <span class="org-function-name">large-process</span> [input]
  (<span class="org-builtin">-&gt;</span> input
      subprocess-one
      subprocess-two
      subprocess-three))
</pre>
<p>
In that article, I defined a pair of macros that allow the preceding example to be written like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defpipe</span> <span class="org-function-name">subprocess-one</span> [alpha beta]
  (return (<span class="org-constant">:set</span> <span class="org-constant">:epsilon</span> (compute-epsilon alpha))
          (<span class="org-constant">:update</span> <span class="org-constant">:gamma</span> merge (compute-gamma beta))))

(<span class="org-keyword">defpipeline</span> <span class="org-function-name">large-process</span>
  subprocess-one
  subprocess-two
  subprocess-three)
</pre>
<p>
I wanted to demonstrate the possibilities of using macros to build abstractions out of common syntactic patterns. My example, however, was poorly chosen.
</p>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">The Problem with the Solution</h2>
<div class="outline-text-2" id="text-2">
<p>
Every choice we make while programming has an associated cost. In the case of macros, that cost is usually borne by the person reading or maintaining the code.
</p>
<p>
In the case of <code>defpipe</code>, the poor sap stuck maintaining my code (maybe my future self!) has to know that it defines a function that takes a single map argument, despite the fact that it <i>looks</i> like a function that takes multiple arguments. That&#8217;s readily apparent if you read the docstring, but the docstring still has to be read and understood before the code makes sense.
</p>
<p>
The <code>return</code> macro is even worse. First of all, the fact that <code>return</code> is only usable within <code>defpipe</code> hints at some hidden coupling between the two, which is exactly what it is. Secondly, the word <i>return</i> is commonly understood to mean an immediate exit from a function. Clojure does not support non-tail function returns, and my macro does not add them, so the name <code>return</code> is confusing.
</p>
<p>
Using <code>return</code> correctly requires that the user first understand the <code>defpipe</code> macro, then understand the &#8220;mini language&#8221; I have created in the body of <code>return</code>, and also know that <code>return</code> only works in tail position inside of <code>defpipe</code>.
</p>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Is it Worth It?</h2>
<div class="outline-text-2" id="text-3">
<p>
Confusion, lack of clarity, and time spent reading docs: Those are the costs. The benefits are comparatively meager. Using the macros, my example is shorter by a couple of lines, one <code>let</code>, and some destructuring.
</p>
<p>
In short, the costs outweigh the benefits. Code using the <code>defpipe</code> macro is actually <i>worse</i> than code without the macro because it requires more effort to read. That&#8217;s not to say that the pipeline pattern I&#8217;ve described isn&#8217;t useful: It is. But my macros haven&#8217;t improved on that pattern enough to be worth their cost.
</p>
<p>
That&#8217;s the crux of the argument about macros. Whenever you think about writing one, ask yourself, &#8220;Is it worth it?&#8221; Is the benefit provided by the macro &ndash; in brevity, clarity, or power &ndash; worth the cost, in time, for you or someone else to understand it later? If the answer is anything but a resounding &#8220;yes&#8221; then you probably shouldn&#8217;t be writing a macro.
</p>
<p>
Of course, the same question can (and should) be asked of any code we write. Macros are a special case because they are so powerful that the cost of maintaining them is higher than that of &#8220;normal&#8221; code. Functions and values have semantics that are specified by the language and universally understood; macros can define their own languages. Buyer beware.
</p>
<p>
I still got some value out of the original post as an intellectual exercise, but it&#8217;s not something I&#8217;m going to put to use in my production code.
</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2012/09/12/when-to-write-a-macro.html" rel="bookmark"><time class="entry-date published" datetime="2012-09-12T08:15:18+00:00">September 12, 2012</time><time class="updated" datetime="2013-03-27T20:07:09+00:00">March 27, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a></span><span class="comments-link"><a href="../../../2012/09/12/when-to-write-a-macro.html#comments">2 Comments<span class="screen-reader-text"> on When (Not) to Write a Macro</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-629" class="post-629 post type-post status-publish format-standard hentry category-programming tag-clojure tag-clojurescript tag-javascript">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2012/06/16/why-im-using-clojurescript.html" rel="bookmark">Why I&#8217;m Using ClojureScript</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Elise Huard wrote about <a href="http://jabberwocky.eu/2012/06/16/why-im-not-using-clojurescript/">why she&#8217;s not using ClojureScript</a>. To quote her essential point, <em>&#8220;The browser doesn&#8217;t speak clojure, it speaks javascript.&#8221;</em>
</p>
<p>
This is true. But the CPU doesn&#8217;t speak Clojure either, or JavaScript. This argument against ClojureScript is similar to arguments made against any high-level language which compiles down to a lower-level representation. Once upon a time, I feel sure, the same argument was made against FORTRAN.
</p>
<p>
A new high-level language has to overcome a period of skepticism from those who are already comfortable programming in the lower-level representation. A young compiler struggles to produce code as efficient as that hand-optimized by an expert. But compilers tend to get better over time, and some smart folks are working hard on <a href="http://www.50ply.com/cljs-bench/">making ClojureScript fast</a>. ClojureScript applications can get the benefit of improvements in the compiler without changing their source code, just as Clojure applications benefit from years of JVM optimizations.
</p>
<p>
To address Huard&#8217;s other points in order:
</p>
<p>
<i>1. Compiled ClojureScript code is hard to read, therefore hard to debug.</i>
</p>
<p>
This has not been an issue for me. In development mode (no optimizations, with pretty-printing) ClojureScript compiles to JavaScript which is, in my opinion, fairly readable. Admittedly, I know Clojure much better than I know JavaScript. The greater challenge for me has been working with the highly-dynamic nature of JavaScript execution in the browser. For example, a function called with the wrong number of arguments will not trigger an immediate error. Perhaps ClojureScript can evolve to catch more of these errors at compile time.
</p>
<p>
<em>2. ClojureScript forces the inclusion of the <a href="https://developers.google.com/closure/library/">Google Closure Library</a>.</em>
</p>
<p>
This is mitigated by the <a href="https://developers.google.com/closure/compiler/">Google Closure Compiler</a>&#8216;s dead-code elimination and aggressive space optimizations. You only pay, in download size, for what you use. For example, <a href="http://code.jquery.com/jquery-1.7.2.min.js">jQuery 1.7.2</a> is 33K, minified and gzipped. <a href="http://samsaffron.com/archive/2012/02/17/stop-paying-your-jquery-tax">Caching doesn&#8217;t always save you</a>. &#8220;Hello World&#8221; in ClojureScript, optimized and gzipped, is 18K.
</p>
<p>
<i>3. Hand-tuning performance is harder in a higher-level language.</i>
</p>
<p>
This is true, as per my comments above about high-level languages. Again, this has not been an issue for me, but you can always &#8220;drop down&#8221; to JavaScript for specialized optimizations.
</p>
<p>
<i>4. Cross-browser compatibility is hard.</i>
</p>
<p>
This is, as Huard admits, unavoidable in any language. The Google Closure Libraries help with some of the basics, and ClojureScript libraries such as <a href="https://github.com/levand/domina">Domina</a> are evolving to deal with other browser-compatibility issues. You also have the entire world of JavaScript libraries to paper over browser incompatibilities.
</p>
<p style="text-align:center">* * *</p>
<p>
Overall, I think I would agree with Elise Huard when it comes to browser programming &#8220;in the small.&#8221; If you just want to add some dynamic behavior to an HTML form, then ClojureScript has little advantage over straight JavaScript, jQuery, and whatever other libraries you favor.
</p>
<p>
What ClojureScript allows you to do is tackle browser-based programming &#8220;in the large.&#8221; I&#8217;ve found it quite rewarding to develop entire applications in ClojureScript, something I would have been reluctant to attempt in JavaScript.
</p>
<p>
It&#8217;s partially a matter of taste and familiarity. Clojure programmers such as myself will likely prefer ClojureScript over JavaScript. Experienced JavaScript programmers will have less to gain &mdash; and more work to do, learning a new language &mdash; by adopting ClojureScript. JavaScript is indeed &#8220;good enough&#8221; for a lot of applications, which means ClojureScript has to work even harder to prove its worth. I still believe that ClojureScript has an edge over JavaScript in the long run, but that edge will be less immediately obvious than the advantage that, say, Clojure on the JVM has over Java.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2012/06/16/why-im-using-clojurescript.html" rel="bookmark"><time class="entry-date published updated" datetime="2012-06-16T17:36:15+00:00">June 16, 2012</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../clojurescript.html" rel="tag">ClojureScript</a>, <a href="../../javascript.html" rel="tag">JavaScript</a></span><span class="comments-link"><a href="../../../2012/06/16/why-im-using-clojurescript.html#comments">4 Comments<span class="screen-reader-text"> on Why I&#8217;m Using ClojureScript</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-624" class="post-624 post type-post status-publish format-standard hentry category-programming tag-clojure tag-macros">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2012/05/16/syntactic-pipelines.html" rel="bookmark">Syntactic Pipelines</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<style type="text/css">
  .org-constant {
     color: purple;
  }</p>
<p>  .org-string {
     color: green;
  }</p>
<p>  .org-comment {
     color: darkred;
  }</p>
<p>  .org-comment-delimiter {
     color: darkred;
  }</p>
<p>  .org-keyword, .org-builtin, .org-variable-name {
     color: blue;
  }
  </style>
<p>
Lately I&#8217;ve been thinking about Clojure programs written in this &#8220;threaded&#8221; or &#8220;pipelined&#8221; style:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">large-process</span> [input]
  (<span class="org-builtin">-&gt;</span> input
      subprocess-one
      subprocess-two
      subprocess-three))
</pre>
<p>
If you saw my talk at Clojure/West (<a href="http://clojurewest.org/news/2012/5/11/clojurewest-video-schedule.html">video forthcoming</a>) this should look familiar. The value being &#8220;threaded&#8221; by the <code>-&gt;</code> macro from one <i>subprocess-</i> function to the next is usually a map, and each subprocess can add, remove, or update keys in the map. A typical subprocess function might look something like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">subprocess-two</span> [data]
  (<span class="org-builtin">let</span> [{<span class="org-constant">:keys</span> [alpha beta]} data]
    (<span class="org-builtin">-&gt;</span> data
        (<span class="org-variable-name">assoc</span> <span class="org-constant">:epsilon</span> (compute-epsilon alpha))
        (<span class="org-variable-name">update-in</span> [<span class="org-constant">:gamma</span>] merge (compute-gamma beta)))))
</pre>
<p>
Most subprocess functions, therefore, have a similar structure: they begin by destructuring the input map and end by performing updates to that same map.
</p>
<p>
This style of programming tends to produce slightly longer code than would be obtained by writing larger functions with <code>let</code> bindings for intermediate values, but it has some advantages. The structure is immediately apparent: someone reading the code can get a high-level overview of what the code does simply by looking at the outer-most function, which, due to the single-pass design of Clojure&#8217;s compiler, will always be at the bottom of a file. It&#8217;s also easy to insert new functions into the process: as long as they accept and return a map with the same structure, they will not interfere with the existing functions.
</p>
<p>
The only problem with this code from a readability standpoint is the visual clutter of repeatedly destructuring and updating the same map. (It&#8217;s possible to move the destructuring into the function argument vector, but it&#8217;s still messy.)
</p>
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">defpipe</h2>
<div class="outline-text-2" id="text-1">
<p>
What if we could clean up the syntax without changing the behavior? That&#8217;s exactly what macros are good for. Here&#8217;s a first attempt:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defmacro</span> <span class="org-function-name">defpipe</span> [name argv &amp; body]
  `(<span class="org-keyword">defn</span> <span class="org-function-name">~name</span> [arg#]
     (<span class="org-builtin">let</span> [{<span class="org-constant">:keys</span> ~argv} arg#]
       ~@body)))
</pre>
<pre class="src src-clojure">(<span class="org-variable-name">macroexpand-1</span> '(<span class="org-keyword">defpipe</span> <span class="org-function-name">foo</span> [a b c] ...))
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (clojure.core/defn foo [arg_47_auto]</span>
<span class="org-comment-delimiter">;;     </span><span class="org-comment">(clojure.core/let [{:keys [a b c]} arg_47_auto] ...))</span>
</pre>
<p>
That doesn&#8217;t quite work: we&#8217;ve eliminated the <code>:keys</code> destructuring, but lost the original input map.
</p>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">return</h2>
<div class="outline-text-2" id="text-2">
<p>
What if we make a second macro specifically for updating the input map?
</p>
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-constant">^:private</span> <span class="org-function-name">pipe-arg</span> (<span class="org-variable-name">gensym</span> <span class="org-string">"pipeline-argument"</span>))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">defpipe</span> [name argv &amp; body]
  `(<span class="org-keyword">defn</span> <span class="org-function-name">~name</span> [~pipe-arg]
     (<span class="org-builtin">let</span> [{<span class="org-constant">:keys</span> ~argv} ~pipe-arg]
       ~@body)))

(<span class="org-keyword">defn-</span> <span class="org-function-name">return-clause</span> [spec]
  (<span class="org-builtin">let</span> [[command sym &amp; body] spec]
    (<span class="org-builtin">case</span> command
      <span class="org-constant">:update</span> `(<span class="org-variable-name">update-in</span> [~(<span class="org-variable-name">keyword</span> (<span class="org-variable-name">name</span> sym))] ~@body)
      <span class="org-constant">:set</span>    `(<span class="org-variable-name">assoc</span> ~(<span class="org-variable-name">keyword</span> (<span class="org-variable-name">name</span> sym)) ~@body)
      <span class="org-constant">:remove</span> `(<span class="org-variable-name">dissoc</span> ~(<span class="org-variable-name">keyword</span> (<span class="org-variable-name">name</span> sym)) ~@body)
      body)))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">return</span> [&amp; specs]
  `(<span class="org-builtin">-&gt;</span> ~pipe-arg
       ~@(<span class="org-variable-name">map</span> return-clause specs)))
</pre>
<p>
This requires some more explanation. The <code>return</code> macro works in tandem with <code>defpipe</code>, and provides a mini-language for threading the input map through a series of transformations. So it can be used like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defpipe</span> <span class="org-function-name">foo</span> [a b]
  (return (<span class="org-constant">:update</span> a + 10)
          (<span class="org-constant">:remove</span> b)
          (<span class="org-constant">:set</span> c a)))

<span class="org-comment-delimiter">;; </span><span class="org-comment">which expands to:</span>
(<span class="org-keyword">defn</span> <span class="org-function-name">foo</span> [input]
  (<span class="org-builtin">let</span> [{<span class="org-constant">:keys</span> [a b]} input]
    (<span class="org-builtin">-&gt;</span> input
        (<span class="org-variable-name">update-in</span> [<span class="org-constant">:a</span>] + 10)
        (<span class="org-variable-name">dissoc</span> <span class="org-constant">:b</span>)
        (<span class="org-variable-name">assoc</span> <span class="org-constant">:c</span> a))))
</pre>
<p>
As a fallback, we can put any old expression inside the <code>return</code>, and it will be just as if we had used it in the <code>-&gt;</code> macro. The rest of the code inside <code>defpipe</code>, before <code>return</code>, is a normal function body. The <code>return</code> can appear anywhere inside <code>defpipe</code>, as long as it is in tail position.
</p>
<p>
The symbol used for the input argument has to be the same in both <code>defpipe</code> and <code>return</code>, so we define it once and use it again. This is safe because that symbol is not exposed anywhere else, and the <code>gensym</code> ensures that it is unique.
</p>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">defpipeline</h2>
<div class="outline-text-2" id="text-3">
<p>
Now that we have the <code>defpipe</code> macro, it&#8217;s trivial to add another macro for defining the composition of functions created with <code>defpipe</code>:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defmacro</span> <span class="org-function-name">defpipeline</span> [name &amp; body]
  `(<span class="org-keyword">defn</span> <span class="org-function-name">~name</span> [arg#]
     (<span class="org-builtin">-&gt;</span> arg# ~@body)))
</pre>
<p>
This macro does so little that I debated whether or not to include it. The only thing it eliminates is the argument name. But I like the way it expresses intent: a pipeline is purely the composition of <code>defpipe</code> functions.
</p>
</div>
</div>
<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Further Possibilities</h2>
<div class="outline-text-2" id="text-4">
<p>
One flaw in the &#8220;pipeline&#8221; style is that it cannot express conditional logic in the middle of a pipeline. Some might say this is a feature: the whole point of the pipeline is that it defines a single thread of execution. But I&#8217;m toying with the idea of adding syntax for predicate dispatch within a pipeline, something like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defpipeline</span> <span class="org-function-name">name</span>
  pipe1
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Map signifies a conditional branch:</span>
  {predicate-a pipe-a
   predicate-b pipe-b
   <span class="org-constant">:else</span>       pipe-c}
  <span class="org-comment-delimiter">;; </span><span class="org-comment">Regular pipeline execution follows:</span>
  pipe2
  pipe3)
</pre>
</div>
</div>
<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">The Whole Shebang</h2>
<div class="outline-text-2" id="text-5">
<p>
The complete implementation follows. I&#8217;ve added doc strings, metadata, and some helper functions to parse the arguments to <code>defpipe</code> and <code>defpipeline</code> in the same style as <code>defn</code>.
</p>
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-constant">^:private</span> <span class="org-function-name">pipe-arg</span> (<span class="org-variable-name">gensym</span> <span class="org-string">"pipeline-argument"</span>))

(<span class="org-keyword">defn-</span> <span class="org-function-name">req</span>
  <span class="org-doc">"Required argument"</span>
  [pred spec message]
  (<span class="org-variable-name">assert</span> (pred (<span class="org-variable-name">first</span> spec))
          (<span class="org-variable-name">str</span> message <span class="org-string">" : "</span> (<span class="org-variable-name">pr-str</span> (<span class="org-variable-name">first</span> spec))))
  [(<span class="org-variable-name">first</span> spec) (<span class="org-variable-name">rest</span> spec)])

(<span class="org-keyword">defn-</span> <span class="org-function-name">opt</span>
  <span class="org-doc">"Optional argument"</span>
  [pred spec]
  (<span class="org-builtin">if</span> (pred (<span class="org-variable-name">first</span> spec))
    [(<span class="org-variable-name">list</span> (<span class="org-variable-name">first</span> spec)) (<span class="org-variable-name">rest</span> spec)]
    [nil spec]))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">defpipeline</span> [name &amp; spec]
  (<span class="org-builtin">let</span> [[docstring spec] (opt string? spec)
        [attr-map spec] (opt map? spec)]
    `(<span class="org-keyword">defn</span> <span class="org-function-name">~name</span> 
       ~@docstring
       ~@attr-map
       [arg#]
       (<span class="org-builtin">-&gt;</span> arg# ~@spec))))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">defpipe</span>
  <span class="org-doc">"Defines a function which takes one argument, a map. The params are</span>
<span class="org-doc">  symbols, which will be bound to values from the map as by :keys</span>
<span class="org-doc">  destructuring. In any tail position of the body, use the 'return'</span>
<span class="org-doc">  macro to update and return the input map."</span>
  [name &amp; spec]
  {<span class="org-constant">:arglists</span> '([name doc-string? attr-map? [params*] &amp; body])}
  (<span class="org-builtin">let</span> [[docstring spec] (opt string? spec)
        [attr-map spec] (opt map? spec)
        [argv spec] (req vector? spec <span class="org-string">"Should be a vector"</span>)]
    (<span class="org-variable-name">assert</span> (<span class="org-variable-name">every?</span> symbol? argv)
            (<span class="org-variable-name">str</span> <span class="org-string">"Should be a vector of symbols : "</span>
                 (<span class="org-variable-name">pr-str</span> argv)))
    `(<span class="org-keyword">defn</span> <span class="org-function-name">~name</span>
       ~@docstring
       ~@attr-map
       [~pipe-arg]
       (<span class="org-builtin">let</span> [{<span class="org-constant">:keys</span> ~argv} ~pipe-arg]
         ~@spec))))

(<span class="org-keyword">defn-</span> <span class="org-function-name">return-clause</span> [spec]
  (<span class="org-builtin">let</span> [[command sym &amp; body] spec]
    (<span class="org-builtin">case</span> command
      <span class="org-constant">:update</span> `(<span class="org-variable-name">update-in</span> [~(<span class="org-variable-name">keyword</span> (<span class="org-variable-name">name</span> sym))] ~@body)
      <span class="org-constant">:set</span>    `(<span class="org-variable-name">assoc</span> ~(<span class="org-variable-name">keyword</span> (<span class="org-variable-name">name</span> sym)) ~@body)
      <span class="org-constant">:remove</span> `(<span class="org-variable-name">dissoc</span> ~(<span class="org-variable-name">keyword</span> (<span class="org-variable-name">name</span> sym)) ~@body)
      body)))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">return</span>
  <span class="org-doc">"Within the body of the defpipe macro, returns the input argument of</span>
<span class="org-doc">  the defpipe function. Must be in tail position. The input argument,</span>
<span class="org-doc">  a map, is threaded through exprs as by the -&gt; macro.</span>

<span class="org-doc">  Expressions within the 'return' macro may take one of the following</span>
<span class="org-doc">  forms:</span>

<span class="org-doc">      (:set key value)      ; like (assoc :key value)</span>
<span class="org-doc">      (:remove key)         ; like (dissoc :key)</span>
<span class="org-doc">      (:update key f args*) ; like (update-in [:key] f args*)</span>

<span class="org-doc">  Optionally, any other expression may be used: the input map will be</span>
<span class="org-doc">  inserted as its first argument."</span>
  [&amp; exprs]
  `(<span class="org-builtin">-&gt;</span> ~pipe-arg
       ~@(<span class="org-variable-name">map</span> return-clause exprs)))
</pre>
</div>
</div>
<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">And a Made-Up Example</h2>
<div class="outline-text-2" id="text-6">
<pre class="src src-clojure">(<span class="org-keyword">defpipe</span> <span class="org-function-name">setup</span> []
  (return  <span class="org-comment-delimiter">; </span><span class="org-comment">imagine these come from a database</span>
   (<span class="org-constant">:set</span> alpha 4)
   (<span class="org-constant">:set</span> beta 3)))

(<span class="org-keyword">defpipe</span> <span class="org-function-name">compute-step1</span> [alpha beta]
  (return (<span class="org-variable-name">:set</span> delta (<span class="org-variable-name">+</span> alpha beta))))

(<span class="org-keyword">defpipe</span> <span class="org-function-name">compute-step2</span> [delta]
  (return
   (<span class="org-variable-name">assoc-in</span> [<span class="org-constant">:x</span> <span class="org-constant">:y</span>] 42)  <span class="org-comment-delimiter">; </span><span class="org-comment">ordinary function expression</span>
   (<span class="org-constant">:update</span> delta * 2)
   (<span class="org-constant">:set</span> gamma (<span class="org-variable-name">+</span> delta 100))))  <span class="org-comment-delimiter">; </span><span class="org-comment">uses old value of delta</span>

(<span class="org-keyword">defpipe</span> <span class="org-function-name">respond</span> [alpha beta gamma delta]
  (<span class="org-variable-name">println</span> <span class="org-string">" Alpha is"</span> alpha <span class="org-string">"\n"</span>
           <span class="org-string">"Beta is"</span> beta <span class="org-string">"\n"</span>
           <span class="org-string">"Delta is"</span> delta <span class="org-string">"\n"</span>
           <span class="org-string">"Gamma is"</span> gamma)
  (return)) <span class="org-comment-delimiter">; </span><span class="org-comment">not strictly necessary, but a good idea</span>

(<span class="org-keyword">defpipeline</span> <span class="org-function-name">compute</span>
  compute-step1
  compute-step2)

(<span class="org-keyword">defpipeline</span> <span class="org-function-name">process-request</span>
  setup
  compute
  respond)
</pre>
<pre class="src src-clojure">(process-request {})

<span class="org-comment-delimiter">;; </span><span class="org-comment">Alpha is 4 </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Beta is 3 </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Delta is 14 </span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Gamma is 107</span>

<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; {:gamma 107, :delta 14, :beta 3, :alpha 4}</span>
</pre>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2012/05/16/syntactic-pipelines.html" rel="bookmark"><time class="entry-date published" datetime="2012-05-16T17:42:41+00:00">May 16, 2012</time><time class="updated" datetime="2012-05-17T09:46:27+00:00">May 17, 2012</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../macros.html" rel="tag">macros</a></span><span class="comments-link"><a href="../../../2012/05/16/syntactic-pipelines.html#comments">14 Comments<span class="screen-reader-text"> on Syntactic Pipelines</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-607" class="post-607 post type-post status-publish format-standard hentry category-programming tag-clojure">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2012/01/03/clojure-2011-year-in-review.html" rel="bookmark">Clojure 2011 Year in Review</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>A new year is upon us. Before the world ends, let&#8217;s take a look back at what 2011 meant for everybody&#8217;s favorite programming language:
</p>
<ul>
<li>
<p><a href="https://groups.google.com/d/msg/clojure/w5Nmx5rPaQs/-Kl4dvGApP0J">Clojure 1.3.0 was released</a>, bringing better performance to numeric applications, reader syntax for record types, and <a href="https://github.com/clojure/clojure/blob/1.3.x/changes.txt">other enhancements</a>.</p>
</li>
<li>
<p><a href="http://clojure.com/blog/2011/07/22/introducing-clojurescript.html">ClojureScript was unveiled</a> to the world, leading to universal confusion about how to pronounce &#8220;Clojure&#8221; differently from &#8220;Closure.&#8221;</p>
</li>
<li>
<p>The <a href="http://clojure-conj.org/">second Clojure/conj</a> went off without a hitch but <a href="http://overtone.github.com/">plenty of bang</a>.</p>
</li>
<li>
<p><a href="http://clojure.com/blog/2011/12/05/lojic-part-one.html">Logic programming</a> burst into the mindspace of Clojure developers with <a href="http://clojure.com/blog/2011/12/08/lojic-part-two.html">core.logic</a>.</p>
</li>
<li>
<p><a href="http://dev.clojure.org/display/doc/Clojure+Contrib">Clojure-contrib was completely restructured</a> to support new libraries, a distributed development model, and an automated release process.</p>
</li>
<li>
<p><a href="https://groups.google.com/d/msg/clojure/QZGmfWFsgoo/XbqpUy5wuqYJ">ClojureCLR got a new home</a> and recognition as a Clojure sub-project.</p>
</li>
<li>
<p>David Liebke <a href="http://clojure.com/blog/2011/11/29/avout.html">introduced Avout</a>, an extension of Clojure&#8217;s software transactional memory model to distributed computing.</p>
</li>
<li>
<p>Clojure project management tools <a href="http://groups.google.com/group/leiningen/browse_thread/thread/5a79d02198a91b91">Leiningen and Cake</a> decided to bury the hatchet and join forces for the greater good.</p>
</li>
<li>
<p><a href="http://clojure.com/blog/">Clojure/core started blogging</a> more regularly.</p>
</li>
<li>
<p>Books! <a href="http://www.manning.com/fogus/">The Joy of Clojure</a> and <a href="http://www.manning.com/rathore/">Clojure in Action</a> (both from Manning) hit the bookshelves. The <a href="http://pragprog.com/book/shcloj2/programming-clojure">Second Edition of Programming Clojure</a> (Pragmatic) and <a href="http://shop.oreilly.com/product/0636920013754.do">Clojure Programming</a> (O&#8217;Reilly) went into early release.</p>
</li>
<li>
<p>PragPub magazine <a href="http://pragprog.com/magazines/2011-07/content">dedicated their July 2011 issue to Clojure</a>.</p>
</li>
<li>
<p>Chas Emerick released <a href="http://www.clojureatlas.com/">Clojure Atlas</a>, an interactive documentation system.</p>
</li>
<li>
<p>Clojure creator <a href="http://www.infoq.com/presentations/Simple-Made-Easy">Rich Hickey spoke at Strange Loop</a> and caused a minor tweet-storm.</p>
</li>
<li>
<p><a href="https://www.4clojure.com/">4Clojure</a> entered the world, giving thousands of programmers a new way to kill time and learn Clojure.</p>
</li>
</ul>
<p>
At this point, I&#8217;ve been typing and looking up links for an hour, so I&#8217;m calling it quits. Needless to say, this was a big year for Clojure, and I&#8217;m sure there&#8217;s a ton of stuff that I missed on this list. Regarding 2012, all I can say is, <i>You ain&#8217;t seen nothing yet</i>.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2012/01/03/clojure-2011-year-in-review.html" rel="bookmark"><time class="entry-date published" datetime="2012-01-03T08:00:15+00:00">January 3, 2012</time><time class="updated" datetime="2012-01-03T11:56:37+00:00">January 3, 2012</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a></span><span class="comments-link"><a href="../../../2012/01/03/clojure-2011-year-in-review.html#comments">5 Comments<span class="screen-reader-text"> on Clojure 2011 Year in Review</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-589" class="post-589 post type-post status-publish format-standard hentry category-programming tag-clojure tag-metaprogramming">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2011/12/19/what-is-a-program.html" rel="bookmark">What Is a Program?</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>What is a program? Is it the source code that a programmer typed? The physical state of the machine on which it is run? Or something more abstract, like the data structures it creates? This is not a purely philosophical question: it has consequences for how programming languages are designed, how development tools work, and what programmers do when we go to work every day.</p>
<p>How much information can we determine about a program <em>without</em> evaluating it? At the high end, we have the Halting Problem: for any Turing-complete programming language, we cannot determine if a given program written in that language will terminate. At the low end, consider an easier problem: can we determine the names of all of the invokable functions/procedures/methods in a given program? In a language in which functions are not first-class entities, such as C or Java, this is generally easy, because every function must have a specific lexical representation in source code. If we can parse the source code, we can find all the functions. At the other extreme, finding all function names in a language like Ruby is nearly impossible in the face of <code>method_missing</code>, <code>define_method</code>, and other &#8220;metaprogramming&#8221; tricks.</p>
<p>Again, these decisions have consequences. Ruby code is flexible and concise, but it&#8217;s hard to parse: <a href="https://github.com/ruby/ruby/blob/ruby_1_9_2/parse.y">ten thousand lines of YACC at last count</a>. I find that documentation generated from Ruby source code tends to be harder to read &mdash; and less useful &mdash; than JavaDoc. </p>
<p>Here&#8217;s another example: can I determine, without evaluating it, what other functions a given function calls? In Java this is easy. In C it&#8217;s much harder, because of the preprocessor. To build a complete call graph of a C function, we need to run the preprocessor first, in effect evaluating some of the code. In Ruby &mdash; Ha! Looking at a random piece of Ruby code, I sometimes have trouble distinguishing method calls from local variables. Again because of <code>method_missing</code>, I&#8217;m not sure it&#8217;s even possible to distinguish the two without evaluating the code.</p>
<p>I do not want to argue that <code>method_missing</code>, macros, and other metaprogramming tools in programming languages are bad. But they do make secondary tooling harder. The idea for this blog post came into my head after observing the following Twitter conversation:</p>
<blockquote>
<p><a href="https://twitter.com/#!/darevay/status/148235645083594753">Dave Ray</a>: &#8220;seesaw.core is 3500 lines of which probably 2500 are docstrings. I wonder if they could be externalized somehow&#8230;&#8221;</p>
<p><a href="https://twitter.com/#!/cemerick/status/148428056082649088">Chas Emerick</a>: &#8220;Put your docs in another file you load at the *end* of seesaw.core, w/ a bunch of <code>(alter-meta! #'f assoc :doc "docs")</code> exprs&#8221;</p>
<p><a href="https://twitter.com/#!/IORayne/status/148506007188946945">Anthony Grimes</a>: &#8220;I hate both of your guts for even thinking about doing this.&#8221;</p>
<p><a href="https://twitter.com/#!/cemerick/status/148519643101933568">Chas Emerick</a>: &#8220;Oh! [Anthony] is miffed b/c Marginalia doesn&#8217;t load namespaces it&#8217;s generating docs for. What was the rationale for that?&#8221;</p>
<p><a href="https://twitter.com/#!/fogus/status/148522300252237824">Michael Fogus</a>: &#8220;patches welcomed.&#8221;</p>
<p><a href="https://twitter.com/#!/cemerick/status/148522784451076098">Chas Emerick</a>: &#8220;Heh, sure. I&#8217;m just wondering if avoiding loading was intentional, i.e. in case someone has a (launch-missiles) top-level.&#8221;</p>
</blockquote>
<p>(As an aside, it&#8217;s hard to link to a Twitter conversation instead of individual tweets.)</p>
<p>Clojure &mdash; or any Lisp, really &mdash; exemplifies a tension between tools that operate on source code and tools that operate on the running state of a program. For any code-analysis task one might want to automate in Clojure, there are two possible approaches. One is to <code>read</code> the source as a sequence of data structures and analyze it. After all, in a Lisp, code is data. The other approach is to <code>eval</code> the source and analyze the state it generates.</p>
<p>For example, suppose I wanted to determine the names of all invokable functions in a Clojure program. I could write a program that scanned the source looking for forms beginning with <code>defn</code>, or I could evaluate the code and use introspection functions to search for all Vars in all namespaces whose values are functions. Which method is &#8220;correct&#8221; depends on the goal. </p>
<p>Michael Fogus wrote <a href="http://fogus.me/fun/marginalia/">Marginalia</a>, a documentation tool for Clojure which takes the first approach. Marginalia was inspired by Literate Programming, which advocates writing source code as a human-readable document, so the unevaluated &#8220;text&#8221; of the program is what it deals with. In contrast, Tom Faulhaber&#8217;s <a href="http://tomfaulhaber.github.com/autodoc/">Autodoc</a> for Clojure takes the second approach: loading code and then examining namespaces and Vars. Autodoc <em>has</em> to work this way to produce documentation for the core Clojure API: many functions in <code>core.clj</code> are defined before documentation strings are available, so their doc strings are loaded later from separate files. (As an alternative, those core functions could be rewritten in standard syntax after the language has been bootstrapped.)</p>
<p>One of the talking-point features of any Lisp is &#8220;all of the language, all of the time.&#8221; All features of the language are always available in any context: macros give access to the entire runtime of the language at compile time, and <code>eval</code> gives access to the entire compiler at runtime. These are a powerful tools for developers, but they make both the compiler and the runtime more complicated. ClojureScript, on the other hand, does not have <code>eval</code> and its macros are written in a different language (Clojure). These choices were deliberate because ClojureScript was designed to be compiled into compressed JavaScript to run on resource-constrained platforms, but I think it also made the ClojureScript compiler easier to write.</p>
<p>Chas&#8217;s last point about code at the top-level comes up often in discussions around Clojure tooling. The fact that we can write arbitrary code anywhere in a Clojure source file &mdash; <code>launch-missiles</code> being the popular example &mdash; means we can never be sure that evaluating a source file is free of side effects. But <em>not</em> evaluating the source means we can never be sure that we have an accurate model of what the code does. Welcome back to the Halting Problem.</p>
<p>Furthermore, maintaining all the metadata associated with a dynamic runtime &mdash; namespaces, Vars, doc strings, etc. &mdash; has measurable costs in performance and (especially) memory. If Clojure is ever to be successful on resource-constrained devices like phones, it will need the ability to produce compiled code that omits most or all of that metadata. At the same time, developers accustomed to the &#8220;creature comforts&#8221; of modern IDEs will continue to clamor for even more metadata. Fortunately, this isn&#8217;t a zero-sum game. ClojureScript proves that Clojure-the-language can work without some of those features, and there have been discussions around <a href="http://dev.clojure.org/display/design/Make+the+ClojureScript+analyzer+independently+callable+a+la+carte">making the ClojureScript analyzer more general</a> and implementing <a href="http://dev.clojure.org/display/design/Build+Profiles">targeted build profiles for Clojure</a>. But I don&#8217;t think we&#8217;ll ever have a perfect resolution of the conflict between tooling and optimization. Programs are ideas, and source code is only one representation among many. To understand a program, one needs to build a mental representation of how it operates. And to do that we&#8217;re stuck with the oldest tool we have, our brains.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2011/12/19/what-is-a-program.html" rel="bookmark"><time class="entry-date published" datetime="2011-12-19T08:45:08+00:00">December 19, 2011</time><time class="updated" datetime="2011-12-18T21:53:42+00:00">December 18, 2011</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../metaprogramming.html" rel="tag">metaprogramming</a></span><span class="comments-link"><a href="../../../2011/12/19/what-is-a-program.html#comments">2 Comments<span class="screen-reader-text"> on What Is a Program?</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

	<nav class="navigation pagination" role="navigation">
		<h2 class="screen-reader-text">Posts navigation</h2>
		<div class="nav-links"><a class="prev page-numbers" href="2.html">Previous page</a>
<a class='page-numbers' href='../index.html'><span class="meta-nav screen-reader-text">Page </span>1</a>
<a class='page-numbers' href='2.html'><span class="meta-nav screen-reader-text">Page </span>2</a>
<span class='page-numbers current'><span class="meta-nav screen-reader-text">Page </span>3</span>
<a class='page-numbers' href='4.html'><span class="meta-nav screen-reader-text">Page </span>4</a>
<span class="page-numbers dots">&hellip;</span>
<a class='page-numbers' href='7.html'><span class="meta-nav screen-reader-text">Page </span>7</a>
<a class="next page-numbers" href="4.html">Next page</a></div>
	</nav>
		</main><!-- .site-main -->
	</div><!-- .content-area -->


	<aside id="secondary" class="sidebar widget-area" role="complementary">
		<section id="search-3" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://stuartsierra.com/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
	</label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">Search</span></button>
</form>
</section><section id="text-4" class="widget widget_text">			<div class="textwidget"><ul>
<li><a href="http://feeds2.feedburner.com/StuartSierra" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="../../../comments/feed" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
</ul>
<ul>
<li><a href="https://twitter.com/stuartsierra">Twitter</a></li>
<li><a href="https://github.com/stuartsierra">GitHub</a></li>
</ul></div>
		</section><section id="tag-widget-2" class="widget TagWidget"><h2 class="widget-title">Clojure Do’s and Don’ts</h2><ul class = "posts-by-tag-list"><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-883"><a class = "posts-by-tag-item-title" href="../../../2015/08/25/clojure-donts-lazy-effects.html">Clojure Don’ts: Lazy Effects</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-877"><a class = "posts-by-tag-item-title" href="../../../2015/08/10/clojure-donts-redundant-map.html">Clojure Don’ts: Redundant map</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-870"><a class = "posts-by-tag-item-title" href="../../../2015/06/16/clojure-donts-single-branch-if.html">Clojure Don’ts: Single-branch if</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-854"><a class = "posts-by-tag-item-title" href="../../../2015/06/10/clojure-donts-heisenparameter.html">Clojure Don’ts: The Heisenparameter</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-849"><a class = "posts-by-tag-item-title" href="../../../2015/06/01/clojure-donts-optional-arguments-with-varargs.html">Clojure Don’ts: Optional Arguments with Varargs</a></li><li class="posts-by-tag-item Clojure do's and don'ts errors" id="posts-by-tag-item-836"><a class = "posts-by-tag-item-title" href="../../../2015/05/27/clojure-uncaught-exceptions.html">Clojure Do’s: Uncaught Exceptions</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-831"><a class = "posts-by-tag-item-title" href="../../../2015/05/17/clojure-record-constructors.html">Record Constructors</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-826"><a class = "posts-by-tag-item-title" href="../../../2015/05/10/clojure-namespace-aliases.html">Clojure Do’s: Namespace Aliases</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-820"><a class = "posts-by-tag-item-title" href="../../../2015/05/02/clojure-donts-isa.html">Clojure Don’ts: isa?</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-812"><a class = "posts-by-tag-item-title" href="../../../2015/04/26/clojure-donts-concat.html">Clojure Don’ts: Concat</a></li></ul></section>	</aside><!-- .sidebar .widget-area -->

		</div><!-- .site-content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
							<nav class="main-navigation" role="navigation" aria-label="Footer Primary Menu">
					<div class="menu-main-menu-container"><ul id="menu-main-menu-1" class="primary-menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../../../about-me.html">About Me</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../../../writing.html">Writing</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../../../presentations.html">Presentations</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../../../software.html">Software</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../../../contact.html">Contact</a></li>
</ul></div>				</nav><!-- .main-navigation -->
			
			
			<div class="site-info">
								<span class="site-title"><a href="../../../index.html" rel="home">Digital Digressions by Stuart Sierra</a></span>
				<a href="https://wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- .site-footer -->
	</div><!-- .site-inner -->
</div><!-- .site -->

	<div style="display:none">
	<div class="grofile-hash-map-55878d0196b91803f9cb2c372b0551d3">
	</div>
	</div>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201635'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2016Sepaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/plugins/jetpack/modules/wpgroho167b.js?ver=4.6'></script>
<script type='text/javascript' src='../../../wp-content/themes/twentysixteen/js/skip-link-focus-fix8de4.js?ver=20160816'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/themes/twentysixteen/js/functions8de4.js?ver=20160816'></script>
<script type='text/javascript' src='../../../wp-includes/js/wp-embed.min167b.js?ver=4.6'></script>
<script type='text/javascript' src='https://stats.wp.com/e-201635.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.2.2',blog:'2702563',post:'0',tz:'-4',srv:'stuartsierra.com'} ]);
	_stq.push([ 'clickTrackerInit', '2702563', '0' ]);
</script>
</body>

<!-- Mirrored from stuartsierra.com/tag/clojure/page/3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 17:00:23 GMT -->
</html>

<!-- Dynamic page generated in 0.449 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2016-09-02 12:57:26 -->

<!-- Compression = gzip -->