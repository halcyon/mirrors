<!DOCTYPE html>
<html lang="en-US" class="no-js">

<!-- Mirrored from stuartsierra.com/tag/clojure/page/2 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 16:57:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Clojure &#8211; Page 2 &#8211; Digital Digressions by Stuart Sierra</title>
<link rel='dns-prefetch' href='http://s0.wp.com/'>
<link rel='dns-prefetch' href='http://secure.gravatar.com/'>
<link rel='dns-prefetch' href='http://fonts.googleapis.com/'>
<link rel='dns-prefetch' href='http://s.w.org/'>
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Feed" href="http://feeds2.feedburner.com/StuartSierra" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Comments Feed" href="../../../comments/feed" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Clojure Tag Feed" href="http://feeds2.feedburner.com/StuartSierra" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/stuartsierra.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='twentysixteen-jetpack-css'  href='../../../wp-content/plugins/jetpack/modules/theme-tools/compat/twentysixteen3a05.css?ver=4.2.2' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-fonts-css'  href='https://fonts.googleapis.com/css?family=Merriweather%3A400%2C700%2C900%2C400italic%2C700italic%2C900italic%7CMontserrat%3A400%2C700%7CInconsolata%3A400&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='../../../wp-content/plugins/jetpack/_inc/genericons/genericons/genericons128b.css?ver=3.1' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-style-css'  href='../../../wp-content/themes/twentysixteen/style167b.css?ver=4.6' type='text/css' media='all' />
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='jetpack_css-css'  href='../../../wp-content/plugins/jetpack/css/jetpack3a05.css?ver=4.2.2' type='text/css' media='all' />
<script type='text/javascript' src='../../../wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../../../wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://stuartsierra.com/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<link rel='https://api.w.org/' href='../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6" />

<link rel='dns-prefetch' href='http://v0.wordpress.com/'>
</head>

<body class="archive paged tag tag-clojure tag-47 paged-2 tag-paged-2 hfeed">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

		<header id="masthead" class="site-header" role="banner">
			<div class="site-header-main">
				<div class="site-branding">
					
											<p class="site-title"><a href="../../../index.html" rel="home">Digital Digressions by Stuart Sierra</a></p>
											<p class="site-description">From programming to everything else</p>
									</div><!-- .site-branding -->

									<button id="menu-toggle" class="menu-toggle">Menu</button>

					<div id="site-header-menu" class="site-header-menu">
													<nav id="site-navigation" class="main-navigation" role="navigation" aria-label="Primary Menu">
								<div class="menu-main-menu-container"><ul id="menu-main-menu" class="primary-menu"><li id="menu-item-635" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../../../about-me.html">About Me</a></li>
<li id="menu-item-633" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../../../writing.html">Writing</a></li>
<li id="menu-item-634" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../../../presentations.html">Presentations</a></li>
<li id="menu-item-636" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../../../software.html">Software</a></li>
<li id="menu-item-637" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../../../contact.html">Contact</a></li>
</ul></div>							</nav><!-- .main-navigation -->
						
											</div><!-- .site-header-menu -->
							</div><!-- .site-header-main -->

											<div class="header-image">
					<a href="../../../index.html" rel="home">
						<img src="../../../wp-content/uploads/2015/12/header.jpg" srcset="https://stuartsierra.com/wp-content/uploads/2015/12/header-300x70.jpg 300w, https://stuartsierra.com/wp-content/uploads/2015/12/header-768x179.jpg 768w, https://stuartsierra.com/wp-content/uploads/2015/12/header-1024x239.jpg 1024w, https://stuartsierra.com/wp-content/uploads/2015/12/header.jpg 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 81vw, (max-width: 1362px) 88vw, 1200px" width="1200" height="280" alt="Digital Digressions by Stuart Sierra">
					</a>
				</div><!-- .header-image -->
					</header><!-- .site-header -->

		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			<header class="page-header">
				<h1 class="page-title">Tag: Clojure</h1>			</header><!-- .page-header -->

			
<article id="post-849" class="post-849 post type-post status-publish format-standard hentry category-programming tag-clojure tag-dos-and-donts">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/06/01/clojure-donts-optional-arguments-with-varargs.html" rel="bookmark">Clojure Don’ts: Optional Arguments with Varargs</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Another <a href="../../dos-and-donts.html">Clojure don’t</a> today. This one is a personal style preference, but I’ll try to back it up.</p>
<p>Say you want to define a function with a mix of required and optional arguments. I’ve often seen this:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">foo</span> [a &amp; [b]]
  (println <span class="org-string">"Required argument a is"</span> a)
  (println <span class="org-string">"Optional argument b is"</span> b))
</pre>
</div>
<p>This is a clever trick. It works because <code>&amp; [b]</code> destructures the sequence of arguments passed to the function after <code>a</code>. Sequential destructuring doesn’t require that the number of symbols match the number of elements in the sequence being bound. If there are more symbols than values, they are bound to <code>nil</code>.</p>
<div class="org-src-container">
<pre class="src src-clojure">(foo 3 4)
<span class="org-comment-delimiter">;; </span><span class="org-comment">Required argument a is 3</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Optional argument b is 4</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; nil</span>

(foo 9)
<span class="org-comment-delimiter">;; </span><span class="org-comment">Required argument a is 9</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Optional argument b is nil</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; nil</span>
</pre>
</div>
<p>I don’t like this pattern for two reasons.</p>
<p><b>One.</b> Because it’s variable arity, the function <code>foo</code> accepts <b>any</b> number of arguments. You won’t get an error if you call it with extra arguments, they will just be silently ignored.</p>
<div class="org-src-container">
<pre class="src src-clojure">(foo 5 6 7 8)
<span class="org-comment-delimiter">;; </span><span class="org-comment">Required argument a is 5</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Optional argument b is 6</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; nil</span>
</pre>
</div>
<p><b>Two.</b> It muddles the intent. The presence of <code>&amp;</code> in the parameter vector suggests that this function is <b>meant</b> to be variable-arity. Reading this code, I might start to wonder why. Or I might miss the <code>&amp;</code> and think this function is meant to be called with a sequence as its second argument.</p>
<p>A couple more lines make it clearer:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">foo</span>
  ([a]
   (foo a <span class="org-constant">nil</span>))
  ([a b]
   (println <span class="org-string">"Required argument a is"</span> a)
   (println <span class="org-string">"Optional argument b is"</span> b)))
</pre>
</div>
<p>The intent here is unambiguous: The function takes either one or two arguments, with <code>b</code> defaulting to <code>nil</code>. Trying to call it with more than two arguments will throw an exception, telling you that you did something wrong.</p>
<p>And one more thing: it’s faster. Variable-arity function calls have to allocate a sequence to hold the arguments, then go through <code>apply</code>. Timothy Baldridge did a quick <a href="https://gist.github.com/halgari/5d7780e6f068ae217bb2">performance comparison</a> showing that calls to a function with multiple, fixed arities can be much faster than variable-arity (varargs) function calls.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/06/01/clojure-donts-optional-arguments-with-varargs.html" rel="bookmark"><time class="entry-date published" datetime="2015-06-01T20:34:00+00:00">June 1, 2015</time><time class="updated" datetime="2015-06-06T08:11:16+00:00">June 6, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../dos-and-donts.html" rel="tag">do's and don'ts</a></span><span class="comments-link"><a href="../../../2015/06/01/clojure-donts-optional-arguments-with-varargs.html#comments">4 Comments<span class="screen-reader-text"> on Clojure Don’ts: Optional Arguments with Varargs</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-836" class="post-836 post type-post status-publish format-standard hentry category-programming tag-clojure tag-dos-and-donts tag-errors">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/05/27/clojure-uncaught-exceptions.html" rel="bookmark">Clojure Do’s: Uncaught Exceptions</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Some more <a href="../../dos-and-donts.html">do’s and don’ts</a> for you. This time it’s a ‘do.’</p>
<p>In the JVM, when an exception is thrown on a thread other than the main thread, and nothing is there to catch it, <b>nothing happens</b>. The thread <b>dies silently</b>.</p>
<p>This is bad news if you needed that thread to do some work. If all the worker threads die, the application could appear to be “up” but cease to do any useful work. And you’ll never know why.</p>
<p>In Clojure, this could happen on any thread you created with <code>core.async/thread</code>, a worker thread used by <code>core.async/go</code>, or a thread that was created for you by a Java framework such as a Servlet container.</p>
<p>One solution is to just wrap the body of every <code>thread</code> or <code>go</code> in a try/catch block. There are good reasons for doing this: you can get fine-grained control over how exceptions are handled. But it’s easy to forget, and it’s tedious to repeat if you can’t do anything useful with the exception besides log it.</p>
<p>So at a minimum, I recommend always including this snippet of code somewhere in the start-up procedure of your application:</p>
<div class="org-src-container">
<pre class="src src-clojure"><span class="org-comment-delimiter">;; </span><span class="org-comment">Assuming require [clojure.tools.logging :as log]</span>
(<span class="org-type">Thread</span>/<span class="org-clojure-interop-method">setDefaultUncaughtExceptionHandler</span>
 (reify <span class="org-type">Thread$UncaughtExceptionHandler</span>
   (<span class="org-clojure-interop-method">uncaughtException</span> [_ thread ex]
     (<span class="org-type">log</span>/error ex <span class="org-string">"Uncaught exception on"</span> (<span class="org-clojure-interop-method">.getName</span> thread)))))
</pre>
</div>
<p>This bit of code has saved my bacon more times than I can count.</p>
<p>This is a <b>global, JVM-wide</b> setting. There can be only one default uncaught exception handler. Individual Threads and ThreadGroups can have their own handlers, which get called in preference to the default handler. See <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Thread.html#setDefaultUncaughtExceptionHandler-java.lang.Thread.UncaughtExceptionHandler-">Thread.setDefaultUncaughtExceptionHandler</a>.</p>
<p>I’ve tried more aggressive measures, such as terminating the whole JVM process on any uncaught exception. While I think this is technically the correct thing to do, it turns out to be annoying in development.</p>
<p>Also annoying is the fact that some Java frameworks are <b>designed</b> to let threads fail silently. They just allocate a new thread in a pool and keep going. If your application is logging lots of uncaught exceptions but appears to be working normally, look to your container framework to see if that’s expected behavior.</p>
<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">The Hidden Future</h2>
<div id="text-unnumbered-1" class="outline-text-2">
<p>Another wrinkle: exceptions inside a <code>future</code> are <b>always</b> caught by the Future. The exception will not be thrown until something calls <a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Future.html#get--">Future.get</a> (<code>deref</code> in Clojure).</p>
<p>Be aware that <a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ExecutorService.html#submit-java.util.concurrent.Callable-">ExecutorService.submit</a> returns a Future, so if you’re using an ExecutorService you need to make sure something is eventually going to consume that Future to surface any exceptions it might have caught.</p>
<p>The parent interface <a href="http://docs.oracle.com/javase/8/docs/api/java/util/concurrent/Executor.html#execute-java.lang.Runnable-">Executor.execute</a> does <b>not</b> return a Future, so exeptions <b>will</b> reach the default exception handler.</p>
<p>Using ExecutorService.submit instead of Executor.execute was a bug in very early versions of core.async.</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/05/27/clojure-uncaught-exceptions.html" rel="bookmark"><time class="entry-date published" datetime="2015-05-27T06:09:00+00:00">May 27, 2015</time><time class="updated" datetime="2015-05-28T03:40:38+00:00">May 28, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../dos-and-donts.html" rel="tag">do's and don'ts</a>, <a href="../../errors.html" rel="tag">errors</a></span><span class="comments-link"><a href="../../../2015/05/27/clojure-uncaught-exceptions.html#comments">3 Comments<span class="screen-reader-text"> on Clojure Do’s: Uncaught Exceptions</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-831" class="post-831 post type-post status-publish format-standard hentry category-programming tag-clojure tag-dos-and-donts">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/05/17/clojure-record-constructors.html" rel="bookmark">Record Constructors</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Some more <a href="../../dos-and-donts.html">Clojure Do’s and Don’ts</a> for you. This week: record constructors.</p>
<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">Don’t use interop syntax to construct records</h2>
<div id="text-unnumbered-1" class="outline-text-2">
<p><code>defrecord</code> and <code>deftype</code> compile into Java classes, so it is possible to construct them using Java interop syntax like this:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-type">Foo</span> [a b])

(<span class="org-type">Foo.</span> 1 2)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; #user.Foo{:a 1, :b 2}</span>
</pre>
</div>
<p>But don’t do that. Interop syntax is for interop with Java libraries.</p>
<p>Since Clojure version 1.3, <code>defrecord</code> and <code>deftype</code> automatically create constructor functions. Use those instead of interop syntax.</p>
<p>For records, you get two constructor functions: one taking the values of fields in the same order they appear in the <code>defrecord</code>:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-type">Foo</span> [a b])

(-&gt;Foo 1 2)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; #user.Foo{:a 1 :b 2}</span>
</pre>
</div>
<p>And another taking a map whose keys are keywords with the same names as the fields:</p>
<div class="org-src-container">
<pre class="src src-clojure">(map-&gt;Foo {<span class="org-clojure-keyword">:b</span> 4 <span class="org-clojure-keyword">:a</span> 3})
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; #user.Foo{:a 3, :b 4}</span>
</pre>
</div>
<p><code>deftype</code> only creates the first kind of constructor, taking the field values in order.</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">deftype</span> <span class="org-type">Bar</span> [c d])

(-&gt;Bar 5 6)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; #&lt;Bar user.Bar@2168aeae&gt;</span>
</pre>
</div>
<p>Constructor functions are ordinary Clojure Vars. You can pass them to higher-order functions and <code>:require :as</code> or <code>:refer</code> them into other namespaces just like any other function.</p>
</div>
</div>
<div id="outline-container-unnumbered-2" class="outline-2">
<h2 id="unnumbered-2">Do add your own constructor functions</h2>
<div id="text-unnumbered-2" class="outline-text-2">
<p>You cannot modify or customize the constructor functions that <code>defrecord</code> and <code>deftype</code> create.</p>
<p>It’s common to want additional functionality around constructing an object, such as validation and default values. To get this, just define your own constructor function that wraps the default constructor.</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-type">Customer</span> [id name phone email])

(<span class="org-keyword">defn</span> <span class="org-function-name">customer</span>
  <span class="org-doc">"Creates a new customer record."</span>
  [{<span class="org-clojure-keyword">:keys</span> [name phone email]}]
  {<span class="org-clojure-keyword">:pre</span> [(string? name)
         (valid-phone? phone)
         (valid-email? email)]}
  (-&gt;Customer (next-id) name phone email))
</pre>
</div>
<p>You don’t necessarily have to use <code>:pre</code> conditions for validation; that’s just how I wrote this example.</p>
<p>It’s up to you to maintain a convention to always use your custom constructor function instead of the automatically-generated one.<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></p>
<p>I frequently define a custom constructor function for every new record type, even if I don&#8217;t need it right away. That gives me a place to add validation later, without searching for and replacing every instance of the default constructor.</p>
<p>Even custom constructor functions should follow the <a href="http://www.ibm.com/developerworks/library/j-jtp0618/">rules for safe constructors</a>. In general, that means no side effects and no “publishing” the object to another place before the constructor is finished. Keep the “creation” of an object (the constructor) separate from “starting” or “using” it, whatever that means for your code.</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes:</h2>
<div id="text-footnotes">
<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup></p>
<p class="footpara">Theoretically you could make the default constructors private with <code>alter-meta!</code>, but I&#8217;ve never found it necessary.</p>
</div>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/05/17/clojure-record-constructors.html" rel="bookmark"><time class="entry-date published" datetime="2015-05-17T05:19:00+00:00">May 17, 2015</time><time class="updated" datetime="2015-05-18T05:51:25+00:00">May 18, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../dos-and-donts.html" rel="tag">do's and don'ts</a></span><span class="comments-link"><a href="../../../2015/05/17/clojure-record-constructors.html#comments">2 Comments<span class="screen-reader-text"> on Record Constructors</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-826" class="post-826 post type-post status-publish format-standard hentry category-programming tag-clojure tag-dos-and-donts">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/05/10/clojure-namespace-aliases.html" rel="bookmark">Clojure Do’s: Namespace Aliases</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Third in a <a href="../../dos-and-donts.html">series</a>, this time with some style recommendations based on my personal experience.</p>
<p>In a small project with only a few developers, things like naming and style conventions don’t matter all that much, because almost everyone has worked with almost all of the code.</p>
<p>With bigger teams and bigger code bases — think tens of developers, tens of thousands of lines of Clojure — there’s a good chance that anyone reading the code has <b>never seen it before</b>. For that reader, a few conventions can be a big help.</p>
<p>Optimizing for readability usually means being more verbose. Don’t abbreviate unless you have to.</p>
<p>It also means optimizing for a reader who is not necessarily familiar with the entire code base, or even an entire file. They’ve just jumped to a function definition in their editor, or maybe pulled a line number from a stack trace. They don’t want to take the time to understand how all the different namespaces relate. They especially don’t want to have to scroll to the top of the file just to see where a symbol comes from.</p>
<p>So these conventions are about maximizing readability at the level of single function definitions. Yes, it means more typing. But it makes it much easier to navigate a large codebase maintained by multiple people.</p>
<p>As a general first rule, make the alias the same as the namespace name with the leading parts removed.</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">ns</span> <span class="org-type">com.example.application</span>
  (<span class="org-clojure-keyword">:require</span>
   [<span class="org-type">clojure.java.io</span> <span class="org-clojure-keyword">:as</span> io]
   [<span class="org-type">clojure.string</span> <span class="org-clojure-keyword">:as</span> string]))
</pre>
</div>
<p>Keep enough trailing parts to make each alias unique. Did you know that namespace aliases can have dots in them?</p>
<div class="org-src-container">
<pre class="src src-clojure">[<span class="org-type">clojure.data.xml</span> <span class="org-clojure-keyword">:as</span> <span class="org-type">data.xml</span>]
[<span class="org-type">clojure.xml</span> <span class="org-clojure-keyword">:as</span> xml]
</pre>
</div>
<p>Eliminate redundant words such as “core” and “clj” in aliases.</p>
<div class="org-src-container">
<pre class="src src-clojure">[clj-http <span class="org-clojure-keyword">:as</span> http]
[<span class="org-type">clj-time.core</span> <span class="org-clojure-keyword">:as</span> time]
[<span class="org-type">clj-time.format</span> <span class="org-clojure-keyword">:as</span> <span class="org-type">time.format</span>]
</pre>
</div>
<p>Use <code>:refer</code> sparingly. It’s good for symbols that have no alphabetic characters, such as <code>&gt;! &lt;! &gt;!! &lt;!!</code> in <code>core.async</code>, or heavily-used macros such those in <code>clojure.test</code>.</p>
<p>You can combine <code>:refer</code> and <code>:as</code> in the same <code>:require</code> clause.</p>
<div class="org-src-container">
<pre class="src src-clojure">[<span class="org-type">clojure.core.async</span> <span class="org-clojure-keyword">:as</span> async <span class="org-clojure-keyword">:refer</span> [&lt;! &gt;! &lt;!! &gt;!!]]
[<span class="org-type">clojure.test</span> <span class="org-clojure-keyword">:refer</span> [deftest is]]
</pre>
</div>
<p>There are always exceptions. For example, some namespaces have established conventions for aliases:</p>
<div class="org-src-container">
<pre class="src src-clojure">[<span class="org-type">datomic.api</span> <span class="org-clojure-keyword">:as</span> d]
</pre>
</div>
<p>Whatever convention you adopt, use consistent aliases everywhere. This makes it easier for everyone to read the code, and makes it possible to search for code with text-based tools like <code>grep</code>.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/05/10/clojure-namespace-aliases.html" rel="bookmark"><time class="entry-date published" datetime="2015-05-10T16:23:00+00:00">May 10, 2015</time><time class="updated" datetime="2015-05-11T07:45:35+00:00">May 11, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../dos-and-donts.html" rel="tag">do's and don'ts</a></span><span class="comments-link"><a href="../../../2015/05/10/clojure-namespace-aliases.html#comments">4 Comments<span class="screen-reader-text"> on Clojure Do’s: Namespace Aliases</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-820" class="post-820 post type-post status-publish format-standard hentry category-programming tag-clojure tag-dos-and-donts">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/05/02/clojure-donts-isa.html" rel="bookmark">Clojure Don’ts: isa?</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Dynamic typing is cool, but sometimes you just want to know the type of something.</p>
<p>I&#8217;ve seen people write this:</p>
<div class="org-src-container">
<pre class="src src-clojure">(isa? (type x) <span class="org-type">SomeJavaClass</span>)
</pre>
</div>
<p>As its docstring describes, <code>isa?</code> checks inheritance relationships, which may come from <b>either</b> Java class inheritance or Clojure hierarchies.</p>
<p><code>isa?</code> manually walks the class inheritance tree, and has special cases for vectors of types to support multiple-argument dispatch in multimethods.</p>
<div class="org-src-container">
<pre class="src src-clojure"><span class="org-comment-delimiter">;; </span><span class="org-comment">isa? with a vector of types.</span>
<span class="org-comment-delimiter">;; </span><span class="org-comment">Both sequences and vectors are java.util.List.</span>
(isa? [(type (range)) (type [1 2 3])]
      [<span class="org-type">java.util.List</span> <span class="org-type">java.util.List</span>])
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
</pre>
</div>
<p>Hierarchies are an interesting but rarely-used feature of Clojure.</p>
<div class="org-src-container">
<pre class="src src-clojure">(derive <span class="org-type">java.lang.String</span> <span class="org-clojure-keyword">::immutable</span>)

(isa? (type <span class="org-string">"Hello"</span>) <span class="org-clojure-keyword">::immutable</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
</pre>
</div>
<p>If all you want to know is “Is x a Foo?” where Foo is a Java type, then <code>(instance? Foo x)</code> is simpler and faster than <code>isa?</code>.</p>
<p>Some examples:</p>
<div class="org-src-container">
<pre class="src src-clojure">(instance? <span class="org-type">String</span> <span class="org-string">"hello"</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>

(instance? <span class="org-type">Double</span> 3.14)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>

(instance? <span class="org-type">Number</span> 3.14)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>

(instance? <span class="org-type">java.util.Date</span> #inst <span class="org-string">"2015-01-01"</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
</pre>
</div>
<p>Note that <code>instance?</code> takes the type first, opposite to the argument order of <code>isa?</code>. This works nicely with <code>condp</code>:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">make-bigger</span> [x]
  (<span class="org-keyword">condp</span> instance? x
    <span class="org-type">String</span> (<span class="org-type">clojure.string</span>/upper-case x)
    <span class="org-type">Number</span> (* x 1000)))

(make-bigger 42)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; 42000</span>

(make-bigger <span class="org-string">"Hi there"</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; "HI THERE"</span>
</pre>
</div>
<p><code>instance?</code> maps directly to Java&#8217;s <a href="http://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#isInstance-java.lang.Object-">Class.isInstance(Object)</a>. It works for both classes and interfaces, but does not accept <code>nil</code> as a type.</p>
<div class="org-src-container">
<pre class="src src-clojure">(isa? <span class="org-type">String</span> <span class="org-constant">nil</span>)      <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; false</span>

(instance? <span class="org-type">String</span> <span class="org-constant">nil</span>) <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; false</span>

(isa? <span class="org-constant">nil</span> <span class="org-constant">nil</span>)         <span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>

(instance? <span class="org-constant">nil</span> <span class="org-constant">nil</span>)    <span class="org-comment-delimiter">;; </span><span class="org-comment">NullPointerException</span>
</pre>
</div>
<p>Remember that <code>defrecord</code> and <code>deftype</code> produce Java classes as well:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-type">FooBar</span> [a])

(instance? <span class="org-type">FooBar</span> (-&gt;FooBar 42))
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; true</span>
</pre>
</div>
<p>Remember also that records and types are classes, not Vars, so to reference them from another namespace you must <code>:import</code> instead of <code>:require</code> them.</p>
<p><code>instance?</code> won&#8217;t work correctly with Clojure protocols. To check if something supports a protocol, use <code>satisfies?</code>.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/05/02/clojure-donts-isa.html" rel="bookmark"><time class="entry-date published" datetime="2015-05-02T07:39:00+00:00">May 2, 2015</time><time class="updated" datetime="2015-05-04T12:28:22+00:00">May 4, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../dos-and-donts.html" rel="tag">do's and don'ts</a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-812" class="post-812 post type-post status-publish format-standard hentry category-programming tag-clojure tag-dos-and-donts">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/04/26/clojure-donts-concat.html" rel="bookmark">Clojure Don’ts: Concat</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Welcome to what I hope will be an ongoing series of Clojure <i>do’s</i> and <i>don’ts</i>. I want to demonstrate not just good patterns to use, but also anti-patterns to avoid.</p>
<p>Some of these will be personal preferences, others will be warnings from hard-won experience. I’ll try to indicate which is which.</p>
<p>First up: <code>concat</code>.</p>
<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">Concat, the lazily-ticking time bomb</h2>
<div id="text-unnumbered-1" class="outline-text-2">
<p><code>concat</code> is a tricky little function. The name suggests a way to combine two collections. And it is, if you have <b>only</b> two collections. But it’s not as general as you might think. It’s not really a collection function at all. It’s a lazy sequence function. The difference can be important.</p>
<p>Here’s an example that I see a lot in the wild. Say you have a loop that builds up some result collection as the concatenation of several intermediate results:<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">next-results</span>
  <span class="org-doc">"Placeholder for function which computes some intermediate</span>
<span class="org-doc">  collection of results."</span>
  [n]
  (range 1 n))

(<span class="org-keyword">defn</span> <span class="org-function-name">build-result</span> [n]
  (<span class="org-keyword">loop</span> [counter 1
         results []]
    (<span class="org-keyword">if</span> (&lt; counter n)
      (<span class="org-keyword">recur</span> (inc counter)
             (concat results (next-results counter)))
      results)))
</pre>
</div>
<p>The devilish thing about this function is that it works just fine when <code>n</code> is small.</p>
<div class="org-src-container">
<pre class="src src-clojure">(take 21 (build-result 100))
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (1 1 2 1 2 3 1 2 3 4 1 2 3 4 5 1 2 3 4 5 6)</span>
</pre>
</div>
<p>But when <code>n</code> gets sufficiently large,<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> suddenly this happens:</p>
<div class="org-src-container">
<pre class="src src-clojure">(first (build-result 4000))
<span class="org-comment-delimiter">;; </span><span class="org-comment">StackOverflowError   clojure.core/seq (core.clj:133)</span>
</pre>
</div>
<p>In the stack trace, we see <code>concat</code> and <code>seq</code> repeated over and over:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-clojure-interop-method">.printStackTrace</span> <span class="org-builtin">*e</span> <span class="org-builtin">*out*</span>)
<span class="org-comment-delimiter">;; </span><span class="org-comment">java.lang.StackOverflowError</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.core$seq.invoke(core.clj:133)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.core$concat$fn__3955.invoke(core.clj:685)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.LazySeq.sval(LazySeq.java:40)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.LazySeq.seq(LazySeq.java:49)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.RT.seq(RT.java:484)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.core$seq.invoke(core.clj:133)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.core$concat$fn__3955.invoke(core.clj:685)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.LazySeq.sval(LazySeq.java:40)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.LazySeq.seq(LazySeq.java:49)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.RT.seq(RT.java:484)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.core$seq.invoke(core.clj:133)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.core$concat$fn__3955.invoke(core.clj:685)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.LazySeq.sval(LazySeq.java:40)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">at clojure.lang.LazySeq.seq(LazySeq.java:49)</span>
<span class="org-comment-delimiter">;;      </span><span class="org-comment">... hundreds more ...</span>
</pre>
</div>
<p>So we have a stack overflow. But why? We used <code>recur</code>. Our code has no stack-consuming recursion. <i>Or does it?</i> (cue ominous music)</p>
</div>
</div>
<div id="outline-container-unnumbered-2" class="outline-2">
<h2 id="unnumbered-2">Call the bomb squad</h2>
<div id="text-unnumbered-2" class="outline-text-2">
<p>Let’s look at the definition of <code>concat</code> more closely. Leaving out the extra arities and chunked sequence optimizations, it looks like this:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">concat</span> [x y]
  (lazy-seq
    (<span class="org-keyword">if-let</span> [s (seq x)]
      (cons (first s) (concat (rest s) y))
      y)))
</pre>
</div>
<p><code>lazy-seq</code> is a macro that wraps its body in function and then wraps the function in a LazySeq object.</p>
<p>The loop in <code>build-result</code> calls <code>concat</code> on the LazySeq returned by the <i>previous</i> <code>concat</code>, creating a chain of LazySeqs like this:</p>
<div class="figure">
<p><img src="../../../wp-content/uploads/2015/04/wpid-LazySeq-tree.png" alt="LazySeq-tree.png" /></p>
</div>
<p>Calling <code>seq</code> forces the LazySeq to invoke its function to realize its value. Most Clojure sequence functions, such as <code>first</code>, call <code>seq</code> for you automatically. Printing a LazySeq also forces it to be realized.</p>
<p>In the case of our <code>concat</code> chain, each LazySeq’s <code>fn</code> returns another LazySeq. <code>seq</code> has to recurse through them until it finds an actual value. If this recursion goes too deep, it overflows the stack.</p>
<p>Just <b>constructing</b> the sequence doesn’t trigger the error:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">let</span> [r (build-result 4000)]
  <span class="org-constant">nil</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; nil</span>
</pre>
</div>
<p>It only overflows when we try to realize it:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">let</span> [r (build-result 4000)]
  (seq r)
  <span class="org-constant">nil</span>)
<span class="org-comment-delimiter">;; </span><span class="org-comment">StackOverflowError   clojure.lang.RT.seq (RT.java:484)</span>
</pre>
</div>
<p>This is a nasty bug in production code, because it could occur far away from its source, and the accumulated stack frames of <code>seq</code> prevent us from seeing where the error originated.</p>
</div>
</div>
<div id="outline-container-unnumbered-3" class="outline-2">
<h2 id="unnumbered-3">Don’t concat</h2>
<div id="text-unnumbered-3" class="outline-text-2">
<p>The fix is to avoid <code>concat</code> in the first place. Our loop is building up a result collection immediately, not lazily, so we can use a vector and call <code>into</code> to accumulate the results:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">build-result-2</span> [n]
  (<span class="org-keyword">loop</span> [counter 1
         results []]
    (<span class="org-keyword">if</span> (&lt; counter n)
      (<span class="org-keyword">recur</span> (inc counter)
             (into results (next-results counter)))
      results)))
</pre>
</div>
<p>This works, at the cost of realizing the entire collection up front:</p>
<div class="org-src-container">
<pre class="src src-clojure">(time (<span class="org-keyword">doall</span> (take 21 (build-result-2 4000))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">"Elapsed time: 830.66655 msecs"</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (1 1 2 1 2 3 1 2 3 4 1 2 3 4 5 1 2 3 4 5 6)</span>
</pre>
</div>
<p>This specific example could also be written as a proper lazy sequence like this:</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">build-result-3</span> [n]
  (mapcat #(range 1 <span class="org-variable-name">%</span>) (range 1 n)))
</pre>
</div>
<p>Which avoids building the whole sequence in advance:</p>
<div class="org-src-container">
<pre class="src src-clojure">(time (<span class="org-keyword">doall</span> (take 21 (build-result-3 4000))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">"Elapsed time: 0.075421 msecs"</span>
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; (1 1 2 1 2 3 1 2 3 4 1 2 3 4 5 1 2 3 4 5 6)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-unnumbered-4" class="outline-2">
<h2 id="unnumbered-4">Don’t mix lazy and strict</h2>
<div id="text-unnumbered-4" class="outline-text-2">
<p>There’s a more general principle here:<br />
<b>Don’t use lazy sequence operations in a non-lazy loop.</b></p>
<p>If you’re using lazy sequences, make sure everything is truly lazy (or small). If you’re in a non-lazy loop, don’t build up a lazy result.</p>
<p>There are many variations of this bug, such as:</p>
<div class="org-src-container">
<pre class="src src-clojure">(first (reduce concat (map next-results (range 1 4000))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">StackOverflowError   clojure.core/seq (core.clj:133)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-clojure">(nth (iterate #(concat <span class="org-variable-name">%</span> [1 2 3]) [1 2 3]) 4000)
<span class="org-comment-delimiter">;; </span><span class="org-comment">StackOverflowError   clojure.core/seq (core.clj:133)</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-clojure">(first (<span class="org-clojure-keyword">:a</span> (apply merge-with concat
                  (map (<span class="org-keyword">fn</span> [n] {<span class="org-clojure-keyword">:a</span> (range 1 n)})
                       (range 1 4000)))))
<span class="org-comment-delimiter">;; </span><span class="org-comment">StackOverflowError   clojure.core/seq (core.clj:133)</span>
</pre>
</div>
<p>It’s not just <code>concat</code> either — any lazy sequence function could potentially cause this. <code>concat</code> is just the most common culprit.</p>
<p><strong>Update October 3, 2015:</strong> My friend Jon Distad has come up with a way to avoid this bug with a different implementation of <code>concat</code>. See <a href="https://groups.google.com/d/topic/clojure-dev/ewBuyloeiFs/discussion">Concat implementation without stack overflow</a> on the Clojure mailing list.</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes:</h2>
<div id="text-footnotes">
<div class="footdef">
<p><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup></p>
<p class="footpara">All these examples use Clojure version 1.6.0</p>
</div>
<div class="footdef">
<p><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup></p>
<p class="footpara">Depending on your JVM settings, it may take more or fewer iterations to trigger a StackOverflowError.</p>
</div>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/04/26/clojure-donts-concat.html" rel="bookmark"><time class="entry-date published" datetime="2015-04-26T11:44:00+00:00">April 26, 2015</time><time class="updated" datetime="2015-10-03T11:40:23+00:00">October 3, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../dos-and-donts.html" rel="tag">do's and don'ts</a></span><span class="comments-link"><a href="../../../2015/04/26/clojure-donts-concat.html#comments">4 Comments<span class="screen-reader-text"> on Clojure Don’ts: Concat</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-795" class="post-795 post type-post status-publish format-standard hentry category-programming tag-clojure">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2015/01/02/clojure-2014-year-in-review.html" rel="bookmark">Clojure 2014 Year in Review</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<div id="outline-container-sec-1" class="outline-2">
<p>My unscientific, incomplete, thoroughly biased view of interesting things that happened with Clojure in 2014.</p>
<h2 id="sec-1">Who&#8217;s Using Clojure?</h2>
<div id="text-1" class="outline-text-2">
<p>No doubt about it: Clojure is making inroads in big business.</p>
<p><a href="http://www.threatgrid.com/new-chapter/">Cisco acquired ThreatGRID</a>, a malware/threat analysis company <a href="http://www.threatgrid.com/software-developer-clojure/">using Clojure</a>.</p>
<p>There hasn&#8217;t been what I&#8217;d call an official announcement from <a href="http://www.amazon.com/">Amazon</a>, but it&#8217;s clear from <a href="https://twitter.com/jng27/status/541334956291522560">tweets</a> and <a href="http://lispjobs.wordpress.com/2014/11/25/clojure-software-development-engineers-amazon-com/">job listings</a> that they&#8217;re using Clojure in production.</p>
<p>Also on the sort-of-announced front, <a href="http://www.walmartlabs.com/">WalmartLabs</a> showed their love for Clojure in <a href="https://twitter.com/Moocar/status/538542041152507904">tweets</a> and <a href="http://jobs.walmart.com/silicon-valley/ecommerce-software-engineering/mobile-instore-software-(clojure)-engineer-jobs">job listings</a>.</p>
<p><a href="http://puppetlabs.com/blog/new-era-application-services-puppet-labs">Puppet Labs announced</a> a big move towards Clojure and released their own framework, <a href="https://github.com/puppetlabs/trapperkeeper">Trapperkeeper</a>.</p>
<p>The U.K. <i>Daily Mail</i> reported on how they use <a href="http://www.pitheringabout.com/?p=1018">Clojure at a Newspaper</a>.</p>
<p>Greenius wrote about their <a href="http://about.greeni.us/greenius-our-tech-roots/">Tech Roots: Clojure and Datomic</a>.</p>
<p>Beanstalk told us that <a href="http://blog.beanstalkapp.com/post/23998022427/beanstalk-clojure-love-and-20x-better">Beanstalk + Clojure = Love (and 20x better performance)</a></p>
<p><a href="http://cognitect.com/">Cognitect</a> published case studies from companies succeeding with Clojure and/or Datomic:</p>
<ul class="org-ul">
<li><a href="http://blog.cognitect.com/blog/2014/6/11/rally-and-datomic">Rally Software</a></li>
<li><a href="http://blog.cognitect.com/blog/2014/7/6/room-key-innovates-on-aws-with-cognitect-clojure-and-datomic">Room Key</a></li>
<li><a href="http://blog.cognitect.com/blog/2014/6/17/the-brigade-and-datomic">The Brigade</a></li>
<li><a href="http://blog.cognitect.com/blog/2014/6/3/pellucid-analytics-and-datomic">Pellucid Analytics</a></li>
</ul>
<p>On the education front, Elena Machkasova has started gathering references for <a href="http://cda.morris.umn.edu/~elenam/index.html#clojure">Clojure in undergraduate CS curriculum</a>.</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Radars &amp; Rankings</h2>
<div id="text-2" class="outline-text-2">
<p><a href="http://assets.thoughtworks.com/assets/technology-radar-jan-2014-en.pdf">Thoughtworks Radar January 2014 (PDF)</a> placed Clojure firmly in the &#8220;adopt&#8221; category, as did <a href="http://www.element84.com/technology-radar-2014.html">element 84&#8217;s Technology Radar 2014</a>.</p>
<p>Also in January, Clojure entered the top 20 in <a href="http://redmonk.com/sogrady/2014/01/22/language-rankings-1-14/">The RedMonk Programming Language Rankings</a>.</p>
<p>By the time of <a href="http://thoughtworks.fileburst.com/assets/technology-radar-july-2014-en.pdf">Thoughtworks Radar July 2014 (PDF)</a>, the editors didn&#8217;t even consider Clojure a question, having moved on to &#8220;trial&#8221; for <a href="https://github.com/clojure/core.async">core.async</a> and &#8220;assess&#8221; for <a href="https://github.com/swannodette/om">Om</a>.</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Conferences &amp; Events</h2>
<div id="text-3" class="outline-text-2">
<p>We started the year off right with <a href="http://www.clojurewest.org/">Clojure/West</a> in San Francisco (<a href="https://www.youtube.com/playlist?list=PLZdCLR02grLp__wRg5OTavVj4wefg69hM">videos on YouTube</a>). I <a href="https://www.youtube.com/watch?v=13cmHf_kt-Q">introduced Component</a>, my not-quite-a-framework. Aaron Bedra threw down the gauntlet for <a href="https://www.youtube.com/watch?v=CBL59w7fXw4">securing Clojure web applications</a>, leading to a flurry of activity making Clojure web frameworks more secure by default.</p>
<p><a href="http://euroclojure.com/2014/">EuroClojure 2014</a> came to Krakow, Poland (<a href="http://vimeo.com/channels/781458/videos">videos on Vimeo</a>).</p>
<p>At <a href="http://www.lambdajam.com/">Lambda Jam 2014</a> in Chicago (<a href="https://www.youtube.com/playlist?list=PLIpl4GKFQR6d5C03HoQN8ubYyMrBlDAAl">videos on YouTube</a>), Rich Hickey <a href="http://blog.cognitect.com/blog/2014/7/22/transit">introduced Transit</a> (<a href="https://github.com/cognitect/transit-format">Transit on GitHub</a>).</p>
<p>At <a href="https://thestrangeloop.com/">Strange Loop 2014</a> in St. Louis (<a href="https://www.youtube.com/channel/UC_QIfHvN9auy2CoOdSfMWDw">videos on YouTube</a>), Rich Hickey <a href="https://www.youtube.com/watch?v=6mTbuzafcII">introduced Transducers</a>. Ramsey Nasser and Tims Gardner <a href="https://www.youtube.com/watch?v=tJr_TD1BtF0">introduced Clojure + Unity 3D</a>, now named <a href="https://github.com/arcadia-unity/Arcadia">Arcadia</a>. Ambrose Bonnaire Sergeant talked about <a href="https://www.youtube.com/watch?v=a0gT0syAXsY">Typed Clojure in Practice</a>. Michael Nygard talked about <a href="https://www.youtube.com/watch?v=N5HyVUPuU0E">Simulation Testing</a>.</p>
<p>Rich Hickey made an appearance at <a href="https://www.oracle.com/javaone/index.html">JavaOne 2014</a> in San Francisco with <a href="https://oracleus.activeevents.com/2014/connect/sessionDetail.ww?SESSION_ID=8870">Clojure Made Simple</a> (<a href="https://www.youtube.com/watch?v=VSdnJDO-xdg">video on YouTube</a>).</p>
<p>In November, <a href="http://clojure-conj.org/">Clojure/conj 2014</a> in Washington, D.C. (<a href="https://www.youtube.com/playlist?list=PLZdCLR02grLoc322bYirANEso3mmzvCiI">videos on YouTube</a>) was the <a href="http://blog.cognitect.com/blog/2014/12/2/clojureconj-2014-is-in-the-books">biggest Clojure/conj yet</a>. Over 500 attendees filled the beautiful Warner Theater.</p>
<p>Meanwhile, <a href="http://www.clojurebridge.org/">ClojureBridge</a> held workshops throughout the year in Sydney, San Francisco, Edinburgh, and Minneapolis, just to name a few.</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Language Ecosystem</h2>
<div id="text-4" class="outline-text-2">
<p>The Clojure language itself continues to feature new and innovative ideas, this time <a href="http://clojure.org/transducers">Transducers</a>.</p>
<p><a href="http://clojuredocs.org/">ClojureDocs</a> got a huge update: it now covers Clojure 1.6 and some important libraries like <a href="http://clojuredocs.org/clojure.core.async">core.async</a> and <a href="http://clojuredocs.org/clojure.core.logic">core.logic</a>. There are also two new additions to the Clojure documentation sphere: <a href="http://conj.io/">Grimoire</a> and <a href="http://crossclj.info/">CrossClj</a>.</p>
<p>I for one am loving the surge in diversity of Clojure tooling. <a href="https://cursiveclojure.com/">Cursive for IntelliJ</a> garnered some serious attention, while <a href="https://github.com/clojure-emacs/cider">CIDER</a> and <a href="https://code.google.com/p/counterclockwise/">Counterclockwise</a> both got major new releases. <a href="http://boot-clj.com/">Boot</a> is a new build tool with a radically different approach from the still-solid <a href="http://leiningen.org/">Leiningen</a>.</p>
<p>Generative testing really started to catch on. Quick-check creator John Hughes gave a great keynote (<a href="https://www.youtube.com/watch?v=zi0rHwfiX1Q">video</a>) at Clojure/west. Ashton Kemerling talked about <a href="https://www.youtube.com/watch?v=HXGpBrmR70U">Generative Integration Tests</a> at Clojure/conj (also <a href="http://www.pivotaltracker.com/community/tracker-blog/generative-testing">blogged</a>). And of course the Clojure library simple-check became <a href="https://github.com/clojure/test.check">test.check</a>, and has grown steadily in both capability and adoption.</p>
<p>Most of the <a href="https://github.com/clojure">Clojure contrib projects</a> have gotten improvements and new releases.</p>
<p>ClojureScript growth accelerated, with three (and counting) frameworks built on top of Facebook&#8217;s <a href="http://facebook.github.io/react/">React</a>: <a href="https://github.com/swannodette/om">Om</a>, <a href="https://github.com/levand/quiescent">Quiescent</a>, and <a href="http://holmsand.github.io/reagent/">Reagent</a>.</p>
<p>Speaking of frameworks, there was a fair amount of activity around <a href="https://github.com/stuartsierra/component">Component</a>. No, I haven&#8217;t ported it to ClojureScript yet :) but there&#8217;s another <a href="https://github.com/quile/component-cljs">ClojureScript port</a>. People have started building things on top of Component, including <a href="https://github.com/juxt/modular">juxt/modular</a> and <a href="https://github.com/danielsz/system">danielsz/system</a>. uSwitch published some <a href="http://www.uswitch.com/tech/more-open-source-clojure-systems-please/">Example Component-based Apps</a>.</p>
<p>Like a Phoenix rising from the ashes, <a href="https://github.com/pedestal/pedestal/releases">new Pedestal releases</a> appeared with support for fully non-blocking I/O, Transit, and Immutant.</p>
<p>What else is going on? The <a href="http://blog.cognitect.com/blog/2014/10/24/analysis-of-the-state-of-clojure-and-clojurescript-survey-2014">State of Clojure Survey 2014 analysis</a> gave some insight into what people are thinking about Clojure.</p>
<p>Onward to 2015!</p>
<p>Thanks to Michael Fogus, Lake Denman, Alex Miller, and Paul deGrandis for their help in assembling this post.</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2015/01/02/clojure-2014-year-in-review.html" rel="bookmark"><time class="entry-date published" datetime="2015-01-02T11:39:00+00:00">January 2, 2015</time><time class="updated" datetime="2015-12-30T16:16:09+00:00">December 30, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a></span><span class="comments-link"><a href="../../../2015/01/02/clojure-2014-year-in-review.html#comments">2 Comments<span class="screen-reader-text"> on Clojure 2014 Year in Review</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-762" class="post-762 post type-post status-publish format-standard hentry category-programming tag-clojure tag-clojurescript">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2014/01/01/clojure-2013-year-in-review.html" rel="bookmark">Clojure 2013 Year in Review</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p> This is my third Clojure year-in-review post. In <a href="../../../2012/01/03/clojure-2011-year-in-review.html">2011</a> I was excited about Clojure 1.3, ClojureScript, and the second Clojure/conj. By <a href="../../../2013/01/01/clojure-2012-year-in-review.html">2012</a> I was blown away by <b>four</b> Clojure conferences, two O&#8217;Reilly books, reducers, Datomic, Immutant, and a partridge in a pear tree. </p>
<p> For 2013, where do I even start? So much has happened this year I can&#8217;t even begin to keep track of it all. What follows is my incomplete, highly-biased summary of the significant news for Clojure in 2013. </p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Growth and the Industry</h2>
<div class="outline-text-2" id="text-1">
<p> Maybe I should start right here at my home base, <a href="http://thinkrelevance.com/">Relevance</a>, which, after years of close collaboration, finally tied the knot with Rich Hickey and Datomic to <a href="http://cognitect.com/hello">become Cognitect</a>.  </p>
<p> This merger opens up new possibilites with the introduction of <a href="http://www.cognitect.com/support">enterprise-grade 24/7 support</a> for Clojure, ClojureScript, Datomic, and the rest of the Clojure &#8220;stack.&#8221; Plenty of big businesses have been waiting for just this kind of safety guarantee before they jump into the Clojure open-source ecosystem, so this means we should be seeing Clojure in more, and bigger, places in 2014. Hear more on the <a href="http://thinkrelevance.com/blog/2013/09/16/cognitect-podcast-episode-040">transition episode</a> of the Relevance Podcast, renamed the <a href="http://cognitect.com/podcast">Cognicast</a>. </p>
<p> In other industry / mindshare news: </p>
<ul class="org-ul">
<li>
<p><a href="http://techcrunch.com/2013/10/02/staples-buys-runa-to-square-up-to-amazon-in-the-e-commerce-game-for-office-supplies/">Staples acquired Runa</a>, an early adopter of Clojure, where they will continue to leverage Clojure for customized offers and other retail services. </p>
</li>
<li>
<p>The Clojure mailing list has over 8500 members. </p>
</li>
<li>
<p>In Chas Emerick&#8217;s <a href="http://cemerick.com/2013/11/18/results-of-the-2013-state-of-clojure-clojurescript-survey/">2013 State of Clojure survey</a>, over half of respondents said they were using Clojure at work, a jump from last year. Alex Miller dug through the free-form responses to identify trends in <a href="http://tech.puredanger.com/2013/11/19/state-of-clojure-language-features/">desired features</a> and <a href="http://tech.puredanger.com/2013/12/01/clj-problems/">perceived problem areas</a>. </p>
</li>
<li>
<p>A batch of new Clojure books came out, notably the first O&#8217;Reilly <a href="http://clojure-cookbook.com/">Clojure Cookbook</a>, written collaboratively by the community and edited by my colleagues Luke VanderHart and Ryan Neufeld. </p>
</li>
<li>
<p>Those looking to learn Clojure also got some new free resources: <a href="http://www.braveclojure.com/">Clojure for the Brave and True</a> by Daniel Higginbotham and <a href="http://aphyr.com/tags/Clojure-from-the-ground-up">Clojure from the Ground Up</a> by Kyle Kingsbury. </p>
</li>
<li>
<p>More conferences: <a href="http://clojurewest.org/">Clojure/West</a> and <a href="http://clojure-conj.org/">Clojure/conj</a> and the second <a href="http://euroclojure.com/">EuroClojure</a>. Not to mention Clojure being a big part of the functional programming discussion at <a href="http://www.yowconference.com.au/lambdajam/">YOW! Lambda Jam</a> in Australia, <a href="http://lambdajam.com/">Lambda Jam</a> in Chicago, and the venerable <a href="https://thestrangeloop.com/">Strange Loop</a>. You can catch videos on <a href="http://www.youtube.com/user/ClojureTV">ClojureTV on YouTube</a>, <a href="http://www.infoq.com/Clojure/presentations/">InfoQ Clojure presentations</a>, and other channels. </p>
</li>
<li>
<p>Inspired by efforts to teach programming to beginners, some friends founded <a href="http://www.clojurebridge.org/">ClojureBridge</a>. A first workshop is scheduled for spring of 2014, and volunteers are developing curriculum and documentation. </p>
</li>
<li>
<p>Two programming contests, <a href="http://clojurecup.com/">Clojure Cup</a> and <a href="http://lispinsummerprojects.org/">Lisp in Summer Projects</a>, showed off programming talent from around the world </p>
</li>
</ul></div>
</p></div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Language &amp; Contributed Libraries</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>
<p>Clojure 1.5 was released, bringing <a href="http://clojure.com/blog/2012/05/08/reducers-a-library-and-model-for-collection-processing.html">reducers</a>, improved reader literals, new form-threading macros, and the new EDN reader. See the <a href="https://github.com/clojure/clojure/blob/clojure-1.5.1/changes.md">Clojure change log</a> for details. </p>
</li>
<li>
<p>Clojure <a href="https://github.com/clojure/clojure/blob/clojure-1.6.0-alpha3/changes.md">1.6 alphas</a> emerged with a new public API for calling Clojure from Java. </p>
</li>
<li>
<p>The <a href="http://clojure.com/blog/2013/06/28/clojure-core-async-channels.html">core.async library</a> alphas burst onto the scene, further extending the great support for concurrency and asynchronous programming in Clojure and ClojureScript. </p>
</li>
<li>
<p><a href="https://github.com/clojure/clojurescript">ClojureScript</a> grew rapidly, adding <a href="https://github.com/clojure/clojurescript/wiki/Source-maps">source maps</a> for debugging in a browser plus tons of performance enhancements. <a href="http://swannodette.github.io/">David Nolen&#8217;s blog</a> showcases some of the possibilities of ClojureScript with core.async. There&#8217;s also a dedicated <a href="https://groups.google.com/forum/#!forum/clojurescript">ClojureScript Google Group</a> now. </p>
</li>
<li>
<p>Stuart Halloway announced the public release of <a href="https://github.com/clojure/data.fressian">data.fressian</a>, the efficient binary encoding of Clojure data structures used by Datomic. See his <a href="http://www.youtube.com/watch?v=JArZqMqsaB0">data.fressian talk</a> from Clojure/conj. </p>
</li>
<li>
<p>A successful <a href="http://www.indiegogo.com/projects/typed-clojure">fund-raising campaign</a> helped Ambrose Bonnaire-Sergeant bring <a href="http://typedclojure.org/">Typed Clojure</a> from an academic thesis to <a href="https://groups.google.com/d/topic/clojure/U_aA_Ce3qWg/discussion">production-ready</a> code. </p>
</li>
<li>
<p>That same campaign plus additional <a href="https://groups.google.com/d/topic/clojure/iaP16MHpX0E/discussion">funding from Cognitect</a> helped Nicola Mometto release new libraries based on his experimental <a href="https://groups.google.com/forum/#!searchin/clojure/cinc/clojure/cC1yC9zrS1s/W0ducjm0uQYJ">Clojure-in-Clojure</a> port: <a href="https://github.com/clojure/tools.analyzer">tools.analyzer</a>, <a href="https://github.com/clojure/tools.analyzer.jvm">tools.analyzer.jvm</a>, <a href="https://github.com/clojure/tools.emitter.jvm">tools.emitter.jvm</a>, and <a href="https://github.com/clojure/tools.reader">tools.reader</a>. </p>
</li>
<li>
<p>Contributors closed <b>562</b> tickets on the <a href="http://dev.clojure.org/jira">Clojure.org JIRA</a> (not counting duplicates or declined tickets) including 68 on the core language. </p>
</li>
<li>
<p>The contrib libraries <a href="https://github.com/clojure/tools.cli">tools.cli</a>, <a href="https://github.com/clojure/java.jdbc">java.jdbc</a>, and <a href="https://github.com/clojure/math.combinatorics">math.combinatorics</a> got significant new releases. </p>
</li>
</ul></div>
</p></div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Software &amp; Tools</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>
<p>The Datomic team released <a href="https://github.com/Datomic/simulant">Simulant</a> for simulation testing of large distributed systems. See Stuart Halloway&#8217;s <a href="http://www.infoq.com/presentations/Simulation-Testing">Simulant presentation</a> on InfoQ. </p>
</li>
<li>
<p>Relevance/Cognitect released <a href="http://pedestal.io/">Pedestal</a>, a client-server web toolkit to showcase the possibilities of Clojure on the server and ClojureScript in the browser. </p>
</li>
<li>
<p>nrepl.el became <a href="https://github.com/clojure-emacs/cider">CIDER</a>, the Clojure IDE and REPL for Emacs. </p>
</li>
<li>
<p>Chas Emerick&#8217;s <a href="https://github.com/cemerick/austin">Austin</a> made ClojureScript REPLs easier to use. </p>
</li>
<li>
<p>New IDEs dedicated to Clojure appeared: <a href="https://nightcode.info/">Nightcode</a> and <a href="http://cursiveclojure.com/">Cursive for IntelliJ</a>. </p>
</li>
<li>
<p>Prismatic released their <a href="https://github.com/prismatic/plumbing">Plumbing / Graph</a> library as well as <a href="http://blog.getprismatic.com/blog/2013/9/4/schema-for-clojurescript-data-shape-declaration-and-validation">Schema</a> for run-time type validation. </p>
</li>
<li>
<p><a href="http://immutant.org/">Immutant</a>, a Clojure application server based on JBoss, made its 1.0 release. </p>
</li>
<li>
<p>Mark Engleberg released <a href="https://github.com/Engelberg/instaparse">Instaparse</a>, a parser generator that understands standard EBNF/ABNF notation. </p>
</li>
<li>
<p>I blogged about <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">My Clojure Workflow, Reloaded</a>, spawning dozens of experimental frameworks for doing dependency injection and modular programming in Clojure, including my own <a href="https://github.com/stuartsierra/component">Component</a>. </p>
</li>
</ul></div>
</p></div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Blogs and &#8216;Casts</h2>
<div class="outline-text-2" id="text-4">
<p> Tons more interesting stuff happened in 2013. I couldn&#8217;t even begin to capture it all in one place. Here are some other good places to look for interesting Clojure news: </p>
<ul class="org-ul">
<li>
<p><a href="http://thinkrelevance.com/blog/tags/podcast">Relevance Podcast</a>, renamed the <a href="http://cognitect.com/podcast">Cognicast</a> </p>
</li>
<li>
<p><a href="http://mostlylazy.com/">Mostly Lazy</a> podcast </p>
</li>
<li>
<p><a href="http://planet.clojure.in/">Planet Clojure</a> blog aggregator </p>
</li>
<li>
<p><a href="http://clojure-log.n01se.net/">#clojure IRC log</a> </p>
</li>
<li>
<p><a href="https://groups.google.com/forum/#!forum/clojure">Clojure Google Group</a> </p>
</li>
</ul>
<p> Here&#8217;s to a great 2014! </p>
</p></div>
</p></div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2014/01/01/clojure-2013-year-in-review.html" rel="bookmark"><time class="entry-date published" datetime="2014-01-01T11:48:41+00:00">January 1, 2014</time><time class="updated" datetime="2014-01-01T12:02:32+00:00">January 1, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../clojurescript.html" rel="tag">ClojureScript</a></span><span class="comments-link"><a href="../../../2014/01/01/clojure-2013-year-in-review.html#comments">5 Comments<span class="screen-reader-text"> on Clojure 2013 Year in Review</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-757" class="post-757 post type-post status-publish format-standard hentry category-programming tag-clojure tag-core-async">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/12/08/parallel-processing-with-core-async.html" rel="bookmark">Parallel Processing with core.async</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p><strong>Update August 13, 2041:</strong> This approach may now be obsolete with the introduction of <a href="http://clojure.github.io/core.async/#clojure.core.async/pipeline">pipeline</a> in core.async.</p>
<p><strong>Update April 27, 2015: </strong>the date <em>2041</em> in the previous update is a typo, but updates from the future ties in nicely with the async theme so I decided to leave it in.</p>
<p>✻ ✻ ✻</p>
<p>Say you have a bunch of items to process, and you want to parallelize the work across N threads. Using <a href="https://github.com/clojure/core.async">core.async</a>, one obvious way to do this is to create N <code>go</code> blocks, all reading from the same input channel.</p>
<div class="org-src-container">
<pre id="parallel" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">parallel</span>
  <span class="org-doc">"Processes values from input channel in parallel on n 'go' blocks.</span>

<span class="org-doc">  Invokes f on values taken from input channel. Values returned from f</span>
<span class="org-doc">  are written on output channel.</span>

<span class="org-doc">  Returns a channel which will be closed when the input channel is</span>
<span class="org-doc">  closed and all operations have completed.</span>

<span class="org-doc">  Note: the order of outputs may not match the order of inputs."</span>
  [n f input output]
  (<span class="org-keyword">let</span> [tasks (<span class="org-keyword">doall</span>
               (<span class="org-builtin">repeatedly</span> n
                #(go-loop []
                   (<span class="org-keyword">let</span> [in (&lt;! input)]
                     (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> in)
                       (<span class="org-keyword">let</span> [out (f in)]
                         (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> out)
                           (&gt;! output out))
                         (<span class="org-keyword">recur</span>)))))))]
    (go (<span class="org-keyword">doseq</span> [task tasks]
          (&lt;! task)))))</pre>
</div>
<p>This might create more <code>go</code> blocks than you need, but inactive <code>go</code> blocks don&#8217;t cost much except a little memory.</p>
<p>But this isn&#8217;t always ideal: if <code>f</code> is going to block or do I/O, then you might want to create a <code>thread</code> instead of a <code>go</code>. Threads are more expensive. Suppose you don&#8217;t know how quickly the inputs will arrive: you might end up creating more threads than you need.</p>
<p>What I typically want is to process things in parallel with as many threads as necessary, but <i>at most N</i>. If the processing with two threads is fast enough to keep up with the input, then we should only create two threads. This applies to other kinds of resources besides threads, network calls for example.</p>
<p>After many attempts, here is what I came up with:</p>
<div class="org-src-container">
<pre id="pmax" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">pmax</span>
  <span class="org-doc">"Process messages from input in parallel with at most max concurrent</span>
<span class="org-doc">  operations.</span>

<span class="org-doc">  Invokes f on values taken from input channel. f must return a</span>
<span class="org-doc">  channel, whose first value (if not closed) will be put on the output</span>
<span class="org-doc">  channel.</span>

<span class="org-doc">  Returns a channel which will be closed when the input channel is</span>
<span class="org-doc">  closed and all operations have completed.</span>

<span class="org-doc">  Creates new operations lazily: if processing can keep up with input,</span>
<span class="org-doc">  the number of parallel operations may be less than max.</span>

<span class="org-doc">  Note: the order of outputs may not match the order of inputs."</span>
  [max f input output]
  (go-loop [tasks #{input}]
    (<span class="org-keyword">when</span> (<span class="org-builtin">seq</span> tasks)
      (<span class="org-keyword">let</span> [[value task] (alts! (<span class="org-builtin">vec</span> tasks))]
        (<span class="org-keyword">if</span> (<span class="org-builtin">=</span> task input)
          (<span class="org-keyword">if</span> (<span class="org-builtin">nil?</span> value)
            (<span class="org-keyword">recur</span> (<span class="org-builtin">disj</span> tasks task))  <span class="org-comment-delimiter">; </span><span class="org-comment">input is closed</span>
            (<span class="org-keyword">recur</span> (<span class="org-builtin">conj</span> (<span class="org-keyword">if</span> (<span class="org-builtin">=</span> max (<span class="org-builtin">count</span> tasks))  <span class="org-comment-delimiter">; </span><span class="org-comment">max - 1 tasks running</span>
                           (<span class="org-builtin">disj</span> tasks input)  <span class="org-comment-delimiter">; </span><span class="org-comment">temporarily stop reading input</span>
                           tasks)
                         (f value))))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">one processing task finished: continue reading input</span>
          (<span class="org-keyword">do</span> (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> value) (&gt;! output value))
              (<span class="org-keyword">recur</span> (<span class="org-keyword">-&gt;</span> tasks (<span class="org-builtin">disj</span> task) (<span class="org-builtin">conj</span> input)))))))))
</pre>
</div>
<p>The function <code>f</code> is responsible for both processing the input <b>and</b> creating the response channel. So <code>f</code> could be a <code>go</code>, a <code>thread</code>, or something else that returns a channel, such as an asynchronous I/O operation. There&#8217;s a little bit of extra overhead to shuffle around data structures in this <code>go-loop</code>, but I&#8217;m assuming that the cost of processing inputs will dominate.</p>
<p>So how to test it? First a few helpers.</p>
<p>We want to make sure that the output channel doesn&#8217;t hold up anything else, so we&#8217;ll make a helper function to consume everything from it:</p>
<div class="org-src-container">
<pre id="sink" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">sink</span>
  <span class="org-doc">"Returns an atom containing a vector. Consumes values from channel</span>
<span class="org-doc">  ch and conj's them into the atom."</span>
  [ch]
  (<span class="org-keyword">let</span> [a (<span class="org-builtin">atom</span> [])]
    (go-loop []
      (<span class="org-keyword">let</span> [val (&lt;! ch)]
        (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> val)
          (<span class="org-builtin">swap!</span> a conj val)
          (<span class="org-keyword">recur</span>))))
    a))</pre>
</div>
<p>What we want to keep track of is how many parallel operations are running at any given time. We can have our &#8220;processing&#8221; function increment a counter when it starts, wait a random interval of time, then decrement the counter before returning.</p>
<p>My colleague <a href="https://twitter.com/timbaldridge">@timbaldridge</a> suggested a watch function to keep track of how high the counter gets. This will produce a record of how many tasks were active at any time during the test.</p>
<div class="org-src-container">
<pre id="watch-counter" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">watch-counter</span> [counter thread-counts]
  (add-watch counter
             <span class="org-constant">:thread-count</span>
             (<span class="org-keyword">fn</span> [_ _ _ thread-count]
               (<span class="org-builtin">swap!</span> thread-counts conj thread-count))))</pre>
</div>
<p>Here&#8217;s the <code>pmax</code> function using a <code>go</code> block:</p>
<div class="org-src-container">
<pre id="t-pmax-go" class="src src-clojure">(<span class="org-keyword">deftest</span> <span class="org-function-name">t-pmax-go</span>
  (<span class="org-keyword">let</span> [input (to-chan (<span class="org-builtin">range</span> 50))
        output (chan)
        result (sink output)
        max-threads 5
        counter (<span class="org-builtin">atom</span> 0)
        f (<span class="org-keyword">fn</span> [x]
            (go
             (<span class="org-builtin">swap!</span> counter inc)
             (&lt;! (timeout (<span class="org-builtin">rand-int</span> 100)))
             (<span class="org-builtin">swap!</span> counter dec)
             x))
        thread-counts (<span class="org-builtin">atom</span> [])]
    (watch-counter counter thread-counts)
    (&lt;!! (pmax max-threads f input output))
    (<span class="org-type">is</span> (<span class="org-builtin">=</span> (<span class="org-builtin">set</span> (<span class="org-builtin">range</span> 50)) (<span class="org-builtin">set</span> @result)))
    (<span class="org-type">is</span> (<span class="org-builtin">every?</span> #(<span class="org-builtin">&lt;=</span> % max-threads) @thread-counts))))</pre>
</div>
<p>And <code>pmax</code> using a <code>thread</code>:</p>
<div class="org-src-container">
<pre id="t-pmax-thread" class="src src-clojure">(<span class="org-keyword">deftest</span> <span class="org-function-name">t-pmax-thread</span>
  (<span class="org-keyword">let</span> [input (to-chan (<span class="org-builtin">range</span> 50))
        output (chan)
        result (sink output)
        max-threads 5
        counter (<span class="org-builtin">atom</span> 0)
        f (<span class="org-keyword">fn</span> [x]
            (thread
             (<span class="org-builtin">swap!</span> counter inc)
             (&lt;!! (timeout (<span class="org-builtin">rand-int</span> 100)))
             (<span class="org-builtin">swap!</span> counter dec)
             x))
        thread-counts (<span class="org-builtin">atom</span> [])]
    (watch-counter counter thread-counts)
    (&lt;!! (pmax max-threads f input output))
    (<span class="org-type">is</span> (<span class="org-builtin">=</span> (<span class="org-builtin">set</span> (<span class="org-builtin">range</span> 50)) (<span class="org-builtin">set</span> @result)))
    (<span class="org-type">is</span> (<span class="org-builtin">every?</span> #(<span class="org-builtin">&lt;=</span> % max-threads) @thread-counts))))</pre>
</div>
<p>But what we really wanted to know is that <code>pmax</code> won&#8217;t create more threads than necessary when the input source is slower than the processing. Here&#8217;s that test, with a deliberately slow input channel:</p>
<div class="org-src-container">
<pre id="t-pmax-slow-input" class="src src-clojure">(<span class="org-keyword">deftest</span> <span class="org-function-name">t-pmax-slow-input</span>
  (<span class="org-keyword">let</span> [input (chan)
        output (chan)
        result (sink output)
        max-threads 5
        actual-needed-threads 3
        counter (<span class="org-builtin">atom</span> 0)
        f (<span class="org-keyword">fn</span> [x]
            (go
             (<span class="org-builtin">swap!</span> counter inc)
             (&lt;! (timeout (<span class="org-builtin">rand-int</span> 100)))
             (<span class="org-builtin">swap!</span> counter dec)
             x))
        thread-counts (<span class="org-builtin">atom</span> [])]
    (watch-counter counter thread-counts)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Slow input:</span>
    (go-loop [i 0]
      (<span class="org-keyword">if</span> (<span class="org-builtin">&lt;</span> i 50)
        (<span class="org-keyword">do</span> (&lt;! (timeout 50))
            (&gt;! input i)
            (<span class="org-keyword">recur</span> (<span class="org-builtin">inc</span> i)))
        (close! input)))
    (&lt;!! (pmax max-threads f input output))
    (<span class="org-type">is</span> (<span class="org-builtin">=</span> (<span class="org-builtin">set</span> (<span class="org-builtin">range</span> 50)) (<span class="org-builtin">set</span> @result)))
    (<span class="org-type">is</span> (<span class="org-builtin">every?</span> #(<span class="org-builtin">&lt;=</span> % actual-needed-threads) @thread-counts))))</pre>
</div>
<p>This still isn&#8217;t suitable for every scenario: maybe each thread needs some expensive set-up before it can process inputs. Then you would need some more elaborate mechanism to keep track of how many threads you have and whether or not they are keeping up with the input.</p>
<p>I have released the code in this blog post under the MIT License. <a href="https://github.com/stuartsierra/parallel-async">View the source code on GitHub</a>.</p>
<p><b>Update January 1, 2014:</b> As my colleague <a href="https://twitter.com/craigandera">@craigandera</a> pointed out, this code doesn&#8217;t do any error handling. It&#8217;s easy enough to add once you make a decision about <b>how</b> to handle errors: ignore, log, or abort the whole process.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/12/08/parallel-processing-with-core-async.html" rel="bookmark"><time class="entry-date published" datetime="2013-12-08T13:46:00+00:00">December 8, 2013</time><time class="updated" datetime="2015-04-27T09:12:33+00:00">April 27, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../core-async.html" rel="tag">core.async</a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-749" class="post-749 post type-post status-publish format-standard hentry category-programming tag-build-tools tag-clojure tag-java tag-lisp tag-maven tag-workflow">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../../../2013/11/04/command-line-intransigence.html" rel="bookmark">Command-Line Intransigence</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p> In the early days of Clojure, I was skeptical of Clojure-specific build tools like <a href="https://github.com/stuarthalloway/lancet">Lancet</a>, <a href="http://leiningen.org/">Leiningen</a>, and <a href="https://github.com/flatland/cake">Cake</a>. Why would Clojure, a part of the Java ecosystem, need its own build tool when there were already so many Java-based tools? </p>
<p> At the time, I thought <a href="http://maven.apache.org/">Maven</a> was the last word in build tooling. Early Leiningen felt like a thin wrapper around Maven for people with an inconsolable allergy to XML. Maven was the <i>serious</i> build tool, with a rich declarative model for describing dependency relationships among software artifacts. That model was imperfect, but it worked well enough to power one of the largest <a href="http://search.maven.org/">repositories</a> of open-source software on the planet. </p>
<p> But things change. Leiningen has evolved rapidly. Maven has also evolved, but more slowly, and the promised <a href="http://maven.40175.n5.nabble.com/What-happened-to-Polyglot-Maven-td5715529.html">non-XML POM syntax</a> (&#8220;polyglot Maven&#8221;) has not materialized. </p>
<p> Meanwhile, I learned <a href="http://nealford.com/memeagora/2013/01/22/why_everyone_eventually_hates_maven.html">why everyone eventually hates Maven</a>, through the experience of crafting custom Maven builds for two large-ish projects: the Clojure language and its contributed libraries. It was a challenge to satisfy the (often conflicting) requirements of developers, continuous integration, source repositories, and the public Maven repository network. Even with the help of <a href="http://www.sonatype.com/resources/books">Maven books</a> from <a href="http://www.sonatype.com/">Sonatype</a>, it took months of trial and error and nearly all my &#8220;open-source&#8221; time to get everything working. </p>
<p> At the end of this process I discovered, to my dismay, that I was the only one who understood it. As my colleague Stuart Halloway put it, &#8220;Maven breeds heroes.&#8221; For end-users and developers, there&#8217;s a nice interface: Clojure-contrib library authors can literally <a href="http://dev.clojure.org/display/community/How+to+Make+Releases">click a button</a> to make a release. But behind that button are so many steps and moving parts (Git, Hudson, Maven, Nexus, GPG, and all the Maven plugins) that even I can barely remember how it all works. I never wanted to be the XML hero. </p>
<p> So I have come around to Leiningen, and even incorporate it into my Clojure development <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">workflow</a>. It&#8217;s had some bumps, as one might expect from a fast-moving open-source project with lots of contributors, but most of the time it does what I need and doesn&#8217;t get in the way. </p>
<p> What puzzles me, however, is the stubbornness of developers who want to do <i>everything</i> via Leiningen. Some days it seems like every new tool or development utility for Clojure comes wrapped up in a Leiningen plugin so it can be invoked at the command line. I don&#8217;t get it. When you have a Clojure REPL, why would you limit yourself to the UNIX shell? </p>
<p> I think this habit comes partly from scripting languages, which were born at the command line, and still live there to a great extent. But it puzzled me a bit even in Ruby: if it takes 3 seconds to for <code>rake</code> to load your 5000-line Rails app, do you really want to use <code>rake</code> for critical administrative tasks like database migrations? <a href="http://ruby-doc.org/docs/ProgrammingRuby/html/irb.html">IRB</a> <a href="http://stackoverflow.com/a/5673496">is not a REPL</a> in the Lisp sense, but it&#8217;s a pretty good interactive shell. I&#8217;d rather work with a large Ruby app in IRB than via <code>rake</code>. </p>
<p> <a href="https://github.com/technomancy/leiningen/wiki/Faster">Start-up time</a> remains a major concern for Leiningen, and its contributors have gone to great lengths (sometimes <a href="https://github.com/technomancy/leiningen/pull/1230">too far</a>) to ameliorate it. Why not just avoid the problem altogether? Start Leiningen once and then work at the REPL. Admittedly, this takes some discipline and careful application design, but on my own projects I&#8217;ve gotten to the point where I only need to launch Leiningen once a day. Occasionally I make a mistake and get my application into such a borked state that the only remedy is restarting the JVM, but those occasions are rare. </p>
<p> I pretty much use Leiningen for just three things: 1) getting dependencies, 2) building JARs, and 3) launching REPLs. Once I have a REPL I can do my real work: running my application, testing, and profiling. The feedback cycles are faster and the debugging options much richer than what I can get on the command-line. </p>
<p> &#8220;Build plugins,&#8221; for Leiningen or Maven or any other tool, always suffer from running in a different environment from the code they are building. But isn&#8217;t one of the central tenets of Lisp that the compiler is <i>part of</i> your application? There isn&#8217;t really a sharp boundary between &#8220;build&#8221; code and &#8220;application&#8221; code. It&#8217;s all just code. </p>
<p> I used to write little &#8220;command-line interfaces&#8221; for running tests, builds, deployments, and so on. Now I&#8217;m more likely to just put those functions in a Clojure namespace and call them from the REPL. Sometimes I wonder: why not go further? Use Leiningen (or Maven, or Gradle, or whatever) just to download dependencies and bootstrap a REPL, then execute builds and releases <i>from the REPL</i>. </p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../../../2013/11/04/command-line-intransigence.html" rel="bookmark"><time class="entry-date published" datetime="2013-11-04T08:32:33+00:00">November 4, 2013</time><time class="updated" datetime="2014-01-01T12:05:19+00:00">January 1, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../build-tools.html" rel="tag">build tools</a>, <a href="../../clojure.html" rel="tag">Clojure</a>, <a href="../../java.html" rel="tag">Java</a>, <a href="../../lisp.html" rel="tag">Lisp</a>, <a href="../../maven.html" rel="tag">Maven</a>, <a href="../../workflow.html" rel="tag">workflow</a></span><span class="comments-link"><a href="../../../2013/11/04/command-line-intransigence.html#comments">7 Comments<span class="screen-reader-text"> on Command-Line Intransigence</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

	<nav class="navigation pagination" role="navigation">
		<h2 class="screen-reader-text">Posts navigation</h2>
		<div class="nav-links"><a class="prev page-numbers" href="../index.html">Previous page</a>
<a class='page-numbers' href='../index.html'><span class="meta-nav screen-reader-text">Page </span>1</a>
<span class='page-numbers current'><span class="meta-nav screen-reader-text">Page </span>2</span>
<a class='page-numbers' href='3.html'><span class="meta-nav screen-reader-text">Page </span>3</a>
<span class="page-numbers dots">&hellip;</span>
<a class='page-numbers' href='7.html'><span class="meta-nav screen-reader-text">Page </span>7</a>
<a class="next page-numbers" href="3.html">Next page</a></div>
	</nav>
		</main><!-- .site-main -->
	</div><!-- .content-area -->


	<aside id="secondary" class="sidebar widget-area" role="complementary">
		<section id="search-3" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://stuartsierra.com/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
	</label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">Search</span></button>
</form>
</section><section id="text-4" class="widget widget_text">			<div class="textwidget"><ul>
<li><a href="http://feeds2.feedburner.com/StuartSierra" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="../../../comments/feed" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
</ul>
<ul>
<li><a href="https://twitter.com/stuartsierra">Twitter</a></li>
<li><a href="https://github.com/stuartsierra">GitHub</a></li>
</ul></div>
		</section><section id="tag-widget-2" class="widget TagWidget"><h2 class="widget-title">Clojure Do’s and Don’ts</h2><ul class = "posts-by-tag-list"><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-883"><a class = "posts-by-tag-item-title" href="../../../2015/08/25/clojure-donts-lazy-effects.html">Clojure Don’ts: Lazy Effects</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-877"><a class = "posts-by-tag-item-title" href="../../../2015/08/10/clojure-donts-redundant-map.html">Clojure Don’ts: Redundant map</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-870"><a class = "posts-by-tag-item-title" href="../../../2015/06/16/clojure-donts-single-branch-if.html">Clojure Don’ts: Single-branch if</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-854"><a class = "posts-by-tag-item-title" href="../../../2015/06/10/clojure-donts-heisenparameter.html">Clojure Don’ts: The Heisenparameter</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-849"><a class = "posts-by-tag-item-title" href="../../../2015/06/01/clojure-donts-optional-arguments-with-varargs.html">Clojure Don’ts: Optional Arguments with Varargs</a></li><li class="posts-by-tag-item Clojure do's and don'ts errors" id="posts-by-tag-item-836"><a class = "posts-by-tag-item-title" href="../../../2015/05/27/clojure-uncaught-exceptions.html">Clojure Do’s: Uncaught Exceptions</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-831"><a class = "posts-by-tag-item-title" href="../../../2015/05/17/clojure-record-constructors.html">Record Constructors</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-826"><a class = "posts-by-tag-item-title" href="../../../2015/05/10/clojure-namespace-aliases.html">Clojure Do’s: Namespace Aliases</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-820"><a class = "posts-by-tag-item-title" href="../../../2015/05/02/clojure-donts-isa.html">Clojure Don’ts: isa?</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-812"><a class = "posts-by-tag-item-title" href="../../../2015/04/26/clojure-donts-concat.html">Clojure Don’ts: Concat</a></li></ul></section>	</aside><!-- .sidebar .widget-area -->

		</div><!-- .site-content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
							<nav class="main-navigation" role="navigation" aria-label="Footer Primary Menu">
					<div class="menu-main-menu-container"><ul id="menu-main-menu-1" class="primary-menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../../../about-me.html">About Me</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../../../writing.html">Writing</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../../../presentations.html">Presentations</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../../../software.html">Software</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../../../contact.html">Contact</a></li>
</ul></div>				</nav><!-- .main-navigation -->
			
			
			<div class="site-info">
								<span class="site-title"><a href="../../../index.html" rel="home">Digital Digressions by Stuart Sierra</a></span>
				<a href="https://wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- .site-footer -->
	</div><!-- .site-inner -->
</div><!-- .site -->

	<div style="display:none">
	<div class="grofile-hash-map-55878d0196b91803f9cb2c372b0551d3">
	</div>
	</div>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201635'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2016Sepaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/plugins/jetpack/modules/wpgroho167b.js?ver=4.6'></script>
<script type='text/javascript' src='../../../wp-content/themes/twentysixteen/js/skip-link-focus-fix8de4.js?ver=20160816'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/themes/twentysixteen/js/functions8de4.js?ver=20160816'></script>
<script type='text/javascript' src='../../../wp-includes/js/wp-embed.min167b.js?ver=4.6'></script>
<script type='text/javascript' src='https://stats.wp.com/e-201635.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.2.2',blog:'2702563',post:'0',tz:'-4',srv:'stuartsierra.com'} ]);
	_stq.push([ 'clickTrackerInit', '2702563', '0' ]);
</script>
</body>

<!-- Mirrored from stuartsierra.com/tag/clojure/page/2 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 16:57:26 GMT -->
</html>

<!-- Dynamic page generated in 0.467 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2016-09-02 00:38:13 -->

<!-- Compression = gzip -->