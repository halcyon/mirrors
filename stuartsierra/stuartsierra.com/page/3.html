<!DOCTYPE html>
<html lang="en-US" class="no-js">

<!-- Mirrored from stuartsierra.com/page/3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 16:59:32 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Digital Digressions by Stuart Sierra &#8211; Page 3 &#8211; From programming to everything else</title>
<link rel='dns-prefetch' href='http://s0.wp.com/'>
<link rel='dns-prefetch' href='http://secure.gravatar.com/'>
<link rel='dns-prefetch' href='http://fonts.googleapis.com/'>
<link rel='dns-prefetch' href='http://s.w.org/'>
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Feed" href="http://feeds2.feedburner.com/StuartSierra" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Comments Feed" href="../comments/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/stuartsierra.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='twentysixteen-jetpack-css'  href='../wp-content/plugins/jetpack/modules/theme-tools/compat/twentysixteen3a05.css?ver=4.2.2' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-fonts-css'  href='https://fonts.googleapis.com/css?family=Merriweather%3A400%2C700%2C900%2C400italic%2C700italic%2C900italic%7CMontserrat%3A400%2C700%7CInconsolata%3A400&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='../wp-content/plugins/jetpack/_inc/genericons/genericons/genericons128b.css?ver=3.1' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-style-css'  href='../wp-content/themes/twentysixteen/style167b.css?ver=4.6' type='text/css' media='all' />
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='jetpack_css-css'  href='../wp-content/plugins/jetpack/css/jetpack3a05.css?ver=4.2.2' type='text/css' media='all' />
<script type='text/javascript' src='../wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://stuartsierra.com/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<link rel='https://api.w.org/' href='../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.6" />
<link rel='shortlink' href='https://wp.me/bl3J' />

<link rel='dns-prefetch' href='http://v0.wordpress.com/'>

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="website" />
<meta property="og:title" content="Digital Digressions by Stuart Sierra" />
<meta property="og:description" content="From programming to everything else" />
<meta property="og:url" content="https://stuartsierra.com/" />
<meta property="og:site_name" content="Digital Digressions by Stuart Sierra" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_US" />
</head>

<body class="home blog paged paged-3 hfeed">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

		<header id="masthead" class="site-header" role="banner">
			<div class="site-header-main">
				<div class="site-branding">
					
											<h1 class="site-title"><a href="../index.html" rel="home">Digital Digressions by Stuart Sierra</a></h1>
											<p class="site-description">From programming to everything else</p>
									</div><!-- .site-branding -->

									<button id="menu-toggle" class="menu-toggle">Menu</button>

					<div id="site-header-menu" class="site-header-menu">
													<nav id="site-navigation" class="main-navigation" role="navigation" aria-label="Primary Menu">
								<div class="menu-main-menu-container"><ul id="menu-main-menu" class="primary-menu"><li id="menu-item-635" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../about-me.html">About Me</a></li>
<li id="menu-item-633" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../writing.html">Writing</a></li>
<li id="menu-item-634" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../presentations.html">Presentations</a></li>
<li id="menu-item-636" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../software.html">Software</a></li>
<li id="menu-item-637" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../contact.html">Contact</a></li>
</ul></div>							</nav><!-- .main-navigation -->
						
											</div><!-- .site-header-menu -->
							</div><!-- .site-header-main -->

											<div class="header-image">
					<a href="../index.html" rel="home">
						<img src="../wp-content/uploads/2015/12/header.jpg" srcset="https://stuartsierra.com/wp-content/uploads/2015/12/header-300x70.jpg 300w, https://stuartsierra.com/wp-content/uploads/2015/12/header-768x179.jpg 768w, https://stuartsierra.com/wp-content/uploads/2015/12/header-1024x239.jpg 1024w, https://stuartsierra.com/wp-content/uploads/2015/12/header.jpg 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 81vw, (max-width: 1362px) 88vw, 1200px" width="1200" height="280" alt="Digital Digressions by Stuart Sierra">
					</a>
				</div><!-- .header-image -->
					</header><!-- .site-header -->

		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
			
<article id="post-762" class="post-762 post type-post status-publish format-standard hentry category-programming tag-clojure tag-clojurescript">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2014/01/01/clojure-2013-year-in-review.html" rel="bookmark">Clojure 2013 Year in Review</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p> This is my third Clojure year-in-review post. In <a href="../2012/01/03/clojure-2011-year-in-review.html">2011</a> I was excited about Clojure 1.3, ClojureScript, and the second Clojure/conj. By <a href="../2013/01/01/clojure-2012-year-in-review.html">2012</a> I was blown away by <b>four</b> Clojure conferences, two O&#8217;Reilly books, reducers, Datomic, Immutant, and a partridge in a pear tree. </p>
<p> For 2013, where do I even start? So much has happened this year I can&#8217;t even begin to keep track of it all. What follows is my incomplete, highly-biased summary of the significant news for Clojure in 2013. </p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Growth and the Industry</h2>
<div class="outline-text-2" id="text-1">
<p> Maybe I should start right here at my home base, <a href="http://thinkrelevance.com/">Relevance</a>, which, after years of close collaboration, finally tied the knot with Rich Hickey and Datomic to <a href="http://cognitect.com/hello">become Cognitect</a>.  </p>
<p> This merger opens up new possibilites with the introduction of <a href="http://www.cognitect.com/support">enterprise-grade 24/7 support</a> for Clojure, ClojureScript, Datomic, and the rest of the Clojure &#8220;stack.&#8221; Plenty of big businesses have been waiting for just this kind of safety guarantee before they jump into the Clojure open-source ecosystem, so this means we should be seeing Clojure in more, and bigger, places in 2014. Hear more on the <a href="http://thinkrelevance.com/blog/2013/09/16/cognitect-podcast-episode-040">transition episode</a> of the Relevance Podcast, renamed the <a href="http://cognitect.com/podcast">Cognicast</a>. </p>
<p> In other industry / mindshare news: </p>
<ul class="org-ul">
<li>
<p><a href="http://techcrunch.com/2013/10/02/staples-buys-runa-to-square-up-to-amazon-in-the-e-commerce-game-for-office-supplies/">Staples acquired Runa</a>, an early adopter of Clojure, where they will continue to leverage Clojure for customized offers and other retail services. </p>
</li>
<li>
<p>The Clojure mailing list has over 8500 members. </p>
</li>
<li>
<p>In Chas Emerick&#8217;s <a href="http://cemerick.com/2013/11/18/results-of-the-2013-state-of-clojure-clojurescript-survey/">2013 State of Clojure survey</a>, over half of respondents said they were using Clojure at work, a jump from last year. Alex Miller dug through the free-form responses to identify trends in <a href="http://tech.puredanger.com/2013/11/19/state-of-clojure-language-features/">desired features</a> and <a href="http://tech.puredanger.com/2013/12/01/clj-problems/">perceived problem areas</a>. </p>
</li>
<li>
<p>A batch of new Clojure books came out, notably the first O&#8217;Reilly <a href="http://clojure-cookbook.com/">Clojure Cookbook</a>, written collaboratively by the community and edited by my colleagues Luke VanderHart and Ryan Neufeld. </p>
</li>
<li>
<p>Those looking to learn Clojure also got some new free resources: <a href="http://www.braveclojure.com/">Clojure for the Brave and True</a> by Daniel Higginbotham and <a href="http://aphyr.com/tags/Clojure-from-the-ground-up">Clojure from the Ground Up</a> by Kyle Kingsbury. </p>
</li>
<li>
<p>More conferences: <a href="http://clojurewest.org/">Clojure/West</a> and <a href="http://clojure-conj.org/">Clojure/conj</a> and the second <a href="http://euroclojure.com/">EuroClojure</a>. Not to mention Clojure being a big part of the functional programming discussion at <a href="http://www.yowconference.com.au/lambdajam/">YOW! Lambda Jam</a> in Australia, <a href="http://lambdajam.com/">Lambda Jam</a> in Chicago, and the venerable <a href="https://thestrangeloop.com/">Strange Loop</a>. You can catch videos on <a href="http://www.youtube.com/user/ClojureTV">ClojureTV on YouTube</a>, <a href="http://www.infoq.com/Clojure/presentations/">InfoQ Clojure presentations</a>, and other channels. </p>
</li>
<li>
<p>Inspired by efforts to teach programming to beginners, some friends founded <a href="http://www.clojurebridge.org/">ClojureBridge</a>. A first workshop is scheduled for spring of 2014, and volunteers are developing curriculum and documentation. </p>
</li>
<li>
<p>Two programming contests, <a href="http://clojurecup.com/">Clojure Cup</a> and <a href="http://lispinsummerprojects.org/">Lisp in Summer Projects</a>, showed off programming talent from around the world </p>
</li>
</ul></div>
</p></div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Language &amp; Contributed Libraries</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>
<p>Clojure 1.5 was released, bringing <a href="http://clojure.com/blog/2012/05/08/reducers-a-library-and-model-for-collection-processing.html">reducers</a>, improved reader literals, new form-threading macros, and the new EDN reader. See the <a href="https://github.com/clojure/clojure/blob/clojure-1.5.1/changes.md">Clojure change log</a> for details. </p>
</li>
<li>
<p>Clojure <a href="https://github.com/clojure/clojure/blob/clojure-1.6.0-alpha3/changes.md">1.6 alphas</a> emerged with a new public API for calling Clojure from Java. </p>
</li>
<li>
<p>The <a href="http://clojure.com/blog/2013/06/28/clojure-core-async-channels.html">core.async library</a> alphas burst onto the scene, further extending the great support for concurrency and asynchronous programming in Clojure and ClojureScript. </p>
</li>
<li>
<p><a href="https://github.com/clojure/clojurescript">ClojureScript</a> grew rapidly, adding <a href="https://github.com/clojure/clojurescript/wiki/Source-maps">source maps</a> for debugging in a browser plus tons of performance enhancements. <a href="http://swannodette.github.io/">David Nolen&#8217;s blog</a> showcases some of the possibilities of ClojureScript with core.async. There&#8217;s also a dedicated <a href="https://groups.google.com/forum/#!forum/clojurescript">ClojureScript Google Group</a> now. </p>
</li>
<li>
<p>Stuart Halloway announced the public release of <a href="https://github.com/clojure/data.fressian">data.fressian</a>, the efficient binary encoding of Clojure data structures used by Datomic. See his <a href="http://www.youtube.com/watch?v=JArZqMqsaB0">data.fressian talk</a> from Clojure/conj. </p>
</li>
<li>
<p>A successful <a href="http://www.indiegogo.com/projects/typed-clojure">fund-raising campaign</a> helped Ambrose Bonnaire-Sergeant bring <a href="http://typedclojure.org/">Typed Clojure</a> from an academic thesis to <a href="https://groups.google.com/d/topic/clojure/U_aA_Ce3qWg/discussion">production-ready</a> code. </p>
</li>
<li>
<p>That same campaign plus additional <a href="https://groups.google.com/d/topic/clojure/iaP16MHpX0E/discussion">funding from Cognitect</a> helped Nicola Mometto release new libraries based on his experimental <a href="https://groups.google.com/forum/#!searchin/clojure/cinc/clojure/cC1yC9zrS1s/W0ducjm0uQYJ">Clojure-in-Clojure</a> port: <a href="https://github.com/clojure/tools.analyzer">tools.analyzer</a>, <a href="https://github.com/clojure/tools.analyzer.jvm">tools.analyzer.jvm</a>, <a href="https://github.com/clojure/tools.emitter.jvm">tools.emitter.jvm</a>, and <a href="https://github.com/clojure/tools.reader">tools.reader</a>. </p>
</li>
<li>
<p>Contributors closed <b>562</b> tickets on the <a href="http://dev.clojure.org/jira">Clojure.org JIRA</a> (not counting duplicates or declined tickets) including 68 on the core language. </p>
</li>
<li>
<p>The contrib libraries <a href="https://github.com/clojure/tools.cli">tools.cli</a>, <a href="https://github.com/clojure/java.jdbc">java.jdbc</a>, and <a href="https://github.com/clojure/math.combinatorics">math.combinatorics</a> got significant new releases. </p>
</li>
</ul></div>
</p></div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Software &amp; Tools</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>
<p>The Datomic team released <a href="https://github.com/Datomic/simulant">Simulant</a> for simulation testing of large distributed systems. See Stuart Halloway&#8217;s <a href="http://www.infoq.com/presentations/Simulation-Testing">Simulant presentation</a> on InfoQ. </p>
</li>
<li>
<p>Relevance/Cognitect released <a href="http://pedestal.io/">Pedestal</a>, a client-server web toolkit to showcase the possibilities of Clojure on the server and ClojureScript in the browser. </p>
</li>
<li>
<p>nrepl.el became <a href="https://github.com/clojure-emacs/cider">CIDER</a>, the Clojure IDE and REPL for Emacs. </p>
</li>
<li>
<p>Chas Emerick&#8217;s <a href="https://github.com/cemerick/austin">Austin</a> made ClojureScript REPLs easier to use. </p>
</li>
<li>
<p>New IDEs dedicated to Clojure appeared: <a href="https://nightcode.info/">Nightcode</a> and <a href="http://cursiveclojure.com/">Cursive for IntelliJ</a>. </p>
</li>
<li>
<p>Prismatic released their <a href="https://github.com/prismatic/plumbing">Plumbing / Graph</a> library as well as <a href="http://blog.getprismatic.com/blog/2013/9/4/schema-for-clojurescript-data-shape-declaration-and-validation">Schema</a> for run-time type validation. </p>
</li>
<li>
<p><a href="http://immutant.org/">Immutant</a>, a Clojure application server based on JBoss, made its 1.0 release. </p>
</li>
<li>
<p>Mark Engleberg released <a href="https://github.com/Engelberg/instaparse">Instaparse</a>, a parser generator that understands standard EBNF/ABNF notation. </p>
</li>
<li>
<p>I blogged about <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">My Clojure Workflow, Reloaded</a>, spawning dozens of experimental frameworks for doing dependency injection and modular programming in Clojure, including my own <a href="https://github.com/stuartsierra/component">Component</a>. </p>
</li>
</ul></div>
</p></div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Blogs and &#8216;Casts</h2>
<div class="outline-text-2" id="text-4">
<p> Tons more interesting stuff happened in 2013. I couldn&#8217;t even begin to capture it all in one place. Here are some other good places to look for interesting Clojure news: </p>
<ul class="org-ul">
<li>
<p><a href="http://thinkrelevance.com/blog/tags/podcast">Relevance Podcast</a>, renamed the <a href="http://cognitect.com/podcast">Cognicast</a> </p>
</li>
<li>
<p><a href="http://mostlylazy.com/">Mostly Lazy</a> podcast </p>
</li>
<li>
<p><a href="http://planet.clojure.in/">Planet Clojure</a> blog aggregator </p>
</li>
<li>
<p><a href="http://clojure-log.n01se.net/">#clojure IRC log</a> </p>
</li>
<li>
<p><a href="https://groups.google.com/forum/#!forum/clojure">Clojure Google Group</a> </p>
</li>
</ul>
<p> Here&#8217;s to a great 2014! </p>
</p></div>
</p></div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2014/01/01/clojure-2013-year-in-review.html" rel="bookmark"><time class="entry-date published" datetime="2014-01-01T11:48:41+00:00">January 1, 2014</time><time class="updated" datetime="2014-01-01T12:02:32+00:00">January 1, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/clojure.html" rel="tag">Clojure</a>, <a href="../tag/clojurescript.html" rel="tag">ClojureScript</a></span><span class="comments-link"><a href="../2014/01/01/clojure-2013-year-in-review.html#comments">5 Comments<span class="screen-reader-text"> on Clojure 2013 Year in Review</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-757" class="post-757 post type-post status-publish format-standard hentry category-programming tag-clojure tag-core-async">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/12/08/parallel-processing-with-core-async.html" rel="bookmark">Parallel Processing with core.async</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p><strong>Update August 13, 2041:</strong> This approach may now be obsolete with the introduction of <a href="http://clojure.github.io/core.async/#clojure.core.async/pipeline">pipeline</a> in core.async.</p>
<p><strong>Update April 27, 2015: </strong>the date <em>2041</em> in the previous update is a typo, but updates from the future ties in nicely with the async theme so I decided to leave it in.</p>
<p>✻ ✻ ✻</p>
<p>Say you have a bunch of items to process, and you want to parallelize the work across N threads. Using <a href="https://github.com/clojure/core.async">core.async</a>, one obvious way to do this is to create N <code>go</code> blocks, all reading from the same input channel.</p>
<div class="org-src-container">
<pre id="parallel" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">parallel</span>
  <span class="org-doc">"Processes values from input channel in parallel on n 'go' blocks.</span>

<span class="org-doc">  Invokes f on values taken from input channel. Values returned from f</span>
<span class="org-doc">  are written on output channel.</span>

<span class="org-doc">  Returns a channel which will be closed when the input channel is</span>
<span class="org-doc">  closed and all operations have completed.</span>

<span class="org-doc">  Note: the order of outputs may not match the order of inputs."</span>
  [n f input output]
  (<span class="org-keyword">let</span> [tasks (<span class="org-keyword">doall</span>
               (<span class="org-builtin">repeatedly</span> n
                #(go-loop []
                   (<span class="org-keyword">let</span> [in (&lt;! input)]
                     (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> in)
                       (<span class="org-keyword">let</span> [out (f in)]
                         (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> out)
                           (&gt;! output out))
                         (<span class="org-keyword">recur</span>)))))))]
    (go (<span class="org-keyword">doseq</span> [task tasks]
          (&lt;! task)))))</pre>
</div>
<p>This might create more <code>go</code> blocks than you need, but inactive <code>go</code> blocks don&#8217;t cost much except a little memory.</p>
<p>But this isn&#8217;t always ideal: if <code>f</code> is going to block or do I/O, then you might want to create a <code>thread</code> instead of a <code>go</code>. Threads are more expensive. Suppose you don&#8217;t know how quickly the inputs will arrive: you might end up creating more threads than you need.</p>
<p>What I typically want is to process things in parallel with as many threads as necessary, but <i>at most N</i>. If the processing with two threads is fast enough to keep up with the input, then we should only create two threads. This applies to other kinds of resources besides threads, network calls for example.</p>
<p>After many attempts, here is what I came up with:</p>
<div class="org-src-container">
<pre id="pmax" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">pmax</span>
  <span class="org-doc">"Process messages from input in parallel with at most max concurrent</span>
<span class="org-doc">  operations.</span>

<span class="org-doc">  Invokes f on values taken from input channel. f must return a</span>
<span class="org-doc">  channel, whose first value (if not closed) will be put on the output</span>
<span class="org-doc">  channel.</span>

<span class="org-doc">  Returns a channel which will be closed when the input channel is</span>
<span class="org-doc">  closed and all operations have completed.</span>

<span class="org-doc">  Creates new operations lazily: if processing can keep up with input,</span>
<span class="org-doc">  the number of parallel operations may be less than max.</span>

<span class="org-doc">  Note: the order of outputs may not match the order of inputs."</span>
  [max f input output]
  (go-loop [tasks #{input}]
    (<span class="org-keyword">when</span> (<span class="org-builtin">seq</span> tasks)
      (<span class="org-keyword">let</span> [[value task] (alts! (<span class="org-builtin">vec</span> tasks))]
        (<span class="org-keyword">if</span> (<span class="org-builtin">=</span> task input)
          (<span class="org-keyword">if</span> (<span class="org-builtin">nil?</span> value)
            (<span class="org-keyword">recur</span> (<span class="org-builtin">disj</span> tasks task))  <span class="org-comment-delimiter">; </span><span class="org-comment">input is closed</span>
            (<span class="org-keyword">recur</span> (<span class="org-builtin">conj</span> (<span class="org-keyword">if</span> (<span class="org-builtin">=</span> max (<span class="org-builtin">count</span> tasks))  <span class="org-comment-delimiter">; </span><span class="org-comment">max - 1 tasks running</span>
                           (<span class="org-builtin">disj</span> tasks input)  <span class="org-comment-delimiter">; </span><span class="org-comment">temporarily stop reading input</span>
                           tasks)
                         (f value))))
          <span class="org-comment-delimiter">;; </span><span class="org-comment">one processing task finished: continue reading input</span>
          (<span class="org-keyword">do</span> (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> value) (&gt;! output value))
              (<span class="org-keyword">recur</span> (<span class="org-keyword">-&gt;</span> tasks (<span class="org-builtin">disj</span> task) (<span class="org-builtin">conj</span> input)))))))))
</pre>
</div>
<p>The function <code>f</code> is responsible for both processing the input <b>and</b> creating the response channel. So <code>f</code> could be a <code>go</code>, a <code>thread</code>, or something else that returns a channel, such as an asynchronous I/O operation. There&#8217;s a little bit of extra overhead to shuffle around data structures in this <code>go-loop</code>, but I&#8217;m assuming that the cost of processing inputs will dominate.</p>
<p>So how to test it? First a few helpers.</p>
<p>We want to make sure that the output channel doesn&#8217;t hold up anything else, so we&#8217;ll make a helper function to consume everything from it:</p>
<div class="org-src-container">
<pre id="sink" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">sink</span>
  <span class="org-doc">"Returns an atom containing a vector. Consumes values from channel</span>
<span class="org-doc">  ch and conj's them into the atom."</span>
  [ch]
  (<span class="org-keyword">let</span> [a (<span class="org-builtin">atom</span> [])]
    (go-loop []
      (<span class="org-keyword">let</span> [val (&lt;! ch)]
        (<span class="org-keyword">when-not</span> (<span class="org-builtin">nil?</span> val)
          (<span class="org-builtin">swap!</span> a conj val)
          (<span class="org-keyword">recur</span>))))
    a))</pre>
</div>
<p>What we want to keep track of is how many parallel operations are running at any given time. We can have our &#8220;processing&#8221; function increment a counter when it starts, wait a random interval of time, then decrement the counter before returning.</p>
<p>My colleague <a href="https://twitter.com/timbaldridge">@timbaldridge</a> suggested a watch function to keep track of how high the counter gets. This will produce a record of how many tasks were active at any time during the test.</p>
<div class="org-src-container">
<pre id="watch-counter" class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">watch-counter</span> [counter thread-counts]
  (add-watch counter
             <span class="org-constant">:thread-count</span>
             (<span class="org-keyword">fn</span> [_ _ _ thread-count]
               (<span class="org-builtin">swap!</span> thread-counts conj thread-count))))</pre>
</div>
<p>Here&#8217;s the <code>pmax</code> function using a <code>go</code> block:</p>
<div class="org-src-container">
<pre id="t-pmax-go" class="src src-clojure">(<span class="org-keyword">deftest</span> <span class="org-function-name">t-pmax-go</span>
  (<span class="org-keyword">let</span> [input (to-chan (<span class="org-builtin">range</span> 50))
        output (chan)
        result (sink output)
        max-threads 5
        counter (<span class="org-builtin">atom</span> 0)
        f (<span class="org-keyword">fn</span> [x]
            (go
             (<span class="org-builtin">swap!</span> counter inc)
             (&lt;! (timeout (<span class="org-builtin">rand-int</span> 100)))
             (<span class="org-builtin">swap!</span> counter dec)
             x))
        thread-counts (<span class="org-builtin">atom</span> [])]
    (watch-counter counter thread-counts)
    (&lt;!! (pmax max-threads f input output))
    (<span class="org-type">is</span> (<span class="org-builtin">=</span> (<span class="org-builtin">set</span> (<span class="org-builtin">range</span> 50)) (<span class="org-builtin">set</span> @result)))
    (<span class="org-type">is</span> (<span class="org-builtin">every?</span> #(<span class="org-builtin">&lt;=</span> % max-threads) @thread-counts))))</pre>
</div>
<p>And <code>pmax</code> using a <code>thread</code>:</p>
<div class="org-src-container">
<pre id="t-pmax-thread" class="src src-clojure">(<span class="org-keyword">deftest</span> <span class="org-function-name">t-pmax-thread</span>
  (<span class="org-keyword">let</span> [input (to-chan (<span class="org-builtin">range</span> 50))
        output (chan)
        result (sink output)
        max-threads 5
        counter (<span class="org-builtin">atom</span> 0)
        f (<span class="org-keyword">fn</span> [x]
            (thread
             (<span class="org-builtin">swap!</span> counter inc)
             (&lt;!! (timeout (<span class="org-builtin">rand-int</span> 100)))
             (<span class="org-builtin">swap!</span> counter dec)
             x))
        thread-counts (<span class="org-builtin">atom</span> [])]
    (watch-counter counter thread-counts)
    (&lt;!! (pmax max-threads f input output))
    (<span class="org-type">is</span> (<span class="org-builtin">=</span> (<span class="org-builtin">set</span> (<span class="org-builtin">range</span> 50)) (<span class="org-builtin">set</span> @result)))
    (<span class="org-type">is</span> (<span class="org-builtin">every?</span> #(<span class="org-builtin">&lt;=</span> % max-threads) @thread-counts))))</pre>
</div>
<p>But what we really wanted to know is that <code>pmax</code> won&#8217;t create more threads than necessary when the input source is slower than the processing. Here&#8217;s that test, with a deliberately slow input channel:</p>
<div class="org-src-container">
<pre id="t-pmax-slow-input" class="src src-clojure">(<span class="org-keyword">deftest</span> <span class="org-function-name">t-pmax-slow-input</span>
  (<span class="org-keyword">let</span> [input (chan)
        output (chan)
        result (sink output)
        max-threads 5
        actual-needed-threads 3
        counter (<span class="org-builtin">atom</span> 0)
        f (<span class="org-keyword">fn</span> [x]
            (go
             (<span class="org-builtin">swap!</span> counter inc)
             (&lt;! (timeout (<span class="org-builtin">rand-int</span> 100)))
             (<span class="org-builtin">swap!</span> counter dec)
             x))
        thread-counts (<span class="org-builtin">atom</span> [])]
    (watch-counter counter thread-counts)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Slow input:</span>
    (go-loop [i 0]
      (<span class="org-keyword">if</span> (<span class="org-builtin">&lt;</span> i 50)
        (<span class="org-keyword">do</span> (&lt;! (timeout 50))
            (&gt;! input i)
            (<span class="org-keyword">recur</span> (<span class="org-builtin">inc</span> i)))
        (close! input)))
    (&lt;!! (pmax max-threads f input output))
    (<span class="org-type">is</span> (<span class="org-builtin">=</span> (<span class="org-builtin">set</span> (<span class="org-builtin">range</span> 50)) (<span class="org-builtin">set</span> @result)))
    (<span class="org-type">is</span> (<span class="org-builtin">every?</span> #(<span class="org-builtin">&lt;=</span> % actual-needed-threads) @thread-counts))))</pre>
</div>
<p>This still isn&#8217;t suitable for every scenario: maybe each thread needs some expensive set-up before it can process inputs. Then you would need some more elaborate mechanism to keep track of how many threads you have and whether or not they are keeping up with the input.</p>
<p>I have released the code in this blog post under the MIT License. <a href="https://github.com/stuartsierra/parallel-async">View the source code on GitHub</a>.</p>
<p><b>Update January 1, 2014:</b> As my colleague <a href="https://twitter.com/craigandera">@craigandera</a> pointed out, this code doesn&#8217;t do any error handling. It&#8217;s easy enough to add once you make a decision about <b>how</b> to handle errors: ignore, log, or abort the whole process.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/12/08/parallel-processing-with-core-async.html" rel="bookmark"><time class="entry-date published" datetime="2013-12-08T13:46:00+00:00">December 8, 2013</time><time class="updated" datetime="2015-04-27T09:12:33+00:00">April 27, 2015</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/clojure.html" rel="tag">Clojure</a>, <a href="../tag/core-async.html" rel="tag">core.async</a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-749" class="post-749 post type-post status-publish format-standard hentry category-programming tag-build-tools tag-clojure tag-java tag-lisp tag-maven tag-workflow">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/11/04/command-line-intransigence.html" rel="bookmark">Command-Line Intransigence</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p> In the early days of Clojure, I was skeptical of Clojure-specific build tools like <a href="https://github.com/stuarthalloway/lancet">Lancet</a>, <a href="http://leiningen.org/">Leiningen</a>, and <a href="https://github.com/flatland/cake">Cake</a>. Why would Clojure, a part of the Java ecosystem, need its own build tool when there were already so many Java-based tools? </p>
<p> At the time, I thought <a href="http://maven.apache.org/">Maven</a> was the last word in build tooling. Early Leiningen felt like a thin wrapper around Maven for people with an inconsolable allergy to XML. Maven was the <i>serious</i> build tool, with a rich declarative model for describing dependency relationships among software artifacts. That model was imperfect, but it worked well enough to power one of the largest <a href="http://search.maven.org/">repositories</a> of open-source software on the planet. </p>
<p> But things change. Leiningen has evolved rapidly. Maven has also evolved, but more slowly, and the promised <a href="http://maven.40175.n5.nabble.com/What-happened-to-Polyglot-Maven-td5715529.html">non-XML POM syntax</a> (&#8220;polyglot Maven&#8221;) has not materialized. </p>
<p> Meanwhile, I learned <a href="http://nealford.com/memeagora/2013/01/22/why_everyone_eventually_hates_maven.html">why everyone eventually hates Maven</a>, through the experience of crafting custom Maven builds for two large-ish projects: the Clojure language and its contributed libraries. It was a challenge to satisfy the (often conflicting) requirements of developers, continuous integration, source repositories, and the public Maven repository network. Even with the help of <a href="http://www.sonatype.com/resources/books">Maven books</a> from <a href="http://www.sonatype.com/">Sonatype</a>, it took months of trial and error and nearly all my &#8220;open-source&#8221; time to get everything working. </p>
<p> At the end of this process I discovered, to my dismay, that I was the only one who understood it. As my colleague Stuart Halloway put it, &#8220;Maven breeds heroes.&#8221; For end-users and developers, there&#8217;s a nice interface: Clojure-contrib library authors can literally <a href="http://dev.clojure.org/display/community/How+to+Make+Releases">click a button</a> to make a release. But behind that button are so many steps and moving parts (Git, Hudson, Maven, Nexus, GPG, and all the Maven plugins) that even I can barely remember how it all works. I never wanted to be the XML hero. </p>
<p> So I have come around to Leiningen, and even incorporate it into my Clojure development <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">workflow</a>. It&#8217;s had some bumps, as one might expect from a fast-moving open-source project with lots of contributors, but most of the time it does what I need and doesn&#8217;t get in the way. </p>
<p> What puzzles me, however, is the stubbornness of developers who want to do <i>everything</i> via Leiningen. Some days it seems like every new tool or development utility for Clojure comes wrapped up in a Leiningen plugin so it can be invoked at the command line. I don&#8217;t get it. When you have a Clojure REPL, why would you limit yourself to the UNIX shell? </p>
<p> I think this habit comes partly from scripting languages, which were born at the command line, and still live there to a great extent. But it puzzled me a bit even in Ruby: if it takes 3 seconds to for <code>rake</code> to load your 5000-line Rails app, do you really want to use <code>rake</code> for critical administrative tasks like database migrations? <a href="http://ruby-doc.org/docs/ProgrammingRuby/html/irb.html">IRB</a> <a href="http://stackoverflow.com/a/5673496">is not a REPL</a> in the Lisp sense, but it&#8217;s a pretty good interactive shell. I&#8217;d rather work with a large Ruby app in IRB than via <code>rake</code>. </p>
<p> <a href="https://github.com/technomancy/leiningen/wiki/Faster">Start-up time</a> remains a major concern for Leiningen, and its contributors have gone to great lengths (sometimes <a href="https://github.com/technomancy/leiningen/pull/1230">too far</a>) to ameliorate it. Why not just avoid the problem altogether? Start Leiningen once and then work at the REPL. Admittedly, this takes some discipline and careful application design, but on my own projects I&#8217;ve gotten to the point where I only need to launch Leiningen once a day. Occasionally I make a mistake and get my application into such a borked state that the only remedy is restarting the JVM, but those occasions are rare. </p>
<p> I pretty much use Leiningen for just three things: 1) getting dependencies, 2) building JARs, and 3) launching REPLs. Once I have a REPL I can do my real work: running my application, testing, and profiling. The feedback cycles are faster and the debugging options much richer than what I can get on the command-line. </p>
<p> &#8220;Build plugins,&#8221; for Leiningen or Maven or any other tool, always suffer from running in a different environment from the code they are building. But isn&#8217;t one of the central tenets of Lisp that the compiler is <i>part of</i> your application? There isn&#8217;t really a sharp boundary between &#8220;build&#8221; code and &#8220;application&#8221; code. It&#8217;s all just code. </p>
<p> I used to write little &#8220;command-line interfaces&#8221; for running tests, builds, deployments, and so on. Now I&#8217;m more likely to just put those functions in a Clojure namespace and call them from the REPL. Sometimes I wonder: why not go further? Use Leiningen (or Maven, or Gradle, or whatever) just to download dependencies and bootstrap a REPL, then execute builds and releases <i>from the REPL</i>. </p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/11/04/command-line-intransigence.html" rel="bookmark"><time class="entry-date published" datetime="2013-11-04T08:32:33+00:00">November 4, 2013</time><time class="updated" datetime="2014-01-01T12:05:19+00:00">January 1, 2014</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/build-tools.html" rel="tag">build tools</a>, <a href="../tag/clojure.html" rel="tag">Clojure</a>, <a href="../tag/java.html" rel="tag">Java</a>, <a href="../tag/lisp.html" rel="tag">Lisp</a>, <a href="../tag/maven.html" rel="tag">Maven</a>, <a href="../tag/workflow.html" rel="tag">workflow</a></span><span class="comments-link"><a href="../2013/11/04/command-line-intransigence.html#comments">7 Comments<span class="screen-reader-text"> on Command-Line Intransigence</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-741" class="post-741 post type-post status-publish format-standard hentry category-programming tag-clojure tag-components tag-lifecycle tag-workflow">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/09/15/lifecycle-composition.html" rel="bookmark">Lifecycle Composition</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>
I&#8217;ve been thinking about how to build up software systems out of<br />
stateful components. In past <a href="http://www.infoq.com/presentations/Clojure-Large-scale-patterns-techniques">presentations</a> and <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">blog posts</a> I&#8217;ve alluded<br />
to a standard interface I use for starting and stopping stateful<br />
components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this] <span class="org-string">"Begins operation of this component."</span>)
  (stop [this] <span class="org-string">"Ceases operation of this component."</span>))
</pre>
</div>
<p>
Most of my Clojure programs follow the same basic structure: Each<br />
subsystem or service is represented by a record which implements this<br />
protocol. At the top, there is a &#8220;system&#8221; record which contains all<br />
the other components.
</p>
<p>
I&#8217;ve gone through several versions of this protocol with the same<br />
function names but slightly different semantics.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Side Effects, Mutable State</h2>
<div class="outline-text-2" id="text-1">
<p>
In the first version, <code>start</code> and <code>stop</code> were side-effecting<br />
procedures which returned a future or promise:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Asynchronous, returns a</span>
<span class="org-string">  promise on which the caller can block to wait until the component is</span>
<span class="org-string">  started."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Asynchronous, returns a</span>
<span class="org-string">  promise on which the caller can block to wait until the component is</span>
<span class="org-string">  stopped."</span>))
</pre>
</div>
<p>
The calling code could dereference the future to block until the<br />
service had successfully started. For example, a database-access<br />
component might look like this:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">Database</span> [uri connection-atom]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (<span class="org-builtin">future</span> (<span class="org-builtin">reset!</span> connection-atom (connect uri))))
  (stop [_]
    (<span class="org-preprocessor">.close</span> @connection-atom)
    (<span class="org-builtin">future</span> (<span class="org-builtin">reset!</span> connection-atom nil))))

(<span class="org-keyword">defn</span> <span class="org-function-name">database</span> [uri]
  (-&gt;<span class="org-preprocessor">Database</span> uri (<span class="org-builtin">atom</span> nil)))
</pre>
</div>
<p>
My idea was that multiple services could be started in parallel if<br />
they didn&#8217;t depend on one another, but in practice I always ended up<br />
blocking on every call to <code>start</code>:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (<span class="org-builtin">future</span>
      @(start database)
      @(start scheduler)
      @(start web)))
  (stop [_]
    (<span class="org-builtin">future</span>
      @(stop web)
      @(stop scheduler)
      @(stop database))))

(<span class="org-keyword">defn</span> <span class="org-function-name">system</span> [database-uri]
  (<span class="org-keyword">let</span> [database (database database-uri)
        scheduler (scheduler)
        web (web-server database)]
    (-&gt;<span class="org-preprocessor">System</span> database scheduler web)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Second Attempt</h2>
<div class="outline-text-2" id="text-2">
<p>
I decided to drop the requirement to return a promise from start/stop,<br />
which meant that those functions became synchronous and had no return<br />
value:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is started."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is stopped."</span>))
</pre>
</div>
<p>
This simplified the code calling start/stop, because I didn&#8217;t have to<br />
worry about dereferencing any futures.
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (start database)
    (start scheduler)
    (start web))
  (stop [_]
    (stop web)
    (stop scheduler)
    (stop database)))
</pre>
</div>
<p>
This also made it very clear that I was using start/stop only for<br />
side-effects, forcing all of my components to contain mutable state.
</p>
<p>
Also, I had to manually place the calls to start/stop in the correct<br />
order, to ensure that components were not started before other<br />
components which depended on them.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Immutable Values</h2>
<div class="outline-text-2" id="text-3">
<p>
I decided to try to make the component objects more like immutable<br />
values by redefining start/stop to return updated versions of the<br />
components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is started. Returns an updated version of this</span>
<span class="org-string">  component."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is stopped. Returns an updated version of this</span>
<span class="org-string">  component."</span>))
</pre>
</div>
<p>
In this version, <code>start</code> and <code>stop</code> feel more like functions. They are<br />
still not <b>pure</b> functions, because they will have to execute<br />
side-effects such as connecting to a database or opening a web server<br />
port, but at least they return something meaningful.
</p>
<p>
This version has the added benefit of removing some mutable state, at<br />
the cost of making the start/stop implementations slightly more<br />
complicated. Now these functions have to return a new instance of the<br />
component record:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">Database</span> [uri connection]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">assoc</span> this <span class="org-constant">:connection</span> (connect uri)))
  (stop [this]
    (<span class="org-preprocessor">.close</span> connection)
    (<span class="org-builtin">assoc</span> this <span class="org-constant">:connection</span> nil)))

(<span class="org-keyword">defn</span> <span class="org-function-name">database</span> [uri]
  (-&gt;<span class="org-preprocessor">Database</span> uri nil))
</pre>
</div>
<p>
One interesting feature of this pattern is that the system record can<br />
<code>reduce</code> over its own keys to start/stop all the components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] start))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Keys are returned in the order they were declared.</span>
            (<span class="org-builtin">keys</span> this)))
  (stop [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] stop))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Reverse the order to stop.</span>
            (<span class="org-builtin">reverse</span> (<span class="org-builtin">keys</span> this)))))
</pre>
</div>
<p>
However, this relies on implementation behavior of Clojure records:<br />
the <code>keys</code> function will return the keys in the order they are<br />
declared in the record. I&#8217;m reluctant to rely on that undocumented<br />
behavior, so instead I&#8217;ll declare the ordering explicitly:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-function-name">component-order</span>
  [<span class="org-constant">:database</span> <span class="org-constant">:scheduler</span> <span class="org-constant">:web</span>])

(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] start))
            this
            component-order))
  (stop [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] stop))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Reverse the order to stop.</span>
            (<span class="org-builtin">reverse</span> component-order))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Dependency Order</h2>
<div class="outline-text-2" id="text-4">
<p>
I still don&#8217;t have good solution to specifying the order in which<br />
components must be started/stopped. I&#8217;ve tried building a graph of<br />
dependencies and computing the correct order. This would be similar to<br />
what <a href="https://github.com/clojure/tools.namespace">tools.namespace</a> does with namespaces. But I haven&#8217;t been able to<br />
come up with a good syntax for representing these relationships that<br />
isn&#8217;t more cumbersome than just declaring them in order.
</p>
<p>
I&#8217;ve also tried using Prismatic&#8217;s <a href="https://github.com/Prismatic/plumbing">Graph</a> library or my own <a href="https://github.com/stuartsierra/flow">Flow</a> library<br />
to define the graph of dependency relationships, but neither of those<br />
libraries can produce a structure that <b>remembers</b> the graph after it<br />
has computed its output, so I have no way to recover the dependency<br />
relationships after constructing the system object.
</p>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Dependency Injection and State</h2>
<div class="outline-text-2" id="text-5">
<p>
This technique is a form of dependency injection through constructors.<br />
The choice of whether to make the individual components mutable,<br />
stateful objects has an impact on how I can use them later on. In the<br />
original version of this pattern using mutable objects, each component<br />
gets stable references to other components it depends on. In the later<br />
version using immutable data structures, each component gets<br />
references to the <b>constructed</b> versions of other components it<br />
depends on, but not the <b>started</b> versions of those components,<br />
i.e. the values returned from <code>start</code>.
</p>
<p>
So far, this has not been a problem in the programs I write. For<br />
example, a Datomic database connection is always recoverable from the<br />
URI, so I don&#8217;t need to store it explicitly. But other components,<br />
particularly components which rely on external state to function<br />
properly, might need to be mutable so that their dependents can still<br />
use them via the references the received in their constructors. I<br />
could still have <code>start</code> and <code>stop</code> return new values, but they would<br />
also have to modify some mutable state (such as a Ref or Atom) along<br />
the way. As always, mutable objects muddy the distinction between<br />
<b>values</b> and <b>identities</b>.
</p>
<p>
I&#8217;ve also experimented with variations of <code>start</code> and <code>stop</code> that<br />
pass in other &#8220;started&#8221; components, but this was cumbersome and hard<br />
to generalize through a single interface.
</p>
<p>
So I don&#8217;t have a perfect system. It works well enough for the<br />
applications I&#8217;ve developed with it so far, and it facilitates my<br />
<a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">REPL-driven development workflow</a>, but I always have to adapt to<br />
circumstance. Eliminating mutable state is generally a good thing,<br />
but it can also be limiting, especially when you have to deal with<br />
<b>external</b> state.
</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/09/15/lifecycle-composition.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-09-15T08:37:28+00:00">September 15, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/clojure.html" rel="tag">Clojure</a>, <a href="../tag/components.html" rel="tag">components</a>, <a href="../tag/lifecycle.html" rel="tag">lifecycle</a>, <a href="../tag/workflow.html" rel="tag">workflow</a></span><span class="comments-link"><a href="../2013/09/15/lifecycle-composition.html#comments">7 Comments<span class="screen-reader-text"> on Lifecycle Composition</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-731" class="post-731 post type-post status-publish format-standard hentry category-programming tag-open-source-software tag-rant">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/07/28/the-amateur-problem.html" rel="bookmark">The Amateur Problem</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>
We have a problem. <i>We</i> are professional software developers who work with open-source software. The <i>problem</i> is that we are in the minority. Most open-source software is written by amateurs.
</p>
<p>
Every time a hot new technology comes on the scene, developers flock to it like ants to a picnic. Those early adopters are, by definition, people for whom choosing a new technology is less risky. Which means, mostly, that their work doesn&#8217;t really matter. Students, hobbyists, &#8220;personal&#8221; projects: nobody&#8217;s life or career is on the line. It doesn&#8217;t matter if the program is entirely correct, efficient, or scalable. It doesn&#8217;t matter if it ignores lots of edge cases.
</p>
<p>
I&#8217;ve been one of those amateurs. It&#8217;s fun. New technologies need amateurs. But as a technology matures, it attracts professionals with real jobs who do care about those details. And those professionals are immediately confronted with a world of open-source software written by amateurs.
</p>
<p>
I used to write code for myself. Since I started getting paid to write code for other people, I&#8217;ve become wary of code written by people writing for themselves. Every time I see a README that begins &#8220;X is a <i>dead simple</i> way to do Y,&#8221; I shudder. Nothing in software is simple. &#8220;Dead simple&#8221; tells me the author has &#8220;simplified&#8221; by &#8220;deadening&#8221; vast swaths of the problem space, either by making unfounded assumptions or by ignoring them completely.
</p>
<p>
We like to carp about &#8220;bloated&#8221; APIs in &#8220;mainstream&#8221; languages like Java. Truly, lots of APIs <i>are</i> more complicated than they need to be. But just because an API is big doesn&#8217;t mean it&#8217;s bloated. I <b>like</b> big APIs: they show me that someone has thought about, and probably encountered, all of the edges and corners in the problem space.
</p>
<p>
Simplifying assumptions do not belong in libraries; they belong in applications, where you know the boundaries of the problem space. On rare occasions, the ground of one problem is trod often enough to warrant a framework. Emphasis on <i>rare</i>. A framework is almost always unnecessary, and, in these days of rapidly-changing technological capabilities, likely to be obsolete before it&#8217;s finished.
</p>
<p>
Frameworks written by amateurs are the worst of the worst: brittle constructs that assume everything in service of one or two &#8220;dead simple&#8221; demos but collapse under the weight of a real-world application.
</p>
<p>
I don&#8217;t want to be a code snob. Let&#8217;s be amateurs. Let&#8217;s have fun. Explore. Learn. Publish code as we go. Show a solution to a problem without assuming it&#8217;s <b>the</b> solution. Be cognizant of and vocal about what assumptions we&#8217;re making. Don&#8217;t call something a <b>library</b> unless it really attempts to reach every nook and cranny of the problem space.
</p>
<p>
And don&#8217;t write frameworks. Ever. ;)
</p>
<p><strong>Update August 8, 2013:</strong> Based on the comments, I feel like too many people have gotten hung up on the words <em>amateur</em> and <em>professional</em>. Those were just convenient labels which I found amusing. The important difference is between &#8220;easy&#8221; single-purpose code and thorough, general-purpose code.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/07/28/the-amateur-problem.html" rel="bookmark"><time class="entry-date published" datetime="2013-07-28T14:00:27+00:00">July 28, 2013</time><time class="updated" datetime="2013-08-08T08:01:38+00:00">August 8, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/open-source-software.html" rel="tag">Open-Source Software</a>, <a href="../tag/rant.html" rel="tag">rant</a></span><span class="comments-link"><a href="../2013/07/28/the-amateur-problem.html#comments">16 Comments<span class="screen-reader-text"> on The Amateur Problem</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-721" class="post-721 post type-post status-publish format-standard hentry category-programming tag-clojure tag-workflow">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/06/04/my-clojure-workflow-reloaded.html" rel="bookmark">My Clojure Workflow, Reloaded</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>I have a new post up on the Relevance blog: <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">My Clojure Workflow, Reloaded</a>. It&#8217;s a description of how I work with Clojure interactively using the REPL, <a href="https://github.com/clojure/tools.namespace">tools.namespace</a>, and <a href="http://leiningen.org/">Leiningen</a>.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/06/04/my-clojure-workflow-reloaded.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-06-04T08:14:22+00:00">June 4, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/clojure.html" rel="tag">Clojure</a>, <a href="../tag/workflow.html" rel="tag">workflow</a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-710" class="post-710 post type-post status-publish format-standard hentry category-programming tag-clojure tag-patterns tag-scope">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/03/29/perils-of-dynamic-scope.html" rel="bookmark">On the Perils of Dynamic Scope</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p><i>Common Lisp the Language</i> (CLtL) devotes an entire chapter to the subject of <a href="http://www.cs.cmu.edu/Groups/AI/html/cltl/clm/node43.html">Scope and Extent</a>. It defines <b>scope</b> as the textual region of a program in which an entity may be used, where &#8220;entity&#8221; could be a symbol, a value, or something more abstract like a variable binding.
</p>
<p>
So scope is about <i>where</i> you can use something. CLtL defines two different kinds of scope:
</p>
<p>
<b>Lexical scope</b> is usually the body of a single expression like <code>let</code> or <code>defun</code>.
</p>
<p>
<b>Indefinite scope</b> is everything else, effectively the global set of symbols that exist in a program.
</p>
<p>
In contrast, <b>extent</b> is about <i>when</i>: it&#8217;s the interval of time during which something may be used. CLtL defines two different kinds of extent:
</p>
<p>
<b>Dynamic extent</b> refers to things that exist for a fixed period of time and are explicitly &#8220;destroyed&#8221; at the end of that period, usually when control returns to the code that created the thing.
</p>
<p>
<b>Indefinite extent</b> is everything else: things that get created, passed around, and eventually garbage-collected.
</p>
<p>
In any language with a garbage collector, most things have indefinite extent. You can create strings, lists, or hash tables and pass them around with impunity. When the garbage collector determines that you are done using something, it reclaims the memory. The process is, in most cases, completely transparent to you.
</p>
<p>
But what about the so-called <b>dynamic scope</b>? The authors of CLtL have this to say:
</p>
<blockquote>
<p>The term &#8220;dynamic scope&#8221; is a misnomer. Nevertheless it is both traditional and useful.
</p>
</blockquote>
<p>
They also define &#8220;dynamic scope&#8221; to be the combination of <i>indefinite scope</i> and <i>dynamic extent</i>. That is, things with dynamic scope are valid in any <i>place</i> in a program, but only for a limited <i>time</i>. In Common Lisp, these are called &#8220;special variables,&#8221; and are created with the macros <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defpar.htm"><code>defparameter</code> and <code>defvar</code></a>.
</p>
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Vars</h2>
<div class="outline-text-2" id="text-1">
<p>
So what does this have to do with Clojure? Clojure has these things called Vars. Every time you write <code>def</code> or <code>defn</code> or one of its variants in Clojure, you&#8217;re creating a Var.
</p>
<p>
Vars have <i>indefinite scope</i>: no matter where you <code>def</code> a Var, it&#8217;s visible everywhere in the program.<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>
</p>
<p>
Vars usually have <i>indefinite extent</i> as well. Usually. This is where things get tricky. Clojure, unlike Common Lisp, was designed for multi-threaded programs.<sup><a class="footref" name="fnr.2" href="#fn.2">2</a></sup> The meaning of <i>extent</i> gets a lot muddier in the face of multiple threads. Each thread has its own timeline, its own view of &#8220;now&#8221; which may or may not conform to any other thread&#8217;s view.
</p>
<p>
In Clojure versions 1.2 and earlier, <b>all</b> Vars had dynamic scope by default, but this meant that there was a performance cost to look up the current dynamic binding of a Var on every function call. Leading up to 1.3, Rich Hickey experimented with allowing Vars to be declared <code>^:static</code>, before settling on static by default with <code>^:dynamic</code> as an option. You can still find <code>^:static</code> declarations littered through the Clojure source code. Maybe someday they&#8217;ll be useful again.
</p>
<p>
The definition of &#8220;dynamic scope&#8221; in Clojure is even fuzzier than it is in Common Lisp. How do we define &#8220;extent&#8221; in the face of multiple threads, each potentially with its own thread-local binding? If a resource can be shared across multiple threads, we have to coordinate the cleanup of that resource. For example, if I open a socket and then hand it off to another piece of code, who is responsible for closing the socket?
</p>
<p>
Resource management is one concurrency bugaboo that Clojure developers have not managed to crack. Various attempts have been made: you can see the artifacts in wiki and mailing list discussions of <a href="http://dev.clojure.org/display/design/Resource+Scopes">Resource Scopes</a>. So far, no solution has been found that doesn&#8217;t just shift the problem somewhere else.
</p>
<p>
It ends up looking a bit like garbage collection: how do I track the path of every resource used by my program and ensure that it gets cleaned up at the appropriate time? But it&#8217;s even harder than that, because resources like file handles and sockets are much scarcer than memory: they need to be reclaimed as soon as possible. In a modern runtime like the JVM, garbage collection is stochastic: there&#8217;s no guarantee that it will happen at any particular time, or even that it will happen at all.
</p>
<p>
To make matters worse, Clojure has laziness to contend with. It&#8217;s entirely possible to obtain a resource, start consuming it via a lazy sequence, and <i>never finish</i> consuming it.
</p>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">The Wrong Solution</h2>
<div class="outline-text-2" id="text-2">
<p>
This brings me to one of my top <a href="http://c2.com/cgi/wiki?AntiPattern">anti-patterns</a> in Clojure: the Dynamically-Scoped Singleton Resource (DSSR).
</p>
<p>
The DSSR is popular in libraries that depend on some external resource such as a socket, file, or database connection. It typically looks like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">ns</span> com.example.library)

(<span class="org-keyword">def</span> <span class="org-constant">^:dynamic</span> <span class="org-function-name">*resource*</span>)

(<span class="org-keyword">defn-</span> <span class="org-function-name">internal-procedure</span> []
  <span class="org-comment-delimiter">;; </span><span class="org-comment">... uses *resource* ...</span>
  )

(<span class="org-keyword">defn</span> <span class="org-function-name">public-api-function</span> [arg]
  <span class="org-comment-delimiter">;; </span><span class="org-comment">... calls internal-procedure ...</span>
  )
</pre>
<p>
That is, there is a single dynamic Var holding the &#8220;resource&#8221; on which the rest of the API operates. The DSSR is often accompanied by a <code>with-*</code> macro:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defmacro</span> <span class="org-function-name">with-resource</span> [src &amp; body]
  `(<span class="org-keyword">binding</span> [*resource* (acquire src)]
     (<span class="org-keyword">try</span> ~@body
       (<span class="org-keyword">finally</span>
         (dispose *resource*)))))
</pre>
<p>
This looks harmless enough. It&#8217;s practically a carbon copy of Clojure&#8217;s <code>with-open</code> macro, and it ensures that the resource will get cleaned up even if <code>body</code> throws an exception.
</p>
<p>
The problem with this pattern, especially in libraries, is the constraints it imposes on any code that wants to use the library. The <code>with-resource</code> macro severely constrains what you can do in the <code>body</code>:
</p>
<p>
<b>You can&#8217;t dispatch to another thread.</b> Say goodbye to Agents, Futures, thread pools, non-blocking I/O, or any other kind of asynchrony. The resource is only valid on the current thread.<sup><a class="footref" name="fnr.3" href="#fn.3">3</a></sup>
</p>
<p>
<b>You can&#8217;t return a lazy sequence</b> backed by the resource because the resource will be destroyed as soon as <code>body</code> returns.
</p>
<p>
<b>You can&#8217;t have more than one resource at a time.</b> Hence the &#8220;singleton&#8221; in the name of this pattern. Using a thread-bound Var throughout the API means that you can never operate on more than one instance of the resource in a single thread. Lots of apps need to work with multiple databases, which really sucks using this kind of library.
</p>
<p>
The last problem with this pattern is a more subtle one: <b>hidden dependencies</b>. The public API functions, which have global scope, depend on the state (thread-local binding) of another Var with global scope. This dependency isn&#8217;t explicitly stated anywhere in the definition of those functions. That might not seem like such a big deal in small examples, and it isn&#8217;t. But as programs (and development teams) grow larger, it&#8217;s one additional piece of implicit knowledge that you have to keep in your head. If there are seventeen layers of function calls between the resource binding and its usage, how certain are you going to be that the resource has the right extent?
</p>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Friends Don&#8217;t Let Friends Use Dynamic Scope</h2>
<div class="outline-text-2" id="text-3">
<p>
The alternative is easy: don&#8217;t do it. Don&#8217;t try to &#8220;solve&#8221; resource management in every library.
</p>
<p>
By all means, provide the functions to acquire and dispose of resources, but then let the application programmer decide what to do with them. Define API functions to take the resource as an argument.
</p>
<p>
Applications can manage their own resources, and only the application programmer knows what the extent of those resources should be. Maybe you can pass it around as a value. Maybe you want to use dynamic binding after all. Maybe you want to stash it in a global state Var.<sup><a class="footref" name="fnr.4" href="#fn.4">4</a></sup> That&#8217;s for you to decide.
</p>
<p>
<a href="http://datomic.com/">Datomic</a> is a good example to follow: it creates connection objects that have a lot of state attached to them &mdash; sockets, queues, and threads. But it says nothing about how you should manage the extent of those connections.<sup><a class="footref" name="fnr.5" href="#fn.5">5</a></sup> Most functions in the <a href="http://docs.datomic.com/clojure/index.html">Datomic API</a> take either a connection or a database (a value obtained from the connection) as an argument.
</p>
</div>
</div>
<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Safe Dynamic Scope</h2>
<div class="outline-text-2" id="text-4">
<p>
So dynamic scope is totally evil, right? Not totally. There are situations where dynamic scope can be helpful without causing the cascade of problems I described above.
</p>
<p>
Remember that dynamic scope in Clojure is really <i>thread-local binding</i>. Therefore, it&#8217;s best suited to operations that are <i>confined to a single thread</i>. There are plenty of examples of this: most popular algorithms are single-threaded, after all. Consider the classic <a href="http://www.cs.engr.uky.edu/~lewis/essays/compilers/rec-des.html">recursive-descent parser</a>: you start with one function call at the top and you&#8217;re not done until that function returns. The entire operation happens on a single thread, in a single call stack. It has <b>dynamic extent</b>.
</p>
<p>
I took advantage of this fact in a <a href="https://github.com/clojure/data.json">Clojure JSON parser</a>. There were a number of control flags that I needed to make available to all the functions. Rather than pass around extra arguments all over the place, I created <a href="https://github.com/clojure/data.json/blob/data.json-0.2.1/src/main/clojure/clojure/data/json.clj#L20-L22">private dynamic Vars</a> to hold them. Those Vars get <a href="https://github.com/clojure/data.json/blob/data.json-0.2.1/src/main/clojure/clojure/data/json.clj#L263-L265">bound in the entry-point</a> to the parser, based on options passed in as arguments to the public API function. The thread-local state never leaks out of the initial function call.
</p>
<p>
As another example, the Clojure compiler, although written in Java, <a href="https://github.com/clojure/clojure/blob/clojure-1.5.1/src/jvm/clojure/lang/Compiler.java#L181-L203">uses dynamic Vars</a> to keep track of internal state.
</p>
<p>
And what about our friend <code>with-open</code>? I said that the example <code>with-resource</code> macro was nearly a copy of it, but only nearly. <code>clojure.core/with-open</code> creates <b>lexical</b> (i.e. local) bindings. It still suffers from some limitations around what you can do in the body, but at least it doesn&#8217;t limit you to one resource at a time.
</p>
<p>
Global state is the zombie in the closet of every Clojure program, about which I&#8217;ll have more to say in future posts. For now, I hope I&#8217;ve convinced you that dynamic scope is easily abused and has a lot of unintended consequences.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> Technically, a Var is visible only <b>after</b> the point at which it was defined. This is significant with regard to the order of definitions, but Vars are still globally visible once they have been defined.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.2" href="#fnr.2">2</a></sup> CLtL has this note embedded in the chapter on scope and extent: &#8220;Behind the assertion that dynamic extents nest properly is the assumption that there is only a single program or process. Common Lisp does not address the problems of multiprogramming (timesharing) or multiprocessing (more than one active processor) within a single Lisp environment.&#8221; Modern Common Lisp implementations have added multi-threading, but it remains absent from the language specification.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.3" href="#fnr.3">3</a></sup> You can use <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/bound-fn">bound-fn</a> to capture the bindings and pass them to another thread, but you still have the problem that the resource may be destroyed before the other thread is finished with it.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.4" href="#fnr.4">4</a></sup> Not recommended, to be discussed in a future post.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.5" href="#fnr.5">5</a></sup> There&#8217;s some caching of connection objects under the hood, but this is not relevant to the consumer.
</p>
</div>
</div>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/03/29/perils-of-dynamic-scope.html" rel="bookmark"><time class="entry-date published" datetime="2013-03-29T08:00:52+00:00">March 29, 2013</time><time class="updated" datetime="2013-03-28T20:10:34+00:00">March 28, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/clojure.html" rel="tag">Clojure</a>, <a href="../tag/patterns.html" rel="tag">patterns</a>, <a href="../tag/scope.html" rel="tag">scope</a></span><span class="comments-link"><a href="../2013/03/29/perils-of-dynamic-scope.html#comments">11 Comments<span class="screen-reader-text"> on On the Perils of Dynamic Scope</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-693" class="post-693 post type-post status-publish format-standard hentry category-programming tag-clojure">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/02/04/affordance-concision.html" rel="bookmark">Affordance and Concision</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Quick, Clojure programmers, what does the following expression do?
</p>
<pre class="src src-clojure">(<span class="org-builtin">get</span> x k)
</pre>
<p>
If you answered, <i>It looks up the key <code>k</code> in an associative data structure <code>x</code> and returns its associated value</i>, you&#8217;re right, but only partially.
</p>
<p>
What if <code>x</code> is not an associative data structure? In every released version of Clojure up to and including 1.5.0, <code>get</code> will return <code>nil</code> in that case.
</p>
<p>
Is that a bug or a feature? It can certainly lead to some hard-to-find bugs, such as this one which I&#8217;ve often found in my own code:
</p>
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-function-name">person</span> (<span class="org-builtin">ref</span> {<span class="org-constant">:name</span> <span class="org-string">"Stuart"</span> <span class="org-constant">:job</span> <span class="org-string">"Programmer"</span>}))

(<span class="org-builtin">get</span> person <span class="org-constant">:name</span>)
<span class="org-comment-delimiter">;;</span><span class="org-comment">=&gt; nil</span>
</pre>
<p>
Spot the bug? <code>person</code> is not a map but rather a Ref whose state is a map. I should have written <code>(get @person :name)</code>. One character between triumph and defeat! To make matters worse, that <code>nil</code> might not show up until it triggers a NullPointerException several pages of code later.
</p>
<p>
It turns out that several core functions in Clojure behave this way: if called on an object which does not implement the correct interface, they return <code>nil</code> rather than throwing an exception.
</p>
<p>
The <code>contains?</code> function is a more bothersome example. Not only is the name difficult to remember &mdash; it&#8217;s an associative function that checks for keys, not a linear search of values like <a href="http://docs.oracle.com/javase/7/docs/api/java/util/Collection.html#contains(java.lang.Object)">java.util.Collection#contains</a> &mdash; but it also returns <code>nil</code> on functions which do not implement <a href="https://github.com/clojure/clojure/blob/clojure-1.4.0/src/jvm/clojure/lang/Associative.java">clojure.lang.Associative</a>. Or at least it did up through Clojure 1.4.0. I submitted a <a href="https://github.com/clojure/clojure/commit/3acb6ee7ec5c295ae14de861d03a5efd115a5968">patch</a> (<a href="http://dev.clojure.org/jira/browse/CLJ-932">CLJ-932</a>), included in Clojure 1.5.0, which changed <code>contains?</code> to throw an exception instead.<a class="footref" name="fnr.1" href="#fn.1">[1]</a>
</p>
<p>
I submitted a similar patch (<a href="http://dev.clojure.org/jira/browse/CLJ-1107">CLJ-1107</a>) to do the same thing for <code>get</code>, but not in time for consideration in the 1.5.0 release.
</p>
<p>
A few weeks later, I was writing some code that looked like this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">my-type</span> [x]
  (<span class="org-keyword">or</span> (<span class="org-builtin">get</span> x <span class="org-constant">:my-namespace/type</span>)
      (<span class="org-builtin">get</span> (<span class="org-builtin">meta</span> x) <span class="org-constant">:my-namespace/type</span>)
      (<span class="org-builtin">get</span> x <span class="org-constant">:type</span>)
      (clojure.core/<span class="org-builtin">type</span> x)))
</pre>
<p>
I wanted a flexible definition of &#8220;type&#8221; which worked on maps or records with different possible keys, falling back on the <code>clojure.core/type</code> function, which looks for a <code>:type</code> key in metadata before falling back to <code>clojure.core/class</code>.
</p>
<p>
Before the patch to <code>get</code> in CLJ-1107, this code works perfectly well. After the patch, it won&#8217;t. I would have to write this instead:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">my-type</span> [x]
  (<span class="org-keyword">or</span> (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:my-namespace/type</span>))
      (<span class="org-builtin">get</span> (<span class="org-builtin">meta</span> x) <span class="org-constant">:my-namespace/type</span>)
      (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:type</span>))
      (clojure.core/<span class="org-builtin">type</span> x)))
</pre>
<p>
But wait! The <code>meta</code> function also returns <code>nil</code> for objects which do not support metadata. Maybe that should be &#8220;fixed&#8221; too. Then I would have to write this:
</p>
<pre class="src src-clojure">(<span class="org-keyword">defn</span> <span class="org-function-name">my-type</span> [x]
  (<span class="org-keyword">or</span> (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:my-namespace/type</span>))
      (<span class="org-keyword">when</span> (<span class="org-builtin">instance?</span> x <span class="org-preprocessor">clojure.lang.IMeta</span>)
        (<span class="org-builtin">get</span> (<span class="org-builtin">meta</span> x) <span class="org-constant">:my-namespace/type</span>))
      (<span class="org-keyword">when</span> (<span class="org-builtin">associative?</span> x)
        (<span class="org-builtin">get</span> x <span class="org-constant">:type</span>))
      (clojure.core/<span class="org-builtin">type</span> x)))
</pre>
<p>
And so on.
</p>
<p>
Every language decision means trade-offs. Clojure accepts <code>nil</code> as a logical false value in boolean contexts, like Common Lisp (and also many scripting languages). This &#8220;nil punning&#8221; enables a concise style in which <code>nil</code> stands in for an empty collection or missing data.<a class="footref" name="fnr.2" href="#fn.2">[2]</a> For example, Clojure 1.5.0 introduces two new macros <a href="https://github.com/clojure/clojure/blob/clojure-1.5.0-RC4/src/clj/clojure/core.clj#L6785-L6805"><code>some-&gt;</code> and <code>some-&gt;&gt;</code></a>, which keep evaluating expressions until one of them returns <code>nil</code>.
</p>
<p>
Is Clojure&#8217;s <code>get</code> wrong? It depends on what you think <code>get</code> should mean. If you&#8217;re a fan of more strictly-typed functional languages you might think <code>get</code> should be defined to return an instance of the <code>Maybe</code> monad:
</p>
<pre class="example">
;; made-up syntax:
get [Associative⟨K,V⟩, K] → Maybe⟨V⟩
</pre>
<p>
You can implement the <a href="http://onclojure.com/2009/03/05/a-monad-tutorial-for-clojure-programmers-part-1/">Maybe monad in Clojure</a>, but there&#8217;s less motivation to do so without the support of a static type checker. You could also argue that, since Clojure is dynamically-typed, <code>get</code> can have a more general type:
</p>
<pre class="example">
;; made-up syntax:
get [Any, Any] → Any | nil
</pre>
<p>
This latter definition is effectively the type of <code>get</code> in Clojure right now.
</p>
<p>
Which form is better is a matter of taste. What I do know is that the current behavior of <code>get</code> doesn&#8217;t give much <i>affordance</i> to a Clojure programmer, even an experienced one.<a class="footref" name="fnr.3" href="#fn.3">[3]</a>
</p>
<p>
Again, tradeoffs. Clojure&#8217;s definition of <code>get</code> is flexible but can lead to subtle bugs. The stricter version would be safer but less flexible.
</p>
<p>
An even stricter version of <code>get</code> would throw an exception if the key is not present instead of returning <code>nil</code>. Sometimes that&#8217;s what you want. The <a href="https://github.com/Datomic/simulant">Simulant testing framework</a> defines a utility function <a href="https://github.com/Datomic/simulant/blob/4d4580460a6aea917b74a923060c99dae906b3fc/src/simulant/util.clj#L23-L30"><code>getx</code></a> that does just that.
</p>
<p>
Over the past five years, Rich Hickey has gradually led Clojure in the direction of &#8220;fast but correct by default.&#8221; This is particularly evident in the <a href="http://dev.clojure.org/display/doc/Documentation+for+1.3+Numerics">numeric primitives since release 1.3.0</a>, which throw an exception on overflow (correct) but do not automatically promote from fixed- to arbitrary-precision types (slow).
</p>
<p>
I believe the change to <code>get</code> in CLJ-1107 will ultimately be more help than hindrance. But it might also be useful to have a function which retains the &#8220;more dynamic&#8221; behavior. We might call it <code>get'</code> in the manner of the auto-promoting arithmetic functions such as <code>+'</code>. Or perhaps, with some cleverness, we could define a higher order function that transforms <i>any</i> function into a function that returns <code>nil</code> when called on a type it does not support. This would be similar in spirit to <a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/fnil"><code>fnil</code></a> but harder to define.<a class="footref" name="fnr.4" href="#fn.4">[4]</a>
</p>
<p><strong>Update #1:</strong> changed <code>(instance? x clojure.lang.Associative)</code> to <code>(associative? x)</code>, suggested by Luke VanderHart.</p>
<p><strong>Update #2:</strong> Some readers have pointed out that I could make <code>my-type</code>  polymorphic, thereby avoiding the conditional checks. But that would be even longer and, in my opinion, more complicated than the conditional version. The <code>get</code> function is already polymorphic, a fact which I exploited in the original definition of <code>my-type</code>. It&#8217;s a contrived example anyway, not a cogent design.</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><a class="footnum" name="fn.1" href="#fnr.1">[1]</a> We can&#8217;t do anything about the name of <code>contains?</code> without breaking a lot more code. This change, at least, is unlikely to break any code that wasn&#8217;t already broken.
</p>
<p class="footnote"><a class="footnum" name="fn.2" href="#fnr.2">[2]</a> There&#8217;s a <a href="http://www.apl.jhu.edu/~hall/lisp/Scheme-Ballad.text">cute poem about nil-punning</a> in Common Lisp versus Scheme or T.
</p>
<p class="footnote"><a class="footnum" name="fn.3" href="#fnr.3">[3]</a> I am slightly abusing the <a href="http://en.wikipedia.org/wiki/Affordance">definition of affordance</a> here, but I think it works to convey what I mean: the implementation of <code>get</code> in the Clojure runtime does not help me to write my code correctly.
</p>
<p class="footnote"><a class="footnum" name="fn.4" href="#fnr.4">[4]</a> I don&#8217;t actually know how to do it without catching <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/IllegalArgumentException.html">IllegalArgumentException</a>, which would be bad for performance and potentially too broad. Left as an exercise for the reader!
</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/02/04/affordance-concision.html" rel="bookmark"><time class="entry-date published" datetime="2013-02-04T08:28:52+00:00">February 4, 2013</time><time class="updated" datetime="2013-02-04T20:45:12+00:00">February 4, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/clojure.html" rel="tag">Clojure</a></span><span class="comments-link"><a href="../2013/02/04/affordance-concision.html#comments">3 Comments<span class="screen-reader-text"> on Affordance and Concision</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-688" class="post-688 post type-post status-publish format-standard hentry category-programming tag-rant tag-versioning">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/01/28/brief-rant-about-versioning.html" rel="bookmark">A Brief Rant About Versioning</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Version numbers are meaningless. By that, I mean they convey no useful information. Oh sure, there are conventions: <i>major.minor.patch</i>, even/odd for stable/development versions, and designations like <i>release candidate</i>. But they&#8217;re just conventions. Version numbers are chosen by people, so they are subject to all the idiosyncrasies and whims of individuals.
</p>
<p>
<a href="http://semver.org/">Semantic Versioning</a>, you say? Pshaw. Nobody does semantic versioning. If they did, we&#8217;d see dozens of libraries and applications with major-version numbers in the double or triple digits. It&#8217;s almost impossible to change software without breaking <b>something</b>. Even a change which is technically a bugfix can easily break a downstream consumer that relied, intentionally or not, on the buggy behavior.
</p>
<p>
That&#8217;s not to say you shouldn&#8217;t <i>try</i> to follow semantic versioning. It&#8217;s a good idea, and even its author admits that some versioning decisions boil down to <i>Use your best judgment</i>.
</p>
<p>
The trouble with semantic versioning is that everyone want <b>others</b> to follow it, but no one wants to follow it themselves. Everyone thinks <i>there&#8217;s room for one more quick fix</i>, or <i>this change isn&#8217;t big enough to warrant a major-version bump</i>, or simply <i>my project is special</i>. It&#8217;s a slippery slope from there to redesigning your entire API between versions <i>2.7.4-RC13</i> and <i>2.7.4-RC14</i>.
</p>
<p>
Everybody does it. I could name names, but that would be redundant. I&#8217;m not sitting in a glass house here, either. I caught major flack for breaking the API of a JSON parser &ndash; a JSON parser! &ndash; between two <i>0.x</i> releases. People don&#8217;t like change, even improvements, if it means the tiniest bit more work for them. Even if the new API is cleaner and more logical, even if you change things that were never explicitly promised by the old API, there will be grumbles and calls for your resignation. It&#8217;s enough to make you want to stop releasing things altogether, or to throw up your hands and just <a href="http://dev.clojure.org/display/design/ClojureScript+Releases">number all your releases sequentially</a>, or to go totally off the reservation a have your version numbers <a href="http://www.tex.ac.uk/cgi-bin/texfaq2html?label=TeXfuture">converge towards an irrational constant</a>.
</p>
<p><strong>Did I mention this was a rant? Please don&#8217;t take it too seriously.</strong></p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/01/28/brief-rant-about-versioning.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-01-28T10:07:37+00:00">January 28, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/rant.html" rel="tag">rant</a>, <a href="../tag/versioning.html" rel="tag">versioning</a></span><span class="comments-link"><a href="../2013/01/28/brief-rant-about-versioning.html#comments">6 Comments<span class="screen-reader-text"> on A Brief Rant About Versioning</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-677" class="post-677 post type-post status-publish format-standard hentry category-programming tag-open-source">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="../2013/01/16/the-reluctant-dictator.html" rel="bookmark">The Reluctant Dictator</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>I have a confession to make. I&#8217;m bad at open-source. Not writing the code. I&#8217;m pretty good at that. I can even write pretty good documentation. I&#8217;m bad at all the rest: patches, mailing lists, chat rooms, bug reports, and anything else that might fall under the heading of &#8220;community.&#8221; I&#8217;m more than bad at it: I don&#8217;t like doing it and generally try to avoid it.
</p>
<p>
I write software to scratch an itch. I release it as open-source in the vague hope that someone else might find it useful. But once I&#8217;ve scratched the itch, I&#8217;m no longer interested. I don&#8217;t want to found a &#8220;community&#8221; or try to herd a bunch of belligerent, independent-minded cats. I&#8217;m not in it for the money. I&#8217;m not even in it for the fame and recognition. (OK, maybe a little bit for the fame.)
</p>
<p>
But this age of &#8220;social&#8221; insists that <b>everything</b> be a community. Deoderant brands beg us to &#8220;like&#8221; their Facebook pages and advertising campaigns come accesorized with Twitter hash tags. In software, you can&#8217;t just release a bit of code as open-source. You have to create a Google Group and a blog and an IRC channel and a novelty Twitter account too.
</p>
<p>
The infrastructure of &#8220;social coding&#8221; has codified this trend into an expectation that every piece of open-source software participate in a world-wide collaboration / popularity contest. The only feature of <a href="https://github.com/">GitHub</a> that can&#8217;t be turned off is the <i>pull request</i>.
</p>
<p>
Don&#8217;t get me wrong, I love GitHub and use it every day. On work projects, I find pull requests to be an efficient tool for doing code reviews. GitHub&#8217;s collaboration tools are great when you&#8217;re only trying to collaborate with a handful of people, all of whom are working towards a common, mutually-understood goal.
</p>
<p>
But when it comes to open-source work, I use GitHub primarily as a hosting platform.<a class="footref" name="fnr.1" href="#fn.1">[1]</a> I put code on GitHub because I want people to be able to find it, and use it if it helps them. I want them to fork it, fix it, and improve it. But I don&#8217;t want to be bothered with it. If you added something new to my code, great! It&#8217;s open-source &ndash; have at it!
</p>
<p>
I&#8217;m puzzled by people who write to me saying, &#8220;If I were to write a patch for your library <i>X</i> to make it do <i>Y</i>, would you accept it?&#8221; First of all, you don&#8217;t need my or anybody else&#8217;s permission to modify my code. That&#8217;s the whole point of open-source! Secondly, how can I decide whether or not I&#8217;ll accept a patch I haven&#8217;t seen yet? Finally, if you do decide to send me a pull request, please don&#8217;t be offended if I don&#8217;t accept it, or if I ignore it for six months and then take the idea and rewrite it myself.
</p>
<p>
Why didn&#8217;t I accept your pull request? Not because I want to hog all the glory for myself. Not because I want to keep you out of my exclusive open-source masters&#8217; club. Not even because I can find any technical fault with your implementation. I&#8217;ve just got other things to do, other itches to scratch.
</p>
<p>
If everyone thought that way, would open-source still work? Probably. Maybe not as well.
</p>
<p>
To be sure, there&#8217;s a big difference between one-off utilities written in a weekend and major projects sustained for years by well-funded organizations. Managing a world-wide collaborative open-source project is a full-time job. The benevolent-dictator-for-life needs an equally-benevolent corporate-sponsor-for-life.<a class="footref" name="fnr.2" href="#fn.2">[2]</a> You can&#8217;t expect the same kind of support from individuals working in their spare time, for free.
</p>
<p>
I sometimes dream of an open-source collaboration model that is truly <i>pull</i>-based instead of GitHub&#8217;s <i>they-should-have-called-it-push request</i>. I don&#8217;t want to be forced to look at anything on any particular schedule. Don&#8217;t give me &#8220;notifications&#8221; or send me email. Instead, and only when I ask for it, allow me to browse the network of forks spawned by my code. Let me see who copied it, how they used it, and how they modified it. Be explicit about who owns the modifications and under what terms I can copy them back into my own project. And not just direct forks &mdash; show me all the places where my code was copied-and-pasted too.
</p>
<p>
Imagine if you could free open-source developers from all the time spent on mailing lists, IRC, bug trackers, wikis, pull requests, comment threads, and patches and channel all that energy into <i>solving problems</i>. Who knows? We might even solve the hard problems, like <a href="https://twitter.com/stuartsierra/status/159741771075694594">dependency management</a>.
</p>
<p><strong>Update Jan 17, 8:52am EST:</strong> I should mention that I have nothing but admiration and respect for people who are good at the organizational/community aspects of open-source software. I&#8217;m just not one of them.</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><a class="footnum" name="fn.1" href="#fnr.1">[1]</a> I&#8217;m not the only one. Linus Torvalds famously pointed out <a href="https://github.com/torvalds/linux/pull/17">flaws in the GitHub pull-request model</a>, in particular its poor support for more rigorous submission/signoff processes.
</p>
<p class="footnote"><a class="footnum" name="fn.2" href="#fnr.2">[2]</a> Even with a cushy corporate sponsor, accepting patches is a far more work than the authors of those patches typically realize. See <a href="https://plus.google.com/113026104107031516488/posts/ZRdtjTL1MpM">The story with #guava and your patches</a>.</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="../2013/01/16/the-reluctant-dictator.html" rel="bookmark"><time class="entry-date published" datetime="2013-01-16T22:02:23+00:00">January 16, 2013</time><time class="updated" datetime="2013-01-17T08:53:02+00:00">January 17, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../tag/open-source.html" rel="tag">open-source</a></span><span class="comments-link"><a href="../2013/01/16/the-reluctant-dictator.html#comments">11 Comments<span class="screen-reader-text"> on The Reluctant Dictator</span></a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

	<nav class="navigation pagination" role="navigation">
		<h2 class="screen-reader-text">Posts navigation</h2>
		<div class="nav-links"><a class="prev page-numbers" href="2.html">Previous page</a>
<a class='page-numbers' href='../index.html'><span class="meta-nav screen-reader-text">Page </span>1</a>
<a class='page-numbers' href='2.html'><span class="meta-nav screen-reader-text">Page </span>2</a>
<span class='page-numbers current'><span class="meta-nav screen-reader-text">Page </span>3</span>
<a class='page-numbers' href='4.html'><span class="meta-nav screen-reader-text">Page </span>4</a>
<span class="page-numbers dots">&hellip;</span>
<a class='page-numbers' href='24.html'><span class="meta-nav screen-reader-text">Page </span>24</a>
<a class="next page-numbers" href="4.html">Next page</a></div>
	</nav>
		</main><!-- .site-main -->
	</div><!-- .content-area -->


	<aside id="secondary" class="sidebar widget-area" role="complementary">
		<section id="search-3" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://stuartsierra.com/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
	</label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">Search</span></button>
</form>
</section><section id="text-4" class="widget widget_text">			<div class="textwidget"><ul>
<li><a href="http://feeds2.feedburner.com/StuartSierra" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="../comments/feed" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
</ul>
<ul>
<li><a href="https://twitter.com/stuartsierra">Twitter</a></li>
<li><a href="https://github.com/stuartsierra">GitHub</a></li>
</ul></div>
		</section><section id="tag-widget-2" class="widget TagWidget"><h2 class="widget-title">Clojure Do’s and Don’ts</h2><ul class = "posts-by-tag-list"><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-883"><a class = "posts-by-tag-item-title" href="../2015/08/25/clojure-donts-lazy-effects.html">Clojure Don’ts: Lazy Effects</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-877"><a class = "posts-by-tag-item-title" href="../2015/08/10/clojure-donts-redundant-map.html">Clojure Don’ts: Redundant map</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-870"><a class = "posts-by-tag-item-title" href="../2015/06/16/clojure-donts-single-branch-if.html">Clojure Don’ts: Single-branch if</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-854"><a class = "posts-by-tag-item-title" href="../2015/06/10/clojure-donts-heisenparameter.html">Clojure Don’ts: The Heisenparameter</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-849"><a class = "posts-by-tag-item-title" href="../2015/06/01/clojure-donts-optional-arguments-with-varargs.html">Clojure Don’ts: Optional Arguments with Varargs</a></li><li class="posts-by-tag-item Clojure do's and don'ts errors" id="posts-by-tag-item-836"><a class = "posts-by-tag-item-title" href="../2015/05/27/clojure-uncaught-exceptions.html">Clojure Do’s: Uncaught Exceptions</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-831"><a class = "posts-by-tag-item-title" href="../2015/05/17/clojure-record-constructors.html">Record Constructors</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-826"><a class = "posts-by-tag-item-title" href="../2015/05/10/clojure-namespace-aliases.html">Clojure Do’s: Namespace Aliases</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-820"><a class = "posts-by-tag-item-title" href="../2015/05/02/clojure-donts-isa.html">Clojure Don’ts: isa?</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-812"><a class = "posts-by-tag-item-title" href="../2015/04/26/clojure-donts-concat.html">Clojure Don’ts: Concat</a></li></ul></section>	</aside><!-- .sidebar .widget-area -->

		</div><!-- .site-content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
							<nav class="main-navigation" role="navigation" aria-label="Footer Primary Menu">
					<div class="menu-main-menu-container"><ul id="menu-main-menu-1" class="primary-menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../about-me.html">About Me</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../writing.html">Writing</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../presentations.html">Presentations</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../software.html">Software</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../contact.html">Contact</a></li>
</ul></div>				</nav><!-- .main-navigation -->
			
			
			<div class="site-info">
								<span class="site-title"><a href="../index.html" rel="home">Digital Digressions by Stuart Sierra</a></span>
				<a href="https://wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- .site-footer -->
	</div><!-- .site-inner -->
</div><!-- .site -->

	<div style="display:none">
	<div class="grofile-hash-map-55878d0196b91803f9cb2c372b0551d3">
	</div>
	</div>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201635'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2016Sepaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../wp-content/plugins/jetpack/modules/wpgroho167b.js?ver=4.6'></script>
<script type='text/javascript' src='../wp-content/themes/twentysixteen/js/skip-link-focus-fix8de4.js?ver=20160816'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
/* ]]> */
</script>
<script type='text/javascript' src='../wp-content/themes/twentysixteen/js/functions8de4.js?ver=20160816'></script>
<script type='text/javascript' src='../wp-includes/js/wp-embed.min167b.js?ver=4.6'></script>
<script type='text/javascript' src='https://stats.wp.com/e-201635.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.2.2',blog:'2702563',post:'0',tz:'-4',srv:'stuartsierra.com'} ]);
	_stq.push([ 'clickTrackerInit', '2702563', '0' ]);
</script>
</body>

<!-- Mirrored from stuartsierra.com/page/3 by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 16:59:34 GMT -->
</html>

<!-- Dynamic page generated in 0.441 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2016-09-02 12:56:50 -->

<!-- Compression = gzip -->