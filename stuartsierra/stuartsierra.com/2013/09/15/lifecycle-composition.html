<!DOCTYPE html>
<html lang="en-US" class="no-js">

<!-- Mirrored from stuartsierra.com/2013/09/15/lifecycle-composition by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 17:01:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Lifecycle Composition &#8211; Digital Digressions by Stuart Sierra</title>
<link rel='dns-prefetch' href='http://s0.wp.com/'>
<link rel='dns-prefetch' href='http://secure.gravatar.com/'>
<link rel='dns-prefetch' href='http://fonts.googleapis.com/'>
<link rel='dns-prefetch' href='http://s.w.org/'>
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Feed" href="http://feeds2.feedburner.com/StuartSierra" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Comments Feed" href="../../../comments/feed" />
<link rel="alternate" type="application/rss+xml" title="Digital Digressions by Stuart Sierra &raquo; Lifecycle Composition Comments Feed" href="lifecycle-composition/feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/stuartsierra.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='twentysixteen-jetpack-css'  href='../../../wp-content/plugins/jetpack/modules/theme-tools/compat/twentysixteen3a05.css?ver=4.2.2' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-fonts-css'  href='https://fonts.googleapis.com/css?family=Merriweather%3A400%2C700%2C900%2C400italic%2C700italic%2C900italic%7CMontserrat%3A400%2C700%7CInconsolata%3A400&amp;subset=latin%2Clatin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='genericons-css'  href='../../../wp-content/plugins/jetpack/_inc/genericons/genericons/genericons128b.css?ver=3.1' type='text/css' media='all' />
<link rel='stylesheet' id='twentysixteen-style-css'  href='../../../wp-content/themes/twentysixteen/style167b.css?ver=4.6' type='text/css' media='all' />
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='https://stuartsierra.com/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<link rel='stylesheet' id='jetpack_css-css'  href='../../../wp-content/plugins/jetpack/css/jetpack3a05.css?ver=4.2.2' type='text/css' media='all' />
<script type='text/javascript' src='../../../wp-includes/js/jquery/jqueryb8ff.js?ver=1.12.4'></script>
<script type='text/javascript' src='../../../wp-includes/js/jquery/jquery-migrate.min330a.js?ver=1.4.1'></script>
<!--[if lt IE 9]>
<script type='text/javascript' src='https://stuartsierra.com/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<link rel='https://api.w.org/' href='../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../../wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='The Amateur Problem' href='../../07/28/the-amateur-problem.html' />
<link rel='next' title='Command-Line Intransigence' href='../../11/04/command-line-intransigence.html' />
<meta name="generator" content="WordPress 4.6" />
<link rel="canonical" href="lifecycle-composition.html" />
<link rel='shortlink' href='https://wp.me/pbl3J-bX' />
<link rel="alternate" type="application/json+oembed" href="../../../wp-json/oembed/1.0/embed1315.json?url=https%3A%2F%2Fstuartsierra.com%2F2013%2F09%2F15%2Flifecycle-composition" />
<link rel="alternate" type="text/xml+oembed" href="../../../wp-json/oembed/1.0/embedf883?url=https%3A%2F%2Fstuartsierra.com%2F2013%2F09%2F15%2Flifecycle-composition&amp;format=xml" />

<link rel='dns-prefetch' href='http://v0.wordpress.com/'>

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Lifecycle Composition" />
<meta property="og:url" content="https://stuartsierra.com/2013/09/15/lifecycle-composition" />
<meta property="og:description" content="I&#8217;ve been thinking about how to build up software systems out of stateful components. In past presentations and blog posts I&#8217;ve alluded to a standard interface I use for starting and st…" />
<meta property="article:published_time" content="2013-09-15T13:37:28+00:00" />
<meta property="article:modified_time" content="2013-09-15T13:37:28+00:00" />
<meta property="og:site_name" content="Digital Digressions by Stuart Sierra" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:card" content="summary" />
</head>

<body class="single single-post postid-741 single-format-standard">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="#content">Skip to content</a>

		<header id="masthead" class="site-header" role="banner">
			<div class="site-header-main">
				<div class="site-branding">
					
											<p class="site-title"><a href="../../../index.html" rel="home">Digital Digressions by Stuart Sierra</a></p>
											<p class="site-description">From programming to everything else</p>
									</div><!-- .site-branding -->

									<button id="menu-toggle" class="menu-toggle">Menu</button>

					<div id="site-header-menu" class="site-header-menu">
													<nav id="site-navigation" class="main-navigation" role="navigation" aria-label="Primary Menu">
								<div class="menu-main-menu-container"><ul id="menu-main-menu" class="primary-menu"><li id="menu-item-635" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../../../about-me.html">About Me</a></li>
<li id="menu-item-633" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../../../writing.html">Writing</a></li>
<li id="menu-item-634" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../../../presentations.html">Presentations</a></li>
<li id="menu-item-636" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../../../software.html">Software</a></li>
<li id="menu-item-637" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../../../contact.html">Contact</a></li>
</ul></div>							</nav><!-- .main-navigation -->
						
											</div><!-- .site-header-menu -->
							</div><!-- .site-header-main -->

											<div class="header-image">
					<a href="../../../index.html" rel="home">
						<img src="../../../wp-content/uploads/2015/12/header.jpg" srcset="https://stuartsierra.com/wp-content/uploads/2015/12/header-300x70.jpg 300w, https://stuartsierra.com/wp-content/uploads/2015/12/header-768x179.jpg 768w, https://stuartsierra.com/wp-content/uploads/2015/12/header-1024x239.jpg 1024w, https://stuartsierra.com/wp-content/uploads/2015/12/header.jpg 1200w" sizes="(max-width: 709px) 85vw, (max-width: 909px) 81vw, (max-width: 1362px) 88vw, 1200px" width="1200" height="280" alt="Digital Digressions by Stuart Sierra">
					</a>
				</div><!-- .header-image -->
					</header><!-- .site-header -->

		<div id="content" class="site-content">

<div id="primary" class="content-area">
	<main id="main" class="site-main" role="main">
		
<article id="post-741" class="post-741 post type-post status-publish format-standard hentry category-programming tag-clojure tag-components tag-lifecycle tag-workflow">
	<header class="entry-header">
		<h1 class="entry-title">Lifecycle Composition</h1>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>
I&#8217;ve been thinking about how to build up software systems out of<br />
stateful components. In past <a href="http://www.infoq.com/presentations/Clojure-Large-scale-patterns-techniques">presentations</a> and <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">blog posts</a> I&#8217;ve alluded<br />
to a standard interface I use for starting and stopping stateful<br />
components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this] <span class="org-string">"Begins operation of this component."</span>)
  (stop [this] <span class="org-string">"Ceases operation of this component."</span>))
</pre>
</div>
<p>
Most of my Clojure programs follow the same basic structure: Each<br />
subsystem or service is represented by a record which implements this<br />
protocol. At the top, there is a &#8220;system&#8221; record which contains all<br />
the other components.
</p>
<p>
I&#8217;ve gone through several versions of this protocol with the same<br />
function names but slightly different semantics.
</p>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Side Effects, Mutable State</h2>
<div class="outline-text-2" id="text-1">
<p>
In the first version, <code>start</code> and <code>stop</code> were side-effecting<br />
procedures which returned a future or promise:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Asynchronous, returns a</span>
<span class="org-string">  promise on which the caller can block to wait until the component is</span>
<span class="org-string">  started."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Asynchronous, returns a</span>
<span class="org-string">  promise on which the caller can block to wait until the component is</span>
<span class="org-string">  stopped."</span>))
</pre>
</div>
<p>
The calling code could dereference the future to block until the<br />
service had successfully started. For example, a database-access<br />
component might look like this:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">Database</span> [uri connection-atom]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (<span class="org-builtin">future</span> (<span class="org-builtin">reset!</span> connection-atom (connect uri))))
  (stop [_]
    (<span class="org-preprocessor">.close</span> @connection-atom)
    (<span class="org-builtin">future</span> (<span class="org-builtin">reset!</span> connection-atom nil))))

(<span class="org-keyword">defn</span> <span class="org-function-name">database</span> [uri]
  (-&gt;<span class="org-preprocessor">Database</span> uri (<span class="org-builtin">atom</span> nil)))
</pre>
</div>
<p>
My idea was that multiple services could be started in parallel if<br />
they didn&#8217;t depend on one another, but in practice I always ended up<br />
blocking on every call to <code>start</code>:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (<span class="org-builtin">future</span>
      @(start database)
      @(start scheduler)
      @(start web)))
  (stop [_]
    (<span class="org-builtin">future</span>
      @(stop web)
      @(stop scheduler)
      @(stop database))))

(<span class="org-keyword">defn</span> <span class="org-function-name">system</span> [database-uri]
  (<span class="org-keyword">let</span> [database (database database-uri)
        scheduler (scheduler)
        web (web-server database)]
    (-&gt;<span class="org-preprocessor">System</span> database scheduler web)))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Second Attempt</h2>
<div class="outline-text-2" id="text-2">
<p>
I decided to drop the requirement to return a promise from start/stop,<br />
which meant that those functions became synchronous and had no return<br />
value:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is started."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is stopped."</span>))
</pre>
</div>
<p>
This simplified the code calling start/stop, because I didn&#8217;t have to<br />
worry about dereferencing any futures.
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [_]
    (start database)
    (start scheduler)
    (start web))
  (stop [_]
    (stop web)
    (stop scheduler)
    (stop database)))
</pre>
</div>
<p>
This also made it very clear that I was using start/stop only for<br />
side-effects, forcing all of my components to contain mutable state.
</p>
<p>
Also, I had to manually place the calls to start/stop in the correct<br />
order, to ensure that components were not started before other<br />
components which depended on them.
</p>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Immutable Values</h2>
<div class="outline-text-2" id="text-3">
<p>
I decided to try to make the component objects more like immutable<br />
values by redefining start/stop to return updated versions of the<br />
components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defprotocol</span> <span class="org-function-name">Lifecycle</span>
  (start [this]
    <span class="org-string">"Begins operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is started. Returns an updated version of this</span>
<span class="org-string">  component."</span>)
  (stop [this]
    <span class="org-string">"Ceases operation of this component. Synchronous, does not return</span>
<span class="org-string">  until the component is stopped. Returns an updated version of this</span>
<span class="org-string">  component."</span>))
</pre>
</div>
<p>
In this version, <code>start</code> and <code>stop</code> feel more like functions. They are<br />
still not <b>pure</b> functions, because they will have to execute<br />
side-effects such as connecting to a database or opening a web server<br />
port, but at least they return something meaningful.
</p>
<p>
This version has the added benefit of removing some mutable state, at<br />
the cost of making the start/stop implementations slightly more<br />
complicated. Now these functions have to return a new instance of the<br />
component record:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">Database</span> [uri connection]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">assoc</span> this <span class="org-constant">:connection</span> (connect uri)))
  (stop [this]
    (<span class="org-preprocessor">.close</span> connection)
    (<span class="org-builtin">assoc</span> this <span class="org-constant">:connection</span> nil)))

(<span class="org-keyword">defn</span> <span class="org-function-name">database</span> [uri]
  (-&gt;<span class="org-preprocessor">Database</span> uri nil))
</pre>
</div>
<p>
One interesting feature of this pattern is that the system record can<br />
<code>reduce</code> over its own keys to start/stop all the components:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] start))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Keys are returned in the order they were declared.</span>
            (<span class="org-builtin">keys</span> this)))
  (stop [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] stop))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Reverse the order to stop.</span>
            (<span class="org-builtin">reverse</span> (<span class="org-builtin">keys</span> this)))))
</pre>
</div>
<p>
However, this relies on implementation behavior of Clojure records:<br />
the <code>keys</code> function will return the keys in the order they are<br />
declared in the record. I&#8217;m reluctant to rely on that undocumented<br />
behavior, so instead I&#8217;ll declare the ordering explicitly:
</p>
<div class="org-src-container">
<pre class="src src-clojure">(<span class="org-keyword">def</span> <span class="org-function-name">component-order</span>
  [<span class="org-constant">:database</span> <span class="org-constant">:scheduler</span> <span class="org-constant">:web</span>])

(<span class="org-keyword">defrecord</span> <span class="org-function-name">System</span> [database scheduler web]
  <span class="org-preprocessor">Lifecycle</span>
  (start [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] start))
            this
            component-order))
  (stop [this]
    (<span class="org-builtin">reduce</span> (<span class="org-keyword">fn</span> [system key]
              (<span class="org-builtin">update-in</span> system [key] stop))
            this
            <span class="org-comment-delimiter">;; </span><span class="org-comment">Reverse the order to stop.</span>
            (<span class="org-builtin">reverse</span> component-order))))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Dependency Order</h2>
<div class="outline-text-2" id="text-4">
<p>
I still don&#8217;t have good solution to specifying the order in which<br />
components must be started/stopped. I&#8217;ve tried building a graph of<br />
dependencies and computing the correct order. This would be similar to<br />
what <a href="https://github.com/clojure/tools.namespace">tools.namespace</a> does with namespaces. But I haven&#8217;t been able to<br />
come up with a good syntax for representing these relationships that<br />
isn&#8217;t more cumbersome than just declaring them in order.
</p>
<p>
I&#8217;ve also tried using Prismatic&#8217;s <a href="https://github.com/Prismatic/plumbing">Graph</a> library or my own <a href="https://github.com/stuartsierra/flow">Flow</a> library<br />
to define the graph of dependency relationships, but neither of those<br />
libraries can produce a structure that <b>remembers</b> the graph after it<br />
has computed its output, so I have no way to recover the dependency<br />
relationships after constructing the system object.
</p>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Dependency Injection and State</h2>
<div class="outline-text-2" id="text-5">
<p>
This technique is a form of dependency injection through constructors.<br />
The choice of whether to make the individual components mutable,<br />
stateful objects has an impact on how I can use them later on. In the<br />
original version of this pattern using mutable objects, each component<br />
gets stable references to other components it depends on. In the later<br />
version using immutable data structures, each component gets<br />
references to the <b>constructed</b> versions of other components it<br />
depends on, but not the <b>started</b> versions of those components,<br />
i.e. the values returned from <code>start</code>.
</p>
<p>
So far, this has not been a problem in the programs I write. For<br />
example, a Datomic database connection is always recoverable from the<br />
URI, so I don&#8217;t need to store it explicitly. But other components,<br />
particularly components which rely on external state to function<br />
properly, might need to be mutable so that their dependents can still<br />
use them via the references the received in their constructors. I<br />
could still have <code>start</code> and <code>stop</code> return new values, but they would<br />
also have to modify some mutable state (such as a Ref or Atom) along<br />
the way. As always, mutable objects muddy the distinction between<br />
<b>values</b> and <b>identities</b>.
</p>
<p>
I&#8217;ve also experimented with variations of <code>start</code> and <code>stop</code> that<br />
pass in other &#8220;started&#8221; components, but this was cumbersome and hard<br />
to generalize through a single interface.
</p>
<p>
So I don&#8217;t have a perfect system. It works well enough for the<br />
applications I&#8217;ve developed with it so far, and it facilitates my<br />
<a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">REPL-driven development workflow</a>, but I always have to adapt to<br />
circumstance. Eliminating mutable state is generally a good thing,<br />
but it can also be limiting, especially when you have to deal with<br />
<b>external</b> state.
</p>
</div>
</div>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=49&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=98&amp;d=blank&amp;r=g 2x' class='avatar avatar-49 photo' height='49' width='49' /><span class="screen-reader-text">Author </span> <a class="url fn n" href="../../../author/stuart.html">Stuart</a></span></span><span class="posted-on"><span class="screen-reader-text">Posted on </span><a href="lifecycle-composition.html" rel="bookmark"><time class="entry-date published updated" datetime="2013-09-15T08:37:28+00:00">September 15, 2013</time></a></span><span class="cat-links"><span class="screen-reader-text">Categories </span><a href="../../../category/programming.html" rel="category tag">Programming</a></span><span class="tags-links"><span class="screen-reader-text">Tags </span><a href="../../../tag/clojure.html" rel="tag">Clojure</a>, <a href="../../../tag/components.html" rel="tag">components</a>, <a href="../../../tag/lifecycle.html" rel="tag">lifecycle</a>, <a href="../../../tag/workflow.html" rel="tag">workflow</a></span>			</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<div id="comments" class="comments-area">

			<h2 class="comments-title">
			7 thoughts on &ldquo;Lifecycle Composition&rdquo;		</h2>

		
		<ol class="comment-list">
					<li id="comment-45593" class="comment even thread-even depth-1">
			<article id="div-comment-45593" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/c694a032be7518a0d704318895f8fe1d?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/c694a032be7518a0d704318895f8fe1d?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn"><a href='http://benmabey.com/' rel='external nofollow' class='url'>Ben Mabey</a></b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45593">
							<time datetime="2013-09-15T13:53:45+00:00">
								September 15, 2013 at 1:53 pm							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Could you explain more about the problems you&#8217;ve faced in using a graph-like library for dependency order?  I&#8217;ve been using this approach for a bit over a year now with good results, but we may be thinking about different things.</p>
<p>I&#8217;ve been using a library like Prismatic&#8217;s graph (and Prismatic&#8217;s version itself in later projects) which uses the topological sort of the graph as the order in which to start the components.  Once the system graph is computed the topo sort is stored as metadata onto the system object (map) which is then used in #&#8217;stop to guarantee components are stopped in reverse order.  The graph library doesn&#8217;t need to remember the order, the Lifecycle #&#8217;start is responsible for storing it in the metadata for later use.</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-45594" class="comment odd alt thread-odd thread-alt depth-1">
			<article id="div-comment-45594" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/37f16626f8d6312ccfa0036065e1884c?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/37f16626f8d6312ccfa0036065e1884c?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn">Dmitry Groshev</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45594">
							<time datetime="2013-09-15T16:45:04+00:00">
								September 15, 2013 at 4:45 pm							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>I can&#8217;t help but think about how this resembles Erlang and it&#8217;s OTP. It looks like every sufficiently well designed system contains half of OTP. I believe that you can benefit a lot from investing some time in it, besides, it&#8217;s very fun by itself.</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-45600" class="comment even thread-even depth-1">
			<article id="div-comment-45600" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/6595ae6ba5ca0712e8e3074f2d9063d2?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/6595ae6ba5ca0712e8e3074f2d9063d2?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn">Laurent Petit</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45600">
							<time datetime="2013-09-17T03:08:04+00:00">
								September 17, 2013 at 3:08 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Have you been tempted by using Spring Core for components wiring under the cover? :-)</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-45603" class="comment byuser comment-author-stuart bypostauthor odd alt thread-odd thread-alt depth-1">
			<article id="div-comment-45603" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/55878d0196b91803f9cb2c372b0551d3?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn"><a href='../../../index.html' rel='external nofollow' class='url'>Stuart</a></b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45603">
							<time datetime="2013-09-17T07:10:42+00:00">
								September 17, 2013 at 7:10 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>No. :)</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-45619" class="comment even thread-even depth-1">
			<article id="div-comment-45619" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/0e1aa7a623e68cca5a3655bb5b23f60f?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/0e1aa7a623e68cca5a3655bb5b23f60f?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn">Murtaza Husain</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45619">
							<time datetime="2013-09-19T00:02:53+00:00">
								September 19, 2013 at 12:02 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Stuart, thanks for the series, I have been enjoying it. Is it possible for you to release a sample project ( a sort of hello world or little more than it), that utilizes the above ideas. It will be cool to see them in action.</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-45637" class="comment odd alt thread-odd thread-alt depth-1">
			<article id="div-comment-45637" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/0e1aa7a623e68cca5a3655bb5b23f60f?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/0e1aa7a623e68cca5a3655bb5b23f60f?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn">Murtaza Husain</b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45637">
							<time datetime="2013-09-20T11:42:45+00:00">
								September 20, 2013 at 11:42 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>Stuart, can you give an example where a mutable reference would be preferred instead of an immutable value. In which case the above system would not work ? </p>
<p>I am also using a complete clojure stack (including datomic), so the immutable values concept should owrk. However want to understand where the above scheme of things will break.</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		<li id="comment-45651" class="comment even thread-even depth-1">
			<article id="div-comment-45651" class="comment-body">
				<footer class="comment-meta">
					<div class="comment-author vcard">
						<img alt='' src='https://secure.gravatar.com/avatar/781e1e48ab0a97e307c1cbee71075cdc?s=42&amp;d=blank&amp;r=g' srcset='https://secure.gravatar.com/avatar/781e1e48ab0a97e307c1cbee71075cdc?s=84&amp;d=blank&amp;r=g 2x' class='avatar avatar-42 photo' height='42' width='42' />						<b class="fn"><a href='http://dm3.github.com/' rel='external nofollow' class='url'>Vadim</a></b> <span class="says">says:</span>					</div><!-- .comment-author -->

					<div class="comment-metadata">
						<a href="lifecycle-composition.html#comment-45651">
							<time datetime="2013-09-21T02:17:38+00:00">
								September 21, 2013 at 2:17 am							</time>
						</a>
											</div><!-- .comment-metadata -->

									</footer><!-- .comment-meta -->

				<div class="comment-content">
					<p>We found it beneficial to make Lifecycle#start:</p>
<p>(start [this started]<br />
    (reduce (fn [system key]<br />
              (update-in system [key] start system))<br />
            this component-order))</p>
<p>Which allows to depend on already started components. Do you see any problems with that?</p>
				</div><!-- .comment-content -->

							</article><!-- .comment-body -->
</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		
	
			<p class="no-comments">Comments are closed.</p>
	
	
</div><!-- .comments-area -->

	<nav class="navigation post-navigation" role="navigation">
		<h2 class="screen-reader-text">Post navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="../../07/28/the-amateur-problem.html" rel="prev"><span class="meta-nav" aria-hidden="true">Previous</span> <span class="screen-reader-text">Previous post:</span> <span class="post-title">The Amateur Problem</span></a></div><div class="nav-next"><a href="../../11/04/command-line-intransigence.html" rel="next"><span class="meta-nav" aria-hidden="true">Next</span> <span class="screen-reader-text">Next post:</span> <span class="post-title">Command-Line Intransigence</span></a></div></div>
	</nav>
	</main><!-- .site-main -->

	
</div><!-- .content-area -->


	<aside id="secondary" class="sidebar widget-area" role="complementary">
		<section id="search-3" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://stuartsierra.com/">
	<label>
		<span class="screen-reader-text">Search for:</span>
		<input type="search" class="search-field" placeholder="Search &hellip;" value="" name="s" />
	</label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">Search</span></button>
</form>
</section><section id="text-4" class="widget widget_text">			<div class="textwidget"><ul>
<li><a href="http://feeds2.feedburner.com/StuartSierra" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="../../../comments/feed" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
</ul>
<ul>
<li><a href="https://twitter.com/stuartsierra">Twitter</a></li>
<li><a href="https://github.com/stuartsierra">GitHub</a></li>
</ul></div>
		</section><section id="tag-widget-2" class="widget TagWidget"><h2 class="widget-title">Clojure Do’s and Don’ts</h2><ul class = "posts-by-tag-list"><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-883"><a class = "posts-by-tag-item-title" href="../../../2015/08/25/clojure-donts-lazy-effects.html">Clojure Don’ts: Lazy Effects</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-877"><a class = "posts-by-tag-item-title" href="../../../2015/08/10/clojure-donts-redundant-map.html">Clojure Don’ts: Redundant map</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-870"><a class = "posts-by-tag-item-title" href="../../../2015/06/16/clojure-donts-single-branch-if.html">Clojure Don’ts: Single-branch if</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-854"><a class = "posts-by-tag-item-title" href="../../../2015/06/10/clojure-donts-heisenparameter.html">Clojure Don’ts: The Heisenparameter</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-849"><a class = "posts-by-tag-item-title" href="../../../2015/06/01/clojure-donts-optional-arguments-with-varargs.html">Clojure Don’ts: Optional Arguments with Varargs</a></li><li class="posts-by-tag-item Clojure do's and don'ts errors" id="posts-by-tag-item-836"><a class = "posts-by-tag-item-title" href="../../../2015/05/27/clojure-uncaught-exceptions.html">Clojure Do’s: Uncaught Exceptions</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-831"><a class = "posts-by-tag-item-title" href="../../../2015/05/17/clojure-record-constructors.html">Record Constructors</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-826"><a class = "posts-by-tag-item-title" href="../../../2015/05/10/clojure-namespace-aliases.html">Clojure Do’s: Namespace Aliases</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-820"><a class = "posts-by-tag-item-title" href="../../../2015/05/02/clojure-donts-isa.html">Clojure Don’ts: isa?</a></li><li class="posts-by-tag-item Clojure do's and don'ts" id="posts-by-tag-item-812"><a class = "posts-by-tag-item-title" href="../../../2015/04/26/clojure-donts-concat.html">Clojure Don’ts: Concat</a></li></ul></section>	</aside><!-- .sidebar .widget-area -->

		</div><!-- .site-content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
							<nav class="main-navigation" role="navigation" aria-label="Footer Primary Menu">
					<div class="menu-main-menu-container"><ul id="menu-main-menu-1" class="primary-menu"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-635"><a href="../../../about-me.html">About Me</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-633"><a href="../../../writing.html">Writing</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-634"><a href="../../../presentations.html">Presentations</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-636"><a href="../../../software.html">Software</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-637"><a href="../../../contact.html">Contact</a></li>
</ul></div>				</nav><!-- .main-navigation -->
			
			
			<div class="site-info">
								<span class="site-title"><a href="../../../index.html" rel="home">Digital Digressions by Stuart Sierra</a></span>
				<a href="https://wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- .site-footer -->
	</div><!-- .site-inner -->
</div><!-- .site -->

	<div style="display:none">
	<div class="grofile-hash-map-55878d0196b91803f9cb2c372b0551d3">
	</div>
	<div class="grofile-hash-map-c694a032be7518a0d704318895f8fe1d">
	</div>
	<div class="grofile-hash-map-37f16626f8d6312ccfa0036065e1884c">
	</div>
	<div class="grofile-hash-map-6595ae6ba5ca0712e8e3074f2d9063d2">
	</div>
	<div class="grofile-hash-map-55878d0196b91803f9cb2c372b0551d3">
	</div>
	<div class="grofile-hash-map-0e1aa7a623e68cca5a3655bb5b23f60f">
	</div>
	<div class="grofile-hash-map-781e1e48ab0a97e307c1cbee71075cdc">
	</div>
	</div>
<script type='text/javascript' src='https://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201635'></script>
<script type='text/javascript' src='https://secure.gravatar.com/js/gprofiles.js?ver=2016Sepaa'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/plugins/jetpack/modules/wpgroho167b.js?ver=4.6'></script>
<script type='text/javascript' src='../../../wp-content/themes/twentysixteen/js/skip-link-focus-fix8de4.js?ver=20160816'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var screenReaderText = {"expand":"expand child menu","collapse":"collapse child menu"};
/* ]]> */
</script>
<script type='text/javascript' src='../../../wp-content/themes/twentysixteen/js/functions8de4.js?ver=20160816'></script>
<script type='text/javascript' src='../../../wp-includes/js/wp-embed.min167b.js?ver=4.6'></script>
<script type='text/javascript' src='https://stats.wp.com/e-201635.js' async defer></script>
<script type='text/javascript'>
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:4.2.2',blog:'2702563',post:'741',tz:'-4',srv:'stuartsierra.com'} ]);
	_stq.push([ 'clickTrackerInit', '2702563', '741' ]);
</script>
</body>

<!-- Mirrored from stuartsierra.com/2013/09/15/lifecycle-composition by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 02 Sep 2016 17:01:26 GMT -->
</html>

<!-- Dynamic page generated in 0.447 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2016-09-02 01:31:04 -->

<!-- Compression = gzip -->